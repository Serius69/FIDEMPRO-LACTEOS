{% extends "partials/base.html" %}
{% load static %}
{% block title %}Vista Previa de Configuración - FindEMPro{% endblock title %}
{% block extra_css %}
<style>
    #demandChart {
    max-height: 320px;
    min-height: 220px;
    height: 320px !important;
    }
    .preview-card {
        border: 2px solid transparent;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
        min-height: 200px;
    }
    
    .preview-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        border-color: var(--vz-primary);
    }
    
    .preview-badge {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 1;
    }
    
    .metric-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        padding: 20px;
        position: relative;
        overflow: hidden;
    }
    
    .metric-card::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -50%;
        width: 200%;
        height: 200%;
        background: rgba(255, 255, 255, 0.1);
        transform: rotate(45deg);
    }
    
    .data-preview-table {
        font-size: 0.875rem;
    }
    
    .data-preview-table th {
        background-color: var(--vz-light);
        font-weight: 600;
    }
    
    .demo-indicator {
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0% {
            opacity: 1;
        }
        50% {
            opacity: 0.6;
        }
        100% {
            opacity: 1;
        }
    }
    
    .feature-icon {
        width: 48px;
        height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: var(--vz-primary-bg-subtle);
        border-radius: 12px;
        font-size: 24px;
    }
    
    .info-tooltip {
        cursor: help;
        color: var(--vz-info);
    }
    
    .config-summary {
        background-color: var(--vz-light);
        border-radius: 10px;
        padding: 20px;
    }
    
    .timeline-item {
        position: relative;
        padding-left: 40px;
        padding-bottom: 30px;
    }
    
    .timeline-item:before {
        content: '';
        position: absolute;
        left: 15px;
        top: 5px;
        height: calc(100% - 5px);
        width: 2px;
        background-color: var(--vz-border-color);
    }
    
    .timeline-item:last-child:before {
        display: none;
    }
    
    .timeline-dot {
        position: absolute;
        left: 10px;
        top: 0;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background-color: var(--vz-primary);
        border: 2px solid white;
        box-shadow: 0 0 0 3px var(--vz-primary-bg-subtle);
    }
</style>
{% endblock extra_css %}
{% block content %}
<!-- ============================================================== -->
<!-- Start right Content here -->
<!-- ============================================================== -->
<div class="main-content">
    <div class="page-content">
        <div class="container-fluid">
            <!-- Page Title -->
            <div class="row">
                <div class="col-12">
                    <div class="page-title-box d-sm-flex align-items-center justify-content-between">
                        <h4 class="mb-sm-0">Vista Previa de Configuración Inicial</h4>
                        <div class="page-title-right">
                            <ol class="breadcrumb m-0">
                                <li class="breadcrumb-item"><a href="{% url 'dashboard:index' %}">Dashboard</a></li>
                                <li class="breadcrumb-item active">Vista Previa</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Alert Banner -->
            <div class="alert alert-info alert-dismissible fade show" role="alert">
                <div class="d-flex align-items-center">
                    <i class="ri-information-line fs-3 me-3"></i>
                    <div>
                        <h5 class="alert-heading">Configuración de Demostración</h5>
                        <p class="mb-0">Esta es una vista previa de la configuración que se creará automáticamente para su empresa láctea. 
                        Todos los valores mostrados son datos de ejemplo que podrá personalizar posteriormente.</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>

            <!-- Metrics Overview -->
            <div class="row">
                <div class="col-lg-3 col-md-6">
                    <div class="metric-card">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h3 class="mb-1 text-white">{{ preview_data.products_preview|length }}</h3>
                                <p class="mb-0 text-white-50">Productos Lácteos</p>
                            </div>
                            <div class="feature-icon bg-white bg-opacity-25">
                                <i class="ri-store-2-line text-white"></i>
                            </div>        
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6">
                    <div class="metric-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h3 class="mb-1 text-white">{{ preview_data.areas_preview|length }}</h3>
                                <p class="mb-0 text-white-50">Áreas Operativas</p>
                            </div>
                            <div class="feature-icon bg-white bg-opacity-25">
                                <i class="ri-dashboard-line text-white"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6">
                    <div class="metric-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h3 class="mb-1 text-white">{{ preview_data.variable_preview|length }}</h3>
                                <p class="mb-0 text-white-50">Variables Financieras</p>
                            </div>
                            <div class="feature-icon bg-white bg-opacity-25">
                                <i class="ri-line-chart-line text-white"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6">
                    <div class="metric-card" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h3 class="mb-1 text-white">30 días</h3>
                                <p class="mb-0 text-white-50">Simulación Inicial</p>
                            </div>
                            <div class="feature-icon bg-white bg-opacity-25">
                                <i class="ri-calendar-line text-white"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="row mt-4">
                <!-- Products Preview -->
                <div class="col-lg-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="ri-store-2-line me-2"></i>Productos que se Configurarán
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                {% for product in preview_data.products_preview|slice:":4" %}
                                <div class="col-md-6">
                                    <div class="preview-card card h-100">
                                        <span class="preview-badge badge bg-success">Por defecto</span>
                                        <div class="card-body">
                                            <h6 class="card-title">{{ product.name }}</h6>
                                            <p class="text-muted small mb-2">{{ product.short_description }}</p>
                                            <div class="d-flex justify-content-between align-items-center mt-3">
                                                <span class="badge bg-primary-subtle text-primary">
                                                    Margen: {{ product.margin }}%
                                                </span>
                                                <small class="text-muted">
                                                    <i class="ri-flask-line"></i> {{ product.unit }}
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                                {% if preview_data.products_preview|length > 4 %}
                                <div class="col-12 text-center mt-2">
                                    <button class="btn btn-soft-primary btn-sm" data-bs-toggle="modal" data-bs-target="#allProductsModal">
                                        <i class="ri-eye-line me-1"></i> Ver todos los productos ({{ preview_data.products_preview|length }})
                                    </button>
                                </div>
                                <!-- Modal para ver todos los productos -->
                                <div class="modal fade" id="allProductsModal" tabindex="-1" aria-labelledby="allProductsModalLabel" aria-hidden="true">
                                    <div class="modal-dialog modal-lg">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="allProductsModalLabel">Todos los Productos Lácteos</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body">
                                                <div class="row g-3">
                                                    {% for product in preview_data.products_preview %}
                                                    <div class="col-md-6">
                                                        <div class="preview-card card h-100">
                                                            <span class="preview-badge badge bg-success">Por defecto</span>
                                                            <div class="card-body">
                                                                <h6 class="card-title">{{ product.name }}</h6>
                                                                <p class="text-muted small mb-2">{{ product.short_description }}</p>
                                                                <div class="d-flex justify-content-between align-items-center mt-3">
                                                                    <span class="badge bg-primary-subtle text-primary">
                                                                        Margen: {{ product.margin }}%
                                                                    </span>
                                                                    <small class="text-muted">
                                                                        <i class="ri-flask-line"></i> {{ product.unit }}
                                                                    </small>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cerrar</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                            <div class="mt-3 text-center">
                                <small class="text-muted">
                                    <i class="ri-information-line"></i> 
                                    Estos productos se crearán automáticamente. Podrá agregar más después.
                                </small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Areas Preview -->
                <div class="col-12 col-lg-6">
                    <div class="card h-100">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="ri-dashboard-line me-2"></i>Áreas Operativas
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="timeline">
                                {% for area in preview_data.areas_preview|slice:":3" %}
                                <div class="timeline-item d-flex align-items-start">
                                    <div class="timeline-dot mt-2"></div>
                                    <div class="flex-grow-1 ms-3">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <h6 class="mb-1">{{ area.name }}</h6>
                                            {% if area.manager %}
                                                <span class="badge bg-primary-subtle text-primary ms-2">
                                                    <i class="ri-user-3-line me-1"></i> {{ area.manager }}
                                                </span>
                                            {% endif %}
                                        </div>
                                        <p class="text-muted small mb-0">{{ area.description }}</p>
                                        {% if area.extra_info %}
                                            <div class="mt-1">
                                                <span class="badge bg-info-subtle text-info">{{ area.extra_info }}</span>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% if preview_data.areas_preview|length > 3 %}
                            <div class="col-12 text-center mt-2">
                                <button class="btn btn-soft-primary btn-sm" data-bs-toggle="modal" data-bs-target="#allAreasModal">
                                    <i class="ri-eye-line me-1"></i> Ver todas las áreas ({{ preview_data.areas_preview|length }})
                                </button>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Modal para ver todas las áreas -->
                <div class="modal fade" id="allAreasModal" tabindex="-1" aria-labelledby="allAreasModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="allAreasModalLabel">Todas las Áreas Operativas</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="timeline">
                                    {% for area in preview_data.areas_preview %}
                                    <div class="timeline-item">
                                        <div class="timeline-dot"></div>
                                        <div>
                                            <h6 class="mb-1">{{ area.name }}</h6>
                                            <p class="text-muted small mb-0">{{ area.description }}</p>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cerrar</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="row mt-4">
                <!-- Products Preview -->
                <div class="col-lg-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="ri-function-line me-2"></i>Ecuaciones del Modelo
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                {% for equation in preview_data.equation_preview|slice:":8" %}
                                <div class="col-12">
                                    <div class="preview-card card h-100">
                                        <span class="preview-badge badge bg-info">Modelo</span>
                                        <div class="card-body">
                                            <h6 class="card-title">{{ equation.name }}</h6>
                                            <p class="text-muted small mb-2">{{ equation.description }}</p>
                                            <div class="mt-2">
                                                <code class="d-block mb-1">{{ equation.formula|safe }}</code>
                                                <small class="text-muted">
                                                    <i class="ri-lightbulb-flash-line"></i> {{ equation.type }}
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                                {% if preview_data.equation_preview|length > 10 %}
                                <div class="col-12 text-center mt-2">
                                    <button class="btn btn-soft-primary btn-sm" data-bs-toggle="modal" data-bs-target="#allEquationsModal">
                                        <i class="ri-eye-line me-1"></i> Ver todas las ecuaciones ({{ preview_data.equation_preview|length }})
                                    </button>
                                </div>
                                <!-- Modal para ver todas las ecuaciones -->
                                <div class="modal fade" id="allEquationsModal" tabindex="-1" aria-labelledby="allEquationsModalLabel" aria-hidden="true">
                                    <div class="modal-dialog modal-lg">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="allEquationsModalLabel">Todas las Ecuaciones del Modelo</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body">
                                                <div class="row g-3">
                                                    {% for equation in preview_data.equation_preview %}
                                                    <div class="col-12">
                                                        <div class="preview-card card h-100">
                                                            <span class="preview-badge badge bg-info">Modelo</span>
                                                            <div class="card-body">
                                                                <h6 class="card-title">{{ equation.name }}</h6>
                                                                <p class="text-muted small mb-2">{{ equation.description }}</p>
                                                                <div class="mt-2">
                                                                    <code class="d-block mb-1">{{ equation.formula|safe }}</code>
                                                                    <small class="text-muted">
                                                                        <i class="ri-lightbulb-flash-line"></i> {{ equation.type }}
                                                                    </small>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cerrar</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                            <div class="mt-3 text-center">
                                <small class="text-muted">
                                    <i class="ri-information-line"></i>
                                    Estas ecuaciones definen el comportamiento inicial del sistema. Puede editarlas luego.
                                </small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Questionnaires Preview -->
                <div class="col-lg-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="ri-question-answer-line me-2"></i>Cuestionarios Iniciales
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="accordion" id="questionnaireAccordion">
                                {% for questionnaire in preview_data.questionarie_preview %}
                                <div class="accordion-item">
                                    <h2 class="accordion-header" id="heading{{ forloop.counter }}">
                                        <button class="accordion-button {% if not forloop.first %}collapsed{% endif %}" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ forloop.counter }}" aria-expanded="{% if forloop.first %}true{% else %}false{% endif %}" aria-controls="collapse{{ forloop.counter }}">
                                            {{ questionnaire.questionary }}
                                        </button>
                                    </h2>
                                    <div id="collapse{{ forloop.counter }}" class="accordion-collapse collapse {% if forloop.first %}show{% endif %}" aria-labelledby="heading{{ forloop.counter }}" data-bs-parent="#questionnaireAccordion">
                                        <div class="accordion-body">
                                            <p class="text-muted small mb-3">{{ questionnaire.description }}</p>
                                            <ul class="list-group list-group-flush">
                                                {% for question in preview_data.question_preview %}
                                                    {% if question.questionnaire_id == questionnaire.id %}
                                                    <li class="list-group-item">
                                                        <strong>{{ question.question }}</strong>
                                                        {% if question.type %}
                                                            {% if question.type == 1 %}
                                                                <span class="badge bg-success-subtle text-success ms-2">Endógena</span>
                                                            {% elif question.type == 2 %}
                                                                <span class="badge bg-info-subtle text-info ms-2">Estado</span>
                                                            {% elif question.type == 3 %}
                                                                <span class="badge bg-warning-subtle text-warning ms-2">Exógena</span>
                                                            {% else %}
                                                                <span class="badge bg-secondary-subtle text-secondary ms-2">{{ question.type }}</span>
                                                            {% endif %}
                                                        {% endif %}
                                                        {% if question.initials_variable %}
                                                            <span class="text-muted small d-block">{{ question.initials_variable }}</span>
                                                        {% endif %}
                                                    </li>
                                                    {% endif %}
                                                {% empty %}
                                                    <li class="list-group-item text-muted">No hay preguntas para este cuestionario.</li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                {% empty %}
                                <div class="text-center text-muted py-4">
                                    No hay cuestionarios de ejemplo configurados.
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Simulation Preview -->
            <div class="row">
                <div class="col-lg-12">
                    <div class="card">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="card-title mb-0">
                                    <i class="ri-bar-chart-2-line me-2"></i>Vista Previa de Simulación
                                </h5>
                                <span class="badge bg-warning demo-indicator">
                                    <i class="ri-flask-line me-1"></i>Datos de Ejemplo
                                </span>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-lg-4">
                                    <div class="config-summary">
                                        <h6 class="text-muted text-uppercase mb-3">Configuración Inicial</h6>
                                        <div class="mb-3">
                                            <label class="text-muted small">Período de Simulación</label>
                                            <p class="mb-0 fw-semibold">{{ preview_data.simulate_preview.quantity_time }} {{ preview_data.simulate_preview.unit_time }}</p>
                                        </div>
                                        <div class="mb-3">
                                            <label class="text-muted small">Demanda Real Total</label>
                                            <p class="mb-0 fw-semibold">
                                                {{ preview_data.simulate_preview.demand_history }}
                                            </p>
                                        </div>
                                        <div class="mb-3">
                                            <label class="text-muted small">Demanda por Producto</label>
                                            <ul class="list-group list-group-flush">
                                                {% for key, config in preview_data.demand_configurations_preview.items %}
                                                <li class="list-group-item px-0 py-1">
                                                    <strong>{{ key|capfirst }}:</strong>
                                                    <span class="text-muted small">
                                                        Base: {{ config.base_demand }},
                                                        {% if config.seasonality %} estacionalidad: Sí, {% else %} estacionalidad: No, {% endif %}
                                                        crecimiento: {{ config.growth_rate }},
                                                        volatilidad: {{ config.volatility }}
                                                    </span>
                                                </li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                        <div class="mb-3">
                                            <label class="text-muted small">Distribución</label>
                                            <p class="mb-0 fw-semibold">
                                                {% if preview_data.simulate_preview.fk_fdp == 1 %}
                                                    Normal
                                                {% elif preview_data.simulate_preview.fk_fdp == 2 %}
                                                    Exponencial
                                                {% elif preview_data.simulate_preview.fk_fdp == 3 %}
                                                    Log-Norm
                                                {% elif preview_data.simulate_preview.fk_fdp == 4 %}
                                                    Gamma
                                                {% elif preview_data.simulate_preview.fk_fdp == 5 %}
                                                    Uniforme
                                                {% else %}
                                                    Desconocida
                                                {% endif %}
                                            </p>
                                        </div>
                                        <div class="mb-3">
                                            <label class="text-muted small">Nivel de Confianza</label>
                                            <p class="mb-0 fw-semibold">{{ preview_data.simulate_preview.confidence_level }}</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-8">
                                    <h6 class="text-muted text-uppercase mb-3">Proyección de Demanda por Producto (Ejemplo)</h6>
                                    <canvas id="demandChart"></canvas>
                                    <div class="row mt-3">
                                        {% for key, config in preview_data.demand_configurations_preview.items %}
                                        <div class="col-md-4">
                                            <div class="card bg-light mb-2">
                                                <div class="card-body py-2 px-3">
                                                    <strong>{{ key|capfirst }}</strong><br>
                                                    <span class="text-muted small">
                                                        Base: {{ config.base_demand }}<br>
                                                        {% if config.seasonality %}Estacionalidad: Sí{% else %}Estacionalidad: No{% endif %}<br>
                                                        Crecimiento: {{ config.growth_rate }}<br>
                                                        Volatilidad: {{ config.volatility }}
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    <p class="text-muted text-center mt-3 small">
                                        <i class="ri-information-line"></i> 
                                        Gráfica ilustrativa. Los datos reales se generarán con sus parámetros específicos de cada producto.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Key Variables Preview -->
            <div class="row">
                <div class="col-lg-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="ri-calculator-line me-2"></i>Variables Clave del Sistema
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table data-preview-table">
                                    <thead>
                                        <tr>
                                            <th>Variable</th>
                                            <th>Descripción</th>
                                            <th>Tipo</th>
                                            <th>Unidad</th>
                                            <th>Valor Ejemplo</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for variable in preview_data.variable_preview|slice:":10" %}
                                        <tr>
                                            <td><code>{{ variable.name }}</code></td>
                                            <td>{{ variable.description }}</td>
                                            <td>
                                                {% if variable.type == 1 %}
                                                    <span class="badge bg-success-subtle text-success">Endógena</span>
                                                {% elif variable.type == 2 %}
                                                    <span class="badge bg-info-subtle text-info">Estado</span>
                                                {% elif variable.type == 3 %}
                                                    <span class="badge bg-warning-subtle text-warning">Exógena</span>
                                                {% else %}
                                                    <span class="badge bg-secondary-subtle text-secondary">{{ variable.type }}</span>
                                                {% endif %}
                                            </td>
                                            <td>{{ variable.unit }}</td>
                                            <td class="fw-semibold">
                                                {% for key, value in preview_data.result_simulation_preview.items %}
                                                    {% if key == variable.initials %}
                                                        <span class="ms-2 badge bg-primary-subtle text-primary">{{ value }}</span>
                                                    {% endif %}
                                                {% endfor %}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            <div class="text-center mt-3">
                                <button class="btn btn-soft-primary btn-sm" data-bs-toggle="modal" data-bs-target="#allVariablesModal">
                                    <i class="ri-eye-line me-1"></i> Ver todas las variables
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="row">
                <div class="col-lg-12">
                    <div class="card bg-primary-subtle border-0">
                        <div class="card-body">
                            <div class="text-center py-3">
                                <h5 class="mb-3">¿Listo para comenzar?</h5>
                                <p class="text-muted mb-4">
                                    Al continuar, se creará automáticamente toda esta configuración para su empresa.
                                    <br>Podrá personalizar todos los valores después de la creación inicial.
                                </p>
                                
                                <!-- Form that triggers the confirmation modal -->
                                <form method="post" id="confirmForm" action="{% url 'pages:pages.register_elements_create' %}">
                                    {% csrf_token %}
                                    <input type="hidden" name="confirm_setup" value="true">
                                    
                                    <div class="d-flex gap-2 justify-content-center">
                                        <a href="{% url 'dashboard:index' %}" class="btn btn-light">
                                            <i class="ri-arrow-left-line me-1"></i> Volver
                                        </a>
                                        <button type="submit" class="btn btn-primary" id="createConfigBtn">
                                            <i class="ri-check-line me-1"></i> Crear Configuración
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
        <!-- container-fluid -->
    </div>
    <!-- End Page-content -->

    {% block footer %}
    {% include "partials/footer.html" %}
    {% endblock footer %}
</div>
<!-- end main content-->

<!-- All Variables Modal -->
<div class="modal fade" id="allVariablesModal" tabindex="-1" aria-labelledby="allVariablesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="allVariablesModalLabel">Todas las Variables del Sistema</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="accordion" id="variablesAccordion">
                    <!-- Exógenas -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#exogenas">
                                <i class="ri-input-method-line me-2"></i> Variables Exógenas (Entrada)
                            </button>
                        </h2>
                        <div id="exogenas" class="accordion-collapse collapse show">
                            <div class="accordion-body">
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Código</th>
                                                <th>Nombre</th>
                                                <th>Unidad</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for variable in preview_data.variable_preview %}
                                                {% if variable.type == 3 %}
                                                <tr>
                                                    <td>{{ variable.code }}</td>
                                                    <td>{{ variable.name }}</td>
                                                    <td>{{ variable.unit }}</td>
                                                </tr>
                                                {% endif %}
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Estado -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#estado">
                                <i class="ri-refresh-line me-2"></i> Variables de Estado
                            </button>
                        </h2>
                        <div id="estado" class="accordion-collapse collapse">
                            <div class="accordion-body">
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Código</th>
                                                <th>Nombre</th>
                                                <th>Unidad</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for variable in preview_data.variable_preview %}
                                                {% if variable.type == 2 %}
                                                <tr>
                                                    <td>{{ variable.code }}</td>
                                                    <td>{{ variable.name }}</td>
                                                    <td>{{ variable.unit }}</td>
                                                </tr>
                                                {% endif %}
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Endógenas -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#endogenas">
                                <i class="ri-output-line me-2"></i> Variables Endógenas (Salida)
                            </button>
                        </h2>
                        <div id="endogenas" class="accordion-collapse collapse">
                            <div class="accordion-body">
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Código</th>
                                                <th>Nombre</th>
                                                <th>Unidad</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for variable in preview_data.variable_preview %}
                                                {% if variable.type == 1 %}
                                                <tr>
                                                    <td>{{ variable.code }}</td>
                                                    <td>{{ variable.name }}</td>
                                                    <td>{{ variable.unit }}</td>
                                                </tr>
                                                {% endif %}
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

{% endblock content %}
{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Demand Chart
document.addEventListener('DOMContentLoaded', function() {
    const demandChartElem = document.getElementById('demandChart');
    if (!demandChartElem) return;
    const ctx = demandChartElem.getContext('2d');
    
    // Función para procesar los datos recibidos
    function processData(data) {
        const simulatePreview = data.simulate_preview;
        const demandConfigs = data.demand_configurations_preview;
        const resultSimulation = data.result_simulation_preview;
        
        // Obtener historial de demanda
        const demandHistory = simulatePreview.demand_history;
        const quantityTime = simulatePreview.quantity_time;
        
        // Generar etiquetas para los días
        const days = Array.from({length: quantityTime}, (_, i) => i + 1);
        
        // Calcular demanda base promedio de las configuraciones
        const baseDemandTotal = Object.values(demandConfigs).reduce((sum, config) => {
            return sum + config.base_demand;
        }, 0);
        
        // O usar la media de simulación si está disponible
        const baseDemandValue = resultSimulation.demand_mean || baseDemandTotal;
        const baselineDemand = Array(quantityTime).fill(baseDemandValue);
        
        // Obtener intervalos de confianza si están disponibles
        const confidenceIntervals = resultSimulation.confidence_intervals?.demand_mean;
        let upperBound = null;
        let lowerBound = null;
        
        if (confidenceIntervals) {
            upperBound = Array(quantityTime).fill(confidenceIntervals.upper);
            lowerBound = Array(quantityTime).fill(confidenceIntervals.lower);
        }
        
        return {
            days,
            demandHistory,
            baselineDemand,
            upperBound,
            lowerBound,
            unit: resultSimulation.unit?.measurement || 'L',
            unitTime: resultSimulation.unit_time?.time_unit || 'día'
        };
    }
    
    // Función para crear el gráfico
    function createChart(processedData) {
        const { days, demandHistory, baselineDemand, upperBound, lowerBound, unit, unitTime } = processedData;
        
        // Configurar datasets base
        const datasets = [{
            label: 'Demanda Real',
            data: demandHistory,
            borderColor: 'rgb(75, 192, 192)',
            backgroundColor: 'rgba(75, 192, 192, 0.1)',
            tension: 0.4,
            fill: false,
            pointRadius: 3,
            pointHoverRadius: 5
        }, {
            label: 'Demanda Base',
            data: baselineDemand,
            borderColor: 'rgb(255, 99, 132)',
            borderDash: [5, 5],
            fill: false,
            pointRadius: 0
        }];
        
        // Agregar intervalos de confianza si están disponibles
        if (upperBound && lowerBound) {
            datasets.push({
                label: 'Límite Superior (95% confianza)',
                data: upperBound,
                borderColor: 'rgba(255, 206, 86, 0.8)',
                borderDash: [2, 2],
                fill: false,
                pointRadius: 0
            }, {
                label: 'Límite Inferior (95% confianza)',
                data: lowerBound,
                borderColor: 'rgba(255, 206, 86, 0.8)',
                borderDash: [2, 2],
                fill: '-1',
                backgroundColor: 'rgba(255, 206, 86, 0.1)',
                pointRadius: 0
            });
        }
        
        return new Chart(ctx, {
            type: 'line',
            data: {
                labels: days.map(d => `${unitTime.charAt(0).toUpperCase() + unitTime.slice(1)} ${d}`),
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                aspectRatio: 2.5,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    title: {
                        display: true,
                        text: 'Análisis de Demanda - Histórico vs Proyección'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `${context.dataset.label}: ${context.parsed.y.toLocaleString()} ${unit}`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: false,
                        ticks: {
                            callback: function(value) {
                                return value.toLocaleString() + ' ' + unit;
                            }
                        },
                        title: {
                            display: true,
                            text: `Demanda (${unit})`
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Período de Tiempo'
                        }
                    }
                },
                interaction: {
                    intersect: false,
                    mode: 'index'
                }
            }
        });
    }
    
    // Función principal para inicializar el gráfico con datos
    function initializeChart(data) {
        try {
            const processedData = processData(data);
            return createChart(processedData);
        } catch (error) {
            console.error('Error al procesar los datos:', error);
            
            // Fallback con datos de ejemplo si hay error
            const fallbackData = {
                days: Array.from({length: 30}, (_, i) => i + 1),
                demandHistory: Array.from({length: 30}, () => Math.floor(Math.random() * 1000) + 2000),
                baselineDemand: Array(30).fill(2500),
                upperBound: null,
                lowerBound: null,
                unit: 'L',
                unitTime: 'día'
            };
            
            return createChart(fallbackData);
        }
    }
    
    // Ejemplo de uso con los datos proporcionados
    const sampleData = {
        'simulate_preview': {
            'unit_time': 'day', 
            'quantity_time': 30, 
            'confidence_level': 0.95, 
            'random_seed': 42, 
            'fk_fdp': 1, 
            'demand_history': [2912, 2343, 2667, 2889, 2703, 2957, 3288, 2458, 2277, 2659, 2410, 2665, 3098, 2435, 1851, 2271, 2288, 2623, 2574, 2706, 3301, 2242, 3612, 2203, 2426, 2849, 3516, 3049, 2165, 2373], 
            'fk_questionary_result': null
        }, 
        'demand_configurations_preview': {
            'leche': {'base_demand': 3000, 'seasonality': true, 'growth_rate': 0.02, 'volatility': 0.1}, 
            'yogurt': {'base_demand': 1500, 'seasonality': true, 'growth_rate': 0.05, 'volatility': 0.15}, 
            'queso': {'base_demand': 800, 'seasonality': false, 'growth_rate': 0.01, 'volatility': 0.08}
        }, 
        'result_simulation_preview': {
            'demand_mean': 2500.0, 
            'demand_std_deviation': 250.0, 
            'confidence_intervals': {
                'demand_mean': {'lower': 2400.0, 'upper': 2600.0}
            }, 
            'unit': {'measurement': 'litros', 'value': 1}, 
            'unit_time': {'time_unit': 'día', 'value': 1}
        }
    };
    
    // Inicializar el gráfico
    // Para usar datos reales, reemplaza sampleData con tu objeto de datos
    const chart = initializeChart(sampleData);
    
    // Exponer función globalmente para uso externo
    window.updateDemandChart = function(newData) {
        chart.destroy();
        return initializeChart(newData);
    };
});

// Form submission confirmation
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Get the form element
    const confirmForm = document.getElementById('confirmForm');
    
    if (confirmForm) {
        confirmForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Show confirmation modal
            Swal.fire({
                title: '¿Confirmar creación?',
                html: `
                    <div class="text-start">
                        <p class="mb-3">Se creará la siguiente configuración inicial:</p>
                        <ul class="list-unstyled">
                            <li class="mb-2">
                                <i class="ri-check-circle-fill text-success me-2"></i>
                                <strong>7 productos lácteos</strong> predefinidos
                            </li>
                            <li class="mb-2">
                                <i class="ri-check-circle-fill text-success me-2"></i>
                                <strong>12 áreas operativas</strong> del negocio
                            </li>
                            <li class="mb-2">
                                <i class="ri-check-circle-fill text-success me-2"></i>
                                <strong>30+ variables financieras</strong> configuradas
                            </li>
                            <li class="mb-2">
                                <i class="ri-check-circle-fill text-success me-2"></i>
                                <strong>Simulación de 30 días</strong> inicializada
                            </li>
                        </ul>
                        <div class="alert alert-info mt-3 mb-0">
                            <i class="ri-information-line me-2"></i>
                            <strong>Nota:</strong> Podrá personalizar todo después de la creación.
                        </div>
                    </div>
                `,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#6c757d',
                confirmButtonText: '<i class="ri-check-line me-1"></i> Sí, crear configuración',
                cancelButtonText: '<i class="ri-close-line me-1"></i> Cancelar',
                buttonsStyling: true,
                customClass: {
                    popup: 'swal2-popup-custom',
                    confirmButton: 'btn btn-primary',
                    cancelButton: 'btn btn-secondary'
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    // Show loading modal
                    Swal.fire({
                        title: 'Creando configuración...',
                        html: `
                            <div class="text-center">
                                <div class="spinner-border text-primary mb-3" role="status">
                                    <span class="visually-hidden">Cargando...</span>
                                </div>
                                <p class="mb-0">Por favor espere mientras configuramos su sistema.</p>
                                <small class="text-muted">Este proceso puede tomar unos segundos.</small>
                            </div>
                        `,
                        allowOutsideClick: false,
                        allowEscapeKey: false,
                        showConfirmButton: false,
                        didOpen: () => {
                            // Disable the confirm button during loading
                            const createBtn = document.getElementById('createConfigBtn');
                            if (createBtn) {
                                createBtn.disabled = true;
                            }
                        }
                    });
                    
                    // Submit the form after a short delay for better UX
                    setTimeout(() => {
                        confirmForm.submit();
                    }, 500);
                }
            });
        });
    }
});
</script>

<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
{% endblock extra_js %}