{% extends "partials/base.html" %}
{% load static %}
{% block title %}Vista Previa de Configuración - FindEMPro{% endblock title %}
{% block extra_css %}
<style>
    .d3-tooltip {
        pointer-events: none;
        z-index: 1000;
    }
    
    #areasNetworkGraph {
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        background-color: #fff;
        position: relative;
        min-height: 600px;
    }
    
    #historicalDemandChart {
        min-height: 400px;
    }
    
    .nav-tabs .nav-link.active {
        font-weight: 600;
        border-bottom: 3px solid var(--vz-primary);
    }
    
    canvas {
        max-height: 400px !important;
    }

    #demandChart {
        max-height: 320px;
        min-height: 220px;
        height: 320px !important;
    }
    
    .preview-card {
        border: 2px solid transparent;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
        min-height: 200px;
    }
    
    .preview-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        border-color: var(--vz-primary);
    }
    
    .preview-badge {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 1;
    }
    
    .metric-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        padding: 20px;
        position: relative;
        overflow: hidden;
    }
    
    .metric-card::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -50%;
        width: 200%;
        height: 200%;
        background: rgba(255, 255, 255, 0.1);
        transform: rotate(45deg);
    }
    
    .data-preview-table {
        font-size: 0.875rem;
    }
    
    .data-preview-table th {
        background-color: var(--vz-light);
        font-weight: 600;
    }
    
    .demo-indicator {
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.6; }
        100% { opacity: 1; }
    }
    
    .feature-icon {
        width: 48px;
        height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: var(--vz-primary-bg-subtle);
        border-radius: 12px;
        font-size: 24px;
    }
    
    .info-tooltip {
        cursor: help;
        color: var(--vz-info);
    }
    
    .config-summary {
        background-color: var(--vz-light);
        border-radius: 10px;
        padding: 20px;
    }
    
    .timeline-item {
        position: relative;
        padding-left: 40px;
        padding-bottom: 30px;
    }
    
    .timeline-item:before {
        content: '';
        position: absolute;
        left: 15px;
        top: 5px;
        height: calc(100% - 5px);
        width: 2px;
        background-color: var(--vz-border-color);
    }
    
    .timeline-item:last-child:before {
        display: none;
    }
    
    .timeline-dot {
        position: absolute;
        left: 10px;
        top: 0;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background-color: var(--vz-primary);
        border: 2px solid white;
        box-shadow: 0 0 0 3px var(--vz-primary-bg-subtle);
    }
</style>
{% endblock extra_css %}
{% block content %}
<div class="main-content">
    <div class="page-content">
        <div class="container-fluid">
            <!-- Page Title -->
            <div class="row">
                <div class="col-12">
                    <div class="page-title-box d-sm-flex align-items-center justify-content-between">
                        <h4 class="mb-sm-0">Vista Previa de Configuración Inicial</h4>
                        <div class="page-title-right">
                            <ol class="breadcrumb m-0">
                                <li class="breadcrumb-item"><a href="{% url 'dashboard:index' %}">Dashboard</a></li>
                                <li class="breadcrumb-item active">Vista Previa</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>

            {% if preview_data.error %}
            <!-- Error Alert -->
            <div class="alert alert-danger" role="alert">
                <h5 class="alert-heading">Error al cargar datos</h5>
                <p>{{ preview_data.message }}</p>
            </div>
            {% else %}
            
            <!-- Alert Banner -->
            <div class="alert alert-info alert-dismissible fade show" role="alert">
                <div class="d-flex align-items-center">
                    <i class="ri-information-line fs-3 me-3"></i>
                    <div>
                        <h5 class="alert-heading">Configuración de Demostración</h5>
                        <p class="mb-0">Esta es una vista previa de la configuración que se creará automáticamente para su empresa láctea. 
                        Todos los valores mostrados son datos de ejemplo que podrá personalizar posteriormente.</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>

            <!-- Summary Statistics Section -->
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title mb-3">
                                <i class="ri-bar-chart-box-line me-2"></i>Resumen de Elementos
                            </h5>
                            <div class="row text-center g-3">
                                <div class="col-md-2 col-6">
                                    <div class="border rounded p-3">
                                        <h3 class="text-primary mb-1">{{ preview_data.summary_stats.total_products }}</h3>
                                        <p class="text-muted mb-0">Productos</p>
                                    </div>
                                </div>
                                <div class="col-md-2 col-6">
                                    <div class="border rounded p-3">
                                        <h3 class="text-info mb-1">{{ preview_data.summary_stats.total_areas }}</h3>
                                        <p class="text-muted mb-0">Áreas</p>
                                    </div>
                                </div>
                                <div class="col-md-2 col-6">
                                    <div class="border rounded p-3">
                                        <h3 class="text-success mb-1">{{ preview_data.summary_stats.total_variables }}</h3>
                                        <p class="text-muted mb-0">Variables</p>
                                    </div>
                                </div>
                                <div class="col-md-2 col-6">
                                    <div class="border rounded p-3">
                                        <h3 class="text-warning mb-1">{{ preview_data.summary_stats.total_equations }}</h3>
                                        <p class="text-muted mb-0">Ecuaciones</p>
                                    </div>
                                </div>
                                <div class="col-md-2 col-6">
                                    <div class="border rounded p-3">
                                        <h3 class="text-danger mb-1">{{ preview_data.summary_stats.total_questions }}</h3>
                                        <p class="text-muted mb-0">Preguntas</p>
                                    </div>
                                </div>
                                <div class="col-md-2 col-6">
                                    <div class="border rounded p-3">
                                        <h3 class="text-purple mb-1">{{ preview_data.summary_stats.total_simulations }}</h3>
                                        <p class="text-muted mb-0">Simulaciones</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Product-Specific Data -->
            <div class="row mt-4">
                {% for key, config in preview_data.demand_configurations_preview.items %}
                <div class="col-lg-4">
                    <div class="card">
                        <div class="card-header bg-light">
                            <h5 class="card-title mb-0">
                                {% if key == 'leche' %}<i class="ri-drop-line me-2"></i>
                                {% elif key == 'queso' %}<i class="ri-cheese-line me-2"></i>
                                {% else %}<i class="ri-cup-line me-2"></i>{% endif %}
                                {{ key|title }}
                            </h5>
                        </div>
                        <div class="card-body">
                            <!-- Product Configuration -->
                            <div class="mb-4">
                                <h6 class="text-muted mb-3">Configuración Base</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <tbody>
                                            <tr>
                                                <td>Demanda Base:</td>
                                                <td class="text-end">{{ config.base_demand }} unidades</td>
                                            </tr>
                                            <tr>
                                                <td>Estacionalidad:</td>
                                                <td class="text-end">
                                                    <span class="badge {% if config.seasonality %}bg-success{% else %}bg-secondary{% endif %}">
                                                        {% if config.seasonality %}Sí{% else %}No{% endif %}
                                                    </span>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td>Crecimiento:</td>
                                                <td class="text-end">{{ config.growth_rate|floatformat:2 }}%</td>
                                            </tr>
                                            <tr>
                                                <td>Volatilidad:</td>
                                                <td class="text-end">{{ config.volatility|floatformat:2 }}%</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Statistics -->
                            {% with stats=preview_data.result_simulation_preview %}
                            <div class="row g-2">
                                <div class="col-6">
                                    <div class="border rounded p-2 text-center">
                                        <small class="text-muted d-block">Media</small>
                                        <strong>{{ stats.demand_mean|floatformat:0 }}</strong>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="border rounded p-2 text-center">
                                        <small class="text-muted d-block">Desv. Est.</small>
                                        <strong>{{ stats.demand_std_deviation|floatformat:1 }}</strong>
                                    </div>
                                </div>
                            </div>
                            {% endwith %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Areas Network Graph -->
            <div class="row mt-4">
                <div class="col-lg-12">
                    <div class="card">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="card-title mb-0">
                                    <i class="ri-mind-map me-2"></i>Relaciones entre Áreas Operativas
                                </h5>
                                <div class="card-header-action">
                                    <button type="button" class="btn btn-soft-primary btn-sm" 
                                            data-bs-toggle="tooltip" 
                                            title="Arrastre los nodos para reorganizar. Use la rueda del mouse para hacer zoom.">
                                        <i class="ri-information-line"></i> Ayuda
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="areasNetworkGraph"></div>
                            <div class="mt-3 text-center">
                                <small class="text-muted">
                                    <i class="ri-information-line"></i> 
                                    Este grafo muestra las interconexiones entre las {{ preview_data.areas_preview|length }} áreas operativas.
                                    Los nodos más grandes tienen más conexiones. Puede arrastrar y hacer zoom.
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Historical Demand Analysis -->
            <div class="row mt-4">
                <div class="col-lg-12">
                    <div class="card">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="card-title mb-0">
                                    <i class="ri-line-chart-line me-2"></i>Análisis de Demandas Históricas por Producto
                                </h5>
                                <span class="badge bg-info">
                                    {{ preview_data.summary_stats.total_simulations }} Simulaciones
                                </span>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="historicalDemandChart"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Variables Distribution -->
            <div class="row mt-4">
                <div class="col-lg-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="ri-pie-chart-2-line me-2"></i>Distribución de Variables
                            </h5>
                        </div>
                        <div class="card-body">
                            <canvas id="variablesTypeChart" height="300"></canvas>
                            <div class="mt-3">
                                <ul class="list-unstyled">
                                    <li class="mb-2">
                                        <i class="ri-input-method-line text-warning me-2"></i>
                                        <strong>Exógenas:</strong> Variables de entrada que el usuario controla
                                    </li>
                                    <li class="mb-2">
                                        <i class="ri-refresh-line text-info me-2"></i>
                                        <strong>Estado:</strong> Variables que mantienen el estado del sistema
                                    </li>
                                    <li class="mb-2">
                                        <i class="ri-output-line text-success me-2"></i>
                                        <strong>Endógenas:</strong> Variables calculadas por el sistema
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Simulation Metrics -->
                <div class="col-lg-8">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="ri-dashboard-3-line me-2"></i>Métricas de Simulación por Producto
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Producto</th>
                                            <th>Escenarios</th>
                                            <th>Distribución PDF</th>
                                            <th>Demanda Base</th>
                                            <th>ROI Esperado</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for product, data in preview_data.simulations_preview.items %}
                                        <tr>
                                            <td><strong>{{ product|title }}</strong></td>
                                            <td>
                                                <div class="d-flex gap-1">
                                                    {% for sim in data.simulations %}
                                                    <span class="badge bg-{{ forloop.counter|yesno:'success,warning,danger' }}-subtle 
                                                                text-{{ forloop.counter|yesno:'success,warning,danger' }}" 
                                                        data-bs-toggle="tooltip" 
                                                        title="{{ sim.description }}">
                                                        {{ sim.scenario }}
                                                    </span>
                                                    {% endfor %}
                                                </div>
                                            </td>
                                            <td>
                                                {% if data.pdf_config.name %}
                                                    <span class="badge bg-info-subtle text-info">
                                                        {{ data.pdf_config.name|truncatechars:20 }}
                                                    </span>
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if data.result_data.demand_mean %}
                                                    {{ data.result_data.demand_mean|floatformat:0 }}
                                                {% else %}
                                                    <span class="text-muted">2500</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if data.simulations %}
                                                    <span class="text-success">
                                                        {% with first_sim=data.simulations|first last_sim=data.simulations|last %}
                                                            {{ first_sim.expected_results.roi|floatformat:0 }}% - 
                                                            {{ last_sim.expected_results.roi|floatformat:0 }}%
                                                        {% endwith %}
                                                    </span>
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Questions Preview -->
            <div class="row mt-4">
                <div class="col-lg-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="ri-question-answer-line me-2"></i>Preguntas con Respuestas de Ejemplo
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="accordion" id="questionsAccordion">
                                {% for question in preview_data.question_preview|slice:":5" %}
                                <div class="accordion-item">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                            data-bs-target="#question{{ forloop.counter }}">
                                            {{ question.question }}
                                            <span class="badge bg-primary ms-2">{{ question.initials_variable }}</span>
                                        </button>
                                    </h2>
                                    <div id="question{{ forloop.counter }}" class="accordion-collapse collapse" 
                                        data-bs-parent="#questionsAccordion">
                                        <div class="accordion-body">
                                            <div class="row">
                                                {% for product, answer in question.sample_answers.items %}
                                                <div class="col-md-4">
                                                    <div class="card bg-light">
                                                        <div class="card-body">
                                                            <h6 class="card-title text-capitalize">{{ product }}</h6>
                                                            <p class="mb-1">
                                                                <strong>Respuesta:</strong> 
                                                                {% if answer.answer|length > 50 %}
                                                                {{ answer.answer|truncatechars:50 }}
                                                                {% else %}
                                                                {{ answer.answer }}
                                                                {% endif %}
                                                            </p>
                                                            {% if answer.unit %}
                                                                <small class="text-muted">Unidad: {{ answer.unit }}</small>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="row mt-4">
                <div class="col-lg-12">
                    <div class="card bg-primary-subtle border-0">
                        <div class="card-body">
                            <div class="text-center py-3">
                                <h5 class="mb-3">¿Listo para comenzar?</h5>
                                <p class="text-muted mb-4">
                                    Al continuar, se creará automáticamente toda esta configuración para su empresa.
                                    <br>Podrá personalizar todos los valores después de la creación inicial.
                                </p>
                                
                                <!-- Form that triggers the confirmation modal -->
                                <form method="post" id="confirmForm" action="{% url 'pages:pages.register_elements_create' %}">
                                    {% csrf_token %}
                                    <input type="hidden" name="confirm_setup" value="true">
                                    
                                    <div class="d-flex gap-2 justify-content-center">
                                        <a href="{% url 'dashboard:index' %}" class="btn btn-light">
                                            <i class="ri-arrow-left-line me-1"></i> Volver
                                        </a>
                                        <button type="submit" class="btn btn-primary" id="createConfigBtn">
                                            <i class="ri-check-line me-1"></i> Crear Configuración
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            {% endif %}
        </div>
        <!-- container-fluid -->
    </div>
    <!-- End Page-content -->

    {% block footer %}
    {% include "partials/footer.html" %}
    {% endblock footer %}
</div>
<!-- end main content-->
{% endblock content %}

{% block extra_js %}
<!-- Required libraries -->
<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
// Data preparation with error handling
const previewData = {
    areas_preview: {{ preview_data.areas_preview|safe|default:"[]" }},
    simulations_preview: {{ preview_data.simulations_preview|safe|default:"{}" }},
    demand_configurations_preview: {{ preview_data.demand_configurations_preview|safe|default:"{}" }},
    result_simulation_preview: {{ preview_data.result_simulation_preview|safe|default:"{}" }},
    simulate_preview: {{ preview_data.simulate_preview|safe|default:"{}" }},
    summary_stats: {
        variables_by_type: {{ preview_data.summary_stats.variables_by_type|safe|default:"{}" }}
    }
};

// Initialize all visualizations
document.addEventListener('DOMContentLoaded', function() {
    // Create areas network graph
    if (document.getElementById('areasNetworkGraph') && previewData.areas_preview.length > 0) {
        createAreasNetworkGraph(previewData.areas_preview);
    }
    
    // Create historical demand chart
    if (document.getElementById('historicalDemandChart') && Object.keys(previewData.simulations_preview).length > 0) {
        createHistoricalDemandChart(previewData.simulations_preview);
    }
    
    // Create variables type chart
    if (document.getElementById('variablesTypeChart')) {
        createVariablesTypeChart(previewData.summary_stats.variables_by_type);
    }
    
    // Create demand projections for each product
    createProductDemandCharts(previewData.demand_configurations_preview);
    
    // Initialize tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // Form submission confirmation
    initializeFormConfirmation();
});

// Areas Network Graph with D3.js
function createAreasNetworkGraph(areasData) {
    const container = document.getElementById('areasNetworkGraph');
    if (!container || !areasData.length) return;
    
    const width = container.offsetWidth || 800;
    const height = 600;
    
    // Prepare nodes and links
    const nodes = [];
    const links = [];
    const nodeMap = {};
    
    areasData.forEach(area => {
        if (!nodeMap[area.name]) {
            nodeMap[area.name] = {
                id: area.name,
                group: getAreaGroup(area.name),
                description: area.description,
                kpis: area.kpis || {}
            };
            nodes.push(nodeMap[area.name]);
        }
        
        if (area.relationships) {
            area.relationships.forEach(target => {
                if (target === "Todas las áreas") {
                    areasData.forEach(otherArea => {
                        if (otherArea.name !== area.name) {
                            links.push({
                                source: area.name,
                                target: otherArea.name,
                                value: 0.5
                            });
                        }
                    });
                } else if (areasData.some(a => a.name === target)) {
                    links.push({
                        source: area.name,
                        target: target,
                        value: 1
                    });
                }
            });
        }
    });
    
    // Create SVG
    const svg = d3.select("#areasNetworkGraph")
        .append("svg")
        .attr("width", width)
        .attr("height", height)
        .attr("viewBox", [0, 0, width, height]);
    
    // Create simulation
    const simulation = d3.forceSimulation(nodes)
        .force("link", d3.forceLink(links).id(d => d.id).distance(120))
        .force("charge", d3.forceManyBody().strength(-400))
        .force("center", d3.forceCenter(width / 2, height / 2))
        .force("collision", d3.forceCollide().radius(35));
    
    // Create zoom behavior
    const g = svg.append("g");
    const zoom = d3.zoom()
        .scaleExtent([0.5, 4])
        .on("zoom", (event) => {
            g.attr("transform", event.transform);
        });
    svg.call(zoom);
    
    // Create links
    const link = g.append("g")
        .attr("stroke", "#999")
        .attr("stroke-opacity", 0.6)
        .selectAll("line")
        .data(links)
        .join("line")
        .attr("stroke-width", d => Math.sqrt(d.value) * 2);
    
    // Create nodes
    const node = g.append("g")
        .attr("stroke", "#fff")
        .attr("stroke-width", 1.5)
        .selectAll("circle")
        .data(nodes)
        .join("circle")
        .attr("r", d => {
            const connections = links.filter(l => l.source.id === d.id || l.target.id === d.id).length;
            return Math.min(20 + connections * 2, 35);
        })
        .attr("fill", d => getAreaColor(d.group))
        .call(drag(simulation));
    
    // Add labels
    const label = g.append("g")
        .selectAll("text")
        .data(nodes)
        .join("text")
        .text(d => d.id)
        .attr("font-size", 12)
        .attr("dx", 25)
        .attr("dy", 4);
    
    // Add tooltip
    const tooltip = d3.select("body").append("div")
        .attr("class", "d3-tooltip")
        .style("opacity", 0)
        .style("position", "absolute")
        .style("background", "rgba(0, 0, 0, 0.9)")
        .style("color", "white")
        .style("padding", "12px")
        .style("border-radius", "6px")
        .style("font-size", "12px");
    
    node.on("mouseover", function(event, d) {
        tooltip.transition().duration(200).style("opacity", .9);
        tooltip.html(`<strong>${d.id}</strong><br/>${d.description || ''}`)
            .style("left", (event.pageX + 10) + "px")
            .style("top", (event.pageY - 28) + "px");
    })
    .on("mouseout", function(d) {
        tooltip.transition().duration(500).style("opacity", 0);
    });
    
    // Update positions
    simulation.on("tick", () => {
        link
            .attr("x1", d => d.source.x)
            .attr("y1", d => d.source.y)
            .attr("x2", d => d.target.x)
            .attr("y2", d => d.target.y);
        
        node
            .attr("cx", d => d.x)
            .attr("cy", d => d.y);
        
        label
            .attr("x", d => d.x)
            .attr("y", d => d.y);
    });
    
    // Drag behavior
    function drag(simulation) {
        function dragstarted(event) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            event.subject.fx = event.subject.x;
            event.subject.fy = event.subject.y;
        }
        
        function dragged(event) {
            event.subject.fx = event.x;
            event.subject.fy = event.y;
        }
        
        function dragended(event) {
            if (!event.active) simulation.alphaTarget(0);
            event.subject.fx = null;
            event.subject.fy = null;
        }
        
        return d3.drag()
            .on("start", dragstarted)
            .on("drag", dragged)
            .on("end", dragended);
    }
}

// Historical Demand Chart
function createHistoricalDemandChart(simulationsData) {
    const container = document.getElementById('historicalDemandChart');
    if (!container) return;
    
    // Create tabs structure
    let tabsHTML = '<ul class="nav nav-tabs mb-3" role="tablist">';
    let contentHTML = '<div class="tab-content">';
    let isFirst = true;
    
    Object.entries(simulationsData).forEach(([product, data]) => {
        const activeClass = isFirst ? 'active' : '';
        const productId = product.replace(/\s+/g, '');
        
        tabsHTML += `
            <li class="nav-item">
                <a class="nav-link ${activeClass}" data-bs-toggle="tab" href="#demand${productId}" role="tab">
                    ${getProductIcon(product)} ${product.charAt(0).toUpperCase() + product.slice(1)}
                </a>
            </li>
        `;
        
        contentHTML += `
            <div class="tab-pane ${activeClass}" id="demand${productId}" role="tabpanel">
                <canvas id="chart${productId}" height="100"></canvas>
                <div id="analysis${productId}" class="mt-3"></div>
            </div>
        `;
        
        isFirst = false;
    });
    
    tabsHTML += '</ul>';
    contentHTML += '</div>';
    
    container.innerHTML = tabsHTML + contentHTML;
    
    // Create charts for each product
    setTimeout(() => {
        Object.entries(simulationsData).forEach(([product, data]) => {
            const productId = product.replace(/\s+/g, '');
            createProductChart(`chart${productId}`, product, data);
        });
    }, 100);
}

// Variables Type Chart
function createVariablesTypeChart(variablesByType) {
    const canvas = document.getElementById('variablesTypeChart');
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Exógenas (Entrada)', 'Estado', 'Endógenas (Salida)'],
            datasets: [{
                data: [
                    variablesByType.exogenas || 0,
                    variablesByType.estado || 0,
                    variablesByType.endogenas || 0
                ],
                backgroundColor: [
                    'rgba(255, 206, 86, 0.8)',
                    'rgba(54, 162, 235, 0.8)',
                    'rgba(75, 192, 192, 0.8)'
                ],
                borderColor: [
                    'rgba(255, 206, 86, 1)',
                    'rgba(54, 162, 235, 1)',
                    'rgba(75, 192, 192, 1)'
                ],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                },
                title: {
                    display: true,
                    text: 'Distribución de Variables por Tipo'
                }
            }
        }
    });
}

// Helper functions
function getAreaGroup(areaName) {
    const groups = {
        "Abastecimiento": 1,
        "Inventario Insumos": 2,
        "Inventario Productos Finales": 2,
        "Producción": 3,
        "Control de Calidad": 3,
        "Distribución": 4,
        "Ventas": 4,
        "Marketing": 5,
        "Competencia": 5,
        "Contabilidad": 6,
        "Recursos Humanos": 7,
        "Mantenimiento": 8
    };
    return groups[areaName] || 0;
}

function getAreaColor(group) {
    const colors = ["#e41a1c", "#377eb8", "#4daf4a", "#984ea3", "#ff7f00", "#ffff33", "#a65628", "#f781bf"];
    return colors[group % colors.length];
}

function getProductIcon(product) {
    const icons = {
        'leche': '<i class="ri-drop-line me-1"></i>',
        'queso': '<i class="ri-cheese-line me-1"></i>',
        'yogur': '<i class="ri-cup-line me-1"></i>',
        'mantequilla': '<i class="ri-cake-line me-1"></i>',
        'crema': '<i class="ri-water-flash-line me-1"></i>',
        'dulce': '<i class="ri-heart-line me-1"></i>'
    };
    return icons[product.toLowerCase()] || '<i class="ri-product-hunt-line me-1"></i>';
}

function createProductChart(canvasId, productName, productData) {
    const canvas = document.getElementById(canvasId);
    if (!canvas || !productData.simulations) return;
    
    const ctx = canvas.getContext('2d');
    
    const datasets = productData.simulations.map((sim, index) => {
        const colors = ['rgb(75, 192, 192)', 'rgb(255, 206, 86)', 'rgb(255, 99, 132)'];
        return {
            label: sim.name || sim.scenario,
            data: sim.demand_history || [],
            borderColor: colors[index % colors.length],
            backgroundColor: colors[index % colors.length].replace('rgb', 'rgba').replace(')', ', 0.1)'),
            tension: 0.4
        };
    });
    
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: Array.from({length: 30}, (_, i) => `Día ${i + 1}`),
            datasets: datasets
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: `Simulaciones de Demanda - ${productName.charAt(0).toUpperCase() + productName.slice(1)}`
                }
            },
            scales: {
                y: {
                    beginAtZero: false
                }
            }
        }
    });
}

function createProductDemandCharts(demandConfigurations) {
    Object.entries(demandConfigurations).forEach(([key, config]) => {
        const canvasId = `demandChart${key.charAt(0).toUpperCase() + key.slice(1).replace(/\s+/g, '')}`;
        const canvas = document.getElementById(canvasId);
        if (!canvas) return;
        
        const ctx = canvas.getContext('2d');
        const periods = 30;
        const baseDemand = config.base_demand;
        const growth = config.growth_rate;
        const volatility = config.volatility;
        
        // Generate scenarios
        const optimistic = Array(periods).fill().map((_, i) => {
            return baseDemand * (1 + growth * 1.5) ** i * (1 + Math.random() * volatility);
        });
        
        const baseline = Array(periods).fill().map((_, i) => {
            return baseDemand * (1 + growth) ** i * (1 + (Math.random() - 0.5) * volatility);
        });
        
        const pessimistic = Array(periods).fill().map((_, i) => {
            return baseDemand * (1 + growth * 0.5) ** i * (1 - Math.random() * volatility);
        });
        
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: Array.from({length: periods}, (_, i) => `Día ${i+1}`),
                datasets: [{
                    label: 'Optimista',
                    data: optimistic,
                    borderColor: 'rgba(75, 192, 192, 1)',
                    backgroundColor: 'rgba(75, 192, 192, 0.1)',
                    fill: false
                }, {
                    label: 'Base',
                    data: baseline,
                    borderColor: 'rgba(54, 162, 235, 1)',
                    backgroundColor: 'rgba(54, 162, 235, 0.1)',
                    fill: false
                }, {
                    label: 'Pesimista',
                    data: pessimistic,
                    borderColor: 'rgba(255, 99, 132, 1)',
                    backgroundColor: 'rgba(255, 99, 132, 0.1)',
                    fill: false
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: `Proyección de Demanda - ${key.charAt(0).toUpperCase() + key.slice(1)}`
                    }
                },
                scales: {
                    y: {
                        beginAtZero: false
                    }
                }
            }
        });
    });
}

function initializeFormConfirmation() {
    const confirmForm = document.getElementById('confirmForm');
    if (!confirmForm) return;
    
    confirmForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        Swal.fire({
            title: '¿Confirmar creación?',
            html: `
                <div class="text-start">
                    <p class="mb-3">Se creará la siguiente configuración inicial:</p>
                    <ul class="list-unstyled">
                        <li class="mb-2">
                            <i class="ri-check-circle-fill text-success me-2"></i>
                            <strong>${previewData.summary_stats.total_products || 7} productos lácteos</strong> predefinidos
                        </li>
                        <li class="mb-2">
                            <i class="ri-check-circle-fill text-success me-2"></i>
                            <strong>${previewData.summary_stats.total_areas || 12} áreas operativas</strong> del negocio
                        </li>
                        <li class="mb-2">
                            <i class="ri-check-circle-fill text-success me-2"></i>
                            <strong>${previewData.summary_stats.total_variables || 30}+ variables</strong> configuradas
                        </li>
                        <li class="mb-2">
                            <i class="ri-check-circle-fill text-success me-2"></i>
                            <strong>Simulación de 30 días</strong> inicializada
                        </li>
                    </ul>
                    <div class="alert alert-info mt-3 mb-0">
                        <i class="ri-information-line me-2"></i>
                        <strong>Nota:</strong> Podrá personalizar todo después de la creación.
                    </div>
                </div>
            `,
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#6c757d',
            confirmButtonText: '<i class="ri-check-line me-1"></i> Sí, crear configuración',
            cancelButtonText: '<i class="ri-close-line me-1"></i> Cancelar'
        }).then((result) => {
            if (result.isConfirmed) {
                Swal.fire({
                    title: 'Creando configuración...',
                    html: `
                        <div class="text-center">
                            <div class="spinner-border text-primary mb-3" role="status">
                                <span class="visually-hidden">Cargando...</span>
                            </div>
                            <p class="mb-0">Por favor espere mientras configuramos su sistema.</p>
                            <small class="text-muted">Este proceso puede tomar unos segundos.</small>
                        </div>
                    `,
                    allowOutsideClick: false,
                    allowEscapeKey: false,
                    showConfirmButton: false
                });
                
                setTimeout(() => {
                    confirmForm.submit();
                }, 500);
            }
        });
    });
}
</script>
{% endblock extra_js %}