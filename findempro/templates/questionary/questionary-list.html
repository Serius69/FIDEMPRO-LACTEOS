{% extends "partials/base.html" %}
{% load static %}
{% block title %}Questionary{% endblock title %}
{% block extra_css %}
{% endblock extra_css %}
{% block content %}
            <!-- ============================================================== -->
            <!-- Start right Content here -->
            <!-- ============================================================== -->
            <div class="main-content">
                <div class="page-content">
                    <div class="container-fluid">
                        {% block pagetitle %}
                        {% include "partials/page-title.html" with pagetitle="questions" title="Questionary" %}
                        {% endblock pagetitle %}
                        <div class="card rounded-0 bg-success-subtle mx-n4 mt-n4 border-top">
                            <div class="px-4">
                                <div class="row">
                                    <div class="col-xxl-9 align-self-center">
                                        <div class="py-4">
                                            <h4 class="display-6 -text">QUESTIONARY</h4>
                                            <div class="container">
                                                <p>
                                                    Choose the questionary of the Product that you want to add information to. With this information, we provide you the possibility to make simulations and understand the state of your business.
                                                </p>
                                                <h2>Key Features:</h2>
                                                <ul>
                                                    <li><span class="text-success">Start Questionary:</span> Begin answering questions about your product.</li>
                                                    <li><span class="text-info">Questionary Options:</span> Choose the questionary that you want to respond to.</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-xxl-3 ms-auto">
                                        <div class="mb-n5 pb-1 faq-img d-none d-xxl-block">
                                            <img src="{% static 'images/questionary-img.webp'%}" alt="Product Image" class="img-fluid" style="width: 200%; height: 150%;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header border-0 rounded">
                                <div class="row g-6 mb-4">
                                    <div class="col-md-4">
                                        <form method="GET" action="{% url 'questionary:questionary.list' %}" onsubmit="return validateForm()">
                                            {% csrf_token %}
                                            <div class="input-group mb-2">
                                                <label class="input-group-text" for="inputGroupSelect01">Questionary Options</label>
                                                <select class="form-select" id="inputGroupSelect01" name="selected_questionary">
                                                    {% for questionary in questionnaires %}
                                                        <option value="{{ questionary.id }}" {% if questionary.id == selected_questionary_id %}selected{% endif %}>
                                                            {{ questionary.questionary }}
                                                        </option>
                                                    {% endfor %}
                                                </select>
                                            </div> 
                                            {% if not started %}
                                                <div class="d-grid gap-1">
                                                    <button type="submit" name="select" class="btn btn-primary">Select</button>
                                                </div>
                                            {% else %}                                          
                                            {% endif %}
                                        </form>

                                        {% if not started %}
                                            <div class="d-grid gap-1">
                                                <form method="POST" action="{% url 'questionary:questionary.list' %}">
                                                    {% csrf_token %}
                                                    <button type="submit" name="start" class="btn btn-primary">Start Questionary</button>
                                                </form>
                                            </div>
                                        {% endif %}
                                        {% if started %}
                                        <div class="col-sm-auto">
                                            <ul class="pagination pagination-separated pagination-sm justify-content-center justify-content-sm-start mb-0">
                                                {% for i in questions_to_answer.paginator.page_range %}
                                                    {% if forloop.counter0|divisibleby:5 %}<div class="row">{% endif %}
                                                    <li class="page-item {% if i == questions_to_answer.number %}active{% endif %}">
                                                        <a href="?page={{ i }}" class="page-link">{{ i }}</a>
                                                    </li>
                                                    {% if forloop.counter|divisibleby:5 or forloop.last %}</div>{% endif %}
                                                {% endfor %}                                        
                                            </ul>

                                            <ul>
                                                {% if questions_to_answer.has_Anterior %}
                                                <li class="page-item">
                                                    <a href="?page={{ questions_to_answer.Anterior_page_number }}" class="page-link">
                                                        ←
                                                    </a>
                                                </li>
                                                {% if questions_to_answer.has_next %}
                                                    <li class="page-item">
                                                        <a href="?page={{ questions_to_answer.next_page_number }}" class="page-link">
                                                            →
                                                        </a>
                                                    </li>
                                                {% endif %}
                                            {% endif %}
                                            </ul>
                                        </div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-6">
                                        {% if not started %}
                                            {% if questions %}
                                                {% for question in questions %}
                                                    <div class="card questionlist-card mb-2">
                                                        <div class="card-body">
                                                            <div class="row">
                                                                <div class="col-md-6">
                                                                    <h5 class="question">Relationate Variable {{ question.fk_variable.name }}</h5>
                                                                    <p class="text-muted">Unit: {{ question.fk_variable.unit }}</p>
                                                                </div>
                                                                <div class="col-md-6">
                                                                    <label for="{{ question.id }}" class="form-label">
                                                                        <span data-key="t-home">{{ question.question }}</span>
                                                                    </label>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>                                                    
                                                {% endfor %}
                                            {% else %}
                                                <div class="text-center py-4">
                                                    <lord-icon src="https://cdn.lordicon.com/msoeawqm.json" trigger="loop" colors="primary:#405189,secondary:#0ab39c" style="width:75px;height:75px"></lord-icon>
                                                    <h5 class="mt-2">Sorry, there isn't any question in the questionary selected</h5>
                                                </div>
                                            {% endif %}
                                            <!-- Pagination -->
                                                    <div class="align-items-center mt-2 row text-center text-sm-start">
                                                        <div class="col-sm">
                                                        <div class="text-muted">
                                                            Mostrar
                                                            <span class="fw-semibold">{{ questions.number }}</span>
                                                            of
                                                            <span class="fw-semibold">
                                                            {{ questions.paginator.num_pages }}
                                                            </span>
                                                            Results
                                                        </div>
                                                        </div>
                                                        <div class="col-sm-auto">
                                                        <ul
                                                            class="pagination pagination-separated pagination-sm justify-content-center justify-content-sm-start mb-0"
                                                        >
                                                            {% if questions.has_Anterior %}
                                                            <li class="page-item">
                                                            <a href="?page={{ questions.Anterior_page_number }}" class="page-link">
                                                                ←
                                                            </a>
                                                            </li>
                                                            {% endif %} 
                                                            {% for i in questions.paginator.page_range %}
                                                            <li class="page-item {% if i == questions.number %}active{% endif %}">
                                                            <a href="?page={{ i }}" class="page-link">{{ i }}</a>
                                                            </li>
                                                            {% endfor %} 
                                                            {% if questions.has_next %}
                                                            <li class="page-item">
                                                            <a href="?page={{ questions.next_page_number }}" class="page-link">
                                                                →
                                                            </a>
                                                            </li>
                                                            {% endif %}
                                                        </ul>
                                                        </div>
                                                    </div>
                                                    <!-- end row -->
                                        {% endif %}
                                        {{ started }} 
                                        {{ selected_questionary_id }} 
                                        {{ questions_to_answer }} 
                                        {% if started %}
                                            <div class="card mb-3">
                                                <div class="card-header">
                                                    <div class="progress">
                                                        <div class="progress-bar" style="width: {% widthratio current_page total_pages 100 %}%;"></div>
                                                    </div>
                                                </div>
                                                <div class="card-body">
                                                    {% if questions_to_answer %}
                                                        {% for question in questions_to_answer %}
                                                            <form method="POST" action="{% url 'questionary:questionary.list' %}" onsubmit="return validateForm2()">
                                                                {% csrf_token %}
                                                                <h5 class="card-title">
                                                                    {% if question.fk_variable %}
                                                                        Relationate Variable {{ question.fk_variable.name }}
                                                                    {% else %}
                                                                        Relationate Variable not found
                                                                    {% endif %}
                                                                </h5>
                                                                <p class="card-text">{{ question.question }}</p>
                                                                {% if question.type == 1 %}
                                                                    <div class="input-group">
                                                                        <input type="number" value="{{ question.fk_answer.answer }}"
                                                                        class="form-control" name="question_id"
                                                                        id="question_id"
                                                                        placeholder="Answer the question only with numbers"
                                                                        required minlength="2" maxlength="10">

                                                                        <span class="input-group-text">{{ question.fk_variable.unit }}</span>
                                                                    </div>
                                                                {% elif  question.type == 2 %}
                                                                <div class="form-group">
                                                                    <label for="answer">Select an option:</label>
                                                                    <select class="form-control" id="answer" name="answer">
                                                                        {% for option in question.posible_answers %}
                                                                            <option value="{{option}}">{{option}}</option>
                                                                        {% endfor %}
                                                                    </select>
                                                                </div>
                                                                {% endif %}             
                                                                <button type="submit" name="next" class="btn btn-secondary">Next Question</button>
                                                            </form>
                                                        {% endfor %}
                                                    {% else %}
                                                        <p>No questions to answer.</p>
                                                    {% endif %}
                                                </div>
                                                <div class="card-footer">
                                                    <form method="POST" action="{% url 'questionary:questionary.list' %}">
                                                        {% csrf_token %}
                                                        <button type="submit" name="cancel" class="btn btn-primary">Cancel Questionary</button>
                                                    </form>
                                                    {% if questions_to_answer.last %}
                                                        <li class="page-item">
                                                            <form method="POST" action="{% url 'questionary:question.save' %}">
                                                                {% csrf_token %}
                                                                <button type="submit" name="next" class="btn btn-primary">Finish Questionary</button>
                                                            </form>
                                                        </li>
                                                    {% endif %}
                                                </div>
                                            </div>

                                            <!-- Pagination -->
                                            <div class="align-items-center mt-2 row text-center text-sm-start">
                                                <div class="col-sm">
                                                    <div class="text-muted">
                                                        Mostrar
                                                        <span class="fw-semibold"> Question Number: {{ questions_to_answer.number }}</span>
                                                        of
                                                        <span class="fw-semibold">
                                                        {{ questions_to_answer.paginator.num_pages }} questions
                                                        </span>
                                                    </div>
                                                </div>
                                                <div class="col-sm-auto">
                                                    <ul
                                                        class="pagination pagination-separated pagination-sm justify-content-center justify-content-sm-start mb-0"
                                                    >
                                                        
                                                        
                                                    </ul>
                                                
                                            </div>
                                            <!-- end row -->
                                        {% endif %} 
                                    </div>
                                </div>
                            </div>
                        </div>        
                    </div>
                    <!-- container-fluid -->
                </div>
                <!-- End Page-content -->

            {% block footer %}
            {% include "partials/footer.html" %}
            {% endblock footer %}
            </div>
            <!-- end main content-->
{% endblock content %}
{% block extra_js %}
<script>
    function validateForm() {
        var selectedQuestionary = document.getElementById('inputGroupSelect01').value;

        // Validate if a questionary is selected
        if (selectedQuestionary === 'Choose...') {
            alert('Please select a questionary.');
            return false;
        }

        // Add more validations if needed

        return true; // Submit the form if all validations pass
    }
</script>
<script>
    function validateForm2() {
        var questionType = {{ question.type }};
        var answerInput = document.getElementById('question_id');

        if (questionType == 1) {
            // Numeric question validation
            var numericValue = answerInput.value.trim();
            if (!numericValue.match(/^\d+$/)) {
                alert('Please enter a valid numeric answer.');
                return false;
            }
        } else if (questionType == 2) {
            // Multiple-choice question validation (optional)
            var selectedOption = document.getElementById('answer').value;
            if (selectedOption === 'Choose...') {
                alert('Please select an option.');
                return false;
            }
        }

        // Add more validations if needed

        return true; // Submit the form if all validations pass
    }
</script>
{% endblock extra_js %}