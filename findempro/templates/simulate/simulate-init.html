{% extends "partials/base.html" %}
{% load static %}
{% block title %}Simulate Init{% endblock title %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/joint.css' %}"> 
<!-- dropzone css -->
<link rel="stylesheet" href="{% static 'libs/dropzone/dist/dropzone.css'%}" type="text/css" />

<!-- Filepond css -->
<link rel="stylesheet" href="{% static 'libs/filepond/dist/filepond.min.css'%}" type="text/css" />
<link rel="stylesheet" href="{% static 'libs/filepond-plugin-image-preview/dist/filepond-plugin-image-preview.min.css'%}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.9.3/min/dropzone.min.css" integrity="sha512-Xr6mUq4Wt5T7Bw6FQPhZcY6wPo6nqmFTfZyU+7xFCTk3mAFLqvcgdbBj+Pf+v+KqDkIXwXQxCVeLwBl+KZ8k4g==" crossorigin="anonymous" />
{% endblock extra_css %}
    
{% block content %}
            <!-- ============================================================== -->
            <!-- Start right Content here -->
            <!-- ============================================================== -->
            <div class="main-content">

                <div class="page-content">
                    <div class="container-fluid">
                        {% block pagetitle %}
                        {% include "partials/page-title.html" with pagetitle="Simulate" title="Init" %}
                        {% endblock pagetitle %}
                        <div class="card rounded-0 bg-success-subtle mx-n4 mt-n4 border-top">
                            <div class="px-4">
                                <div class="row">
                                    <div class="col-xxl-9 align-self-center">
                                        <div class="py-4">
                                            <h4 class="display-6 -text">SIMULATE</h4>
                                            <div class="container">                      
                                              <p>Explore our comprehensive product list featuring a diverse range of items sourced from our extensive database. This user-friendly platform empowers you to take control of your product inventory effortlessly. Whether you're a business owner, a stock manager, or just someone passionate about organization, this page is designed with you in mind.</p>
                                          
                                              <h2>Key Features:</h2>
                                          
                                              <ul>
                                                <li>
                                                    <span class="text-success">Information of questionary to use for the simulation:</span> 
                                                
                                                </li>
                                          
                                                <li>
                                                    <span class="text-danger">Historic Demand:</span> 
                                                
                                                </li>
                                          
                                                <li>
                                                    <span class="text-primary">Unit of time:</span> 
                                                
                                                </li>
                                              </ul>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-xxl-3 ms-auto">
                                        <div class="mb-n5 pb-1 faq-img d-none d-xxl-block">
                                            <img src="{% static 'images/simulate-img.webp'%}" alt="" class="img-fluid">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <div class="row">
                                    <div class="col-xxl-6">
                                        <div class="card">
                                            <div class="card-header align-items-center d-flex">
                                                <h4 class="card-title mb-0 flex-grow-1">Params Simulation</h4>
                                            </div><!-- end card header -->
        
                                            <div class="card-body">
                                                <p class="text-muted">Realize a Simulation with the next params</p>
                                                <div class="live-preview">
                                                    <form action="{% url 'simulate:simulate.init' %}" method="post" id="simulateForm">
                                                        {% csrf_token %}
                                                        <div class="row">                                                          
                                                            <div class="col-md-4">
                                                                <div class="mb-3">
                                                                    <label for="fk_questionary" class="form-label" title="Select the information to use in the simulation">
                                                                        <span data-key="t-timeunit"> Information of questionary to use for the simulation</span>
                                                                    </label>
                                                                    <select id="fk_questionary" class="form-select" data-choices data-choices-sorting="true">
                                                                        <option selected>Choose...</option>
                                                                        {% for questionary in questionaries %}
                                                                            <option value="{{ questionary.id }}">{{ questionary.name }}</option>
                                                                        {% empty %}
                                                                            <option>...</option>
                                                                        {% endfor %}
                                                                    </select>
                                                                    <div class="text-end">
                                                                        <button onclick="show()" class="btn btn-info">Select</button>
                                                                    </div>
                                                                </div>
                                                            </div><!--end col-->
                                                            <div class="col-md-4">
                                                                <div class="mb-3">
                                                                    <label for="historicdemand" class="form-label" title="Submit the historic demand you want to use in format .xlsx"><span data-key="t-demandhistory">Historic Demand</span></label>
                                                                    <div class="dropzone" id="myDropzone">
                                                                        <div class="fallback">
                                                                            <input name="file" type="file" multiple="multiple" accept=".xlsx, .txt">
                                                                        </div>
                                                                        <div class="dz-message needsclick">
                                                                            <div class="mb-3">
                                                                                <i class="display-2 text-muted ri-upload-cloud-2-fill"></i>
                                                                            </div>
                                                                            <h4>Drop files here or click to upload.</h4>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div><!--end col-->                                                            
                                                            <div class="col-md-4">
                                                                <div class="mb-3">
                                                                    <label for="unit_time" class="form-label" title="Select the unit of time you want to use"><span data-key="t-timeunit"> Unit of time</span></label>
        
                                                                    <select id="unit_time" class="form-select" data-choices data-choices-sorting="true" >
                                                                        <option selected>Choose...</option>
                                                                        <option value="1">year</option>
                                                                        <option value="2">month</option>
                                                                        <option value="2">day</option>
                                                                    </select>
                                                                </div>
                                                            </div><!--end col-->
                                                            <div class="col-md-4">
                                                                <div class="mb-3">
                                                                    <label for="elements" class="form-label" title="Select the options that you want to use in the simulation"> Elements that want to show inn the graphic and table</label>
                                                                    <label>
                                                                        <div class="form-check">
                                                                            <input class="form-check-input" type="checkbox" id="financial_statements">
                                                                            <label class="form-check-label" for="financial_statements">
                                                                                Financial Statements
                                                                            </label>
                                                                        </div>
                                                                        <div class="form-check">
                                                                            <input class="form-check-input" type="checkbox" id="performance_indicators">
                                                                            <label class="form-check-label" for="performance_indicators">
                                                                                Key Performance Indicators
                                                                            </label>
                                                                        </div>
                                                                        <div class="form-check">
                                                                            <input class="form-check-input" type="checkbox" id="tables_analysis">
                                                                            <label class="form-check-label" for="tables_analysis">
                                                                                Scenario Analysis Tables
                                                                            </label>
                                                                        </div>
                                                                        <div class="form-check">
                                                                            <input class="form-check-input" type="checkbox" id="sensitivity_analysis">
                                                                            <label class="form-check-label" for="sensitivity_analysis">
                                                                                Sensitivity Analysis
                                                                            </label>
                                                                        </div>
                                                                        <div class="form-check">
                                                                            <input class="form-check-input" type="checkbox" id="comparative_analysis">
                                                                            <label class="form-check-label" for="comparative_analysis">
                                                                                Comparative Analysis
                                                                            </label>
                                                                        </div>
                                                                    </label>
                                                                </div>
                                                            </div><!--end col-->
                                                            <div class="col-md-4">
                                                                <div class="mb-3">
                                                                    <label for="elements" class="form-label" title="Select the options that you want to use in the simulation"> Areas that you want to simulate</label>
                                                                    <label>
                                                                        <div class="form-check">
                                                                            <input class="form-check-input" type="checkbox" id="financial_statements">
                                                                            <label class="form-check-label" for="financial_statements">
                                                                                Financial Statements
                                                                            </label>
                                                                        </div>
                                                                    </label>
                                                                </div>
                                                            </div><!--end col-->
                                                            <div class="col-md-12">
                                                                <div id="selectedDetails">
                                                                    <!-- Aquí se mostrarán los detalles del elemento seleccionado -->
                                                                </div>
                                                            </div>
        
                                                            <div class="col-lg-12">
                                                                <div class="text-init">
                                                                    <button type="button" class="btn btn-dark" id="clearButton">Clear</button>
                                                                </div>
                                                                <div class="text-end">
                                                                    <button type="submit" class="btn btn-primary">Start Simulation</button>
                                                                </div>
                                                            </div><!--end col-->
                                                        </div><!--end row-->
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                    </div> <!-- end col -->
        
                                    <div class="col-xxl-6">
                                        <div class="card">
                                            <div class="card-header align-items-center d-flex">
                                                <h4 class="card-title mb-0 flex-grow-1">Lineal Graph</h4>
                                            </div><!-- end card header -->
                                            <div class="card-body">
                                                <canvas id="myChart" width="100" height="50"></canvas>                          
                                            </div>
                                        </div>
                                        
                                    </div> <!-- end col -->
                                </div><!--end row-->
                                
                                <div class="row">
                                    <div>
                                        <div id="diagram"></div>
                                    </div>
                                    <div class="col-lg-6">
                                        <h1>Equations</h1>
                                        <div id="diagram"></div>
                                            <ul>
                                                {% for equation in equations %}
                                                    <li>
                                                        <h2>{{ equation.name }}</h2>
                                                        <p>{{ equation.equation }}</p>
                                                        <p>Variables: {{ equation.variables }}</p>
                                                    </li>
                                                {% empty %}
                                                <div class="text-center py-4">
                                                    <lord-icon src="https://cdn.lordicon.com/msoeawqm.json" trigger="loop" colors="primary:#405189,secondary:#0ab39c" style="width:75px;height:75px"></lord-icon>
                                                    <h5 class="mt-2">Sorry there isn't any product register in the database</h5>
                                                    <p class="text-muted mb-0">You have to "Add Product".</p>
                                                </div>
        
                                                {% endfor %}
                                            </ul>
                                    </div>
                                    <div class="col-lg-6">
                                        <div class="card">
                                            <div class="card-header">
                                                <h4 class="card-title mb-0">Simulate Table</h4>
                                            </div><!-- end card header -->
            
                                            <div class="card-body">
                                                <div id="customerList">
                                                    <div class="table-responsive table-card mt-3 mb-1">
                                                        <table class="table align-middle table-nowrap" id="simulateTable">
                                                            <thead class="table-light">
                                                                <tr>
                                                                    <th scope="col" style="width: 50px;">
                                                                        <div class="form-check">
                                                                            <input class="form-check-input" type="checkbox" id="checkAll" value="option">
                                                                        </div>
                                                                    </th>
                                                                    <th class="sort" data-sort="date">Date</th>
                                                                    <th class="sort" data-sort="variable">Variable</th>
                                                                    <th class="sort" data-sort="unit">Unit</th>
                                                                    <th class="sort" data-sort="unit_time">Unit of time</th>
                                                                    <th class="sort" data-sort="result">Result</th>
                                                                    </tr>
                                                            </thead>
                                                            <tbody class="">
                                                                <tr>
                                                                    <td class="date">{{simulate.date}}</td>
                                                                    <td class="variable">{{simulate.variable}}</td>
                                                                    <td class="unit">{{simulate.unit}}</td>
                                                                    <td class="unit_time">{{simulate.unittime}}</td>  
                                                                    <td class="result">{{simulate.result}}</td>                                                            
                                                                </tr>
                                                            </tbody>
                                                        </table>
        
                                                            <div class="noresult" style="display: none">
                                                                <div class="text-center">
                                                                    <lord-icon src="https://cdn.lordicon.com/msoeawqm.json" trigger="loop"
                                                                        colors="primary:#121331,secondary:#08a88a" style="width:75px;height:75px">
                                                                    </lord-icon>
                                                                    <h5 class="mt-2">Sorry! No Result Found</h5>
                                                                    <p class="text-muted mb-0"></p>
                                                                </div>
                                                            </div>
                                                    </div>
                                                    
                                                    <div class="d-flex justify-content-end">
                                                        <div class="pagination-wrap hstack gap-2">
                                                            <a class="page-item pagination-prev disabled" href="javascript:void(0);">
                                                                Previous
                                                            </a>
                                                            <ul class="pagination listjs-pagination mb-0"></ul>
                                                            <a class="page-item pagination-next" href="javascript:void(0);">
                                                                Next
                                                            </a>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div><!-- end card -->
                                        </div>
                                        <!-- end col -->
                                    </div>
                                    <!-- end col -->
                                </div>
                                <!-- end row -->
                            <div>
                            <div class="col-auto layout-rightside-col ">
                                <div class="overlay"></div>
                                    <div class="layout-rightside">
                                      <div class="card h-100 rounded-0">
                                        <div class="card-body p-0">
                                          <div class="p-3">
                                            <h6 class="text-muted mb-0 text-uppercase fw-semibold">
                                              Instructions
                                            </h6>
                                          </div>
                                          <div data-simplebar style="max-height: 410px" class="p-3 pt-0">
                                            <div class="acitivity-timeline acitivity-main">
                                              {% for instruction in instructions %}
                                              <div class="acitivity-item d-flex">
                                                <div class="flex-shrink-0 avatar-xs acitivity-avatar">
                                                  <div
                                                    class="avatar-title bg-primary-subtle text-primary rounded-circle"
                                                  >
                                                    <i class="ri-info-line"></i>
                                                  </div>
                                                </div>
                                                <div class="flex-grow-1 ms-3">
                                                  <h6 class="mb-1 lh-base">{{ instruction.title }}</h6>
                                                  <p class="text-muted mb-1">
                                                    {{ instruction.description }}
                                                  </p>
                                                  <small class="mb-0 text-muted">
                                                    {{ instruction.date }}
                                                  </small>
                                                </div>
                                              </div>
                                              {% empty %}
                                              <div class="text-center py-4">
                                                <lord-icon
                                                  src="https://cdn.lordicon.com/msoeawqm.json"
                                                  trigger="loop"
                                                  colors="primary:#405189,secondary:#0ab39c"
                                                  style="width: 75px; height: 75px"
                                                ></lord-icon>
                                                <h5 class="mt-2">
                                                  Sorry, there are no instructions in the database
                                                </h5>
                                                <p class="text-muted mb-0">
                                                  Please add instructions to the system.
                                                </p>
                                              </div>
                                              {% endfor %}
                                            </div>
                                          </div>
                                        </div>
                                      </div>
                                      <!-- end card-->
                                    </div>
                                    <!-- end .rightbar-->
                                  </div>
                                  <!-- end col activity -->
                                </div>
                            </div>

                        </div> <!-- container-fluid -->
                </div>
                <!-- End Page-content -->

            {% block footer %}
            {% include "partials/footer.html" %}
            {% endblock footer %}
            </div>
            <!-- end main content-->
{% endblock content %}
{% block extra_js %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>       
    <script src="{% static 'js/pages/joint.js' %}"></script>
    <!-- dropzone min -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.9.3/min/dropzone.min.js" integrity="sha512-vjeXE7PyNKQmUtsaO+t4fT80y8AGCPiHdM2AUxP2dG9KqDYZSfGAF4RqXUsXgD9PwtGZe5Jr9Ok6mbT7FpQlgg==" crossorigin="anonymous"></script>
    <script src="{% static 'libs/dropzone/dist/dropzone-min.js'%}"></script>
    <script>
        // Dropzone initialization
        Dropzone.options.myDropzone = {
            paramName: "file", // The name that will be used to transfer the file
            maxFilesize: 5, // MB
            previewsContainer: ".dropzone",
            clickable: true,
            acceptedFiles: ".xlsx, .txt"
        };
        $(document).ready(function() {
    
          var graph = new joint.dia.Graph;
          
          var paper = new joint.dia.Paper({
            el: $('#diagram'),
            model: graph,
            width: 600,
            height: 200
          });
          
          var rect = new joint.shapes.basic.Rect({
            position: {x: 100, y: 30},
            size: {width: 100, height: 30}
          });
          
          graph.addCell(rect);
          
        });
        

        $.ajax({
            type: "GET",
            url: "{% url 'simulate:simulate.init' %}", // Replace with the actual URL of your Django view
            // ...
        });

        // Obtén una referencia al elemento canvas
        var ctx = document.getElementById('myChart').getContext('2d');

        // Define los datos para el gráfico
        var data = {
            labels: [],
            datasets: [{
                label: 'En Espera',
                data: [],
                backgroundColor: 'rgba(255, 255, 255, 0)',  // Transparent background
                borderColor: 'rgba(255, 255, 255, 0)',      // Transparent border
                borderWidth: 1
            }]
        };

        // Configura las opciones del gráfico
        var options = {
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        };

        // Crea el gráfico lineal
        var myChart = new Chart(ctx, {
            type: 'line',
            data: data,
            options: options
        });

        // Function to update the chart with data
        function updateChart(data) {
            var ctx = document.getElementById('myChart').getContext('2d');
            var myChart = new Chart(ctx, {
                type: 'line',
                data: data,
                options: {
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
    
        // Function to update the table with data
        function updateTable(data) {
            var tableBody = document.querySelector("#simulateTable tbody");
            tableBody.innerHTML = ""; // Clear the existing table rows
            for (var i = 0; i < data.length; i++) {
                var row = data[i];
                var newRow = tableBody.insertRow();
                newRow.innerHTML = "<td>" + row.date + "</td><td>" + row.variable + "</td><td>" + row.unit + "</td><td>" + row.unit_time + "</td><td>" + row.result + "</td>";
            }
        }
    
        // Add a click event listener to the "Init" button
        document.getElementById("initButton").addEventListener("click", function () {
            // Make an AJAX request to your Django view to fetch data
            $.ajax({
                type: "GET",
                url: "{% url 'simulate:simulate.init' %}", // Replace with the actual URL of your Django view
                success: function (data) {
                    // Update the chart and table with the retrieved data
                    updateChart(data.chartData);
                    updateTable(data.tableData);
                },
                error: function () {
                    alert("Error fetching data from the server.");
                }
            });
        });
        document.getElementById('clearButton').addEventListener('click', function() {
            document.getElementById('simulateForm').reset();
        });
        // Agregar un evento de cambio al elemento select
        document.getElementById("ForminputState").addEventListener("change", function () {
            // Obtener el elemento seleccionado
            var selectedOption = this.options[this.selectedIndex];
    
            // Obtener los detalles del elemento seleccionado
            var details = selectedOption.getAttribute("data-details");
    
            // Mostrar los detalles en un área específica
            var selectedDetails = document.getElementById("selectedDetails");
            selectedDetails.innerHTML = details;
        });
    </script>
{% endblock extra_js %}