{% extends "partials/base.html" %}
{% load static %}
{% block title %}Simulate Init{% endblock title %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/joint.css' %}"> 
<!-- dropzone css -->
<link rel="stylesheet" href="{% static 'libs/dropzone/dist/dropzone.css'%}" type="text/css" />

<!-- Filepond css -->
<link rel="stylesheet" href="{% static 'libs/filepond/dist/filepond.min.css'%}" type="text/css" />
<link rel="stylesheet" href="{% static 'libs/filepond-plugin-image-preview/dist/filepond-plugin-image-preview.min.css'%}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.9.3/min/dropzone.min.css" integrity="sha512-Xr6mUq4Wt5T7Bw6FQPhZcY6wPo6nqmFTfZyU+7xFCTk3mAFLqvcgdbBj+Pf+v+KqDkIXwXQxCVeLwBl+KZ8k4g==" crossorigin="anonymous" />
{% endblock extra_css %}
    
{% block content %}
            <!-- ============================================================== -->
            <!-- Start right Content here -->
            <!-- ============================================================== -->
            <div class="main-content">

                <div class="page-content">
                    <div class="container-fluid">
                        {% block pagetitle %}
                        {% include "partials/page-title.html" with pagetitle="Simulate" title="Init" %}
                        {% endblock pagetitle %}
                        <div class="card rounded-0 bg-success-subtle mx-n4 mt-n4 border-top">
                            <div class="px-4">
                                <div class="row">
                                    <div class="col-xxl-9 align-self-center">
                                        <div class="py-4">
                                            <h4 class="display-6 -text">SIMULAR</h4>
                                            <div class="container">                      
                                              <p>Explore nuestra lista completa de productos que presenta una amplia gama de artículos obtenidos de nuestra extensa base de datos. Esta plataforma fácil de usar le permite tomar el control de su inventario de productos sin esfuerzo. Si usted es propietario de un negocio, administrador de existencias o simplemente alguien apasionado por la organización, esta página está diseñada pensando en usted.</p>
                                          
                                              <h2>Características clave:</h2>
                                          
                                              <ul>
                                                <li>
                                                    <span class="text-success">Información del cuestionario a utilizar para la simulación:</span> 
                                                
                                                </li>
                                          
                                                <li>
                                                    <span class="text-danger">Historic Demand:</span> 
                                                
                                                </li>
                                          
                                                <li>
                                                    <span class="text-primary">Unit of time:</span> 
                                                
                                                </li>
                                              </ul>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-xxl-3 ms-auto">
                                        <div class="mb-n5 pb-1 faq-img d-none d-xxl-block">
                                            <img src="{% static 'images/simulate-img.webp'%}" alt="" class="img-fluid">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <div class="row">
                                    <div class="col-xxl-6">
                                        <div class="card">
                                            <div class="card-header align-items-center d-flex">
                                                <h4 class="card-title mb-0 flex-grow-1">Params Simulation</h4>
                                            </div><!-- end card header -->
        
                                            <div class="card-body">
                                                <p class="text-muted">Realize a Simulation with the next params</p>
                                                <div class="live-preview">
                                                    <form action="{% url 'simulate:simulate.init' %}" method="post" id="simulateForm" onsubmit="return validateForm()">
                                                        {% csrf_token %}
                                                        <div class="row">                                                          
                                                            <div class="col-md-4">
                                                                <div class="mb-3">
                                                                    <form action="{% url 'simulate:simulate.init' %}" method="GET" id="questionaryResultForm" onsubmit="return validateForm()">
                                                                        <label for="selected_questionary_result" class="form-label" title="Select the information to use in the simulation">
                                                                            <span data-key="t-timeunit"> Information of questionary to use for the simulation</span>
                                                                        </label>
                                                                        <select id="selected_questionary_result" class="form-select" data-choices data-choices-sorting="true">
                                                                            <option selected>Choose...</option>
                                                                            {% for questionary in questionaries %}
                                                                                <option value="{{ questionary.id }}">{{ questionary.name }}</option>
                                                                            {% empty %}
                                                                                <option>...</option>
                                                                            {% endfor %}
                                                                        </select>
                                                                        <div class="text-end">
                                                                            <button type="submit" name="select" class="btn btn-info">Select</button>
                                                                        </div>
                                                                    </form>
                                                                </div>
                                                            </div><!--end col-->
                                                            <div class="col-md-4">
                                                                <div class="mb-3">
                                                                    <label for="historicdemand" class="form-label" title="Submit the historic demand you want to use in format .xlsx"><span data-key="t-demandhistory">Historic Demand</span></label>
                                                                    <div class="dropzone" id="myDropzone">
                                                                        <div class="fallback">
                                                                            <input name="demandhistory" type="file" multiple="multiple" accept=".xlsx, .txt">
                                                                        </div>
                                                                        <div class="dz-message needsclick">
                                                                            <div class="mb-3">
                                                                                <i class="display-2 text-muted ri-upload-cloud-2-fill"></i>
                                                                            </div>
                                                                            <h4>Drop files here or click to upload.</h4>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div><!--end col-->                                                            
                                                            <div class="col-md-4">
                                                                <div class="mb-3">
                                                                    <label for="unit_time" class="form-label" title="Select the unit of time you want to use"><span data-key="t-timeunit"> Unit of time</span></label>
        
                                                                    <select id="unit_time" class="form-select" data-choices data-choices-sorting="true" >
                                                                        <option selected>Choose...</option>
                                                                        <option value="1">year</option>
                                                                        <option value="2">month</option>
                                                                        <option value="2">day</option>
                                                                    </select>
                                                                </div>
                                                            </div><!--end col-->        
                                                            <div class="col-lg-12">
                                                                <div class="text-init">
                                                                    <button type="button" class="btn btn-dark" id="clearButton">Clear</button>
                                                                </div>
                                                                <div class="text-end">
                                                                    <button type="submit" class="btn btn-primary">Start Simulation</button>
                                                                </div>
                                                            </div><!--end col-->
                                                        </div><!--end row-->
                                                    </form>

                                                    {% if simulation_started %}
                                                        <!-- Display simulation results or next step content here -->
                                                        <p>Simulation started!</p>
                                                        <p>Current Step: {{ simulation_instance.current_step }}</p>
                                                        <!-- Display simulation data for the current step -->
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </div> <!-- end col -->
        
                                    <div class="col-xxl-6">
                                        <div class="card">
                                            <div class="card-header align-items-center d-flex">
                                                <h4 class="card-title mb-0 flex-grow-1">Lineal Graph</h4>
                                            </div><!-- end card header -->
                                            <div class="card-body">
                                                <canvas id="myChart" width="100" height="50"></canvas>                          
                                            </div>
                                        </div>
                                        
                                    </div> <!-- end col -->
                                </div><!--end row-->
                                
                                <div class="row">
                                    <div class="col-lg-6">
                                        <div class="card">
                                            <div class="card-header">
                                                <h4 class="card-title">Preview Information</h4>
                                            </div>
                                            <div class="card-body">
                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <h5>Equations</h5>
                                                        <ul>
                                                            {% for equation in equations_to_use %}
                                                                <li>
                                                                    <h6>{{ equation.name }}</h6>
                                                                    <p>{{ equation.equation }}</p>
                                                                    <p>Variables: {{ equation.variables }}</p>
                                                                </li>
                                                            {% empty %}
                                                                <p>No equations available.</p>
                                                            {% endfor %}
                                                        </ul>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <h5>Simulation Details</h5>
                                                        {% if simulation_started %}
                                                            <p>Simulation started!</p>
                                                            <p>Current Step: {{ simulation_instance.current_step }}</p>
                                                            <!-- Display simulation data for the current step -->
                                                        {% else %}
                                                            <p>No simulation started.</p>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>                                    
                                    <div class="col-lg-6">
                                        <div class="card">
                                            <div class="card-header">
                                                <h4 class="card-title mb-0">Simulate Table</h4>
                                            </div><!-- end card header -->

                                            <div class="card-body">
                                                <div id="customerList">
                                                    <div class="table-responsive table-card mt-3 mb-1">
                                                        <table class="table align-middle table-nowrap" id="simulateTable">
                                                            <thead class="table-light">
                                                                <tr>
                                                                    <th class="sort" data-sort="date">Date</th>
                                                                    <th class="sort" data-sort="variable">Variable</th>
                                                                    <th class="sort" data-sort="unit">Unit</th>
                                                                    <th class="sort" data-sort="unit_time">Unit of time</th>
                                                                    <th class="sort" data-sort="result">Result</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody class="">
                                                                {% if simulation_started %}
                                                                    <tr>
                                                                        <td class="date">{{ simulate.date }}</td>
                                                                        <td class="variable">{{ simulate.variable }}</td>
                                                                        <td class="unit">{{ simulate.unit }}</td>
                                                                        <td class="unit_time">{{ simulate.unittime }}</td>
                                                                        <td class="result">{{ simulate.result }}</td>
                                                                    </tr>
                                                                {% else %}
                                                                    <tr>
                                                                        <td colspan="6"> <!-- Adjust the colspan value as needed -->
                                                                            <div class="noresult" style="display: none">
                                                                                <div class="text-center">
                                                                                    <lord-icon src="https://cdn.lordicon.com/msoeawqm.json" trigger="loop"
                                                                                        colors="primary:#121331,secondary:#08a88a" style="width:75px;height:75px">
                                                                                    </lord-icon>
                                                                                    <h5 class="mt-2">Sorry! No Result Found</h5>
                                                                                    <p class="text-muted mb-0"></p>
                                                                                </div>
                                                                            </div>
                                                                        </td>
                                                                    </tr>
                                                                {% endif %}
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                    <div class="d-flex justify-content-end">
                                                        <div class="pagination-wrap hstack gap-2">
                                                            <a class="page-item pagination-prev disabled" href="javascript:void(0);">
                                                                Anterior
                                                            </a>
                                                            <ul class="pagination listjs-pagination mb-0"></ul>
                                                            <a class="page-item pagination-next" href="javascript:void(0);">
                                                                Next
                                                            </a>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div><!-- end card -->
                                        </div><!-- end col -->
                                    </div><!-- end col -->
                                </div>
                                <!-- end row -->
                                <div class="card">
                                    <div class="card-header">
                                        Simulation Diagram
                                    </div>
                                    <div class="card-body">
                                        <!-- Add your diagram visualization code here -->
                                        <!-- For example, you can use a canvas element to draw the diagram -->
                                        <canvas id="simulationDiagram"></canvas>
                                    </div>
                                </div>
                            <div>
                        </div> <!-- container-fluid -->
                </div>
                <!-- End Page-content -->
            {% block footer %}
            {% include "partials/footer.html" %}
            {% endblock footer %}
            </div>
            <!-- end main content-->
{% endblock content %}
{% block extra_js %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>       
    <script src="{% static 'js/pages/joint.js' %}"></script>
    <!-- dropzone min -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.9.3/min/dropzone.min.js" integrity="sha512-vjeXE7PyNKQmUtsaO+t4fT80y8AGCPiHdM2AUxP2dG9KqDYZSfGAF4RqXUsXgD9PwtGZe5Jr9Ok6mbT7FpQlgg==" crossorigin="anonymous"></script>
    <script src="{% static 'libs/dropzone/dist/dropzone-min.js'%}"></script>

    <script>
        function validateForm() {
            // Validate the selected questionary
            var questionarySelect = document.getElementById('fk_questionary');
            if (questionarySelect.value == 'Choose...') {
                alert('Please select a questionary.');
                return false;
            }
    
            // Validate the uploaded historic demand file
            var historicDemandInput = document.querySelector('input[name="demandhistory"]');
            if (historicDemandInput.files.length === 0) {
                alert('Please upload a historic demand file.');
                return false;
            }
    
            // Validate the selected unit of time
            var unitTimeSelect = document.getElementById('unit_time');
            if (unitTimeSelect.value == 'Choose...') {
                alert('Please select a unit of time.');
                return false;
            }
    
            // Add more validations for other fields if needed
    
            return true; // Submit the form if all validations pass
        }
    </script>

    <script>
        // Dropzone initialization
        Dropzone.options.myDropzone = {
            paramName: "file", // The name that will be used to transfer the file
            maxFilesize: 5, // MB
            previewsContainer: ".dropzone",
            clickable: true,
            acceptedFiles: ".xlsx, .txt"
        };
        $(document).ready(function() {
    
          var graph = new joint.dia.Graph;
          
          var paper = new joint.dia.Paper({
            el: $('#diagram'),
            model: graph,
            width: 600,
            height: 200
          });
          
          var rect = new joint.shapes.basic.Rect({
            position: {x: 100, y: 30},
            size: {width: 100, height: 30}
          });
          
          graph.addCell(rect);
          
        });
        

        $.ajax({
            type: "GET",
            url: "{% url 'simulate:simulate.init' %}", // Replace with the actual URL of your Django view
            // ...
        });

        // Obtén una referencia al elemento canvas
        var ctx = document.getElementById('myChart').getContext('2d');

        // Define los datos para el gráfico
        var data = {
            labels: [],
            datasets: [{
                label: 'En Espera',
                data: [],
                backgroundColor: 'rgba(255, 255, 255, 0)',  // Transparent background
                borderColor: 'rgba(255, 255, 255, 0)',      // Transparent border
                borderWidth: 1
            }]
        };

        // Configura las opciones del gráfico
        var options = {
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        };

        // Crea el gráfico lineal
        var myChart = new Chart(ctx, {
            type: 'line',
            data: data,
            options: options
        });

        // Function to update the chart with data
        function updateChart(data) {
            var ctx = document.getElementById('myChart').getContext('2d');
            var myChart = new Chart(ctx, {
                type: 'line',
                data: data,
                options: {
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
    
        // Function to update the table with data
        function updateTable(data) {
            var tableBody = document.querySelector("#simulateTable tbody");
            tableBody.innerHTML = ""; // Clear the existing table rows
            for (var i = 0; i < data.length; i++) {
                var row = data[i];
                var newRow = tableBody.insertRow();
                newRow.innerHTML = "<td>" + row.date + "</td><td>" + row.variable + "</td><td>" + row.unit + "</td><td>" + row.unit_time + "</td><td>" + row.result + "</td>";
            }
        }
    
        // Add a click event listener to the "Init" button
        document.getElementById("initButton").addEventListener("click", function () {
            // Make an AJAX request to your Django view to fetch data
            $.ajax({
                type: "GET",
                url: "{% url 'simulate:simulate.init' %}", // Replace with the actual URL of your Django view
                success: function (data) {
                    // Update the chart and table with the retrieved data
                    updateChart(data.chartData);
                    updateTable(data.tableData);
                },
                error: function () {
                    alert("Error fetching data from the server.");
                }
            });
        });
        document.getElementById('clearButton').addEventListener('click', function() {
            document.getElementById('simulateForm').reset();
        });
        // Agregar un evento de cambio al elemento select
        document.getElementById("ForminputState").addEventListener("change", function () {
            // Obtener el elemento seleccionado
            var selectedOption = this.options[this.selectedIndex];
    
            // Obtener los detalles del elemento seleccionado
            var details = selectedOption.getAttribute("data-details");
    
            // Mostrar los detalles en un área específica
            var selectedDetails = document.getElementById("selectedDetails");
            selectedDetails.innerHTML = details;
        });
    </script>
{% endblock extra_js %}