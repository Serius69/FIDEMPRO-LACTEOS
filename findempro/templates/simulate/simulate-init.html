{% extends "partials/base.html" %}
{% load static %}
{% block title %}Simulate Init{% endblock title %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/joint.css' %}"> 
<!-- dropzone css -->
<link rel="stylesheet" href="{% static 'libs/dropzone/dist/dropzone.css'%}" type="text/css" />

<!-- Filepond css -->
<link rel="stylesheet" href="{% static 'libs/filepond/dist/filepond.min.css'%}" type="text/css" />
<link rel="stylesheet" href="{% static 'libs/filepond-plugin-image-preview/dist/filepond-plugin-image-preview.min.css'%}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.9.3/min/dropzone.min.css" integrity="sha512-Xr6mUq4Wt5T7Bw6FQPhZcY6wPo6nqmFTfZyU+7xFCTk3mAFLqvcgdbBj+Pf+v+KqDkIXwXQxCVeLwBl+KZ8k4g==" crossorigin="anonymous" />
{% endblock extra_css %}
    
{% block content %}
            <!-- ============================================================== -->
            <!-- Start right Content here -->
            <!-- ============================================================== -->
            <div class="main-content">

                <div class="page-content">
                    <div class="container-fluid">
                        {% block pagetitle %}
                        {% include "partials/page-title.html" with pagetitle="Simulate" title="Init" %}
                        {% endblock pagetitle %}
                        <div class="card rounded-0 bg-success-subtle mx-n4 mt-n4 border-top">
                            <div class="px-4">
                                <div class="row">
                                    <div class="col-xxl-9 align-self-center">
                                        <div class="py-4">
                                            <h4 class="display-6 -text">SIMULAR</h4>
                                            <div class="container">                      
                                              <p>Ahora puedes generar simulaciones basadas en las respuestas de tus cuestionarios previos.</p>
                                              <h2>Características clave:</h2>
                                              <ul>
                                                <li>
                                                    <span class="text-success">Información del cuestionario a utilizar para la simulación:</span> <p>Seleccione el cuestionario que desea utilizar para la simulación.</p>
                                                </li>
                                                <li>
                                                    <span class="text-primary">Unidad de tiempo:</span> <p>Seleccione la unidad de tiempo que desea utilizar para la simulación.</p>
                                                </li>
                                              </ul>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-xxl-3 ms-auto">
                                        <div class="mb-n5 pb-1 faq-img d-none d-xxl-block">
                                            <img src="{% static 'images/simulate-img.webp'%}" alt="" class="img-fluid">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <div class="row">
                                    <div class="col-xxl-12">
                                        <div class="card">
                                            <div class="card-header align-items-center d-flex">
                                                <h4 class="card-title mb-0 flex-grow-1">Parametros para la simulacion</h4>
                                            </div><!-- end card header -->                                        
                                            <div class="card-body">
                                                <p class="text-muted">Realizar una simulación con los siguientes parámetros</p>
                                                <div class="live-preview">
                                                        <div class="row">
                                                            <div class="col-md-6">
                                                                {% if not started %}
                                                                        <form method="GET" action="{% url 'simulate:simulate.show' %}" onsubmit=validateForm3()>
                                                                            {% csrf_token %}
                                                                            <div class="mb-4">
                                                                                <label for="selected_questionary_result" class="form-label" title="Select the information to use in the simulation">
                                                                                    <span data-key="t-timeunit"> Información del cuestionario para usar para la simulación</span>
                                                                                </label>
                                                                                <select id="selected_questionary_result" name="selected_questionary_result" class="form-select" data-choices data-choices-sorting="true">
                                                                                    <option selected>Elegir...</option>
                                                                                    {% for questionary_result in questionnaires_result %}
                                                                                    <option for="selected_questionary_result_id" value="{{ questionary_result.id }}" 
                                                                                    {% if questionary_result.id == selected_questionary_result_id %} selected {% endif %}>
                                                                                        {{ questionary_result.id }} {{questionary_result.date_created}}
                                                                                    </option>
                                                                                    {% empty %}
                                                                                        <option>...</option>
                                                                                    {% endfor %}    
                                                                                </select>
                                                                                {% if not started %}
                                                                                    <button type="submit" name="select" class="btn btn-primary">Seleccionar</button>
                                                                                {% else %}                                          
                                                                                {% endif %}
                                                                            </div>
                                                                        </form>
                                                                {% endif %}
                                                            </div><!--end col-->
                                                            <div class="col-md-6">
                                                                {% if questionary_result_instance %}
                                                                    <div class="card">
                                                                        <div class="card-body">
                                                                            <h5 class="card-title">Informacion de los resultados del cuestionario seleccionado</h5>
                                                                            <p>ID: {{ questionary_result_instance.id }}</p>
                                                                            <p>Fecha de creacion: {{ questionary_result_instance.date_created|date:"F j, Y, P" }}</p>
                                                                            <p>Producto que cubre: {{ questionary_result_instance.fk_questionary.fk_product.name }}</p>
                                                                            <a href="{% url 'questionary:questionary.result' questionary_result_instance.id %}" class="btn btn-primary">Ver Resultados</a>
                                                                        </div>
                                                                    </div>
                                                                {% else %}
                                                                    <p>No hay resultado de cuestionario seleccionado.</p>
                                                                {% endif %}
                                                            </div>
                                                            <form action="{% url 'simulate:simulate.show' %}" method="post" id="simulateForm" onsubmit="return validateForm()">
                                                                {% csrf_token %}
                                                                {% comment %} informacion de ceustionario para hacer la simualcion {% endcomment %}
                                                                <input type="hidden" name="questionary_result_id" value="{{ selected_questionary_result_id }}">
                                                                <div class="row">
                                                                    <div class="col-md-6">
                                                                        {% comment %} Cantidad de Unidad de tiempo que se usara para realizar la simulacion {% endcomment %}
                                                                        <label for="time" class="form-label" title="Ingresa la cantidad de ">
                                                                            <span data-key="t-answer">Cantidad</span></label>
                                                                        {% comment %} esto debe cambiar segun se escoja una opcion de unidad de tiempo tanto su validacion
                                                                        como lo que se muestra {% endcomment %}
                                                                        <input type="number" value="{{ question.fk_answer.answer }}"
                                                                            class="form-control" name="time"
                                                                            id="time"
                                                                            placeholder="Ingresa la cantidad de:"
                                                                            required min="0" max="90">
                                                                    </div><!--end col-->                                                            
                                                                    <div class="col-md-6">
                                                                        {% comment %} que unidad de tiempo se usara para la simulacion {% endcomment %}
                                                                        <div class="mb-3">
                                                                            <label for="unit_time" class="form-label" title="Select the unit of time you want to use">
                                                                                <span data-key="t-timeunit"> Unidad de tiempo</span></label>
                                                                            <select id="unit_time" class="form-select" data-choices data-choices-sorting="true" >
                                                                                <option value="1">día</option>
                                                                                <option value="2">mes</option>
                                                                                <option value="3">año</option>    
                                                                            </select>
                                                                        </div>
                                                                    </div><!--end col-->
                                                                </div><!--end row-->
                                                                <div class="col-lg-12">
                                                                    <div class="d-flex justify-content-between">
                                                                        <button type="submit" name="start" class="btn btn-primary">Iniciar simulación</button>
                                                                    </div><!--end col-->
                                                                </div><!--end row-->
                                                            </form>
                                                                {% if started %}
                                                                    {% if request.session.simulation_id %}
                                                                        <a href="{% url 'questionary:questionary.result' request.session.simulattion_id %}" class="btn btn-primary">Mostrar Resultados</a>
                                                                    {% else %}
                                                                        <!-- Handle the case where questionary_result_id is empty -->
                                                                        <p>No hay ID de simulación disponible.</p>
                                                                    {% endif %}    
                                                                    <form method="POST" action="{% url 'simulate:simulate.show' %}">
                                                                        {% csrf_token %}
                                                                        <div class="mb-3">
                                                                            <button type="submit" name="cancel" class="btn btn-danger">Cancelar simulacion</button>
                                                                        </div>
                                                                    </form>
                                                                {% endif %}
                                                        </div><!--end row-->
                                                </div><!--end live-preview-->
                                            </div> <!-- end col -->
                                        </div>
                                    </div><!--end col-->
                                    {% comment %} </div> {% endcomment %}
                                    
                                </div><!--end row-->
                            <div>

                                <div class="col-lg-12">
                                    <div class="card">
                                        <div class="card-header">
                                            <h4 class="card-title">Areas que se simularan</h4>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-12">
                                                    <div class="row">
                                                        {% for area in areas %}
                                                            <div class="col-md-3">
                                                                <div class="card">
                                                                    <img src="{{ area.get_photo_url }}" class="card-img-top img-fluid" style="height: 100px; object-fit: cover;" alt="{{ area.name }}">
                                                                    <div class="card-body">
                                                                        <h5 class="card-subtitle mb-2 text-muted">{{ area.name }}</h5>
                                                                        <h6 class="card-subtitle mb-2 text-muted">{{ area.fk_product.name }}</h6>
                                                                        <p class="card-text">{{ area.description }}</p>
                                                                        <h5>Ecuaciones:</h5>
                                                                        {% for equation in area.area_equation.all %}
                                                                            <article>
                                                                                <p>{{ equation.id }}: {{ equation.name }}</p>
                                                                                <p>{{ equation.expression }}</p>
                                                                                {% if equation.fk_variable1 %}
                                                                                    <p>Variable 1: {{ equation.fk_variable1.name }}</p>
                                                                                {% endif %}
                                                                                {% if equation.fk_variable2 %}
                                                                                    <p>Variable 2: {{ equation.fk_variable2.name }}</p>
                                                                                {% endif %}
                                                                                {% if equation.fk_variable3 %}
                                                                                    <p>Variable 3: {{ equation.fk_variable3.name }}</p>
                                                                                {% endif %}
                                                                                {% if equation.fk_variable4 %}
                                                                                    <p>Variable 4: {{ equation.fk_variable4.name }}</p>
                                                                                {% endif %}
                                                                                {% if equation.fk_variable5 %}
                                                                                    <p>Variable 5: {{ equation.fk_variable5.name }}</p>
                                                                                {% endif %}
                                                                            </article>
                                                                        {% empty %}
                                                                            <p>No se encontraron ecuaciones para esta área.</p>
                                                                        {% endfor %}
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        {% empty %}
                                                            <p>No hay areas disponibles.</p>
                                                        {% endfor %}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div> 
                                <div class="col-lg-12">
                                    <div class="card">
                                        <div class="card-header">
                                            <h4 class="card-title">Información previa</h4>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <h5>Ecuaciones con sus respectivos datos</h5>
                                                    <ul>
                                                        {% for equation in equations_with_values %}
                                                            <li>
                                                                <h6>{{ equation.name }}</h6>
                                                            </li>
                                                        {% empty %}
                                                            <p>No hay ecuaciones con valores.</p>
                                                        {% endfor %}
                                                    </ul>
                                                </div>
                                                <div class="col-md-6">
                                                    <h5>Detalles de simulación</h5>
                                                    {% if started %}
                                                        <p>¡Comenzó la simulación!</p>
                                                        <p>Paso actual: {{ simulation_instance.current_step }}</p>
                                                        <!-- Display simulation data for the current step -->
                                                    {% else %}
                                                        <p>No se inició una simulación.</p>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div> 

                                
                        </div> <!-- container-fluid -->
                </div>
                </div>
                <!-- End Page-content -->
                {% block footer %}
                {% include "partials/footer.html" %}
                {% endblock footer %}
            </div>
            <!-- end main content-->
{% endblock content %}
{% block extra_js %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>       
    <script src="{% static 'js/pages/joint.js' %}"></script>
    <!-- dropzone min -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.9.3/min/dropzone.min.js" integrity="sha512-vjeXE7PyNKQmUtsaO+t4fT80y8AGCPiHdM2AUxP2dG9KqDYZSfGAF4RqXUsXgD9PwtGZe5Jr9Ok6mbT7FpQlgg==" crossorigin="anonymous"></script>
    <script src="{% static 'libs/dropzone/dist/dropzone-min.js'%}"></script>

    <script>
        function validateForm3() {
            var selectedQuestionary = document.getElementById('inputGroupSelect01').value;
            // Validate if a questionary is selected
            if (selectedQuestionary === 'Choose...') {
                alert('Please select a questionary.');
                return false;
            }
            // Add more validations if needed
            return true; // Submit the form if all validations pass
        }
    </script>
    <script>
        function validateForm() {
            var unitTime = document.getElementById("unit_time").value;

            // Verifica si se ha seleccionado una unidad de tiempo
            if (unitTime === "Elegir...") {
                alert("Por favor, selecciona una unidad de tiempo.");
                return false; // Evita que el formulario se envíe
            }

            // Puedes agregar más validaciones según tus necesidades

            return true; // Permite que el formulario se envíe
        }
    </script>
    <script>
        Dropzone.options.myDropzone = {
            paramName: "file", // The name that will be used to transfer the file
            maxFilesize: 5, // MB
            previewsContainer: ".dropzone",
            clickable: true,
            acceptedFiles: ".txt",
            maxFiles: 1, // Only one file
            show: function() {
                this.on("addedfile", function(file) {
                    if (this.files.length > 1) {
                        this.removeFile(this.files[0]);
                    }
                });
                this.on("success", function(file, responseText) {
                    // Check if the file has at least 30 data points
                    var dataPoints = responseText.split('\n');
                    if (dataPoints.length < 30) {
                        alert("The file must contain at least 30 data points.");
                        this.removeFile(file);
                    }
                });
            }
        };
    </script>


{% endblock extra_js %}