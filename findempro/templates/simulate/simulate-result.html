{% extends "partials/base.html" %}
{% load static %}
{% block title %}Resultados de Simulación{% endblock title %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/joint.css' %}"> 
<link rel="stylesheet" href="{% static 'libs/dropzone/dist/dropzone.css'%}" type="text/css" />
<link rel="stylesheet" href="{% static 'libs/filepond/dist/filepond.min.css'%}" type="text/css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.9.3/min/dropzone.min.css" />
<link rel="stylesheet" href="{% static 'css/simulate-result.css' %}">
{% endblock extra_css %}
<style>
.analysis-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 2rem;
    border-radius: 10px;
    margin-bottom: 2rem;
}

.analysis-title {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
}

.analysis-subtitle {
    font-size: 1.1rem;
    opacity: 0.9;
    margin-bottom: 1rem;
}

.analysis-badges .badge {
    font-size: 0.9rem;
    padding: 0.5rem 1rem;
    margin-right: 0.5rem;
}

.performance-metric {
    display: flex;
    align-items: center;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 8px;
    border-left: 4px solid #007bff;
}

.metric-icon {
    font-size: 2rem;
    color: #007bff;
    margin-right: 1rem;
}

.metric-content h6 {
    margin-bottom: 0.25rem;
    color: #6c757d;
}

.metric-content h4 {
    margin-bottom: 0.25rem;
    font-weight: 700;
}

.stats-section {
    padding: 1rem;
    border-radius: 8px;
    margin-bottom: 1rem;
}

.stats-section.historical {
    background: rgba(0, 123, 255, 0.1);
}

.stats-section.simulated {
    background: rgba(40, 167, 69, 0.1);
}

.stats-grid .stat-row {
    display: flex;
    justify-content: space-between;
    padding: 0.25rem 0;
    border-bottom: 1px solid rgba(0,0,0,0.1);
}

.stat-row:last-child {
    border-bottom: none;
}

.comparison-metric {
    text-align: center;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 8px;
    margin-bottom: 1rem;
}

.metric-label {
    font-size: 0.9rem;
    color: #6c757d;
    margin-bottom: 0.5rem;
}

.metric-value {
    font-size: 1.25rem;
    font-weight: 700;
}

.interpretation-card {
    background: #f8f9fa;
    padding: 1.5rem;
    border-radius: 8px;
    border-left: 4px solid #28a745;
}

.interpretation-item {
    margin-bottom: 1rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid rgba(0,0,0,0.1);
}

.interpretation-item:last-child {
    border-bottom: none;
    margin-bottom: 0;
}

.interpretation-label {
    font-weight: 600;
    margin-bottom: 0.5rem;
}

.test-result {
    background: #f8f9fa;
    padding: 1rem;
    border-radius: 8px;
    text-align: center;
    border: 1px solid #dee2e6;
}

.test-name {
    font-size: 0.9rem;
    margin-bottom: 0.75rem;
    color: #495057;
}

.test-value {
    margin-bottom: 0.5rem;
}

.test-interpretation {
    margin-top: 0.5rem;
}

.correlation-item {
    background: #f8f9fa;
    padding: 1rem;
    border-radius: 8px;
    border-left: 4px solid #17a2b8;
}

.correlation-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
}

.conclusions-list {
    list-style: none;
    padding: 0;
}

.conclusions-list li {
    padding: 0.5rem 0;
    display: flex;
    align-items: center;
}

.score-circle {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    margin: 0 auto;
    color: white;
    font-weight: bold;
}

.score-excellent { background: linear-gradient(135deg, #28a745, #20c997); }
.score-very-good { background: linear-gradient(135deg, #28a745, #17a2b8); }
.score-good { background: linear-gradient(135deg, #ffc107, #fd7e14); }
.score-fair { background: linear-gradient(135deg, #fd7e14, #dc3545); }
.score-poor { background: linear-gradient(135deg, #dc3545, #6f42c1); }
.score-unknown { background: linear-gradient(135deg, #6c757d, #495057); }

.score-value {
    font-size: 2rem;
    line-height: 1;
}

.score-label {
    font-size: 0.8rem;
    margin-top: 0.25rem;
}
</style>
{% block content %}
<div class="main-content">
    <div class="page-content">
        <div class="container-fluid">
            <!-- Page Title -->
            {% block pagetitle %}
            {% include "partials/page-title.html" with pagetitle="Simulación" title="Resultados" %}
            {% endblock pagetitle %}

            <!-- Results Tutorial -->
            <div class="results-tutorial" id="resultsTutorial">
                <h5><i class="bx bx-bulb me-2"></i>Guía de Interpretación de Resultados</h5>
                <p>Sus resultados de simulación están listos. Aquí le explicamos cómo interpretarlos:</p>
                <div class="tutorial-steps">
                    <div class="tutorial-step">
                        <i class="bx bx-bar-chart-alt-2"></i>
                        <h6>Métricas Clave</h6>
                        <p class="small">Revise los indicadores principales en la parte superior</p>
                    </div>
                    <div class="tutorial-step">
                        <i class="bx bx-line-chart"></i>
                        <h6>Análisis Visual</h6>
                        <p class="small">Explore los gráficos interactivos por categoría</p>
                    </div>
                    <div class="tutorial-step">
                        <i class="bx bx-bulb"></i>
                        <h6>Recomendaciones</h6>
                        <p class="small">Lea las sugerencias personalizadas basadas en IA</p>
                    </div>
                    <div class="tutorial-step">
                        <i class="bx bx-download"></i>
                        <h6>Exportar</h6>
                        <p class="small">Descargue reportes en PDF o Excel</p>
                    </div>
                </div>
                <button class="btn btn-sm btn-outline-primary mt-3" onclick="hideTutorial()">
                    <i class="bx bx-x me-1"></i>Entendido
                </button>
            </div>

            <!-- Results Header -->
            <div class="results-header">
                <div class="row align-items-center">
                    <div class="col-lg-8">
                        <h1 class="mb-3">
                            <i class="bx bx-bar-chart-alt-2 me-3"></i>
                            Resultados de Simulación
                        </h1>
                        <p class="fs-5 mb-0">
                            Análisis completo para {{ product_instance.name }} - {{ business_instance.name }}
                        </p>
                        <p class="opacity-75 mb-0">
                            Simulación ejecutada el {{ simulation_instance.date_created|date:"d/m/Y H:i" }}
                        </p>
                    </div>
                    <div class="col-lg-4 text-lg-end">
                        <div class="export-section">
                            <h5 class="mb-3">
                                <i class="bx bx-download me-2"></i>
                                Exportar Resultados
                            </h5>
                            <div class="d-grid gap-2">
                                <button class="btn btn-primary" onclick="exportToPDF()">
                                    <i class="bx bx-file-pdf me-2"></i>
                                    Exportar PDF
                                </button>
                                <button class="btn btn-success" onclick="exportToExcel()">
                                    <i class="bx bx-file me-2"></i>
                                    Exportar Excel
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Key Insights Panel -->
            <div class="insights-panel">
                <h5 class="mb-3"><i class="bx bx-bulb me-2"></i>Insights Principales</h5>
                <div class="row">
                    <div class="col-md-6">
                        <div class="insight-item">
                            <div class="insight-icon {% if growth_rate > 0 %}positive{% else %}negative{% endif %}">
                                <i class="bx {% if growth_rate > 0 %}bx-trending-up{% else %}bx-trending-down{% endif %}"></i>
                            </div>
                            <div>
                                <h6 class="mb-1">Tendencia de Demanda</h6>
                                <p class="mb-0">
                                    La demanda muestra una tendencia 
                                    {% if growth_rate > 0 %}
                                        <strong class="text-success">creciente del {{ growth_rate|floatformat:"2" }}%</strong>
                                    {% else %}
                                        <strong class="text-danger">decreciente del {{ growth_rate|floatformat:"2" }}%</strong>
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="insight-item">
                            <div class="insight-icon {% if error_permisible < 5 %}positive{% elif error_permisible < 10 %}warning{% else %}negative{% endif %}">
                                <i class="bx bx-target-lock"></i>
                            </div>
                            <div>
                                <h6 class="mb-1">Precisión del Modelo</h6>
                                <p class="mb-0">
                                    Error permisible del <strong>{{ error_permisible|floatformat:"2" }}%</strong>
                                    {% if error_permisible < 5 %}
                                        <span class="text-success">(Muy bueno)</span>
                                    {% elif error_permisible < 10 %}
                                        <span class="text-warning">(Bueno)</span>
                                    {% else %}
                                        <span class="text-danger">(Revisar modelo)</span>
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Content Grid -->
            <div class="row">
                <!-- Sidebar with Parameters and Controls -->
                <div class="col-lg-3">
                    <!-- Simulation Parameters -->
                    <div class="metric-card mb-4">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="bx bx-cog me-2"></i>
                                Parámetros de Simulación
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-4">
                                    <img src="{{ product_instance.get_photo_url }}" 
                                         class="img-fluid rounded" 
                                         alt="{{ product_instance.name }}"
                                         loading="lazy">
                                </div>
                                <div class="col-8">
                                    <h6 class="mb-1">{{ business_instance.name }}</h6>
                                    <p class="text-muted mb-0">{{ product_instance.name }}</p>
                                </div>
                            </div>
                            
                            <dl class="row mb-0">
                                <dt class="col-6">Horizonte:</dt>
                                <dd class="col-6">{{ simulation_instance.quantity_time }} {{ simulation_instance.unit_time }}</dd>
                                
                                <dt class="col-6">Inicio:</dt>
                                <dd class="col-6">{{ simulation_instance.date_created|date:"d/m/Y" }}</dd>
                                
                                <dt class="col-6">Estado:</dt>
                                <dd class="col-6">
                                    <span class="badge bg-success">Completada</span>
                                </dd>
                            </dl>
                            
                            <!-- Quick Actions -->
                            <hr>
                            <div class="d-grid gap-2">
                                <button class="btn btn-sm btn-outline-primary" onclick="window.print()">
                                    <i class="bx bx-printer me-1"></i>Imprimir
                                </button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="shareResults()">
                                    <i class="bx bx-share-alt me-1"></i>Compartir
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Financial Recommendations -->
                    {% if financial_recommendations_to_show %}
                    <div class="recommendation-card mb-4">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="bx bx-lightbulb me-2"></i>
                                Recomendaciones Financieras
                            </h5>
                        </div>
                        <div class="card-body">
                            {% for recommendation in financial_recommendations_to_show %}
                            <div class="mb-3 p-3 bg-white rounded">
                                <h6 class="fw-bold text-primary">{{ recommendation.name }}</h6>
                                <p class="mb-2">{{ recommendation.recommendation }}</p>
                                <small class="text-muted">
                                    <i class="bx bx-info-circle me-1"></i>
                                    Variable: {{ recommendation.variable_name }}
                                </small>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Daily Results Navigation -->
                    <div class="container mt-12">
                        <div class="data-table-container">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="bx bx-calendar me-2"></i>
                                    Resultados Diarios
                                    <span class="badge bg-info ms-2" id="currentDayIndicator">Día 1</span>
                                </h5>
                            </div>
                            <div class="card-body" style="max-height: 900px; overflow-y: auto;">
                                <div id="dailyResultsContainer">
                                    {% for item in all_variables_extracted %}
                                    <div class="daily-result-item" 
                                        data-day="{{ forloop.counter }}" 
                                        style="{% if not forloop.first %}display: none;{% endif %}">
                                        <h6 class="text-primary mb-3">
                                            <i class="bx bx-calendar-event me-2"></i>
                                            {% if item.date %}
                                                {{ item.date|date:"d/m/Y" }}
                                            {% else %}
                                                Día {{ forloop.counter }}
                                            {% endif %}
                                        </h6>
                                        
                                        <!-- Demanda del día -->
                                        <div class="mb-4">
                                            <div class="row">
                                                <div class="col-6">
                                                    <div class="p-3 bg-primary text-white rounded">
                                                        <small class="d-block opacity-75">Demanda Media</small>
                                                        <h4 class="mb-0">{{ item.demand_mean|floatformat:2 }}</h4>
                                                    </div>
                                                </div>
                                                <div class="col-6">
                                                    <div class="p-3 bg-info text-white rounded">
                                                        <small class="d-block opacity-75">Desviación Estándar</small>
                                                        <h4 class="mb-0">{{ item.demand_std|floatformat:2 }}</h4>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="table-responsive">
                                            <table class="table table-sm table-hover">
                                                <thead>
                                                    <tr>
                                                        <th style="width: 40%">Variable</th>
                                                        <th style="width: 30%">Valor</th>
                                                        <th style="width: 20%">Unidad</th>
                                                        <th style="width: 10%">Estado</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for key, value in item.items %}
                                                        {% if key != 'day' and key != 'date' and key != 'demand_mean' and key != 'demand_std' %}
                                                        <tr>
                                                            <td class="small">
                                                                <strong>{{ key }}</strong>
                                                                <br>
                                                                <small class="text-muted">
    {% if key == 'PVP' %}Precio de Venta al Público
    {% elif key == 'TPV' %}Total Productos Vendidos
    {% elif key == 'IT' %}Ingresos Totales
    {% elif key == 'TG' %}Total Gastos
    {% elif key == 'GT' %}Ganancia Total
    {% elif key == 'NR' %}Nivel de Rentabilidad
    {% elif key == 'NSC' %}Nivel de Satisfacción del Cliente
    {% elif key == 'EOG' %}Eficiencia Operativa General
    {% elif key == 'DPH' %}Demanda Promedio Histórica
    {% elif key == 'CFD' %}Costo Fijo Diario
    {% elif key == 'CVU' %}Costo Variable Unitario
    {% elif key == 'CPROD' %}Capacidad de Producción
    {% elif key == 'NEPP' %}Número de Empleados en Producción
    {% elif key == 'VPC_BASE' %}Ventas por Cliente Base
    {% elif key == 'IPF_INICIAL' %}Inventario Productos Finales Inicial
    {% elif key == 'II_INICIAL' %}Inventario Insumos Inicial
    {% elif key == 'IPF_NEW' %}Inventario Productos Finales Nuevo
    {% elif key == 'DPE' %}Distancia Promedio de Entrega
    {% elif key == 'DH' %}Demanda Histórica
    {% elif key == 'DE' %}Demanda Esperada
    {% elif key == 'CIP' %}Capacidad Inventario Productos
    {% elif key == 'ED' %}Estacionalidad de la Demanda
    {% elif key == 'CUIP' %}Costo Unitario Insumo
    {% elif key == 'TPC' %}Tiempo Promedio entre Compras
    {% elif key == 'CPD' %}Clientes Por Día
    {% elif key == 'CPPL' %}Cantidad Promedio Producción por Lote
    {% elif key == 'TPE' %}Tiempo de producción por empleado
    {% elif key == 'SE' %}Sueldos Empleados
    {% elif key == 'PC' %}Precio de Venta de la Competencia
    {% elif key == 'CUTRANS' %}Costo Transporte Unitario
    {% elif key == 'TMP' %}Tiempo Medio Procesamiento Pedido
    {% elif key == 'CTPLV' %}Cantidad transportada por viaje
    {% elif key == 'GMM' %}Gastos Marketing Mensual
    {% elif key == 'TR' %}Tiempo Reabastecimiento
    {% elif key == 'CINSP' %}Conversión Insumos
    {% elif key == 'CMIPF' %}Capacidad Máxima Inventario Producto Final
    {% elif key == 'NMD' %}Número Máximo de Días
    {% elif key == 'NPD' %}Número de Proveedores de Leche
    {% elif key == 'SI' %}Stock Inventario Seguridad
    {% elif key == 'DPL' %}Días Promedio de Reposición de Leche
    {% elif key == 'CTL' %}Consumo diario promedio
    {% elif key == 'MLP' %}Minutos Laborables Por Día
    {% elif key == 'HTO' %}Horas Totales de Operación
    {% elif key == 'QMAX' %}Cantidad Máxima Producible
    {% elif key == 'TCFO' %}Temperatura Cadena Frío Objetivo
    {% elif key == 'TEO' %}Tiempo Entrega Objetivo
    {% elif key == 'TE1' %}Tiempo Entrega Proveedor 1
    {% elif key == 'TE2' %}Tiempo Entrega Proveedor 2
    {% elif key == 'TE3' %}Tiempo Entrega Proveedor 3
    {% elif key == 'P1' %}Peso Proveedor 1
    {% elif key == 'P2' %}Peso Proveedor 2
    {% elif key == 'P3' %}Peso Proveedor 3
    {% elif key == 'PMC' %}Participación Mercado Competidor
    {% elif key == 'NPC' %}Número Productos Competencia
    {% elif key == 'QPL' %}Cantidad producida de productos lácteos
    {% elif key == 'VPC' %}Ventas Por Cliente
    {% elif key == 'TCAE' %}Total Clientes Atendidos en el Día
    {% elif key == 'II' %}Inventario Insumos
    {% elif key == 'IPF' %}Inventario Productos Finales
    {% elif key == 'PI' %}Pedido Insumos
    {% elif key == 'UII' %}Uso de Inventario Insumos
    {% elif key == 'PPL' %}Productos Producidos por Lote
    {% elif key == 'TCA' %}Total Clientes Atendidos
    {% elif key == 'TP' %}Tiempo de Parada
    {% elif key == 'QC' %}Cantidad Conforme
    {% elif key == 'CRP' %}Costo Reparaciones
    {% elif key == 'CREP' %}Costo Repuestos
    {% elif key == 'CMOM' %}Costo Mano Obra Mantenimiento
    {% elif key == 'NF' %}Número de Fallas
    {% elif key == 'HMP' %}Horas Mantenimiento Preventivo
    {% elif key == 'HMC' %}Horas Mantenimiento Correctivo
    {% elif key == 'CC' %}Costo de Compra
    {% elif key == 'CTI' %}Costo de Transporte Insumos
    {% elif key == 'CAL' %}Costo de Almacenamiento
    {% elif key == 'CMP1' %}Calidad Materia Prima 1
    {% elif key == 'CMP2' %}Calidad Materia Prima 2
    {% elif key == 'CMP3' %}Calidad Materia Prima 3
    {% elif key == 'V1' %}Volumen Proveedor 1
    {% elif key == 'V2' %}Volumen Proveedor 2
    {% elif key == 'V3' %}Volumen Proveedor 3
    {% elif key == 'IIF' %}Inventario Final Insumos
    {% elif key == 'EAT' %}Entregas a Tiempo
    {% elif key == 'TTEP' %}Total de Entregas Proveedores
    {% elif key == 'ES' %}Empleados Salieron
    {% elif key == 'EE' %}Empleados Entraron
    {% elif key == 'CCAP' %}Costo Capacitación Mensual
    {% elif key == 'HAU' %}Horas Ausentismo
    {% elif key == 'HTP' %}Horas Trabajadas Programadas
    {% elif key == 'LG' %}Leads Generados
    {% elif key == 'NC' %}Nuevos Clientes
    {% elif key == 'AC' %}Alcance de Campañas
    {% elif key == 'ALC' %}Alcance Campañas
    {% elif key == 'MRE' %}Marca Reconocimiento Espontáneo
    {% elif key == 'MRA' %}Marca Reconocimiento Asistido
    {% elif key == 'CDP' %}Calidad Diferenciada Producto
    {% elif key == 'CCP' %}Costo Competitivo Producto
    {% elif key == 'CSP' %}Servicio Competitivo Producto
    {% elif key == 'ICC' %}Intensidad Campañas Competencia
    {% elif key == 'KMT' %}Kilómetros Totales
    {% elif key == 'CCF' %}Costo Cadena Frío
    {% elif key == 'CLOG' %}Costo Logístico
    {% elif key == 'TTED' %}Tiempo Total Entregas Distribución
    {% elif key == 'NE' %}Número de Entregas
    {% elif key == 'TCF' %}Temperatura Cadena Frío
    {% elif key == 'TER' %}Tiempo Entrega Real
    {% elif key == 'PD' %}Productos Devueltos
    {% elif key == 'CTR' %}Costo Total Reorden
    {% elif key == 'CTAI' %}Costo Total Adquisición Insumos
    {% elif key == 'TPPRO' %}Total Productos Producidos
    {% elif key == 'DI' %}Demanda Insatisfecha
    {% elif key == 'GO' %}Gastos Operativos
    {% elif key == 'GG' %}Gastos Generales
    {% elif key == 'CTTL' %}Costo Total Transporte
    {% elif key == 'CPP' %}Costo Promedio Producción
    {% elif key == 'CPV' %}Costo Promedio Venta
    {% elif key == 'CPI' %}Costo Promedio Insumos
    {% elif key == 'CPMO' %}Costo Promedio Mano Obra
    {% elif key == 'CUP' %}Costo Unitario Producción
    {% elif key == 'PVR' %}Precio Venta Recomendado
    {% elif key == 'FU' %}Factor Utilización
    {% elif key == 'IB' %}Ingreso Bruto
    {% elif key == 'MB' %}Margen Bruto
    {% elif key == 'RI' %}Retorno Inversión
    {% elif key == 'RTI' %}Rotación Inventario
    {% elif key == 'RTC' %}Rotación Clientes
    {% elif key == 'PM' %}Participación Mercado
    {% elif key == 'PE' %}Productividad Empleados
    {% elif key == 'HO' %}Horas Ociosas
    {% elif key == 'CHO' %}Costo Horas Ociosas
    {% elif key == 'CA' %}Costo Almacenamiento
    {% elif key == 'DT' %}Demanda Total
    {% elif key == 'NCM' %}Nivel de Competencia en el Mercado
    {% elif key == 'FC' %}Frecuencia de Compra
    {% elif key == 'CUAC' %}Costo Unitario de Adquisición de Clientes
    {% elif key == 'CUI' %}Costo Unitario Inventario
    {% elif key == 'NIL' %}Nivel Ideal del Inventario Leche
    {% elif key == 'DF' %}Tiempo Formulación Pedido
    {% elif key == 'PRL' %}Pedido Reabastecimiento Leche
    {% elif key == 'DSD' %}Desviación Estándar Demanda
    {% elif key == 'CVD' %}Coeficiente Variación Demanda
    {% elif key == 'DDP' %}Demanda Diaria Proyectada
    {% elif key == 'POD' %}Producción Objetivo Diaria
    {% elif key == 'EP' %}Eficiencia Producción
    {% elif key == 'IOP' %}Inventario Objetivo Productos
    {% elif key == 'DCI' %}Días Cobertura Inventario
    {% elif key == 'IOI' %}Inventario Objetivo Insumos
    {% elif key == 'IE' %}Ingresos Esperados
    {% elif key == 'RVE' %}Rentabilidad vs Esperada
    {% elif key == 'HNP' %}Horas Necesarias Producción
    {% elif key == 'EM' %}Efectividad Marketing
    {% elif key == 'IC' %}Índice Competitividad
    {% elif key == 'IDG' %}Índice Desempeño Global
    {% elif key == 'MP' %}Merma Producción Calculada
    {% elif key == 'MI' %}Merma Inventario Calculada
    {% elif key == 'CTM' %}Costo Total Mermas Calculado
    {% elif key == 'ISC' %}Índice Satisfacción Cliente Calculado
    {% elif key == 'PED' %}Punto de Equilibrio Diario
    {% elif key == 'DISP' %}Disponibilidad
    {% elif key == 'OEE' %}Efectividad General Equipos
    {% elif key == 'CML' %}Costo Mantenimiento por Litro
    {% elif key == 'FF' %}Frecuencia de Fallas
    {% elif key == 'RMP' %}Ratio Mantenimiento Preventivo
    {% elif key == 'CTA' %}Costo Total de Adquisición
    {% elif key == 'TPEP' %}Tiempo Promedio Entrega Proveedores
    {% elif key == 'ICP' %}Índice Calidad Proveedores
    {% elif key == 'RIMP' %}Rotación Inventario Materias Primas
    {% elif key == 'CDE' %}Cumplimiento Entregas
    {% elif key == 'IRP' %}Índice Rotación Personal
    {% elif key == 'PPE' %}Productividad por Empleado
    {% elif key == 'CCE' %}Costo Capacitación por Empleado
    {% elif key == 'TAU' %}Tasa Ausentismo
    {% elif key == 'CLL' %}Costo Laboral por Litro
    {% elif key == 'ROIA' %}ROI Inversión Publicitaria
    {% elif key == 'CPL_MKT' %}Costo por Lead
    {% elif key == 'TCL' %}Tasa Conversión Leads
    {% elif key == 'AEC' %}Alcance Efectivo Campañas
    {% elif key == 'RMI' %}Reconocimiento Marca Índice
    {% elif key == 'VCP' %}Ventaja Competitiva Precio
    {% elif key == 'PMR' %}Participación Mercado Relativa
    {% elif key == 'IDP' %}Índice Diferenciación Producto
    {% elif key == 'EEC' %}Efectividad Estrategia Competitiva
    {% elif key == 'AMEN' %}Amenaza Competitiva
    {% elif key == 'ERE' %}Eficiencia Rutas Entrega
    {% elif key == 'CDL' %}Costo Distribución por Litro
    {% elif key == 'TPEC' %}Tiempo Promedio Entrega Cliente
    {% elif key == 'ICE' %}Índice Calidad Entrega
    {% elif key == 'TD' %}Tasa Devoluciones
    {% else %}{{ key }}
    {% endif %}
</small>
                                                            </td>
                                                            <td class="fw-bold">
    {% if key == 'NR' or key == 'NSC' or key == 'EOG' or key == 'EP' or key == 'RVE' or key == 'EM' or key == 'IC' or key == 'IDG' or key == 'ISC' or key == 'DISP' or key == 'OEE' or key == 'RMP' or key == 'TAU' or key == 'ROIA' or key == 'TCL' or key == 'TD' or key == 'MB' or key == 'RI' or key == 'PM' or key == 'FU' or key == 'VCP' or key == 'PMR' or key == 'EEC' or key == 'CVD' %}
        {{ value|floatformat:3 }}
    {% elif key == 'PVP' or key == 'IT' or key == 'TG' or key == 'GT' or key == 'CFD' or key == 'CVU' or key == 'CUIP' or key == 'SE' or key == 'PC' or key == 'CUTRANS' or key == 'GMM' or key == 'CINSP' or key == 'TCFO' or key == 'TEO' or key == 'P1' or key == 'P2' or key == 'P3' or key == 'CRP' or key == 'CREP' or key == 'CMOM' or key == 'HMP' or key == 'HMC' or key == 'CC' or key == 'CTI' or key == 'CAL' or key == 'CMP1' or key == 'CMP2' or key == 'CMP3' or key == 'CCAP' or key == 'CCF' or key == 'CLOG' or key == 'TCF' or key == 'TER' or key == 'CTR' or key == 'CTAI' or key == 'GO' or key == 'GG' or key == 'CTTL' or key == 'CPP' or key == 'CPV' or key == 'CPI' or key == 'CPMO' or key == 'CUP' or key == 'PVR' or key == 'IB' or key == 'CHO' or key == 'CA' or key == 'CUAC' or key == 'CUI' or key == 'IE' or key == 'CTM' or key == 'CTA' or key == 'CCE' or key == 'CLL' or key == 'CPL_MKT' or key == 'CDL' or key == 'CML' %}
        {{ value|floatformat:2 }}
    {% else %}
        {{ value|floatformat:2 }}
    {% endif %}
</td>
                                                            <td class="small text-muted">
    {% if key == 'TPV' or key == 'DPH' or key == 'DH' or key == 'DE' or key == 'CIP' or key == 'CPPL' or key == 'QMAX' or key == 'QPL' or key == 'VPC' or key == 'VPC_BASE' or key == 'IPF_INICIAL' or key == 'II_INICIAL' or key == 'IPF_NEW' or key == 'II' or key == 'IPF' or key == 'PI' or key == 'UII' or key == 'PPL' or key == 'QC' or key == 'V1' or key == 'V2' or key == 'V3' or key == 'IIF' or key == 'KMT' or key == 'PD' or key == 'TPPRO' or key == 'DI' or key == 'DT' or key == 'NIL' or key == 'PRL' or key == 'DSD' or key == 'DDP' or key == 'POD' or key == 'IOP' or key == 'IOI' or key == 'MP' or key == 'MI' or key == 'PED' or key == 'CTL' or key == 'CMIPF' or key == 'SI' %}Litros
    {% elif key == 'PVP' or key == 'IT' or key == 'TG' or key == 'GT' or key == 'CFD' or key == 'CVU' or key == 'CUIP' or key == 'SE' or key == 'PC' or key == 'CUTRANS' or key == 'GMM' or key == 'CRP' or key == 'CREP' or key == 'CMOM' or key == 'CC' or key == 'CTI' or key == 'CAL' or key == 'CCAP' or key == 'CCF' or key == 'CLOG' or key == 'CTR' or key == 'CTAI' or key == 'GO' or key == 'GG' or key == 'CTTL' or key == 'CPP' or key == 'CPV' or key == 'CPI' or key == 'CPMO' or key == 'CUP' or key == 'PVR' or key == 'IB' or key == 'CHO' or key == 'CA' or key == 'CUAC' or key == 'CUI' or key == 'IE' or key == 'CTM' or key == 'CTA' or key == 'CCE' or key == 'CLL' or key == 'CPL_MKT' or key == 'CDL' or key == 'CML' %}Bs.
    {% elif key == 'NR' or key == 'NSC' or key == 'EOG' or key == 'ED' or key == 'P1' or key == 'P2' or key == 'P3' or key == 'PMC' or key == 'MRE' or key == 'MRA' or key == 'NCM' or key == 'EP' or key == 'CVD' or key == 'RVE' or key == 'EM' or key == 'IC' or key == 'IDG' or key == 'ISC' or key == 'DISP' or key == 'OEE' or key == 'RMP' or key == 'CDE' or key == 'IRP' or key == 'TAU' or key == 'ROIA' or key == 'TCL' or key == 'VCP' or key == 'EEC' or key == 'TD' or key == 'MB' or key == 'RI' or key == 'PM' or key == 'FU' %}%
    {% elif key == 'CPROD' %}L/día
    {% elif key == 'NEPP' or key == 'CPD' or key == 'TCAE' or key == 'TCA' or key == 'NPC' or key == 'EAT' or key == 'TTEP' or key == 'ES' or key == 'EE' or key == 'LG' or key == 'NC' or key == 'AC' or key == 'ALC' or key == 'NE' or key == 'NF' or key == 'NPD' %}Personas
    {% elif key == 'DPE' %}KM
    {% elif key == 'TPC' or key == 'TMP' or key == 'TR' or key == 'NMD' or key == 'DPL' or key == 'TE1' or key == 'TE2' or key == 'TE3' or key == 'DCI' or key == 'DF' %}DÍAS
    {% elif key == 'TPE' or key == 'MLP' or key == 'HNP' %}minutos
    {% elif key == 'HTO' or key == 'TEO' or key == 'TP' or key == 'HMP' or key == 'HMC' or key == 'HAU' or key == 'HTP' or key == 'TTED' or key == 'TER' or key == 'TPEC' or key == 'HO' %}HORAS
    {% elif key == 'CINSP' %}L/L
    {% elif key == 'TCFO' or key == 'TCF' %}°C
    {% elif key == 'CUIP' or key == 'CUTRANS' or key == 'CVU' or key == 'CML' or key == 'CDL' or key == 'CLL' %}Bs/L
    {% elif key == 'SE' or key == 'GMM' or key == 'CCAP' %}Bs/mes
    {% elif key == 'CMP1' or key == 'CMP2' or key == 'CMP3' or key == 'CDP' or key == 'CCP' or key == 'CSP' or key == 'ICP' or key == 'RMI' or key == 'IDP' %}PUNTOS
    {% elif key == 'ICC' or key == 'AMEN' or key == 'ICE' %}INDICE
    {% elif key == 'FC' %}VECES/DÍA
    {% elif key == 'RTI' or key == 'RTC' or key == 'PMR' %}VECES
    {% elif key == 'PE' or key == 'PPE' %}L/EMPLEADO
    {% elif key == 'FF' %}FALLAS/1000H
    {% elif key == 'RIMP' %}VECES/AÑO
    {% elif key == 'CCE' %}BS/EMPLEADO
    {% elif key == 'CPL_MKT' %}BS/LEAD
    {% elif key == 'CUAC' %}BS/CLIENTE
    {% elif key == 'ERE' %}L/KM
    {% else %}Unidad
    {% endif %}
</td>
                                                            <td>
                                                                {% if key == 'NR' %}
                                                                    {% if value >= 0.2 %}
                                                                        <span class="badge bg-success">Óptimo</span>
                                                                    {% elif value >= 0.1 %}
                                                                        <span class="badge bg-warning">Aceptable</span>
                                                                    {% else %}
                                                                        <span class="badge bg-danger">Crítico</span>
                                                                    {% endif %}
                                                                {% elif key == 'NSC' %}
                                                                    {% if value >= 0.9 %}
                                                                        <span class="badge bg-success">Excelente</span>
                                                                    {% elif value >= 0.7 %}
                                                                        <span class="badge bg-warning">Bueno</span>
                                                                    {% else %}
                                                                        <span class="badge bg-danger">Bajo</span>
                                                                    {% endif %}
                                                                {% elif key == 'EOG' %}
                                                                    {% if value >= 0.8 %}
                                                                        <span class="badge bg-success">Alta</span>
                                                                    {% elif value >= 0.6 %}
                                                                        <span class="badge bg-warning">Media</span>
                                                                    {% else %}
                                                                        <span class="badge bg-danger">Baja</span>
                                                                    {% endif %}
                                                                {% else %}
                                                                    <span class="badge bg-info">Normal</span>
                                                                {% endif %}
                                                            </td>
                                                        </tr>
                                                        {% endif %}
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                        
                                        <!-- Additional daily stats -->
                                        <div class="mt-4">
                                            <h6 class="text-muted mb-3">Estadísticas del día</h6>
                                            <div class="row g-3">
                                                <div class="col-6 col-md-3">
                                                    <div class="p-3 bg-light rounded text-center">
                                                        <small class="d-block text-muted">Total Variables</small>
                                                        <h5 class="mb-0">
                                                            {% with total_vars=0 %}
                                                                {% for key, value in item.items %}
                                                                    {% if key != 'day' and key != 'date' and key != 'demand_mean' and key != 'demand_std' %}
                                                                        {% with total_vars=total_vars|add:1 %}{% endwith %}
                                                                    {% endif %}
                                                                {% endfor %}
                                                                {{ item.items|length|add:-4 }}
                                                            {% endwith %}
                                                        </h5>
                                                    </div>
                                                </div>
                                                <div class="col-6 col-md-3">
                                                    <div class="p-3 bg-light rounded text-center">
                                                        <small class="d-block text-muted">Día de Simulación</small>
                                                        <h5 class="mb-0">{{ forloop.counter }}</h5>
                                                    </div>
                                                </div>
                                                {% if item.GT %}
                                                <div class="col-6 col-md-3">
                                                    <div class="p-3 bg-light rounded text-center">
                                                        <small class="d-block text-muted">Ganancia</small>
                                                        <h5 class="mb-0 {% if item.GT > 0 %}text-success{% else %}text-danger{% endif %}">
                                                            {{ item.GT|floatformat:0 }} Bs.
                                                        </h5>
                                                    </div>
                                                </div>
                                                {% endif %}
                                                {% if item.NR %}
                                                <div class="col-6 col-md-3">
                                                    <div class="p-3 bg-light rounded text-center">
                                                        <small class="d-block text-muted">Rentabilidad</small>
                                                        <h5 class="mb-0 {% if item.NR >= 0.2 %}text-success{% elif item.NR >= 0.1 %}text-warning{% else %}text-danger{% endif %}">
                                                            {{ item.NR|floatformat:1 }}%
                                                        </h5>
                                                    </div>
                                                </div>
                                                {% endif %}
                                            </div>
                                        </div>

                                        <!-- Daily notes section -->
                                        <div class="mt-4">
                                            <div class="alert alert-info">
                                                <h6 class="mb-2"><i class="bx bx-info-circle me-2"></i>Análisis del día {{ forloop.counter }}</h6>
                                                <small>
                                                    {% if item.GT and item.NR %}
                                                        Ganancia del día: <strong>{{ item.GT|floatformat:2 }} Bs.</strong> 
                                                        con rentabilidad de <strong>{{ item.NR|floatformat:1 }}%</strong>.
                                                        {% if item.NSC %}
                                                            Satisfacción del cliente: <strong>{{ item.NSC|floatformat:1 }}%</strong>.
                                                        {% endif %}
                                                    {% else %}
                                                        Datos correspondientes a la simulación del día {{ forloop.counter }}. 
                                                        Variables calculadas según el modelo de simulación.
                                                    {% endif %}
                                                </small>
                                            </div>
                                        </div>

                                    </div>
                                    {% empty %}
                                    <div class="text-center py-5">
                                        <i class="bx bx-info-circle display-4 text-muted"></i>
                                        <h5 class="mt-3 text-muted">No hay datos de variables disponibles</h5>
                                        <p class="text-muted">Los resultados de la simulación no contienen datos de variables para mostrar.</p>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            <div class="pagination-controls p-3 bg-light">
                                <div class="d-flex justify-content-between align-items-center">
                                    <button type="button" class="btn btn-sm btn-outline-primary btn-pagination" id="prevDayBtn">
                                        <i class="bx bx-chevron-left me-1"></i>Anterior
                                    </button>
                                    <span class="text-center small text-muted" id="dayCounter">
                                        Día 1 de {{ all_variables_extracted|length }}
                                    </span>
                                    <button type="button" class="btn btn-sm btn-outline-primary btn-pagination" id="nextDayBtn">
                                        Siguiente<i class="bx bx-chevron-right ms-1"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Main Charts and Analysis -->
                <div class="col-lg-9">
                    <!-- Chart Tabs -->
                        <div class="chart-tabs">
                            <ul class="nav nav-tabs" id="chartTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" 
                                            data-bs-target="#overview" type="button" role="tab">
                                        <i class="bx bx-line-chart me-2"></i>
                                        Resumen General
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="financial-tab" data-bs-toggle="tab" 
                                            data-bs-target="#financial" type="button" role="tab">
                                        <i class="bx bx-dollar me-2"></i>
                                        Análisis Financiero
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="operations-tab" data-bs-toggle="tab" 
                                            data-bs-target="#operations" type="button" role="tab">
                                        <i class="bx bx-cog me-2"></i>
                                        Operaciones
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="demand-tab" data-bs-toggle="tab" 
                                            data-bs-target="#demand" type="button" role="tab">
                                        <i class="bx bx-trending-up me-2"></i>
                                        Demanda
                                    </button>
                                </li>
                                <!-- En la sección de Tab Content, agregar nuevos tabs -->
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="endogenous-tab" data-bs-toggle="tab" 
                                            data-bs-target="#endogenous" type="button" role="tab">
                                        <i class="bx bx-scatter-chart me-2"></i>
                                        Variables Endógenas
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="analysis-tab" data-bs-toggle="tab" 
                                            data-bs-target="#analysis" type="button" role="tab">
                                        <i class="bx bx-analyse me-2"></i>
                                        Análisis Estadístico
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="validation-tab" data-bs-toggle="tab" 
                                            data-bs-target="#validation" type="button" role="tab">
                                        <i class="bx bx-check-double me-2"></i>
                                        Validación del Modelo
                                    </button>
                                </li>
                                
                            </ul>
                        </div>
                        <!-- Tab Content -->
                        <div class="tab-content" id="chartTabsContent">
                            <!-- Overview Tab -->
                            <div class="tab-pane fade show active" id="overview" role="tabpanel">
                                
                                <!-- Header de resumen ejecutivo -->
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <div class="executive-summary">
                                            <div class="summary-header">
                                                <h2 class="summary-title">
                                                    <i class="bx bx-chart me-3"></i>
                                                    Resumen Ejecutivo de la Simulación
                                                </h2>
                                                <div class="summary-badges">
                                                    {% if simulation_instance.date_created %}
                                                    <span class="badge bg-info">
                                                        <i class="bx bx-calendar me-1"></i>
                                                        {{ simulation_instance.date_created|date:"d/m/Y H:i" }}
                                                    </span>
                                                    {% endif %}
                                                    <span class="badge bg-success">
                                                        <i class="bx bx-check-circle me-1"></i>
                                                        Simulación Completada
                                                    </span>
                                                    {% if validation_summary.success_rate %}
                                                    <span class="badge bg-{% if validation_summary.success_rate >= 80 %}success{% elif validation_summary.success_rate >= 60 %}warning{% else %}danger{% endif %}">
                                                        <i class="bx bx-target-lock me-1"></i>
                                                        Precisión: {{ validation_summary.success_rate|floatformat:1 }}%
                                                    </span>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            <div class="summary-description">
                                                <p class="lead">
                                                    Análisis integral de {{ all_variables_extracted|length|default:0 }} días de simulación 
                                                    para <strong>{{ product_instance.name|default:"el producto" }}</strong> de 
                                                    <strong>{{ business_instance.name|default:"la empresa" }}</strong>.
                                                    {% if totales_acumulativos.GT %}
                                                        {% if totales_acumulativos.GT.total > 0 %}
                                                            La simulación proyecta un escenario <span class="text-success font-weight-bold">rentable</span> 
                                                            con ganancias totales de <strong>Bs. {{ totales_acumulativos.GT.total|floatformat:2 }}</strong>.
                                                        {% else %}
                                                            La simulación indica la necesidad de <span class="text-warning font-weight-bold">optimización</span> 
                                                            en la estrategia operativa y financiera.
                                                        {% endif %}
                                                    {% endif %}
                                                </p>
                                                
                                                <p class="lead">
                                                    El análisis de demanda revela que la demanda histórica promedio es de 
                                                    <strong>{{ demand_stats.historical.mean|floatformat:1 }} L diarios</strong>, mientras que la simulación 
                                                    proyecta una demanda de <strong>{{ demand_stats.simulated.mean|floatformat:1 }} L diarios</strong>.
                                                    {% if demand_stats.comparison.mean_diff > 0 %}
                                                        Esto representa un <span class="text-success font-weight-bold">incremento esperado</span> de 
                                                        <strong>{{ demand_stats.comparison.mean_diff|floatformat:1 }} L</strong>
                                                        {% if demand_stats.comparison.mean_diff_pct %}
                                                            ({{ demand_stats.comparison.mean_diff_pct|floatformat:1 }}%)
                                                        {% endif %}, 
                                                        indicando un crecimiento positivo en la demanda del producto.
                                                    {% elif demand_stats.comparison.mean_diff < 0 %}
                                                        Esto representa una <span class="text-danger font-weight-bold">disminución esperada</span> de 
                                                        <strong>{{ demand_stats.comparison.mean_diff|floatformat:1 }} L</strong>
                                                        {% if demand_stats.comparison.mean_diff_pct %}
                                                            ({{ demand_stats.comparison.mean_diff_pct|floatformat:1 }}%)
                                                        {% endif %}, 
                                                        sugiriendo la necesidad de estrategias para estimular la demanda.
                                                    {% else %}
                                                        Esto muestra una <span class="text-info font-weight-bold">estabilidad</span> en los patrones de demanda, 
                                                        manteniendo niveles consistentes con el comportamiento histórico.
                                                    {% endif %}
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Gráficos principales del overview -->
                                <div class="row mb-4">
                                    <div class="col-lg-6 mb-4">
    <div class="chart-container">
        <!-- TEXTO ARRIBA: Header con título y controles -->
        <div class="chart-header">
            <h6 class="chart-title mb-3">
                <i class="bx bx-dollar me-2"></i>
                Evolución Financiera: Ingresos vs Ganancias
            </h6>
            <div class="chart-controls">
                {% if image_data_ingresos_gastos %}
                <div class="chart-control-btn" onclick="downloadChart('{{ image_data_ingresos_gastos }}', 'ingresos-ganancias.png')" title="Descargar">
                    <i class="bx bx-download"></i>
                </div>
                <div class="chart-control-btn" onclick="openFullscreen('{{ image_data_ingresos_gastos }}', 'Ingresos vs Ganancias')" title="Pantalla completa">
                    <i class="bx bx-fullscreen"></i>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- GRÁFICO EN EL MEDIO: Imagen o placeholder -->
        <div class="chart-content">
            {% if image_data_ingresos_gastos %}
            <img src="data:image/png;base64,{{ image_data_ingresos_gastos }}" 
                class="chart-image" 
                alt="Evolución Financiera: Ingresos vs Ganancias"
                loading="lazy">
            {% else %}
            <div class="chart-placeholder">
                <i class="bx bx-chart text-muted" style="font-size: 3rem;"></i>
                <p class="text-muted mt-2">Gráfico financiero no disponible</p>
                <small class="text-muted">Los datos se generarán durante el análisis</small>
            </div>
            {% endif %}
        </div>

        <!-- FOOTER ABAJO: Resumen y análisis -->
        <div class="chart-footer">
            <div class="chart-summary">
                <small class="text-muted">
                    {% if totales_acumulativos.IT and totales_acumulativos.GT %}
                        Rendimiento financiero: 
                        {% if totales_acumulativos.GT.total > 0 %}
                            <span class="text-success">Positivo</span> - 
                            Margen del {{ margin_percent|floatformat:1 }}%
                        {% else %}
                            <span class="text-danger">Requiere optimización</span>
                        {% endif %}
                    {% else %}
                        Análisis financiero en proceso
                    {% endif %}
                </small>
            </div>
        </div>
    </div>
</div>
                                    
                                    <div class="col-lg-6 mb-4">
    <div class="chart-container">
        <!-- TEXTO ARRIBA: Header con título y controles -->
        <div class="chart-header">
            <h6 class="chart-title mb-3">
                <i class="bx bx-line-chart me-2"></i>
                Comportamiento de la Demanda
            </h6>
            <div class="chart-controls">
                {% if image_data_simulation %}
                <div class="chart-control-btn" onclick="downloadChart('{{ image_data_simulation }}', 'tendencia-demanda.png')" title="Descargar">
                    <i class="bx bx-download"></i>
                </div>
                <div class="chart-control-btn" onclick="openFullscreen('{{ image_data_simulation }}', 'Tendencia de Demanda')" title="Pantalla completa">
                    <i class="bx bx-fullscreen"></i>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- GRÁFICO EN EL MEDIO: Imagen o placeholder -->
        <div class="chart-content">
            {% if image_data_simulation %}
            <img src="data:image/png;base64,{{ image_data_simulation }}" 
                class="chart-image" 
                alt="Comportamiento de la Demanda"
                loading="lazy">
            {% elif comparison_chart %}
            <img src="data:image/png;base64,{{ comparison_chart }}" 
                class="chart-image" 
                alt="Comparación de Demanda"
                loading="lazy">
            {% else %}
            <div class="chart-placeholder">
                <i class="bx bx-chart text-muted" style="font-size: 3rem;"></i>
                <p class="text-muted mt-2">Gráfico de demanda no disponible</p>
                <small class="text-muted">Los datos se generarán durante el análisis</small>
            </div>
            {% endif %}
        </div>

        <!-- FOOTER ABAJO: Resumen y análisis -->
        <div class="chart-footer">
            <div class="chart-summary">
                <small class="text-muted">
                    {% if growth_rate %}
                        Tendencia de crecimiento: 
                        {% if growth_rate > 0 %}
                            <span class="text-success">+{{ growth_rate|floatformat:2 }}%</span> - Creciente
                        {% elif growth_rate < 0 %}
                            <span class="text-danger">{{ growth_rate|floatformat:2 }}%</span> - Decreciente
                        {% else %}
                            <span class="text-info">{{ growth_rate|floatformat:2 }}%</span> - Estable
                        {% endif %}
                    {% elif demand_stats.comparison.mean_diff_pct %}
                        Cambio vs histórico: {{ demand_stats.comparison.mean_diff_pct|floatformat:2 }}%
                    {% else %}
                        Análisis de tendencia en proceso
                    {% endif %}
                </small>
            </div>
        </div>
    </div>
</div>
                                </div>

                                <!-- Gráficos adicionales de overview -->
                                <div class="row mb-6">
                                    <div class="col-lg-6 mb-3">
    <div class="chart-container compact">
        <!-- TEXTO ARRIBA: Título -->
        <div class="chart-header">
            <h6 class="chart-title mb-3">
                <i class="bx bx-bar-chart me-2"></i>
                Eficiencia Operativa
            </h6>
        </div>

        <!-- GRÁFICO EN EL MEDIO: Imagen o placeholder -->
        <div class="chart-content">
            {% if image_data_eficiencia %}
            <img src="data:image/png;base64,{{ image_data_eficiencia }}" 
                class="chart-image" 
                alt="Eficiencia Operativa"
                loading="lazy">
            {% else %}
            <div class="chart-placeholder compact">
                <i class="bx bx-bar-chart text-muted" style="font-size: 2rem;"></i>
                <p class="text-muted mt-2">No disponible</p>
            </div>
            {% endif %}
        </div>

        <!-- FOOTER ABAJO: Podría agregarse aquí si se necesita -->
        <div class="chart-footer">
            <!-- Footer vacío para mantener consistencia -->
        </div>
    </div>
</div>

<div class="col-lg-6 mb-3">
    <div class="chart-container compact">
        <!-- TEXTO ARRIBA: Título -->
        <div class="chart-header">
            <h6 class="chart-title mb-3">
                <i class="bx bx-trending-up me-2"></i>
                Análisis de ROI
            </h6>
        </div>

        <!-- GRÁFICO EN EL MEDIO: Imagen o placeholder -->
        <div class="chart-content">
            {% if image_data_kpis %}
            <img src="data:image/png;base64,{{ image_data_kpis }}" 
                class="chart-image" 
                alt="Análisis de KPIs"
                loading="lazy">
            {% elif image_data_rentabilidad %}
            <img src="data:image/png;base64,{{ image_data_rentabilidad }}" 
                class="chart-image" 
                alt="Análisis de Rentabilidad"
                loading="lazy">
            {% else %}
            <div class="chart-placeholder compact">
                <i class="bx bx-trending-up text-muted" style="font-size: 2rem;"></i>
                <p class="text-muted mt-2">No disponible</p>
            </div>
            {% endif %}
        </div>

        <!-- FOOTER ABAJO: Podría agregarse aquí si se necesita -->
        <div class="chart-footer">
            <!-- Footer vacío para mantener consistencia -->
        </div>
    </div>
</div>
                                </div>

                                <!-- Datos estadísticos adicionales si están disponibles -->
                                {% if demand_stats.comparison %}
                                <div class="row mb-9">
                                    <div class="col-12">
                                        <h5 class="mb-3">
                                            <i class="bx bx-calculator me-2"></i>
                                            Estadísticas Comparativas
                                        </h5>
                                        <div class="row">
                                            <div class="col-md-3">
                                                <div class="text-center p-3 border rounded">
                                                    <h6 class="text-muted mb-1">Correlación</h6>
                                                    <h4 class="mb-0 {% if demand_stats.comparison.correlation > 0.8 %}text-success{% elif demand_stats.comparison.correlation > 0.6 %}text-warning{% else %}text-danger{% endif %}">
                                                        {{ demand_stats.comparison.correlation|floatformat:3 }}
                                                    </h4>
                                                    <small class="text-muted">Histórico vs Simulado</small>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="text-center p-3 border rounded">
                                                    <h6 class="text-muted mb-1">MAPE</h6>
                                                    <h4 class="mb-0 {% if demand_stats.comparison.mape < 10 %}text-success{% elif demand_stats.comparison.mape < 20 %}text-warning{% else %}text-danger{% endif %}">
                                                        {{ demand_stats.comparison.mape|floatformat:2 }}%
                                                    </h4>
                                                    <small class="text-muted">Error promedio</small>
                                                </div>
                                            </div>
                                            {% if demand_stats.comparison.r_squared %}
                                            <div class="col-md-3">
                                                <div class="text-center p-3 border rounded">
                                                    <h6 class="text-muted mb-1">R²</h6>
                                                    <h4 class="mb-0 {% if demand_stats.comparison.r_squared > 0.8 %}text-success{% elif demand_stats.comparison.r_squared > 0.6 %}text-warning{% else %}text-danger{% endif %}">
                                                        {{ demand_stats.comparison.r_squared|floatformat:3 }}
                                                    </h4>
                                                    <small class="text-muted">Bondad de ajuste</small>
                                                </div>
                                            </div>
                                            {% endif %}
                                            {% if demand_stats.comparison.mean_diff_pct %}
                                            <div class="col-md-3">
                                                <div class="text-center p-3 border rounded">
                                                    <h6 class="text-muted mb-1">Cambio en Media</h6>
                                                    <h4 class="mb-0 {% if demand_stats.comparison.mean_diff_pct > -5 and demand_stats.comparison.mean_diff_pct < 5 %}text-success{% else %}text-warning{% endif %}">
                                                        {% if demand_stats.comparison.mean_diff_pct > 0 %}+{% endif %}{{ demand_stats.comparison.mean_diff_pct|floatformat:1 }}%
                                                    </h4>
                                                    <small class="text-muted">vs histórico</small>
                                                </div>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                            <!-- Financial Tab - Actualización completa -->
                            <!-- Financial Tab - Actualización completa -->
<!-- Financial Tab -->
<div class="tab-pane fade" id="financial" role="tabpanel">
    
    <!-- Header con resumen financiero -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-success">
                <h4 class="alert-heading mb-3">
                    <i class="bx bx-dollar-circle me-2"></i>
                    Análisis Financiero Integral
                </h4>
                <p class="mb-2">
                    Análisis completo de la performance financiera de la simulación, incluyendo ingresos, gastos, 
                    rentabilidad y métricas clave de rendimiento financiero.
                </p>
                <small class="text-muted">
                    Período analizado: <strong>{{ all_variables_extracted|length|default:0 }} días</strong> | 
                    {% if totales_acumulativos.GT %}
                        Ganancia total: <strong>Bs. {{ totales_acumulativos.GT.total|floatformat:2|default:"0.00" }}</strong>
                    {% endif %}
                    {% if validation_summary.success_rate %}
                        | Precisión del modelo: <strong>{{ validation_summary.success_rate|floatformat:1 }}%</strong>
                    {% endif %}
                </small>
            </div>
        </div>
    </div>

    <!-- Métricas financieras principales -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-gradient-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="text-white-50">Ingresos Totales</h6>
                            <h3 class="mb-0">
                                {% if totales_acumulativos.IT %}
                                    Bs. {{ totales_acumulativos.IT.total|floatformat:0|default:"0" }}
                                {% else %}
                                    Bs. 0
                                {% endif %}
                            </h3>
                            {% if totales_acumulativos.IT.trend %}
                            <small class="text-white-75">
                                Tendencia: {{ totales_acumulativos.IT.trend|capfirst }}
                            </small>
                            {% endif %}
                        </div>
                        <div class="align-self-center">
                            <i class="bx bx-dollar display-6"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-gradient-danger text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="text-white-50">Gastos Totales</h6>
                            <h3 class="mb-0">
                                {% if totales_acumulativos.TG %}
                                    Bs. {{ totales_acumulativos.TG.total|floatformat:0|default:"0" }}
                                {% else %}
                                    Bs. 0
                                {% endif %}
                            </h3>
                            {% if totales_acumulativos.TG.trend %}
                            <small class="text-white-75">
                                Tendencia: {{ totales_acumulativos.TG.trend|capfirst }}
                            </small>
                            {% endif %}
                        </div>
                        <div class="align-self-center">
                            <i class="bx bx-trending-down display-6"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-gradient-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="text-white-50">Ganancia Neta</h6>
                            <h3 class="mb-0">
                                {% if totales_acumulativos.GT %}
                                    Bs. {{ totales_acumulativos.GT.total|floatformat:0|default:"0" }}
                                {% else %}
                                    Bs. 0
                                {% endif %}
                            </h3>
                            {% if totales_acumulativos.GT.trend %}
                            <small class="text-white-75">
                                Tendencia: {{ totales_acumulativos.GT.trend|capfirst }}
                            </small>
                            {% endif %}
                        </div>
                        <div class="align-self-center">
                            <i class="bx bx-trending-up display-6"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-gradient-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="text-white-50">Margen Promedio</h6>
                            <h3 class="mb-0">
                                {% if totales_acumulativos.NR and all_variables_extracted %}
                                    {% if all_variables_extracted|length > 0 %}
                                        {% with total_nr=totales_acumulativos.NR.total|default:0 %}
                                        {% with days_count=all_variables_extracted|length %}
                                        {% if days_count > 0 %}
                                            {% with avg_margin_decimal=total_nr|floatformat:6 %}
                                            {% if avg_margin_decimal != "0.000000" %}
                                                {% with avg_margin_calc=total_nr|default:0 %}
                                                {% with avg_margin_final=avg_margin_calc|default:0 %}
                                                {{ avg_margin_final|floatformat:1 }}%
                                                {% endwith %}
                                                {% endwith %}
                                            {% else %}
                                                0.0%
                                            {% endif %}
                                            {% endwith %}
                                        {% else %}
                                            0.0%
                                        {% endif %}
                                        {% endwith %}
                                        {% endwith %}
                                    {% else %}
                                        0.0%
                                    {% endif %}
                                {% else %}
                                    0.0%
                                {% endif %}
                            </h3>
                            {% if totales_acumulativos.NR.trend %}
                            <small class="text-white-75">
                                Tendencia: {{ totales_acumulativos.NR.trend|capfirst }}
                            </small>
                            {% endif %}
                        </div>
                        <div class="align-self-center">
                            <i class="bx bx-percentage display-6"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Gráficos principales -->
    <div class="row">
        <!-- Ingresos vs Ganancias -->
        <div class="col-md-6 mb-4">
    <div class="chart-container">
        <!-- TEXTO ARRIBA: Header con título y controles -->
        <div class="chart-header">
            <h6 class="chart-title mb-3">
                <i class="bx bx-dollar me-2"></i>
                Evolución de Ingresos vs Ganancias
            </h6>
            <div class="chart-controls">
                {% if image_data_ingresos_gastos %}
                <div class="chart-control-btn" onclick="downloadChart('{{ image_data_ingresos_gastos }}', 'ingresos-ganancias.png')" title="Descargar">
                    <i class="bx bx-download"></i>
                </div>
                <div class="chart-control-btn" onclick="openFullscreen('{{ image_data_ingresos_gastos }}', 'Ingresos vs Ganancias')" title="Pantalla completa">
                    <i class="bx bx-fullscreen"></i>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- GRÁFICO EN EL MEDIO: Imagen o placeholder -->
        <div class="chart-content">
            {% if image_data_ingresos_gastos %}
            <img src="data:image/png;base64,{{ image_data_ingresos_gastos }}" 
                class="chart-image" 
                alt="Evolución de Ingresos vs Ganancias"
                loading="lazy">
            {% else %}
            <div class="chart-placeholder">
                <i class="bx bx-chart text-muted" style="font-size: 3rem;"></i>
                <p class="text-muted mt-2">Gráfico de ingresos vs ganancias no disponible</p>
                <small class="text-muted">Los datos se generarán durante el análisis</small>
            </div>
            {% endif %}
        </div>

        <!-- FOOTER ABAJO: Preparado para resumen -->
        <div class="chart-footer">
            <!-- Footer disponible para agregar información de resumen -->
        </div>
    </div>
</div>
        
        <!-- Análisis de Gastos -->
        <div class="col-md-6 mb-4">
            <div class="chart-container">
                <div class="chart-header">
                    <h6 class="mb-3">
                        <i class="bx bx-trending-down me-2"></i>
                        Composición y Evolución de Gastos
                    </h6>
                    <div class="chart-controls">
                        {% if image_data_gastos %}
                        <div class="chart-control-btn" onclick="downloadChart('{{ image_data_gastos }}', 'analisis-gastos.png')" title="Descargar">
                            <i class="bx bx-download"></i>
                        </div>
                        <div class="chart-control-btn" onclick="openFullscreen('{{ image_data_gastos }}', 'Análisis de Gastos')" title="Pantalla completa">
                            <i class="bx bx-fullscreen"></i>
                        </div>
                        {% elif image_data_rentabilidad %}
                        <div class="chart-control-btn" onclick="downloadChart('{{ image_data_rentabilidad }}', 'analisis-rentabilidad.png')" title="Descargar">
                            <i class="bx bx-download"></i>
                        </div>
                        <div class="chart-control-btn" onclick="openFullscreen('{{ image_data_rentabilidad }}', 'Análisis de Rentabilidad')" title="Pantalla completa">
                            <i class="bx bx-fullscreen"></i>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% if image_data_gastos %}
                <img src="data:image/png;base64,{{ image_data_gastos }}" 
                    class="chart-image" 
                    alt="Análisis de gastos"
                    loading="lazy">
                {% elif image_data_rentabilidad %}
                <img src="data:image/png;base64,{{ image_data_rentabilidad }}" 
                    class="chart-image" 
                    alt="Análisis de rentabilidad y gastos"
                    loading="lazy">
                {% else %}
                <div class="chart-placeholder">
                    <i class="bx bx-chart text-muted" style="font-size: 3rem;"></i>
                    <p class="text-muted mt-2">Gráfico de análisis de gastos no disponible</p>
                    <small class="text-muted">Los datos se generarán durante el análisis</small>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Costos de Producción -->
        <div class="col-md-6 mb-4">
            <div class="chart-container">
                <div class="chart-header">
                    <h6 class="mb-3">
                        <i class="bx bx-calculator me-2"></i>
                        Estructura de Costos de Producción
                    </h6>
                    <div class="chart-controls">
                        {% if cost_distribution_chart %}
                        <div class="chart-control-btn" onclick="downloadChart('{{ cost_distribution_chart }}', 'distribucion-costos.png')" title="Descargar">
                            <i class="bx bx-download"></i>
                        </div>
                        <div class="chart-control-btn" onclick="openFullscreen('{{ cost_distribution_chart }}', 'Distribución de Costos')" title="Pantalla completa">
                            <i class="bx bx-fullscreen"></i>
                        </div>
                        {% elif image_data_costos %}
                        <div class="chart-control-btn" onclick="downloadChart('{{ image_data_costos }}', 'costos-produccion.png')" title="Descargar">
                            <i class="bx bx-download"></i>
                        </div>
                        <div class="chart-control-btn" onclick="openFullscreen('{{ image_data_costos }}', 'Costos de Producción')" title="Pantalla completa">
                            <i class="bx bx-fullscreen"></i>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% if cost_distribution_chart %}
                <img src="data:image/png;base64,{{ cost_distribution_chart }}" 
                    class="chart-image" 
                    alt="Distribución de costos"
                    loading="lazy">
                {% elif image_data_costos %}
                <img src="data:image/png;base64,{{ image_data_costos }}" 
                    class="chart-image" 
                    alt="Costos de producción"
                    loading="lazy">
                {% elif image_data_eficiencia %}
                <img src="data:image/png;base64,{{ image_data_eficiencia }}" 
                    class="chart-image" 
                    alt="Eficiencia y costos"
                    loading="lazy">
                {% else %}
                <div class="chart-placeholder">
                    <i class="bx bx-chart text-muted" style="font-size: 3rem;"></i>
                    <p class="text-muted mt-2">Gráfico de costos de producción no disponible</p>
                    <small class="text-muted">Los datos se generarán durante el análisis</small>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Rentabilidad y ROI -->
        <div class="col-md-6 mb-4">
            <div class="chart-container">
                <div class="chart-header">
                    <h6 class="mb-3">
                        <i class="bx bx-stats me-2"></i>
                        Rentabilidad y ROI
                    </h6>
                    <div class="chart-controls">
                        {% if financial_efficiency_chart %}
                        <div class="chart-control-btn" onclick="downloadChart('{{ financial_efficiency_chart }}', 'eficiencia-financiera.png')" title="Descargar">
                            <i class="bx bx-download"></i>
                        </div>
                        <div class="chart-control-btn" onclick="openFullscreen('{{ financial_efficiency_chart }}', 'Eficiencia Financiera')" title="Pantalla completa">
                            <i class="bx bx-fullscreen"></i>
                        </div>
                        {% elif image_data_kpis %}
                        <div class="chart-control-btn" onclick="downloadChart('{{ image_data_kpis }}', 'roi-rentabilidad.png')" title="Descargar">
                            <i class="bx bx-download"></i>
                        </div>
                        <div class="chart-control-btn" onclick="openFullscreen('{{ image_data_kpis }}', 'ROI y Rentabilidad')" title="Pantalla completa">
                            <i class="bx bx-fullscreen"></i>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% if financial_efficiency_chart %}
                <img src="data:image/png;base64,{{ financial_efficiency_chart }}" 
                    class="chart-image" 
                    alt="Eficiencia financiera"
                    loading="lazy">
                {% elif image_data_kpis %}
                <img src="data:image/png;base64,{{ image_data_kpis }}" 
                    class="chart-image" 
                    alt="KPIs financieros"
                    loading="lazy">
                {% elif image_data_rentabilidad %}
                <img src="data:image/png;base64,{{ image_data_rentabilidad }}" 
                    class="chart-image" 
                    alt="Análisis de rentabilidad"
                    loading="lazy">
                {% else %}
                <div class="chart-placeholder">
                    <i class="bx bx-chart text-muted" style="font-size: 3rem;"></i>
                    <p class="text-muted mt-2">Gráfico de ROI y rentabilidad no disponible</p>
                    <small class="text-muted">Los datos se generarán durante el análisis</small>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Gráficos de variables financieras endógenas -->
    {% if endogenous_charts %}
    <div class="row mb-4">
        <div class="col-12">
            <h5 class="mb-3">
                <i class="bx bx-line-chart me-2"></i>
                Variables Financieras Endógenas
            </h5>
        </div>
        
        {% for chart_name, chart_data in endogenous_charts.items %}
            {% if 'IT' in chart_name or 'GT' in chart_name or 'TG' in chart_name or 'NR' in chart_name %}
            <div class="col-md-6 mb-4">
                <div class="chart-container">
                    <div class="chart-header">
                        <h6 class="mb-3">
                            {% if 'IT' in chart_name %}
                                <i class="bx bx-dollar text-success me-2"></i>Evolución de Ingresos Totales
                            {% elif 'GT' in chart_name %}
                                <i class="bx bx-trending-up text-primary me-2"></i>Evolución de Ganancia Total
                            {% elif 'TG' in chart_name %}
                                <i class="bx bx-trending-down text-danger me-2"></i>Evolución de Total Gastos
                            {% elif 'NR' in chart_name %}
                                <i class="bx bx-percentage text-info me-2"></i>Evolución del Nivel de Rentabilidad
                            {% endif %}
                        </h6>
                        <div class="chart-controls">
                            <div class="chart-control-btn" onclick="downloadChart('{{ chart_data }}', '{{ chart_name }}.png')" title="Descargar">
                                <i class="bx bx-download"></i>
                            </div>
                            <div class="chart-control-btn" onclick="openFullscreen('{{ chart_data }}', '{{ chart_name }}')" title="Pantalla completa">
                                <i class="bx bx-fullscreen"></i>
                            </div>
                        </div>
                    </div>
                    <img src="data:image/png;base64,{{ chart_data }}" 
                        class="chart-image" 
                        alt="{{ chart_name }}"
                        loading="lazy">
                </div>
            </div>
            {% endif %}
        {% endfor %}
    </div>
    {% endif %}


    <!-- Recomendaciones financieras -->
    {% if financial_recommendations %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                       <i class="bx bx-lightbulb me-2"></i>
                       Recomendaciones Financieras
                   </h5>
               </div>
               <div class="card-body">
                   <div class="row">
                       {% for recommendation in financial_recommendations %}
                       <div class="col-md-6 mb-3">
                           <div class="alert alert-{% if recommendation.severity == 'high' %}danger{% elif recommendation.severity == 'medium' %}warning{% else %}info{% endif %} alert-dismissible">
                               <h6 class="alert-heading">
                                   {% if recommendation.severity == 'high' %}
                                       <i class="bx bx-error-circle me-2"></i>
                                   {% elif recommendation.severity == 'medium' %}
                                       <i class="bx bx-error me-2"></i>
                                   {% else %}
                                       <i class="bx bx-info-circle me-2"></i>
                                   {% endif %}
                                   {{ recommendation.name|default:'Recomendación Financiera' }}
                               </h6>
                               <p class="mb-2">{{ recommendation.description|default:recommendation.recommendation }}</p>
                               {% if recommendation.priority %}
                               <small class="fw-bold">
                                   Prioridad: 
                                   <span class="badge bg-{% if recommendation.priority == 'high' %}danger{% elif recommendation.priority == 'medium' %}warning{% else %}secondary{% endif %}">
                                       {% if recommendation.priority == 'high' %}Alta
                                       {% elif recommendation.priority == 'medium' %}Media
                                       {% else %}Baja
                                       {% endif %}
                                   </span>
                               </small>
                               {% endif %}
                               {% if recommendation.variable %}
                               <br><small class="text-muted">Variable: {{ recommendation.variable }}</small>
                               {% endif %}
                           </div>
                       </div>
                       {% endfor %}
                   </div>
               </div>
           </div>
       </div>
   </div>
   {% endif %}

   <!-- Estadísticas de demanda financiera si están disponibles -->
   {% if demand_stats.historical and demand_stats.simulated %}
   <div class="row mb-4">
       <div class="col-12">
           <div class="card">
               <div class="card-header">
                   <h5 class="card-title mb-0">
                       <i class="bx bx-stats me-2"></i>
                       Impacto Financiero de la Demanda
                   </h5>
               </div>
               <div class="card-body">
                   <div class="row">
                       <div class="col-md-4">
                           <div class="text-center p-3 border rounded">
                               <h6 class="text-muted mb-1">Demanda Histórica</h6>
                               <h4 class="mb-0 text-primary">{{ demand_stats.historical.mean|floatformat:1 }} L</h4>
                               <small class="text-muted">Promedio diario</small>
                           </div>
                       </div>
                       <div class="col-md-4">
                           <div class="text-center p-3 border rounded">
                               <h6 class="text-muted mb-1">Demanda Simulada</h6>
                               <h4 class="mb-0 text-success">{{ demand_stats.simulated.mean|floatformat:1 }} L</h4>
                               <small class="text-muted">Promedio proyectado</small>
                           </div>
                       </div>
                       <div class="col-md-4">
                           <div class="text-center p-3 border rounded">
                               <h6 class="text-muted mb-1">Cambio Esperado</h6>
                               <h4 class="mb-0 {% if demand_stats.comparison.mean_diff > 0 %}text-success{% elif demand_stats.comparison.mean_diff < 0 %}text-danger{% else %}text-info{% endif %}">
                                   {% if demand_stats.comparison.mean_diff > 0 %}+{% endif %}{{ demand_stats.comparison.mean_diff|floatformat:1 }} L
                               </h4>
                               <small class="text-muted">
                                   {% if demand_stats.comparison.mean_diff_pct %}
                                       ({{ demand_stats.comparison.mean_diff_pct|floatformat:1 }}%)
                                   {% endif %}
                               </small>
                           </div>
                       </div>
                   </div>
                   {% if demand_stats.comparison.correlation %}
                   <div class="mt-3 text-center">
                       <p class="mb-0">
                           <strong>Correlación con histórico:</strong> 
                           <span class="{% if demand_stats.comparison.correlation > 0.8 %}text-success{% elif demand_stats.comparison.correlation > 0.6 %}text-warning{% else %}text-danger{% endif %}">
                               {{ demand_stats.comparison.correlation|floatformat:3 }}
                           </span>
                           {% if demand_stats.comparison.mape %}
                           | <strong>Error promedio:</strong> {{ demand_stats.comparison.mape|floatformat:2 }}%
                           {% endif %}
                       </p>
                   </div>
                   {% endif %}
               </div>
           </div>
       </div>
   </div>
   {% endif %}

   <!-- Métricas de validación financiera si están disponibles -->
   {% if validation_summary %}
   <div class="row mb-4">
       <div class="col-12">
           <div class="card">
               <div class="card-header">
                   <h5 class="card-title mb-0">
                       <i class="bx bx-shield-quarter me-2"></i>
                       Validación del Modelo Financiero
                   </h5>
               </div>
               <div class="card-body">
                   <div class="row">
                       {% if validation_summary.success_rate %}
                       <div class="col-md-3">
                           <div class="text-center p-3 border rounded">
                               <h6 class="text-muted mb-1">Tasa de Éxito</h6>
                               <h4 class="mb-0 {% if validation_summary.success_rate >= 80 %}text-success{% elif validation_summary.success_rate >= 60 %}text-warning{% else %}text-danger{% endif %}">
                                   {{ validation_summary.success_rate|floatformat:1 }}%
                               </h4>
                               <small class="text-muted">Validación general</small>
                           </div>
                       </div>
                       {% endif %}
                       {% if validation_summary.avg_mape %}
                       <div class="col-md-3">
                           <div class="text-center p-3 border rounded">
                               <h6 class="text-muted mb-1">MAPE</h6>
                               <h4 class="mb-0 {% if validation_summary.avg_mape < 10 %}text-success{% elif validation_summary.avg_mape < 20 %}text-warning{% else %}text-danger{% endif %}">
                                   {{ validation_summary.avg_mape|floatformat:2 }}%
                               </h4>
                               <small class="text-muted">Error promedio</small>
                           </div>
                       </div>
                       {% endif %}
                       {% if validation_summary.precise_count %}
                       <div class="col-md-3">
                           <div class="text-center p-3 border rounded">
                               <h6 class="text-muted mb-1">Predicciones Precisas</h6>
                               <h4 class="mb-0 text-success">{{ validation_summary.precise_count }}</h4>
                               <small class="text-muted">Error &lt; 10%</small>
                           </div>
                       </div>
                       {% endif %}
                       {% if validation_summary.inaccurate_count %}
                       <div class="col-md-3">
                           <div class="text-center p-3 border rounded">
                               <h6 class="text-muted mb-1">Predicciones Inexactas</h6>
                               <h4 class="mb-0 text-danger">{{ validation_summary.inaccurate_count }}</h4>
                               <small class="text-muted">Error &gt; 20%</small>
                           </div>
                       </div>
                       {% endif %}
                   </div>
               </div>
           </div>
       </div>
   </div>
   {% endif %}

   <!-- Análisis comparativo con simulaciones anteriores si existe -->
   {% if comparison_chart %}
   <div class="row mb-4">
       <div class="col-12">
           <div class="card">
               <div class="card-header">
                   <h5 class="card-title mb-0">
                       <i class="bx bx-git-compare me-2"></i>
                       Comparación con Datos Históricos
                   </h5>
               </div>
               <div class="card-body">
                   <div class="chart-container">
                       <img src="data:image/png;base64,{{ comparison_chart }}" 
                           class="chart-image" 
                           alt="Comparación de demanda histórica vs simulada"
                           loading="lazy">
                   </div>
                   <div class="mt-3">
                       <p class="text-muted mb-0">
                           Este gráfico muestra la comparación entre la demanda histórica real y la demanda simulada por el modelo, 
                           permitiendo evaluar la precisión de las proyecciones financieras.
                       </p>
                   </div>
               </div>
           </div>
       </div>
   </div>
   {% endif %}

</div>
    


                            <!-- Operations Tab - Versión Corregida -->
                            <div class="tab-pane fade" id="operations" role="tabpanel">
                                
                                <!-- Header operativo -->
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <div class="alert alert-info">
                                            <h4 class="alert-heading mb-3">
                                                <i class="bx bx-cog me-2"></i>
                                                Análisis Operativo Integral
                                            </h4>
                                            <p class="mb-2">
                                                Análisis completo de la eficiencia operativa, costos de producción y métricas clave 
                                                durante {{ all_variables_extracted|length|default:0 }} días de simulación.
                                            </p>
                                            <div class="row mt-3">
                                                <div class="col-md-3">
                                                    <strong>Productos Vendidos:</strong> 
                                                    <span class="text-primary">
                                                        {% if totales_acumulativos.TPV %}
                                                            {{ totales_acumulativos.TPV.total|floatformat:0 }}
                                                        {% else %}
                                                            0
                                                        {% endif %} unidades
                                                    </span>
                                                </div>
                                                <div class="col-md-3">
                                                    <strong>Eficiencia Promedio:</strong> 
                                                    {% if totales_acumulativos.EOG and all_variables_extracted|length > 0 %}
                                                        <span class="text-success">{{ totales_acumulativos.EOG.total|floatformat:1 }}%</span>
                                                    {% else %}
                                                        <span class="text-muted">Calculando...</span>
                                                    {% endif %}
                                                </div>
                                                <div class="col-md-3">
                                                    <strong>Personal:</strong>
                                                    {% if totales_acumulativos.NEPP %}
                                                        <span class="text-info">{{ totales_acumulativos.NEPP.total|floatformat:0 }} empleados</span>
                                                    {% else %}
                                                        <span class="text-muted">N/A</span>
                                                    {% endif %}
                                                </div>
                                                <div class="col-md-3">
                                                    <strong>Días Analizados:</strong>
                                                    <span class="text-warning">{{ all_variables_extracted|length|default:0 }}</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Métricas operativas principales -->
                                <div class="row mb-4">
                                    <div class="col-md-3">
                                        <div class="card bg-gradient-primary text-white">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between">
                                                    <div>
                                                        <h6 class="text-white-50">Productos Vendidos</h6>
                                                        <h3 class="mb-0">
                                                            {% if totales_acumulativos.TPV %}
                                                                {{ totales_acumulativos.TPV.total|floatformat:0 }}
                                                            {% else %}
                                                                0
                                                            {% endif %}
                                                        </h3>
                                                        <small class="text-white-75">Total del período</small>
                                                    </div>
                                                    <div class="align-self-center">
                                                        <i class="bx bx-package display-6"></i>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-3">
                                        <div class="card bg-gradient-success text-white">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between">
                                                    <div>
                                                        <h6 class="text-white-50">Eficiencia Operativa</h6>
                                                        <h3 class="mb-0">
                                                            {% if totales_acumulativos.EOG %}
                                                                {{ totales_acumulativos.EOG.total|floatformat:1 }}%
                                                            {% else %}
                                                                0.0%
                                                            {% endif %}
                                                        </h3>
                                                        <small class="text-white-75">Promedio general</small>
                                                    </div>
                                                    <div class="align-self-center">
                                                        <i class="bx bx-tachometer display-6"></i>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-3">
                                        <div class="card bg-gradient-warning text-white">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between">
                                                    <div>
                                                        <h6 class="text-white-50">Capacidad Total</h6>
                                                        <h3 class="mb-0">
                                                            {% if totales_acumulativos.CPROD %}
                                                                {{ totales_acumulativos.CPROD.total|floatformat:0 }}
                                                            {% else %}
                                                                N/A
                                                            {% endif %}
                                                        </h3>
                                                        <small class="text-white-75">Litros/período</small>
                                                    </div>
                                                    <div class="align-self-center">
                                                        <i class="bx bx-bar-chart display-6"></i>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-3">
                                        <div class="card bg-gradient-danger text-white">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between">
                                                    <div>
                                                        <h6 class="text-white-50">Costo Variable Unit.</h6>
                                                        <h3 class="mb-0">
                                                            {% if totales_acumulativos.CVU %}
                                                                Bs. {{ totales_acumulativos.CVU.total|floatformat:2 }}
                                                            {% else %}
                                                                Bs. 0.00
                                                            {% endif %}
                                                        </h3>
                                                        <small class="text-white-75">Promedio</small>
                                                    </div>
                                                    <div class="align-self-center">
                                                        <i class="bx bx-calculator display-6"></i>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Gráficos operativos principales -->
                                <div class="row mb-4">
                                    <!-- Gráfico de Eficiencia Operativa -->
                                    <div class="col-lg-6 mb-4">
                                        <div class="chart-container">
                                            <div class="chart-header">
                                                <h6 class="chart-title mb-3">
                                                    <i class="bx bx-tachometer me-2"></i>
                                                    Indicadores de Eficiencia Operativa
                                                </h6>
                                                <div class="chart-controls">
                                                    {% if image_data_eficiencia %}
                                                    <div class="chart-control-btn" onclick="downloadChart('{{ image_data_eficiencia }}', 'eficiencia-operativa.png')" title="Descargar">
                                                        <i class="bx bx-download"></i>
                                                    </div>
                                                    <div class="chart-control-btn" onclick="openFullscreen('{{ image_data_eficiencia }}', 'Eficiencia Operativa')" title="Pantalla completa">
                                                        <i class="bx bx-fullscreen"></i>
                                                    </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            {% if image_data_eficiencia %}
                                            <img src="data:image/png;base64,{{ image_data_eficiencia }}" 
                                                class="chart-image" 
                                                alt="Indicadores de Eficiencia Operativa"
                                                loading="lazy">
                                            {% else %}
                                            <div class="chart-placeholder">
                                                <i class="bx bx-tachometer text-muted" style="font-size: 3rem;"></i>
                                                <p class="text-muted mt-2">Indicadores de eficiencia</p>
                                                <small class="text-muted">Métricas de rendimiento operativo</small>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    
                                    {% comment %} <!-- Gráfico de Costos Operativos -->
                                    <div class="col-lg-6 mb-4">
                                        <div class="chart-container">
                                            <div class="chart-header">
                                                <h6 class="chart-title mb-3">
                                                    <i class="bx bx-dollar-circle me-2"></i>
                                                    Evolución de Costos Operativos
                                                </h6>
                                                <div class="chart-controls">
                                                    {% if image_data_5 %}
                                                    <div class="chart-control-btn" onclick="downloadChart('{{ image_data_5 }}', 'costos-operativos.png')" title="Descargar">
                                                        <i class="bx bx-download"></i>
                                                    </div>
                                                    <div class="chart-control-btn" onclick="openFullscreen('{{ image_data_5 }}', 'Costos Operativos')" title="Pantalla completa">
                                                        <i class="bx bx-fullscreen"></i>
                                                    </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            {% if image_data_5 %}
                                            <img src="data:image/png;base64,{{ image_data_5 }}" 
                                                class="chart-image" 
                                                alt="Evolución de Costos Operativos"
                                                loading="lazy">
                                            {% else %}
                                            <div class="chart-placeholder">
                                                <i class="bx bx-dollar-circle text-muted" style="font-size: 3rem;"></i>
                                                <p class="text-muted mt-2">Costos operativos</p>
                                                <small class="text-muted">Análisis de gastos operacionales</small>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    
                                    <!-- Gráfico de Producción vs Ventas -->
                                    <div class="col-lg-6 mb-4">
                                        <div class="chart-container">
                                            <div class="chart-header">
                                                <h6 class="chart-title mb-3">
                                                    <i class="bx bx-box me-2"></i>
                                                    Evolución de Producción vs Ventas
                                                </h6>
                                                <div class="chart-controls">
                                                    {% if image_data_6 %}
                                                    <div class="chart-control-btn" onclick="downloadChart('{{ image_data_6 }}', 'produccion-ventas.png')" title="Descargar">
                                                        <i class="bx bx-download"></i>
                                                    </div>
                                                    <div class="chart-control-btn" onclick="openFullscreen('{{ image_data_6 }}', 'Producción vs Ventas')" title="Pantalla completa">
                                                        <i class="bx bx-fullscreen"></i>
                                                    </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            {% if image_data_6 %}
                                            <img src="data:image/png;base64,{{ image_data_6 }}" 
                                                class="chart-image" 
                                                alt="Evolución Producción vs Ventas"
                                                loading="lazy">
                                            {% else %}
                                            <div class="chart-placeholder">
                                                <i class="bx bx-box text-muted" style="font-size: 3rem;"></i>
                                                <p class="text-muted mt-2">Producción vs ventas</p>
                                                <small class="text-muted">Comparación de volúmenes</small>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>

                                    <!-- Gráfico de Capacidad vs Demanda -->
                                    <div class="col-lg-6 mb-4">
                                        <div class="chart-container">
                                            <div class="chart-header">
                                                <h6 class="chart-title mb-3">
                                                    <i class="bx bx-bar-chart me-2"></i>
                                                    Análisis Capacidad vs Demanda
                                                </h6>
                                                <div class="chart-controls">
                                                    {% if image_data_7 %}
                                                    <div class="chart-control-btn" onclick="downloadChart('{{ image_data_7 }}', 'capacidad-demanda.png')" title="Descargar">
                                                        <i class="bx bx-download"></i>
                                                    </div>
                                                    <div class="chart-control-btn" onclick="openFullscreen('{{ image_data_7 }}', 'Capacidad vs Demanda')" title="Pantalla completa">
                                                        <i class="bx bx-fullscreen"></i>
                                                    </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            {% if image_data_7 %}
                                            <img src="data:image/png;base64,{{ image_data_7 }}" 
                                                class="chart-image" 
                                                alt="Análisis Capacidad vs Demanda"
                                                loading="lazy">
                                            {% else %}
                                            <div class="chart-placeholder">
                                                <i class="bx bx-bar-chart text-muted" style="font-size: 3rem;"></i>
                                                <p class="text-muted mt-2">Capacidad vs demanda</p>
                                                <small class="text-muted">Análisis de utilización</small>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div> {% endcomment %}
                                </div>

                                <!-- Gráficos de variables operativas endógenas -->
                                {% if endogenous_charts %}
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <h5 class="mb-3">
                                            <i class="bx bx-cog me-2"></i>
                                            Variables Operativas Endógenas
                                        </h5>
                                    </div>
                                    
                                    {% for chart_name, chart_data in endogenous_charts.items %}
                                        {% if 'TPV' in chart_name or 'EOG' in chart_name or 'CPROD' in chart_name or 'NEPP' in chart_name %}
                                        <div class="col-lg-6 mb-4">
                                            <div class="chart-container">
                                                <div class="chart-header">
                                                    <h6 class="chart-title mb-3">
                                                        {% if 'TPV' in chart_name %}
                                                            <i class="bx bx-package text-primary me-2"></i>Total Productos Vendidos
                                                        {% elif 'EOG' in chart_name %}
                                                            <i class="bx bx-tachometer text-success me-2"></i>Eficiencia Operativa
                                                        {% elif 'CPROD' in chart_name %}
                                                            <i class="bx bx-factory text-info me-2"></i>Capacidad de Producción
                                                        {% elif 'NEPP' in chart_name %}
                                                            <i class="bx bx-group text-warning me-2"></i>Personal en Producción
                                                        {% endif %}
                                                    </h6>
                                                    <div class="chart-controls">
                                                        <div class="chart-control-btn" onclick="downloadChart('{{ chart_data }}', '{{ chart_name }}.png')" title="Descargar">
                                                            <i class="bx bx-download"></i>
                                                        </div>
                                                        <div class="chart-control-btn" onclick="openFullscreen('{{ chart_data }}', '{{ chart_name }}')" title="Pantalla completa">
                                                            <i class="bx bx-fullscreen"></i>
                                                        </div>
                                                    </div>
                                                </div>
                                                <img src="data:image/png;base64,{{ chart_data }}" 
                                                    class="chart-image" 
                                                    alt="{{ chart_name }}"
                                                    loading="lazy">
                                            </div>
                                        </div>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                                {% endif %}

                                <!-- Tabla resumen operativo -->
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <div class="card">
                                            <div class="card-header">
                                                <h5 class="card-title mb-0">
                                                    <i class="bx bx-table me-2"></i>
                                                    Resumen Operativo por Variable
                                                </h5>
                                            </div>
                                            <div class="card-body">
                                                <div class="table-responsive">
                                                    <table class="table table-hover">
                                                        <thead>
                                                            <tr>
                                                                <th>Variable Operativa</th>
                                                                <th>Promedio Diario</th>
                                                                <th>Unidad</th>
                                                                <th>Valor Total</th>
                                                                <th>Tendencia</th>
                                                                <th>Estado</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {% for name_variable, info_variable in totales_acumulativos.items %}
                                                                {% if 'TPV' in name_variable or 'EOG' in name_variable or 'CPROD' in name_variable or 'NEPP' in name_variable or 'CFD' in name_variable or 'CVU' in name_variable %}
                                                                <tr>
                                                                    <td>
                                                                        <strong>
                                                                            {% if name_variable == 'TPV' %}Total Productos Vendidos
                                                                            {% elif name_variable == 'EOG' %}Eficiencia Operativa General
                                                                            {% elif name_variable == 'CPROD' %}Capacidad de Producción
                                                                            {% elif name_variable == 'NEPP' %}Empleados en Producción
                                                                            {% elif name_variable == 'CFD' %}Costo Fijo Diario
                                                                            {% elif name_variable == 'CVU' %}Costo Variable Unitario
                                                                            {% else %}{{ name_variable }}
                                                                            {% endif %}
                                                                        </strong>
                                                                        <br>
                                                                        <small class="text-muted">{{ name_variable }}</small>
                                                                    </td>
                                                                    <td class="fw-bold">
                                                                        {% if info_variable.unit == "BS" %}
                                                                            <span class="text-warning">Bs. {{ info_variable.total|floatformat:2 }}</span>
                                                                        {% elif info_variable.unit == "L" %}
                                                                            <span class="text-primary">{{ info_variable.total|floatformat:0 }} L</span>
                                                                        {% elif "%" in info_variable.unit %}
                                                                            <span class="text-info">{{ info_variable.total|floatformat:3 }}</span>
                                                                        {% else %}
                                                                            {{ info_variable.total|floatformat:2 }}
                                                                        {% endif %}
                                                                    </td>
                                                                    <td>
                                                                        <span class="badge bg-light text-dark">
                                                                            {% if info_variable.unit == "BS" %}Bolivianos
                                                                            {% elif info_variable.unit == "L" %}Litros
                                                                            {% elif info_variable.unit == "%" %}Porcentaje
                                                                            {% elif "Personas" in info_variable.unit %}Empleados
                                                                            {% else %}{{ info_variable.unit }}
                                                                            {% endif %}
                                                                        </span>
                                                                    </td>
                                                                    <td>
                                                                        {% if all_variables_extracted|length > 0 %}
                                                                            {% widthratio info_variable.total 1 all_variables_extracted|length as daily_avg %}
                                                                            {% if info_variable.unit == "BS" %}
                                                                                Bs. {{ daily_avg|floatformat:2 }}
                                                                            {% elif info_variable.unit == "L" %}
                                                                                {{ daily_avg|floatformat:1 }} L
                                                                            {% elif "%" in info_variable.unit %}
                                                                                {{ daily_avg|floatformat:3 }}
                                                                            {% else %}
                                                                                {{ daily_avg|floatformat:2 }}
                                                                            {% endif %}
                                                                        {% else %}
                                                                            N/A
                                                                        {% endif %}
                                                                    </td>
                                                                    <td>
                                                                        {% if info_variable.trend == "increasing" %}
                                                                            <span class="badge bg-success">
                                                                                <i class="bx bx-trending-up me-1"></i>Creciente
                                                                            </span>
                                                                        {% elif info_variable.trend == "decreasing" %}
                                                                            <span class="badge bg-danger">
                                                                                <i class="bx bx-trending-down me-1"></i>Decreciente
                                                                            </span>
                                                                        {% else %}
                                                                            <span class="badge bg-secondary">
                                                                                <i class="bx bx-minus me-1"></i>Estable
                                                                            </span>
                                                                        {% endif %}
                                                                    </td>
                                                                    <td>
                                                                        {% if name_variable == 'EOG' %}
                                                                            {% if info_variable.total > 80 %}
                                                                                <span class="badge bg-success">Excelente</span>
                                                                            {% elif info_variable.total > 60 %}
                                                                                <span class="badge bg-warning">Bueno</span>
                                                                            {% else %}
                                                                                <span class="badge bg-danger">Bajo</span>
                                                                            {% endif %}
                                                                        {% elif name_variable == 'TPV' %}
                                                                            {% if info_variable.trend == "increasing" %}
                                                                                <span class="badge bg-success">Creciendo</span>
                                                                            {% elif info_variable.trend == "decreasing" %}
                                                                                <span class="badge bg-warning">Decreciendo</span>
                                                                            {% else %}
                                                                                <span class="badge bg-info">Estable</span>
                                                                            {% endif %}
                                                                        {% else %}
                                                                            <span class="badge bg-info">Normal</span>
                                                                        {% endif %}
                                                                    </td>
                                                                </tr>
                                                                {% endif %}
                                                            {% empty %}
                                                            <tr>
                                                                <td colspan="6" class="text-center py-4">
                                                                    <i class="bx bx-info-circle display-4 text-muted"></i>
                                                                    <h6 class="mt-2 text-muted">No hay datos operativos disponibles</h6>
                                                                    <small class="text-muted">Los datos se generarán durante el procesamiento.</small>
                                                                </td>
                                                            </tr>
                                                            {% endfor %}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                            </div>
                            <!-- Endogenous Variables Tab -->
                            <div class="tab-pane fade" id="endogenous" role="tabpanel">
                                
                                <!-- Título Principal -->
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <div class="alert alert-primary">
                                            <h4 class="alert-heading mb-3">
                                                <i class="bx bx-trending-up me-2"></i>
                                                Variables Endógenas del Modelo
                                            </h4>
                                            <p class="mb-2">
                                                Las variables endógenas son aquellas que se determinan dentro del modelo de simulación 
                                                basándose en las relaciones matemáticas establecidas y las variables exógenas.
                                            </p>
                                            <small class="text-muted">
                                                Total de variables endógenas procesadas: <strong>{{ totales_acumulativos|length|default:0 }}</strong> | 
                                                Período de simulación: <strong>{{ all_variables_extracted|length|default:0 }} días</strong>
                                            </small>
                                        </div>
                                    </div>
                                </div>

                                <!-- Métricas Resumen -->
                                <div class="row mb-4" id="endogenousMetrics">
                                    <div class="col-md-3">
                                        <div class="card bg-gradient-primary text-white">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between">
                                                    <div>
                                                        <h6 class="text-white-50">Variables Totales</h6>
                                                        <h3 class="mb-0" id="totalVarsCount">{{ totales_acumulativos|length|default:0 }}</h3>
                                                    </div>
                                                    <div class="align-self-center">
                                                        <i class="bx bx-list-ul display-6"></i>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% comment %} <div class="col-md-3">
                                        <div class="card bg-gradient-success text-white">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between">
                                                    <div>
                                                        <h6 class="text-white-50">Variables Financieras</h6>
                                                        <h3 class="mb-0" id="financialVarsCount">0</h3>
                                                    </div>
                                                    <div class="align-self-center">
                                                        <i class="bx bx-dollar display-6"></i>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card bg-gradient-info text-white">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between">
                                                    <div>
                                                        <h6 class="text-white-50">Variables Operativas</h6>
                                                        <h3 class="mb-0" id="operationalVarsCount">0</h3>
                                                    </div>
                                                    <div class="align-self-center">
                                                        <i class="bx bx-cog display-6"></i>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card bg-gradient-warning text-white">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between">
                                                    <div>
                                                        <h6 class="text-white-50">Variables de Calidad</h6>
                                                        <h3 class="mb-0" id="qualityVarsCount">0</h3>
                                                    </div>
                                                    <div class="align-self-center">
                                                        <i class="bx bx-star display-6"></i>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div> {% endcomment %}
                                </div>

                                <!-- Gráficos de Variables Endógenas -->
                                {% if endogenous_charts or chart_images %}
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <div class="card">
                                            <div class="card-header">
                                                <h5 class="card-title mb-0">
                                                    <i class="bx bx-bar-chart me-2"></i>
                                                    Gráficos de Variables Endógenas
                                                </h5>
                                            </div>
                                            <div class="card-body">
                                                <div class="row g-3">
                                                    <!-- Gráficos endógenos específicos -->
                                                    {% for chart_name, chart_data in endogenous_charts.items %}
                                                    <div class="col-lg-6">
                                                        <div class="card chart-card">
                                                            <div class="card-header">
                                                                <h6 class="card-title mb-0">
                                                                    {% if 'IT' in chart_name %}
                                                                        <i class="bx bx-dollar text-success me-2"></i>Ingresos Totales
                                                                    {% elif 'GT' in chart_name %}
                                                                        <i class="bx bx-trending-up text-info me-2"></i>Ganancia Total
                                                                    {% elif 'TG' in chart_name %}
                                                                        <i class="bx bx-receipt text-danger me-2"></i>Total Gastos
                                                                    {% elif 'TPV' in chart_name %}
                                                                        <i class="bx bx-box text-primary me-2"></i>Total Productos Vendidos
                                                                    {% elif 'NSC' in chart_name %}
                                                                        <i class="bx bx-star text-warning me-2"></i>Satisfacción del Cliente
                                                                    {% elif 'EOG' in chart_name %}
                                                                        <i class="bx bx-cog text-secondary me-2"></i>Eficiencia Operativa
                                                                    {% else %}
                                                                        <i class="bx bx-stats me-2"></i>{{ chart_name }}
                                                                    {% endif %}
                                                                </h6>
                                                            </div>
                                                            <div class="card-body">
                                                                <div class="chart-container">
                                                                    {% if chart_data %}
                                                                        <img src="data:image/png;base64,{{ chart_data }}" 
                                                                            class="img-fluid chart-image" 
                                                                            alt="Gráfico {{ chart_name }}"
                                                                            onclick="expandChart('{{ chart_name }}', this.src)">
                                                                    {% else %}
                                                                        <div class="chart-placeholder">
                                                                            <i class="bx bx-bar-chart display-4 text-muted"></i>
                                                                            <p class="text-muted">Gráfico no disponible</p>
                                                                        </div>
                                                                    {% endif %}
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    {% endfor %}

                                                    <!-- Gráficos adicionales del análisis -->
                                                    {% for chart_key, chart_data in chart_images.items %}
                                                        {% if 'endogenous' in chart_key or 'variables' in chart_key %}
                                                        <div class="col-lg-6">
                                                            <div class="card chart-card">
                                                                <div class="card-header">
                                                                    <h6 class="card-title mb-0">
                                                                        <i class="bx bx-line-chart me-2"></i>
                                                                        {% if 'trend' in chart_key %}
                                                                            Tendencias de Variables
                                                                        {% elif 'correlation' in chart_key %}
                                                                            Correlaciones
                                                                        {% elif 'distribution' in chart_key %}
                                                                            Distribuciones
                                                                        {% else %}
                                                                            {{ chart_key|title }}
                                                                        {% endif %}
                                                                    </h6>
                                                                </div>
                                                                <div class="card-body">
                                                                    <div class="chart-container">
                                                                        <img src="data:image/png;base64,{{ chart_data }}" 
                                                                            class="img-fluid chart-image" 
                                                                            alt="Gráfico {{ chart_key }}"
                                                                            onclick="expandChart('{{ chart_key }}', this.src)">
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        {% endif %}
                                                    {% endfor %}

                                                    <!-- Mensaje si no hay gráficos -->
                                                    {% if not endogenous_charts and not chart_images %}
                                                    <div class="col-12">
                                                        <div class="text-center py-5">
                                                            <i class="bx bx-bar-chart display-1 text-muted"></i>
                                                            <h5 class="mt-3 text-muted">No hay gráficos disponibles</h5>
                                                            <p class="text-muted">Los gráficos de variables endógenas se generarán durante el análisis.</p>
                                                        </div>
                                                    </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}

                                <!-- Tabla Resumen de Variables Endógenas -->
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <div class="data-table-container">
                                            <div class="card-header">
                                                <h5 class="card-title mb-0">
                                                    <i class="bx bx-list-ul me-2"></i>
                                                    Resumen Completo de Variables Endógenas
                                                </h5>
                                            </div>
                                            <div class="card-body">
                                                <div class="table-responsive">
                                                    <table class="table table-hover" id="endogenousTable">
                                                        <thead>
                                                            <tr>
                                                                <th style="width: 25%">Variable</th>
                                                                <th style="width: 15%">Promedio Diario</th>
                                                                <th style="width: 12%">Unidad</th>
                                                                <th style="width: 15%">Valor Total</th>
                                                                <th style="width: 10%">Tendencia</th>
                                                                <th style="width: 13%">Rango</th>
                                                                <th style="width: 10%">Acciones</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody id="endogenousTableBody">
                                                            {% for name_variable, info_variable in totales_acumulativos.items %}
                                                            <tr data-variable="{{ name_variable }}" 
                                                                data-category="{% if 'IT' in name_variable or 'GT' in name_variable or 'TG' in name_variable or 'NR' in name_variable %}financial{% elif 'NSC' in name_variable or 'EOG' in name_variable %}quality{% else %}operational{% endif %}"
                                                                data-trend="{{ info_variable.trend|default:'stable' }}">
                                                                <td>
                                                                    <div class="variable-info">
                                                                        <strong>{{ name_variable }}</strong>
                                                                        <br>
                                                                        <small class="text-muted">
                                                                            {% if "IT" in name_variable %}
                                                                                <i class="bx bx-dollar text-success"></i> Ingresos totales del período
                                                                            {% elif "GT" in name_variable %}
                                                                                <i class="bx bx-trending-up text-info"></i> Ganancia acumulada
                                                                            {% elif "TG" in name_variable %}
                                                                                <i class="bx bx-receipt text-danger"></i> Gastos totales
                                                                            {% elif "TPV" in name_variable %}
                                                                                <i class="bx bx-box text-primary"></i> Productos vendidos
                                                                            {% elif "NSC" in name_variable %}
                                                                                <i class="bx bx-star text-warning"></i> Satisfacción del cliente
                                                                            {% elif "EOG" in name_variable %}
                                                                                <i class="bx bx-cog text-secondary"></i> Eficiencia operativa
                                                                            {% elif "NR" in name_variable %}
                                                                                <i class="bx bx-percentage text-info"></i> Nivel de rentabilidad
                                                                            {% else %}
                                                                                <i class="bx bx-stats text-secondary"></i> Variable del modelo
                                                                            {% endif %}
                                                                        </small>
                                                                    </div>
                                                                </td>
                                                                <td class="fw-bold variable-total">
                                                                    {% if info_variable.unit == "BS" %}
                                                                        <span class="text-success">Bs. {{ info_variable.total|floatformat:2 }}</span>
                                                                    {% elif "%" in info_variable.unit %}
                                                                        <span class="text-info">{{ info_variable.total|floatformat:3 }}</span>
                                                                    {% else %}
                                                                        {{ info_variable.total|floatformat:2 }}
                                                                    {% endif %}
                                                                </td>
                                                                <td class="variable-unit">
                                                                    <span class="badge bg-light text-dark">
                                                                        {% if info_variable.unit == "BS" %}Bolivianos
                                                                        {% elif info_variable.unit == "L" %}Litros
                                                                        {% elif info_variable.unit == "CLIENTES" %}Clientes
                                                                        {% elif info_variable.unit == "%" %}Porcentaje
                                                                        {% elif info_variable.unit == "Horas" %}Horas
                                                                        {% elif info_variable.unit == "L/BS" %}L/Bs.
                                                                        {% elif info_variable.unit == "[0.1,0.3,0.5]" %}Factor
                                                                        {% else %}{{ info_variable.unit }}
                                                                        {% endif %}
                                                                    </span>
                                                                </td>
                                                                <td class="variable-average">
                                                                    {% if all_variables_extracted|length > 0 %}
                                                                        {% widthratio info_variable.total 1 all_variables_extracted|length as daily_average %}
                                                                        {% if info_variable.unit == "BS" %}
                                                                            Bs. {{ daily_average|floatformat:2 }}
                                                                        {% elif "%" in info_variable.unit %}
                                                                            {{ daily_average|floatformat:3 }}
                                                                        {% else %}
                                                                            {{ daily_average|floatformat:2 }}
                                                                        {% endif %}
                                                                    {% else %}
                                                                        N/A
                                                                    {% endif %}
                                                                </td>
                                                                <td class="variable-trend">
                                                                    {% if info_variable.trend == "increasing" %}
                                                                        <span class="badge bg-success">
                                                                            <i class="bx bx-trending-up me-1"></i>Creciente
                                                                        </span>
                                                                    {% elif info_variable.trend == "decreasing" %}
                                                                        <span class="badge bg-danger">
                                                                            <i class="bx bx-trending-down me-1"></i>Decreciente
                                                                        </span>
                                                                    {% else %}
                                                                        <span class="badge bg-secondary">
                                                                            <i class="bx bx-minus me-1"></i>Estable
                                                                        </span>
                                                                    {% endif %}
                                                                </td>
                                                                <td class="variable-range">
                                                                    {% if info_variable.min_value and info_variable.max_value %}
                                                                        <small class="text-muted">
                                                                            {{ info_variable.min_value|floatformat:1 }} - {{ info_variable.max_value|floatformat:1 }}
                                                                        </small>
                                                                    {% else %}
                                                                        <small class="text-muted">N/A</small>
                                                                    {% endif %}
                                                                </td>
                                                                <td class="variable-actions">
                                                                    <div class="btn-group" role="group">
                                                                        <button type="button" class="btn btn-sm btn-outline-primary" 
                                                                                onclick="showVariableDetails('{{ name_variable }}')"
                                                                                title="Ver detalles">
                                                                            <i class="bx bx-info-circle"></i>
                                                                        </button>
                                                                    </div>
                                                                </td>
                                                            </tr>
                                                            {% empty %}
                                                            <tr>
                                                                <td colspan="7" class="text-center py-4">
                                                                    <i class="bx bx-info-circle display-4 text-muted"></i>
                                                                    <h5 class="mt-3 text-muted">No hay variables endógenas disponibles</h5>
                                                                    <p class="text-muted">Las variables se generarán durante el procesamiento de la simulación.</p>
                                                                </td>
                                                            </tr>
                                                            {% endfor %}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Modal para expandir gráficos -->
                                <div class="modal fade" id="chartModal" tabindex="-1">
                                    <div class="modal-dialog modal-xl">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="chartModalTitle">Gráfico de Variable</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                            </div>
                                            <div class="modal-body text-center">
                                                <img id="chartModalImage" src="" class="img-fluid" alt="Gráfico expandido">
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Modal para detalles de variable -->
                                <div class="modal fade" id="variableDetailsModal" tabindex="-1">
                                    <div class="modal-dialog modal-lg">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="variableDetailsTitle">Detalles de Variable</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                            </div>
                                            <div class="modal-body" id="variableDetailsBody">
                                                <!-- Contenido dinámico -->
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                            </div>
                            <!-- Demand Tab -->
                            <div class="tab-pane fade" id="demand" role="tabpanel">
                                <div class="row">
                                    <div class="col-md-6">
                                        <!-- Demand Table -->
                                        <div class="data-table-container">
                                            <div class="card-header">
                                                <h5 class="card-title mb-0">
                                                    <i class="bx bx-table me-2"></i>
                                                    Tabla de Demanda Diaria
                                                </h5>
                                            </div>
                                            <div class="card-body">
                                                <div class="table-responsive" style="max-height: 400px;">
                                                    <table class="table table-striped" id="demandTable">
                                                        <thead>
                                                            <tr>
                                                                <th>Día</th>
                                                                <th>Fecha</th>
                                                                <th>Demanda (L)</th>
                                                                <th>Desviación (%)</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {% for simulate in results %}
                                                            <tr>
                                                                <td>{{ forloop.counter }}</td>
                                                                <td>{{ simulate.date|date:"d/m/Y" }}</td>
                                                                <td class="fw-bold">{{ simulate.demand_mean|floatformat:"2" }}</td>
                                                                <td>
                                                                    <span class="badge bg-info">
                                                                        {{ simulate.demand_std_deviation|floatformat:"2" }}%
                                                                    </span>
                                                                </td>
                                                            </tr>
                                                            {% endfor %}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                            <div class="pagination-controls">
                                                <button type="button" class="btn btn-sm btn-outline-primary btn-pagination" id="prevTablePage">
                                                    <i class="bx bx-chevron-left me-1"></i>Anterior
                                                </button>
                                                <span class="flex-grow-1 text-center small text-muted" id="tablePageInfo">
                                                    Página 1
                                                </span>
                                                <button type="button" class="btn btn-sm btn-outline-primary btn-pagination" id="nextTablePage">
                                                    Siguiente<i class="bx bx-chevron-right ms-1"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="chart-container">
                                            <h6 class="mb-3">
                                                <i class="bx bx-line-chart-down me-2"></i>
                                                Análisis de Demanda con Tendencias
                                            </h6>
                                            {% if image_data_simulation %}
                                            <img src="data:image/png;base64,{{ image_data_simulation }}" 
                                                    class="chart-image" 
                                                    alt="Análisis de demanda"
                                                    loading="lazy">
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% if comparison_chart %}
                                    <div class="col-12 mb-4">
                                        <div class="chart-container">
                                            <h6 class="mb-3">
                                                <i class="bx bx-git-compare me-2"></i>
                                                Comparación: Demanda Histórica vs Simulada
                                            </h6>
                                            <div class="chart-controls">
                                                <div class="chart-control-btn" onclick="downloadChart('{{ comparison_chart }}', 'comparacion-demanda.png')" title="Descargar">
                                                    <i class="bx bx-download"></i>
                                                </div>
                                                <div class="chart-control-btn" onclick="openFullscreen('{{ comparison_chart }}', 'Comparación de Demanda')" title="Pantalla completa">
                                                    <i class="bx bx-fullscreen"></i>
                                                </div>
                                            </div>
                                            <img src="data:image/png;base64,{{ comparison_chart }}" 
                                                class="chart-image" 
                                                alt="Comparación de Demanda Histórica vs Simulada"
                                                loading="lazy">
                                        </div>
                                    </div>
                                    {% endif %}
                                    <!-- Three-Line Validation Chart Section -->
                                    {% if has_three_line_chart %}
                                    <div class="row mb-4">
                                        <div class="col-12">
                                            <div class="card shadow-sm">
                                                <div class="card-header bg-success text-white">
                                                    <h4 class="mb-0">
                                                        <i class="fas fa-check-circle"></i> Validación del Modelo: Comparación de Tres Líneas
                                                    </h4>
                                                </div>
                                                <div class="card-body">
                                                    <div class="row">
                                                        <div class="col-lg-9">
                                                            {% if three_line_validation_chart %}
                                                                <img src="data:image/png;base64,{{ three_line_validation_chart }}" 
                                                                    class="img-fluid rounded shadow" 
                                                                    alt="Gráfico de Validación de Tres Líneas">
                                                            {% endif %}
                                                        </div>
                                                        <div class="col-lg-3">
                                                            <div class="validation-metrics">
                                                                <h5>Métricas de Validación</h5>
                                                                
                                                                {% if three_line_validation_metrics.historical_vs_simulated %}
                                                                <div class="metric-card mb-3 p-3 bg-light rounded">
                                                                    <h6 class="text-muted">Histórico vs Simulado</h6>
                                                                    {% comment %} <p class="mb-1">MAPE: <strong class="text-{{ three_line_validation_metrics.historical_vs_simulated.mape < 10|yesno:'success,warning' }}">{{ three_line_validation_metrics.historical_vs_simulated.mape }}%</strong></p> {% endcomment %}
                                                                    <p class="mb-1">RMSE: <strong>{{ three_line_validation_metrics.historical_vs_simulated.rmse|floatformat:2 }}</strong></p>
                                                                    {% comment %} <p class="mb-0">Precisión: <strong class="text-{{ three_line_validation_metrics.historical_vs_simulated.accuracy_level == 'Excelente'|yesno:'success,info' }}">{{ three_line_validation_metrics.historical_vs_simulated.accuracy_level }}</strong></p> {% endcomment %}
                                                                </div>
                                                                {% endif %}
                                                                
                                                                {% if three_line_validation_metrics.simulated_vs_projected %}
                                                                <div class="metric-card mb-3 p-3 bg-light rounded">
                                                                    <h6 class="text-muted">Simulado vs Proyectado</h6>
                                                                    <p class="mb-1">MAPE: <strong>{{ three_line_validation_metrics.simulated_vs_projected.mape }}%</strong></p>
                                                                    <p class="mb-0">Alineación: <strong>{{ three_line_validation_metrics.simulated_vs_projected.alignment }}</strong></p>
                                                                </div>
                                                                {% endif %}
                                                                
                                                                {% if three_line_validation_metrics.overall_validation %}
                                                                <div class="metric-card p-3 bg-primary text-white rounded">
                                                                    <h6>Validación General</h6>
                                                                    <h3 class="mb-1">{{ three_line_validation_metrics.overall_validation.score|floatformat:1 }}%</h3>
                                                                    <p class="mb-0">{{ three_line_validation_metrics.overall_validation.status }}</p>
                                                                </div>
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                    </div>
                                                    
                                                    <div class="mt-3 p-3 bg-light rounded">
                                                        <h6>Interpretación del Gráfico:</h6>
                                                        <ul class="mb-0">
                                                            <li><span style="color: blue; font-weight: bold;">Línea Azul</span>: Demanda Real Histórica</li>
                                                            <li><span style="color: red; font-weight: bold;">Línea Roja</span>: Demanda Proyectada (tendencia futura)</li>
                                                            <li><span style="color: green; font-weight: bold;">Línea Verde (punteada)</span>: Demanda Simulada (validación del modelo)</li>
                                                        </ul>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            <!-- Statistical Analysis Tab -->
<!-- TAB DE ANÁLISIS ESTADÍSTICO COMPLETO -->
<!-- TAB DE ANÁLISIS ESTADÍSTICO COMPLETO -->
<!-- Reemplazar el contenido del div con id="analysis" -->

<div class="tab-pane fade" id="analysis" role="tabpanel">
    
    <!-- Header del análisis estadístico -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="analysis-header">
                <h2 class="analysis-title">
                    <i class="bx bx-math me-3"></i>
                    Análisis Estadístico Avanzado
                </h2>
                <p class="analysis-subtitle">
                    Evaluación estadística completa del modelo de simulación, comparación de distribuciones, 
                    métricas de desempeño y validación de precisión predictiva.
                </p>
                <div class="analysis-badges">
                    <span class="badge bg-primary">
                        <i class="bx bx-data me-1"></i>
                        {{ all_variables_extracted|length|default:0 }} días analizados
                    </span>
                    {% if simulation_instance.fk_fdp %}
                    <span class="badge bg-success">
                        <i class="bx bx-chart me-1"></i>
                        Distribución: {{ simulation_instance.fk_fdp.name }}
                    </span>
                    {% endif %}
                    {% if performance_metrics.mape %}
                    <span class="badge bg-info">
                        <i class="bx bx-target-lock me-1"></i>
                        MAPE: {{ performance_metrics.mape|floatformat:2 }}%
                    </span>
                    {% endif %}
                    {% if charts_available_count %}
                    <span class="badge bg-warning">
                        <i class="bx bx-bar-chart me-1"></i>
                        {{ charts_available_count }} gráficos disponibles
                    </span>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard de Performance Principal -->
    {% if statistical_charts.performance_dashboard %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="chart-container">
                <div class="chart-header">
                    <h5 class="chart-title mb-3">
                        <i class="bx bx-dashboard me-2"></i>
                        Dashboard de Performance del Modelo
                    </h5>
                    <div class="chart-controls">
                        <div class="chart-control-btn" onclick="downloadChart('{{ statistical_charts.performance_dashboard }}', 'dashboard-performance.png')" title="Descargar">
                            <i class="bx bx-download"></i>
                        </div>
                        <div class="chart-control-btn" onclick="openFullscreen('{{ statistical_charts.performance_dashboard }}', 'Dashboard de Performance')" title="Pantalla completa">
                            <i class="bx bx-fullscreen"></i>
                        </div>
                    </div>
                </div>
                <div class="chart-content">
                    <img src="data:image/png;base64,{{ statistical_charts.performance_dashboard }}" 
                        class="chart-image" 
                        alt="Dashboard de Performance del Modelo"
                        loading="lazy">
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Métricas de Performance Detalladas -->
    {% if performance_metrics %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="metric-card model-performance">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bx bx-target-lock me-2"></i>
                        Métricas de Desempeño del Modelo
                    </h5>
                    <div class="card-subtitle">
                        Indicadores cuantitativos de precisión y calidad del modelo de simulación
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-lg-2 col-md-4 col-sm-6">
                            <div class="performance-metric">
                                <div class="metric-icon">
                                    <i class="bx bx-percentage"></i>
                                </div>
                                <div class="metric-content">
                                    <h6 class="metric-label">MAPE</h6>
                                    <h4 class="metric-value text-{% if performance_metrics.mape < 10 %}success{% elif performance_metrics.mape < 20 %}warning{% else %}danger{% endif %}">
                                        {{ performance_metrics.mape|floatformat:2 }}%
                                    </h4>
                                    <small class="text-muted">{{ performance_metrics.accuracy_level|default:"Calculando..." }}</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-2 col-md-4 col-sm-6">
                            <div class="performance-metric">
                                <div class="metric-icon">
                                    <i class="bx bx-check-square"></i>
                                </div>
                                <div class="metric-content">
                                    <h6 class="metric-label">R²</h6>
                                    <h4 class="metric-value text-{% if performance_metrics.r_squared > 0.8 %}success{% elif performance_metrics.r_squared > 0.6 %}warning{% else %}danger{% endif %}">
                                        {{ performance_metrics.r_squared|floatformat:3 }}
                                    </h4>
                                    <small class="text-muted">{{ performance_metrics.model_quality|default:"Evaluando..." }}</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-2 col-md-4 col-sm-6">
                            <div class="performance-metric">
                                <div class="metric-icon">
                                    <i class="bx bx-error"></i>
                                </div>
                                <div class="metric-content">
                                    <h6 class="metric-label">RMSE</h6>
                                    <h4 class="metric-value text-info">
                                        {{ performance_metrics.rmse|floatformat:2 }}
                                    </h4>
                                    <small class="text-muted">Error cuadrático medio</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-2 col-md-4 col-sm-6">
                            <div class="performance-metric">
                                <div class="metric-icon">
                                    <i class="bx bx-trending-down"></i>
                                </div>
                                <div class="metric-content">
                                    <h6 class="metric-label">MAE</h6>
                                    <h4 class="metric-value text-warning">
                                        {{ performance_metrics.mae|floatformat:2 }}
                                    </h4>
                                    <small class="text-muted">Error absoluto medio</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-2 col-md-4 col-sm-6">
                            <div class="performance-metric">
                                <div class="metric-icon">
                                    <i class="bx bx-award"></i>
                                </div>
                                <div class="metric-content">
                                    <h6 class="metric-label">Nash-Sutcliffe</h6>
                                    <h4 class="metric-value text-primary">
                                        {{ performance_metrics.nash_sutcliffe|floatformat:3 }}
                                    </h4>
                                    <small class="text-muted">Eficiencia del modelo</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-2 col-md-4 col-sm-6">
                            <div class="performance-metric">
                                <div class="metric-icon">
                                    <i class="bx bx-stats"></i>
                                </div>
                                <div class="metric-content">
                                    <h6 class="metric-label">Willmott-d</h6>
                                    <h4 class="metric-value text-secondary">
                                        {{ performance_metrics.willmott_d|floatformat:3 }}
                                    </h4>
                                    <small class="text-muted">Índice de concordancia</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Gráficos Estadísticos Principales -->
    <div class="row mb-4">
        <div class="col-12">
            <h5 class="mb-3">
                <i class="bx bx-bar-chart me-2"></i>
                Análisis de Distribución y Correlación
            </h5>
        </div>
        
        <!-- Histograma con distribución -->
        {% if statistical_charts.histogram %}
        <div class="col-lg-6 mb-4">
            <div class="chart-container">
                <div class="chart-header">
                    <h6 class="chart-title mb-3">
                        <i class="bx bx-bar-chart me-2"></i>
                        Distribución de la Demanda Simulada
                    </h6>
                    <div class="chart-controls">
                        <div class="chart-control-btn" onclick="downloadChart('{{ statistical_charts.histogram }}', 'distribucion-demanda.png')" title="Descargar">
                            <i class="bx bx-download"></i>
                        </div>
                        <div class="chart-control-btn" onclick="openFullscreen('{{ statistical_charts.histogram }}', 'Distribución de Demanda')" title="Pantalla completa">
                            <i class="bx bx-fullscreen"></i>
                        </div>
                    </div>
                </div>
                <div class="chart-content">
                    <img src="data:image/png;base64,{{ statistical_charts.histogram }}" 
                        class="chart-image" 
                        alt="Distribución de la Demanda"
                        loading="lazy">
                </div>
                {% if distribution_analysis.basic_stats %}
                <div class="chart-footer">
                    <small class="text-muted">
                        Media: {{ distribution_analysis.basic_stats.mean|floatformat:2 }} | 
                        Std: {{ distribution_analysis.basic_stats.std|floatformat:2 }} | 
                        {% if distribution_analysis.normality_test.is_normal %}
                            <span class="text-success">Distribución Normal</span>
                        {% else %}
                            <span class="text-warning">No Normal</span>
                        {% endif %}
                    </small>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
        
        <!-- Box plot comparativo -->
        {% if statistical_charts.boxplot %}
        <div class="col-lg-6 mb-4">
            <div class="chart-container">
                <div class="chart-header">
                    <h6 class="chart-title mb-3">
                        <i class="bx bx-box me-2"></i>
                        Comparación de Distribuciones
                    </h6>
                    <div class="chart-controls">
                        <div class="chart-control-btn" onclick="downloadChart('{{ statistical_charts.boxplot }}', 'boxplot-comparativo.png')" title="Descargar">
                            <i class="bx bx-download"></i>
                        </div>
                        <div class="chart-control-btn" onclick="openFullscreen('{{ statistical_charts.boxplot }}', 'Box Plot Comparativo')" title="Pantalla completa">
                            <i class="bx bx-fullscreen"></i>
                        </div>
                    </div>
                </div>
                <div class="chart-content">
                    <img src="data:image/png;base64,{{ statistical_charts.boxplot }}" 
                        class="chart-image" 
                        alt="Box Plot Comparativo"
                        loading="lazy">
                </div>
                <div class="chart-footer">
                    <small class="text-muted">
                        Comparación de distribuciones entre demanda histórica y simulada
                    </small>
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- Scatter plot de correlación -->
        {% if statistical_charts.scatter %}
        <div class="col-lg-6 mb-4">
            <div class="chart-container">
                <div class="chart-header">
                    <h6 class="chart-title mb-3">
                        <i class="bx bx-scatter-chart me-2"></i>
                        Correlación Histórico vs Simulado
                    </h6>
                    <div class="chart-controls">
                        <div class="chart-control-btn" onclick="downloadChart('{{ statistical_charts.scatter }}', 'correlacion-scatter.png')" title="Descargar">
                            <i class="bx bx-download"></i>
                        </div>
                        <div class="chart-control-btn" onclick="openFullscreen('{{ statistical_charts.scatter }}', 'Gráfico de Correlación')" title="Pantalla completa">
                            <i class="bx bx-fullscreen"></i>
                        </div>
                    </div>
                </div>
                <div class="chart-content">
                    <img src="data:image/png;base64,{{ statistical_charts.scatter }}" 
                        class="chart-image" 
                        alt="Gráfico de Correlación"
                        loading="lazy">
                </div>
                {% if performance_metrics.r_squared %}
                <div class="chart-footer">
                    <small class="text-muted">
                        R² = {{ performance_metrics.r_squared|floatformat:3 }} | 
                        Correlación: {{ statistical_tests.correlation.strength|default:"Calculando..." }}
                    </small>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
        
        <!-- Gráfico de residuos -->
        {% if statistical_charts.residuals %}
        <div class="col-lg-6 mb-4">
            <div class="chart-container">
                <div class="chart-header">
                    <h6 class="chart-title mb-3">
                        <i class="bx bx-line-chart me-2"></i>
                        Análisis de Residuos
                    </h6>
                    <div class="chart-controls">
                        <div class="chart-control-btn" onclick="downloadChart('{{ statistical_charts.residuals }}', 'analisis-residuos.png')" title="Descargar">
                            <i class="bx bx-download"></i>
                        </div>
                        <div class="chart-control-btn" onclick="openFullscreen('{{ statistical_charts.residuals }}', 'Análisis de Residuos')" title="Pantalla completa">
                            <i class="bx bx-fullscreen"></i>
                        </div>
                    </div>
                </div>
                <div class="chart-content">
                    <img src="data:image/png;base64,{{ statistical_charts.residuals }}" 
                        class="chart-image" 
                        alt="Análisis de Residuos"
                        loading="lazy">
                </div>
                <div class="chart-footer">
                    <small class="text-muted">
                        Distribución de errores para evaluar la calidad del ajuste del modelo
                    </small>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Análisis de Normalidad y Autocorrelación -->
    <div class="row mb-4">
        <div class="col-12">
            <h5 class="mb-3">
                <i class="bx bx-pulse me-2"></i>
                Análisis de Normalidad y Patrones Temporales
            </h5>
        </div>
        
        <!-- Q-Q Plot -->
        {% if statistical_charts.qq_plot %}
        <div class="col-lg-6 mb-4">
            <div class="chart-container">
                <div class="chart-header">
                    <h6 class="chart-title mb-3">
                        <i class="bx bx-stats me-2"></i>
                        Prueba de Normalidad (Q-Q Plot)
                    </h6>
                    <div class="chart-controls">
                        <div class="chart-control-btn" onclick="downloadChart('{{ statistical_charts.qq_plot }}', 'qq-plot-normalidad.png')" title="Descargar">
                            <i class="bx bx-download"></i>
                        </div>
                        <div class="chart-control-btn" onclick="openFullscreen('{{ statistical_charts.qq_plot }}', 'Q-Q Plot')" title="Pantalla completa">
                            <i class="bx bx-fullscreen"></i>
                        </div>
                    </div>
                </div>
                <div class="chart-content">
                    <img src="data:image/png;base64,{{ statistical_charts.qq_plot }}" 
                        class="chart-image" 
                        alt="Q-Q Plot de Normalidad"
                        loading="lazy">
                </div>
                {% if distribution_analysis.normality_test %}
                <div class="chart-footer">
                    <small class="text-muted">
                        Shapiro-Wilk: p = {{ distribution_analysis.normality_test.shapiro_p|floatformat:4 }} | 
                        {% if distribution_analysis.normality_test.is_normal %}
                            <span class="text-success">Los datos siguen distribución normal</span>
                        {% else %}
                            <span class="text-warning">Los datos no siguen distribución normal</span>
                        {% endif %}
                    </small>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
        
        <!-- Autocorrelación -->
        {% if statistical_charts.autocorrelation %}
        <div class="col-lg-6 mb-4">
            <div class="chart-container">
                <div class="chart-header">
                    <h6 class="chart-title mb-3">
                        <i class="bx bx-pulse me-2"></i>
                        Función de Autocorrelación
                    </h6>
                    <div class="chart-controls">
                        <div class="chart-control-btn" onclick="downloadChart('{{ statistical_charts.autocorrelation }}', 'autocorrelacion.png')" title="Descargar">
                            <i class="bx bx-download"></i>
                        </div>
                        <div class="chart-control-btn" onclick="openFullscreen('{{ statistical_charts.autocorrelation }}', 'Autocorrelación')" title="Pantalla completa">
                            <i class="bx bx-fullscreen"></i>
                        </div>
                    </div>
                </div>
                <div class="chart-content">
                    <img src="data:image/png;base64,{{ statistical_charts.autocorrelation }}" 
                        class="chart-image" 
                        alt="Función de Autocorrelación"
                        loading="lazy">
                </div>
                <div class="chart-footer">
                    <small class="text-muted">
                        Análisis de dependencias temporales en la serie de demanda simulada
                    </small>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Mapa de correlaciones entre variables -->
    {% if statistical_charts.correlation_heatmap %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="chart-container">
                <div class="chart-header">
                    <h5 class="chart-title mb-3">
                        <i class="bx bx-grid me-2"></i>
                        Matriz de Correlación entre Variables Endógenas
                    </h5>
                    <div class="chart-controls">
                        <div class="chart-control-btn" onclick="downloadChart('{{ statistical_charts.correlation_heatmap }}', 'correlaciones-variables.png')" title="Descargar">
                            <i class="bx bx-download"></i>
                        </div>
                        <div class="chart-control-btn" onclick="openFullscreen('{{ statistical_charts.correlation_heatmap }}', 'Matriz de Correlación')" title="Pantalla completa">
                            <i class="bx bx-fullscreen"></i>
                        </div>
                    </div>
                </div>
                <div class="chart-content">
                    <img src="data:image/png;base64,{{ statistical_charts.correlation_heatmap }}" 
                        class="chart-image" 
                        alt="Matriz de Correlación entre Variables"
                        loading="lazy">
                </div>
                {% if correlation_analysis.significant_correlations %}
                <div class="chart-footer">
                    <small class="text-muted">
                        Correlaciones significativas detectadas: {{ correlation_analysis.significant_correlations|length }}
                    </small>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Pruebas Estadísticas -->
    {% if statistical_tests %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="statistical-tests-card">
                <h5 class="tests-title">
                    <i class="bx bx-test-tube me-2"></i>
                    Pruebas Estadísticas de Validación
                </h5>
                <div class="tests-grid">
                    <div class="row">
                        {% if statistical_tests.t_test %}
                        <div class="col-md-3">
                            <div class="test-result">
                                <h6 class="test-name">Prueba t (Medias)</h6>
                                <div class="test-value">
                                    <span class="badge {% if statistical_tests.t_test.means_equal %}bg-success{% else %}bg-warning{% endif %}">
                                        {% if statistical_tests.t_test.means_equal %}Iguales{% else %}Diferentes{% endif %}
                                    </span>
                                    <small class="d-block">p-value: {{ statistical_tests.t_test.p_value|floatformat:4 }}</small>
                                    <small class="text-muted">{{ statistical_tests.t_test.interpretation }}</small>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if statistical_tests.f_test %}
                        <div class="col-md-3">
                            <div class="test-result">
                                <h6 class="test-name">Prueba F (Varianzas)</h6>
                                <div class="test-value">
                                    <span class="badge {% if statistical_tests.f_test.variances_equal %}bg-success{% else %}bg-warning{% endif %}">
                                        {% if statistical_tests.f_test.variances_equal %}Homogéneas{% else %}Heterogéneas{% endif %}
                                    </span>
                                    <small class="d-block">p-value: {{ statistical_tests.f_test.p_value|floatformat:4 }}</small>
                                    <small class="text-muted">{{ statistical_tests.f_test.interpretation }}</small>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if statistical_tests.ks_test %}
                        <div class="col-md-3">
                            <div class="test-result">
                                <h6 class="test-name">Kolmogorov-Smirnov</h6>
                                <div class="test-value">
                                    <span class="badge {% if statistical_tests.ks_test.distributions_equal %}bg-success{% else %}bg-warning{% endif %}">
                                        {% if statistical_tests.ks_test.distributions_equal %}Similares{% else %}Diferentes{% endif %}
                                    </span>
                                    <small class="d-block">p-value: {{ statistical_tests.ks_test.p_value|floatformat:4 }}</small>
                                    <small class="text-muted">{{ statistical_tests.ks_test.interpretation }}</small>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if statistical_tests.correlation %}
                        <div class="col-md-3">
                            <div class="test-result">
                                <h6 class="test-name">Correlación de Pearson</h6>
                                <div class="test-value">
                                    <span class="badge {% if statistical_tests.correlation.is_significant %}bg-success{% else %}bg-secondary{% endif %}">
                                        {{ statistical_tests.correlation.strength }}
                                    </span>
                                    <small class="d-block">r = {{ statistical_tests.correlation.coefficient|floatformat:3 }}</small>
                                    <small class="text-muted">{{ statistical_tests.correlation.interpretation }}</small>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Correlaciones Significativas -->
    {% if correlation_analysis.significant_correlations %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bx bx-link me-2"></i>
                        Correlaciones Significativas entre Variables
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for correlation in correlation_analysis.significant_correlations %}
                        <div class="col-md-6 mb-3">
                            <div class="correlation-item">
                                <div class="correlation-header">
                                    <strong>{{ correlation.var1 }} ↔ {{ correlation.var2 }}</strong>
                                    <span class="badge bg-{% if correlation.coefficient > 0 %}success{% else %}danger{% endif %} ms-2">
                                        {{ correlation.direction }}
                                    </span>
                                </div>
                                <div class="correlation-details">
                                    <small class="text-muted">
                                        Coeficiente: {{ correlation.coefficient|floatformat:3 }} | 
                                        Fuerza: {{ correlation.strength }}
                                    </small>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Análisis de Tendencias -->
    {% if trend_analysis %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bx bx-trending-up me-2"></i>
                        Análisis de Tendencias Temporales
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="trend-metric">
                                <h6 class="trend-label">Tipo de Tendencia</h6>
                                <div class="trend-value">
                                    <span class="badge bg-{% if trend_analysis.trend_type == 'Creciente' %}success{% elif trend_analysis.trend_type == 'Decreciente' %}danger{% else %}secondary{% endif %}">
                                        {{ trend_analysis.trend_type }}
                                    </span>
                                </div>
                                <small class="text-muted">{{ trend_analysis.trend_strength }} intensidad</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="trend-metric">
                                <h6 class="trend-label">Pendiente</h6>
                                <div class="trend-value">
                                    <strong class="text-{% if trend_analysis.slope > 0 %}success{% elif trend_analysis.slope < 0 %}danger{% else %}secondary{% endif %}">
                                        {{ trend_analysis.slope|floatformat:4 }}
                                    </strong>
                                </div>
                                <small class="text-muted">Cambio por período</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="trend-metric">
                                <h6 class="trend-label">Significancia</h6>
                                <div class="trend-value">
                                    <span class="badge bg-{% if trend_analysis.has_significant_trend %}success{% else %}secondary{% endif %}">
                                        {% if trend_analysis.has_significant_trend %}Significativa{% else %}No Significativa{% endif %}
                                    </span>
                                </div>
                                <small class="text-muted">R² = {{ trend_analysis.r_squared|floatformat:3 }}</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Interpretación y Recomendaciones Estadísticas -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bx bx-brain me-2"></i>
                        Interpretación Estadística y Recomendaciones
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-primary">Calidad del Modelo</h6>
                            {% if performance_metrics %}
                            <div class="interpretation-section">
                                <p><strong>Nivel de Precisión:</strong> {{ performance_metrics.accuracy_level }}</p>
                                <p><strong>Calidad del Ajuste:</strong> {{ performance_metrics.model_quality }}</p>
                                
                                {% if performance_metrics.mape < 10 %}
                                <div class="alert alert-success">
                                    <i class="bx bx-check-circle me-2"></i>
                                    El modelo muestra <strong>excelente precisión</strong> con MAPE < 10%. 
                                    Las predicciones son altamente confiables.
                                </div>
                                {% elif performance_metrics.mape < 20 %}
                                <div class="alert alert-warning">
                                    <i class="bx bx-error-circle me-2"></i>
                                    El modelo tiene <strong>buena precisión</strong> pero puede mejorarse. 
                                    Considerar refinamiento de parámetros.
                                </div>
                                {% else %}
                                <div class="alert alert-danger">
                                    <i class="bx bx-x-circle me-2"></i>
                                    El modelo requiere <strong>calibración significativa</strong>. 
                                    Revisar estructura del modelo y datos de entrada.
                                </div>
                                {% endif %}
                            </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6">
                            <h6 class="text-success">Recomendaciones</h6>
                            <div class="recommendations-section">
                                {% if performance_metrics.r_squared > 0.8 %}
                                <div class="recommendation-item">
                                    <i class="bx bx-check text-success me-2"></i>
                                    <span>Excelente capacidad explicativa del modelo (R² > 0.8)</span>
                                </div>
                                {% else %}
                                <div class="recommendation-item">
                                    <i class="bx bx-error text-warning me-2"></i>
                                    <span>Considerar incluir variables adicionales para mejorar R²</span>
                                </div>
                                {% endif %}
                                
                                {% if statistical_tests.correlation.is_significant %}
                                <div class="recommendation-item">
                                    <i class="bx bx-check text-success me-2"></i>
                                    <span>Correlación significativa entre histórico y simulado</span>
                                </div>
                                {% else %}
                                <div class="recommendation-item">
                                    <i class="bx bx-error text-warning me-2"></i>
                                    <span>Revisar patrones temporales y ajustar modelo</span>
                                </div>
                                {% endif %}
                                
                                {% if distribution_analysis.normality_test.is_normal %}
                                <div class="recommendation-item">
                                    <i class="bx bx-check text-success me-2"></i>
                                    <span>Distribución normal: métodos estadísticos estándar aplicables</span>
                                </div>
                                {% else %}
                                <div class="recommendation-item">
                                    <i class="bx bx-info text-info me-2"></i>
                                    <span>Distribución no normal: considerar transformaciones de datos</span>
                                </div>
                                {% endif %}
                                
                                {% if trend_analysis.has_significant_trend %}
                                <div class="recommendation-item">
                                    <i class="bx bx-trending-up text-info me-2"></i>
                                    <span>Tendencia {{ trend_analysis.trend_type|lower }} detectada: incluir en análisis futuro</span>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
</div>

                            
                            <!-- Validation Tab -->
                            <div class="tab-pane fade" id="validation" role="tabpanel">
                                
                                <!-- Resumen de Validación -->
                                <div class="row mb-4">
                                    <div class="col-12">
                                        {% if validation_summary and validation_summary.success_rate %}
                                            <div class="alert {% if validation_summary.success_rate >= 80 %}alert-success{% elif validation_summary.success_rate >= 60 %}alert-warning{% else %}alert-danger{% endif %}">
                                                <h5 class="alert-heading">
                                                    <i class="bx {% if validation_summary.success_rate >= 80 %}bx-check-circle{% elif validation_summary.success_rate >= 60 %}bx-error-circle{% else %}bx-x-circle{% endif %} me-2"></i>
                                                    Estado General de Validación del Modelo
                                                </h5>
                                                <hr>
                                                <div class="row text-center">
                                                    <div class="col-md-3">
                                                        <div class="validation-kpi">
                                                            <div class="validation-kpi-value {% if validation_summary.success_rate > 80 %}text-success{% elif validation_summary.success_rate > 60 %}text-warning{% else %}text-danger{% endif %}">
                                                                {{ validation_summary.success_rate|floatformat:1 }}%
                                                            </div>
                                                            <div class="validation-kpi-label">Tasa de Éxito Global</div>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <div class="validation-kpi">
                                                            <div class="validation-kpi-value {% if validation_summary.avg_mape < 10 %}text-success{% elif validation_summary.avg_mape < 20 %}text-warning{% else %}text-danger{% endif %}">
                                                                {{ validation_summary.avg_mape|default:"N/A"|floatformat:2 }}%
                                                            </div>
                                                            <div class="validation-kpi-label">Error Promedio (MAPE)</div>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <div class="validation-kpi">
                                                            <div class="validation-kpi-value text-success">
                                                                {{ validation_summary.precise_count|default:0 }}
                                                            </div>
                                                            <div class="validation-kpi-label">Días Precisos (&lt;10%)</div>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <div class="validation-kpi">
                                                            <div class="validation-kpi-value text-danger">
                                                                {{ validation_summary.inaccurate_count|default:0 }}
                                                            </div>
                                                            <div class="validation-kpi-label">Días Inexactos (&gt;20%)</div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        {% else %}
                                            <div class="alert alert-info">
                                                <h5 class="alert-heading">
                                                    <i class="bx bx-info-circle me-2"></i>
                                                    Validación del Modelo en Proceso
                                                </h5>
                                                <p class="mb-0">
                                                    El sistema está procesando la validación del modelo. Los resultados se mostrarán cuando estén disponibles.
                                                </p>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>

                                <!-- Gráfico de Distribución de Precisión -->
                                {% if validation_summary and validation_summary.success_rate %}
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <div class="chart-container">
                                            <h6 class="mb-3">
                                                <i class="bx bx-bar-chart-alt-2 me-2"></i>
                                                Distribución de Precisión - Error Porcentual por Día
                                            </h6>
                                            <div class="chart-controls">
                                                <div class="chart-control-btn" onclick="downloadValidationChart()" title="Descargar">
                                                    <i class="bx bx-download"></i>
                                                </div>
                                                <div class="chart-control-btn" onclick="toggleValidationChartType()" title="Cambiar tipo de gráfico">
                                                    <i class="bx bx-refresh"></i>
                                                </div>
                                            </div>
                                            <div style="position: relative; height: 400px;">
                                                <canvas id="validationPrecisionChart"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}

                                <!-- Métricas de Error Detalladas -->
                                <div class="row mb-4">
                                    <div class="col-md-6">
                                        <div class="metric-card">
                                            <div class="card-header">
                                                <h5 class="card-title mb-0">
                                                    <i class="bx bx-calculator me-2"></i>
                                                    Métricas de Error del Modelo
                                                </h5>
                                            </div>
                                            <div class="card-body">
                                                <div class="row">
                                                    <div class="col-6">
                                                        <div class="text-center p-3 border rounded mb-3">
                                                            <h6 class="text-muted mb-1">MAE</h6>
                                                            <h4 class="mb-0">{{ validation_metrics.mae|default:"N/A"|floatformat:2 }} L</h4>
                                                            <small class="text-muted">Error Absoluto Medio</small>
                                                        </div>
                                                    </div>
                                                    <div class="col-6">
                                                        <div class="text-center p-3 border rounded mb-3">
                                                            <h6 class="text-muted mb-1">MAPE</h6>
                                                            <h4 class="mb-0 {% if validation_metrics.mape < 10 %}text-success{% elif validation_metrics.mape < 20 %}text-warning{% else %}text-danger{% endif %}">
                                                                {{ validation_metrics.mape|default:"N/A"|floatformat:2 }}%
                                                            </h4>
                                                            <small class="text-muted">Error Porcentual Medio</small>
                                                        </div>
                                                    </div>
                                                    <div class="col-6">
                                                        <div class="text-center p-3 border rounded">
                                                            <h6 class="text-muted mb-1">RMSE</h6>
                                                            <h4 class="mb-0">{{ validation_metrics.rmse|default:"N/A"|floatformat:2 }} L</h4>
                                                            <small class="text-muted">Error Cuadrático Medio</small>
                                                        </div>
                                                    </div>
                                                    <div class="col-6">
                                                        <div class="text-center p-3 border rounded">
                                                            <h6 class="text-muted mb-1">R²</h6>
                                                            <h4 class="mb-0 {% if validation_metrics.r_squared > 0.8 %}text-success{% elif validation_metrics.r_squared > 0.6 %}text-warning{% else %}text-danger{% endif %}">
                                                                {{ validation_metrics.r_squared|default:"N/A"|floatformat:3 }}
                                                            </h4>
                                                            <small class="text-muted">Coeficiente de Determinación</small>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <div class="metric-card">
                                            <div class="card-header">
                                                <h5 class="card-title mb-0">
                                                    <i class="bx bx-pie-chart-alt-2 me-2"></i>
                                                    Resumen de Precisión por Categoría
                                                </h5>
                                            </div>
                                            <div class="card-body">
                                                <canvas id="validationSummaryChart" height="200"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Three-Line Validation Chart Section -->
                                {% if has_three_line_chart and three_line_validation_chart %}
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <div class="card shadow-sm">
                                            <div class="card-header bg-success text-white">
                                                <h4 class="mb-0">
                                                    <i class="bx bx-check-circle me-2"></i> 
                                                    Validación del Modelo: Comparación de Tres Líneas
                                                </h4>
                                            </div>
                                            <div class="card-body">
                                                <div class="row">
                                                    <div class="col-lg-9">
                                                        <img src="data:image/png;base64,{{ three_line_validation_chart }}" 
                                                            class="img-fluid rounded shadow" 
                                                            alt="Gráfico de Validación de Tres Líneas">
                                                    </div>
                                                    <div class="col-lg-3">
                                                        <div class="validation-metrics">
                                                            <h5>Métricas de Validación</h5>
                                                            
                                                            {% if three_line_validation_metrics.historical_vs_simulated %}
                                                            <div class="metric-card mb-3 p-3 bg-light rounded">
                                                                <h6 class="text-muted">Histórico vs Simulado</h6>
                                                                <p class="mb-1">MAPE: <strong class="text-{% if three_line_validation_metrics.historical_vs_simulated.mape < 10 %}success{% else %}warning{% endif %}">{{ three_line_validation_metrics.historical_vs_simulated.mape|floatformat:2 }}%</strong></p>
                                                                <p class="mb-0">Precisión: <strong class="text-{% if three_line_validation_metrics.historical_vs_simulated.accuracy_level == 'Excelente' %}success{% else %}info{% endif %}">{{ three_line_validation_metrics.historical_vs_simulated.accuracy_level|default:"Buena" }}</strong></p>
                                                            </div>
                                                            {% endif %}
                                                            
                                                            {% if three_line_validation_metrics.overall_validation %}
                                                            <div class="metric-card p-3 bg-primary text-white rounded">
                                                                <h6>Validación General</h6>
                                                                <h3 class="mb-1">{{ three_line_validation_metrics.overall_validation.score|default:85|floatformat:1 }}%</h3>
                                                                <p class="mb-0">{{ three_line_validation_metrics.overall_validation.status|default:"Validación Exitosa" }}</p>
                                                            </div>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <div class="mt-3 p-3 bg-light rounded">
                                                    <h6>Interpretación del Gráfico:</h6>
                                                    <ul class="mb-0">
                                                        <li><span style="color: blue; font-weight: bold;">Línea Azul</span>: Demanda Real Histórica</li>
                                                        <li><span style="color: red; font-weight: bold;">Línea Roja</span>: Demanda Proyectada (tendencia futura)</li>
                                                        <li><span style="color: green; font-weight: bold;">Línea Verde (punteada)</span>: Demanda Simulada (validación del modelo)</li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}

                                <!-- Tabla de Validación Completa por Día -->
                                {% if all_variables_extracted %}
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <div class="data-table-container">
                                            <div class="card-header d-flex justify-content-between align-items-center">
                                                <h5 class="card-title mb-0">
                                                    <i class="bx bx-list-check me-2"></i>
                                                    Detalle de Validación por Día
                                                    <span class="badge bg-info ms-2">{{ all_variables_extracted|length }} días</span>
                                                </h5>
                                                <button class="btn btn-sm btn-outline-primary" onclick="exportValidationResults()">
                                                    <i class="bx bx-download me-1"></i>Exportar CSV
                                                </button>
                                            </div>
                                            <div class="card-body">
                                                <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                                                    <table class="table table-hover table-sm" id="validationDetailTable">
                                                        <thead class="sticky-top bg-white">
                                                            <tr>
                                                                <th style="width: 80px;">Día</th>
                                                                <th>Fecha</th>
                                                                <th>Producto</th>
                                                                <th class="text-end">Demanda Simulada</th>
                                                                <th class="text-end">Variables Procesadas</th>
                                                                <th class="text-center">Estado Simulación</th>
                                                                <th class="text-center">Calidad Datos</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {% for item in all_variables_extracted %}
                                                            <tr class="validation-row" data-day="{{ item.day }}">
                                                                <td class="fw-bold">{{ item.day }}</td>
                                                                <td>
                                                                    {% if item.date %}
                                                                        {{ item.date|date:"d/m/Y" }}
                                                                    {% else %}
                                                                        Día {{ item.day }}
                                                                    {% endif %}
                                                                </td>
                                                                <td>
                                                                    <small>{{ product_instance.name|default:"Producto" }}</small>
                                                                    <br>
                                                                    <span class="text-muted" style="font-size: 0.75rem;">{{ business_instance.name|default:"Empresa" }}</span>
                                                                </td>
                                                                <td class="text-end text-primary fw-bold">
                                                                    {{ item.demand_mean|floatformat:2 }} L
                                                                    <br>
                                                                    <small class="text-muted">±{{ item.demand_std|floatformat:2 }}</small>
                                                                </td>
                                                                <td class="text-end">
                                                                    {% with var_count=0 %}
                                                                        {% for key, value in item.items %}
                                                                            {% if key != 'day' and key != 'date' and key != 'demand_mean' and key != 'demand_std' %}
                                                                                {% with var_count=var_count|add:1 %}{% endwith %}
                                                                            {% endif %}
                                                                        {% endfor %}
                                                                        <span class="badge bg-info">{{ item.items|length|add:-4 }} variables</span>
                                                                    {% endwith %}
                                                                    <br>
                                                                    <small class="text-muted">Calculadas</small>
                                                                </td>
                                                                <td class="text-center">
                                                                    {% if item.demand_mean > 0 %}
                                                                        <span class="badge bg-success">
                                                                            <i class="bx bx-check-circle"></i> Válida
                                                                        </span>
                                                                    {% else %}
                                                                        <span class="badge bg-warning">
                                                                            <i class="bx bx-error-circle"></i> Revisar
                                                                        </span>
                                                                    {% endif %}
                                                                </td>
                                                                <td class="text-center">
                                                                    {% if item.items|length > 10 %}
                                                                        <span class="badge bg-success">
                                                                            <i class="bx bx-check"></i> Completa
                                                                        </span>
                                                                    {% elif item.items|length > 5 %}
                                                                        <span class="badge bg-warning">
                                                                            <i class="bx bx-time"></i> Parcial
                                                                        </span>
                                                                    {% else %}
                                                                        <span class="badge bg-danger">
                                                                            <i class="bx bx-x"></i> Limitada
                                                                        </span>
                                                                    {% endif %}
                                                                </td>
                                                            </tr>
                                                            {% endfor %}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}

                                <!-- Validación de Variables del Modelo -->
                                {% if model_validation_summary %}
                                <div class="validation-section variables-validation mt-5">
                                    <h4 class="mb-3">
                                        <i class="bx bx-calculator"></i> Validación de Variables del Modelo
                                    </h4>
                                    
                                    <!-- Resumen General -->
                                    <div class="row mb-4">
                                        <div class="col-md-3">
                                            <div class="card text-center">
                                                <div class="card-body">
                                                    <h5 class="card-title">Variables Totales</h5>
                                                    <h2 class="text-primary">{{ model_validation_summary.total_variables|default:0 }}</h2>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="card text-center">
                                                <div class="card-body">
                                                    <h5 class="card-title">Precisas</h5>
                                                    <h2 class="text-success">{{ model_validation_summary.precise_count|default:0 }}</h2>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="card text-center">
                                                <div class="card-body">
                                                    <h5 class="card-title">Aceptables</h5>
                                                    <h2 class="text-warning">{{ model_validation_summary.acceptable_count|default:0 }}</h2>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="card text-center">
                                                <div class="card-body">
                                                    <h5 class="card-title">Inexactas</h5>
                                                    <h2 class="text-danger">{{ model_validation_summary.inaccurate_count|default:0 }}</h2>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Score de Validación -->
                                    <div class="row mb-4">
                                        <div class="col-12">
                                            <div class="progress" style="height: 30px;">
                                                <div class="progress-bar {% if model_validation_summary.success_rate >= 90 %}bg-success{% elif model_validation_summary.success_rate >= 70 %}bg-warning{% else %}bg-danger{% endif %}" 
                                                    role="progressbar" 
                                                    style="width: {{ model_validation_summary.success_rate|default:0 }}%;"
                                                    aria-valuenow="{{ model_validation_summary.success_rate|default:0 }}" 
                                                    aria-valuemin="0" 
                                                    aria-valuemax="100">
                                                    <strong>{{ model_validation_summary.success_rate|default:0|floatformat:1 }}% de Precisión</strong>
                                                </div>
                                            </div>
                                            <p class="text-center mt-2">
                                                <strong>Score de Validación: {{ model_validation_summary.validation_score|default:0|floatformat:1 }}/100</strong>
                                                {% if model_validation_summary.is_valid %}
                                                    <span class="badge bg-success">Modelo Válido</span>
                                                {% else %}
                                                    <span class="badge bg-danger">Modelo Requiere Calibración</span>
                                                {% endif %}
                                            </p>
                                        </div>
                                    </div>
                                </div>
                                {% else %}
                                <div class="validation-section variables-validation mt-5">
                                    <div class="alert alert-info">
                                        <h4 class="alert-heading">
                                            <i class="bx bx-info-circle me-2"></i>
                                            Validación de Variables en Proceso
                                        </h4>
                                        <p class="mb-0">
                                            El sistema está procesando la validación de variables del modelo. 
                                            Esta información estará disponible cuando se complete el análisis.
                                        </p>
                                    </div>
                                </div>
                                {% endif %}

                                <!-- Gráficos de Validación por Variable -->
                                {% if model_validation_charts %}
                                <div class="card mt-4">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0">
                                            <i class="bx bx-line-chart"></i> Gráficos de Validación por Variable
                                        </h5>
                                        <span class="badge bg-info">
                                            {{ model_validation_charts|length }} tipos de variables
                                        </span>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            {% for chart_type, charts_list in model_validation_charts.items %}
                                                {% if chart_type != 'summary' and charts_list %}
                                                    {% for chart_data in charts_list %}
                                                    <div class="col-lg-6 mb-4">
                                                        <div class="card h-100 shadow-sm">
                                                            <div class="card-header d-flex justify-content-between align-items-center">
                                                                <div>
                                                                    <h6 class="mb-0">{{ chart_data.variable }}</h6>
                                                                    <small class="text-muted">{{ chart_data.description|truncatechars:50 }}</small>
                                                                </div>
                                                                <div class="text-end">
                                                                    <span class="badge bg-{% if chart_data.status == 'PRECISA' %}success{% elif chart_data.status == 'ACEPTABLE' %}warning{% else %}danger{% endif %}">
                                                                        {{ chart_data.error_pct|floatformat:1 }}% error
                                                                    </span>
                                                                </div>
                                                            </div>
                                                            <div class="card-body p-2">
                                                                <img src="data:image/png;base64,{{ chart_data.chart }}" 
                                                                    class="img-fluid validation-chart-img" 
                                                                    alt="Gráfico de {{ chart_data.variable }}"
                                                                    onclick="openFullscreen('{{ chart_data.chart }}', '{{ chart_data.variable }}')">
                                                            </div>
                                                            <div class="card-footer bg-light">
                                                                <div class="row text-center small">
                                                                    <div class="col-4">
                                                                        <strong>Unidad:</strong><br>{{ chart_data.unit|default:"N/A" }}
                                                                    </div>
                                                                    <div class="col-4">
                                                                        <strong>Días:</strong><br>{{ chart_data.days_count|default:0 }}
                                                                    </div>
                                                                    <div class="col-4">
                                                                        <strong>Cobertura:</strong><br>{{ chart_data.coverage|default:0|floatformat:0 }}%
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    {% endfor %}
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                                {% else %}
                                <div class="alert alert-info mt-4">
                                    <i class="bx bx-info-circle"></i> 
                                    Los gráficos de validación por variable se generarán cuando el análisis esté completo.
                                </div>
                                {% endif %}

                                <!-- Recomendaciones de Validación -->
                                {% if validation_recommendations %}
                                <div class="row mt-4">
                                    <div class="col-12">
                                        <div class="alert alert-info">
                                            <h5 class="alert-heading">
                                                <i class="bx bx-bulb me-2"></i>
                                                Recomendaciones basadas en la Validación
                                            </h5>
                                            <hr>
                                            <div class="row">
                                                {% for recommendation in validation_recommendations %}
                                                <div class="col-md-6 mb-2">
                                                    <div class="d-flex align-items-start">
                                                        <i class="bx bx-check-circle text-info me-2 mt-1"></i>
                                                        <p class="mb-0">{{ recommendation }}</p>
                                                    </div>
                                                </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% else %}
                                <div class="row mt-4">
                                    <div class="col-12">
                                        <div class="alert alert-success">
                                            <h5 class="alert-heading">
                                                <i class="bx bx-check-double me-2"></i>
                                                Recomendaciones Generales
                                            </h5>
                                            <hr>
                                            <div class="row">
                                                <div class="col-md-6 mb-2">
                                                    <div class="d-flex align-items-start">
                                                        <i class="bx bx-check-circle text-success me-2 mt-1"></i>
                                                        <p class="mb-0">El modelo muestra un comportamiento estable durante el período simulado</p>
                                                    </div>
                                                </div>
                                                <div class="col-md-6 mb-2">
                                                    <div class="d-flex align-items-start">
                                                        <i class="bx bx-check-circle text-success me-2 mt-1"></i>
                                                        <p class="mb-0">Las variables principales mantienen valores dentro de rangos esperados</p>
                                                    </div>
                                                </div>
                                                <div class="col-md-6 mb-2">
                                                    <div class="d-flex align-items-start">
                                                        <i class="bx bx-info-circle text-info me-2 mt-1"></i>
                                                        <p class="mb-0">Continuar monitoreando las métricas clave para futuras simulaciones</p>
                                                    </div>
                                                </div>
                                                <div class="col-md-6 mb-2">
                                                    <div class="d-flex align-items-start">
                                                        <i class="bx bx-info-circle text-info me-2 mt-1"></i>
                                                        <p class="mb-0">Considerar ajustes menores en parámetros para optimización</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}

                            </div>
                        </div>
                        
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para expandir gráficos -->
    <div class="modal fade" id="chartModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="chartModalTitle">Gráfico de Variable</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <img id="chartModalImage" src="" class="img-fluid" alt="Gráfico expandido">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-primary" onclick="downloadChart()">
                        <i class="bx bx-download me-1"></i>Descargar
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal para detalles de variable -->
    <div class="modal fade" id="variableDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="variableDetailsTitle">Detalles de Variable</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="variableDetailsBody">
                    <!-- Contenido dinámico -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal para Detalles de Variable -->
    <div class="modal fade" id="variableDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Detalles de Validación por Día</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="variableDetailsContent">
                    <!-- Contenido dinámico -->
                </div>
            </div>
        </div>
    </div>
    <!-- SOLO ESTOS DOS MODALES AL FINAL DEL TEMPLATE -->
    <div class="modal fade" id="mainFullscreenModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-fullscreen-lg-down">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="mainFullscreenModalTitle">Gráfico</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <img id="mainFullscreenModalImage" src="" class="img-fluid" alt="Gráfico expandido">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-primary" onclick="downloadCurrentChart()">
                        <i class="bx bx-download me-1"></i>Descargar
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="mainDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="mainDetailsModalTitle">Detalles</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="mainDetailsModalBody">
                    <!-- Contenido dinámico -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
    {% block footer %}
    {% include "partials/footer.html" %}
    {% endblock footer %}
</div>
{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<!-- Agregar en la sección de scripts, después de los scripts existentes -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>


<script>
document.addEventListener('DOMContentLoaded', function() {
    initializeEnhancedInsights();
});

function initializeEnhancedInsights() {
    // Animar insights secuencialmente
    const insightCards = document.querySelectorAll('.insight-card');
    
    // Intersection Observer para animar cuando sea visible
    const observer = new IntersectionObserver((entries) => {
        entries.forEach((entry, index) => {
            if (entry.isIntersecting) {
                setTimeout(() => {
                    entry.target.style.opacity = '1';
                    entry.target.style.transform = 'translateY(0)';
                }, index * 100);
                observer.unobserve(entry.target);
            }
        });
    }, {
        threshold: 0.1,
        rootMargin: '50px'
    });
    
    insightCards.forEach(card => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(30px)';
        card.style.transition = 'all 0.6s ease';
        observer.observe(card);
    });
    
    // Agregar tooltips a los insights
    addInsightTooltips();
    
    // Actualizar insights en tiempo real si hay datos dinámicos
    updateInsightsRealTime();
}

function addInsightTooltips() {
    const tooltips = {
        '.financial': 'Análisis de rentabilidad y performance financiera basado en ingresos, gastos y márgenes',
        '.validation': 'Evaluación de la precisión y confiabilidad del modelo predictivo utilizado',
        '.operational': 'Medición de la eficiencia en procesos operativos y uso de recursos',
        '.demand': 'Análisis del comportamiento y tendencias de la demanda del producto',
        '.customer': 'Evaluación del nivel de satisfacción y experiencia del cliente',
        '.comparison': 'Comparación entre datos históricos reales y resultados de la simulación'
    };
    
    Object.entries(tooltips).forEach(([selector, tooltip]) => {
        const elements = document.querySelectorAll(selector);
        elements.forEach(element => {
            element.title = tooltip;
            element.style.cursor = 'help';
        });
    });
}

function updateInsightsRealTime() {
    // Simular actualizaciones en tiempo real de insights
    setInterval(() => {
        updateInsightTrends();
    }, 30000); // Cada 30 segundos
}

function updateInsightTrends() {
    const trendElements = document.querySelectorAll('.insight-trend');
    trendElements.forEach(element => {
        if (element.querySelector('.trend-up, .trend-down')) {
            element.style.animation = 'pulse-success 1s ease';
            setTimeout(() => {
                element.style.animation = '';
            }, 1000);
        }
    });
}

// Función para expandir detalles de un insight específico
function expandInsightDetails(insightType) {
    const modal = document.getElementById('mainDetailsModal');
    const modalTitle = document.getElementById('mainDetailsModalTitle');
    const modalBody = document.getElementById('mainDetailsModalBody');
    
    if (!modal || !modalTitle || !modalBody) return;
    
    const insightDetails = {
        financial: {
            title: 'Detalles del Análisis Financiero',
            content: generateFinancialDetails()
        },
        validation: {
            title: 'Detalles de Validación del Modelo',
            content: generateValidationDetails()
        },
        operational: {
            title: 'Detalles de Eficiencia Operativa',
            content: generateOperationalDetails()
        },
        demand: {
            title: 'Detalles del Comportamiento de Demanda',
            content: generateDemandDetails()
        },
        customer: {
            title: 'Detalles de Satisfacción del Cliente',
            content: generateCustomerDetails()
        },
        comparison: {
            title: 'Detalles de Comparación Histórica',
            content: generateComparisonDetails()
        }
    };
    
    const detail = insightDetails[insightType];
    if (detail) {
        modalTitle.textContent = detail.title;
        modalBody.innerHTML = detail.content;
        new bootstrap.Modal(modal).show();
    }
}

function generateFinancialDetails() {
    return `
        <div class="financial-details">
            <h6>Métricas Financieras Detalladas</h6>
            <div class="row">
                <div class="col-md-6">
                    <h6 class="text-primary">Ingresos</h6>
                    <p>Total generado durante el período de simulación</p>
                </div>
                <div class="col-md-6">
                    <h6 class="text-success">Rentabilidad</h6>
                    <p>Margen de ganancia sobre ingresos totales</p>
                </div>
            </div>
        </div>
    `;
}

function generateValidationDetails() {
    return `
        <div class="validation-details">
            <h6>Métricas de Validación del Modelo</h6>
            <p>El modelo ha sido validado comparando predicciones con datos históricos reales.</p>
        </div>
    `;
}

function generateOperationalDetails() {
    return `
        <div class="operational-details">
            <h6>Análisis de Eficiencia Operativa</h6>
            <p>Evaluación de la eficiencia en procesos de producción y operaciones.</p>
        </div>
    `;
}

function generateDemandDetails() {
    return `
        <div class="demand-details">
            <h6>Análisis de Demanda</h6>
            <p>Tendencias y patrones identificados en el comportamiento de la demanda.</p>
        </div>
    `;
}

function generateCustomerDetails() {
    return `
        <div class="customer-details">
            <h6>Análisis de Satisfacción del Cliente</h6>
            <p>Evaluación del nivel de satisfacción basado en métricas de servicio.</p>
        </div>
    `;
}

function generateComparisonDetails() {
    return `
        <div class="comparison-details">
            <h6>Comparación con Datos Históricos</h6>
            <p>Análisis de correlación entre datos reales y simulaciones.</p>
        </div>
    `;
}

// Exportar funciones globales
window.expandInsightDetails = expandInsightDetails;
</script>

<script>

// ==========================================
// SCRIPT UNIFICADO PARA SIMULATE-RESULT.HTML
// ==========================================

// Variables globales
let currentDay = 1;
let totalDays = 0;
let currentPage = 1;
let rowsPerPage = 10;
let validationPrecisionChart = null;
let validationSummaryChart = null;
let variablesComparisonChart = null;
let currentChartType = 'bar';
let allCharts = [];
let loadedCharts = 0;
const CHARTS_PER_BATCH = 3;

// ==========================================
// INICIALIZACIÓN PRINCIPAL
// ==========================================
document.addEventListener('DOMContentLoaded', function() {
    initializeApp();
});

function initializeApp() {
    totalDays = parseInt(document.querySelector('[data-total-days]')?.dataset.totalDays) || 
                document.querySelectorAll('.daily-result-item').length;
    
    initializeCounters();
    initializeDailyResultsPagination();
    initializeTablePagination();
    initializeModals();
    initializeChartInteractions();
    initializeExportFunctions();
    initializeTooltips();
    initializeTabEvents();
    initializeKeyboardShortcuts();
    
    // Ocultar tutorial si no es primera vez
    if (localStorage.getItem('resultsViewedBefore')) {
        hideTutorial();
    }
}

// ==========================================
// NAVEGACIÓN DE DÍAS
// ==========================================
function initializeDailyResultsPagination() {
    const prevBtn = document.getElementById('prevDayBtn');
    const nextBtn = document.getElementById('nextDayBtn');
    const dayCounter = document.getElementById('dayCounter');
    const currentDayIndicator = document.getElementById('currentDayIndicator');
    
    if (!prevBtn || !nextBtn) return;
    
    function updateDayDisplay() {
        // Ocultar todos los items
        document.querySelectorAll('.daily-result-item').forEach(item => {
            item.style.display = 'none';
        });
        
        // Mostrar item actual con animación
        const currentItem = document.querySelector(`[data-day="${currentDay}"]`);
        if (currentItem) {
            currentItem.style.display = 'block';
            currentItem.style.animation = 'fadeIn 0.3s ease';
        }
        
        // Actualizar contadores
        if (dayCounter) dayCounter.textContent = `Día ${currentDay} de ${totalDays}`;
        if (currentDayIndicator) currentDayIndicator.textContent = `Día ${currentDay}`;
        
        // Actualizar estado de botones
        prevBtn.disabled = currentDay === 1;
        nextBtn.disabled = currentDay === totalDays;
        
        // Clases de botones
        prevBtn.className = currentDay === 1 ? 
            'btn btn-sm btn-outline-secondary btn-pagination' : 
            'btn btn-sm btn-outline-primary btn-pagination';
        nextBtn.className = currentDay === totalDays ? 
            'btn btn-sm btn-outline-secondary btn-pagination' : 
            'btn btn-sm btn-outline-primary btn-pagination';
        
        // Scroll al top
        const cardBody = document.querySelector('.card-body');
        if (cardBody) cardBody.scrollTop = 0;
    }
    
    prevBtn.addEventListener('click', function() {
        if (currentDay > 1) {
            currentDay--;
            updateDayDisplay();
        }
    });
    
    nextBtn.addEventListener('click', function() {
        if (currentDay < totalDays) {
            currentDay++;
            updateDayDisplay();
        }
    });
    
    // Inicializar vista
    updateDayDisplay();
}

// ==========================================
// CONTADORES ANIMADOS
// ==========================================
function initializeCounters() {
    const counters = document.querySelectorAll('.counter');
    const speed = 200;
    
    const animateCounter = (counter) => {
        const target = parseFloat(counter.getAttribute('data-target'));
        const count = parseFloat(counter.innerText) || 0;
        const increment = target / speed;
        
        if (count < target) {
            const newCount = Math.ceil(count + increment);
            if (target % 1 === 0) {
                counter.innerText = newCount.toLocaleString('es-ES');
            } else {
                counter.innerText = newCount.toFixed(2);
            }
            setTimeout(() => animateCounter(counter), 1);
        } else {
            if (target % 1 === 0) {
                counter.innerText = target.toLocaleString('es-ES');
            } else {
                counter.innerText = target.toFixed(2);
            }
        }
    };
    
    // Observer para activar cuando sea visible
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                animateCounter(entry.target);
                observer.unobserve(entry.target);
            }
        });
    });
    
    counters.forEach(counter => {
        observer.observe(counter);
    });
}

// ==========================================
// PAGINACIÓN DE TABLAS
// ==========================================
function initializeTablePagination() {
    const table = document.getElementById('demandTable');
    if (!table) return;
    
    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    const totalPages = Math.ceil(rows.length / rowsPerPage);
    
    const prevBtn = document.getElementById('prevTablePage');
    const nextBtn = document.getElementById('nextTablePage');
    const pageInfo = document.getElementById('tablePageInfo');
    
    if (!prevBtn || !nextBtn) return;
    
    function updateTableDisplay() {
        // Ocultar todas las filas
        rows.forEach(row => row.style.display = 'none');
        
        // Mostrar filas de la página actual
        const startIndex = (currentPage - 1) * rowsPerPage;
        const endIndex = Math.min(startIndex + rowsPerPage, rows.length);
        
        for (let i = startIndex; i < endIndex; i++) {
            if (rows[i]) {
                rows[i].style.display = 'table-row';
                rows[i].style.animation = 'fadeIn 0.2s ease';
            }
        }
        
        // Actualizar info
        if (pageInfo) pageInfo.textContent = `Página ${currentPage} de ${totalPages}`;
        
        // Actualizar botones
        prevBtn.disabled = currentPage === 1;
        nextBtn.disabled = currentPage === totalPages;
    }
    
    prevBtn.addEventListener('click', function() {
        if (currentPage > 1) {
            currentPage--;
            updateTableDisplay();
        }
    });
    
    nextBtn.addEventListener('click', function() {
        if (currentPage < totalPages) {
            currentPage++;
            updateTableDisplay();
        }
    });
    
    updateTableDisplay();
}

// ==========================================
// MODALES UNIFICADOS
// ==========================================
function initializeModals() {
    // Cerrar con ESC
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeAllModals();
        }
    });
    
    // Cerrar al hacer clic fuera
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('modal')) {
            closeAllModals();
        }
    });
}

function closeAllModals() {
    const modals = document.querySelectorAll('.modal.show');
    modals.forEach(modal => {
        const bsModal = bootstrap.Modal.getInstance(modal);
        if (bsModal) bsModal.hide();
    });
}

// ==========================================
// FUNCIONES DE GRÁFICOS UNIFICADAS
// ==========================================
function initializeChartInteractions() {
    // Click en imágenes para expandir
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('chart-image')) {
            const src = e.target.src;
            const alt = e.target.alt;
            const base64Data = src.split(',')[1];
            if (base64Data) {
                openFullscreen(base64Data, alt);
            }
        }
    });
}

function downloadChart(chartData, filename) {
    try {
        if (!chartData) {
            console.warn('No chart data provided for download');
            showNotification('No hay datos del gráfico para descargar', 'warning');
            return;
        }
        
        const link = document.createElement('a');
        link.href = 'data:image/png;base64,' + chartData;
        link.download = filename || 'grafico.png';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showNotification('Gráfico descargado exitosamente', 'success');
    } catch (error) {
        console.error('Error downloading chart:', error);
        showNotification('Error al descargar el gráfico', 'error');
    }
}

function openFullscreen(chartData, title) {
    try {
        if (!chartData) {
            console.warn('No chart data provided for fullscreen');
            return;
        }
        
        const modal = document.getElementById('mainFullscreenModal');
        const modalTitle = document.getElementById('mainFullscreenModalTitle');
        const modalImage = document.getElementById('mainFullscreenModalImage');
        
        if (modal && modalTitle && modalImage) {
            modalTitle.textContent = title || 'Gráfico';
            modalImage.src = 'data:image/png;base64,' + chartData;
            modalImage.setAttribute('data-chart-data', chartData);
            
            new bootstrap.Modal(modal).show();
        }
    } catch (error) {
        console.error('Error opening fullscreen:', error);
        showNotification('Error al abrir el gráfico', 'error');
    }
}

function downloadCurrentChart() {
    try {
        const modalImage = document.getElementById('mainFullscreenModalImage');
        const chartData = modalImage?.getAttribute('data-chart-data');
        const title = document.getElementById('mainFullscreenModalTitle')?.textContent;
        
        if (chartData) {
            const filename = (title || 'grafico').toLowerCase().replace(/\s+/g, '-') + '.png';
            downloadChart(chartData, filename);
        }
    } catch (error) {
        console.error('Error downloading current chart:', error);
        showNotification('Error al descargar el gráfico', 'error');
    }
}

// ==========================================
// EXPORTACIÓN UNIFICADA
// ==========================================
function initializeExportFunctions() {
    window.exportToPDF = async function() {
        const btn = event?.target;
        if (btn) {
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="bx bx-loader-alt bx-spin me-2"></i>Generando PDF...';
            btn.disabled = true;
        }
        
        try {
            const element = document.querySelector('.page-content');
            const canvas = await html2canvas(element, {
                scale: 1.5,
                logging: false,
                useCORS: true,
                allowTaint: true
            });
            
            const imgData = canvas.toDataURL('image/png');
            const pdf = new jspdf.jsPDF({
                orientation: 'landscape',
                unit: 'px',
                format: [canvas.width, canvas.height]
            });
            
            pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
            pdf.save(`simulacion_${new Date().getTime()}_resultados.pdf`);
            
            showNotification('PDF generado exitosamente', 'success');
        } catch (error) {
            console.error('Error generating PDF:', error);
            showNotification('Error al generar PDF', 'error');
        } finally {
            if (btn) {
                btn.innerHTML = btn.dataset.originalText || '<i class="bx bx-file-pdf me-2"></i>Exportar PDF';
                btn.disabled = false;
            }
        }
    };
    
    window.exportToExcel = function() {
        const btn = event?.target;
        if (btn) {
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="bx bx-loader-alt bx-spin me-2"></i>Generando Excel...';
            btn.disabled = true;
        }
        
        try {
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Variable,Valor Total,Unidad,Promedio,Tendencia\n";
            
            // Obtener datos de la tabla de variables
            const rows = document.querySelectorAll('#endogenousTableBody tr');
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 5) {
                    const variable = cells[0].textContent.trim();
                    const total = cells[1].textContent.trim().replace(/[^\d.-]/g, '');
                    const unit = cells[2].textContent.trim();
                    const average = cells[3].textContent.trim().replace(/[^\d.-]/g, '');
                    const trend = cells[4].textContent.trim();
                    
                    csvContent += `"${variable}","${total}","${unit}","${average}","${trend}"\n`;
                }
            });
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `simulacion_${new Date().getTime()}_resultados.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification('Archivo Excel generado exitosamente', 'success');
        } catch (error) {
            console.error('Error generating Excel:', error);
            showNotification('Error al generar Excel', 'error');
        } finally {
            if (btn) {
                btn.innerHTML = '<i class="bx bx-file me-2"></i>Exportar Excel';
                btn.disabled = false;
            }
        }
    };
}

// ==========================================
// GRÁFICOS DE VALIDACIÓN
// ==========================================
function initializeValidationCharts() {
    initializeValidationPrecisionChart();
    initializeValidationSummaryChart();
}

function initializeValidationPrecisionChart() {
    const ctx = document.getElementById('validationPrecisionChart');
    if (!ctx) return;
    
    if (validationPrecisionChart) {
        validationPrecisionChart.destroy();
    }
    
    const tableRows = document.querySelectorAll('#validationDetailTable tbody tr');
    const labels = [];
    const errorData = [];
    const colors = [];
    
    tableRows.forEach(row => {
        const day = row.querySelector('td:first-child')?.textContent;
        const errorCell = row.querySelector('td:nth-child(7) span');
        if (day && errorCell) {
            const errorValue = parseFloat(errorCell.textContent);
            
            labels.push(`Día ${day}`);
            errorData.push(errorValue);
            
            if (errorValue < 10) {
                colors.push('rgba(40, 167, 69, 0.8)');
            } else if (errorValue < 20) {
                colors.push('rgba(255, 193, 7, 0.8)');
            } else {
                colors.push('rgba(220, 53, 69, 0.8)');
            }
        }
    });
    
    const config = {
        type: currentChartType,
        data: {
            labels: labels,
            datasets: [{
                label: 'Error Porcentual (%)',
                data: errorData,
                backgroundColor: colors,
                borderColor: colors.map(c => c.replace('0.8', '1')),
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Distribución de Error Porcentual por Día'
                },
                legend: { display: false }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: { display: true, text: 'Error Porcentual (%)' }
                }
            }
        }
    };
    
    validationPrecisionChart = new Chart(ctx, config);
}

function initializeValidationSummaryChart() {
    const ctx = document.getElementById('validationSummaryChart');
    if (!ctx) return;
    
    if (validationSummaryChart) {
        validationSummaryChart.destroy();
    }
    
    // Obtener datos del template
    const preciseCount = parseInt(document.querySelector('[data-precise-count]')?.dataset.preciseCount) || 0;
    const acceptableCount = parseInt(document.querySelector('[data-acceptable-count]')?.dataset.acceptableCount) || 0;
    const inaccurateCount = parseInt(document.querySelector('[data-inaccurate-count]')?.dataset.inaccurateCount) || 0;
    
    const config = {
        type: 'doughnut',
        data: {
            labels: ['Precisa (<10%)', 'Aceptable (10-20%)', 'Inexacta (>20%)'],
            datasets: [{
                data: [preciseCount, acceptableCount, inaccurateCount],
                backgroundColor: [
                    'rgba(40, 167, 69, 0.8)',
                    'rgba(255, 193, 7, 0.8)',
                    'rgba(220, 53, 69, 0.8)'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom' }
            }
        }
    };
    
    validationSummaryChart = new Chart(ctx, config);
}

function toggleValidationChartType() {
    currentChartType = currentChartType === 'bar' ? 'line' : 'bar';
    initializeValidationPrecisionChart();
}

function downloadValidationChart() {
    if (!validationPrecisionChart) return;
    
    const url = validationPrecisionChart.toBase64Image();
    const link = document.createElement('a');
    link.download = 'distribucion_precision_' + new Date().getTime() + '.png';
    link.href = url;
    link.click();
}

// ==========================================
// VARIABLES ENDÓGENAS
// ==========================================
function updateVariableCounts() {
    try {
        const rows = document.querySelectorAll('#endogenousTableBody tr[data-category]');
        let financial = 0, operational = 0, quality = 0;
        
        rows.forEach(row => {
            const category = row.dataset.category;
            if (category === 'financial') financial++;
            else if (category === 'operational') operational++;
            else if (category === 'quality') quality++;
        });
        
        const financialCount = document.getElementById('financialVarsCount');
        const operationalCount = document.getElementById('operationalVarsCount');
        const qualityCount = document.getElementById('qualityVarsCount');
        
        if (financialCount) financialCount.textContent = financial;
        if (operationalCount) operationalCount.textContent = operational;
        if (qualityCount) qualityCount.textContent = quality;
    } catch (error) {
        console.error('Error updating variable counts:', error);
    }
}

function expandChart(chartName, imageSrc) {
    try {
        const modal = document.getElementById('mainFullscreenModal');
        const modalTitle = document.getElementById('mainFullscreenModalTitle');
        const modalImage = document.getElementById('mainFullscreenModalImage');
        
        if (modal && modalTitle && modalImage) {
            modalTitle.textContent = `Gráfico: ${chartName}`;
            modalImage.src = imageSrc || '';
            
            new bootstrap.Modal(modal).show();
        }
    } catch (error) {
        console.error('Error expanding chart:', error);
    }
}

function showVariableDetails(variableName) {
    try {
        const row = document.querySelector(`tr[data-variable="${variableName}"]`);
        if (!row) return;
        
        const modal = document.getElementById('mainDetailsModal');
        const modalTitle = document.getElementById('mainDetailsModalTitle');
        const modalBody = document.getElementById('mainDetailsModalBody');
        
        if (modal && modalTitle && modalBody) {
            modalTitle.textContent = `Detalles: ${variableName}`;
            
            const category = row.dataset.category || 'unknown';
            const trend = row.dataset.trend || 'stable';
            const totalElement = row.querySelector('.variable-total');
            const unitElement = row.querySelector('.variable-unit');
            const averageElement = row.querySelector('.variable-average');
            
            const total = totalElement?.textContent.trim() || 'N/A';
            const unit = unitElement?.textContent.trim() || 'N/A';
            const average = averageElement?.textContent.trim() || 'N/A';
            
            modalBody.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Información General</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Variable:</strong></td><td>${variableName}</td></tr>
                            <tr><td><strong>Categoría:</strong></td><td class="text-capitalize">${category}</td></tr>
                            <tr><td><strong>Unidad:</strong></td><td>${unit}</td></tr>
                            <tr><td><strong>Tendencia:</strong></td><td class="text-capitalize">${trend}</td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>Valores</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Total:</strong></td><td>${total}</td></tr>
                            <tr><td><strong>Promedio:</strong></td><td>${average}</td></tr>
                        </table>
                    </div>
                </div>
                <div class="mt-3">
                    <h6>Descripción</h6>
                    <p class="text-muted">${getVariableDescription(variableName)}</p>
                </div>
            `;
            
            new bootstrap.Modal(modal).show();
        }
    } catch (error) {
        console.error('Error showing variable details:', error);
    }
}

function getVariableDescription(variableName) {
    const descriptions = {
        'IT': 'Ingresos Totales: Suma de todos los ingresos generados durante el período de simulación.',
        'GT': 'Ganancia Total: Diferencia entre ingresos totales y gastos totales del período.',
        'TG': 'Total Gastos: Suma de todos los costos y gastos incurridos durante la simulación.',
        'TPV': 'Total Productos Vendidos: Cantidad total de productos vendidos en el período.',
        'NSC': 'Nivel de Satisfacción del Cliente: Indicador de calidad del servicio prestado.',
        'EOG': 'Eficiencia Operativa General: Medida de la eficiencia en los procesos operativos.',
        'NR': 'Nivel de Rentabilidad: Porcentaje de ganancia sobre los ingresos totales.',
        'PVP': 'Precio de Venta al Público: Precio unitario de venta del producto.',
        'CFD': 'Costo Fijo Diario: Costos fijos que se incurren diariamente.',
        'CVU': 'Costo Variable Unitario: Costo variable por unidad producida.',
        'DPH': 'Demanda Promedio Histórica: Promedio histórico de la demanda.',
        'CPROD': 'Capacidad de Producción: Capacidad máxima de producción diaria.',
        'NEPP': 'Número de Empleados en Producción: Personal asignado a producción.'
    };
    
    return descriptions[variableName] || `Variable endógena ${variableName} del modelo de simulación.`;
}

// ==========================================
// EVENTOS DE PESTAÑAS
// ==========================================
function initializeTabEvents() {
    // Inicializar contenido cuando se muestre una pestaña
    document.addEventListener('shown.bs.tab', function(e) {
        const targetId = e.target.getAttribute('aria-controls');
        
        switch(targetId) {
            case 'endogenous':
                setTimeout(updateVariableCounts, 100);
                break;
            case 'validation':
                setTimeout(initializeValidationCharts, 100);
                break;
        }
        
        // Animar entrada de contenido
        const targetPane = document.getElementById(targetId);
        if (targetPane) {
            targetPane.style.animation = 'fadeIn 0.3s ease';
        }
    });
}

// ==========================================
// ATAJOS DE TECLADO
// ==========================================
function initializeKeyboardShortcuts() {
    document.addEventListener('keydown', function(e) {
        // Navegación de días con Ctrl + Flechas
        if (e.ctrlKey || e.metaKey) {
            if (e.key === 'ArrowLeft' && currentDay > 1) {
                e.preventDefault();
                currentDay--;
                document.querySelectorAll('.daily-result-item').forEach(item => {
                    item.style.display = item.dataset.day == currentDay ? 'block' : 'none';
                });
                updateDayCounters();
            } else if (e.key === 'ArrowRight' && currentDay < totalDays) {
                e.preventDefault();
                currentDay++;
                document.querySelectorAll('.daily-result-item').forEach(item => {
                    item.style.display = item.dataset.day == currentDay ? 'block' : 'none';
                });
                updateDayCounters();
            }
        }
    });
}

function updateDayCounters() {
    const dayCounter = document.getElementById('dayCounter');
    const currentDayIndicator = document.getElementById('currentDayIndicator');
    
    if (dayCounter) dayCounter.textContent = `Día ${currentDay} de ${totalDays}`;
    if (currentDayIndicator) currentDayIndicator.textContent = `Día ${currentDay}`;
}

// ==========================================
// FUNCIONES AUXILIARES
// ==========================================
function initializeTooltips() {
    // Agregar estilos de animación
    if (!document.getElementById('custom-animations')) {
        const style = document.createElement('style');
        style.id = 'custom-animations';
        style.textContent = `
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(10px); }
                to { opacity: 1; transform: translateY(0); }
            }
            @keyframes fadeOut {
                from { opacity: 1; transform: translateY(0); }
                to { opacity: 0; transform: translateY(-10px); }
            }
            .cursor-pointer { cursor: pointer; }
        `;
        document.head.appendChild(style);
    }
}

function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 10000; min-width: 300px;';
    
    const icon = type === 'success' ? 'bx-check-circle' : 
                 type === 'error' ? 'bx-error' : 
                 'bx-info-circle';
    
    notification.innerHTML = `
        <i class="bx ${icon} me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);
}

function hideTutorial() {
    const tutorial = document.getElementById('resultsTutorial');
    if (tutorial) {
        tutorial.style.animation = 'fadeOut 0.5s ease-out';
        setTimeout(() => {
            tutorial.style.display = 'none';
        }, 500);
        localStorage.setItem('resultsViewedBefore', 'true');
    }
}

function shareResults() {
    if (navigator.share) {
        navigator.share({
            title: 'Resultados de Simulación',
            text: 'Mira los resultados de mi simulación de negocio',
            url: window.location.href
        }).then(() => {
            showNotification('Compartido exitosamente', 'success');
        }).catch((error) => {
            console.log('Error sharing:', error);
        });
    } else {
        navigator.clipboard.writeText(window.location.href).then(() => {
            showNotification('Enlace copiado al portapapeles', 'success');
        });
    }
}

// Exportar validación de resultados
function exportValidationResults() {
    try {
        let csv = 'Día,Fecha,Producto,Empresa,Demanda Simulada (L),Demanda Real (L),Diferencia (L),Error %,Veredicto\n';
        
        const tableRows = document.querySelectorAll('#validationDetailTable tbody tr.validation-row');
        
        tableRows.forEach(row => {
            const cells = row.querySelectorAll('td');
            if (cells.length >= 8) {
                const day = cells[0].textContent.trim();
                const date = cells[1].textContent.trim();
                const productInfo = cells[2].textContent.trim().split('\n');
                const product = productInfo[0].trim();
                const business = productInfo[1] ? productInfo[1].trim() : '';
                const simulated = cells[3].textContent.replace(' L', '').trim();
                const real = cells[4].textContent.replace(' L', '').trim();
                const difference = cells[5].textContent.replace(' L', '').replace('+', '').trim();
                const error = cells[6].querySelector('span')?.textContent.replace('%', '').trim() || '0';
                const verdict = cells[7].textContent.trim();
                
                csv += `${day},"${date}","${product}","${business}",${simulated},${real},${difference},${error},"${verdict}"\n`;
            }
        });
        
        // Agregar totales si existen
        const footerCells = document.querySelectorAll('#validationDetailTable tfoot td');
        if (footerCells.length > 0) {
            csv += '\nTotales/Promedios,,,,' + 
                   footerCells[3]?.textContent.replace(' L', '').trim() + ',' +
                   footerCells[4]?.textContent.replace(' L', '').trim() + ',' +
                   footerCells[5]?.textContent.replace(' L', '').replace('+', '').trim() + ',' +
                   footerCells[6]?.querySelector('span')?.textContent.replace('%', '').trim() + ',';
        }
        
        // Descargar archivo
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'validacion_modelo_' + new Date().getTime() + '.csv';
        link.click();
        
        showNotification('Resultados exportados exitosamente', 'success');
    } catch (error) {
        console.error('Error exporting validation results:', error);
        showNotification('Error al exportar resultados', 'error');
    }
}

// Exportar validación de variables
function exportVariablesValidation() {
    try {
        let csv = 'Variable,Descripción,Unidad,Valor Real Promedio,Valor Simulado Promedio,Error Promedio %,Días Válidos,Veredicto\n';
        
        const rows = document.querySelectorAll('#variablesValidationTable tbody tr');
        rows.forEach(row => {
            const cells = row.querySelectorAll('td');
            if (cells.length >= 8) {
                const variable = cells[0].querySelector('strong')?.textContent || '';
                const description = cells[1].textContent.trim();
                const unit = cells[2].textContent.trim();
                const realAvg = cells[3].textContent.replace(/[^\d.-]/g, '');
                const simAvg = cells[4].textContent.replace(/[^\d.-]/g, '');
                const errorAvg = cells[5].querySelector('span')?.textContent.replace('%', '') || '0';
                const validDays = cells[6].textContent.trim();
                const verdict = cells[7].textContent.trim();
                
                csv += `"${variable}","${description}","${unit}",${realAvg},${simAvg},${errorAvg},"${validDays}","${verdict}"\n`;
            }
        });
        
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'validacion_variables_' + new Date().getTime() + '.csv';
        link.click();
        
        showNotification('Validación de variables exportada exitosamente', 'success');
    } catch (error) {
        console.error('Error exporting variables validation:', error);
        showNotification('Error al exportar validación de variables', 'error');
    }
}

// Exportar tabla de variables endógenas
function exportEndogenousTable(format) {
    try {
        const table = document.getElementById('endogenousTable');
        const rows = table.querySelectorAll('tbody tr[data-variable]');
        
        if (format === 'excel' || format === 'csv') {
            let csvContent = 'Variable,Valor Total,Unidad,Promedio Diario,Tendencia,Rango,Volatilidad\n';
            
            rows.forEach(row => {
                if (row.style.display !== 'none') {
                    const variable = row.dataset.variable;
                    const total = row.querySelector('.variable-total')?.textContent.replace(/[,]/g, '') || '';
                    const unit = row.querySelector('.variable-unit')?.textContent || '';
                    const average = row.querySelector('.variable-average')?.textContent.replace(/[,]/g, '') || '';
                    const trend = row.dataset.trend || '';
                    const range = row.querySelector('.variable-range')?.textContent || '';
                    const volatility = row.querySelector('.variable-volatility')?.textContent || '';
                    
                    csvContent += `"${variable}","${total}","${unit}","${average}","${trend}","${range}","${volatility}"\n`;
                }
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'variables_endogenas_' + new Date().getTime() + '.csv';
            link.click();
            
            showNotification('Variables endógenas exportadas exitosamente', 'success');
        } else if (format === 'pdf') {
            window.print();
        }
    } catch (error) {
        console.error('Error exporting endogenous table:', error);
        showNotification('Error al exportar tabla', 'error');
    }
}

// ==========================================
// FUNCIONES ESPECÍFICAS DE GRÁFICOS
// ==========================================

// Cargar gráficos de validación por lotes
function loadInitialCharts() {
    const container = document.getElementById('chartsContainer');
    const loadedContainer = document.getElementById('loadedChartsContainer');
    
    if (container) container.style.display = 'none';
    if (loadedContainer) loadedContainer.style.display = 'block';
    
    loadMoreCharts();
}

function loadMoreCharts() {
    const container = document.getElementById('chartsGrid');
    if (!container) return;
    
    const remaining = allCharts.length - loadedCharts;
    const toLoad = Math.min(CHARTS_PER_BATCH, remaining);
    
    for (let i = loadedCharts; i < loadedCharts + toLoad; i++) {
        if (allCharts[i]) {
            const chartHtml = createChartCard(allCharts[i]);
            container.insertAdjacentHTML('beforeend', chartHtml);
        }
    }
    
    loadedCharts += toLoad;
    
    // Actualizar botón de cargar más
    const loadMoreContainer = document.getElementById('loadMoreContainer');
    const remainingCount = document.getElementById('remainingCount');
    
    if (loadMoreContainer && remainingCount) {
        const newRemaining = allCharts.length - loadedCharts;
        if (newRemaining > 0) {
            loadMoreContainer.style.display = 'block';
            remainingCount.textContent = `(${newRemaining} restantes)`;
        } else {
            loadMoreContainer.style.display = 'none';
        }
    }
}

function createChartCard(chartData) {
    const statusClass = chartData.status === 'PRECISA' ? 'success' : 
                       chartData.status === 'ACEPTABLE' ? 'warning' : 'danger';
    
    return `
        <div class="col-lg-6 mb-4 chart-card" data-variable="${chartData.variable}" data-type="${chartData.type}">
            <div class="card h-100 shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-0">${chartData.variable}</h6>
                        <small class="text-muted">${chartData.description}</small>
                    </div>
                    <span class="badge bg-${statusClass}">
                        ${chartData.error_pct?.toFixed(1) || 0}% error
                    </span>
                </div>
                <div class="card-body p-2">
                    <img src="data:image/png;base64,${chartData.chart}" 
                         class="img-fluid validation-chart-img" 
                         alt="Gráfico de ${chartData.variable}"
                         onclick="expandChart('${chartData.variable}', this.src)">
                </div>
                <div class="card-footer bg-light">
                    <div class="row text-center small">
                        <div class="col-4">
                            <strong>Unidad:</strong><br>${chartData.unit || 'N/A'}
                        </div>
                        <div class="col-4">
                            <strong>Días:</strong><br>${chartData.days_count || 0}
                        </div>
                        <div class="col-4">
                            <strong>Cobertura:</strong><br>${chartData.coverage?.toFixed(0) || 0}%
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
}

// Filtrar gráficos por tipo
function filterChartsByType() {
    const filter = document.getElementById('chartTypeFilter')?.value || '';
    const chartCards = document.querySelectorAll('.chart-card');
    
    chartCards.forEach(card => {
        const cardType = card.dataset.type;
        if (!filter || cardType === filter) {
            card.style.display = '';
        } else {
            card.style.display = 'none';
        }
    });
}

// ==========================================
// GESTIÓN DE PERFORMANCE Y MEMORIA
// ==========================================
function checkPerformance() {
    if ('performance' in window && 'memory' in performance) {
        const memoryUsage = performance.memory.usedJSHeapSize / 1048576;
        console.log(`Memory usage: ${memoryUsage.toFixed(2)} MB`);
        
        if (memoryUsage > 500) {
            console.warn('High memory usage detected. Consider closing other tabs.');
        }
    }
}

// Monitorear rendimiento cada 30 segundos
setInterval(checkPerformance, 30000);

// Lazy loading de imágenes
function setupLazyLoading() {
    if ('IntersectionObserver' in window) {
        const imageObserver = new IntersectionObserver((entries, observer) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const img = entry.target;
                    if (img.dataset.src) {
                        img.src = img.dataset.src;
                        img.classList.remove('lazy');
                        observer.unobserve(img);
                    }
                }
            });
        });
        
        document.querySelectorAll('img[data-src]').forEach(img => {
            imageObserver.observe(img);
        });
    }
}

// ==========================================
// EVENTOS DE IMPRESIÓN
// ==========================================
window.addEventListener('beforeprint', function() {
    // Expandir secciones colapsadas para impresión
    document.querySelectorAll('.collapse').forEach(el => {
        el.classList.add('show');
    });
    
    // Mostrar todos los días para impresión
    document.querySelectorAll('.daily-result-item').forEach(item => {
        item.style.display = 'block';
    });
});

window.addEventListener('afterprint', function() {
    // Restaurar estado después de impresión
    document.querySelectorAll('.daily-result-item').forEach((item, index) => {
        item.style.display = index === currentDay - 1 ? 'block' : 'none';
    });
});

// ==========================================
// GESTIÓN DE ERRORES GLOBAL
// ==========================================
window.addEventListener('error', function(e) {
    console.error('Global error:', e.error);
    
    // Manejar errores de carga de imágenes
    if (e.target.tagName === 'IMG' && e.target.classList.contains('chart-image')) {
        e.target.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjBmMGYwIi8+CiAgPHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxOCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkVycm9yIGNhcmdhbmRvIGdyw6FmaWNvPC90ZXh0Pgo8L3N2Zz4=';
        e.target.classList.remove('lazy');
    }
});

// ==========================================
// INICIALIZACIÓN FINAL
// ==========================================
console.log('Simulate Result Unified Script loaded successfully');

// Exportar funciones globales necesarias
window.downloadChart = downloadChart;
window.openFullscreen = openFullscreen;
window.downloadCurrentChart = downloadCurrentChart;
window.exportToPDF = exportToPDF;
window.exportToExcel = exportToExcel;
window.shareResults = shareResults;
window.hideTutorial = hideTutorial;
window.showVariableDetails = showVariableDetails;
window.expandChart = expandChart;
window.updateVariableCounts = updateVariableCounts;
window.toggleValidationChartType = toggleValidationChartType;
window.downloadValidationChart = downloadValidationChart;
window.exportValidationResults = exportValidationResults;
window.exportVariablesValidation = exportVariablesValidation;
window.exportEndogenousTable = exportEndogenousTable;
window.loadInitialCharts = loadInitialCharts;
window.loadMoreCharts = loadMoreCharts;
window.filterChartsByType = filterChartsByType;
</script>
{% endblock extra_js %}