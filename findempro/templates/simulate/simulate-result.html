{% extends "partials/base.html" %}
{% load static %}
{% block title %}Resultados de Simulaci√≥n{% endblock title %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/joint.css' %}"> 
<link rel="stylesheet" href="{% static 'libs/dropzone/dist/dropzone.css'%}" type="text/css" />
<link rel="stylesheet" href="{% static 'libs/filepond/dist/filepond.min.css'%}" type="text/css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.9.3/min/dropzone.min.css" />
<link rel="stylesheet" href="{% static 'css/simulate-result.css' %}">
{% endblock extra_css %}
<!-- CSS Styles for Enhanced Insights -->
<style>
.validation-kpi {
    padding: 1rem;
}

.validation-kpi-value {
    font-size: 2rem;
    font-weight: bold;
    margin-bottom: 0.5rem;
}

.validation-kpi-label {
    font-size: 0.9rem;
    color: #6c757d;
}

.validation-row:hover {
    background-color: #f8f9fa;
    cursor: pointer;
}

.validation-chart-img {
    cursor: pointer;
    transition: transform 0.2s ease;
}

.validation-chart-img:hover {
    transform: scale(1.05);
}

.validation-section {
    border-top: 2px solid #dee2e6;
    padding-top: 2rem;
}

.metric-card {
    border: 1px solid #dee2e6;
    border-radius: 8px;
    overflow: hidden;
}

@media (max-width: 768px) {
    .validation-kpi {
        margin-bottom: 1rem;
    }
    
    .validation-kpi-value {
        font-size: 1.5rem;
    }
}
.insights-panel-enhanced {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 2rem;
    border-radius: 15px;
    margin-bottom: 2rem;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
}

.insights-header {
    text-align: center;
    margin-bottom: 2rem;
}

.insights-title {
    font-size: 1.8rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
}

.insights-subtitle {
    opacity: 0.9;
    font-size: 1.1rem;
    margin-bottom: 0;
}

.insights-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.insight-card {
    background: rgba(255,255,255,0.1);
    backdrop-filter: blur(10px);
    border-radius: 12px;
    padding: 1.5rem;
    border: 1px solid rgba(255,255,255,0.2);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.insight-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 35px rgba(0,0,0,0.2);
}

.insight-header {
    display: flex;
    align-items: center;
    margin-bottom: 1rem;
}

.insight-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: rgba(255,255,255,0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 1rem;
}

.insight-icon i {
    font-size: 1.2rem;
}

.insight-category {
    margin: 0;
    font-weight: 600;
    opacity: 0.9;
}

.insight-status {
    display: flex;
    align-items: center;
    margin-bottom: 0.5rem;
    font-weight: 600;
}

.insight-status i {
    margin-right: 0.5rem;
}

.insight-status.success { color: #4caf50; }
.insight-status.warning { color: #ff9800; }
.insight-status.danger { color: #f44336; }
.insight-status.info { color: #2196f3; }

.insight-detail strong {
    font-size: 1.2rem;
    display: block;
}

.insight-detail small {
    opacity: 0.8;
    font-size: 0.85rem;
}

.insight-trend {
    margin-top: 0.5rem;
    font-size: 0.9rem;
}

.trend-up { color: #4caf50; }
.trend-down { color: #f44336; }
.trend-stable { color: #ff9800; }

.executive-summary {
    background: rgba(255,255,255,0.1);
    backdrop-filter: blur(10px);
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
}

.summary-header h5 {
    margin: 0;
    font-weight: 600;
}

.summary-points {
    margin-top: 1rem;
}

.summary-point {
    display: flex;
    align-items: flex-start;
    margin-bottom: 1rem;
    padding: 0.5rem 0;
}

.summary-point i {
    margin-right: 0.75rem;
    margin-top: 0.2rem;
    flex-shrink: 0;
}

.summary-point.positive i { color: #4caf50; }
.summary-point.negative i { color: #f44336; }
.summary-point.neutral i { color: #ff9800; }

.quick-alerts {
    background: rgba(255,255,255,0.1);
    backdrop-filter: blur(10px);
    border-radius: 12px;
    padding: 1.5rem;
}

.alerts-header h6 {
    margin: 0 0 1rem 0;
    font-weight: 600;
}

.alerts-content .row {
    align-items: stretch;
}

.alert-item {
    display: flex;
    align-items: center;
    background: rgba(255,255,255,0.1);
    border-radius: 8px;
    padding: 1rem;
    height: 100%;
    transition: all 0.3s ease;
}

.alert-item:hover {
    background: rgba(255,255,255,0.15);
    transform: translateY(-2px);
}

.alert-item i {
    font-size: 1.5rem;
    margin-right: 1rem;
    flex-shrink: 0;
}

.alert-item.critical i { color: #f44336; }
.alert-item.warning i { color: #ff9800; }
.alert-item.recommendation i { color: #4caf50; }

.alert-item strong {
    display: block;
    font-size: 0.9rem;
    margin-bottom: 0.25rem;
}

.alert-item small {
    opacity: 0.8;
    font-size: 0.8rem;
    line-height: 1.3;
}

/* Responsive Design */
@media (max-width: 768px) {
    .insights-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
    }
    
    .insight-card {
        padding: 1rem;
    }
    
    .insights-panel-enhanced {
        padding: 1.5rem;
    }
    
    .insights-title {
        font-size: 1.5rem;
    }
    
    .insights-subtitle {
        font-size: 1rem;
    }
}

/* Animation for insights loading */
@keyframes slideInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.insight-card {
    animation: slideInUp 0.6s ease forwards;
}

.insight-card:nth-child(1) { animation-delay: 0.1s; }
.insight-card:nth-child(2) { animation-delay: 0.2s; }
.insight-card:nth-child(3) { animation-delay: 0.3s; }
.insight-card:nth-child(4) { animation-delay: 0.4s; }
.insight-card:nth-child(5) { animation-delay: 0.5s; }
.insight-card:nth-child(6) { animation-delay: 0.6s; }

/* Loading states */
.insight-card.loading {
    opacity: 0.6;
    pointer-events: none;
}

.insight-card.loading::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 20px;
    height: 20px;
    margin: -10px 0 0 -10px;
    border: 2px solid transparent;
    border-top: 2px solid #fff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Special effects for different insight types */
.insight-card.financial {
    background: linear-gradient(135deg, rgba(76, 175, 80, 0.2), rgba(139, 195, 74, 0.2));
}

.insight-card.validation {
    background: linear-gradient(135deg, rgba(33, 150, 243, 0.2), rgba(3, 169, 244, 0.2));
}

.insight-card.operational {
    background: linear-gradient(135deg, rgba(255, 152, 0, 0.2), rgba(255, 193, 7, 0.2));
}

.insight-card.demand {
    background: linear-gradient(135deg, rgba(156, 39, 176, 0.2), rgba(233, 30, 99, 0.2));
}

.insight-card.customer {
    background: linear-gradient(135deg, rgba(244, 67, 54, 0.2), rgba(233, 30, 99, 0.2));
}

.insight-card.comparison {
    background: linear-gradient(135deg, rgba(96, 125, 139, 0.2), rgba(120, 144, 156, 0.2));
}

/* Pulse effect for important insights */
.insight-status.success {
    animation: pulse-success 2s infinite;
}

.insight-status.danger {
    animation: pulse-danger 2s infinite;
}

@keyframes pulse-success {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.8; }
}

@keyframes pulse-danger {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.9; }
}

/* Dark mode compatibility */
@media (prefers-color-scheme: dark) {
    .insights-panel-enhanced {
        background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
        border: 1px solid rgba(255,255,255,0.1);
    }
    
    .insight-card {
        background: rgba(255,255,255,0.05);
        border: 1px solid rgba(255,255,255,0.1);
    }
}

/* Print styles */
@media print {
    .insights-panel-enhanced {
        background: white !important;
        color: black !important;
        box-shadow: none !important;
    }
    
    .insight-card {
        background: #f5f5f5 !important;
        color: black !important;
        break-inside: avoid;
    }
    
    .insight-status.success { color: #2e7d32 !important; }
    .insight-status.warning { color: #f57c00 !important; }
    .insight-status.danger { color: #c62828 !important; }
    .insight-status.info { color: #1565c0 !important; }
}
.productivity-metric {
   text-align: center;
   padding: 1rem;
   border-radius: 8px;
   background: #f8f9fa;
   margin-bottom: 1rem;
}

.correlation-metric {
   padding: 1rem;
   border-radius: 8px;
   background: #f8f9fa;
   margin-bottom: 1rem;
}

.correlation-value {
   margin-top: 0.5rem;
}

.recommendation-item {
   height: 100%;
}

.recommendation-item .alert {
   height: 100%;
   margin-bottom: 0;
}

.kpi-card {
   background: white;
   border-radius: 12px;
   padding: 1.5rem;
   box-shadow: 0 2px 10px rgba(0,0,0,0.1);
   margin-bottom: 1rem;
   transition: transform 0.3s ease;
}

.kpi-card:hover {
   transform: translateY(-5px);
}

.kpi-icon {
   width: 60px;
   height: 60px;
   border-radius: 50%;
   display: flex;
   align-items: center;
   justify-content: center;
   margin: 0 auto 1rem;
   color: white;
}

.kpi-icon i {
   font-size: 1.5rem;
}

.kpi-title {
   font-size: 0.9rem;
   color: #6c757d;
   margin-bottom: 0.5rem;
}

.kpi-value {
   font-size: 1.8rem;
   font-weight: bold;
   color: #333;
   margin-bottom: 0.5rem;
}

.kpi-status {
   margin-bottom: 0.5rem;
}

@media (max-width: 768px) {
   .kpi-card {
       margin-bottom: 1rem;
   }
   
   .correlation-metric,
   .productivity-metric {
       margin-bottom: 1rem;
   }
}
</style>
{% block content %}
<div class="main-content">
    <div class="page-content">
        <div class="container-fluid">
            <!-- Page Title -->
            {% block pagetitle %}
            {% include "partials/page-title.html" with pagetitle="Simulaci√≥n" title="Resultados" %}
            {% endblock pagetitle %}

            <!-- Results Tutorial -->
            <div class="results-tutorial" id="resultsTutorial">
                <h5><i class="bx bx-bulb me-2"></i>Gu√≠a de Interpretaci√≥n de Resultados</h5>
                <p>Sus resultados de simulaci√≥n est√°n listos. Aqu√≠ le explicamos c√≥mo interpretarlos:</p>
                <div class="tutorial-steps">
                    <div class="tutorial-step">
                        <i class="bx bx-bar-chart-alt-2"></i>
                        <h6>M√©tricas Clave</h6>
                        <p class="small">Revise los indicadores principales en la parte superior</p>
                    </div>
                    <div class="tutorial-step">
                        <i class="bx bx-line-chart"></i>
                        <h6>An√°lisis Visual</h6>
                        <p class="small">Explore los gr√°ficos interactivos por categor√≠a</p>
                    </div>
                    <div class="tutorial-step">
                        <i class="bx bx-bulb"></i>
                        <h6>Recomendaciones</h6>
                        <p class="small">Lea las sugerencias personalizadas basadas en IA</p>
                    </div>
                    <div class="tutorial-step">
                        <i class="bx bx-download"></i>
                        <h6>Exportar</h6>
                        <p class="small">Descargue reportes en PDF o Excel</p>
                    </div>
                </div>
                <button class="btn btn-sm btn-outline-primary mt-3" onclick="hideTutorial()">
                    <i class="bx bx-x me-1"></i>Entendido
                </button>
            </div>

            <!-- Results Header -->
            <div class="results-header">
                <div class="row align-items-center">
                    <div class="col-lg-8">
                        <h1 class="mb-3">
                            <i class="bx bx-bar-chart-alt-2 me-3"></i>
                            Resultados de Simulaci√≥n
                        </h1>
                        <p class="fs-5 mb-0">
                            An√°lisis completo para {{ product_instance.name }} - {{ business_instance.name }}
                        </p>
                        <p class="opacity-75 mb-0">
                            Simulaci√≥n ejecutada el {{ simulation_instance.date_created|date:"d/m/Y H:i" }}
                        </p>
                    </div>
                    <div class="col-lg-4 text-lg-end">
                        <div class="export-section">
                            <h5 class="mb-3">
                                <i class="bx bx-download me-2"></i>
                                Exportar Resultados
                            </h5>
                            <div class="d-grid gap-2">
                                <button class="btn btn-primary" onclick="exportToPDF()">
                                    <i class="bx bx-file-pdf me-2"></i>
                                    Exportar PDF
                                </button>
                                <button class="btn btn-success" onclick="exportToExcel()">
                                    <i class="bx bx-file me-2"></i>
                                    Exportar Excel
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Key Insights Panel -->
            <div class="insights-panel">
                <h5 class="mb-3"><i class="bx bx-bulb me-2"></i>Insights Principales</h5>
                <div class="row">
                    <div class="col-md-6">
                        <div class="insight-item">
                            <div class="insight-icon {% if growth_rate > 0 %}positive{% else %}negative{% endif %}">
                                <i class="bx {% if growth_rate > 0 %}bx-trending-up{% else %}bx-trending-down{% endif %}"></i>
                            </div>
                            <div>
                                <h6 class="mb-1">Tendencia de Demanda</h6>
                                <p class="mb-0">
                                    La demanda muestra una tendencia 
                                    {% if growth_rate > 0 %}
                                        <strong class="text-success">creciente del {{ growth_rate|floatformat:"2" }}%</strong>
                                    {% else %}
                                        <strong class="text-danger">decreciente del {{ growth_rate|floatformat:"2" }}%</strong>
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="insight-item">
                            <div class="insight-icon {% if error_permisible < 5 %}positive{% elif error_permisible < 10 %}warning{% else %}negative{% endif %}">
                                <i class="bx bx-target-lock"></i>
                            </div>
                            <div>
                                <h6 class="mb-1">Precisi√≥n del Modelo</h6>
                                <p class="mb-0">
                                    Error permisible del <strong>{{ error_permisible|floatformat:"2" }}%</strong>
                                    {% if error_permisible < 5 %}
                                        <span class="text-success">(Muy bueno)</span>
                                    {% elif error_permisible < 10 %}
                                        <span class="text-warning">(Bueno)</span>
                                    {% else %}
                                        <span class="text-danger">(Revisar modelo)</span>
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

  <!-- Enhanced Key Insights Panel -->
<div class="insights-panel-enhanced">
    <div class="insights-header">
        <h4 class="insights-title">
            <i class="bx bx-brain me-3"></i>
            Insights Inteligentes de la Simulaci√≥n
        </h4>
        <p class="insights-subtitle">
            An√°lisis autom√°tico de {{ all_variables_extracted|length|default:0 }} d√≠as de simulaci√≥n 
            para <strong>{{ product_instance.name|default:"el producto" }}</strong>
        </p>
    </div>

    <!-- Grid de Insights Principales -->
    <div class="insights-grid">
        
        <!-- Insight Financiero Principal -->
        <div class="insight-card financial">
            <div class="insight-header">
                <div class="insight-icon">
                    <i class="bx bx-trending-up"></i>
                </div>
                <h6 class="insight-category">Performance Financiera</h6>
            </div>
            <div class="insight-content">
                {% if totales_acumulativos.GT and totales_acumulativos.IT %}
                    {% if totales_acumulativos.GT.total > 0 %}
                        <div class="insight-status success">
                            <i class="bx bx-check-circle"></i>
                            <span>Rentable</span>
                        </div>
                        <div class="insight-detail">
                            <strong>Bs. {{ totales_acumulativos.GT.total|floatformat:0 }}</strong> de ganancia
                            <small>
                                {% if totales_acumulativos.NR %}
                                    {% widthratio totales_acumulativos.NR.total 1 all_variables_extracted|length as avg_margin %}
                                    {% widthratio avg_margin 1 100 as margin_percent %}
                                    ({{ margin_percent|floatformat:1 }}% de margen)
                                {% endif %}
                            </small>
                        </div>
                        <div class="insight-trend">
                            {% if totales_acumulativos.GT.trend == "increasing" %}
                                <span class="trend-up">
                                    <i class="bx bx-trending-up"></i> Tendencia creciente
                                </span>
                            {% elif totales_acumulativos.GT.trend == "decreasing" %}
                                <span class="trend-down">
                                    <i class="bx bx-trending-down"></i> Requiere atenci√≥n
                                </span>
                            {% else %}
                                <span class="trend-stable">
                                    <i class="bx bx-minus"></i> Comportamiento estable
                                </span>
                            {% endif %}
                        </div>
                    {% else %}
                        <div class="insight-status warning">
                            <i class="bx bx-error-circle"></i>
                            <span>Requiere Optimizaci√≥n</span>
                        </div>
                        <div class="insight-detail">
                            <strong>Bs. {{ totales_acumulativos.GT.total|floatformat:0 }}</strong> de resultado
                            <small>Necesita ajustar costos y precios</small>
                        </div>
                    {% endif %}
                {% else %}
                    <div class="insight-status info">
                        <i class="bx bx-info-circle"></i>
                        <span>Calculando performance...</span>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Insight de Calidad del Modelo -->
        <div class="insight-card validation">
            <div class="insight-header">
                <div class="insight-icon">
                    <i class="bx bx-target-lock"></i>
                </div>
                <h6 class="insight-category">Calidad del Modelo</h6>
            </div>
            <div class="insight-content">
                {% if validation_summary.success_rate %}
                    {% if validation_summary.success_rate >= 80 %}
                        <div class="insight-status success">
                            <i class="bx bx-badge-check"></i>
                            <span>Excelente Precisi√≥n</span>
                        </div>
                        <div class="insight-detail">
                            <strong>{{ validation_summary.success_rate|floatformat:1 }}%</strong> de √©xito
                            <small>Error promedio: {{ validation_summary.avg_mape|floatformat:2 }}%</small>
                        </div>
                    {% elif validation_summary.success_rate >= 60 %}
                        <div class="insight-status warning">
                            <i class="bx bx-error-alt"></i>
                            <span>Precisi√≥n Aceptable</span>
                        </div>
                        <div class="insight-detail">
                            <strong>{{ validation_summary.success_rate|floatformat:1 }}%</strong> de √©xito
                            <small>Puede mejorarse el modelo</small>
                        </div>
                    {% else %}
                        <div class="insight-status danger">
                            <i class="bx bx-x-circle"></i>
                            <span>Requiere Calibraci√≥n</span>
                        </div>
                        <div class="insight-detail">
                            <strong>{{ validation_summary.success_rate|floatformat:1 }}%</strong> de √©xito
                            <small>Revisar par√°metros del modelo</small>
                        </div>
                    {% endif %}
                {% else %}
                    <div class="insight-status info">
                        <span>Error: <strong>{{ error_permisible|floatformat:2 }}%</strong></span>
                        <small>Margen de tolerancia configurado</small>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Insight Operativo -->
        <div class="insight-card operational">
            <div class="insight-header">
                <div class="insight-icon">
                    <i class="bx bx-cog"></i>
                </div>
                <h6 class="insight-category">Eficiencia Operativa</h6>
            </div>
            <div class="insight-content">
                {% if totales_acumulativos.EOG and all_variables_extracted|length > 0 %}
                    {% widthratio totales_acumulativos.EOG.total 1 all_variables_extracted|length as avg_eff %}
                    {% widthratio avg_eff 1 100 as eff_percent %}
                    {% if eff_percent >= 80 %}
                        <div class="insight-status success">
                            <i class="bx bx-trending-up"></i>
                            <span>Alta Eficiencia</span>
                        </div>
                        <div class="insight-detail">
                            <strong>{{ eff_percent|floatformat:1 }}%</strong> de eficiencia
                            <small>Procesos optimizados</small>
                        </div>
                    {% elif eff_percent >= 60 %}
                        <div class="insight-status warning">
                            <i class="bx bx-time"></i>
                            <span>Eficiencia Moderada</span>
                        </div>
                        <div class="insight-detail">
                            <strong>{{ eff_percent|floatformat:1 }}%</strong> de eficiencia
                            <small>Oportunidades de mejora</small>
                        </div>
                    {% else %}
                        <div class="insight-status danger">
                            <i class="bx bx-error"></i>
                            <span>Eficiencia Baja</span>
                        </div>
                        <div class="insight-detail">
                            <strong>{{ eff_percent|floatformat:1 }}%</strong> de eficiencia
                            <small>Requiere optimizaci√≥n urgente</small>
                        </div>
                    {% endif %}
                {% else %}
                    <div class="insight-status info">
                        <span>Analizando eficiencia...</span>
                        <small>Datos en procesamiento</small>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Insight de Demanda -->
        <div class="insight-card demand">
            <div class="insight-header">
                <div class="insight-icon">
                    <i class="bx bx-line-chart"></i>
                </div>
                <h6 class="insight-category">Comportamiento de Demanda</h6>
            </div>
            <div class="insight-content">
                {% if growth_rate %}
                    {% if growth_rate > 5 %}
                        <div class="insight-status success">
                            <i class="bx bx-trending-up"></i>
                            <span>Crecimiento Fuerte</span>
                        </div>
                        <div class="insight-detail">
                            <strong>+{{ growth_rate|floatformat:2 }}%</strong> de crecimiento
                            <small>Considerar expandir capacidad</small>
                        </div>
                    {% elif growth_rate > 0 %}
                        <div class="insight-status success">
                            <i class="bx bx-trending-up"></i>
                            <span>Crecimiento Moderado</span>
                        </div>
                        <div class="insight-detail">
                            <strong>+{{ growth_rate|floatformat:2 }}%</strong> de crecimiento
                            <small>Tendencia positiva sostenible</small>
                        </div>
                    {% elif growth_rate < -5 %}
                        <div class="insight-status danger">
                            <i class="bx bx-trending-down"></i>
                            <span>Declive Significativo</span>
                        </div>
                        <div class="insight-detail">
                            <strong>{{ growth_rate|floatformat:2 }}%</strong> de cambio
                            <small>Requiere estrategia de recuperaci√≥n</small>
                        </div>
                    {% elif growth_rate < 0 %}
                        <div class="insight-status warning">
                            <i class="bx bx-trending-down"></i>
                            <span>Declive Leve</span>
                        </div>
                        <div class="insight-detail">
                            <strong>{{ growth_rate|floatformat:2 }}%</strong> de cambio
                            <small>Monitorear de cerca</small>
                        </div>
                    {% else %}
                        <div class="insight-status info">
                            <i class="bx bx-minus"></i>
                            <span>Demanda Estable</span>
                        </div>
                        <div class="insight-detail">
                            <strong>{{ growth_rate|floatformat:2 }}%</strong> de cambio
                            <small>Comportamiento predecible</small>
                        </div>
                    {% endif %}
                {% else %}
                    <div class="insight-status info">
                        <span>Analizando tendencias...</span>
                        <small>Calculando patrones de demanda</small>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Insight de Satisfacci√≥n del Cliente -->
        <div class="insight-card customer">
            <div class="insight-header">
                <div class="insight-icon">
                    <i class="bx bx-happy"></i>
                </div>
                <h6 class="insight-category">Satisfacci√≥n del Cliente</h6>
            </div>
            <div class="insight-content">
                {% if totales_acumulativos.NSC and all_variables_extracted|length > 0 %}
                    {% widthratio totales_acumulativos.NSC.total 1 all_variables_extracted|length as avg_sat %}
                    {% widthratio avg_sat 1 100 as sat_percent %}
                    {% if sat_percent >= 90 %}
                        <div class="insight-status success">
                            <i class="bx bx-star"></i>
                            <span>Excelente</span>
                        </div>
                        <div class="insight-detail">
                            <strong>{{ sat_percent|floatformat:1 }}%</strong> satisfacci√≥n
                            <small>Clientes muy satisfechos</small>
                        </div>
                    {% elif sat_percent >= 70 %}
                        <div class="insight-status warning">
                            <i class="bx bx-like"></i>
                            <span>Buena</span>
                        </div>
                        <div class="insight-detail">
                            <strong>{{ sat_percent|floatformat:1 }}%</strong> satisfacci√≥n
                            <small>Espacio para mejorar</small>
                        </div>
                    {% else %}
                        <div class="insight-status danger">
                            <i class="bx bx-dislike"></i>
                            <span>Requiere Atenci√≥n</span>
                        </div>
                        <div class="insight-detail">
                            <strong>{{ sat_percent|floatformat:1 }}%</strong> satisfacci√≥n
                            <small>Priorizar mejoras de servicio</small>
                        </div>
                    {% endif %}
                {% else %}
                    <div class="insight-status info">
                        <span>Evaluando satisfacci√≥n...</span>
                        <small>An√°lisis en proceso</small>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Insight de Comparaci√≥n Hist√≥rica -->
        <div class="insight-card comparison">
            <div class="insight-header">
                <div class="insight-icon">
                    <i class="bx bx-git-compare"></i>
                </div>
                <h6 class="insight-category">Precisi√≥n Hist√≥rica</h6>
            </div>
            <div class="insight-content">
                {% if realistic_comparison.correlation %}
                    {% if realistic_comparison.correlation >= 0.8 %}
                        <div class="insight-status success">
                            <i class="bx bx-check-double"></i>
                            <span>Alta Correlaci√≥n</span>
                        </div>
                        <div class="insight-detail">
                            <strong>{{ realistic_comparison.correlation|floatformat:3 }}</strong> correlaci√≥n
                            <small>MAPE: {{ realistic_comparison.mape|floatformat:2 }}%</small>
                        </div>
                    {% elif realistic_comparison.correlation >= 0.6 %}
                        <div class="insight-status warning">
                            <i class="bx bx-check"></i>
                            <span>Correlaci√≥n Moderada</span>
                        </div>
                        <div class="insight-detail">
                            <strong>{{ realistic_comparison.correlation|floatformat:3 }}</strong> correlaci√≥n
                            <small>Ajuste aceptable del modelo</small>
                        </div>
                    {% else %}
                        <div class="insight-status danger">
                            <i class="bx bx-x"></i>
                            <span>Baja Correlaci√≥n</span>
                        </div>
                        <div class="insight-detail">
                            <strong>{{ realistic_comparison.correlation|floatformat:3 }}</strong> correlaci√≥n
                            <small>Revisar modelo predictivo</small>
                        </div>
                    {% endif %}
                {% elif demand_stats.comparison.correlation %}
                    <div class="insight-status info">
                        <span>Correlaci√≥n: <strong>{{ demand_stats.comparison.correlation|floatformat:3 }}</strong></span>
                        <small>Basado en comparaci√≥n de demanda</small>
                    </div>
                {% else %}
                    <div class="insight-status info">
                        <span>Evaluando correlaci√≥n...</span>
                        <small>Comparando datos hist√≥ricos</small>
                    </div>
                {% endif %}
            </div>
        </div>

    </div>

    <!-- Resumen Ejecutivo Autom√°tico -->
    <div class="executive-summary">
        <div class="summary-header">
            <h5>
                <i class="bx bx-bulb me-2"></i>
                Resumen Ejecutivo Inteligente
            </h5>
        </div>
        <div class="summary-content">
            <div class="summary-points">
                
                <!-- Punto financiero -->
                {% if totales_acumulativos.GT %}
                <div class="summary-point {% if totales_acumulativos.GT.total > 0 %}positive{% else %}negative{% endif %}">
                    <i class="bx {% if totales_acumulativos.GT.total > 0 %}bx-check-circle{% else %}bx-error-circle{% endif %}"></i>
                    <span>
                        {% if totales_acumulativos.GT.total > 0 %}
                            El modelo proyecta un negocio <strong>rentable</strong> con ganancias de 
                            <strong>Bs. {{ totales_acumulativos.GT.total|floatformat:0 }}</strong> en {{ all_variables_extracted|length }} d√≠as.
                        {% else %}
                            El modelo indica la necesidad de <strong>optimizar costos</strong> para alcanzar rentabilidad.
                        {% endif %}
                    </span>
                </div>
                {% endif %}

                <!-- Punto de validaci√≥n -->
                {% if validation_summary.success_rate %}
                <div class="summary-point {% if validation_summary.success_rate >= 70 %}positive{% elif validation_summary.success_rate >= 50 %}neutral{% else %}negative{% endif %}">
                    <i class="bx {% if validation_summary.success_rate >= 70 %}bx-badge-check{% elif validation_summary.success_rate >= 50 %}bx-time{% else %}bx-error{% endif %}"></i>
                    <span>
                        La precisi√≥n del modelo es del <strong>{{ validation_summary.success_rate|floatformat:1 }}%</strong>
                        {% if validation_summary.success_rate >= 70 %}
                            , indicando <strong>alta confiabilidad</strong> en las predicciones.
                        {% elif validation_summary.success_rate >= 50 %}
                            , mostrando <strong>resultados aceptables</strong> pero con espacio para mejora.
                        {% else %}
                            , sugiriendo la necesidad de <strong>calibrar el modelo</strong>.
                        {% endif %}
                    </span>
                </div>
                {% endif %}

                <!-- Punto operativo -->
                {% if totales_acumulativos.EOG %}
                <div class="summary-point {% if eff_percent >= 70 %}positive{% elif eff_percent >= 50 %}neutral{% else %}negative{% endif %}">
                    <i class="bx {% if eff_percent >= 70 %}bx-trending-up{% elif eff_percent >= 50 %}bx-time{% else %}bx-trending-down{% endif %}"></i>
                    <span>
                        La eficiencia operativa promedio del <strong>{{ eff_percent|floatformat:1 }}%</strong>
                        {% if eff_percent >= 70 %}
                            demuestra <strong>procesos bien optimizados</strong>.
                        {% elif eff_percent >= 50 %}
                            sugiere <strong>oportunidades de mejora</strong> en los procesos.
                        {% else %}
                            requiere <strong>atenci√≥n inmediata</strong> para optimizar operaciones.
                        {% endif %}
                    </span>
                </div>
                {% endif %}

                <!-- Punto de demanda -->
                {% if growth_rate %}
                <div class="summary-point {% if growth_rate > 0 %}positive{% elif growth_rate == 0 %}neutral{% else %}negative{% endif %}">
                    <i class="bx {% if growth_rate > 0 %}bx-trending-up{% elif growth_rate == 0 %}bx-minus{% else %}bx-trending-down{% endif %}"></i>
                    <span>
                        La demanda muestra una tendencia de <strong>{{ growth_rate|floatformat:2 }}%</strong>
                        {% if growth_rate > 5 %}
                            , indicando <strong>crecimiento robusto</strong> y oportunidades de expansi√≥n.
                        {% elif growth_rate > 0 %}
                            , mostrando <strong>crecimiento sostenido</strong> y mercado saludable.
                        {% elif growth_rate == 0 %}
                            , evidenciando un <strong>mercado estable</strong> y demanda predecible.
                        {% elif growth_rate > -5 %}
                            , sugiriendo la necesidad de <strong>estrategias de retenci√≥n</strong>.
                        {% else %}
                            , requiriendo <strong>acciones correctivas inmediatas</strong>.
                        {% endif %}
                    </span>
                </div>
                {% endif %}

            </div>
        </div>
    </div>

    <!-- Alertas y Recomendaciones R√°pidas -->
    {% if validation_alerts or financial_recommendations %}
    <div class="quick-alerts">
        <div class="alerts-header">
            <h6>
                <i class="bx bx-bell me-2"></i>
                Alertas y Recomendaciones Inmediatas
            </h6>
        </div>
        <div class="alerts-content">
            <div class="row">
                <!-- Alertas de validaci√≥n -->
                {% if validation_alerts.ERROR %}
                <div class="col-md-4">
                    <div class="alert-item critical">
                        <i class="bx bx-error-circle"></i>
                        <div>
                            <strong>Cr√≠ticas ({{ validation_alerts.ERROR|length }})</strong>
                            <small>{{ validation_alerts.ERROR.0.message|truncatechars:60 }}</small>
                        </div>
                    </div>
                </div>
                {% endif %}

                {% if validation_alerts.WARNING %}
                <div class="col-md-4">
                    <div class="alert-item warning">
                        <i class="bx bx-error"></i>
                        <div>
                            <strong>Advertencias ({{ validation_alerts.WARNING|length }})</strong>
                            <small>{{ validation_alerts.WARNING.0.message|truncatechars:60 }}</small>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Recomendaciones principales -->
                {% if financial_recommendations %}
                <div class="col-md-4">
                    <div class="alert-item recommendation">
                        <i class="bx bx-lightbulb"></i>
                        <div>
                            <strong>Recomendaciones ({{ financial_recommendations|length }})</strong>
                            <small>{{ financial_recommendations.0.recommendation|truncatechars:60 }}</small>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}

</div>



<!-- JavaScript para funcionalidad mejorada de insights -->



            <!-- Main Content Grid -->
            <div class="row">
                <!-- Sidebar with Parameters and Controls -->
                <div class="col-lg-4">
                    <!-- Simulation Parameters -->
                    <div class="metric-card mb-4">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="bx bx-cog me-2"></i>
                                Par√°metros de Simulaci√≥n
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-4">
                                    <img src="{{ product_instance.get_photo_url }}" 
                                         class="img-fluid rounded" 
                                         alt="{{ product_instance.name }}"
                                         loading="lazy">
                                </div>
                                <div class="col-8">
                                    <h6 class="mb-1">{{ business_instance.name }}</h6>
                                    <p class="text-muted mb-0">{{ product_instance.name }}</p>
                                </div>
                            </div>
                            
                            <dl class="row mb-0">
                                <dt class="col-6">Horizonte:</dt>
                                <dd class="col-6">{{ simulation_instance.quantity_time }} {{ simulation_instance.unit_time }}</dd>
                                
                                <dt class="col-6">Inicio:</dt>
                                <dd class="col-6">{{ simulation_instance.date_created|date:"d/m/Y" }}</dd>
                                
                                <dt class="col-6">Estado:</dt>
                                <dd class="col-6">
                                    <span class="badge bg-success">Completada</span>
                                </dd>
                            </dl>
                            
                            <!-- Quick Actions -->
                            <hr>
                            <div class="d-grid gap-2">
                                <button class="btn btn-sm btn-outline-primary" onclick="window.print()">
                                    <i class="bx bx-printer me-1"></i>Imprimir
                                </button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="shareResults()">
                                    <i class="bx bx-share-alt me-1"></i>Compartir
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Financial Recommendations -->
                    {% if financial_recommendations_to_show %}
                    <div class="recommendation-card mb-4">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="bx bx-lightbulb me-2"></i>
                                Recomendaciones Financieras
                            </h5>
                        </div>
                        <div class="card-body">
                            {% for recommendation in financial_recommendations_to_show %}
                            <div class="mb-3 p-3 bg-white rounded">
                                <h6 class="fw-bold text-primary">{{ recommendation.name }}</h6>
                                <p class="mb-2">{{ recommendation.recommendation }}</p>
                                <small class="text-muted">
                                    <i class="bx bx-info-circle me-1"></i>
                                    Variable: {{ recommendation.variable_name }}
                                </small>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Daily Results Navigation -->
                    <div class="container mt-4">
                        <div class="data-table-container">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="bx bx-calendar me-2"></i>
                                    Resultados Diarios
                                    <span class="badge bg-info ms-2" id="currentDayIndicator">D√≠a 1</span>
                                </h5>
                            </div>
                            <div class="card-body" style="max-height: 900px; overflow-y: auto;">
                                <div id="dailyResultsContainer">
                                    {% for item in all_variables_extracted %}
                                    <div class="daily-result-item" 
                                        data-day="{{ forloop.counter }}" 
                                        style="{% if not forloop.first %}display: none;{% endif %}">
                                        <h6 class="text-primary mb-3">
                                            <i class="bx bx-calendar-event me-2"></i>
                                            {% if item.date %}
                                                {{ item.date|date:"d/m/Y" }}
                                            {% else %}
                                                D√≠a {{ forloop.counter }}
                                            {% endif %}
                                        </h6>
                                        
                                        <!-- Demanda del d√≠a -->
                                        <div class="mb-4">
                                            <div class="row">
                                                <div class="col-6">
                                                    <div class="p-3 bg-primary text-white rounded">
                                                        <small class="d-block opacity-75">Demanda Media</small>
                                                        <h4 class="mb-0">{{ item.demand_mean|floatformat:2 }}</h4>
                                                    </div>
                                                </div>
                                                <div class="col-6">
                                                    <div class="p-3 bg-info text-white rounded">
                                                        <small class="d-block opacity-75">Desviaci√≥n Est√°ndar</small>
                                                        <h4 class="mb-0">{{ item.demand_std|floatformat:2 }}</h4>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="table-responsive">
                                            <table class="table table-sm table-hover">
                                                <thead>
                                                    <tr>
                                                        <th style="width: 40%">Variable</th>
                                                        <th style="width: 30%">Valor</th>
                                                        <th style="width: 20%">Unidad</th>
                                                        <th style="width: 10%">Estado</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for key, value in item.items %}
                                                        {% if key != 'day' and key != 'date' and key != 'demand_mean' and key != 'demand_std' %}
                                                        <tr>
                                                            <td class="small">
                                                                <strong>{{ key }}</strong>
                                                                <br>
                                                                <small class="text-muted">
                                                                    {% if key == 'PVP' %}Precio de Venta al P√∫blico
                                                                    {% elif key == 'TPV' %}Total Productos Vendidos
                                                                    {% elif key == 'IT' %}Ingresos Totales
                                                                    {% elif key == 'TG' %}Total Gastos
                                                                    {% elif key == 'GT' %}Ganancia Total
                                                                    {% elif key == 'NR' %}Nivel de Rentabilidad
                                                                    {% elif key == 'NSC' %}Nivel de Satisfacci√≥n del Cliente
                                                                    {% elif key == 'EOG' %}Eficiencia Operativa General
                                                                    {% elif key == 'DPH' %}Demanda Promedio Hist√≥rica
                                                                    {% elif key == 'CFD' %}Costo Fijo Diario
                                                                    {% elif key == 'CVU' %}Costo Variable Unitario
                                                                    {% elif key == 'CPROD' %}Capacidad de Producci√≥n
                                                                    {% elif key == 'NEPP' %}N√∫mero de Empleados en Producci√≥n
                                                                    {% else %}{{ key }}
                                                                    {% endif %}
                                                                </small>
                                                            </td>
                                                            <td class="fw-bold">
                                                                {% if key == 'NR' or key == 'NSC' or key == 'EOG' %}
                                                                    {{ value|floatformat:3 }}
                                                                {% elif key == 'PVP' or key == 'IT' or key == 'TG' or key == 'GT' or key == 'CFD' or key == 'CVU' %}
                                                                    {{ value|floatformat:2 }}
                                                                {% else %}
                                                                    {{ value|floatformat:2 }}
                                                                {% endif %}
                                                            </td>
                                                            <td class="small text-muted">
                                                                {% if key == 'TPV' or key == 'DPH' %}Litros
                                                                {% elif key == 'PVP' or key == 'IT' or key == 'TG' or key == 'GT' or key == 'CFD' or key == 'CVU' %}Bs.
                                                                {% elif key == 'NR' or key == 'NSC' or key == 'EOG' %}%
                                                                {% elif key == 'CPROD' %}L/d√≠a
                                                                {% elif key == 'NEPP' %}Personas
                                                                {% else %}Unidad
                                                                {% endif %}
                                                            </td>
                                                            <td>
                                                                {% if key == 'NR' %}
                                                                    {% if value >= 0.2 %}
                                                                        <span class="badge bg-success">√ìptimo</span>
                                                                    {% elif value >= 0.1 %}
                                                                        <span class="badge bg-warning">Aceptable</span>
                                                                    {% else %}
                                                                        <span class="badge bg-danger">Cr√≠tico</span>
                                                                    {% endif %}
                                                                {% elif key == 'NSC' %}
                                                                    {% if value >= 0.9 %}
                                                                        <span class="badge bg-success">Excelente</span>
                                                                    {% elif value >= 0.7 %}
                                                                        <span class="badge bg-warning">Bueno</span>
                                                                    {% else %}
                                                                        <span class="badge bg-danger">Bajo</span>
                                                                    {% endif %}
                                                                {% elif key == 'EOG' %}
                                                                    {% if value >= 0.8 %}
                                                                        <span class="badge bg-success">Alta</span>
                                                                    {% elif value >= 0.6 %}
                                                                        <span class="badge bg-warning">Media</span>
                                                                    {% else %}
                                                                        <span class="badge bg-danger">Baja</span>
                                                                    {% endif %}
                                                                {% else %}
                                                                    <span class="badge bg-info">Normal</span>
                                                                {% endif %}
                                                            </td>
                                                        </tr>
                                                        {% endif %}
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                        
                                        <!-- Additional daily stats -->
                                        <div class="mt-4">
                                            <h6 class="text-muted mb-3">Estad√≠sticas del d√≠a</h6>
                                            <div class="row g-3">
                                                <div class="col-6 col-md-3">
                                                    <div class="p-3 bg-light rounded text-center">
                                                        <small class="d-block text-muted">Total Variables</small>
                                                        <h5 class="mb-0">
                                                            {% with total_vars=0 %}
                                                                {% for key, value in item.items %}
                                                                    {% if key != 'day' and key != 'date' and key != 'demand_mean' and key != 'demand_std' %}
                                                                        {% with total_vars=total_vars|add:1 %}{% endwith %}
                                                                    {% endif %}
                                                                {% endfor %}
                                                                {{ item.items|length|add:-4 }}
                                                            {% endwith %}
                                                        </h5>
                                                    </div>
                                                </div>
                                                <div class="col-6 col-md-3">
                                                    <div class="p-3 bg-light rounded text-center">
                                                        <small class="d-block text-muted">D√≠a de Simulaci√≥n</small>
                                                        <h5 class="mb-0">{{ forloop.counter }}</h5>
                                                    </div>
                                                </div>
                                                {% if item.GT %}
                                                <div class="col-6 col-md-3">
                                                    <div class="p-3 bg-light rounded text-center">
                                                        <small class="d-block text-muted">Ganancia</small>
                                                        <h5 class="mb-0 {% if item.GT > 0 %}text-success{% else %}text-danger{% endif %}">
                                                            {{ item.GT|floatformat:0 }} Bs.
                                                        </h5>
                                                    </div>
                                                </div>
                                                {% endif %}
                                                {% if item.NR %}
                                                <div class="col-6 col-md-3">
                                                    <div class="p-3 bg-light rounded text-center">
                                                        <small class="d-block text-muted">Rentabilidad</small>
                                                        <h5 class="mb-0 {% if item.NR >= 0.2 %}text-success{% elif item.NR >= 0.1 %}text-warning{% else %}text-danger{% endif %}">
                                                            {{ item.NR|floatformat:1 }}%
                                                        </h5>
                                                    </div>
                                                </div>
                                                {% endif %}
                                            </div>
                                        </div>

                                        <!-- Daily notes section -->
                                        <div class="mt-4">
                                            <div class="alert alert-info">
                                                <h6 class="mb-2"><i class="bx bx-info-circle me-2"></i>An√°lisis del d√≠a {{ forloop.counter }}</h6>
                                                <small>
                                                    {% if item.GT and item.NR %}
                                                        Ganancia del d√≠a: <strong>{{ item.GT|floatformat:2 }} Bs.</strong> 
                                                        con rentabilidad de <strong>{{ item.NR|floatformat:1 }}%</strong>.
                                                        {% if item.NSC %}
                                                            Satisfacci√≥n del cliente: <strong>{{ item.NSC|floatformat:1 }}%</strong>.
                                                        {% endif %}
                                                    {% else %}
                                                        Datos correspondientes a la simulaci√≥n del d√≠a {{ forloop.counter }}. 
                                                        Variables calculadas seg√∫n el modelo de simulaci√≥n.
                                                    {% endif %}
                                                </small>
                                            </div>
                                        </div>

                                    </div>
                                    {% empty %}
                                    <div class="text-center py-5">
                                        <i class="bx bx-info-circle display-4 text-muted"></i>
                                        <h5 class="mt-3 text-muted">No hay datos de variables disponibles</h5>
                                        <p class="text-muted">Los resultados de la simulaci√≥n no contienen datos de variables para mostrar.</p>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            <div class="pagination-controls p-3 bg-light">
                                <div class="d-flex justify-content-between align-items-center">
                                    <button type="button" class="btn btn-sm btn-outline-primary btn-pagination" id="prevDayBtn">
                                        <i class="bx bx-chevron-left me-1"></i>Anterior
                                    </button>
                                    <span class="text-center small text-muted" id="dayCounter">
                                        D√≠a 1 de {{ all_variables_extracted|length }}
                                    </span>
                                    <button type="button" class="btn btn-sm btn-outline-primary btn-pagination" id="nextDayBtn">
                                        Siguiente<i class="bx bx-chevron-right ms-1"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Main Charts and Analysis -->
                <div class="col-lg-8">
                    <!-- Chart Tabs -->
                        <div class="chart-tabs">
                            <ul class="nav nav-tabs" id="chartTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" 
                                            data-bs-target="#overview" type="button" role="tab">
                                        <i class="bx bx-line-chart me-2"></i>
                                        Resumen General
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="financial-tab" data-bs-toggle="tab" 
                                            data-bs-target="#financial" type="button" role="tab">
                                        <i class="bx bx-dollar me-2"></i>
                                        An√°lisis Financiero
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="operations-tab" data-bs-toggle="tab" 
                                            data-bs-target="#operations" type="button" role="tab">
                                        <i class="bx bx-cog me-2"></i>
                                        Operaciones
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="demand-tab" data-bs-toggle="tab" 
                                            data-bs-target="#demand" type="button" role="tab">
                                        <i class="bx bx-trending-up me-2"></i>
                                        Demanda
                                    </button>
                                </li>
                                <!-- En la secci√≥n de Tab Content, agregar nuevos tabs -->
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="endogenous-tab" data-bs-toggle="tab" 
                                            data-bs-target="#endogenous" type="button" role="tab">
                                        <i class="bx bx-scatter-chart me-2"></i>
                                        Variables End√≥genas
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="analysis-tab" data-bs-toggle="tab" 
                                            data-bs-target="#analysis" type="button" role="tab">
                                        <i class="bx bx-analyse me-2"></i>
                                        An√°lisis Estad√≠stico
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="validation-tab" data-bs-toggle="tab" 
                                            data-bs-target="#validation" type="button" role="tab">
                                        <i class="bx bx-check-double me-2"></i>
                                        Validaci√≥n del Modelo
                                    </button>
                                </li>
                                
                            </ul>
                        </div>
                        <!-- Tab Content -->
                        <div class="tab-content" id="chartTabsContent">
                            <!-- Overview Tab -->
                            <div class="tab-pane fade show active" id="overview" role="tabpanel">
                                
                                <!-- Header de resumen ejecutivo -->
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <div class="executive-summary">
                                            <div class="summary-header">
                                                <h2 class="summary-title">
                                                    <i class="bx bx-chart me-3"></i>
                                                    Resumen Ejecutivo de la Simulaci√≥n
                                                </h2>
                                                <div class="summary-badges">
                                                    {% if simulation_instance.date_created %}
                                                    <span class="badge bg-info">
                                                        <i class="bx bx-calendar me-1"></i>
                                                        {{ simulation_instance.date_created|date:"d/m/Y H:i" }}
                                                    </span>
                                                    {% endif %}
                                                    <span class="badge bg-success">
                                                        <i class="bx bx-check-circle me-1"></i>
                                                        Simulaci√≥n Completada
                                                    </span>
                                                </div>
                                            </div>
                                            <div class="summary-description">
                                                <p class="lead">
                                                    An√°lisis integral de {{ all_variables_extracted|length|default:0 }} d√≠as de simulaci√≥n 
                                                    para <strong>{{ product_instance.name|default:"el producto" }}</strong> de 
                                                    <strong>{{ business_instance.name|default:"la empresa" }}</strong>.
                                                    {% if totales_acumulativos.GT %}
                                                        {% if totales_acumulativos.GT.total > 0 %}
                                                            La simulaci√≥n proyecta un escenario <span class="text-success font-weight-bold">rentable</span> 
                                                            con ganancias totales de <strong>Bs. {{ totales_acumulativos.GT.total|floatformat:2 }}</strong>.
                                                        {% else %}
                                                            La simulaci√≥n indica la necesidad de <span class="text-warning font-weight-bold">optimizaci√≥n</span> 
                                                            en la estrategia operativa y financiera.
                                                        {% endif %}
                                                    {% endif %}
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                

                                <!-- M√©tricas clave del resumen -->
                                <div class="row mb-4">

                                    

                                    <div class="col-12">
                                        <div class="metrics-overview">
                                            <h4 class="metrics-title mb-4">
                                                <i class="bx bx-tachometer me-2"></i>
                                                M√©tricas Clave de Performance
                                            </h4>
                                            <div class="metrics-grid">
                                                <div class="metric-card metric-revenue">
                                                    <div class="metric-icon">
                                                        <i class="bx bx-dollar-circle"></i>
                                                    </div>
                                                    <div class="metric-content">
                                                        <div class="metric-value">
                                                            {% if totales_acumulativos.IT %}
                                                                Bs. {{ totales_acumulativos.IT.total|floatformat:0|default:"0" }}
                                                            {% else %}
                                                                Bs. 0
                                                            {% endif %}
                                                        </div>
                                                        <div class="metric-label">Ingresos Totales</div>
                                                        <div class="metric-trend">
                                                            {% if totales_acumulativos.IT.trend == "increasing" %}
                                                                <span class="trend-up"><i class="bx bx-trending-up"></i> Creciente</span>
                                                            {% elif totales_acumulativos.IT.trend == "decreasing" %}
                                                                <span class="trend-down"><i class="bx bx-trending-down"></i> Decreciente</span>
                                                            {% else %}
                                                                <span class="trend-stable"><i class="bx bx-minus"></i> Estable</span>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="metric-card metric-profit">
                                                    <div class="metric-icon">
                                                        <i class="bx bx-trending-up"></i>
                                                    </div>
                                                    <div class="metric-content">
                                                        <div class="metric-value">
                                                            {% if totales_acumulativos.GT %}
                                                                Bs. {{ totales_acumulativos.GT.total|floatformat:0|default:"0" }}
                                                            {% else %}
                                                                Bs. 0
                                                            {% endif %}
                                                        </div>
                                                        <div class="metric-label">Ganancia Neta</div>
                                                        <div class="metric-trend">
                                                            {% if totales_acumulativos.GT %}
                                                                {% if totales_acumulativos.GT.total > 0 %}
                                                                    <span class="trend-up"><i class="bx bx-check-circle"></i> Rentable</span>
                                                                {% else %}
                                                                    <span class="trend-down"><i class="bx bx-x-circle"></i> Con p√©rdidas</span>
                                                                {% endif %}
                                                            {% else %}
                                                                <span class="trend-stable">No disponible</span>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="metric-card metric-efficiency">
                                                    <div class="metric-icon">
                                                        <i class="bx bx-cog"></i>
                                                    </div>
                                                    <div class="metric-content">
                                                        <div class="metric-value">
                                                            {% if totales_acumulativos.EOG and all_variables_extracted|length > 0 %}
                                                                {% widthratio totales_acumulativos.EOG.total 1 all_variables_extracted|length as avg_eff %}
                                                                {% widthratio avg_eff 1 100 as eff_percent %}
                                                                {{ eff_percent|floatformat:1 }}%
                                                            {% else %}
                                                                0.0%
                                                            {% endif %}
                                                        </div>
                                                        <div class="metric-label">Eficiencia Operativa</div>
                                                        <div class="metric-trend">
                                                            {% if eff_percent >= 80 %}
                                                                <span class="trend-up"><i class="bx bx-check"></i> Excelente</span>
                                                            {% elif eff_percent >= 60 %}
                                                                <span class="trend-stable"><i class="bx bx-info-circle"></i> Buena</span>
                                                            {% else %}
                                                                <span class="trend-down"><i class="bx bx-error"></i> Necesita mejora</span>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="metric-card metric-margin">
                                                    <div class="metric-icon">
                                                        <i class="bx bx-percentage"></i>
                                                    </div>
                                                    <div class="metric-content">
                                                        <div class="metric-value">
                                                            {% if totales_acumulativos.NR and all_variables_extracted|length > 0 %}
                                                                {% widthratio totales_acumulativos.NR.total 1 all_variables_extracted|length as avg_margin %}
                                                                {% widthratio avg_margin 1 100 as margin_percent %}
                                                                {{ margin_percent|floatformat:1 }}%
                                                            {% else %}
                                                                0.0%
                                                            {% endif %}
                                                        </div>
                                                        <div class="metric-label">Margen de Rentabilidad</div>
                                                        <div class="metric-trend">
                                                            {% if margin_percent >= 20 %}
                                                                <span class="trend-up"><i class="bx bx-star"></i> Excelente</span>
                                                            {% elif margin_percent >= 10 %}
                                                                <span class="trend-stable"><i class="bx bx-check"></i> Aceptable</span>
                                                            {% else %}
                                                                <span class="trend-down"><i class="bx bx-error"></i> Bajo</span>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Gr√°ficos principales del overview -->
                                <div class="row mb-4">
                                    <div class="col-lg-6 mb-4">
                                        <div class="chart-container">
                                            <div class="chart-header">
                                                <h6 class="chart-title mb-3">
                                                    <i class="bx bx-dollar me-2"></i>
                                                    Evoluci√≥n Financiera: Ingresos vs Ganancias
                                                </h6>
                                                <div class="chart-controls">
                                                    {% if image_data_ingresos_gastos %}
                                                    <div class="chart-control-btn" onclick="downloadChart('{{ image_data_ingresos_gastos }}', 'ingresos-ganancias.png')" title="Descargar">
                                                        <i class="bx bx-download"></i>
                                                    </div>
                                                    <div class="chart-control-btn" onclick="openFullscreen('{{ image_data_ingresos_gastos }}', 'Ingresos vs Ganancias')" title="Pantalla completa">
                                                        <i class="bx bx-fullscreen"></i>
                                                    </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            {% if image_data_ingresos_gastos %}
                                            <img src="data:image/png;base64,{{ image_data_ingresos_gastos }}" 
                                                class="chart-image" 
                                                alt="Evoluci√≥n Financiera: Ingresos vs Ganancias"
                                                loading="lazy">
                                            {% else %}
                                            <div class="chart-placeholder">
                                                <i class="bx bx-chart text-muted" style="font-size: 3rem;"></i>
                                                <p class="text-muted mt-2">Gr√°fico financiero no disponible</p>
                                                <small class="text-muted">Los datos se generar√°n durante el an√°lisis</small>
                                            </div>
                                            {% endif %}
                                            <div class="chart-summary">
                                                <small class="text-muted">
                                                    {% if totales_acumulativos.IT and totales_acumulativos.GT %}
                                                        Rendimiento financiero: 
                                                        {% if totales_acumulativos.GT.total > 0 %}
                                                            <span class="text-success">Positivo</span> - 
                                                            Margen del {{ margin_percent|floatformat:1 }}%
                                                        {% else %}
                                                            <span class="text-danger">Requiere optimizaci√≥n</span>
                                                        {% endif %}
                                                    {% else %}
                                                        An√°lisis financiero en proceso
                                                    {% endif %}
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-lg-6 mb-4">
                                        <div class="chart-container">
                                            <div class="chart-header">
                                                <h6 class="chart-title mb-3">
                                                    <i class="bx bx-line-chart me-2"></i>
                                                    Comportamiento de la Demanda
                                                </h6>
                                                <div class="chart-controls">
                                                    {% if image_data_simulation %}
                                                    <div class="chart-control-btn" onclick="downloadChart('{{ image_data_simulation }}', 'tendencia-demanda.png')" title="Descargar">
                                                        <i class="bx bx-download"></i>
                                                    </div>
                                                    <div class="chart-control-btn" onclick="openFullscreen('{{ image_data_simulation }}', 'Tendencia de Demanda')" title="Pantalla completa">
                                                        <i class="bx bx-fullscreen"></i>
                                                    </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            {% if image_data_simulation %}
                                            <img src="data:image/png;base64,{{ image_data_simulation }}" 
                                                class="chart-image" 
                                                alt="Comportamiento de la Demanda"
                                                loading="lazy">
                                            {% else %}
                                            <div class="chart-placeholder">
                                                <i class="bx bx-chart text-muted" style="font-size: 3rem;"></i>
                                                <p class="text-muted mt-2">Gr√°fico de demanda no disponible</p>
                                                <small class="text-muted">Los datos se generar√°n durante el an√°lisis</small>
                                            </div>
                                            {% endif %}
                                            <div class="chart-summary">
                                                <small class="text-muted">
                                                    {% if growth_rate %}
                                                        Tendencia de crecimiento: 
                                                        {% if growth_rate > 0 %}
                                                            <span class="text-success">+{{ growth_rate|floatformat:2 }}%</span> - Creciente
                                                        {% elif growth_rate < 0 %}
                                                            <span class="text-danger">{{ growth_rate|floatformat:2 }}%</span> - Decreciente
                                                        {% else %}
                                                            <span class="text-info">{{ growth_rate|floatformat:2 }}%</span> - Estable
                                                        {% endif %}
                                                    {% else %}
                                                        An√°lisis de tendencia en proceso
                                                    {% endif %}
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Gr√°ficos adicionales de overview -->
                                <div class="row mb-4">
                                    <div class="col-lg-4 mb-3">
                                        <div class="chart-container compact">
                                            <h6 class="chart-title mb-3">
                                                <i class="bx bx-pie-chart me-2"></i>
                                                Distribuci√≥n de Costos
                                            </h6>
                                            {% if image_data_costos or image_data_gastos %}
                                            <img src="data:image/png;base64,{{ image_data_costos|default:image_data_gastos }}" 
                                                class="chart-image" 
                                                alt="Distribuci√≥n de Costos"
                                                loading="lazy">
                                            {% else %}
                                            <div class="chart-placeholder compact">
                                                <i class="bx bx-pie-chart text-muted" style="font-size: 2rem;"></i>
                                                <p class="text-muted mt-2">No disponible</p>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>

                                    <div class="col-lg-4 mb-3">
                                        <div class="chart-container compact">
                                            <h6 class="chart-title mb-3">
                                                <i class="bx bx-bar-chart me-2"></i>
                                                Eficiencia Operativa
                                            </h6>
                                            {% if image_data_eficiencia %}
                                            <img src="data:image/png;base64,{{ image_data_eficiencia }}" 
                                                class="chart-image" 
                                                alt="Eficiencia Operativa"
                                                loading="lazy">
                                            {% else %}
                                            <div class="chart-placeholder compact">
                                                <i class="bx bx-bar-chart text-muted" style="font-size: 2rem;"></i>
                                                <p class="text-muted mt-2">No disponible</p>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>

                                    <div class="col-lg-4 mb-3">
                                        <div class="chart-container compact">
                                            <h6 class="chart-title mb-3">
                                                <i class="bx bx-trending-up me-2"></i>
                                                An√°lisis de ROI
                                            </h6>
                                            {% if image_data_roi or image_data_kpis %}
                                            <img src="data:image/png;base64,{{ image_data_roi|default:image_data_kpis }}" 
                                                class="chart-image" 
                                                alt="An√°lisis de ROI"
                                                loading="lazy">
                                            {% else %}
                                            <div class="chart-placeholder compact">
                                                <i class="bx bx-trending-up text-muted" style="font-size: 2rem;"></i>
                                                <p class="text-muted mt-2">No disponible</p>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>

                                <!-- Resumen de insights y recomendaciones -->
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <div class="insights-overview">
                                            <h4 class="insights-title mb-4">
                                                <i class="bx bx-lightbulb me-2"></i>
                                                Insights Principales y Recomendaciones
                                            </h4>
                                            <div class="row">
                                                <div class="col-lg-8">
                                                    <div class="insights-list">
                                                        <!-- Insight financiero -->
                                                        <div class="insight-item">
                                                            <div class="insight-icon bg-success">
                                                                <i class="bx bx-dollar"></i>
                                                            </div>
                                                            <div class="insight-content">
                                                                <h6 class="insight-title">Performance Financiera</h6>
                                                                <p class="insight-description">
                                                                    {% if totales_acumulativos.GT %}
                                                                        {% if totales_acumulativos.GT.total > 0 %}
                                                                            La simulaci√≥n proyecta una rentabilidad positiva de 
                                                                            <strong>Bs. {{ totales_acumulativos.GT.total|floatformat:2 }}</strong>, 
                                                                            indicando un modelo de negocio viable.
                                                                        {% else %}
                                                                            Los resultados muestran necesidad de optimizaci√≥n en costos y 
                                                                            estrategias de precios para alcanzar rentabilidad.
                                                                        {% endif %}
                                                                    {% else %}
                                                                        An√°lisis financiero en proceso de c√°lculo.
                                                                    {% endif %}
                                                                </p>
                                                            </div>
                                                        </div>

                                                        <!-- Insight operativo -->
                                                        <div class="insight-item">
                                                            <div class="insight-icon bg-info">
                                                                <i class="bx bx-cog"></i>
                                                            </div>
                                                            <div class="insight-content">
                                                                <h6 class="insight-title">Eficiencia Operativa</h6>
                                                                <p class="insight-description">
                                                                    {% if eff_percent %}
                                                                        La eficiencia operativa promedio del {{ eff_percent|floatformat:1 }}% 
                                                                        {% if eff_percent >= 80 %}
                                                                            demuestra procesos optimizados y alta productividad.
                                                                        {% elif eff_percent >= 60 %}
                                                                            indica un rendimiento aceptable con oportunidades de mejora.
                                                                        {% else %}
                                                                            requiere atenci√≥n inmediata para optimizar procesos y recursos.
                                                                        {% endif %}
                                                                    {% else %}
                                                                        Los indicadores operativos est√°n siendo analizados para identificar oportunidades de mejora.
                                                                    {% endif %}
                                                                </p>
                                                            </div>
                                                        </div>

                                                        <!-- Insight de demanda -->
                                                        <div class="insight-item">
                                                            <div class="insight-icon bg-warning">
                                                                <i class="bx bx-trending-up"></i>
                                                            </div>
                                                            <div class="insight-content">
                                                                <h6 class="insight-title">Comportamiento de Demanda</h6>
                                                                <p class="insight-description">
                                                                    {% if growth_rate %}
                                                                        El an√°lisis revela una tasa de crecimiento del {{ growth_rate|floatformat:2 }}%, 
                                                                        {% if growth_rate > 0 %}
                                                                            sugiriendo oportunidades de expansi√≥n y crecimiento del mercado.
                                                                        {% elif growth_rate < 0 %}
                                                                            indicando la necesidad de estrategias para revertir la tendencia.
                                                                        {% else %}
                                                                            mostrando un mercado estable con demanda predecible.
                                                                        {% endif %}
                                                                    {% else %}
                                                                        El comportamiento de la demanda est√° siendo analizado para identificar patrones y tendencias.
                                                                    {% endif %}
                                                                </p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="col-lg-4">
                                                    <div class="recommendations-card">
                                                        <h6 class="recommendations-title">
                                                            <i class="bx bx-check-square me-2"></i>
                                                            Acciones Recomendadas
                                                        </h6>
                                                        <div class="recommendations-list">
                                                            {% if margin_percent < 15 %}
                                                            <div class="recommendation-item">
                                                                <i class="bx bx-arrow-to-right text-danger"></i>
                                                                <span>Revisar estructura de costos</span>
                                                            </div>
                                                            {% endif %}
                                                            
                                                            {% if eff_percent < 70 %}
                                                            <div class="recommendation-item">
                                                                <i class="bx bx-arrow-to-right text-warning"></i>
                                                                <span>Optimizar procesos operativos</span>
                                                            </div>
                                                            {% endif %}
                                                            
                                                            {% if growth_rate > 5 %}
                                                            <div class="recommendation-item">
                                                                <i class="bx bx-arrow-to-right text-success"></i>
                                                                <span>Considerar expansi√≥n de capacidad</span>
                                                            </div>
                                                            {% elif growth_rate < -2 %}
                                                            <div class="recommendation-item">
                                                                <i class="bx bx-arrow-to-right text-info"></i>
                                                                <span>Desarrollar estrategias de mercado</span>
                                                            </div>
                                                            {% endif %}

                                                            <div class="recommendation-item">
                                                                <i class="bx bx-arrow-to-right text-primary"></i>
                                                                <span>Monitorear KPIs continuamente</span>
                                                            </div>

                                                            <div class="recommendation-item">
                                                                <i class="bx bx-arrow-to-right text-secondary"></i>
                                                                <span>Implementar mejora continua</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Financial Tab - Actualizaci√≥n completa -->
                            <div class="tab-pane fade" id="financial" role="tabpanel">
                                
                                <!-- Header con resumen financiero -->
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <div class="alert alert-success">
                                            <h4 class="alert-heading mb-3">
                                                <i class="bx bx-dollar-circle me-2"></i>
                                                An√°lisis Financiero Integral
                                            </h4>
                                            <p class="mb-2">
                                                An√°lisis completo de la performance financiera de la simulaci√≥n, incluyendo ingresos, gastos, 
                                                rentabilidad y m√©tricas clave de rendimiento financiero.
                                            </p>
                                            <small class="text-muted">
                                                Per√≠odo analizado: <strong>{{ all_variables_extracted|length|default:0 }} d√≠as</strong> | 
                                                {% if totales_acumulativos.GT %}
                                                    Ganancia total: <strong>Bs. {{ totales_acumulativos.GT.total|floatformat:2|default:"0.00" }}</strong>
                                                {% endif %}
                                            </small>
                                        </div>
                                    </div>
                                </div>

                                <!-- M√©tricas financieras principales -->
                                <div class="row mb-4">
                                    <div class="col-md-3">
                                        <div class="card bg-gradient-success text-white">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between">
                                                    <div>
                                                        <h6 class="text-white-50">Ingresos Totales</h6>
                                                        <h3 class="mb-0">
                                                            {% if totales_acumulativos.IT %}
                                                                Bs. {{ totales_acumulativos.IT.total|floatformat:0|default:"0" }}
                                                            {% else %}
                                                                Bs. 0
                                                            {% endif %}
                                                        </h3>
                                                    </div>
                                                    <div class="align-self-center">
                                                        <i class="bx bx-dollar display-6"></i>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card bg-gradient-danger text-white">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between">
                                                    <div>
                                                        <h6 class="text-white-50">Gastos Totales</h6>
                                                        <h3 class="mb-0">
                                                            {% if totales_acumulativos.TG %}
                                                                Bs. {{ totales_acumulativos.TG.total|floatformat:0|default:"0" }}
                                                            {% else %}
                                                                Bs. 0
                                                            {% endif %}
                                                        </h3>
                                                    </div>
                                                    <div class="align-self-center">
                                                        <i class="bx bx-trending-down display-6"></i>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card bg-gradient-primary text-white">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between">
                                                    <div>
                                                        <h6 class="text-white-50">Ganancia Neta</h6>
                                                        <h3 class="mb-0">
                                                            {% if totales_acumulativos.GT %}
                                                                Bs. {{ totales_acumulativos.GT.total|floatformat:0|default:"0" }}
                                                            {% else %}
                                                                Bs. 0
                                                            {% endif %}
                                                        </h3>
                                                    </div>
                                                    <div class="align-self-center">
                                                        <i class="bx bx-trending-up display-6"></i>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card bg-gradient-info text-white">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between">
                                                    <div>
                                                        <h6 class="text-white-50">Margen Promedio</h6>
                                                        <h3 class="mb-0">
                                                            {% if totales_acumulativos.NR %}
                                                                {% widthratio totales_acumulativos.NR.total 1 all_variables_extracted|length as avg_margin %}
                                                                {% widthratio avg_margin 1 100 as margin_percent %}
                                                                {{ margin_percent|floatformat:1 }}%
                                                            {% else %}
                                                                0.0%
                                                            {% endif %}
                                                        </h3>
                                                    </div>
                                                    <div class="align-self-center">
                                                        <i class="bx bx-percentage display-6"></i>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Gr√°ficos principales -->
                                <div class="row">
                                    <!-- Ingresos vs Ganancias -->
                                    <div class="col-md-6 mb-4">
                                        <div class="chart-container">
                                            <div class="chart-header">
                                                <h6 class="mb-3">
                                                    <i class="bx bx-dollar me-2"></i>
                                                    Evoluci√≥n de Ingresos vs Ganancias
                                                </h6>
                                                <div class="chart-controls">
                                                    {% if image_data_ingresos_gastos %}
                                                    <div class="chart-control-btn" onclick="downloadChart('{{ image_data_ingresos_gastos }}', 'ingresos-ganancias.png')" title="Descargar">
                                                        <i class="bx bx-download"></i>
                                                    </div>
                                                    <div class="chart-control-btn" onclick="openFullscreen('{{ image_data_ingresos_gastos }}', 'Ingresos vs Ganancias')" title="Pantalla completa">
                                                        <i class="bx bx-fullscreen"></i>
                                                    </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            {% if image_data_ingresos_gastos %}
                                            <img src="data:image/png;base64,{{ image_data_ingresos_gastos }}" 
                                                class="chart-image" 
                                                alt="Evoluci√≥n de Ingresos vs Ganancias"
                                                loading="lazy">
                                            {% else %}
                                            <div class="chart-placeholder">
                                                <i class="bx bx-chart text-muted" style="font-size: 3rem;"></i>
                                                <p class="text-muted mt-2">Gr√°fico de ingresos vs ganancias no disponible</p>
                                                <small class="text-muted">Los datos se generar√°n durante el an√°lisis</small>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    
                                    <!-- An√°lisis de Gastos -->
                                    <div class="col-md-6 mb-4">
                                        <div class="chart-container">
                                            <div class="chart-header">
                                                <h6 class="mb-3">
                                                    <i class="bx bx-trending-down me-2"></i>
                                                    Composici√≥n y Evoluci√≥n de Gastos
                                                </h6>
                                                <div class="chart-controls">
                                                    {% if image_data_gastos or image_data_rentabilidad %}
                                                    <div class="chart-control-btn" onclick="downloadChart('{{ image_data_gastos|default:image_data_rentabilidad }}', 'analisis-gastos.png')" title="Descargar">
                                                        <i class="bx bx-download"></i>
                                                    </div>
                                                    <div class="chart-control-btn" onclick="openFullscreen('{{ image_data_gastos|default:image_data_rentabilidad }}', 'An√°lisis de Gastos')" title="Pantalla completa">
                                                        <i class="bx bx-fullscreen"></i>
                                                    </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            {% if image_data_gastos %}
                                            <img src="data:image/png;base64,{{ image_data_gastos }}" 
                                                class="chart-image" 
                                                alt="An√°lisis de gastos"
                                                loading="lazy">
                                            {% elif image_data_rentabilidad %}
                                            <img src="data:image/png;base64,{{ image_data_rentabilidad }}" 
                                                class="chart-image" 
                                                alt="An√°lisis de rentabilidad y gastos"
                                                loading="lazy">
                                            {% else %}
                                            <div class="chart-placeholder">
                                                <i class="bx bx-chart text-muted" style="font-size: 3rem;"></i>
                                                <p class="text-muted mt-2">Gr√°fico de an√°lisis de gastos no disponible</p>
                                                <small class="text-muted">Los datos se generar√°n durante el an√°lisis</small>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    
                                    <!-- Costos de Producci√≥n -->
                                    <div class="col-md-6 mb-4">
                                        <div class="chart-container">
                                            <div class="chart-header">
                                                <h6 class="mb-3">
                                                    <i class="bx bx-calculator me-2"></i>
                                                    Estructura de Costos de Producci√≥n
                                                </h6>
                                                <div class="chart-controls">
                                                    {% if image_data_costos or image_data_eficiencia %}
                                                    <div class="chart-control-btn" onclick="downloadChart('{{ image_data_costos|default:image_data_eficiencia }}', 'costos-produccion.png')" title="Descargar">
                                                        <i class="bx bx-download"></i>
                                                    </div>
                                                    <div class="chart-control-btn" onclick="openFullscreen('{{ image_data_costos|default:image_data_eficiencia }}', 'Costos de Producci√≥n')" title="Pantalla completa">
                                                        <i class="bx bx-fullscreen"></i>
                                                    </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            {% if image_data_costos %}
                                            <img src="data:image/png;base64,{{ image_data_costos }}" 
                                                class="chart-image" 
                                                alt="Costos de producci√≥n"
                                                loading="lazy">
                                            {% elif image_data_eficiencia %}
                                            <img src="data:image/png;base64,{{ image_data_eficiencia }}" 
                                                class="chart-image" 
                                                alt="Eficiencia y costos"
                                                loading="lazy">
                                            {% else %}
                                            <div class="chart-placeholder">
                                                <i class="bx bx-chart text-muted" style="font-size: 3rem;"></i>
                                                <p class="text-muted mt-2">Gr√°fico de costos de producci√≥n no disponible</p>
                                                <small class="text-muted">Los datos se generar√°n durante el an√°lisis</small>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>

                                    <!-- Rentabilidad y ROI -->
                                    <div class="col-md-6 mb-4">
                                        <div class="chart-container">
                                            <div class="chart-header">
                                                <h6 class="mb-3">
                                                    <i class="bx bx-stats me-2"></i>
                                                    Rentabilidad y ROI
                                                </h6>
                                                <div class="chart-controls">
                                                    {% if image_data_roi or image_data_kpis %}
                                                    <div class="chart-control-btn" onclick="downloadChart('{{ image_data_roi|default:image_data_kpis }}', 'roi-rentabilidad.png')" title="Descargar">
                                                        <i class="bx bx-download"></i>
                                                    </div>
                                                    <div class="chart-control-btn" onclick="openFullscreen('{{ image_data_roi|default:image_data_kpis }}', 'ROI y Rentabilidad')" title="Pantalla completa">
                                                        <i class="bx bx-fullscreen"></i>
                                                    </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            {% if image_data_roi %}
                                            <img src="data:image/png;base64,{{ image_data_roi }}" 
                                                class="chart-image" 
                                                alt="ROI y rentabilidad"
                                                loading="lazy">
                                            {% elif image_data_kpis %}
                                            <img src="data:image/png;base64,{{ image_data_kpis }}" 
                                                class="chart-image" 
                                                alt="KPIs financieros"
                                                loading="lazy">
                                            {% else %}
                                            <div class="chart-placeholder">
                                                <i class="bx bx-chart text-muted" style="font-size: 3rem;"></i>
                                                <p class="text-muted mt-2">Gr√°fico de ROI y rentabilidad no disponible</p>
                                                <small class="text-muted">Los datos se generar√°n durante el an√°lisis</small>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>

                                <!-- Gr√°ficos de variables financieras end√≥genas -->
                                {% if endogenous_charts %}
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <h5 class="mb-3">
                                            <i class="bx bx-line-chart me-2"></i>
                                            Variables Financieras End√≥genas
                                        </h5>
                                    </div>
                                    
                                    {% for chart_name, chart_data in endogenous_charts.items %}
                                        {% if 'IT' in chart_name or 'GT' in chart_name or 'TG' in chart_name or 'NR' in chart_name %}
                                        <div class="col-md-6 mb-4">
                                            <div class="chart-container">
                                                <div class="chart-header">
                                                    <h6 class="mb-3">
                                                        {% if 'IT' in chart_name %}
                                                            <i class="bx bx-dollar text-success me-2"></i>Evoluci√≥n de Ingresos Totales
                                                        {% elif 'GT' in chart_name %}
                                                            <i class="bx bx-trending-up text-primary me-2"></i>Evoluci√≥n de Ganancia Total
                                                        {% elif 'TG' in chart_name %}
                                                            <i class="bx bx-trending-down text-danger me-2"></i>Evoluci√≥n de Total Gastos
                                                        {% elif 'NR' in chart_name %}
                                                            <i class="bx bx-percentage text-info me-2"></i>Evoluci√≥n del Nivel de Rentabilidad
                                                        {% endif %}
                                                    </h6>
                                                    <div class="chart-controls">
                                                        <div class="chart-control-btn" onclick="downloadChart('{{ chart_data }}', '{{ chart_name }}.png')" title="Descargar">
                                                            <i class="bx bx-download"></i>
                                                        </div>
                                                        <div class="chart-control-btn" onclick="openFullscreen('{{ chart_data }}', '{{ chart_name }}')" title="Pantalla completa">
                                                            <i class="bx bx-fullscreen"></i>
                                                        </div>
                                                    </div>
                                                </div>
                                                <img src="data:image/png;base64,{{ chart_data }}" 
                                                    class="chart-image" 
                                                    alt="{{ chart_name }}"
                                                    loading="lazy">
                                            </div>
                                        </div>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                                {% endif %}

                                <!-- An√°lisis financiero detallado -->
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <h5 class="mb-3">
                                            <i class="bx bx-analytics me-2"></i>
                                            An√°lisis Financiero Detallado
                                        </h5>
                                    </div>
                                    
                                    <!-- Flujo de caja y liquidez -->
                                    <div class="col-lg-6 mb-4">
                                        <div class="chart-container">
                                            <div class="chart-header">
                                                <h6 class="mb-3">
                                                    <i class="bx bx-money me-2"></i>
                                                    Flujo de Caja Operativo
                                                </h6>
                                                <div class="chart-controls">
                                                    {% if image_data_flujo_caja or additional_analisis_costos_detallado %}
                                                    <div class="chart-control-btn" onclick="downloadChart('{{ image_data_flujo_caja|default:additional_analisis_costos_detallado }}', 'flujo-caja.png')" title="Descargar">
                                                        <i class="bx bx-download"></i>
                                                    </div>
                                                    <div class="chart-control-btn" onclick="openFullscreen('{{ image_data_flujo_caja|default:additional_analisis_costos_detallado }}', 'Flujo de Caja')" title="Pantalla completa">
                                                        <i class="bx bx-fullscreen"></i>
                                                    </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            {% if image_data_flujo_caja %}
                                            <img src="data:image/png;base64,{{ image_data_flujo_caja }}" 
                                                class="chart-image" 
                                                alt="Flujo de caja operativo"
                                                loading="lazy">
                                            {% elif additional_analisis_costos_detallado %}
                                            <img src="data:image/png;base64,{{ additional_analisis_costos_detallado }}" 
                                                class="chart-image" 
                                                alt="An√°lisis detallado de costos"
                                                loading="lazy">
                                            {% else %}
                                            <div class="chart-placeholder">
                                                <i class="bx bx-chart text-muted" style="font-size: 3rem;"></i>
                                                <p class="text-muted mt-2">Gr√°fico de flujo de caja no disponible</p>
                                                <small class="text-muted">Los datos se generar√°n durante el an√°lisis</small>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>

                                    <!-- Indicadores de eficiencia financiera -->
                                    <div class="col-lg-6 mb-4">
                                        <div class="chart-container">
                                            <div class="chart-header">
                                                <h6 class="mb-3">
                                                    <i class="bx bx-tachometer me-2"></i>
                                                    Indicadores de Eficiencia Financiera
                                                </h6>
                                                <div class="chart-controls">
                                                    {% if image_data_indicadores or additional_eficiencia_operativa %}
                                                    <div class="chart-control-btn" onclick="downloadChart('{{ image_data_indicadores|default:additional_eficiencia_operativa }}', 'indicadores-financieros.png')" title="Descargar">
                                                        <i class="bx bx-download"></i>
                                                    </div>
                                                    <div class="chart-control-btn" onclick="openFullscreen('{{ image_data_indicadores|default:additional_eficiencia_operativa }}', 'Indicadores Financieros')" title="Pantalla completa">
                                                        <i class="bx bx-fullscreen"></i>
                                                    </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            {% if image_data_indicadores %}
                                            <img src="data:image/png;base64,{{ image_data_indicadores }}" 
                                                class="chart-image" 
                                                alt="Indicadores de eficiencia financiera"
                                                loading="lazy">
                                            {% elif additional_eficiencia_operativa %}
                                            <img src="data:image/png;base64,{{ additional_eficiencia_operativa }}" 
                                                class="chart-image" 
                                                alt="Eficiencia operativa"
                                                loading="lazy">
                                            {% else %}
                                            <div class="chart-placeholder">
                                                <i class="bx bx-chart text-muted" style="font-size: 3rem;"></i>
                                                <p class="text-muted mt-2">Gr√°fico de indicadores financieros no disponible</p>
                                                <small class="text-muted">Los datos se generar√°n durante el an√°lisis</small>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>

                                <!-- Proyecciones y tendencias -->
                                {% if image_data_proyecciones or image_data_tendencias %}
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <h5 class="mb-3">
                                            <i class="bx bx-trending-up me-2"></i>
                                            Proyecciones y Tendencias Financieras
                                        </h5>
                                    </div>
                                    
                                    {% if image_data_proyecciones %}
                                    <div class="col-lg-6 mb-4">
                                        <div class="chart-container">
                                            <div class="chart-header">
                                                <h6 class="mb-3">
                                                    <i class="bx bx-line-chart me-2"></i>
                                                    Proyecciones Financieras
                                                </h6>
                                                <div class="chart-controls">
                                                    <div class="chart-control-btn" onclick="downloadChart('{{ image_data_proyecciones }}', 'proyecciones-financieras.png')" title="Descargar">
                                                        <i class="bx bx-download"></i>
                                                    </div>
                                                    <div class="chart-control-btn" onclick="openFullscreen('{{ image_data_proyecciones }}', 'Proyecciones Financieras')" title="Pantalla completa">
                                                        <i class="bx bx-fullscreen"></i>
                                                    </div>
                                                </div>
                                            </div>
                                            <img src="data:image/png;base64,{{ image_data_proyecciones }}" 
                                                class="chart-image" 
                                                alt="Proyecciones financieras"
                                                loading="lazy">
                                        </div>
                                    </div>
                                    {% endif %}

                                    {% if image_data_tendencias %}
                                    <div class="col-lg-6 mb-4">
                                        <div class="chart-container">
                                            <div class="chart-header">
                                                <h6 class="mb-3">
                                                    <i class="bx bx-stats me-2"></i>
                                                    An√°lisis de Tendencias
                                                </h6>
                                                <div class="chart-controls">
                                                    <div class="chart-control-btn" onclick="downloadChart('{{ image_data_tendencias }}', 'tendencias-financieras.png')" title="Descargar">
                                                        <i class="bx bx-download"></i>
                                                    </div>
                                                    <div class="chart-control-btn" onclick="openFullscreen('{{ image_data_tendencias }}', 'Tendencias Financieras')" title="Pantalla completa">
                                                        <i class="bx bx-fullscreen"></i>
                                                    </div>
                                                </div>
                                            </div>
                                            <img src="data:image/png;base64,{{ image_data_tendencias }}" 
                                                class="chart-image" 
                                                alt="An√°lisis de tendencias"
                                                loading="lazy">
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                                {% endif %}

                                <!-- Tabla resumen financiero -->
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <div class="card">
                                            <div class="card-header">
                                                <h5 class="card-title mb-0">
                                                    <i class="bx bx-table me-2"></i>
                                                    Resumen Financiero por Variable
                                                </h5>
                                            </div>
                                            <div class="card-body">
                                                <div class="table-responsive">
                                                    <table class="table table-hover">
                                                        <thead>
                                                            <tr>
                                                                <th>Variable Financiera</th>
                                                                <th>Valor Total</th>
                                                                <th>Promedio Diario</th>
                                                                <th>Tendencia</th>
                                                                <th>Estado</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {% for name_variable, info_variable in totales_acumulativos.items %}
                                                                {% if 'IT' in name_variable or 'GT' in name_variable or 'TG' in name_variable or 'NR' in name_variable or 'PVP' in name_variable or 'CFD' in name_variable or 'CVU' in name_variable %}
                                                                <tr>
                                                                    <td>
                                                                        <strong>
                                                                            {% if name_variable == 'IT' %}Ingresos Totales
                                                                            {% elif name_variable == 'GT' %}Ganancia Total
                                                                            {% elif name_variable == 'TG' %}Total Gastos
                                                                            {% elif name_variable == 'NR' %}Nivel de Rentabilidad
                                                                            {% elif name_variable == 'PVP' %}Precio de Venta al P√∫blico
                                                                            {% elif name_variable == 'CFD' %}Costo Fijo Diario
                                                                            {% elif name_variable == 'CVU' %}Costo Variable Unitario
                                                                            {% else %}{{ name_variable }}
                                                                            {% endif %}
                                                                        </strong>
                                                                        <br>
                                                                        <small class="text-muted">{{ name_variable }}</small>
                                                                    </td>
                                                                    <td class="fw-bold">
                                                                        {% if info_variable.unit == "BS" %}
                                                                            <span class="text-success">Bs. {{ info_variable.total|floatformat:2 }}</span>
                                                                        {% elif "%" in info_variable.unit %}
                                                                            <span class="text-info">{{ info_variable.total|floatformat:3 }}</span>
                                                                        {% else %}
                                                                            {{ info_variable.total|floatformat:2 }}
                                                                        {% endif %}
                                                                    </td>
                                                                    <td>
                                                                        {% if all_variables_extracted|length > 0 %}
                                                                            {% widthratio info_variable.total 1 all_variables_extracted|length as daily_avg %}
                                                                            {% if info_variable.unit == "BS" %}
                                                                                Bs. {{ daily_avg|floatformat:2 }}
                                                                            {% elif "%" in info_variable.unit %}
                                                                                {{ daily_avg|floatformat:3 }}
                                                                            {% else %}
                                                                                {{ daily_avg|floatformat:2 }}
                                                                            {% endif %}
                                                                        {% else %}
                                                                            N/A
                                                                        {% endif %}
                                                                    </td>
                                                                    <td>
                                                                        {% if info_variable.trend == "increasing" %}
                                                                            <span class="badge bg-success">
                                                                                <i class="bx bx-trending-up me-1"></i>Creciente
                                                                            </span>
                                                                        {% elif info_variable.trend == "decreasing" %}
                                                                            <span class="badge bg-danger">
                                                                                <i class="bx bx-trending-down me-1"></i>Decreciente
                                                                            </span>
                                                                        {% else %}
                                                                            <span class="badge bg-secondary">
                                                                                <i class="bx bx-minus me-1"></i>Estable
                                                                            </span>
                                                                        {% endif %}
                                                                    </td>
                                                                    <td>
                                                                        {% if name_variable == 'GT' %}
                                                                            {% if info_variable.total > 0 %}
                                                                                <span class="badge bg-success">Rentable</span>
                                                                            {% else %}
                                                                                <span class="badge bg-danger">Con p√©rdidas</span>
                                                                            {% endif %}
                                                                        {% elif name_variable == 'NR' %}
                                                                            {% if info_variable.total > 0.2 %}
                                                                                <span class="badge bg-success">Excelente</span>
                                                                            {% elif info_variable.total > 0.1 %}
                                                                                <span class="badge bg-warning">Bueno</span>
                                                                            {% else %}
                                                                                <span class="badge bg-danger">Bajo</span>
                                                                            {% endif %}
                                                                        {% else %}
                                                                            <span class="badge bg-info">Normal</span>
                                                                        {% endif %}
                                                                    </td>
                                                                </tr>
                                                                {% endif %}
                                                            {% empty %}
                                                            <tr>
                                                                <td colspan="5" class="text-center py-4">
                                                                    <i class="bx bx-info-circle display-4 text-muted"></i>
                                                                    <h6 class="mt-2 text-muted">No hay datos financieros disponibles</h6>
                                                                    <small class="text-muted">Los datos se generar√°n durante el procesamiento de la simulaci√≥n.</small>
                                                                </td>
                                                            </tr>
                                                            {% endfor %}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Recomendaciones financieras -->
                                {% if financial_recommendations %}
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <div class="card">
                                            <div class="card-header">
                                                <h5 class="card-title mb-0">
                                                    <i class="bx bx-lightbulb me-2"></i>
                                                    Recomendaciones Financieras
                                                </h5>
                                            </div>
                                            <div class="card-body">
                                                <div class="row">
                                                    {% for recommendation in financial_recommendations %}
                                                    <div class="col-md-6 mb-3">
                                                        <div class="alert alert-{{ recommendation.type|default:'info' }} alert-dismissible">
                                                            <h6 class="alert-heading">
                                                                {% if recommendation.type == 'success' %}
                                                                    <i class="bx bx-check-circle me-2"></i>
                                                                {% elif recommendation.type == 'warning' %}
                                                                    <i class="bx bx-error me-2"></i>
                                                                {% elif recommendation.type == 'danger' %}
                                                                    <i class="bx bx-x-circle me-2"></i>
                                                                {% else %}
                                                                    <i class="bx bx-info-circle me-2"></i>
                                                                {% endif %}
                                                                {{ recommendation.title|default:'Recomendaci√≥n Financiera' }}
                                                            </h6>
                                                            <p class="mb-2">{{ recommendation.message }}</p>
                                                            {% if recommendation.priority %}
                                                            <small class="fw-bold">
                                                                Prioridad: 
                                                                <span class="badge bg-{{ recommendation.priority }}">
                                                                    {% if recommendation.priority == 'high' %}Alta
                                                                    {% elif recommendation.priority == 'medium' %}Media
                                                                    {% else %}Baja
                                                                    {% endif %}
                                                                </span>
                                                            </small>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                            <!-- Operations Tab - Versi√≥n Corregida -->
                            <div class="tab-pane fade" id="operations" role="tabpanel">
                                
                                <!-- Header operativo -->
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <div class="alert alert-info">
                                            <h4 class="alert-heading mb-3">
                                                <i class="bx bx-cog me-2"></i>
                                                An√°lisis Operativo Integral
                                            </h4>
                                            <p class="mb-2">
                                                An√°lisis completo de la eficiencia operativa, costos de producci√≥n y m√©tricas clave 
                                                durante {{ all_variables_extracted|length|default:0 }} d√≠as de simulaci√≥n.
                                            </p>
                                            <div class="row mt-3">
                                                <div class="col-md-3">
                                                    <strong>Productos Vendidos:</strong> 
                                                    <span class="text-primary">
                                                        {% if totales_acumulativos.TPV %}
                                                            {{ totales_acumulativos.TPV.total|floatformat:0 }}
                                                        {% else %}
                                                            0
                                                        {% endif %} unidades
                                                    </span>
                                                </div>
                                                <div class="col-md-3">
                                                    <strong>Eficiencia Promedio:</strong> 
                                                    {% if totales_acumulativos.EOG and all_variables_extracted|length > 0 %}
                                                        <span class="text-success">{{ totales_acumulativos.EOG.total|floatformat:1 }}%</span>
                                                    {% else %}
                                                        <span class="text-muted">Calculando...</span>
                                                    {% endif %}
                                                </div>
                                                <div class="col-md-3">
                                                    <strong>Personal:</strong>
                                                    {% if totales_acumulativos.NEPP %}
                                                        <span class="text-info">{{ totales_acumulativos.NEPP.total|floatformat:0 }} empleados</span>
                                                    {% else %}
                                                        <span class="text-muted">N/A</span>
                                                    {% endif %}
                                                </div>
                                                <div class="col-md-3">
                                                    <strong>D√≠as Analizados:</strong>
                                                    <span class="text-warning">{{ all_variables_extracted|length|default:0 }}</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- M√©tricas operativas principales -->
                                <div class="row mb-4">
                                    <div class="col-md-3">
                                        <div class="card bg-gradient-primary text-white">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between">
                                                    <div>
                                                        <h6 class="text-white-50">Productos Vendidos</h6>
                                                        <h3 class="mb-0">
                                                            {% if totales_acumulativos.TPV %}
                                                                {{ totales_acumulativos.TPV.total|floatformat:0 }}
                                                            {% else %}
                                                                0
                                                            {% endif %}
                                                        </h3>
                                                        <small class="text-white-75">Total del per√≠odo</small>
                                                    </div>
                                                    <div class="align-self-center">
                                                        <i class="bx bx-package display-6"></i>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-3">
                                        <div class="card bg-gradient-success text-white">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between">
                                                    <div>
                                                        <h6 class="text-white-50">Eficiencia Operativa</h6>
                                                        <h3 class="mb-0">
                                                            {% if totales_acumulativos.EOG %}
                                                                {{ totales_acumulativos.EOG.total|floatformat:1 }}%
                                                            {% else %}
                                                                0.0%
                                                            {% endif %}
                                                        </h3>
                                                        <small class="text-white-75">Promedio general</small>
                                                    </div>
                                                    <div class="align-self-center">
                                                        <i class="bx bx-tachometer display-6"></i>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-3">
                                        <div class="card bg-gradient-warning text-white">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between">
                                                    <div>
                                                        <h6 class="text-white-50">Capacidad Total</h6>
                                                        <h3 class="mb-0">
                                                            {% if totales_acumulativos.CPROD %}
                                                                {{ totales_acumulativos.CPROD.total|floatformat:0 }}
                                                            {% else %}
                                                                N/A
                                                            {% endif %}
                                                        </h3>
                                                        <small class="text-white-75">Litros/per√≠odo</small>
                                                    </div>
                                                    <div class="align-self-center">
                                                        <i class="bx bx-bar-chart display-6"></i>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-3">
                                        <div class="card bg-gradient-danger text-white">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between">
                                                    <div>
                                                        <h6 class="text-white-50">Costo Variable Unit.</h6>
                                                        <h3 class="mb-0">
                                                            {% if totales_acumulativos.CVU %}
                                                                Bs. {{ totales_acumulativos.CVU.total|floatformat:2 }}
                                                            {% else %}
                                                                Bs. 0.00
                                                            {% endif %}
                                                        </h3>
                                                        <small class="text-white-75">Promedio</small>
                                                    </div>
                                                    <div class="align-self-center">
                                                        <i class="bx bx-calculator display-6"></i>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Gr√°ficos operativos principales -->
                                <div class="row mb-4">
                                    <!-- Gr√°fico de Eficiencia Operativa -->
                                    <div class="col-lg-6 mb-4">
                                        <div class="chart-container">
                                            <div class="chart-header">
                                                <h6 class="chart-title mb-3">
                                                    <i class="bx bx-tachometer me-2"></i>
                                                    Indicadores de Eficiencia Operativa
                                                </h6>
                                                <div class="chart-controls">
                                                    {% if image_data_eficiencia %}
                                                    <div class="chart-control-btn" onclick="downloadChart('{{ image_data_eficiencia }}', 'eficiencia-operativa.png')" title="Descargar">
                                                        <i class="bx bx-download"></i>
                                                    </div>
                                                    <div class="chart-control-btn" onclick="openFullscreen('{{ image_data_eficiencia }}', 'Eficiencia Operativa')" title="Pantalla completa">
                                                        <i class="bx bx-fullscreen"></i>
                                                    </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            {% if image_data_eficiencia %}
                                            <img src="data:image/png;base64,{{ image_data_eficiencia }}" 
                                                class="chart-image" 
                                                alt="Indicadores de Eficiencia Operativa"
                                                loading="lazy">
                                            {% else %}
                                            <div class="chart-placeholder">
                                                <i class="bx bx-tachometer text-muted" style="font-size: 3rem;"></i>
                                                <p class="text-muted mt-2">Indicadores de eficiencia</p>
                                                <small class="text-muted">M√©tricas de rendimiento operativo</small>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    
                                    <!-- Gr√°fico de Costos Operativos -->
                                    <div class="col-lg-6 mb-4">
                                        <div class="chart-container">
                                            <div class="chart-header">
                                                <h6 class="chart-title mb-3">
                                                    <i class="bx bx-dollar-circle me-2"></i>
                                                    Evoluci√≥n de Costos Operativos
                                                </h6>
                                                <div class="chart-controls">
                                                    {% if image_data_5 %}
                                                    <div class="chart-control-btn" onclick="downloadChart('{{ image_data_5 }}', 'costos-operativos.png')" title="Descargar">
                                                        <i class="bx bx-download"></i>
                                                    </div>
                                                    <div class="chart-control-btn" onclick="openFullscreen('{{ image_data_5 }}', 'Costos Operativos')" title="Pantalla completa">
                                                        <i class="bx bx-fullscreen"></i>
                                                    </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            {% if image_data_5 %}
                                            <img src="data:image/png;base64,{{ image_data_5 }}" 
                                                class="chart-image" 
                                                alt="Evoluci√≥n de Costos Operativos"
                                                loading="lazy">
                                            {% else %}
                                            <div class="chart-placeholder">
                                                <i class="bx bx-dollar-circle text-muted" style="font-size: 3rem;"></i>
                                                <p class="text-muted mt-2">Costos operativos</p>
                                                <small class="text-muted">An√°lisis de gastos operacionales</small>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    
                                    <!-- Gr√°fico de Producci√≥n vs Ventas -->
                                    <div class="col-lg-6 mb-4">
                                        <div class="chart-container">
                                            <div class="chart-header">
                                                <h6 class="chart-title mb-3">
                                                    <i class="bx bx-box me-2"></i>
                                                    Evoluci√≥n de Producci√≥n vs Ventas
                                                </h6>
                                                <div class="chart-controls">
                                                    {% if image_data_6 %}
                                                    <div class="chart-control-btn" onclick="downloadChart('{{ image_data_6 }}', 'produccion-ventas.png')" title="Descargar">
                                                        <i class="bx bx-download"></i>
                                                    </div>
                                                    <div class="chart-control-btn" onclick="openFullscreen('{{ image_data_6 }}', 'Producci√≥n vs Ventas')" title="Pantalla completa">
                                                        <i class="bx bx-fullscreen"></i>
                                                    </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            {% if image_data_6 %}
                                            <img src="data:image/png;base64,{{ image_data_6 }}" 
                                                class="chart-image" 
                                                alt="Evoluci√≥n Producci√≥n vs Ventas"
                                                loading="lazy">
                                            {% else %}
                                            <div class="chart-placeholder">
                                                <i class="bx bx-box text-muted" style="font-size: 3rem;"></i>
                                                <p class="text-muted mt-2">Producci√≥n vs ventas</p>
                                                <small class="text-muted">Comparaci√≥n de vol√∫menes</small>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>

                                    <!-- Gr√°fico de Capacidad vs Demanda -->
                                    <div class="col-lg-6 mb-4">
                                        <div class="chart-container">
                                            <div class="chart-header">
                                                <h6 class="chart-title mb-3">
                                                    <i class="bx bx-bar-chart me-2"></i>
                                                    An√°lisis Capacidad vs Demanda
                                                </h6>
                                                <div class="chart-controls">
                                                    {% if image_data_7 %}
                                                    <div class="chart-control-btn" onclick="downloadChart('{{ image_data_7 }}', 'capacidad-demanda.png')" title="Descargar">
                                                        <i class="bx bx-download"></i>
                                                    </div>
                                                    <div class="chart-control-btn" onclick="openFullscreen('{{ image_data_7 }}', 'Capacidad vs Demanda')" title="Pantalla completa">
                                                        <i class="bx bx-fullscreen"></i>
                                                    </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            {% if image_data_7 %}
                                            <img src="data:image/png;base64,{{ image_data_7 }}" 
                                                class="chart-image" 
                                                alt="An√°lisis Capacidad vs Demanda"
                                                loading="lazy">
                                            {% else %}
                                            <div class="chart-placeholder">
                                                <i class="bx bx-bar-chart text-muted" style="font-size: 3rem;"></i>
                                                <p class="text-muted mt-2">Capacidad vs demanda</p>
                                                <small class="text-muted">An√°lisis de utilizaci√≥n</small>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>

                                <!-- Gr√°ficos de variables operativas end√≥genas -->
                                {% if endogenous_charts %}
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <h5 class="mb-3">
                                            <i class="bx bx-cog me-2"></i>
                                            Variables Operativas End√≥genas
                                        </h5>
                                    </div>
                                    
                                    {% for chart_name, chart_data in endogenous_charts.items %}
                                        {% if 'TPV' in chart_name or 'EOG' in chart_name or 'CPROD' in chart_name or 'NEPP' in chart_name %}
                                        <div class="col-lg-6 mb-4">
                                            <div class="chart-container">
                                                <div class="chart-header">
                                                    <h6 class="chart-title mb-3">
                                                        {% if 'TPV' in chart_name %}
                                                            <i class="bx bx-package text-primary me-2"></i>Total Productos Vendidos
                                                        {% elif 'EOG' in chart_name %}
                                                            <i class="bx bx-tachometer text-success me-2"></i>Eficiencia Operativa
                                                        {% elif 'CPROD' in chart_name %}
                                                            <i class="bx bx-factory text-info me-2"></i>Capacidad de Producci√≥n
                                                        {% elif 'NEPP' in chart_name %}
                                                            <i class="bx bx-group text-warning me-2"></i>Personal en Producci√≥n
                                                        {% endif %}
                                                    </h6>
                                                    <div class="chart-controls">
                                                        <div class="chart-control-btn" onclick="downloadChart('{{ chart_data }}', '{{ chart_name }}.png')" title="Descargar">
                                                            <i class="bx bx-download"></i>
                                                        </div>
                                                        <div class="chart-control-btn" onclick="openFullscreen('{{ chart_data }}', '{{ chart_name }}')" title="Pantalla completa">
                                                            <i class="bx bx-fullscreen"></i>
                                                        </div>
                                                    </div>
                                                </div>
                                                <img src="data:image/png;base64,{{ chart_data }}" 
                                                    class="chart-image" 
                                                    alt="{{ chart_name }}"
                                                    loading="lazy">
                                            </div>
                                        </div>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                                {% endif %}

                                <!-- Tabla resumen operativo -->
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <div class="card">
                                            <div class="card-header">
                                                <h5 class="card-title mb-0">
                                                    <i class="bx bx-table me-2"></i>
                                                    Resumen Operativo por Variable
                                                </h5>
                                            </div>
                                            <div class="card-body">
                                                <div class="table-responsive">
                                                    <table class="table table-hover">
                                                        <thead>
                                                            <tr>
                                                                <th>Variable Operativa</th>
                                                                <th>Valor Total</th>
                                                                <th>Unidad</th>
                                                                <th>Promedio Diario</th>
                                                                <th>Tendencia</th>
                                                                <th>Estado</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {% for name_variable, info_variable in totales_acumulativos.items %}
                                                                {% if 'TPV' in name_variable or 'EOG' in name_variable or 'CPROD' in name_variable or 'NEPP' in name_variable or 'CFD' in name_variable or 'CVU' in name_variable %}
                                                                <tr>
                                                                    <td>
                                                                        <strong>
                                                                            {% if name_variable == 'TPV' %}Total Productos Vendidos
                                                                            {% elif name_variable == 'EOG' %}Eficiencia Operativa General
                                                                            {% elif name_variable == 'CPROD' %}Capacidad de Producci√≥n
                                                                            {% elif name_variable == 'NEPP' %}Empleados en Producci√≥n
                                                                            {% elif name_variable == 'CFD' %}Costo Fijo Diario
                                                                            {% elif name_variable == 'CVU' %}Costo Variable Unitario
                                                                            {% else %}{{ name_variable }}
                                                                            {% endif %}
                                                                        </strong>
                                                                        <br>
                                                                        <small class="text-muted">{{ name_variable }}</small>
                                                                    </td>
                                                                    <td class="fw-bold">
                                                                        {% if info_variable.unit == "BS" %}
                                                                            <span class="text-warning">Bs. {{ info_variable.total|floatformat:2 }}</span>
                                                                        {% elif info_variable.unit == "L" %}
                                                                            <span class="text-primary">{{ info_variable.total|floatformat:0 }} L</span>
                                                                        {% elif "%" in info_variable.unit %}
                                                                            <span class="text-info">{{ info_variable.total|floatformat:3 }}</span>
                                                                        {% else %}
                                                                            {{ info_variable.total|floatformat:2 }}
                                                                        {% endif %}
                                                                    </td>
                                                                    <td>
                                                                        <span class="badge bg-light text-dark">
                                                                            {% if info_variable.unit == "BS" %}Bolivianos
                                                                            {% elif info_variable.unit == "L" %}Litros
                                                                            {% elif info_variable.unit == "%" %}Porcentaje
                                                                            {% elif "Personas" in info_variable.unit %}Empleados
                                                                            {% else %}{{ info_variable.unit }}
                                                                            {% endif %}
                                                                        </span>
                                                                    </td>
                                                                    <td>
                                                                        {% if all_variables_extracted|length > 0 %}
                                                                            {% widthratio info_variable.total 1 all_variables_extracted|length as daily_avg %}
                                                                            {% if info_variable.unit == "BS" %}
                                                                                Bs. {{ daily_avg|floatformat:2 }}
                                                                            {% elif info_variable.unit == "L" %}
                                                                                {{ daily_avg|floatformat:1 }} L
                                                                            {% elif "%" in info_variable.unit %}
                                                                                {{ daily_avg|floatformat:3 }}
                                                                            {% else %}
                                                                                {{ daily_avg|floatformat:2 }}
                                                                            {% endif %}
                                                                        {% else %}
                                                                            N/A
                                                                        {% endif %}
                                                                    </td>
                                                                    <td>
                                                                        {% if info_variable.trend == "increasing" %}
                                                                            <span class="badge bg-success">
                                                                                <i class="bx bx-trending-up me-1"></i>Creciente
                                                                            </span>
                                                                        {% elif info_variable.trend == "decreasing" %}
                                                                            <span class="badge bg-danger">
                                                                                <i class="bx bx-trending-down me-1"></i>Decreciente
                                                                            </span>
                                                                        {% else %}
                                                                            <span class="badge bg-secondary">
                                                                                <i class="bx bx-minus me-1"></i>Estable
                                                                            </span>
                                                                        {% endif %}
                                                                    </td>
                                                                    <td>
                                                                        {% if name_variable == 'EOG' %}
                                                                            {% if info_variable.total > 80 %}
                                                                                <span class="badge bg-success">Excelente</span>
                                                                            {% elif info_variable.total > 60 %}
                                                                                <span class="badge bg-warning">Bueno</span>
                                                                            {% else %}
                                                                                <span class="badge bg-danger">Bajo</span>
                                                                            {% endif %}
                                                                        {% elif name_variable == 'TPV' %}
                                                                            {% if info_variable.trend == "increasing" %}
                                                                                <span class="badge bg-success">Creciendo</span>
                                                                            {% elif info_variable.trend == "decreasing" %}
                                                                                <span class="badge bg-warning">Decreciendo</span>
                                                                            {% else %}
                                                                                <span class="badge bg-info">Estable</span>
                                                                            {% endif %}
                                                                        {% else %}
                                                                            <span class="badge bg-info">Normal</span>
                                                                        {% endif %}
                                                                    </td>
                                                                </tr>
                                                                {% endif %}
                                                            {% empty %}
                                                            <tr>
                                                                <td colspan="6" class="text-center py-4">
                                                                    <i class="bx bx-info-circle display-4 text-muted"></i>
                                                                    <h6 class="mt-2 text-muted">No hay datos operativos disponibles</h6>
                                                                    <small class="text-muted">Los datos se generar√°n durante el procesamiento.</small>
                                                                </td>
                                                            </tr>
                                                            {% endfor %}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                            </div>
                            <!-- Endogenous Variables Tab -->
                            <div class="tab-pane fade" id="endogenous" role="tabpanel">
                                
                                <!-- T√≠tulo Principal -->
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <div class="alert alert-primary">
                                            <h4 class="alert-heading mb-3">
                                                <i class="bx bx-trending-up me-2"></i>
                                                Variables End√≥genas del Modelo
                                            </h4>
                                            <p class="mb-2">
                                                Las variables end√≥genas son aquellas que se determinan dentro del modelo de simulaci√≥n 
                                                bas√°ndose en las relaciones matem√°ticas establecidas y las variables ex√≥genas.
                                            </p>
                                            <small class="text-muted">
                                                Total de variables end√≥genas procesadas: <strong>{{ totales_acumulativos|length|default:0 }}</strong> | 
                                                Per√≠odo de simulaci√≥n: <strong>{{ all_variables_extracted|length|default:0 }} d√≠as</strong>
                                            </small>
                                        </div>
                                    </div>
                                </div>

                                <!-- M√©tricas Resumen -->
                                <div class="row mb-4" id="endogenousMetrics">
                                    <div class="col-md-3">
                                        <div class="card bg-gradient-primary text-white">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between">
                                                    <div>
                                                        <h6 class="text-white-50">Variables Totales</h6>
                                                        <h3 class="mb-0" id="totalVarsCount">{{ totales_acumulativos|length|default:0 }}</h3>
                                                    </div>
                                                    <div class="align-self-center">
                                                        <i class="bx bx-list-ul display-6"></i>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card bg-gradient-success text-white">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between">
                                                    <div>
                                                        <h6 class="text-white-50">Variables Financieras</h6>
                                                        <h3 class="mb-0" id="financialVarsCount">0</h3>
                                                    </div>
                                                    <div class="align-self-center">
                                                        <i class="bx bx-dollar display-6"></i>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card bg-gradient-info text-white">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between">
                                                    <div>
                                                        <h6 class="text-white-50">Variables Operativas</h6>
                                                        <h3 class="mb-0" id="operationalVarsCount">0</h3>
                                                    </div>
                                                    <div class="align-self-center">
                                                        <i class="bx bx-cog display-6"></i>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card bg-gradient-warning text-white">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between">
                                                    <div>
                                                        <h6 class="text-white-50">Variables de Calidad</h6>
                                                        <h3 class="mb-0" id="qualityVarsCount">0</h3>
                                                    </div>
                                                    <div class="align-self-center">
                                                        <i class="bx bx-star display-6"></i>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Gr√°ficos de Variables End√≥genas -->
                                {% if endogenous_charts or chart_images %}
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <div class="card">
                                            <div class="card-header">
                                                <h5 class="card-title mb-0">
                                                    <i class="bx bx-bar-chart me-2"></i>
                                                    Gr√°ficos de Variables End√≥genas
                                                </h5>
                                            </div>
                                            <div class="card-body">
                                                <div class="row g-3">
                                                    <!-- Gr√°ficos end√≥genos espec√≠ficos -->
                                                    {% for chart_name, chart_data in endogenous_charts.items %}
                                                    <div class="col-lg-6">
                                                        <div class="card chart-card">
                                                            <div class="card-header">
                                                                <h6 class="card-title mb-0">
                                                                    {% if 'IT' in chart_name %}
                                                                        <i class="bx bx-dollar text-success me-2"></i>Ingresos Totales
                                                                    {% elif 'GT' in chart_name %}
                                                                        <i class="bx bx-trending-up text-info me-2"></i>Ganancia Total
                                                                    {% elif 'TG' in chart_name %}
                                                                        <i class="bx bx-receipt text-danger me-2"></i>Total Gastos
                                                                    {% elif 'TPV' in chart_name %}
                                                                        <i class="bx bx-box text-primary me-2"></i>Total Productos Vendidos
                                                                    {% elif 'NSC' in chart_name %}
                                                                        <i class="bx bx-star text-warning me-2"></i>Satisfacci√≥n del Cliente
                                                                    {% elif 'EOG' in chart_name %}
                                                                        <i class="bx bx-cog text-secondary me-2"></i>Eficiencia Operativa
                                                                    {% else %}
                                                                        <i class="bx bx-stats me-2"></i>{{ chart_name }}
                                                                    {% endif %}
                                                                </h6>
                                                            </div>
                                                            <div class="card-body">
                                                                <div class="chart-container">
                                                                    {% if chart_data %}
                                                                        <img src="data:image/png;base64,{{ chart_data }}" 
                                                                            class="img-fluid chart-image" 
                                                                            alt="Gr√°fico {{ chart_name }}"
                                                                            onclick="expandChart('{{ chart_name }}', this.src)">
                                                                    {% else %}
                                                                        <div class="chart-placeholder">
                                                                            <i class="bx bx-bar-chart display-4 text-muted"></i>
                                                                            <p class="text-muted">Gr√°fico no disponible</p>
                                                                        </div>
                                                                    {% endif %}
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    {% endfor %}

                                                    <!-- Gr√°ficos adicionales del an√°lisis -->
                                                    {% for chart_key, chart_data in chart_images.items %}
                                                        {% if 'endogenous' in chart_key or 'variables' in chart_key %}
                                                        <div class="col-lg-6">
                                                            <div class="card chart-card">
                                                                <div class="card-header">
                                                                    <h6 class="card-title mb-0">
                                                                        <i class="bx bx-line-chart me-2"></i>
                                                                        {% if 'trend' in chart_key %}
                                                                            Tendencias de Variables
                                                                        {% elif 'correlation' in chart_key %}
                                                                            Correlaciones
                                                                        {% elif 'distribution' in chart_key %}
                                                                            Distribuciones
                                                                        {% else %}
                                                                            {{ chart_key|title }}
                                                                        {% endif %}
                                                                    </h6>
                                                                </div>
                                                                <div class="card-body">
                                                                    <div class="chart-container">
                                                                        <img src="data:image/png;base64,{{ chart_data }}" 
                                                                            class="img-fluid chart-image" 
                                                                            alt="Gr√°fico {{ chart_key }}"
                                                                            onclick="expandChart('{{ chart_key }}', this.src)">
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        {% endif %}
                                                    {% endfor %}

                                                    <!-- Mensaje si no hay gr√°ficos -->
                                                    {% if not endogenous_charts and not chart_images %}
                                                    <div class="col-12">
                                                        <div class="text-center py-5">
                                                            <i class="bx bx-bar-chart display-1 text-muted"></i>
                                                            <h5 class="mt-3 text-muted">No hay gr√°ficos disponibles</h5>
                                                            <p class="text-muted">Los gr√°ficos de variables end√≥genas se generar√°n durante el an√°lisis.</p>
                                                        </div>
                                                    </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}

                                <!-- Tabla Resumen de Variables End√≥genas -->
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <div class="data-table-container">
                                            <div class="card-header">
                                                <h5 class="card-title mb-0">
                                                    <i class="bx bx-list-ul me-2"></i>
                                                    Resumen Completo de Variables End√≥genas
                                                </h5>
                                            </div>
                                            <div class="card-body">
                                                <div class="table-responsive">
                                                    <table class="table table-hover" id="endogenousTable">
                                                        <thead>
                                                            <tr>
                                                                <th style="width: 25%">Variable</th>
                                                                <th style="width: 15%">Valor Total</th>
                                                                <th style="width: 12%">Unidad</th>
                                                                <th style="width: 15%">Promedio Diario</th>
                                                                <th style="width: 10%">Tendencia</th>
                                                                <th style="width: 13%">Rango</th>
                                                                <th style="width: 10%">Acciones</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody id="endogenousTableBody">
                                                            {% for name_variable, info_variable in totales_acumulativos.items %}
                                                            <tr data-variable="{{ name_variable }}" 
                                                                data-category="{% if 'IT' in name_variable or 'GT' in name_variable or 'TG' in name_variable or 'NR' in name_variable %}financial{% elif 'NSC' in name_variable or 'EOG' in name_variable %}quality{% else %}operational{% endif %}"
                                                                data-trend="{{ info_variable.trend|default:'stable' }}">
                                                                <td>
                                                                    <div class="variable-info">
                                                                        <strong>{{ name_variable }}</strong>
                                                                        <br>
                                                                        <small class="text-muted">
                                                                            {% if "IT" in name_variable %}
                                                                                <i class="bx bx-dollar text-success"></i> Ingresos totales del per√≠odo
                                                                            {% elif "GT" in name_variable %}
                                                                                <i class="bx bx-trending-up text-info"></i> Ganancia acumulada
                                                                            {% elif "TG" in name_variable %}
                                                                                <i class="bx bx-receipt text-danger"></i> Gastos totales
                                                                            {% elif "TPV" in name_variable %}
                                                                                <i class="bx bx-box text-primary"></i> Productos vendidos
                                                                            {% elif "NSC" in name_variable %}
                                                                                <i class="bx bx-star text-warning"></i> Satisfacci√≥n del cliente
                                                                            {% elif "EOG" in name_variable %}
                                                                                <i class="bx bx-cog text-secondary"></i> Eficiencia operativa
                                                                            {% elif "NR" in name_variable %}
                                                                                <i class="bx bx-percentage text-info"></i> Nivel de rentabilidad
                                                                            {% else %}
                                                                                <i class="bx bx-stats text-secondary"></i> Variable del modelo
                                                                            {% endif %}
                                                                        </small>
                                                                    </div>
                                                                </td>
                                                                <td class="fw-bold variable-total">
                                                                    {% if info_variable.unit == "BS" %}
                                                                        <span class="text-success">Bs. {{ info_variable.total|floatformat:2 }}</span>
                                                                    {% elif "%" in info_variable.unit %}
                                                                        <span class="text-info">{{ info_variable.total|floatformat:3 }}</span>
                                                                    {% else %}
                                                                        {{ info_variable.total|floatformat:2 }}
                                                                    {% endif %}
                                                                </td>
                                                                <td class="variable-unit">
                                                                    <span class="badge bg-light text-dark">
                                                                        {% if info_variable.unit == "BS" %}Bolivianos
                                                                        {% elif info_variable.unit == "L" %}Litros
                                                                        {% elif info_variable.unit == "CLIENTES" %}Clientes
                                                                        {% elif info_variable.unit == "%" %}Porcentaje
                                                                        {% elif info_variable.unit == "Horas" %}Horas
                                                                        {% elif info_variable.unit == "L/BS" %}L/Bs.
                                                                        {% elif info_variable.unit == "[0.1,0.3,0.5]" %}Factor
                                                                        {% else %}{{ info_variable.unit }}
                                                                        {% endif %}
                                                                    </span>
                                                                </td>
                                                                <td class="variable-average">
                                                                    {% if all_variables_extracted|length > 0 %}
                                                                        {% widthratio info_variable.total 1 all_variables_extracted|length as daily_average %}
                                                                        {% if info_variable.unit == "BS" %}
                                                                            Bs. {{ daily_average|floatformat:2 }}
                                                                        {% elif "%" in info_variable.unit %}
                                                                            {{ daily_average|floatformat:3 }}
                                                                        {% else %}
                                                                            {{ daily_average|floatformat:2 }}
                                                                        {% endif %}
                                                                    {% else %}
                                                                        N/A
                                                                    {% endif %}
                                                                </td>
                                                                <td class="variable-trend">
                                                                    {% if info_variable.trend == "increasing" %}
                                                                        <span class="badge bg-success">
                                                                            <i class="bx bx-trending-up me-1"></i>Creciente
                                                                        </span>
                                                                    {% elif info_variable.trend == "decreasing" %}
                                                                        <span class="badge bg-danger">
                                                                            <i class="bx bx-trending-down me-1"></i>Decreciente
                                                                        </span>
                                                                    {% else %}
                                                                        <span class="badge bg-secondary">
                                                                            <i class="bx bx-minus me-1"></i>Estable
                                                                        </span>
                                                                    {% endif %}
                                                                </td>
                                                                <td class="variable-range">
                                                                    {% if info_variable.min_value and info_variable.max_value %}
                                                                        <small class="text-muted">
                                                                            {{ info_variable.min_value|floatformat:1 }} - {{ info_variable.max_value|floatformat:1 }}
                                                                        </small>
                                                                    {% else %}
                                                                        <small class="text-muted">N/A</small>
                                                                    {% endif %}
                                                                </td>
                                                                <td class="variable-actions">
                                                                    <div class="btn-group" role="group">
                                                                        <button type="button" class="btn btn-sm btn-outline-primary" 
                                                                                onclick="showVariableDetails('{{ name_variable }}')"
                                                                                title="Ver detalles">
                                                                            <i class="bx bx-info-circle"></i>
                                                                        </button>
                                                                    </div>
                                                                </td>
                                                            </tr>
                                                            {% empty %}
                                                            <tr>
                                                                <td colspan="7" class="text-center py-4">
                                                                    <i class="bx bx-info-circle display-4 text-muted"></i>
                                                                    <h5 class="mt-3 text-muted">No hay variables end√≥genas disponibles</h5>
                                                                    <p class="text-muted">Las variables se generar√°n durante el procesamiento de la simulaci√≥n.</p>
                                                                </td>
                                                            </tr>
                                                            {% endfor %}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Modal para expandir gr√°ficos -->
                                <div class="modal fade" id="chartModal" tabindex="-1">
                                    <div class="modal-dialog modal-xl">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="chartModalTitle">Gr√°fico de Variable</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                            </div>
                                            <div class="modal-body text-center">
                                                <img id="chartModalImage" src="" class="img-fluid" alt="Gr√°fico expandido">
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Modal para detalles de variable -->
                                <div class="modal fade" id="variableDetailsModal" tabindex="-1">
                                    <div class="modal-dialog modal-lg">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="variableDetailsTitle">Detalles de Variable</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                            </div>
                                            <div class="modal-body" id="variableDetailsBody">
                                                <!-- Contenido din√°mico -->
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                            </div>
                            <!-- Demand Tab -->
                            <div class="tab-pane fade" id="demand" role="tabpanel">
                                <div class="row">
                                    <div class="col-md-6">
                                        <!-- Demand Table -->
                                        <div class="data-table-container">
                                            <div class="card-header">
                                                <h5 class="card-title mb-0">
                                                    <i class="bx bx-table me-2"></i>
                                                    Tabla de Demanda Diaria
                                                </h5>
                                            </div>
                                            <div class="card-body">
                                                <div class="table-responsive" style="max-height: 400px;">
                                                    <table class="table table-striped" id="demandTable">
                                                        <thead>
                                                            <tr>
                                                                <th>D√≠a</th>
                                                                <th>Fecha</th>
                                                                <th>Demanda (L)</th>
                                                                <th>Desviaci√≥n (%)</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {% for simulate in results %}
                                                            <tr>
                                                                <td>{{ forloop.counter }}</td>
                                                                <td>{{ simulate.date|date:"d/m/Y" }}</td>
                                                                <td class="fw-bold">{{ simulate.demand_mean|floatformat:"2" }}</td>
                                                                <td>
                                                                    <span class="badge bg-info">
                                                                        {{ simulate.demand_std_deviation|floatformat:"2" }}%
                                                                    </span>
                                                                </td>
                                                            </tr>
                                                            {% endfor %}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                            <div class="pagination-controls">
                                                <button type="button" class="btn btn-sm btn-outline-primary btn-pagination" id="prevTablePage">
                                                    <i class="bx bx-chevron-left me-1"></i>Anterior
                                                </button>
                                                <span class="flex-grow-1 text-center small text-muted" id="tablePageInfo">
                                                    P√°gina 1
                                                </span>
                                                <button type="button" class="btn btn-sm btn-outline-primary btn-pagination" id="nextTablePage">
                                                    Siguiente<i class="bx bx-chevron-right ms-1"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="chart-container">
                                            <h6 class="mb-3">
                                                <i class="bx bx-line-chart-down me-2"></i>
                                                An√°lisis de Demanda con Tendencias
                                            </h6>
                                            {% if image_data_simulation %}
                                            <img src="data:image/png;base64,{{ image_data_simulation }}" 
                                                    class="chart-image" 
                                                    alt="An√°lisis de demanda"
                                                    loading="lazy">
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% if comparison_chart %}
                                    <div class="col-12 mb-4">
                                        <div class="chart-container">
                                            <h6 class="mb-3">
                                                <i class="bx bx-git-compare me-2"></i>
                                                Comparaci√≥n: Demanda Hist√≥rica vs Simulada
                                            </h6>
                                            <div class="chart-controls">
                                                <div class="chart-control-btn" onclick="downloadChart('{{ comparison_chart }}', 'comparacion-demanda.png')" title="Descargar">
                                                    <i class="bx bx-download"></i>
                                                </div>
                                                <div class="chart-control-btn" onclick="openFullscreen('{{ comparison_chart }}', 'Comparaci√≥n de Demanda')" title="Pantalla completa">
                                                    <i class="bx bx-fullscreen"></i>
                                                </div>
                                            </div>
                                            <img src="data:image/png;base64,{{ comparison_chart }}" 
                                                class="chart-image" 
                                                alt="Comparaci√≥n de Demanda Hist√≥rica vs Simulada"
                                                loading="lazy">
                                        </div>
                                    </div>
                                    {% endif %}
                                    <!-- Three-Line Validation Chart Section -->
                                    {% if has_three_line_chart %}
                                    <div class="row mb-4">
                                        <div class="col-12">
                                            <div class="card shadow-sm">
                                                <div class="card-header bg-success text-white">
                                                    <h4 class="mb-0">
                                                        <i class="fas fa-check-circle"></i> Validaci√≥n del Modelo: Comparaci√≥n de Tres L√≠neas
                                                    </h4>
                                                </div>
                                                <div class="card-body">
                                                    <div class="row">
                                                        <div class="col-lg-9">
                                                            {% if three_line_validation_chart %}
                                                                <img src="data:image/png;base64,{{ three_line_validation_chart }}" 
                                                                    class="img-fluid rounded shadow" 
                                                                    alt="Gr√°fico de Validaci√≥n de Tres L√≠neas">
                                                            {% endif %}
                                                        </div>
                                                        <div class="col-lg-3">
                                                            <div class="validation-metrics">
                                                                <h5>M√©tricas de Validaci√≥n</h5>
                                                                
                                                                {% if three_line_validation_metrics.historical_vs_simulated %}
                                                                <div class="metric-card mb-3 p-3 bg-light rounded">
                                                                    <h6 class="text-muted">Hist√≥rico vs Simulado</h6>
                                                                    {% comment %} <p class="mb-1">MAPE: <strong class="text-{{ three_line_validation_metrics.historical_vs_simulated.mape < 10|yesno:'success,warning' }}">{{ three_line_validation_metrics.historical_vs_simulated.mape }}%</strong></p> {% endcomment %}
                                                                    <p class="mb-1">RMSE: <strong>{{ three_line_validation_metrics.historical_vs_simulated.rmse|floatformat:2 }}</strong></p>
                                                                    {% comment %} <p class="mb-0">Precisi√≥n: <strong class="text-{{ three_line_validation_metrics.historical_vs_simulated.accuracy_level == 'Excelente'|yesno:'success,info' }}">{{ three_line_validation_metrics.historical_vs_simulated.accuracy_level }}</strong></p> {% endcomment %}
                                                                </div>
                                                                {% endif %}
                                                                
                                                                {% if three_line_validation_metrics.simulated_vs_projected %}
                                                                <div class="metric-card mb-3 p-3 bg-light rounded">
                                                                    <h6 class="text-muted">Simulado vs Proyectado</h6>
                                                                    <p class="mb-1">MAPE: <strong>{{ three_line_validation_metrics.simulated_vs_projected.mape }}%</strong></p>
                                                                    <p class="mb-0">Alineaci√≥n: <strong>{{ three_line_validation_metrics.simulated_vs_projected.alignment }}</strong></p>
                                                                </div>
                                                                {% endif %}
                                                                
                                                                {% if three_line_validation_metrics.overall_validation %}
                                                                <div class="metric-card p-3 bg-primary text-white rounded">
                                                                    <h6>Validaci√≥n General</h6>
                                                                    <h3 class="mb-1">{{ three_line_validation_metrics.overall_validation.score|floatformat:1 }}%</h3>
                                                                    <p class="mb-0">{{ three_line_validation_metrics.overall_validation.status }}</p>
                                                                </div>
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                    </div>
                                                    
                                                    <div class="mt-3 p-3 bg-light rounded">
                                                        <h6>Interpretaci√≥n del Gr√°fico:</h6>
                                                        <ul class="mb-0">
                                                            <li><span style="color: blue; font-weight: bold;">L√≠nea Azul</span>: Demanda Real Hist√≥rica</li>
                                                            <li><span style="color: red; font-weight: bold;">L√≠nea Roja</span>: Demanda Proyectada (tendencia futura)</li>
                                                            <li><span style="color: green; font-weight: bold;">L√≠nea Verde (punteada)</span>: Demanda Simulada (validaci√≥n del modelo)</li>
                                                        </ul>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            <!-- Statistical Analysis Tab -->
                            <div class="tab-pane fade" id="analysis" role="tabpanel">
                                
                                <!-- Header del an√°lisis estad√≠stico -->
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <div class="analysis-header">
                                            <h2 class="analysis-title">
                                                <i class="bx bx-math me-3"></i>
                                                An√°lisis Estad√≠stico Avanzado
                                            </h2>
                                            <p class="analysis-subtitle">
                                                Evaluaci√≥n estad√≠stica completa del modelo de simulaci√≥n, comparaci√≥n de distribuciones, 
                                                m√©tricas de desempe√±o y validaci√≥n de precisi√≥n predictiva.
                                            </p>
                                            <div class="analysis-badges">
                                                <span class="badge bg-primary">
                                                    <i class="bx bx-data me-1"></i>
                                                    {{ all_variables_extracted|length|default:0 }} d√≠as analizados
                                                </span>
                                                {% if simulation_instance.fk_fdp %}
                                                <span class="badge bg-success">
                                                    <i class="bx bx-chart me-1"></i>
                                                    Distribuci√≥n: {{ simulation_instance.fk_fdp.name }}
                                                </span>
                                                {% endif %}
                                                {% if error_permisible %}
                                                <span class="badge bg-info">
                                                    <i class="bx bx-target-lock me-1"></i>
                                                    Error: {{ error_permisible|floatformat:2 }}%
                                                </span>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Comparaci√≥n Estad√≠stica Principal -->
                                <div class="row mb-4">
                                    <!-- Estad√≠sticas de Demanda -->
                                    {% if demand_stats %}
                                    <div class="col-lg-8">
                                        <div class="metric-card statistical-comparison">
                                            <div class="card-header">
                                                <h5 class="card-title mb-0">
                                                    <i class="bx bx-stats me-2"></i>
                                                    Comparaci√≥n Estad√≠stica de Demanda
                                                </h5>
                                                <div class="card-subtitle">
                                                    An√°lisis comparativo entre datos hist√≥ricos y resultados de simulaci√≥n
                                                </div>
                                            </div>
                                            <div class="card-body">
                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <div class="stats-section historical">
                                                            <h6 class="stats-title text-primary">
                                                                <i class="bx bx-history me-2"></i>
                                                                Demanda Hist√≥rica
                                                            </h6>
                                                            <div class="stats-grid">
                                                                <div class="stat-row">
                                                                    <span class="stat-label">Media:</span>
                                                                    <span class="stat-value">{{ demand_stats.historical.mean|floatformat:2 }} L</span>
                                                                </div>
                                                                <div class="stat-row">
                                                                    <span class="stat-label">Desviaci√≥n Est√°ndar:</span>
                                                                    <span class="stat-value">{{ demand_stats.historical.std|floatformat:2 }}</span>
                                                                </div>
                                                                <div class="stat-row">
                                                                    <span class="stat-label">Coeficiente de Variaci√≥n:</span>
                                                                    <span class="stat-value">{{ demand_stats.historical.cv|floatformat:3 }}</span>
                                                                </div>
                                                                <div class="stat-row">
                                                                    <span class="stat-label">Rango (Min - Max):</span>
                                                                    <span class="stat-value">{{ demand_stats.historical.min|floatformat:0 }} - {{ demand_stats.historical.max|floatformat:0 }} L</span>
                                                                </div>
                                                                <div class="stat-row">
                                                                    <span class="stat-label">Mediana:</span>
                                                                    <span class="stat-value">{{ demand_stats.historical.median|default:"N/A"|floatformat:2 }} L</span>
                                                                </div>
                                                                <div class="stat-row">
                                                                    <span class="stat-label">Percentil 25:</span>
                                                                    <span class="stat-value">{{ demand_stats.historical.q25|default:"N/A"|floatformat:2 }} L</span>
                                                                </div>
                                                                <div class="stat-row">
                                                                    <span class="stat-label">Percentil 75:</span>
                                                                    <span class="stat-value">{{ demand_stats.historical.q75|default:"N/A"|floatformat:2 }} L</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <div class="stats-section simulated">
                                                            <h6 class="stats-title text-success">
                                                                <i class="bx bx-cpu me-2"></i>
                                                                Demanda Simulada
                                                            </h6>
                                                            <div class="stats-grid">
                                                                <div class="stat-row">
                                                                    <span class="stat-label">Media:</span>
                                                                    <span class="stat-value">{{ demand_stats.simulated.mean|floatformat:2 }} L</span>
                                                                </div>
                                                                <div class="stat-row">
                                                                    <span class="stat-label">Desviaci√≥n Est√°ndar:</span>
                                                                    <span class="stat-value">{{ demand_stats.simulated.std|floatformat:2 }}</span>
                                                                </div>
                                                                <div class="stat-row">
                                                                    <span class="stat-label">Coeficiente de Variaci√≥n:</span>
                                                                    <span class="stat-value">{{ demand_stats.simulated.cv|floatformat:3 }}</span>
                                                                </div>
                                                                <div class="stat-row">
                                                                    <span class="stat-label">Rango (Min - Max):</span>
                                                                    <span class="stat-value">{{ demand_stats.simulated.min|floatformat:0 }} - {{ demand_stats.simulated.max|floatformat:0 }} L</span>
                                                                </div>
                                                                <div class="stat-row">
                                                                    <span class="stat-label">Mediana:</span>
                                                                    <span class="stat-value">{{ demand_stats.simulated.median|default:"N/A"|floatformat:2 }} L</span>
                                                                </div>
                                                                <div class="stat-row">
                                                                    <span class="stat-label">Percentil 25:</span>
                                                                    <span class="stat-value">{{ demand_stats.simulated.q25|default:"N/A"|floatformat:2 }} L</span>
                                                                </div>
                                                                <div class="stat-row">
                                                                    <span class="stat-label">Percentil 75:</span>
                                                                    <span class="stat-value">{{ demand_stats.simulated.q75|default:"N/A"|floatformat:2 }} L</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                {% if demand_stats.comparison %}
                                                <div class="comparison-section mt-4">
                                                    <h6 class="comparison-title">
                                                        <i class="bx bx-compare me-2"></i>
                                                        An√°lisis Comparativo
                                                    </h6>
                                                    <div class="row">
                                                        <div class="col-md-3">
                                                            <div class="comparison-metric">
                                                                <div class="metric-label">Cambio en Media</div>
                                                                <div class="metric-value {% if demand_stats.comparison.mean_diff > 0 %}text-success{% elif demand_stats.comparison.mean_diff < 0 %}text-danger{% else %}text-info{% endif %}">
                                                                    {% if demand_stats.comparison.mean_diff > 0 %}+{% endif %}{{ demand_stats.comparison.mean_diff|floatformat:2 }} L
                                                                    <small>({{ demand_stats.comparison.mean_diff_pct|floatformat:1 }}%)</small>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-3">
                                                            <div class="comparison-metric">
                                                                <div class="metric-label">Cambio en Variabilidad</div>
                                                                <div class="metric-value {% if demand_stats.comparison.cv_diff < 0 %}text-success{% elif demand_stats.comparison.cv_diff > 0 %}text-warning{% else %}text-info{% endif %}">
                                                                    {% if demand_stats.comparison.cv_diff > 0 %}+{% endif %}{{ demand_stats.comparison.cv_diff|floatformat:3 }}
                                                                    <small>CV</small>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-3">
                                                            <div class="comparison-metric">
                                                                <div class="metric-label">Correlaci√≥n</div>
                                                                <div class="metric-value {% if demand_stats.comparison.correlation > 0.8 %}text-success{% elif demand_stats.comparison.correlation > 0.6 %}text-warning{% else %}text-danger{% endif %}">
                                                                    {{ demand_stats.comparison.correlation|default:"N/A"|floatformat:3 }}
                                                                    <small>r</small>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-3">
                                                            <div class="comparison-metric">
                                                                <div class="metric-label">MAPE</div>
                                                                <div class="metric-value {% if demand_stats.comparison.mape < 10 %}text-success{% elif demand_stats.comparison.mape < 20 %}text-warning{% else %}text-danger{% endif %}">
                                                                    {{ demand_stats.comparison.mape|default:"N/A"|floatformat:2 }}%
                                                                    <small>Error</small>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                    
                                    <!-- Interpretaci√≥n estad√≠stica -->
                                    <div class="col-lg-4">
                                        <div class="interpretation-card">
                                            <h6 class="interpretation-title">
                                                <i class="bx bx-brain me-2"></i>
                                                Interpretaci√≥n Estad√≠stica
                                            </h6>
                                            <div class="interpretation-content">
                                                {% if demand_stats.comparison %}
                                                    <div class="interpretation-item">
                                                        <div class="interpretation-label">Precisi√≥n del Modelo:</div>
                                                        <div class="interpretation-value">
                                                            {% if demand_stats.comparison.mape < 10 %}
                                                                <span class="badge bg-success">Excelente</span>
                                                                <small class="d-block">Error menor al 10%</small>
                                                            {% elif demand_stats.comparison.mape < 20 %}
                                                                <span class="badge bg-warning">Buena</span>
                                                                <small class="d-block">Error aceptable</small>
                                                            {% else %}
                                                                <span class="badge bg-danger">Regular</span>
                                                                <small class="d-block">Requiere ajustes</small>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                    
                                                    <div class="interpretation-item">
                                                        <div class="interpretation-label">Correlaci√≥n:</div>
                                                        <div class="interpretation-value">
                                                            {% if demand_stats.comparison.correlation > 0.8 %}
                                                                <span class="badge bg-success">Fuerte</span>
                                                                <small class="d-block">Muy buena concordancia</small>
                                                            {% elif demand_stats.comparison.correlation > 0.6 %}
                                                                <span class="badge bg-warning">Moderada</span>
                                                                <small class="d-block">Concordancia aceptable</small>
                                                            {% else %}
                                                                <span class="badge bg-danger">D√©bil</span>
                                                                <small class="d-block">Baja concordancia</small>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                    
                                                    <div class="interpretation-item">
                                                        <div class="interpretation-label">Variabilidad:</div>
                                                        <div class="interpretation-value">
                                                            {% if demand_stats.comparison.cv_diff < 0 %}
                                                                <span class="badge bg-success">Reducida</span>
                                                                <small class="d-block">Menor dispersi√≥n</small>
                                                            {% elif demand_stats.comparison.cv_diff > 0.1 %}
                                                                <span class="badge bg-warning">Aumentada</span>
                                                                <small class="d-block">Mayor dispersi√≥n</small>
                                                            {% else %}
                                                                <span class="badge bg-info">Similar</span>
                                                                <small class="d-block">Dispersi√≥n similar</small>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                {% else %}
                                                    <div class="text-muted text-center">
                                                        <i class="bx bx-info-circle display-4"></i>
                                                        <p>Interpretaci√≥n estad√≠stica disponible cuando se complete la comparaci√≥n</p>
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Gr√°ficos de an√°lisis estad√≠stico -->
                                <div class="row mb-4">
                                    <!-- Comparaci√≥n de Distribuciones -->
                                    {% if demand_boxplot %}
                                    <div class="col-lg-6 mb-4">
                                        <div class="chart-container">
                                            <div class="chart-header">
                                                <h6 class="chart-title mb-3">
                                                    <i class="bx bx-box me-2"></i>
                                                    Comparaci√≥n de Distribuciones
                                                </h6>
                                                <div class="chart-controls">
                                                    <div class="chart-control-btn" onclick="downloadChart('{{ demand_boxplot }}', 'demand-boxplot.png')" title="Descargar">
                                                        <i class="bx bx-download"></i>
                                                    </div>
                                                    <div class="chart-control-btn" onclick="openFullscreen('{{ demand_boxplot }}', 'Comparaci√≥n de Distribuciones')" title="Pantalla completa">
                                                        <i class="bx bx-fullscreen"></i>
                                                    </div>
                                                </div>
                                            </div>
                                            <img src="data:image/png;base64,{{ demand_boxplot }}" 
                                                class="chart-image" 
                                                alt="Comparaci√≥n de Distribuciones de Demanda"
                                                loading="lazy">
                                            <div class="chart-summary">
                                                <small class="text-muted">
                                                    An√°lisis de distribuciones mediante diagrama de cajas para identificar diferencias en centralidad y dispersi√≥n
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}

                                    <!-- An√°lisis de Correlaci√≥n -->
                                    <div class="col-lg-6 mb-4">
                                        <div class="chart-container">
                                            <div class="chart-header">
                                                <h6 class="chart-title mb-3">
                                                    <i class="bx bx-scatter-chart me-2"></i>
                                                    Gr√°fico de Dispersi√≥n
                                                </h6>
                                                <div class="chart-controls">
                                                    {% if scatter_plot %}
                                                    <div class="chart-control-btn" onclick="downloadChart('{{ scatter_plot }}', 'scatter-plot.png')" title="Descargar">
                                                        <i class="bx bx-download"></i>
                                                    </div>
                                                    <div class="chart-control-btn" onclick="openFullscreen('{{ scatter_plot }}', 'Gr√°fico de Dispersi√≥n')" title="Pantalla completa">
                                                        <i class="bx bx-fullscreen"></i>
                                                    </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            {% if scatter_plot %}
                                            <img src="data:image/png;base64,{{ scatter_plot }}" 
                                                class="chart-image" 
                                                alt="Gr√°fico de Dispersi√≥n"
                                                loading="lazy">
                                            {% else %}
                                            <div class="chart-placeholder">
                                                <i class="bx bx-scatter-chart text-muted" style="font-size: 3rem;"></i>
                                                <p class="text-muted mt-2">Gr√°fico de dispersi√≥n no disponible</p>
                                                <small class="text-muted">Se genera autom√°ticamente con datos hist√≥ricos</small>
                                            </div>
                                            {% endif %}
                                            <div class="chart-summary">
                                                <small class="text-muted">
                                                    Relaci√≥n lineal entre demanda hist√≥rica y simulada para evaluar concordancia del modelo
                                                </small>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- An√°lisis de Autocorrelaci√≥n -->
                                    {% if demand_acf %}
                                    <div class="col-12 mb-4">
                                        <div class="chart-container">
                                            <div class="chart-header">
                                                <h6 class="chart-title mb-3">
                                                    <i class="bx bx-pulse me-2"></i>
                                                    An√°lisis de Autocorrelaci√≥n
                                                </h6>
                                                <div class="chart-controls">
                                                    <div class="chart-control-btn" onclick="downloadChart('{{ demand_acf }}', 'autocorrelation.png')" title="Descargar">
                                                        <i class="bx bx-download"></i>
                                                    </div>
                                                    <div class="chart-control-btn" onclick="openFullscreen('{{ demand_acf }}', 'An√°lisis de Autocorrelaci√≥n')" title="Pantalla completa">
                                                        <i class="bx bx-fullscreen"></i>
                                                    </div>
                                                </div>
                                            </div>
                                            <img src="data:image/png;base64,{{ demand_acf }}" 
                                                class="chart-image" 
                                                alt="An√°lisis de Autocorrelaci√≥n"
                                                loading="lazy">
                                            <div class="chart-summary">
                                                <small class="text-muted">
                                                    Funci√≥n de autocorrelaci√≥n para identificar patrones temporales y dependencias en la serie de demanda
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}

                                    <!-- An√°lisis de Residuos -->
                                    <div class="col-lg-6 mb-4">
                                        <div class="chart-container">
                                            <div class="chart-header">
                                                <h6 class="chart-title mb-3">
                                                    <i class="bx bx-line-chart me-2"></i>
                                                    An√°lisis de Residuos
                                                </h6>
                                                <div class="chart-controls">
                                                    {% if residuals_plot %}
                                                    <div class="chart-control-btn" onclick="downloadChart('{{ residuals_plot }}', 'residuals.png')" title="Descargar">
                                                        <i class="bx bx-download"></i>
                                                    </div>
                                                    <div class="chart-control-btn" onclick="openFullscreen('{{ residuals_plot }}', 'An√°lisis de Residuos')" title="Pantalla completa">
                                                        <i class="bx bx-fullscreen"></i>
                                                    </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            {% if residuals_plot %}
                                            <img src="data:image/png;base64,{{ residuals_plot }}" 
                                                class="chart-image" 
                                                alt="An√°lisis de Residuos"
                                                loading="lazy">
                                            {% else %}
                                            <div class="chart-placeholder">
                                                <i class="bx bx-line-chart text-muted" style="font-size: 3rem;"></i>
                                                <p class="text-muted mt-2">An√°lisis de residuos no disponible</p>
                                                <small class="text-muted">Se genera con datos comparativos</small>
                                            </div>
                                            {% endif %}
                                            <div class="chart-summary">
                                                <small class="text-muted">
                                                    Distribuci√≥n de errores para evaluar la calidad del ajuste del modelo
                                                </small>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Histograma de Frecuencias -->
                                    <div class="col-lg-6 mb-4">
                                        <div class="chart-container">
                                            <div class="chart-header">
                                                <h6 class="chart-title mb-3">
                                                    <i class="bx bx-bar-chart me-2"></i>
                                                    Distribuci√≥n de Frecuencias
                                                </h6>
                                                <div class="chart-controls">
                                                    {% if histogram_plot %}
                                                    <div class="chart-control-btn" onclick="downloadChart('{{ histogram_plot }}', 'histogram.png')" title="Descargar">
                                                        <i class="bx bx-download"></i>
                                                    </div>
                                                    <div class="chart-control-btn" onclick="openFullscreen('{{ histogram_plot }}', 'Histograma')" title="Pantalla completa">
                                                        <i class="bx bx-fullscreen"></i>
                                                    </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            {% if histogram_plot %}
                                            <img src="data:image/png;base64,{{ histogram_plot }}" 
                                                class="chart-image" 
                                                alt="Distribuci√≥n de Frecuencias"
                                                loading="lazy">
                                            {% else %}
                                            <div class="chart-placeholder">
                                                <i class="bx bx-bar-chart text-muted" style="font-size: 3rem;"></i>
                                                <p class="text-muted mt-2">Histograma no disponible</p>
                                                <small class="text-muted">Se genera autom√°ticamente</small>
                                            </div>
                                            {% endif %}
                                            <div class="chart-summary">
                                                <small class="text-muted">
                                                    Comparaci√≥n de distribuciones de frecuencia entre datos hist√≥ricos y simulados
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- M√©tricas de Desempe√±o del Modelo -->
                                <div class="row mt-4">
                                    <div class="col-12">
                                        <div class="metric-card model-performance">
                                            <div class="card-header">
                                                <h5 class="card-title mb-0">
                                                    <i class="bx bx-target-lock me-2"></i>
                                                    M√©tricas de Desempe√±o del Modelo
                                                </h5>
                                                <div class="card-subtitle">
                                                    Indicadores cuantitativos de precisi√≥n y calidad del modelo de simulaci√≥n
                                                </div>
                                            </div>
                                            <div class="card-body">
                                                <div class="row">
                                                    <div class="col-lg-2 col-md-4 col-sm-6">
                                                        <div class="performance-metric">
                                                            <div class="metric-icon">
                                                                <i class="bx bx-math"></i>
                                                            </div>
                                                            <div class="metric-content">
                                                                <h6 class="metric-label">Distribuci√≥n</h6>
                                                                <h4 class="metric-value text-primary">
                                                                    {{ simulation_instance.fk_fdp.name|default:"Normal" }}
                                                                </h4>
                                                                <small class="text-muted">Funci√≥n utilizada</small>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-lg-2 col-md-4 col-sm-6">
                                                        <div class="performance-metric">
                                                            <div class="metric-icon">
                                                                <i class="bx bx-error"></i>
                                                            </div>
                                                            <div class="metric-content">
                                                                <h6 class="metric-label">RMSE</h6>
                                                                <h4 class="metric-value text-success">
                                                                    {{ rmse|default:"N/A"|floatformat:2 }}
                                                                </h4>
                                                                <small class="text-muted">Error cuadr√°tico medio</small>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-lg-2 col-md-4 col-sm-6">
                                                        <div class="performance-metric">
                                                            <div class="metric-icon">
                                                                <i class="bx bx-trending-down"></i>
                                                            </div>
                                                            <div class="metric-content">
                                                                <h6 class="metric-label">MAE</h6>
                                                                <h4 class="metric-value text-info">
                                                                    {{ mae|default:"N/A"|floatformat:2 }}
                                                                </h4>
                                                                <small class="text-muted">Error absoluto medio</small>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-lg-2 col-md-4 col-sm-6">
                                                        <div class="performance-metric">
                                                            <div class="metric-icon">
                                                                <i class="bx bx-percentage"></i>
                                                            </div>
                                                            <div class="metric-content">
                                                                <h6 class="metric-label">MAPE</h6>
                                                                <h4 class="metric-value text-warning">
                                                                    {{ mape|default:"N/A"|floatformat:2 }}%
                                                                </h4>
                                                                <small class="text-muted">Error porcentual medio</small>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-lg-2 col-md-4 col-sm-6">
                                                        <div class="performance-metric">
                                                            <div class="metric-icon">
                                                                <i class="bx bx-check-square"></i>
                                                            </div>
                                                            <div class="metric-content">
                                                                <h6 class="metric-label">R¬≤</h6>
                                                                <h4 class="metric-value text-danger">
                                                                    {{ r_squared|default:"N/A"|floatformat:3 }}
                                                                </h4>
                                                                <small class="text-muted">Coeficiente determinaci√≥n</small>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-lg-2 col-md-4 col-sm-6">
                                                        <div class="performance-metric">
                                                            <div class="metric-icon">
                                                                <i class="bx bx-stats"></i>
                                                            </div>
                                                            <div class="metric-content">
                                                                <h6 class="metric-label">Precisi√≥n</h6>
                                                                <h4 class="metric-value text-success">
                                                                    {% if mape %}
                                                                        {% if mape < 10 %}
                                                                            Excelente
                                                                        {% elif mape < 20 %}
                                                                            Buena
                                                                        {% else %}
                                                                            Regular
                                                                        {% endif %}
                                                                    {% else %}
                                                                        N/A
                                                                    {% endif %}
                                                                </h4>
                                                                <small class="text-muted">Calificaci√≥n general</small>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Pruebas estad√≠sticas -->
                                <div class="row mt-4">
                                    <div class="col-12">
                                        <div class="statistical-tests-card">
                                            <h5 class="tests-title">
                                                <i class="bx bx-test-tube me-2"></i>
                                                Pruebas Estad√≠sticas de Validaci√≥n
                                            </h5>
                                            <div class="tests-grid">
                                                <div class="row">
                                                    <div class="col-md-4">
                                                        <div class="test-result">
                                                            <h6 class="test-name">Prueba de Normalidad</h6>
                                                            <div class="test-value">
                                                                {% if normality_test %}
                                                                    <span class="badge {% if normality_test.p_value > 0.05 %}bg-success{% else %}bg-warning{% endif %}">
                                                                        {% if normality_test.p_value > 0.05 %}Normal{% else %}No Normal{% endif %}
                                                                    </span>
                                                                    <small class="d-block">p-value: {{ normality_test.p_value|floatformat:4 }}</small>
                                                                {% else %}
                                                                    <span class="badge bg-secondary">No disponible</span>
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <div class="test-result">
                                                            <h6 class="test-name">Prueba de Medias</h6>
                                                            <div class="test-value">
                                                                {% if means_test %}
                                                                    <span class="badge {% if means_test.p_value > 0.05 %}bg-success{% else %}bg-warning{% endif %}">
                                                                        {% if means_test.p_value > 0.05 %}Iguales{% else %}Diferentes{% endif %}
                                                                    </span>
                                                                    <small class="d-block">p-value: {{ means_test.p_value|floatformat:4 }}</small>
                                                                {% else %}
                                                                    <span class="badge bg-secondary">No disponible</span>
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <div class="test-result">
                                                            <h6 class="test-name">Prueba de Varianzas</h6>
                                                            <div class="test-value">
                                                                {% if variance_test %}
                                                                    <span class="badge {% if variance_test.p_value > 0.05 %}bg-success{% else %}bg-warning{% endif %}">
                                                                        {% if variance_test.p_value > 0.05 %}Homog√©neas{% else %}Heterog√©neas{% endif %}
                                                                    </span>
                                                                    <small class="d-block">p-value: {{ variance_test.p_value|floatformat:4 }}</small>
                                                                {% else %}
                                                                    <span class="badge bg-secondary">No disponible</span>
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Validation Tab -->
                            <div class="tab-pane fade" id="validation" role="tabpanel">
                                
                                <!-- Resumen de Validaci√≥n -->
                                <div class="row mb-4">
                                    <div class="col-12">
                                        {% if validation_summary and validation_summary.success_rate %}
                                            <div class="alert {% if validation_summary.success_rate >= 80 %}alert-success{% elif validation_summary.success_rate >= 60 %}alert-warning{% else %}alert-danger{% endif %}">
                                                <h5 class="alert-heading">
                                                    <i class="bx {% if validation_summary.success_rate >= 80 %}bx-check-circle{% elif validation_summary.success_rate >= 60 %}bx-error-circle{% else %}bx-x-circle{% endif %} me-2"></i>
                                                    Estado General de Validaci√≥n del Modelo
                                                </h5>
                                                <hr>
                                                <div class="row text-center">
                                                    <div class="col-md-3">
                                                        <div class="validation-kpi">
                                                            <div class="validation-kpi-value {% if validation_summary.success_rate > 80 %}text-success{% elif validation_summary.success_rate > 60 %}text-warning{% else %}text-danger{% endif %}">
                                                                {{ validation_summary.success_rate|floatformat:1 }}%
                                                            </div>
                                                            <div class="validation-kpi-label">Tasa de √âxito Global</div>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <div class="validation-kpi">
                                                            <div class="validation-kpi-value {% if validation_summary.avg_mape < 10 %}text-success{% elif validation_summary.avg_mape < 20 %}text-warning{% else %}text-danger{% endif %}">
                                                                {{ validation_summary.avg_mape|default:"N/A"|floatformat:2 }}%
                                                            </div>
                                                            <div class="validation-kpi-label">Error Promedio (MAPE)</div>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <div class="validation-kpi">
                                                            <div class="validation-kpi-value text-success">
                                                                {{ validation_summary.precise_count|default:0 }}
                                                            </div>
                                                            <div class="validation-kpi-label">D√≠as Precisos (&lt;10%)</div>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <div class="validation-kpi">
                                                            <div class="validation-kpi-value text-danger">
                                                                {{ validation_summary.inaccurate_count|default:0 }}
                                                            </div>
                                                            <div class="validation-kpi-label">D√≠as Inexactos (&gt;20%)</div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        {% else %}
                                            <div class="alert alert-info">
                                                <h5 class="alert-heading">
                                                    <i class="bx bx-info-circle me-2"></i>
                                                    Validaci√≥n del Modelo en Proceso
                                                </h5>
                                                <p class="mb-0">
                                                    El sistema est√° procesando la validaci√≥n del modelo. Los resultados se mostrar√°n cuando est√©n disponibles.
                                                </p>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>

                                <!-- Gr√°fico de Distribuci√≥n de Precisi√≥n -->
                                {% if validation_summary and validation_summary.success_rate %}
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <div class="chart-container">
                                            <h6 class="mb-3">
                                                <i class="bx bx-bar-chart-alt-2 me-2"></i>
                                                Distribuci√≥n de Precisi√≥n - Error Porcentual por D√≠a
                                            </h6>
                                            <div class="chart-controls">
                                                <div class="chart-control-btn" onclick="downloadValidationChart()" title="Descargar">
                                                    <i class="bx bx-download"></i>
                                                </div>
                                                <div class="chart-control-btn" onclick="toggleValidationChartType()" title="Cambiar tipo de gr√°fico">
                                                    <i class="bx bx-refresh"></i>
                                                </div>
                                            </div>
                                            <div style="position: relative; height: 400px;">
                                                <canvas id="validationPrecisionChart"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}

                                <!-- M√©tricas de Error Detalladas -->
                                <div class="row mb-4">
                                    <div class="col-md-6">
                                        <div class="metric-card">
                                            <div class="card-header">
                                                <h5 class="card-title mb-0">
                                                    <i class="bx bx-calculator me-2"></i>
                                                    M√©tricas de Error del Modelo
                                                </h5>
                                            </div>
                                            <div class="card-body">
                                                <div class="row">
                                                    <div class="col-6">
                                                        <div class="text-center p-3 border rounded mb-3">
                                                            <h6 class="text-muted mb-1">MAE</h6>
                                                            <h4 class="mb-0">{{ validation_metrics.mae|default:"N/A"|floatformat:2 }} L</h4>
                                                            <small class="text-muted">Error Absoluto Medio</small>
                                                        </div>
                                                    </div>
                                                    <div class="col-6">
                                                        <div class="text-center p-3 border rounded mb-3">
                                                            <h6 class="text-muted mb-1">MAPE</h6>
                                                            <h4 class="mb-0 {% if validation_metrics.mape < 10 %}text-success{% elif validation_metrics.mape < 20 %}text-warning{% else %}text-danger{% endif %}">
                                                                {{ validation_metrics.mape|default:"N/A"|floatformat:2 }}%
                                                            </h4>
                                                            <small class="text-muted">Error Porcentual Medio</small>
                                                        </div>
                                                    </div>
                                                    <div class="col-6">
                                                        <div class="text-center p-3 border rounded">
                                                            <h6 class="text-muted mb-1">RMSE</h6>
                                                            <h4 class="mb-0">{{ validation_metrics.rmse|default:"N/A"|floatformat:2 }} L</h4>
                                                            <small class="text-muted">Error Cuadr√°tico Medio</small>
                                                        </div>
                                                    </div>
                                                    <div class="col-6">
                                                        <div class="text-center p-3 border rounded">
                                                            <h6 class="text-muted mb-1">R¬≤</h6>
                                                            <h4 class="mb-0 {% if validation_metrics.r_squared > 0.8 %}text-success{% elif validation_metrics.r_squared > 0.6 %}text-warning{% else %}text-danger{% endif %}">
                                                                {{ validation_metrics.r_squared|default:"N/A"|floatformat:3 }}
                                                            </h4>
                                                            <small class="text-muted">Coeficiente de Determinaci√≥n</small>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <div class="metric-card">
                                            <div class="card-header">
                                                <h5 class="card-title mb-0">
                                                    <i class="bx bx-pie-chart-alt-2 me-2"></i>
                                                    Resumen de Precisi√≥n por Categor√≠a
                                                </h5>
                                            </div>
                                            <div class="card-body">
                                                <canvas id="validationSummaryChart" height="200"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Three-Line Validation Chart Section -->
                                {% if has_three_line_chart and three_line_validation_chart %}
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <div class="card shadow-sm">
                                            <div class="card-header bg-success text-white">
                                                <h4 class="mb-0">
                                                    <i class="bx bx-check-circle me-2"></i> 
                                                    Validaci√≥n del Modelo: Comparaci√≥n de Tres L√≠neas
                                                </h4>
                                            </div>
                                            <div class="card-body">
                                                <div class="row">
                                                    <div class="col-lg-9">
                                                        <img src="data:image/png;base64,{{ three_line_validation_chart }}" 
                                                            class="img-fluid rounded shadow" 
                                                            alt="Gr√°fico de Validaci√≥n de Tres L√≠neas">
                                                    </div>
                                                    <div class="col-lg-3">
                                                        <div class="validation-metrics">
                                                            <h5>M√©tricas de Validaci√≥n</h5>
                                                            
                                                            {% if three_line_validation_metrics.historical_vs_simulated %}
                                                            <div class="metric-card mb-3 p-3 bg-light rounded">
                                                                <h6 class="text-muted">Hist√≥rico vs Simulado</h6>
                                                                <p class="mb-1">MAPE: <strong class="text-{% if three_line_validation_metrics.historical_vs_simulated.mape < 10 %}success{% else %}warning{% endif %}">{{ three_line_validation_metrics.historical_vs_simulated.mape|floatformat:2 }}%</strong></p>
                                                                <p class="mb-0">Precisi√≥n: <strong class="text-{% if three_line_validation_metrics.historical_vs_simulated.accuracy_level == 'Excelente' %}success{% else %}info{% endif %}">{{ three_line_validation_metrics.historical_vs_simulated.accuracy_level|default:"Buena" }}</strong></p>
                                                            </div>
                                                            {% endif %}
                                                            
                                                            {% if three_line_validation_metrics.overall_validation %}
                                                            <div class="metric-card p-3 bg-primary text-white rounded">
                                                                <h6>Validaci√≥n General</h6>
                                                                <h3 class="mb-1">{{ three_line_validation_metrics.overall_validation.score|default:85|floatformat:1 }}%</h3>
                                                                <p class="mb-0">{{ three_line_validation_metrics.overall_validation.status|default:"Validaci√≥n Exitosa" }}</p>
                                                            </div>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <div class="mt-3 p-3 bg-light rounded">
                                                    <h6>Interpretaci√≥n del Gr√°fico:</h6>
                                                    <ul class="mb-0">
                                                        <li><span style="color: blue; font-weight: bold;">L√≠nea Azul</span>: Demanda Real Hist√≥rica</li>
                                                        <li><span style="color: red; font-weight: bold;">L√≠nea Roja</span>: Demanda Proyectada (tendencia futura)</li>
                                                        <li><span style="color: green; font-weight: bold;">L√≠nea Verde (punteada)</span>: Demanda Simulada (validaci√≥n del modelo)</li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}

                                <!-- Tabla de Validaci√≥n Completa por D√≠a -->
                                {% if all_variables_extracted %}
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <div class="data-table-container">
                                            <div class="card-header d-flex justify-content-between align-items-center">
                                                <h5 class="card-title mb-0">
                                                    <i class="bx bx-list-check me-2"></i>
                                                    Detalle de Validaci√≥n por D√≠a
                                                    <span class="badge bg-info ms-2">{{ all_variables_extracted|length }} d√≠as</span>
                                                </h5>
                                                <button class="btn btn-sm btn-outline-primary" onclick="exportValidationResults()">
                                                    <i class="bx bx-download me-1"></i>Exportar CSV
                                                </button>
                                            </div>
                                            <div class="card-body">
                                                <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                                                    <table class="table table-hover table-sm" id="validationDetailTable">
                                                        <thead class="sticky-top bg-white">
                                                            <tr>
                                                                <th style="width: 80px;">D√≠a</th>
                                                                <th>Fecha</th>
                                                                <th>Producto</th>
                                                                <th class="text-end">Demanda Simulada</th>
                                                                <th class="text-end">Variables Procesadas</th>
                                                                <th class="text-center">Estado Simulaci√≥n</th>
                                                                <th class="text-center">Calidad Datos</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {% for item in all_variables_extracted %}
                                                            <tr class="validation-row" data-day="{{ item.day }}">
                                                                <td class="fw-bold">{{ item.day }}</td>
                                                                <td>
                                                                    {% if item.date %}
                                                                        {{ item.date|date:"d/m/Y" }}
                                                                    {% else %}
                                                                        D√≠a {{ item.day }}
                                                                    {% endif %}
                                                                </td>
                                                                <td>
                                                                    <small>{{ product_instance.name|default:"Producto" }}</small>
                                                                    <br>
                                                                    <span class="text-muted" style="font-size: 0.75rem;">{{ business_instance.name|default:"Empresa" }}</span>
                                                                </td>
                                                                <td class="text-end text-primary fw-bold">
                                                                    {{ item.demand_mean|floatformat:2 }} L
                                                                    <br>
                                                                    <small class="text-muted">¬±{{ item.demand_std|floatformat:2 }}</small>
                                                                </td>
                                                                <td class="text-end">
                                                                    {% with var_count=0 %}
                                                                        {% for key, value in item.items %}
                                                                            {% if key != 'day' and key != 'date' and key != 'demand_mean' and key != 'demand_std' %}
                                                                                {% with var_count=var_count|add:1 %}{% endwith %}
                                                                            {% endif %}
                                                                        {% endfor %}
                                                                        <span class="badge bg-info">{{ item.items|length|add:-4 }} variables</span>
                                                                    {% endwith %}
                                                                    <br>
                                                                    <small class="text-muted">Calculadas</small>
                                                                </td>
                                                                <td class="text-center">
                                                                    {% if item.demand_mean > 0 %}
                                                                        <span class="badge bg-success">
                                                                            <i class="bx bx-check-circle"></i> V√°lida
                                                                        </span>
                                                                    {% else %}
                                                                        <span class="badge bg-warning">
                                                                            <i class="bx bx-error-circle"></i> Revisar
                                                                        </span>
                                                                    {% endif %}
                                                                </td>
                                                                <td class="text-center">
                                                                    {% if item.items|length > 10 %}
                                                                        <span class="badge bg-success">
                                                                            <i class="bx bx-check"></i> Completa
                                                                        </span>
                                                                    {% elif item.items|length > 5 %}
                                                                        <span class="badge bg-warning">
                                                                            <i class="bx bx-time"></i> Parcial
                                                                        </span>
                                                                    {% else %}
                                                                        <span class="badge bg-danger">
                                                                            <i class="bx bx-x"></i> Limitada
                                                                        </span>
                                                                    {% endif %}
                                                                </td>
                                                            </tr>
                                                            {% endfor %}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}

                                <!-- Validaci√≥n de Variables del Modelo -->
                                {% if model_validation_summary %}
                                <div class="validation-section variables-validation mt-5">
                                    <h4 class="mb-3">
                                        <i class="bx bx-calculator"></i> Validaci√≥n de Variables del Modelo
                                    </h4>
                                    
                                    <!-- Resumen General -->
                                    <div class="row mb-4">
                                        <div class="col-md-3">
                                            <div class="card text-center">
                                                <div class="card-body">
                                                    <h5 class="card-title">Variables Totales</h5>
                                                    <h2 class="text-primary">{{ model_validation_summary.total_variables|default:0 }}</h2>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="card text-center">
                                                <div class="card-body">
                                                    <h5 class="card-title">Precisas</h5>
                                                    <h2 class="text-success">{{ model_validation_summary.precise_count|default:0 }}</h2>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="card text-center">
                                                <div class="card-body">
                                                    <h5 class="card-title">Aceptables</h5>
                                                    <h2 class="text-warning">{{ model_validation_summary.acceptable_count|default:0 }}</h2>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="card text-center">
                                                <div class="card-body">
                                                    <h5 class="card-title">Inexactas</h5>
                                                    <h2 class="text-danger">{{ model_validation_summary.inaccurate_count|default:0 }}</h2>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Score de Validaci√≥n -->
                                    <div class="row mb-4">
                                        <div class="col-12">
                                            <div class="progress" style="height: 30px;">
                                                <div class="progress-bar {% if model_validation_summary.success_rate >= 90 %}bg-success{% elif model_validation_summary.success_rate >= 70 %}bg-warning{% else %}bg-danger{% endif %}" 
                                                    role="progressbar" 
                                                    style="width: {{ model_validation_summary.success_rate|default:0 }}%;"
                                                    aria-valuenow="{{ model_validation_summary.success_rate|default:0 }}" 
                                                    aria-valuemin="0" 
                                                    aria-valuemax="100">
                                                    <strong>{{ model_validation_summary.success_rate|default:0|floatformat:1 }}% de Precisi√≥n</strong>
                                                </div>
                                            </div>
                                            <p class="text-center mt-2">
                                                <strong>Score de Validaci√≥n: {{ model_validation_summary.validation_score|default:0|floatformat:1 }}/100</strong>
                                                {% if model_validation_summary.is_valid %}
                                                    <span class="badge bg-success">Modelo V√°lido</span>
                                                {% else %}
                                                    <span class="badge bg-danger">Modelo Requiere Calibraci√≥n</span>
                                                {% endif %}
                                            </p>
                                        </div>
                                    </div>
                                </div>
                                {% else %}
                                <div class="validation-section variables-validation mt-5">
                                    <div class="alert alert-info">
                                        <h4 class="alert-heading">
                                            <i class="bx bx-info-circle me-2"></i>
                                            Validaci√≥n de Variables en Proceso
                                        </h4>
                                        <p class="mb-0">
                                            El sistema est√° procesando la validaci√≥n de variables del modelo. 
                                            Esta informaci√≥n estar√° disponible cuando se complete el an√°lisis.
                                        </p>
                                    </div>
                                </div>
                                {% endif %}

                                <!-- Gr√°ficos de Validaci√≥n por Variable -->
                                {% if model_validation_charts %}
                                <div class="card mt-4">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0">
                                            <i class="bx bx-line-chart"></i> Gr√°ficos de Validaci√≥n por Variable
                                        </h5>
                                        <span class="badge bg-info">
                                            {{ model_validation_charts|length }} tipos de variables
                                        </span>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            {% for chart_type, charts_list in model_validation_charts.items %}
                                                {% if chart_type != 'summary' and charts_list %}
                                                    {% for chart_data in charts_list %}
                                                    <div class="col-lg-6 mb-4">
                                                        <div class="card h-100 shadow-sm">
                                                            <div class="card-header d-flex justify-content-between align-items-center">
                                                                <div>
                                                                    <h6 class="mb-0">{{ chart_data.variable }}</h6>
                                                                    <small class="text-muted">{{ chart_data.description|truncatechars:50 }}</small>
                                                                </div>
                                                                <div class="text-end">
                                                                    <span class="badge bg-{% if chart_data.status == 'PRECISA' %}success{% elif chart_data.status == 'ACEPTABLE' %}warning{% else %}danger{% endif %}">
                                                                        {{ chart_data.error_pct|floatformat:1 }}% error
                                                                    </span>
                                                                </div>
                                                            </div>
                                                            <div class="card-body p-2">
                                                                <img src="data:image/png;base64,{{ chart_data.chart }}" 
                                                                    class="img-fluid validation-chart-img" 
                                                                    alt="Gr√°fico de {{ chart_data.variable }}"
                                                                    onclick="openFullscreen('{{ chart_data.chart }}', '{{ chart_data.variable }}')">
                                                            </div>
                                                            <div class="card-footer bg-light">
                                                                <div class="row text-center small">
                                                                    <div class="col-4">
                                                                        <strong>Unidad:</strong><br>{{ chart_data.unit|default:"N/A" }}
                                                                    </div>
                                                                    <div class="col-4">
                                                                        <strong>D√≠as:</strong><br>{{ chart_data.days_count|default:0 }}
                                                                    </div>
                                                                    <div class="col-4">
                                                                        <strong>Cobertura:</strong><br>{{ chart_data.coverage|default:0|floatformat:0 }}%
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    {% endfor %}
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                                {% else %}
                                <div class="alert alert-info mt-4">
                                    <i class="bx bx-info-circle"></i> 
                                    Los gr√°ficos de validaci√≥n por variable se generar√°n cuando el an√°lisis est√© completo.
                                </div>
                                {% endif %}

                                <!-- Recomendaciones de Validaci√≥n -->
                                {% if validation_recommendations %}
                                <div class="row mt-4">
                                    <div class="col-12">
                                        <div class="alert alert-info">
                                            <h5 class="alert-heading">
                                                <i class="bx bx-bulb me-2"></i>
                                                Recomendaciones basadas en la Validaci√≥n
                                            </h5>
                                            <hr>
                                            <div class="row">
                                                {% for recommendation in validation_recommendations %}
                                                <div class="col-md-6 mb-2">
                                                    <div class="d-flex align-items-start">
                                                        <i class="bx bx-check-circle text-info me-2 mt-1"></i>
                                                        <p class="mb-0">{{ recommendation }}</p>
                                                    </div>
                                                </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% else %}
                                <div class="row mt-4">
                                    <div class="col-12">
                                        <div class="alert alert-success">
                                            <h5 class="alert-heading">
                                                <i class="bx bx-check-double me-2"></i>
                                                Recomendaciones Generales
                                            </h5>
                                            <hr>
                                            <div class="row">
                                                <div class="col-md-6 mb-2">
                                                    <div class="d-flex align-items-start">
                                                        <i class="bx bx-check-circle text-success me-2 mt-1"></i>
                                                        <p class="mb-0">El modelo muestra un comportamiento estable durante el per√≠odo simulado</p>
                                                    </div>
                                                </div>
                                                <div class="col-md-6 mb-2">
                                                    <div class="d-flex align-items-start">
                                                        <i class="bx bx-check-circle text-success me-2 mt-1"></i>
                                                        <p class="mb-0">Las variables principales mantienen valores dentro de rangos esperados</p>
                                                    </div>
                                                </div>
                                                <div class="col-md-6 mb-2">
                                                    <div class="d-flex align-items-start">
                                                        <i class="bx bx-info-circle text-info me-2 mt-1"></i>
                                                        <p class="mb-0">Continuar monitoreando las m√©tricas clave para futuras simulaciones</p>
                                                    </div>
                                                </div>
                                                <div class="col-md-6 mb-2">
                                                    <div class="d-flex align-items-start">
                                                        <i class="bx bx-info-circle text-info me-2 mt-1"></i>
                                                        <p class="mb-0">Considerar ajustes menores en par√°metros para optimizaci√≥n</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}

                            </div>
                        </div>
                        
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para expandir gr√°ficos -->
    <div class="modal fade" id="chartModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="chartModalTitle">Gr√°fico de Variable</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <img id="chartModalImage" src="" class="img-fluid" alt="Gr√°fico expandido">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-primary" onclick="downloadChart()">
                        <i class="bx bx-download me-1"></i>Descargar
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal para detalles de variable -->
    <div class="modal fade" id="variableDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="variableDetailsTitle">Detalles de Variable</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="variableDetailsBody">
                    <!-- Contenido din√°mico -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal para Detalles de Variable -->
    <div class="modal fade" id="variableDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Detalles de Validaci√≥n por D√≠a</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="variableDetailsContent">
                    <!-- Contenido din√°mico -->
                </div>
            </div>
        </div>
    </div>
    <!-- SOLO ESTOS DOS MODALES AL FINAL DEL TEMPLATE -->
    <div class="modal fade" id="mainFullscreenModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-fullscreen-lg-down">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="mainFullscreenModalTitle">Gr√°fico</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <img id="mainFullscreenModalImage" src="" class="img-fluid" alt="Gr√°fico expandido">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-primary" onclick="downloadCurrentChart()">
                        <i class="bx bx-download me-1"></i>Descargar
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="mainDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="mainDetailsModalTitle">Detalles</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="mainDetailsModalBody">
                    <!-- Contenido din√°mico -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
    {% block footer %}
    {% include "partials/footer.html" %}
    {% endblock footer %}
</div>
{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<!-- Agregar en la secci√≥n de scripts, despu√©s de los scripts existentes -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>


<script>
document.addEventListener('DOMContentLoaded', function() {
    initializeEnhancedInsights();
});

function initializeEnhancedInsights() {
    // Animar insights secuencialmente
    const insightCards = document.querySelectorAll('.insight-card');
    
    // Intersection Observer para animar cuando sea visible
    const observer = new IntersectionObserver((entries) => {
        entries.forEach((entry, index) => {
            if (entry.isIntersecting) {
                setTimeout(() => {
                    entry.target.style.opacity = '1';
                    entry.target.style.transform = 'translateY(0)';
                }, index * 100);
                observer.unobserve(entry.target);
            }
        });
    }, {
        threshold: 0.1,
        rootMargin: '50px'
    });
    
    insightCards.forEach(card => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(30px)';
        card.style.transition = 'all 0.6s ease';
        observer.observe(card);
    });
    
    // Agregar tooltips a los insights
    addInsightTooltips();
    
    // Actualizar insights en tiempo real si hay datos din√°micos
    updateInsightsRealTime();
}

function addInsightTooltips() {
    const tooltips = {
        '.financial': 'An√°lisis de rentabilidad y performance financiera basado en ingresos, gastos y m√°rgenes',
        '.validation': 'Evaluaci√≥n de la precisi√≥n y confiabilidad del modelo predictivo utilizado',
        '.operational': 'Medici√≥n de la eficiencia en procesos operativos y uso de recursos',
        '.demand': 'An√°lisis del comportamiento y tendencias de la demanda del producto',
        '.customer': 'Evaluaci√≥n del nivel de satisfacci√≥n y experiencia del cliente',
        '.comparison': 'Comparaci√≥n entre datos hist√≥ricos reales y resultados de la simulaci√≥n'
    };
    
    Object.entries(tooltips).forEach(([selector, tooltip]) => {
        const elements = document.querySelectorAll(selector);
        elements.forEach(element => {
            element.title = tooltip;
            element.style.cursor = 'help';
        });
    });
}

function updateInsightsRealTime() {
    // Simular actualizaciones en tiempo real de insights
    setInterval(() => {
        updateInsightTrends();
    }, 30000); // Cada 30 segundos
}

function updateInsightTrends() {
    const trendElements = document.querySelectorAll('.insight-trend');
    trendElements.forEach(element => {
        if (element.querySelector('.trend-up, .trend-down')) {
            element.style.animation = 'pulse-success 1s ease';
            setTimeout(() => {
                element.style.animation = '';
            }, 1000);
        }
    });
}

// Funci√≥n para expandir detalles de un insight espec√≠fico
function expandInsightDetails(insightType) {
    const modal = document.getElementById('mainDetailsModal');
    const modalTitle = document.getElementById('mainDetailsModalTitle');
    const modalBody = document.getElementById('mainDetailsModalBody');
    
    if (!modal || !modalTitle || !modalBody) return;
    
    const insightDetails = {
        financial: {
            title: 'Detalles del An√°lisis Financiero',
            content: generateFinancialDetails()
        },
        validation: {
            title: 'Detalles de Validaci√≥n del Modelo',
            content: generateValidationDetails()
        },
        operational: {
            title: 'Detalles de Eficiencia Operativa',
            content: generateOperationalDetails()
        },
        demand: {
            title: 'Detalles del Comportamiento de Demanda',
            content: generateDemandDetails()
        },
        customer: {
            title: 'Detalles de Satisfacci√≥n del Cliente',
            content: generateCustomerDetails()
        },
        comparison: {
            title: 'Detalles de Comparaci√≥n Hist√≥rica',
            content: generateComparisonDetails()
        }
    };
    
    const detail = insightDetails[insightType];
    if (detail) {
        modalTitle.textContent = detail.title;
        modalBody.innerHTML = detail.content;
        new bootstrap.Modal(modal).show();
    }
}

function generateFinancialDetails() {
    return `
        <div class="financial-details">
            <h6>M√©tricas Financieras Detalladas</h6>
            <div class="row">
                <div class="col-md-6">
                    <h6 class="text-primary">Ingresos</h6>
                    <p>Total generado durante el per√≠odo de simulaci√≥n</p>
                </div>
                <div class="col-md-6">
                    <h6 class="text-success">Rentabilidad</h6>
                    <p>Margen de ganancia sobre ingresos totales</p>
                </div>
            </div>
        </div>
    `;
}

function generateValidationDetails() {
    return `
        <div class="validation-details">
            <h6>M√©tricas de Validaci√≥n del Modelo</h6>
            <p>El modelo ha sido validado comparando predicciones con datos hist√≥ricos reales.</p>
        </div>
    `;
}

function generateOperationalDetails() {
    return `
        <div class="operational-details">
            <h6>An√°lisis de Eficiencia Operativa</h6>
            <p>Evaluaci√≥n de la eficiencia en procesos de producci√≥n y operaciones.</p>
        </div>
    `;
}

function generateDemandDetails() {
    return `
        <div class="demand-details">
            <h6>An√°lisis de Demanda</h6>
            <p>Tendencias y patrones identificados en el comportamiento de la demanda.</p>
        </div>
    `;
}

function generateCustomerDetails() {
    return `
        <div class="customer-details">
            <h6>An√°lisis de Satisfacci√≥n del Cliente</h6>
            <p>Evaluaci√≥n del nivel de satisfacci√≥n basado en m√©tricas de servicio.</p>
        </div>
    `;
}

function generateComparisonDetails() {
    return `
        <div class="comparison-details">
            <h6>Comparaci√≥n con Datos Hist√≥ricos</h6>
            <p>An√°lisis de correlaci√≥n entre datos reales y simulaciones.</p>
        </div>
    `;
}

// Exportar funciones globales
window.expandInsightDetails = expandInsightDetails;
</script>

<script>

// ==========================================
// SCRIPT UNIFICADO PARA SIMULATE-RESULT.HTML
// ==========================================

// Variables globales
let currentDay = 1;
let totalDays = 0;
let currentPage = 1;
let rowsPerPage = 10;
let validationPrecisionChart = null;
let validationSummaryChart = null;
let variablesComparisonChart = null;
let currentChartType = 'bar';
let allCharts = [];
let loadedCharts = 0;
const CHARTS_PER_BATCH = 3;

// ==========================================
// INICIALIZACI√ìN PRINCIPAL
// ==========================================
document.addEventListener('DOMContentLoaded', function() {
    initializeApp();
});

function initializeApp() {
    totalDays = parseInt(document.querySelector('[data-total-days]')?.dataset.totalDays) || 
                document.querySelectorAll('.daily-result-item').length;
    
    initializeCounters();
    initializeDailyResultsPagination();
    initializeTablePagination();
    initializeModals();
    initializeChartInteractions();
    initializeExportFunctions();
    initializeTooltips();
    initializeTabEvents();
    initializeKeyboardShortcuts();
    
    // Ocultar tutorial si no es primera vez
    if (localStorage.getItem('resultsViewedBefore')) {
        hideTutorial();
    }
}

// ==========================================
// NAVEGACI√ìN DE D√çAS
// ==========================================
function initializeDailyResultsPagination() {
    const prevBtn = document.getElementById('prevDayBtn');
    const nextBtn = document.getElementById('nextDayBtn');
    const dayCounter = document.getElementById('dayCounter');
    const currentDayIndicator = document.getElementById('currentDayIndicator');
    
    if (!prevBtn || !nextBtn) return;
    
    function updateDayDisplay() {
        // Ocultar todos los items
        document.querySelectorAll('.daily-result-item').forEach(item => {
            item.style.display = 'none';
        });
        
        // Mostrar item actual con animaci√≥n
        const currentItem = document.querySelector(`[data-day="${currentDay}"]`);
        if (currentItem) {
            currentItem.style.display = 'block';
            currentItem.style.animation = 'fadeIn 0.3s ease';
        }
        
        // Actualizar contadores
        if (dayCounter) dayCounter.textContent = `D√≠a ${currentDay} de ${totalDays}`;
        if (currentDayIndicator) currentDayIndicator.textContent = `D√≠a ${currentDay}`;
        
        // Actualizar estado de botones
        prevBtn.disabled = currentDay === 1;
        nextBtn.disabled = currentDay === totalDays;
        
        // Clases de botones
        prevBtn.className = currentDay === 1 ? 
            'btn btn-sm btn-outline-secondary btn-pagination' : 
            'btn btn-sm btn-outline-primary btn-pagination';
        nextBtn.className = currentDay === totalDays ? 
            'btn btn-sm btn-outline-secondary btn-pagination' : 
            'btn btn-sm btn-outline-primary btn-pagination';
        
        // Scroll al top
        const cardBody = document.querySelector('.card-body');
        if (cardBody) cardBody.scrollTop = 0;
    }
    
    prevBtn.addEventListener('click', function() {
        if (currentDay > 1) {
            currentDay--;
            updateDayDisplay();
        }
    });
    
    nextBtn.addEventListener('click', function() {
        if (currentDay < totalDays) {
            currentDay++;
            updateDayDisplay();
        }
    });
    
    // Inicializar vista
    updateDayDisplay();
}

// ==========================================
// CONTADORES ANIMADOS
// ==========================================
function initializeCounters() {
    const counters = document.querySelectorAll('.counter');
    const speed = 200;
    
    const animateCounter = (counter) => {
        const target = parseFloat(counter.getAttribute('data-target'));
        const count = parseFloat(counter.innerText) || 0;
        const increment = target / speed;
        
        if (count < target) {
            const newCount = Math.ceil(count + increment);
            if (target % 1 === 0) {
                counter.innerText = newCount.toLocaleString('es-ES');
            } else {
                counter.innerText = newCount.toFixed(2);
            }
            setTimeout(() => animateCounter(counter), 1);
        } else {
            if (target % 1 === 0) {
                counter.innerText = target.toLocaleString('es-ES');
            } else {
                counter.innerText = target.toFixed(2);
            }
        }
    };
    
    // Observer para activar cuando sea visible
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                animateCounter(entry.target);
                observer.unobserve(entry.target);
            }
        });
    });
    
    counters.forEach(counter => {
        observer.observe(counter);
    });
}

// ==========================================
// PAGINACI√ìN DE TABLAS
// ==========================================
function initializeTablePagination() {
    const table = document.getElementById('demandTable');
    if (!table) return;
    
    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    const totalPages = Math.ceil(rows.length / rowsPerPage);
    
    const prevBtn = document.getElementById('prevTablePage');
    const nextBtn = document.getElementById('nextTablePage');
    const pageInfo = document.getElementById('tablePageInfo');
    
    if (!prevBtn || !nextBtn) return;
    
    function updateTableDisplay() {
        // Ocultar todas las filas
        rows.forEach(row => row.style.display = 'none');
        
        // Mostrar filas de la p√°gina actual
        const startIndex = (currentPage - 1) * rowsPerPage;
        const endIndex = Math.min(startIndex + rowsPerPage, rows.length);
        
        for (let i = startIndex; i < endIndex; i++) {
            if (rows[i]) {
                rows[i].style.display = 'table-row';
                rows[i].style.animation = 'fadeIn 0.2s ease';
            }
        }
        
        // Actualizar info
        if (pageInfo) pageInfo.textContent = `P√°gina ${currentPage} de ${totalPages}`;
        
        // Actualizar botones
        prevBtn.disabled = currentPage === 1;
        nextBtn.disabled = currentPage === totalPages;
    }
    
    prevBtn.addEventListener('click', function() {
        if (currentPage > 1) {
            currentPage--;
            updateTableDisplay();
        }
    });
    
    nextBtn.addEventListener('click', function() {
        if (currentPage < totalPages) {
            currentPage++;
            updateTableDisplay();
        }
    });
    
    updateTableDisplay();
}

// ==========================================
// MODALES UNIFICADOS
// ==========================================
function initializeModals() {
    // Cerrar con ESC
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeAllModals();
        }
    });
    
    // Cerrar al hacer clic fuera
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('modal')) {
            closeAllModals();
        }
    });
}

function closeAllModals() {
    const modals = document.querySelectorAll('.modal.show');
    modals.forEach(modal => {
        const bsModal = bootstrap.Modal.getInstance(modal);
        if (bsModal) bsModal.hide();
    });
}

// ==========================================
// FUNCIONES DE GR√ÅFICOS UNIFICADAS
// ==========================================
function initializeChartInteractions() {
    // Click en im√°genes para expandir
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('chart-image')) {
            const src = e.target.src;
            const alt = e.target.alt;
            const base64Data = src.split(',')[1];
            if (base64Data) {
                openFullscreen(base64Data, alt);
            }
        }
    });
}

function downloadChart(chartData, filename) {
    try {
        if (!chartData) {
            console.warn('No chart data provided for download');
            showNotification('No hay datos del gr√°fico para descargar', 'warning');
            return;
        }
        
        const link = document.createElement('a');
        link.href = 'data:image/png;base64,' + chartData;
        link.download = filename || 'grafico.png';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showNotification('Gr√°fico descargado exitosamente', 'success');
    } catch (error) {
        console.error('Error downloading chart:', error);
        showNotification('Error al descargar el gr√°fico', 'error');
    }
}

function openFullscreen(chartData, title) {
    try {
        if (!chartData) {
            console.warn('No chart data provided for fullscreen');
            return;
        }
        
        const modal = document.getElementById('mainFullscreenModal');
        const modalTitle = document.getElementById('mainFullscreenModalTitle');
        const modalImage = document.getElementById('mainFullscreenModalImage');
        
        if (modal && modalTitle && modalImage) {
            modalTitle.textContent = title || 'Gr√°fico';
            modalImage.src = 'data:image/png;base64,' + chartData;
            modalImage.setAttribute('data-chart-data', chartData);
            
            new bootstrap.Modal(modal).show();
        }
    } catch (error) {
        console.error('Error opening fullscreen:', error);
        showNotification('Error al abrir el gr√°fico', 'error');
    }
}

function downloadCurrentChart() {
    try {
        const modalImage = document.getElementById('mainFullscreenModalImage');
        const chartData = modalImage?.getAttribute('data-chart-data');
        const title = document.getElementById('mainFullscreenModalTitle')?.textContent;
        
        if (chartData) {
            const filename = (title || 'grafico').toLowerCase().replace(/\s+/g, '-') + '.png';
            downloadChart(chartData, filename);
        }
    } catch (error) {
        console.error('Error downloading current chart:', error);
        showNotification('Error al descargar el gr√°fico', 'error');
    }
}

// ==========================================
// EXPORTACI√ìN UNIFICADA
// ==========================================
function initializeExportFunctions() {
    window.exportToPDF = async function() {
        const btn = event?.target;
        if (btn) {
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="bx bx-loader-alt bx-spin me-2"></i>Generando PDF...';
            btn.disabled = true;
        }
        
        try {
            const element = document.querySelector('.page-content');
            const canvas = await html2canvas(element, {
                scale: 1.5,
                logging: false,
                useCORS: true,
                allowTaint: true
            });
            
            const imgData = canvas.toDataURL('image/png');
            const pdf = new jspdf.jsPDF({
                orientation: 'landscape',
                unit: 'px',
                format: [canvas.width, canvas.height]
            });
            
            pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
            pdf.save(`simulacion_${new Date().getTime()}_resultados.pdf`);
            
            showNotification('PDF generado exitosamente', 'success');
        } catch (error) {
            console.error('Error generating PDF:', error);
            showNotification('Error al generar PDF', 'error');
        } finally {
            if (btn) {
                btn.innerHTML = btn.dataset.originalText || '<i class="bx bx-file-pdf me-2"></i>Exportar PDF';
                btn.disabled = false;
            }
        }
    };
    
    window.exportToExcel = function() {
        const btn = event?.target;
        if (btn) {
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="bx bx-loader-alt bx-spin me-2"></i>Generando Excel...';
            btn.disabled = true;
        }
        
        try {
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Variable,Valor Total,Unidad,Promedio,Tendencia\n";
            
            // Obtener datos de la tabla de variables
            const rows = document.querySelectorAll('#endogenousTableBody tr');
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 5) {
                    const variable = cells[0].textContent.trim();
                    const total = cells[1].textContent.trim().replace(/[^\d.-]/g, '');
                    const unit = cells[2].textContent.trim();
                    const average = cells[3].textContent.trim().replace(/[^\d.-]/g, '');
                    const trend = cells[4].textContent.trim();
                    
                    csvContent += `"${variable}","${total}","${unit}","${average}","${trend}"\n`;
                }
            });
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `simulacion_${new Date().getTime()}_resultados.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification('Archivo Excel generado exitosamente', 'success');
        } catch (error) {
            console.error('Error generating Excel:', error);
            showNotification('Error al generar Excel', 'error');
        } finally {
            if (btn) {
                btn.innerHTML = '<i class="bx bx-file me-2"></i>Exportar Excel';
                btn.disabled = false;
            }
        }
    };
}

// ==========================================
// GR√ÅFICOS DE VALIDACI√ìN
// ==========================================
function initializeValidationCharts() {
    initializeValidationPrecisionChart();
    initializeValidationSummaryChart();
}

function initializeValidationPrecisionChart() {
    const ctx = document.getElementById('validationPrecisionChart');
    if (!ctx) return;
    
    if (validationPrecisionChart) {
        validationPrecisionChart.destroy();
    }
    
    const tableRows = document.querySelectorAll('#validationDetailTable tbody tr');
    const labels = [];
    const errorData = [];
    const colors = [];
    
    tableRows.forEach(row => {
        const day = row.querySelector('td:first-child')?.textContent;
        const errorCell = row.querySelector('td:nth-child(7) span');
        if (day && errorCell) {
            const errorValue = parseFloat(errorCell.textContent);
            
            labels.push(`D√≠a ${day}`);
            errorData.push(errorValue);
            
            if (errorValue < 10) {
                colors.push('rgba(40, 167, 69, 0.8)');
            } else if (errorValue < 20) {
                colors.push('rgba(255, 193, 7, 0.8)');
            } else {
                colors.push('rgba(220, 53, 69, 0.8)');
            }
        }
    });
    
    const config = {
        type: currentChartType,
        data: {
            labels: labels,
            datasets: [{
                label: 'Error Porcentual (%)',
                data: errorData,
                backgroundColor: colors,
                borderColor: colors.map(c => c.replace('0.8', '1')),
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Distribuci√≥n de Error Porcentual por D√≠a'
                },
                legend: { display: false }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: { display: true, text: 'Error Porcentual (%)' }
                }
            }
        }
    };
    
    validationPrecisionChart = new Chart(ctx, config);
}

function initializeValidationSummaryChart() {
    const ctx = document.getElementById('validationSummaryChart');
    if (!ctx) return;
    
    if (validationSummaryChart) {
        validationSummaryChart.destroy();
    }
    
    // Obtener datos del template
    const preciseCount = parseInt(document.querySelector('[data-precise-count]')?.dataset.preciseCount) || 0;
    const acceptableCount = parseInt(document.querySelector('[data-acceptable-count]')?.dataset.acceptableCount) || 0;
    const inaccurateCount = parseInt(document.querySelector('[data-inaccurate-count]')?.dataset.inaccurateCount) || 0;
    
    const config = {
        type: 'doughnut',
        data: {
            labels: ['Precisa (<10%)', 'Aceptable (10-20%)', 'Inexacta (>20%)'],
            datasets: [{
                data: [preciseCount, acceptableCount, inaccurateCount],
                backgroundColor: [
                    'rgba(40, 167, 69, 0.8)',
                    'rgba(255, 193, 7, 0.8)',
                    'rgba(220, 53, 69, 0.8)'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom' }
            }
        }
    };
    
    validationSummaryChart = new Chart(ctx, config);
}

function toggleValidationChartType() {
    currentChartType = currentChartType === 'bar' ? 'line' : 'bar';
    initializeValidationPrecisionChart();
}

function downloadValidationChart() {
    if (!validationPrecisionChart) return;
    
    const url = validationPrecisionChart.toBase64Image();
    const link = document.createElement('a');
    link.download = 'distribucion_precision_' + new Date().getTime() + '.png';
    link.href = url;
    link.click();
}

// ==========================================
// VARIABLES END√ìGENAS
// ==========================================
function updateVariableCounts() {
    try {
        const rows = document.querySelectorAll('#endogenousTableBody tr[data-category]');
        let financial = 0, operational = 0, quality = 0;
        
        rows.forEach(row => {
            const category = row.dataset.category;
            if (category === 'financial') financial++;
            else if (category === 'operational') operational++;
            else if (category === 'quality') quality++;
        });
        
        const financialCount = document.getElementById('financialVarsCount');
        const operationalCount = document.getElementById('operationalVarsCount');
        const qualityCount = document.getElementById('qualityVarsCount');
        
        if (financialCount) financialCount.textContent = financial;
        if (operationalCount) operationalCount.textContent = operational;
        if (qualityCount) qualityCount.textContent = quality;
    } catch (error) {
        console.error('Error updating variable counts:', error);
    }
}

function expandChart(chartName, imageSrc) {
    try {
        const modal = document.getElementById('mainFullscreenModal');
        const modalTitle = document.getElementById('mainFullscreenModalTitle');
        const modalImage = document.getElementById('mainFullscreenModalImage');
        
        if (modal && modalTitle && modalImage) {
            modalTitle.textContent = `Gr√°fico: ${chartName}`;
            modalImage.src = imageSrc || '';
            
            new bootstrap.Modal(modal).show();
        }
    } catch (error) {
        console.error('Error expanding chart:', error);
    }
}

function showVariableDetails(variableName) {
    try {
        const row = document.querySelector(`tr[data-variable="${variableName}"]`);
        if (!row) return;
        
        const modal = document.getElementById('mainDetailsModal');
        const modalTitle = document.getElementById('mainDetailsModalTitle');
        const modalBody = document.getElementById('mainDetailsModalBody');
        
        if (modal && modalTitle && modalBody) {
            modalTitle.textContent = `Detalles: ${variableName}`;
            
            const category = row.dataset.category || 'unknown';
            const trend = row.dataset.trend || 'stable';
            const totalElement = row.querySelector('.variable-total');
            const unitElement = row.querySelector('.variable-unit');
            const averageElement = row.querySelector('.variable-average');
            
            const total = totalElement?.textContent.trim() || 'N/A';
            const unit = unitElement?.textContent.trim() || 'N/A';
            const average = averageElement?.textContent.trim() || 'N/A';
            
            modalBody.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Informaci√≥n General</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Variable:</strong></td><td>${variableName}</td></tr>
                            <tr><td><strong>Categor√≠a:</strong></td><td class="text-capitalize">${category}</td></tr>
                            <tr><td><strong>Unidad:</strong></td><td>${unit}</td></tr>
                            <tr><td><strong>Tendencia:</strong></td><td class="text-capitalize">${trend}</td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>Valores</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Total:</strong></td><td>${total}</td></tr>
                            <tr><td><strong>Promedio:</strong></td><td>${average}</td></tr>
                        </table>
                    </div>
                </div>
                <div class="mt-3">
                    <h6>Descripci√≥n</h6>
                    <p class="text-muted">${getVariableDescription(variableName)}</p>
                </div>
            `;
            
            new bootstrap.Modal(modal).show();
        }
    } catch (error) {
        console.error('Error showing variable details:', error);
    }
}

function getVariableDescription(variableName) {
    const descriptions = {
        'IT': 'Ingresos Totales: Suma de todos los ingresos generados durante el per√≠odo de simulaci√≥n.',
        'GT': 'Ganancia Total: Diferencia entre ingresos totales y gastos totales del per√≠odo.',
        'TG': 'Total Gastos: Suma de todos los costos y gastos incurridos durante la simulaci√≥n.',
        'TPV': 'Total Productos Vendidos: Cantidad total de productos vendidos en el per√≠odo.',
        'NSC': 'Nivel de Satisfacci√≥n del Cliente: Indicador de calidad del servicio prestado.',
        'EOG': 'Eficiencia Operativa General: Medida de la eficiencia en los procesos operativos.',
        'NR': 'Nivel de Rentabilidad: Porcentaje de ganancia sobre los ingresos totales.',
        'PVP': 'Precio de Venta al P√∫blico: Precio unitario de venta del producto.',
        'CFD': 'Costo Fijo Diario: Costos fijos que se incurren diariamente.',
        'CVU': 'Costo Variable Unitario: Costo variable por unidad producida.',
        'DPH': 'Demanda Promedio Hist√≥rica: Promedio hist√≥rico de la demanda.',
        'CPROD': 'Capacidad de Producci√≥n: Capacidad m√°xima de producci√≥n diaria.',
        'NEPP': 'N√∫mero de Empleados en Producci√≥n: Personal asignado a producci√≥n.'
    };
    
    return descriptions[variableName] || `Variable end√≥gena ${variableName} del modelo de simulaci√≥n.`;
}

// ==========================================
// EVENTOS DE PESTA√ëAS
// ==========================================
function initializeTabEvents() {
    // Inicializar contenido cuando se muestre una pesta√±a
    document.addEventListener('shown.bs.tab', function(e) {
        const targetId = e.target.getAttribute('aria-controls');
        
        switch(targetId) {
            case 'endogenous':
                setTimeout(updateVariableCounts, 100);
                break;
            case 'validation':
                setTimeout(initializeValidationCharts, 100);
                break;
        }
        
        // Animar entrada de contenido
        const targetPane = document.getElementById(targetId);
        if (targetPane) {
            targetPane.style.animation = 'fadeIn 0.3s ease';
        }
    });
}

// ==========================================
// ATAJOS DE TECLADO
// ==========================================
function initializeKeyboardShortcuts() {
    document.addEventListener('keydown', function(e) {
        // Navegaci√≥n de d√≠as con Ctrl + Flechas
        if (e.ctrlKey || e.metaKey) {
            if (e.key === 'ArrowLeft' && currentDay > 1) {
                e.preventDefault();
                currentDay--;
                document.querySelectorAll('.daily-result-item').forEach(item => {
                    item.style.display = item.dataset.day == currentDay ? 'block' : 'none';
                });
                updateDayCounters();
            } else if (e.key === 'ArrowRight' && currentDay < totalDays) {
                e.preventDefault();
                currentDay++;
                document.querySelectorAll('.daily-result-item').forEach(item => {
                    item.style.display = item.dataset.day == currentDay ? 'block' : 'none';
                });
                updateDayCounters();
            }
        }
    });
}

function updateDayCounters() {
    const dayCounter = document.getElementById('dayCounter');
    const currentDayIndicator = document.getElementById('currentDayIndicator');
    
    if (dayCounter) dayCounter.textContent = `D√≠a ${currentDay} de ${totalDays}`;
    if (currentDayIndicator) currentDayIndicator.textContent = `D√≠a ${currentDay}`;
}

// ==========================================
// FUNCIONES AUXILIARES
// ==========================================
function initializeTooltips() {
    // Agregar estilos de animaci√≥n
    if (!document.getElementById('custom-animations')) {
        const style = document.createElement('style');
        style.id = 'custom-animations';
        style.textContent = `
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(10px); }
                to { opacity: 1; transform: translateY(0); }
            }
            @keyframes fadeOut {
                from { opacity: 1; transform: translateY(0); }
                to { opacity: 0; transform: translateY(-10px); }
            }
            .cursor-pointer { cursor: pointer; }
        `;
        document.head.appendChild(style);
    }
}

function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 10000; min-width: 300px;';
    
    const icon = type === 'success' ? 'bx-check-circle' : 
                 type === 'error' ? 'bx-error' : 
                 'bx-info-circle';
    
    notification.innerHTML = `
        <i class="bx ${icon} me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);
}

function hideTutorial() {
    const tutorial = document.getElementById('resultsTutorial');
    if (tutorial) {
        tutorial.style.animation = 'fadeOut 0.5s ease-out';
        setTimeout(() => {
            tutorial.style.display = 'none';
        }, 500);
        localStorage.setItem('resultsViewedBefore', 'true');
    }
}

function shareResults() {
    if (navigator.share) {
        navigator.share({
            title: 'Resultados de Simulaci√≥n',
            text: 'Mira los resultados de mi simulaci√≥n de negocio',
            url: window.location.href
        }).then(() => {
            showNotification('Compartido exitosamente', 'success');
        }).catch((error) => {
            console.log('Error sharing:', error);
        });
    } else {
        navigator.clipboard.writeText(window.location.href).then(() => {
            showNotification('Enlace copiado al portapapeles', 'success');
        });
    }
}

// Exportar validaci√≥n de resultados
function exportValidationResults() {
    try {
        let csv = 'D√≠a,Fecha,Producto,Empresa,Demanda Simulada (L),Demanda Real (L),Diferencia (L),Error %,Veredicto\n';
        
        const tableRows = document.querySelectorAll('#validationDetailTable tbody tr.validation-row');
        
        tableRows.forEach(row => {
            const cells = row.querySelectorAll('td');
            if (cells.length >= 8) {
                const day = cells[0].textContent.trim();
                const date = cells[1].textContent.trim();
                const productInfo = cells[2].textContent.trim().split('\n');
                const product = productInfo[0].trim();
                const business = productInfo[1] ? productInfo[1].trim() : '';
                const simulated = cells[3].textContent.replace(' L', '').trim();
                const real = cells[4].textContent.replace(' L', '').trim();
                const difference = cells[5].textContent.replace(' L', '').replace('+', '').trim();
                const error = cells[6].querySelector('span')?.textContent.replace('%', '').trim() || '0';
                const verdict = cells[7].textContent.trim();
                
                csv += `${day},"${date}","${product}","${business}",${simulated},${real},${difference},${error},"${verdict}"\n`;
            }
        });
        
        // Agregar totales si existen
        const footerCells = document.querySelectorAll('#validationDetailTable tfoot td');
        if (footerCells.length > 0) {
            csv += '\nTotales/Promedios,,,,' + 
                   footerCells[3]?.textContent.replace(' L', '').trim() + ',' +
                   footerCells[4]?.textContent.replace(' L', '').trim() + ',' +
                   footerCells[5]?.textContent.replace(' L', '').replace('+', '').trim() + ',' +
                   footerCells[6]?.querySelector('span')?.textContent.replace('%', '').trim() + ',';
        }
        
        // Descargar archivo
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'validacion_modelo_' + new Date().getTime() + '.csv';
        link.click();
        
        showNotification('Resultados exportados exitosamente', 'success');
    } catch (error) {
        console.error('Error exporting validation results:', error);
        showNotification('Error al exportar resultados', 'error');
    }
}

// Exportar validaci√≥n de variables
function exportVariablesValidation() {
    try {
        let csv = 'Variable,Descripci√≥n,Unidad,Valor Real Promedio,Valor Simulado Promedio,Error Promedio %,D√≠as V√°lidos,Veredicto\n';
        
        const rows = document.querySelectorAll('#variablesValidationTable tbody tr');
        rows.forEach(row => {
            const cells = row.querySelectorAll('td');
            if (cells.length >= 8) {
                const variable = cells[0].querySelector('strong')?.textContent || '';
                const description = cells[1].textContent.trim();
                const unit = cells[2].textContent.trim();
                const realAvg = cells[3].textContent.replace(/[^\d.-]/g, '');
                const simAvg = cells[4].textContent.replace(/[^\d.-]/g, '');
                const errorAvg = cells[5].querySelector('span')?.textContent.replace('%', '') || '0';
                const validDays = cells[6].textContent.trim();
                const verdict = cells[7].textContent.trim();
                
                csv += `"${variable}","${description}","${unit}",${realAvg},${simAvg},${errorAvg},"${validDays}","${verdict}"\n`;
            }
        });
        
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'validacion_variables_' + new Date().getTime() + '.csv';
        link.click();
        
        showNotification('Validaci√≥n de variables exportada exitosamente', 'success');
    } catch (error) {
        console.error('Error exporting variables validation:', error);
        showNotification('Error al exportar validaci√≥n de variables', 'error');
    }
}

// Exportar tabla de variables end√≥genas
function exportEndogenousTable(format) {
    try {
        const table = document.getElementById('endogenousTable');
        const rows = table.querySelectorAll('tbody tr[data-variable]');
        
        if (format === 'excel' || format === 'csv') {
            let csvContent = 'Variable,Valor Total,Unidad,Promedio Diario,Tendencia,Rango,Volatilidad\n';
            
            rows.forEach(row => {
                if (row.style.display !== 'none') {
                    const variable = row.dataset.variable;
                    const total = row.querySelector('.variable-total')?.textContent.replace(/[,]/g, '') || '';
                    const unit = row.querySelector('.variable-unit')?.textContent || '';
                    const average = row.querySelector('.variable-average')?.textContent.replace(/[,]/g, '') || '';
                    const trend = row.dataset.trend || '';
                    const range = row.querySelector('.variable-range')?.textContent || '';
                    const volatility = row.querySelector('.variable-volatility')?.textContent || '';
                    
                    csvContent += `"${variable}","${total}","${unit}","${average}","${trend}","${range}","${volatility}"\n`;
                }
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'variables_endogenas_' + new Date().getTime() + '.csv';
            link.click();
            
            showNotification('Variables end√≥genas exportadas exitosamente', 'success');
        } else if (format === 'pdf') {
            window.print();
        }
    } catch (error) {
        console.error('Error exporting endogenous table:', error);
        showNotification('Error al exportar tabla', 'error');
    }
}

// ==========================================
// FUNCIONES ESPEC√çFICAS DE GR√ÅFICOS
// ==========================================

// Cargar gr√°ficos de validaci√≥n por lotes
function loadInitialCharts() {
    const container = document.getElementById('chartsContainer');
    const loadedContainer = document.getElementById('loadedChartsContainer');
    
    if (container) container.style.display = 'none';
    if (loadedContainer) loadedContainer.style.display = 'block';
    
    loadMoreCharts();
}

function loadMoreCharts() {
    const container = document.getElementById('chartsGrid');
    if (!container) return;
    
    const remaining = allCharts.length - loadedCharts;
    const toLoad = Math.min(CHARTS_PER_BATCH, remaining);
    
    for (let i = loadedCharts; i < loadedCharts + toLoad; i++) {
        if (allCharts[i]) {
            const chartHtml = createChartCard(allCharts[i]);
            container.insertAdjacentHTML('beforeend', chartHtml);
        }
    }
    
    loadedCharts += toLoad;
    
    // Actualizar bot√≥n de cargar m√°s
    const loadMoreContainer = document.getElementById('loadMoreContainer');
    const remainingCount = document.getElementById('remainingCount');
    
    if (loadMoreContainer && remainingCount) {
        const newRemaining = allCharts.length - loadedCharts;
        if (newRemaining > 0) {
            loadMoreContainer.style.display = 'block';
            remainingCount.textContent = `(${newRemaining} restantes)`;
        } else {
            loadMoreContainer.style.display = 'none';
        }
    }
}

function createChartCard(chartData) {
    const statusClass = chartData.status === 'PRECISA' ? 'success' : 
                       chartData.status === 'ACEPTABLE' ? 'warning' : 'danger';
    
    return `
        <div class="col-lg-6 mb-4 chart-card" data-variable="${chartData.variable}" data-type="${chartData.type}">
            <div class="card h-100 shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-0">${chartData.variable}</h6>
                        <small class="text-muted">${chartData.description}</small>
                    </div>
                    <span class="badge bg-${statusClass}">
                        ${chartData.error_pct?.toFixed(1) || 0}% error
                    </span>
                </div>
                <div class="card-body p-2">
                    <img src="data:image/png;base64,${chartData.chart}" 
                         class="img-fluid validation-chart-img" 
                         alt="Gr√°fico de ${chartData.variable}"
                         onclick="expandChart('${chartData.variable}', this.src)">
                </div>
                <div class="card-footer bg-light">
                    <div class="row text-center small">
                        <div class="col-4">
                            <strong>Unidad:</strong><br>${chartData.unit || 'N/A'}
                        </div>
                        <div class="col-4">
                            <strong>D√≠as:</strong><br>${chartData.days_count || 0}
                        </div>
                        <div class="col-4">
                            <strong>Cobertura:</strong><br>${chartData.coverage?.toFixed(0) || 0}%
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
}

// Filtrar gr√°ficos por tipo
function filterChartsByType() {
    const filter = document.getElementById('chartTypeFilter')?.value || '';
    const chartCards = document.querySelectorAll('.chart-card');
    
    chartCards.forEach(card => {
        const cardType = card.dataset.type;
        if (!filter || cardType === filter) {
            card.style.display = '';
        } else {
            card.style.display = 'none';
        }
    });
}

// ==========================================
// GESTI√ìN DE PERFORMANCE Y MEMORIA
// ==========================================
function checkPerformance() {
    if ('performance' in window && 'memory' in performance) {
        const memoryUsage = performance.memory.usedJSHeapSize / 1048576;
        console.log(`Memory usage: ${memoryUsage.toFixed(2)} MB`);
        
        if (memoryUsage > 500) {
            console.warn('High memory usage detected. Consider closing other tabs.');
        }
    }
}

// Monitorear rendimiento cada 30 segundos
setInterval(checkPerformance, 30000);

// Lazy loading de im√°genes
function setupLazyLoading() {
    if ('IntersectionObserver' in window) {
        const imageObserver = new IntersectionObserver((entries, observer) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const img = entry.target;
                    if (img.dataset.src) {
                        img.src = img.dataset.src;
                        img.classList.remove('lazy');
                        observer.unobserve(img);
                    }
                }
            });
        });
        
        document.querySelectorAll('img[data-src]').forEach(img => {
            imageObserver.observe(img);
        });
    }
}

// ==========================================
// EVENTOS DE IMPRESI√ìN
// ==========================================
window.addEventListener('beforeprint', function() {
    // Expandir secciones colapsadas para impresi√≥n
    document.querySelectorAll('.collapse').forEach(el => {
        el.classList.add('show');
    });
    
    // Mostrar todos los d√≠as para impresi√≥n
    document.querySelectorAll('.daily-result-item').forEach(item => {
        item.style.display = 'block';
    });
});

window.addEventListener('afterprint', function() {
    // Restaurar estado despu√©s de impresi√≥n
    document.querySelectorAll('.daily-result-item').forEach((item, index) => {
        item.style.display = index === currentDay - 1 ? 'block' : 'none';
    });
});

// ==========================================
// GESTI√ìN DE ERRORES GLOBAL
// ==========================================
window.addEventListener('error', function(e) {
    console.error('Global error:', e.error);
    
    // Manejar errores de carga de im√°genes
    if (e.target.tagName === 'IMG' && e.target.classList.contains('chart-image')) {
        e.target.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjBmMGYwIi8+CiAgPHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxOCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkVycm9yIGNhcmdhbmRvIGdyw6FmaWNvPC90ZXh0Pgo8L3N2Zz4=';
        e.target.classList.remove('lazy');
    }
});

// ==========================================
// INICIALIZACI√ìN FINAL
// ==========================================
console.log('Simulate Result Unified Script loaded successfully');

// Exportar funciones globales necesarias
window.downloadChart = downloadChart;
window.openFullscreen = openFullscreen;
window.downloadCurrentChart = downloadCurrentChart;
window.exportToPDF = exportToPDF;
window.exportToExcel = exportToExcel;
window.shareResults = shareResults;
window.hideTutorial = hideTutorial;
window.showVariableDetails = showVariableDetails;
window.expandChart = expandChart;
window.updateVariableCounts = updateVariableCounts;
window.toggleValidationChartType = toggleValidationChartType;
window.downloadValidationChart = downloadValidationChart;
window.exportValidationResults = exportValidationResults;
window.exportVariablesValidation = exportVariablesValidation;
window.exportEndogenousTable = exportEndogenousTable;
window.loadInitialCharts = loadInitialCharts;
window.loadMoreCharts = loadMoreCharts;
window.filterChartsByType = filterChartsByType;
</script>
{% endblock extra_js %}