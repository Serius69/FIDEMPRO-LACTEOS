{% extends "partials/base.html" %}
{% load static %}
{% block title %}Resultados de Simulación{% endblock title %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/joint.css' %}"> 
<link rel="stylesheet" href="{% static 'libs/dropzone/dist/dropzone.css'%}" type="text/css" />
<link rel="stylesheet" href="{% static 'libs/filepond/dist/filepond.min.css'%}" type="text/css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.9.3/min/dropzone.min.css" />
<link rel="stylesheet" href="{% static 'css/simulate-result.css' %}">
{% endblock extra_css %}

{% block content %}
<div class="main-content">
    <div class="page-content">
        <div class="container-fluid">
            <!-- Page Title -->
            {% block pagetitle %}
            {% include "partials/page-title.html" with pagetitle="Simulación" title="Resultados" %}
            {% endblock pagetitle %}

            <!-- Results Tutorial -->
            <div class="results-tutorial" id="resultsTutorial">
                <h5><i class="bx bx-bulb me-2"></i>Guía de Interpretación de Resultados</h5>
                <p>Sus resultados de simulación están listos. Aquí le explicamos cómo interpretarlos:</p>
                <div class="tutorial-steps">
                    <div class="tutorial-step">
                        <i class="bx bx-bar-chart-alt-2"></i>
                        <h6>Métricas Clave</h6>
                        <p class="small">Revise los indicadores principales en la parte superior</p>
                    </div>
                    <div class="tutorial-step">
                        <i class="bx bx-line-chart"></i>
                        <h6>Análisis Visual</h6>
                        <p class="small">Explore los gráficos interactivos por categoría</p>
                    </div>
                    <div class="tutorial-step">
                        <i class="bx bx-bulb"></i>
                        <h6>Recomendaciones</h6>
                        <p class="small">Lea las sugerencias personalizadas basadas en IA</p>
                    </div>
                    <div class="tutorial-step">
                        <i class="bx bx-download"></i>
                        <h6>Exportar</h6>
                        <p class="small">Descargue reportes en PDF o Excel</p>
                    </div>
                </div>
                <button class="btn btn-sm btn-outline-primary mt-3" onclick="hideTutorial()">
                    <i class="bx bx-x me-1"></i>Entendido
                </button>
            </div>

            <!-- Results Header -->
            <div class="results-header">
                <div class="row align-items-center">
                    <div class="col-lg-8">
                        <h1 class="mb-3">
                            <i class="bx bx-bar-chart-alt-2 me-3"></i>
                            Resultados de Simulación
                        </h1>
                        <p class="fs-5 mb-0">
                            Análisis completo para {{ product_instance.name }} - {{ business_instance.name }}
                        </p>
                        <p class="opacity-75 mb-0">
                            Simulación ejecutada el {{ simulation_instance.date_created|date:"d/m/Y H:i" }}
                        </p>
                    </div>
                    <div class="col-lg-4 text-lg-end">
                        <div class="export-section">
                            <h5 class="mb-3">
                                <i class="bx bx-download me-2"></i>
                                Exportar Resultados
                            </h5>
                            <div class="d-grid gap-2">
                                <button class="btn btn-primary" onclick="exportToPDF()">
                                    <i class="bx bx-file-pdf me-2"></i>
                                    Exportar PDF
                                </button>
                                <button class="btn btn-success" onclick="exportToExcel()">
                                    <i class="bx bx-file me-2"></i>
                                    Exportar Excel
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Key Insights Panel -->
            <div class="insights-panel">
                <h5 class="mb-3"><i class="bx bx-bulb me-2"></i>Insights Principales</h5>
                <div class="row">
                    <div class="col-md-6">
                        <div class="insight-item">
                            <div class="insight-icon {% if growth_rate > 0 %}positive{% else %}negative{% endif %}">
                                <i class="bx {% if growth_rate > 0 %}bx-trending-up{% else %}bx-trending-down{% endif %}"></i>
                            </div>
                            <div>
                                <h6 class="mb-1">Tendencia de Demanda</h6>
                                <p class="mb-0">
                                    La demanda muestra una tendencia 
                                    {% if growth_rate > 0 %}
                                        <strong class="text-success">creciente del {{ growth_rate|floatformat:"2" }}%</strong>
                                    {% else %}
                                        <strong class="text-danger">decreciente del {{ growth_rate|floatformat:"2" }}%</strong>
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="insight-item">
                            <div class="insight-icon {% if error_permisible < 5 %}positive{% elif error_permisible < 10 %}warning{% else %}negative{% endif %}">
                                <i class="bx bx-target-lock"></i>
                            </div>
                            <div>
                                <h6 class="mb-1">Precisión del Modelo</h6>
                                <p class="mb-0">
                                    Error permisible del <strong>{{ error_permisible|floatformat:"2" }}%</strong>
                                    {% if error_permisible < 5 %}
                                        <span class="text-success">(Muy bueno)</span>
                                    {% elif error_permisible < 10 %}
                                        <span class="text-warning">(Bueno)</span>
                                    {% else %}
                                        <span class="text-danger">(Revisar modelo)</span>
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Key Statistics with Animation -->
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-icon">
                        <i class="bx bx-trending-up"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value">
                            <span class="counter" data-target="{{ demand_stats.historical.quantity|default:0|floatformat:'0' }}">0</span> L
                        </div>
                        <div class="stat-label">Demanda Inicial</div>
                        <div class="stat-description">Promedio histórico</div>
                    </div>
                </div>

                <div class="stat-item">
                    <div class="stat-icon">
                        <i class="bx bx-target-lock"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value">
                            <span class="counter" data-target="{{ demand_predicted.quantity|default:0|floatformat:'0' }}">0</span> L
                        </div>
                        <div class="stat-label">Demanda Predicha</div>
                        <div class="stat-description">Proyección del modelo</div>
                    </div>
                </div>

                <div class="stat-item">
                    <div class="stat-icon">
                        <i class="bx bx-line-chart"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value">
                            <span class="counter" data-target="{{ growth_rate|default_if_none:0|default:0|floatformat:'2' }}">0</span>%
                        </div>
                        <div class="stat-label">Tasa de Crecimiento</div>
                        <div class="stat-description">Crecimiento estimado</div>
                    </div>
                </div>

                <div class="stat-item">
                    <div class="stat-icon">
                        <i class="bx bx-error-circle"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value">
                            <span class="counter" data-target="{{ error_permisible|default_if_none:0|default:0|floatformat:'2' }}">0</span>%
                        </div>
                        <div class="stat-label">Error Permisible</div>
                        <div class="stat-description">Margen de tolerancia</div>
                    </div>
                </div>

                <div class="stat-item">
                    <div class="stat-icon">
                        <i class="bx bx-calendar"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value">
                            <span class="counter" data-target="{{ simulation_instance.quantity_time|default:0 }}">0</span>
                        </div>
                        <div class="stat-label">Días Simulados</div>
                        <div class="stat-description">Período de análisis</div>
                    </div>
                </div>

                <!-- Métricas adicionales -->
                <div class="stat-item">
                    <div class="stat-icon">
                        <i class="bx bx-dollar-circle"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value">
                            {% if totales_acumulativos.GT %}
                                <span class="counter" data-target="{{ totales_acumulativos.GT.total|floatformat:'0' }}">0</span>
                            {% else %}
                                <span class="counter" data-target="0">0</span>
                            {% endif %}
                            Bs.
                        </div>
                        <div class="stat-label">Ganancia Total</div>
                        <div class="stat-description">Beneficio acumulado</div>
                    </div>
                </div>

                <div class="stat-item">
                    <div class="stat-icon">
                        <i class="bx bx-package"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value">
                            {% if totales_acumulativos.TPV %}
                                <span class="counter" data-target="{{ totales_acumulativos.TPV.total|floatformat:'0' }}">0</span>
                            {% else %}
                                <span class="counter" data-target="0">0</span>
                            {% endif %}
                            L
                        </div>
                        <div class="stat-label">Productos Vendidos</div>
                        <div class="stat-description">Total del período</div>
                    </div>
                </div>

                <div class="stat-item">
                    <div class="stat-icon">
                        <i class="bx bx-tachometer"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value">
                            {% if totales_acumulativos.EOG and all_variables_extracted|length > 0 %}
                                {% widthratio totales_acumulativos.EOG.total 1 all_variables_extracted|length as avg_eog %}
                                {% widthratio avg_eog 1 100 as eog_percent %}
                                <span class="counter" data-target="{{ eog_percent|floatformat:'1' }}">0</span>%
                            {% else %}
                                <span class="counter" data-target="0">0</span>%
                            {% endif %}
                        </div>
                        <div class="stat-label">Eficiencia Operativa</div>
                        <div class="stat-description">Promedio del período</div>
                    </div>
                </div>

                <div class="stat-item">
                    <div class="stat-icon">
                        <i class="bx bx-percentage"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value">
                            {% if totales_acumulativos.NR and all_variables_extracted|length > 0 %}
                                {% widthratio totales_acumulativos.NR.total 1 all_variables_extracted|length as avg_margin %}
                                {% widthratio avg_margin 1 100 as margin_percent %}
                                <span class="counter" data-target="{{ margin_percent|floatformat:'1' }}">0</span>%
                            {% else %}
                                <span class="counter" data-target="0">0</span>%
                            {% endif %}
                        </div>
                        <div class="stat-label">Rentabilidad</div>
                        <div class="stat-description">Margen promedio</div>
                    </div>
                </div>
            </div>


            <!-- Main Content Grid -->
            <div class="row">
                <!-- Sidebar with Parameters and Controls -->
                <div class="col-lg-4">
                    <!-- Simulation Parameters -->
                    <div class="metric-card mb-4">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="bx bx-cog me-2"></i>
                                Parámetros de Simulación
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-4">
                                    <img src="{{ product_instance.get_photo_url }}" 
                                         class="img-fluid rounded" 
                                         alt="{{ product_instance.name }}"
                                         loading="lazy">
                                </div>
                                <div class="col-8">
                                    <h6 class="mb-1">{{ business_instance.name }}</h6>
                                    <p class="text-muted mb-0">{{ product_instance.name }}</p>
                                </div>
                            </div>
                            
                            <dl class="row mb-0">
                                <dt class="col-6">Horizonte:</dt>
                                <dd class="col-6">{{ simulation_instance.quantity_time }} {{ simulation_instance.unit_time }}</dd>
                                
                                <dt class="col-6">Inicio:</dt>
                                <dd class="col-6">{{ simulation_instance.date_created|date:"d/m/Y" }}</dd>
                                
                                <dt class="col-6">Estado:</dt>
                                <dd class="col-6">
                                    <span class="badge bg-success">Completada</span>
                                </dd>
                            </dl>
                            
                            <!-- Quick Actions -->
                            <hr>
                            <div class="d-grid gap-2">
                                <button class="btn btn-sm btn-outline-primary" onclick="window.print()">
                                    <i class="bx bx-printer me-1"></i>Imprimir
                                </button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="shareResults()">
                                    <i class="bx bx-share-alt me-1"></i>Compartir
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Financial Recommendations -->
                    {% if financial_recommendations_to_show %}
                    <div class="recommendation-card mb-4">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="bx bx-lightbulb me-2"></i>
                                Recomendaciones Financieras
                            </h5>
                        </div>
                        <div class="card-body">
                            {% for recommendation in financial_recommendations_to_show %}
                            <div class="mb-3 p-3 bg-white rounded">
                                <h6 class="fw-bold text-primary">{{ recommendation.name }}</h6>
                                <p class="mb-2">{{ recommendation.recommendation }}</p>
                                <small class="text-muted">
                                    <i class="bx bx-info-circle me-1"></i>
                                    Variable: {{ recommendation.variable_name }}
                                </small>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Daily Results Navigation -->
                    <div class="container mt-4">
                        <div class="data-table-container">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="bx bx-calendar me-2"></i>
                                    Resultados Diarios
                                    <span class="badge bg-info ms-2" id="currentDayIndicator">Día 1</span>
                                </h5>
                            </div>
                            <div class="card-body" style="max-height: 900px; overflow-y: auto;">
                                <div id="dailyResultsContainer">
                                    {% for item in all_variables_extracted %}
                                    <div class="daily-result-item" 
                                        data-day="{{ forloop.counter }}" 
                                        style="{% if not forloop.first %}display: none;{% endif %}">
                                        <h6 class="text-primary mb-3">
                                            <i class="bx bx-calendar-event me-2"></i>
                                            {% if item.date %}
                                                {{ item.date|date:"d/m/Y" }}
                                            {% else %}
                                                Día {{ forloop.counter }}
                                            {% endif %}
                                        </h6>
                                        
                                        <!-- Demanda del día -->
                                        <div class="mb-4">
                                            <div class="row">
                                                <div class="col-6">
                                                    <div class="p-3 bg-primary text-white rounded">
                                                        <small class="d-block opacity-75">Demanda Media</small>
                                                        <h4 class="mb-0">{{ item.demand_mean|floatformat:2 }}</h4>
                                                    </div>
                                                </div>
                                                <div class="col-6">
                                                    <div class="p-3 bg-info text-white rounded">
                                                        <small class="d-block opacity-75">Desviación Estándar</small>
                                                        <h4 class="mb-0">{{ item.demand_std|floatformat:2 }}</h4>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="table-responsive">
                                            <table class="table table-sm table-hover">
                                                <thead>
                                                    <tr>
                                                        <th style="width: 40%">Variable</th>
                                                        <th style="width: 30%">Valor</th>
                                                        <th style="width: 20%">Unidad</th>
                                                        <th style="width: 10%">Estado</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for key, value in item.items %}
                                                        {% if key != 'day' and key != 'date' and key != 'demand_mean' and key != 'demand_std' %}
                                                        <tr>
                                                            <td class="small">
                                                                <strong>{{ key }}</strong>
                                                                <br>
                                                                <small class="text-muted">
                                                                    {% if key == 'PVP' %}Precio de Venta al Público
                                                                    {% elif key == 'TPV' %}Total Productos Vendidos
                                                                    {% elif key == 'IT' %}Ingresos Totales
                                                                    {% elif key == 'TG' %}Total Gastos
                                                                    {% elif key == 'GT' %}Ganancia Total
                                                                    {% elif key == 'NR' %}Nivel de Rentabilidad
                                                                    {% elif key == 'NSC' %}Nivel de Satisfacción del Cliente
                                                                    {% elif key == 'EOG' %}Eficiencia Operativa General
                                                                    {% elif key == 'DPH' %}Demanda Promedio Histórica
                                                                    {% elif key == 'CFD' %}Costo Fijo Diario
                                                                    {% elif key == 'CVU' %}Costo Variable Unitario
                                                                    {% elif key == 'CPROD' %}Capacidad de Producción
                                                                    {% elif key == 'NEPP' %}Número de Empleados en Producción
                                                                    {% else %}{{ key }}
                                                                    {% endif %}
                                                                </small>
                                                            </td>
                                                            <td class="fw-bold">
                                                                {% if key == 'NR' or key == 'NSC' or key == 'EOG' %}
                                                                    {{ value|floatformat:3 }}
                                                                {% elif key == 'PVP' or key == 'IT' or key == 'TG' or key == 'GT' or key == 'CFD' or key == 'CVU' %}
                                                                    {{ value|floatformat:2 }}
                                                                {% else %}
                                                                    {{ value|floatformat:2 }}
                                                                {% endif %}
                                                            </td>
                                                            <td class="small text-muted">
                                                                {% if key == 'TPV' or key == 'DPH' %}Litros
                                                                {% elif key == 'PVP' or key == 'IT' or key == 'TG' or key == 'GT' or key == 'CFD' or key == 'CVU' %}Bs.
                                                                {% elif key == 'NR' or key == 'NSC' or key == 'EOG' %}%
                                                                {% elif key == 'CPROD' %}L/día
                                                                {% elif key == 'NEPP' %}Personas
                                                                {% else %}Unidad
                                                                {% endif %}
                                                            </td>
                                                            <td>
                                                                {% if key == 'NR' %}
                                                                    {% if value >= 0.2 %}
                                                                        <span class="badge bg-success">Óptimo</span>
                                                                    {% elif value >= 0.1 %}
                                                                        <span class="badge bg-warning">Aceptable</span>
                                                                    {% else %}
                                                                        <span class="badge bg-danger">Crítico</span>
                                                                    {% endif %}
                                                                {% elif key == 'NSC' %}
                                                                    {% if value >= 0.9 %}
                                                                        <span class="badge bg-success">Excelente</span>
                                                                    {% elif value >= 0.7 %}
                                                                        <span class="badge bg-warning">Bueno</span>
                                                                    {% else %}
                                                                        <span class="badge bg-danger">Bajo</span>
                                                                    {% endif %}
                                                                {% elif key == 'EOG' %}
                                                                    {% if value >= 0.8 %}
                                                                        <span class="badge bg-success">Alta</span>
                                                                    {% elif value >= 0.6 %}
                                                                        <span class="badge bg-warning">Media</span>
                                                                    {% else %}
                                                                        <span class="badge bg-danger">Baja</span>
                                                                    {% endif %}
                                                                {% else %}
                                                                    <span class="badge bg-info">Normal</span>
                                                                {% endif %}
                                                            </td>
                                                        </tr>
                                                        {% endif %}
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                        
                                        <!-- Additional daily stats -->
                                        <div class="mt-4">
                                            <h6 class="text-muted mb-3">Estadísticas del día</h6>
                                            <div class="row g-3">
                                                <div class="col-6 col-md-3">
                                                    <div class="p-3 bg-light rounded text-center">
                                                        <small class="d-block text-muted">Total Variables</small>
                                                        <h5 class="mb-0">
                                                            {% with total_vars=0 %}
                                                                {% for key, value in item.items %}
                                                                    {% if key != 'day' and key != 'date' and key != 'demand_mean' and key != 'demand_std' %}
                                                                        {% with total_vars=total_vars|add:1 %}{% endwith %}
                                                                    {% endif %}
                                                                {% endfor %}
                                                                {{ item.items|length|add:-4 }}
                                                            {% endwith %}
                                                        </h5>
                                                    </div>
                                                </div>
                                                <div class="col-6 col-md-3">
                                                    <div class="p-3 bg-light rounded text-center">
                                                        <small class="d-block text-muted">Día de Simulación</small>
                                                        <h5 class="mb-0">{{ forloop.counter }}</h5>
                                                    </div>
                                                </div>
                                                {% if item.GT %}
                                                <div class="col-6 col-md-3">
                                                    <div class="p-3 bg-light rounded text-center">
                                                        <small class="d-block text-muted">Ganancia</small>
                                                        <h5 class="mb-0 {% if item.GT > 0 %}text-success{% else %}text-danger{% endif %}">
                                                            {{ item.GT|floatformat:0 }} Bs.
                                                        </h5>
                                                    </div>
                                                </div>
                                                {% endif %}
                                                {% if item.NR %}
                                                <div class="col-6 col-md-3">
                                                    <div class="p-3 bg-light rounded text-center">
                                                        <small class="d-block text-muted">Rentabilidad</small>
                                                        <h5 class="mb-0 {% if item.NR >= 0.2 %}text-success{% elif item.NR >= 0.1 %}text-warning{% else %}text-danger{% endif %}">
                                                            {{ item.NR|floatformat:1 }}%
                                                        </h5>
                                                    </div>
                                                </div>
                                                {% endif %}
                                            </div>
                                        </div>

                                        <!-- Daily notes section -->
                                        <div class="mt-4">
                                            <div class="alert alert-info">
                                                <h6 class="mb-2"><i class="bx bx-info-circle me-2"></i>Análisis del día {{ forloop.counter }}</h6>
                                                <small>
                                                    {% if item.GT and item.NR %}
                                                        Ganancia del día: <strong>{{ item.GT|floatformat:2 }} Bs.</strong> 
                                                        con rentabilidad de <strong>{{ item.NR|floatformat:1 }}%</strong>.
                                                        {% if item.NSC %}
                                                            Satisfacción del cliente: <strong>{{ item.NSC|floatformat:1 }}%</strong>.
                                                        {% endif %}
                                                    {% else %}
                                                        Datos correspondientes a la simulación del día {{ forloop.counter }}. 
                                                        Variables calculadas según el modelo de simulación.
                                                    {% endif %}
                                                </small>
                                            </div>
                                        </div>

                                    </div>
                                    {% empty %}
                                    <div class="text-center py-5">
                                        <i class="bx bx-info-circle display-4 text-muted"></i>
                                        <h5 class="mt-3 text-muted">No hay datos de variables disponibles</h5>
                                        <p class="text-muted">Los resultados de la simulación no contienen datos de variables para mostrar.</p>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            <div class="pagination-controls p-3 bg-light">
                                <div class="d-flex justify-content-between align-items-center">
                                    <button type="button" class="btn btn-sm btn-outline-primary btn-pagination" id="prevDayBtn">
                                        <i class="bx bx-chevron-left me-1"></i>Anterior
                                    </button>
                                    <span class="text-center small text-muted" id="dayCounter">
                                        Día 1 de {{ all_variables_extracted|length }}
                                    </span>
                                    <button type="button" class="btn btn-sm btn-outline-primary btn-pagination" id="nextDayBtn">
                                        Siguiente<i class="bx bx-chevron-right ms-1"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Main Charts and Analysis -->
                <div class="col-lg-8">
                    <!-- Chart Tabs -->
                        <div class="chart-tabs">
                            <ul class="nav nav-tabs" id="chartTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" 
                                            data-bs-target="#overview" type="button" role="tab">
                                        <i class="bx bx-line-chart me-2"></i>
                                        Resumen General
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="financial-tab" data-bs-toggle="tab" 
                                            data-bs-target="#financial" type="button" role="tab">
                                        <i class="bx bx-dollar me-2"></i>
                                        Análisis Financiero
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="operations-tab" data-bs-toggle="tab" 
                                            data-bs-target="#operations" type="button" role="tab">
                                        <i class="bx bx-cog me-2"></i>
                                        Operaciones
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="demand-tab" data-bs-toggle="tab" 
                                            data-bs-target="#demand" type="button" role="tab">
                                        <i class="bx bx-trending-up me-2"></i>
                                        Demanda
                                    </button>
                                </li>
                                <!-- En la sección de Tab Content, agregar nuevos tabs -->
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="endogenous-tab" data-bs-toggle="tab" 
                                            data-bs-target="#endogenous" type="button" role="tab">
                                        <i class="bx bx-scatter-chart me-2"></i>
                                        Variables Endógenas
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="analysis-tab" data-bs-toggle="tab" 
                                            data-bs-target="#analysis" type="button" role="tab">
                                        <i class="bx bx-analyse me-2"></i>
                                        Análisis Estadístico
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="validation-tab" data-bs-toggle="tab" 
                                            data-bs-target="#validation" type="button" role="tab">
                                        <i class="bx bx-check-double me-2"></i>
                                        Validación del Modelo
                                    </button>
                                </li>
                                
                            </ul>
                        </div>
                        <!-- Tab Content -->
                        <div class="tab-content" id="chartTabsContent">
                            <!-- Overview Tab -->
                            <div class="tab-pane fade show active" id="overview" role="tabpanel">
                                
                                <!-- Header de resumen ejecutivo -->
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <div class="executive-summary">
                                            <div class="summary-header">
                                                <h2 class="summary-title">
                                                    <i class="bx bx-chart me-3"></i>
                                                    Resumen Ejecutivo de la Simulación
                                                </h2>
                                                <div class="summary-badges">
                                                    {% if simulation_instance.date_created %}
                                                    <span class="badge bg-info">
                                                        <i class="bx bx-calendar me-1"></i>
                                                        {{ simulation_instance.date_created|date:"d/m/Y H:i" }}
                                                    </span>
                                                    {% endif %}
                                                    <span class="badge bg-success">
                                                        <i class="bx bx-check-circle me-1"></i>
                                                        Simulación Completada
                                                    </span>
                                                </div>
                                            </div>
                                            <div class="summary-description">
                                                <p class="lead">
                                                    Análisis integral de {{ all_variables_extracted|length|default:0 }} días de simulación 
                                                    para <strong>{{ product_instance.name|default:"el producto" }}</strong> de 
                                                    <strong>{{ business_instance.name|default:"la empresa" }}</strong>.
                                                    {% if totales_acumulativos.GT %}
                                                        {% if totales_acumulativos.GT.total > 0 %}
                                                            La simulación proyecta un escenario <span class="text-success font-weight-bold">rentable</span> 
                                                            con ganancias totales de <strong>Bs. {{ totales_acumulativos.GT.total|floatformat:2 }}</strong>.
                                                        {% else %}
                                                            La simulación indica la necesidad de <span class="text-warning font-weight-bold">optimización</span> 
                                                            en la estrategia operativa y financiera.
                                                        {% endif %}
                                                    {% endif %}
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Métricas clave del resumen -->
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <div class="metrics-overview">
                                            <h4 class="metrics-title mb-4">
                                                <i class="bx bx-tachometer me-2"></i>
                                                Métricas Clave de Performance
                                            </h4>
                                            <div class="metrics-grid">
                                                <div class="metric-card metric-revenue">
                                                    <div class="metric-icon">
                                                        <i class="bx bx-dollar-circle"></i>
                                                    </div>
                                                    <div class="metric-content">
                                                        <div class="metric-value">
                                                            {% if totales_acumulativos.IT %}
                                                                Bs. {{ totales_acumulativos.IT.total|floatformat:0|default:"0" }}
                                                            {% else %}
                                                                Bs. 0
                                                            {% endif %}
                                                        </div>
                                                        <div class="metric-label">Ingresos Totales</div>
                                                        <div class="metric-trend">
                                                            {% if totales_acumulativos.IT.trend == "increasing" %}
                                                                <span class="trend-up"><i class="bx bx-trending-up"></i> Creciente</span>
                                                            {% elif totales_acumulativos.IT.trend == "decreasing" %}
                                                                <span class="trend-down"><i class="bx bx-trending-down"></i> Decreciente</span>
                                                            {% else %}
                                                                <span class="trend-stable"><i class="bx bx-minus"></i> Estable</span>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="metric-card metric-profit">
                                                    <div class="metric-icon">
                                                        <i class="bx bx-trending-up"></i>
                                                    </div>
                                                    <div class="metric-content">
                                                        <div class="metric-value">
                                                            {% if totales_acumulativos.GT %}
                                                                Bs. {{ totales_acumulativos.GT.total|floatformat:0|default:"0" }}
                                                            {% else %}
                                                                Bs. 0
                                                            {% endif %}
                                                        </div>
                                                        <div class="metric-label">Ganancia Neta</div>
                                                        <div class="metric-trend">
                                                            {% if totales_acumulativos.GT %}
                                                                {% if totales_acumulativos.GT.total > 0 %}
                                                                    <span class="trend-up"><i class="bx bx-check-circle"></i> Rentable</span>
                                                                {% else %}
                                                                    <span class="trend-down"><i class="bx bx-x-circle"></i> Con pérdidas</span>
                                                                {% endif %}
                                                            {% else %}
                                                                <span class="trend-stable">No disponible</span>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="metric-card metric-efficiency">
                                                    <div class="metric-icon">
                                                        <i class="bx bx-cog"></i>
                                                    </div>
                                                    <div class="metric-content">
                                                        <div class="metric-value">
                                                            {% if totales_acumulativos.EOG and all_variables_extracted|length > 0 %}
                                                                {% widthratio totales_acumulativos.EOG.total 1 all_variables_extracted|length as avg_eff %}
                                                                {% widthratio avg_eff 1 100 as eff_percent %}
                                                                {{ eff_percent|floatformat:1 }}%
                                                            {% else %}
                                                                0.0%
                                                            {% endif %}
                                                        </div>
                                                        <div class="metric-label">Eficiencia Operativa</div>
                                                        <div class="metric-trend">
                                                            {% if eff_percent >= 80 %}
                                                                <span class="trend-up"><i class="bx bx-check"></i> Excelente</span>
                                                            {% elif eff_percent >= 60 %}
                                                                <span class="trend-stable"><i class="bx bx-info-circle"></i> Buena</span>
                                                            {% else %}
                                                                <span class="trend-down"><i class="bx bx-error"></i> Necesita mejora</span>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="metric-card metric-margin">
                                                    <div class="metric-icon">
                                                        <i class="bx bx-percentage"></i>
                                                    </div>
                                                    <div class="metric-content">
                                                        <div class="metric-value">
                                                            {% if totales_acumulativos.NR and all_variables_extracted|length > 0 %}
                                                                {% widthratio totales_acumulativos.NR.total 1 all_variables_extracted|length as avg_margin %}
                                                                {% widthratio avg_margin 1 100 as margin_percent %}
                                                                {{ margin_percent|floatformat:1 }}%
                                                            {% else %}
                                                                0.0%
                                                            {% endif %}
                                                        </div>
                                                        <div class="metric-label">Margen de Rentabilidad</div>
                                                        <div class="metric-trend">
                                                            {% if margin_percent >= 20 %}
                                                                <span class="trend-up"><i class="bx bx-star"></i> Excelente</span>
                                                            {% elif margin_percent >= 10 %}
                                                                <span class="trend-stable"><i class="bx bx-check"></i> Aceptable</span>
                                                            {% else %}
                                                                <span class="trend-down"><i class="bx bx-error"></i> Bajo</span>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Gráficos principales del overview -->
                                <div class="row mb-4">
                                    <div class="col-lg-6 mb-4">
                                        <div class="chart-container">
                                            <div class="chart-header">
                                                <h6 class="chart-title mb-3">
                                                    <i class="bx bx-dollar me-2"></i>
                                                    Evolución Financiera: Ingresos vs Ganancias
                                                </h6>
                                                <div class="chart-controls">
                                                    {% if image_data_ingresos_gastos %}
                                                    <div class="chart-control-btn" onclick="downloadChart('{{ image_data_ingresos_gastos }}', 'ingresos-ganancias.png')" title="Descargar">
                                                        <i class="bx bx-download"></i>
                                                    </div>
                                                    <div class="chart-control-btn" onclick="openFullscreen('{{ image_data_ingresos_gastos }}', 'Ingresos vs Ganancias')" title="Pantalla completa">
                                                        <i class="bx bx-fullscreen"></i>
                                                    </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            {% if image_data_ingresos_gastos %}
                                            <img src="data:image/png;base64,{{ image_data_ingresos_gastos }}" 
                                                class="chart-image" 
                                                alt="Evolución Financiera: Ingresos vs Ganancias"
                                                loading="lazy">
                                            {% else %}
                                            <div class="chart-placeholder">
                                                <i class="bx bx-chart text-muted" style="font-size: 3rem;"></i>
                                                <p class="text-muted mt-2">Gráfico financiero no disponible</p>
                                                <small class="text-muted">Los datos se generarán durante el análisis</small>
                                            </div>
                                            {% endif %}
                                            <div class="chart-summary">
                                                <small class="text-muted">
                                                    {% if totales_acumulativos.IT and totales_acumulativos.GT %}
                                                        Rendimiento financiero: 
                                                        {% if totales_acumulativos.GT.total > 0 %}
                                                            <span class="text-success">Positivo</span> - 
                                                            Margen del {{ margin_percent|floatformat:1 }}%
                                                        {% else %}
                                                            <span class="text-danger">Requiere optimización</span>
                                                        {% endif %}
                                                    {% else %}
                                                        Análisis financiero en proceso
                                                    {% endif %}
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-lg-6 mb-4">
                                        <div class="chart-container">
                                            <div class="chart-header">
                                                <h6 class="chart-title mb-3">
                                                    <i class="bx bx-line-chart me-2"></i>
                                                    Comportamiento de la Demanda
                                                </h6>
                                                <div class="chart-controls">
                                                    {% if image_data_simulation %}
                                                    <div class="chart-control-btn" onclick="downloadChart('{{ image_data_simulation }}', 'tendencia-demanda.png')" title="Descargar">
                                                        <i class="bx bx-download"></i>
                                                    </div>
                                                    <div class="chart-control-btn" onclick="openFullscreen('{{ image_data_simulation }}', 'Tendencia de Demanda')" title="Pantalla completa">
                                                        <i class="bx bx-fullscreen"></i>
                                                    </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            {% if image_data_simulation %}
                                            <img src="data:image/png;base64,{{ image_data_simulation }}" 
                                                class="chart-image" 
                                                alt="Comportamiento de la Demanda"
                                                loading="lazy">
                                            {% else %}
                                            <div class="chart-placeholder">
                                                <i class="bx bx-chart text-muted" style="font-size: 3rem;"></i>
                                                <p class="text-muted mt-2">Gráfico de demanda no disponible</p>
                                                <small class="text-muted">Los datos se generarán durante el análisis</small>
                                            </div>
                                            {% endif %}
                                            <div class="chart-summary">
                                                <small class="text-muted">
                                                    {% if growth_rate %}
                                                        Tendencia de crecimiento: 
                                                        {% if growth_rate > 0 %}
                                                            <span class="text-success">+{{ growth_rate|floatformat:2 }}%</span> - Creciente
                                                        {% elif growth_rate < 0 %}
                                                            <span class="text-danger">{{ growth_rate|floatformat:2 }}%</span> - Decreciente
                                                        {% else %}
                                                            <span class="text-info">{{ growth_rate|floatformat:2 }}%</span> - Estable
                                                        {% endif %}
                                                    {% else %}
                                                        Análisis de tendencia en proceso
                                                    {% endif %}
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Gráficos adicionales de overview -->
                                <div class="row mb-4">
                                    <div class="col-lg-4 mb-3">
                                        <div class="chart-container compact">
                                            <h6 class="chart-title mb-3">
                                                <i class="bx bx-pie-chart me-2"></i>
                                                Distribución de Costos
                                            </h6>
                                            {% if image_data_costos or image_data_gastos %}
                                            <img src="data:image/png;base64,{{ image_data_costos|default:image_data_gastos }}" 
                                                class="chart-image" 
                                                alt="Distribución de Costos"
                                                loading="lazy">
                                            {% else %}
                                            <div class="chart-placeholder compact">
                                                <i class="bx bx-pie-chart text-muted" style="font-size: 2rem;"></i>
                                                <p class="text-muted mt-2">No disponible</p>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>

                                    <div class="col-lg-4 mb-3">
                                        <div class="chart-container compact">
                                            <h6 class="chart-title mb-3">
                                                <i class="bx bx-bar-chart me-2"></i>
                                                Eficiencia Operativa
                                            </h6>
                                            {% if image_data_eficiencia %}
                                            <img src="data:image/png;base64,{{ image_data_eficiencia }}" 
                                                class="chart-image" 
                                                alt="Eficiencia Operativa"
                                                loading="lazy">
                                            {% else %}
                                            <div class="chart-placeholder compact">
                                                <i class="bx bx-bar-chart text-muted" style="font-size: 2rem;"></i>
                                                <p class="text-muted mt-2">No disponible</p>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>

                                    <div class="col-lg-4 mb-3">
                                        <div class="chart-container compact">
                                            <h6 class="chart-title mb-3">
                                                <i class="bx bx-trending-up me-2"></i>
                                                Análisis de ROI
                                            </h6>
                                            {% if image_data_roi or image_data_kpis %}
                                            <img src="data:image/png;base64,{{ image_data_roi|default:image_data_kpis }}" 
                                                class="chart-image" 
                                                alt="Análisis de ROI"
                                                loading="lazy">
                                            {% else %}
                                            <div class="chart-placeholder compact">
                                                <i class="bx bx-trending-up text-muted" style="font-size: 2rem;"></i>
                                                <p class="text-muted mt-2">No disponible</p>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>

                                <!-- Resumen de insights y recomendaciones -->
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <div class="insights-overview">
                                            <h4 class="insights-title mb-4">
                                                <i class="bx bx-lightbulb me-2"></i>
                                                Insights Principales y Recomendaciones
                                            </h4>
                                            <div class="row">
                                                <div class="col-lg-8">
                                                    <div class="insights-list">
                                                        <!-- Insight financiero -->
                                                        <div class="insight-item">
                                                            <div class="insight-icon bg-success">
                                                                <i class="bx bx-dollar"></i>
                                                            </div>
                                                            <div class="insight-content">
                                                                <h6 class="insight-title">Performance Financiera</h6>
                                                                <p class="insight-description">
                                                                    {% if totales_acumulativos.GT %}
                                                                        {% if totales_acumulativos.GT.total > 0 %}
                                                                            La simulación proyecta una rentabilidad positiva de 
                                                                            <strong>Bs. {{ totales_acumulativos.GT.total|floatformat:2 }}</strong>, 
                                                                            indicando un modelo de negocio viable.
                                                                        {% else %}
                                                                            Los resultados muestran necesidad de optimización en costos y 
                                                                            estrategias de precios para alcanzar rentabilidad.
                                                                        {% endif %}
                                                                    {% else %}
                                                                        Análisis financiero en proceso de cálculo.
                                                                    {% endif %}
                                                                </p>
                                                            </div>
                                                        </div>

                                                        <!-- Insight operativo -->
                                                        <div class="insight-item">
                                                            <div class="insight-icon bg-info">
                                                                <i class="bx bx-cog"></i>
                                                            </div>
                                                            <div class="insight-content">
                                                                <h6 class="insight-title">Eficiencia Operativa</h6>
                                                                <p class="insight-description">
                                                                    {% if eff_percent %}
                                                                        La eficiencia operativa promedio del {{ eff_percent|floatformat:1 }}% 
                                                                        {% if eff_percent >= 80 %}
                                                                            demuestra procesos optimizados y alta productividad.
                                                                        {% elif eff_percent >= 60 %}
                                                                            indica un rendimiento aceptable con oportunidades de mejora.
                                                                        {% else %}
                                                                            requiere atención inmediata para optimizar procesos y recursos.
                                                                        {% endif %}
                                                                    {% else %}
                                                                        Los indicadores operativos están siendo analizados para identificar oportunidades de mejora.
                                                                    {% endif %}
                                                                </p>
                                                            </div>
                                                        </div>

                                                        <!-- Insight de demanda -->
                                                        <div class="insight-item">
                                                            <div class="insight-icon bg-warning">
                                                                <i class="bx bx-trending-up"></i>
                                                            </div>
                                                            <div class="insight-content">
                                                                <h6 class="insight-title">Comportamiento de Demanda</h6>
                                                                <p class="insight-description">
                                                                    {% if growth_rate %}
                                                                        El análisis revela una tasa de crecimiento del {{ growth_rate|floatformat:2 }}%, 
                                                                        {% if growth_rate > 0 %}
                                                                            sugiriendo oportunidades de expansión y crecimiento del mercado.
                                                                        {% elif growth_rate < 0 %}
                                                                            indicando la necesidad de estrategias para revertir la tendencia.
                                                                        {% else %}
                                                                            mostrando un mercado estable con demanda predecible.
                                                                        {% endif %}
                                                                    {% else %}
                                                                        El comportamiento de la demanda está siendo analizado para identificar patrones y tendencias.
                                                                    {% endif %}
                                                                </p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="col-lg-4">
                                                    <div class="recommendations-card">
                                                        <h6 class="recommendations-title">
                                                            <i class="bx bx-check-square me-2"></i>
                                                            Acciones Recomendadas
                                                        </h6>
                                                        <div class="recommendations-list">
                                                            {% if margin_percent < 15 %}
                                                            <div class="recommendation-item">
                                                                <i class="bx bx-arrow-to-right text-danger"></i>
                                                                <span>Revisar estructura de costos</span>
                                                            </div>
                                                            {% endif %}
                                                            
                                                            {% if eff_percent < 70 %}
                                                            <div class="recommendation-item">
                                                                <i class="bx bx-arrow-to-right text-warning"></i>
                                                                <span>Optimizar procesos operativos</span>
                                                            </div>
                                                            {% endif %}
                                                            
                                                            {% if growth_rate > 5 %}
                                                            <div class="recommendation-item">
                                                                <i class="bx bx-arrow-to-right text-success"></i>
                                                                <span>Considerar expansión de capacidad</span>
                                                            </div>
                                                            {% elif growth_rate < -2 %}
                                                            <div class="recommendation-item">
                                                                <i class="bx bx-arrow-to-right text-info"></i>
                                                                <span>Desarrollar estrategias de mercado</span>
                                                            </div>
                                                            {% endif %}

                                                            <div class="recommendation-item">
                                                                <i class="bx bx-arrow-to-right text-primary"></i>
                                                                <span>Monitorear KPIs continuamente</span>
                                                            </div>

                                                            <div class="recommendation-item">
                                                                <i class="bx bx-arrow-to-right text-secondary"></i>
                                                                <span>Implementar mejora continua</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Modal para pantalla completa -->
                                <div class="modal fade" id="fullscreenModal" tabindex="-1">
                                    <div class="modal-dialog modal-xl modal-fullscreen-lg-down">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="fullscreenModalTitle">Gráfico Overview</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                            </div>
                                            <div class="modal-body text-center">
                                                <img id="fullscreenModalImage" src="" class="img-fluid" alt="Gráfico expandido">
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-outline-primary" onclick="downloadCurrentChart()">
                                                    <i class="bx bx-download me-1"></i>Descargar
                                                </button>
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Financial Tab - Actualización completa -->
                            <div class="tab-pane fade" id="financial" role="tabpanel">
                                
                                <!-- Header con resumen financiero -->
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <div class="alert alert-success">
                                            <h4 class="alert-heading mb-3">
                                                <i class="bx bx-dollar-circle me-2"></i>
                                                Análisis Financiero Integral
                                            </h4>
                                            <p class="mb-2">
                                                Análisis completo de la performance financiera de la simulación, incluyendo ingresos, gastos, 
                                                rentabilidad y métricas clave de rendimiento financiero.
                                            </p>
                                            <small class="text-muted">
                                                Período analizado: <strong>{{ all_variables_extracted|length|default:0 }} días</strong> | 
                                                {% if totales_acumulativos.GT %}
                                                    Ganancia total: <strong>Bs. {{ totales_acumulativos.GT.total|floatformat:2|default:"0.00" }}</strong>
                                                {% endif %}
                                            </small>
                                        </div>
                                    </div>
                                </div>

                                <!-- Métricas financieras principales -->
                                <div class="row mb-4">
                                    <div class="col-md-3">
                                        <div class="card bg-gradient-success text-white">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between">
                                                    <div>
                                                        <h6 class="text-white-50">Ingresos Totales</h6>
                                                        <h3 class="mb-0">
                                                            {% if totales_acumulativos.IT %}
                                                                Bs. {{ totales_acumulativos.IT.total|floatformat:0|default:"0" }}
                                                            {% else %}
                                                                Bs. 0
                                                            {% endif %}
                                                        </h3>
                                                    </div>
                                                    <div class="align-self-center">
                                                        <i class="bx bx-dollar display-6"></i>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card bg-gradient-danger text-white">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between">
                                                    <div>
                                                        <h6 class="text-white-50">Gastos Totales</h6>
                                                        <h3 class="mb-0">
                                                            {% if totales_acumulativos.TG %}
                                                                Bs. {{ totales_acumulativos.TG.total|floatformat:0|default:"0" }}
                                                            {% else %}
                                                                Bs. 0
                                                            {% endif %}
                                                        </h3>
                                                    </div>
                                                    <div class="align-self-center">
                                                        <i class="bx bx-trending-down display-6"></i>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card bg-gradient-primary text-white">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between">
                                                    <div>
                                                        <h6 class="text-white-50">Ganancia Neta</h6>
                                                        <h3 class="mb-0">
                                                            {% if totales_acumulativos.GT %}
                                                                Bs. {{ totales_acumulativos.GT.total|floatformat:0|default:"0" }}
                                                            {% else %}
                                                                Bs. 0
                                                            {% endif %}
                                                        </h3>
                                                    </div>
                                                    <div class="align-self-center">
                                                        <i class="bx bx-trending-up display-6"></i>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card bg-gradient-info text-white">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between">
                                                    <div>
                                                        <h6 class="text-white-50">Margen Promedio</h6>
                                                        <h3 class="mb-0">
                                                            {% if totales_acumulativos.NR %}
                                                                {% widthratio totales_acumulativos.NR.total 1 all_variables_extracted|length as avg_margin %}
                                                                {% widthratio avg_margin 1 100 as margin_percent %}
                                                                {{ margin_percent|floatformat:1 }}%
                                                            {% else %}
                                                                0.0%
                                                            {% endif %}
                                                        </h3>
                                                    </div>
                                                    <div class="align-self-center">
                                                        <i class="bx bx-percentage display-6"></i>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Gráficos principales -->
                                <div class="row">
                                    <!-- Ingresos vs Ganancias -->
                                    <div class="col-md-6 mb-4">
                                        <div class="chart-container">
                                            <div class="chart-header">
                                                <h6 class="mb-3">
                                                    <i class="bx bx-dollar me-2"></i>
                                                    Evolución de Ingresos vs Ganancias
                                                </h6>
                                                <div class="chart-controls">
                                                    {% if image_data_ingresos_gastos %}
                                                    <div class="chart-control-btn" onclick="downloadChart('{{ image_data_ingresos_gastos }}', 'ingresos-ganancias.png')" title="Descargar">
                                                        <i class="bx bx-download"></i>
                                                    </div>
                                                    <div class="chart-control-btn" onclick="openFullscreen('{{ image_data_ingresos_gastos }}', 'Ingresos vs Ganancias')" title="Pantalla completa">
                                                        <i class="bx bx-fullscreen"></i>
                                                    </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            {% if image_data_ingresos_gastos %}
                                            <img src="data:image/png;base64,{{ image_data_ingresos_gastos }}" 
                                                class="chart-image" 
                                                alt="Evolución de Ingresos vs Ganancias"
                                                loading="lazy">
                                            {% else %}
                                            <div class="chart-placeholder">
                                                <i class="bx bx-chart text-muted" style="font-size: 3rem;"></i>
                                                <p class="text-muted mt-2">Gráfico de ingresos vs ganancias no disponible</p>
                                                <small class="text-muted">Los datos se generarán durante el análisis</small>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    
                                    <!-- Análisis de Gastos -->
                                    <div class="col-md-6 mb-4">
                                        <div class="chart-container">
                                            <div class="chart-header">
                                                <h6 class="mb-3">
                                                    <i class="bx bx-trending-down me-2"></i>
                                                    Composición y Evolución de Gastos
                                                </h6>
                                                <div class="chart-controls">
                                                    {% if image_data_gastos or image_data_rentabilidad %}
                                                    <div class="chart-control-btn" onclick="downloadChart('{{ image_data_gastos|default:image_data_rentabilidad }}', 'analisis-gastos.png')" title="Descargar">
                                                        <i class="bx bx-download"></i>
                                                    </div>
                                                    <div class="chart-control-btn" onclick="openFullscreen('{{ image_data_gastos|default:image_data_rentabilidad }}', 'Análisis de Gastos')" title="Pantalla completa">
                                                        <i class="bx bx-fullscreen"></i>
                                                    </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            {% if image_data_gastos %}
                                            <img src="data:image/png;base64,{{ image_data_gastos }}" 
                                                class="chart-image" 
                                                alt="Análisis de gastos"
                                                loading="lazy">
                                            {% elif image_data_rentabilidad %}
                                            <img src="data:image/png;base64,{{ image_data_rentabilidad }}" 
                                                class="chart-image" 
                                                alt="Análisis de rentabilidad y gastos"
                                                loading="lazy">
                                            {% else %}
                                            <div class="chart-placeholder">
                                                <i class="bx bx-chart text-muted" style="font-size: 3rem;"></i>
                                                <p class="text-muted mt-2">Gráfico de análisis de gastos no disponible</p>
                                                <small class="text-muted">Los datos se generarán durante el análisis</small>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    
                                    <!-- Costos de Producción -->
                                    <div class="col-md-6 mb-4">
                                        <div class="chart-container">
                                            <div class="chart-header">
                                                <h6 class="mb-3">
                                                    <i class="bx bx-calculator me-2"></i>
                                                    Estructura de Costos de Producción
                                                </h6>
                                                <div class="chart-controls">
                                                    {% if image_data_costos or image_data_eficiencia %}
                                                    <div class="chart-control-btn" onclick="downloadChart('{{ image_data_costos|default:image_data_eficiencia }}', 'costos-produccion.png')" title="Descargar">
                                                        <i class="bx bx-download"></i>
                                                    </div>
                                                    <div class="chart-control-btn" onclick="openFullscreen('{{ image_data_costos|default:image_data_eficiencia }}', 'Costos de Producción')" title="Pantalla completa">
                                                        <i class="bx bx-fullscreen"></i>
                                                    </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            {% if image_data_costos %}
                                            <img src="data:image/png;base64,{{ image_data_costos }}" 
                                                class="chart-image" 
                                                alt="Costos de producción"
                                                loading="lazy">
                                            {% elif image_data_eficiencia %}
                                            <img src="data:image/png;base64,{{ image_data_eficiencia }}" 
                                                class="chart-image" 
                                                alt="Eficiencia y costos"
                                                loading="lazy">
                                            {% else %}
                                            <div class="chart-placeholder">
                                                <i class="bx bx-chart text-muted" style="font-size: 3rem;"></i>
                                                <p class="text-muted mt-2">Gráfico de costos de producción no disponible</p>
                                                <small class="text-muted">Los datos se generarán durante el análisis</small>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>

                                    <!-- Rentabilidad y ROI -->
                                    <div class="col-md-6 mb-4">
                                        <div class="chart-container">
                                            <div class="chart-header">
                                                <h6 class="mb-3">
                                                    <i class="bx bx-stats me-2"></i>
                                                    Rentabilidad y ROI
                                                </h6>
                                                <div class="chart-controls">
                                                    {% if image_data_roi or image_data_kpis %}
                                                    <div class="chart-control-btn" onclick="downloadChart('{{ image_data_roi|default:image_data_kpis }}', 'roi-rentabilidad.png')" title="Descargar">
                                                        <i class="bx bx-download"></i>
                                                    </div>
                                                    <div class="chart-control-btn" onclick="openFullscreen('{{ image_data_roi|default:image_data_kpis }}', 'ROI y Rentabilidad')" title="Pantalla completa">
                                                        <i class="bx bx-fullscreen"></i>
                                                    </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            {% if image_data_roi %}
                                            <img src="data:image/png;base64,{{ image_data_roi }}" 
                                                class="chart-image" 
                                                alt="ROI y rentabilidad"
                                                loading="lazy">
                                            {% elif image_data_kpis %}
                                            <img src="data:image/png;base64,{{ image_data_kpis }}" 
                                                class="chart-image" 
                                                alt="KPIs financieros"
                                                loading="lazy">
                                            {% else %}
                                            <div class="chart-placeholder">
                                                <i class="bx bx-chart text-muted" style="font-size: 3rem;"></i>
                                                <p class="text-muted mt-2">Gráfico de ROI y rentabilidad no disponible</p>
                                                <small class="text-muted">Los datos se generarán durante el análisis</small>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>

                                <!-- Gráficos de variables financieras endógenas -->
                                {% if endogenous_charts %}
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <h5 class="mb-3">
                                            <i class="bx bx-line-chart me-2"></i>
                                            Variables Financieras Endógenas
                                        </h5>
                                    </div>
                                    
                                    {% for chart_name, chart_data in endogenous_charts.items %}
                                        {% if 'IT' in chart_name or 'GT' in chart_name or 'TG' in chart_name or 'NR' in chart_name %}
                                        <div class="col-md-6 mb-4">
                                            <div class="chart-container">
                                                <div class="chart-header">
                                                    <h6 class="mb-3">
                                                        {% if 'IT' in chart_name %}
                                                            <i class="bx bx-dollar text-success me-2"></i>Evolución de Ingresos Totales
                                                        {% elif 'GT' in chart_name %}
                                                            <i class="bx bx-trending-up text-primary me-2"></i>Evolución de Ganancia Total
                                                        {% elif 'TG' in chart_name %}
                                                            <i class="bx bx-trending-down text-danger me-2"></i>Evolución de Total Gastos
                                                        {% elif 'NR' in chart_name %}
                                                            <i class="bx bx-percentage text-info me-2"></i>Evolución del Nivel de Rentabilidad
                                                        {% endif %}
                                                    </h6>
                                                    <div class="chart-controls">
                                                        <div class="chart-control-btn" onclick="downloadChart('{{ chart_data }}', '{{ chart_name }}.png')" title="Descargar">
                                                            <i class="bx bx-download"></i>
                                                        </div>
                                                        <div class="chart-control-btn" onclick="openFullscreen('{{ chart_data }}', '{{ chart_name }}')" title="Pantalla completa">
                                                            <i class="bx bx-fullscreen"></i>
                                                        </div>
                                                    </div>
                                                </div>
                                                <img src="data:image/png;base64,{{ chart_data }}" 
                                                    class="chart-image" 
                                                    alt="{{ chart_name }}"
                                                    loading="lazy">
                                            </div>
                                        </div>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                                {% endif %}

                                <!-- Análisis financiero detallado -->
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <h5 class="mb-3">
                                            <i class="bx bx-analytics me-2"></i>
                                            Análisis Financiero Detallado
                                        </h5>
                                    </div>
                                    
                                    <!-- Flujo de caja y liquidez -->
                                    <div class="col-lg-6 mb-4">
                                        <div class="chart-container">
                                            <div class="chart-header">
                                                <h6 class="mb-3">
                                                    <i class="bx bx-money me-2"></i>
                                                    Flujo de Caja Operativo
                                                </h6>
                                                <div class="chart-controls">
                                                    {% if image_data_flujo_caja or additional_analisis_costos_detallado %}
                                                    <div class="chart-control-btn" onclick="downloadChart('{{ image_data_flujo_caja|default:additional_analisis_costos_detallado }}', 'flujo-caja.png')" title="Descargar">
                                                        <i class="bx bx-download"></i>
                                                    </div>
                                                    <div class="chart-control-btn" onclick="openFullscreen('{{ image_data_flujo_caja|default:additional_analisis_costos_detallado }}', 'Flujo de Caja')" title="Pantalla completa">
                                                        <i class="bx bx-fullscreen"></i>
                                                    </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            {% if image_data_flujo_caja %}
                                            <img src="data:image/png;base64,{{ image_data_flujo_caja }}" 
                                                class="chart-image" 
                                                alt="Flujo de caja operativo"
                                                loading="lazy">
                                            {% elif additional_analisis_costos_detallado %}
                                            <img src="data:image/png;base64,{{ additional_analisis_costos_detallado }}" 
                                                class="chart-image" 
                                                alt="Análisis detallado de costos"
                                                loading="lazy">
                                            {% else %}
                                            <div class="chart-placeholder">
                                                <i class="bx bx-chart text-muted" style="font-size: 3rem;"></i>
                                                <p class="text-muted mt-2">Gráfico de flujo de caja no disponible</p>
                                                <small class="text-muted">Los datos se generarán durante el análisis</small>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>

                                    <!-- Indicadores de eficiencia financiera -->
                                    <div class="col-lg-6 mb-4">
                                        <div class="chart-container">
                                            <div class="chart-header">
                                                <h6 class="mb-3">
                                                    <i class="bx bx-tachometer me-2"></i>
                                                    Indicadores de Eficiencia Financiera
                                                </h6>
                                                <div class="chart-controls">
                                                    {% if image_data_indicadores or additional_eficiencia_operativa %}
                                                    <div class="chart-control-btn" onclick="downloadChart('{{ image_data_indicadores|default:additional_eficiencia_operativa }}', 'indicadores-financieros.png')" title="Descargar">
                                                        <i class="bx bx-download"></i>
                                                    </div>
                                                    <div class="chart-control-btn" onclick="openFullscreen('{{ image_data_indicadores|default:additional_eficiencia_operativa }}', 'Indicadores Financieros')" title="Pantalla completa">
                                                        <i class="bx bx-fullscreen"></i>
                                                    </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            {% if image_data_indicadores %}
                                            <img src="data:image/png;base64,{{ image_data_indicadores }}" 
                                                class="chart-image" 
                                                alt="Indicadores de eficiencia financiera"
                                                loading="lazy">
                                            {% elif additional_eficiencia_operativa %}
                                            <img src="data:image/png;base64,{{ additional_eficiencia_operativa }}" 
                                                class="chart-image" 
                                                alt="Eficiencia operativa"
                                                loading="lazy">
                                            {% else %}
                                            <div class="chart-placeholder">
                                                <i class="bx bx-chart text-muted" style="font-size: 3rem;"></i>
                                                <p class="text-muted mt-2">Gráfico de indicadores financieros no disponible</p>
                                                <small class="text-muted">Los datos se generarán durante el análisis</small>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>

                                <!-- Proyecciones y tendencias -->
                                {% if image_data_proyecciones or image_data_tendencias %}
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <h5 class="mb-3">
                                            <i class="bx bx-trending-up me-2"></i>
                                            Proyecciones y Tendencias Financieras
                                        </h5>
                                    </div>
                                    
                                    {% if image_data_proyecciones %}
                                    <div class="col-lg-6 mb-4">
                                        <div class="chart-container">
                                            <div class="chart-header">
                                                <h6 class="mb-3">
                                                    <i class="bx bx-line-chart me-2"></i>
                                                    Proyecciones Financieras
                                                </h6>
                                                <div class="chart-controls">
                                                    <div class="chart-control-btn" onclick="downloadChart('{{ image_data_proyecciones }}', 'proyecciones-financieras.png')" title="Descargar">
                                                        <i class="bx bx-download"></i>
                                                    </div>
                                                    <div class="chart-control-btn" onclick="openFullscreen('{{ image_data_proyecciones }}', 'Proyecciones Financieras')" title="Pantalla completa">
                                                        <i class="bx bx-fullscreen"></i>
                                                    </div>
                                                </div>
                                            </div>
                                            <img src="data:image/png;base64,{{ image_data_proyecciones }}" 
                                                class="chart-image" 
                                                alt="Proyecciones financieras"
                                                loading="lazy">
                                        </div>
                                    </div>
                                    {% endif %}

                                    {% if image_data_tendencias %}
                                    <div class="col-lg-6 mb-4">
                                        <div class="chart-container">
                                            <div class="chart-header">
                                                <h6 class="mb-3">
                                                    <i class="bx bx-stats me-2"></i>
                                                    Análisis de Tendencias
                                                </h6>
                                                <div class="chart-controls">
                                                    <div class="chart-control-btn" onclick="downloadChart('{{ image_data_tendencias }}', 'tendencias-financieras.png')" title="Descargar">
                                                        <i class="bx bx-download"></i>
                                                    </div>
                                                    <div class="chart-control-btn" onclick="openFullscreen('{{ image_data_tendencias }}', 'Tendencias Financieras')" title="Pantalla completa">
                                                        <i class="bx bx-fullscreen"></i>
                                                    </div>
                                                </div>
                                            </div>
                                            <img src="data:image/png;base64,{{ image_data_tendencias }}" 
                                                class="chart-image" 
                                                alt="Análisis de tendencias"
                                                loading="lazy">
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                                {% endif %}

                                <!-- Tabla resumen financiero -->
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <div class="card">
                                            <div class="card-header">
                                                <h5 class="card-title mb-0">
                                                    <i class="bx bx-table me-2"></i>
                                                    Resumen Financiero por Variable
                                                </h5>
                                            </div>
                                            <div class="card-body">
                                                <div class="table-responsive">
                                                    <table class="table table-hover">
                                                        <thead>
                                                            <tr>
                                                                <th>Variable Financiera</th>
                                                                <th>Valor Total</th>
                                                                <th>Promedio Diario</th>
                                                                <th>Tendencia</th>
                                                                <th>Estado</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {% for name_variable, info_variable in totales_acumulativos.items %}
                                                                {% if 'IT' in name_variable or 'GT' in name_variable or 'TG' in name_variable or 'NR' in name_variable or 'PVP' in name_variable or 'CFD' in name_variable or 'CVU' in name_variable %}
                                                                <tr>
                                                                    <td>
                                                                        <strong>
                                                                            {% if name_variable == 'IT' %}Ingresos Totales
                                                                            {% elif name_variable == 'GT' %}Ganancia Total
                                                                            {% elif name_variable == 'TG' %}Total Gastos
                                                                            {% elif name_variable == 'NR' %}Nivel de Rentabilidad
                                                                            {% elif name_variable == 'PVP' %}Precio de Venta al Público
                                                                            {% elif name_variable == 'CFD' %}Costo Fijo Diario
                                                                            {% elif name_variable == 'CVU' %}Costo Variable Unitario
                                                                            {% else %}{{ name_variable }}
                                                                            {% endif %}
                                                                        </strong>
                                                                        <br>
                                                                        <small class="text-muted">{{ name_variable }}</small>
                                                                    </td>
                                                                    <td class="fw-bold">
                                                                        {% if info_variable.unit == "BS" %}
                                                                            <span class="text-success">Bs. {{ info_variable.total|floatformat:2 }}</span>
                                                                        {% elif "%" in info_variable.unit %}
                                                                            <span class="text-info">{{ info_variable.total|floatformat:3 }}</span>
                                                                        {% else %}
                                                                            {{ info_variable.total|floatformat:2 }}
                                                                        {% endif %}
                                                                    </td>
                                                                    <td>
                                                                        {% if all_variables_extracted|length > 0 %}
                                                                            {% widthratio info_variable.total 1 all_variables_extracted|length as daily_avg %}
                                                                            {% if info_variable.unit == "BS" %}
                                                                                Bs. {{ daily_avg|floatformat:2 }}
                                                                            {% elif "%" in info_variable.unit %}
                                                                                {{ daily_avg|floatformat:3 }}
                                                                            {% else %}
                                                                                {{ daily_avg|floatformat:2 }}
                                                                            {% endif %}
                                                                        {% else %}
                                                                            N/A
                                                                        {% endif %}
                                                                    </td>
                                                                    <td>
                                                                        {% if info_variable.trend == "increasing" %}
                                                                            <span class="badge bg-success">
                                                                                <i class="bx bx-trending-up me-1"></i>Creciente
                                                                            </span>
                                                                        {% elif info_variable.trend == "decreasing" %}
                                                                            <span class="badge bg-danger">
                                                                                <i class="bx bx-trending-down me-1"></i>Decreciente
                                                                            </span>
                                                                        {% else %}
                                                                            <span class="badge bg-secondary">
                                                                                <i class="bx bx-minus me-1"></i>Estable
                                                                            </span>
                                                                        {% endif %}
                                                                    </td>
                                                                    <td>
                                                                        {% if name_variable == 'GT' %}
                                                                            {% if info_variable.total > 0 %}
                                                                                <span class="badge bg-success">Rentable</span>
                                                                            {% else %}
                                                                                <span class="badge bg-danger">Con pérdidas</span>
                                                                            {% endif %}
                                                                        {% elif name_variable == 'NR' %}
                                                                            {% if info_variable.total > 0.2 %}
                                                                                <span class="badge bg-success">Excelente</span>
                                                                            {% elif info_variable.total > 0.1 %}
                                                                                <span class="badge bg-warning">Bueno</span>
                                                                            {% else %}
                                                                                <span class="badge bg-danger">Bajo</span>
                                                                            {% endif %}
                                                                        {% else %}
                                                                            <span class="badge bg-info">Normal</span>
                                                                        {% endif %}
                                                                    </td>
                                                                </tr>
                                                                {% endif %}
                                                            {% empty %}
                                                            <tr>
                                                                <td colspan="5" class="text-center py-4">
                                                                    <i class="bx bx-info-circle display-4 text-muted"></i>
                                                                    <h6 class="mt-2 text-muted">No hay datos financieros disponibles</h6>
                                                                    <small class="text-muted">Los datos se generarán durante el procesamiento de la simulación.</small>
                                                                </td>
                                                            </tr>
                                                            {% endfor %}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Recomendaciones financieras -->
                                {% if financial_recommendations %}
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <div class="card">
                                            <div class="card-header">
                                                <h5 class="card-title mb-0">
                                                    <i class="bx bx-lightbulb me-2"></i>
                                                    Recomendaciones Financieras
                                                </h5>
                                            </div>
                                            <div class="card-body">
                                                <div class="row">
                                                    {% for recommendation in financial_recommendations %}
                                                    <div class="col-md-6 mb-3">
                                                        <div class="alert alert-{{ recommendation.type|default:'info' }} alert-dismissible">
                                                            <h6 class="alert-heading">
                                                                {% if recommendation.type == 'success' %}
                                                                    <i class="bx bx-check-circle me-2"></i>
                                                                {% elif recommendation.type == 'warning' %}
                                                                    <i class="bx bx-error me-2"></i>
                                                                {% elif recommendation.type == 'danger' %}
                                                                    <i class="bx bx-x-circle me-2"></i>
                                                                {% else %}
                                                                    <i class="bx bx-info-circle me-2"></i>
                                                                {% endif %}
                                                                {{ recommendation.title|default:'Recomendación Financiera' }}
                                                            </h6>
                                                            <p class="mb-2">{{ recommendation.message }}</p>
                                                            {% if recommendation.priority %}
                                                            <small class="fw-bold">
                                                                Prioridad: 
                                                                <span class="badge bg-{{ recommendation.priority }}">
                                                                    {% if recommendation.priority == 'high' %}Alta
                                                                    {% elif recommendation.priority == 'medium' %}Media
                                                                    {% else %}Baja
                                                                    {% endif %}
                                                                </span>
                                                            </small>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}

                                <!-- Modal para pantalla completa -->
                                <div class="modal fade" id="fullscreenModal" tabindex="-1">
                                    <div class="modal-dialog modal-xl modal-fullscreen-lg-down">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="fullscreenModalTitle">Gráfico Financiero</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                            </div>
                                            <div class="modal-body text-center">
                                                <img id="fullscreenModalImage" src="" class="img-fluid" alt="Gráfico expandido">
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-outline-primary" onclick="downloadCurrentChart()">
                                                    <i class="bx bx-download me-1"></i>Descargar
                                                </button>
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                            </div>
                            <!-- Operations Tab - Corregido -->
                            <div class="tab-pane fade" id="operations" role="tabpanel">
                                
                                <!-- Header con resumen operativo -->
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <div class="alert alert-info">
                                            <h4 class="alert-heading mb-3">
                                                <i class="bx bx-cog me-2"></i>
                                                Análisis Operativo Integral
                                            </h4>
                                            <p class="mb-2">
                                                Análisis completo de la eficiencia operativa, incluyendo costos de producción, capacidad utilizada, 
                                                eficiencia de procesos y métricas clave de desempeño operacional.
                                            </p>
                                            <small class="text-muted">
                                                Período analizado: <strong>{{ all_variables_extracted|length|default:0 }} días</strong>
                                                {% if totales_acumulativos.TPV %}
                                                    | Total productos vendidos: <strong>{{ totales_acumulativos.TPV.total|floatformat:0|default:"0" }} unidades</strong>
                                                {% endif %}
                                            </small>
                                        </div>
                                    </div>
                                </div>

                                <!-- Métricas operativas principales -->
                                <div class="row mb-4">
                                    <div class="col-md-3">
                                        <div class="card bg-gradient-primary text-white">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between">
                                                    <div>
                                                        <h6 class="text-white-50">Productos Vendidos</h6>
                                                        <h3 class="mb-0">
                                                            {% if totales_acumulativos.TPV %}
                                                                {{ totales_acumulativos.TPV.total|floatformat:0|default:"0" }}
                                                            {% else %}
                                                                0
                                                            {% endif %}
                                                        </h3>
                                                    </div>
                                                    <div class="align-self-center">
                                                        <i class="bx bx-package display-6"></i>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card bg-gradient-warning text-white">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between">
                                                    <div>
                                                        <h6 class="text-white-50">Eficiencia Operativa</h6>
                                                        <h3 class="mb-0">
                                                            {% if totales_acumulativos.EOG and all_variables_extracted|length > 0 %}
                                                                {% widthratio totales_acumulativos.EOG.total 1 all_variables_extracted|length as avg_eog %}
                                                                {% widthratio avg_eog 1 100 as eog_percent %}
                                                                {{ eog_percent|floatformat:1 }}%
                                                            {% else %}
                                                                0.0%
                                                            {% endif %}
                                                        </h3>
                                                    </div>
                                                    <div class="align-self-center">
                                                        <i class="bx bx-tachometer display-6"></i>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card bg-gradient-success text-white">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between">
                                                    <div>
                                                        <h6 class="text-white-50">Capacidad Utilizada</h6>
                                                        <h3 class="mb-0">
                                                            {% if totales_acumulativos.CPROD and totales_acumulativos.TPV %}
                                                                {% widthratio totales_acumulativos.TPV.total 100 totales_acumulativos.CPROD.total as capacity_used %}
                                                                {{ capacity_used|floatformat:1 }}%
                                                            {% else %}
                                                                N/A
                                                            {% endif %}
                                                        </h3>
                                                    </div>
                                                    <div class="align-self-center">
                                                        <i class="bx bx-bar-chart display-6"></i>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card bg-gradient-danger text-white">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between">
                                                    <div>
                                                        <h6 class="text-white-50">Costo Variable Unit.</h6>
                                                        <h3 class="mb-0">
                                                            {% if totales_acumulativos.CVU and all_variables_extracted|length > 0 %}
                                                                {% widthratio totales_acumulativos.CVU.total 1 all_variables_extracted|length as avg_cvu %}
                                                                Bs. {{ avg_cvu|floatformat:2 }}
                                                            {% else %}
                                                                Bs. 0.00
                                                            {% endif %}
                                                        </h3>
                                                    </div>
                                                    <div class="align-self-center">
                                                        <i class="bx bx-calculator display-6"></i>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Gráficos principales -->
                                <div class="row">
                                    <!-- Costos Operativos -->
                                    <div class="col-md-6 mb-4">
                                        <div class="chart-container">
                                            <h6 class="mb-3">
                                                <i class="bx bx-package me-2"></i>
                                                Evolución de Costos Operativos
                                            </h6>
                                            <div class="chart-controls">
                                                {% if image_data_5 %}
                                                <div class="chart-control-btn" onclick="downloadChart('{{ image_data_5 }}', 'costos-operativos.png')" title="Descargar">
                                                    <i class="bx bx-download"></i>
                                                </div>
                                                <div class="chart-control-btn" onclick="openFullscreen('{{ image_data_5 }}', 'Costos Operativos')" title="Pantalla completa">
                                                    <i class="bx bx-fullscreen"></i>
                                                </div>
                                                {% endif %}
                                            </div>
                                            {% if image_data_5 %}
                                            <img src="data:image/png;base64,{{ image_data_5 }}" 
                                                class="chart-image" 
                                                alt="Costos operativos"
                                                loading="lazy">
                                            {% else %}
                                            <div class="chart-placeholder">
                                                <i class="bx bx-chart text-muted" style="font-size: 3rem;"></i>
                                                <p class="text-muted mt-2">Gráfico de costos operativos no disponible</p>
                                                <small class="text-muted">Los datos se generarán durante el análisis</small>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    
                                    <!-- Producción vs Ventas -->
                                    <div class="col-md-6 mb-4">
                                        <div class="chart-container">
                                            <h6 class="mb-3">
                                                <i class="bx bx-box me-2"></i>
                                                Producción vs Ventas
                                            </h6>
                                            <div class="chart-controls">
                                                {% if image_data_6 %}
                                                <div class="chart-control-btn" onclick="downloadChart('{{ image_data_6 }}', 'produccion-ventas.png')" title="Descargar">
                                                    <i class="bx bx-download"></i>
                                                </div>
                                                <div class="chart-control-btn" onclick="openFullscreen('{{ image_data_6 }}', 'Producción vs Ventas')" title="Pantalla completa">
                                                    <i class="bx bx-fullscreen"></i>
                                                </div>
                                                {% endif %}
                                            </div>
                                            {% if image_data_6 %}
                                            <img src="data:image/png;base64,{{ image_data_6 }}" 
                                                class="chart-image" 
                                                alt="Producción vs Ventas"
                                                loading="lazy">
                                            {% else %}
                                            <div class="chart-placeholder">
                                                <i class="bx bx-chart text-muted" style="font-size: 3rem;"></i>
                                                <p class="text-muted mt-2">Gráfico de producción vs ventas no disponible</p>
                                                <small class="text-muted">Los datos se generarán durante el análisis</small>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    
                                    <!-- Eficiencia Operativa -->
                                    <div class="col-md-6 mb-4">
                                        <div class="chart-container">
                                            <h6 class="mb-3">
                                                <i class="bx bx-tachometer me-2"></i>
                                                Indicadores de Eficiencia Operativa
                                            </h6>
                                            <div class="chart-controls">
                                                {% if image_data_eficiencia %}
                                                <div class="chart-control-btn" onclick="downloadChart('{{ image_data_eficiencia }}', 'eficiencia-operativa.png')" title="Descargar">
                                                    <i class="bx bx-download"></i>
                                                </div>
                                                <div class="chart-control-btn" onclick="openFullscreen('{{ image_data_eficiencia }}', 'Eficiencia Operativa')" title="Pantalla completa">
                                                    <i class="bx bx-fullscreen"></i>
                                                </div>
                                                {% endif %}
                                            </div>
                                            {% if image_data_eficiencia %}
                                            <img src="data:image/png;base64,{{ image_data_eficiencia }}" 
                                                class="chart-image" 
                                                alt="Eficiencia operativa"
                                                loading="lazy">
                                            {% else %}
                                            <div class="chart-placeholder">
                                                <i class="bx bx-chart text-muted" style="font-size: 3rem;"></i>
                                                <p class="text-muted mt-2">Gráfico de eficiencia operativa no disponible</p>
                                                <small class="text-muted">Los datos se generarán durante el análisis</small>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>

                                    <!-- Análisis de Costos Promedio -->
                                    <div class="col-md-6 mb-4">
                                        <div class="chart-container">
                                            <h6 class="mb-3">
                                                <i class="bx bx-dollar-circle me-2"></i>
                                                Análisis de Costos Promedio
                                            </h6>
                                            <div class="chart-controls">
                                                {% if image_data_7 %}
                                                <div class="chart-control-btn" onclick="downloadChart('{{ image_data_7 }}', 'costos-promedio.png')" title="Descargar">
                                                    <i class="bx bx-download"></i>
                                                </div>
                                                <div class="chart-control-btn" onclick="openFullscreen('{{ image_data_7 }}', 'Costos Promedio')" title="Pantalla completa">
                                                    <i class="bx bx-fullscreen"></i>
                                                </div>
                                                {% endif %}
                                            </div>
                                            {% if image_data_7 %}
                                            <img src="data:image/png;base64,{{ image_data_7 }}" 
                                                class="chart-image" 
                                                alt="Costos promedio"
                                                loading="lazy">
                                            {% else %}
                                            <div class="chart-placeholder">
                                                <i class="bx bx-chart text-muted" style="font-size: 3rem;"></i>
                                                <p class="text-muted mt-2">Gráfico de costos promedio no disponible</p>
                                                <small class="text-muted">Los datos se generarán durante el análisis</small>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>

                                <!-- Tabla resumen operativo -->
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <div class="card">
                                            <div class="card-header">
                                                <h5 class="card-title mb-0">
                                                    <i class="bx bx-table me-2"></i>
                                                    Resumen Operativo por Variable
                                                </h5>
                                            </div>
                                            <div class="card-body">
                                                <div class="table-responsive">
                                                    <table class="table table-hover">
                                                        <thead>
                                                            <tr>
                                                                <th>Variable Operativa</th>
                                                                <th>Valor Total</th>
                                                                <th>Promedio Diario</th>
                                                                <th>Tendencia</th>
                                                                <th>Estado</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {% for name_variable, info_variable in totales_acumulativos.items %}
                                                                {% if 'TPV' in name_variable or 'EOG' in name_variable or 'CPROD' in name_variable or 'NEPP' in name_variable or 'CFD' in name_variable or 'CVU' in name_variable or 'DPH' in name_variable %}
                                                                <tr>
                                                                    <td>
                                                                        <strong>
                                                                            {% if name_variable == 'TPV' %}Total Productos Vendidos
                                                                            {% elif name_variable == 'EOG' %}Eficiencia Operativa General
                                                                            {% elif name_variable == 'CPROD' %}Capacidad de Producción
                                                                            {% elif name_variable == 'NEPP' %}Número de Empleados en Producción
                                                                            {% elif name_variable == 'CFD' %}Costo Fijo Diario
                                                                            {% elif name_variable == 'CVU' %}Costo Variable Unitario
                                                                            {% elif name_variable == 'DPH' %}Demanda Promedio Histórica
                                                                            {% else %}{{ name_variable }}
                                                                            {% endif %}
                                                                        </strong>
                                                                        <br>
                                                                        <small class="text-muted">{{ name_variable }}</small>
                                                                    </td>
                                                                    <td class="fw-bold">
                                                                        {% if info_variable.unit == "BS" %}
                                                                            <span class="text-warning">Bs. {{ info_variable.total|floatformat:2 }}</span>
                                                                        {% elif info_variable.unit == "L" %}
                                                                            <span class="text-primary">{{ info_variable.total|floatformat:0 }} L</span>
                                                                        {% elif "%" in info_variable.unit %}
                                                                            <span class="text-info">{{ info_variable.total|floatformat:3 }}</span>
                                                                        {% elif "Personas" in info_variable.unit %}
                                                                            <span class="text-success">{{ info_variable.total|floatformat:0 }} pers.</span>
                                                                        {% else %}
                                                                            {{ info_variable.total|floatformat:2 }}
                                                                        {% endif %}
                                                                    </td>
                                                                    <td>
                                                                        {% if all_variables_extracted|length > 0 %}
                                                                            {% widthratio info_variable.total 1 all_variables_extracted|length as daily_avg %}
                                                                            {% if info_variable.unit == "BS" %}
                                                                                Bs. {{ daily_avg|floatformat:2 }}
                                                                            {% elif info_variable.unit == "L" %}
                                                                                {{ daily_avg|floatformat:1 }} L
                                                                            {% elif "%" in info_variable.unit %}
                                                                                {{ daily_avg|floatformat:3 }}
                                                                            {% elif "Personas" in info_variable.unit %}
                                                                                {{ daily_avg|floatformat:0 }} pers.
                                                                            {% else %}
                                                                                {{ daily_avg|floatformat:2 }}
                                                                            {% endif %}
                                                                        {% else %}
                                                                            N/A
                                                                        {% endif %}
                                                                    </td>
                                                                    <td>
                                                                        {% if info_variable.trend == "increasing" %}
                                                                            <span class="badge bg-success">
                                                                                <i class="bx bx-trending-up me-1"></i>Creciente
                                                                            </span>
                                                                        {% elif info_variable.trend == "decreasing" %}
                                                                            <span class="badge bg-danger">
                                                                                <i class="bx bx-trending-down me-1"></i>Decreciente
                                                                            </span>
                                                                        {% else %}
                                                                            <span class="badge bg-secondary">
                                                                                <i class="bx bx-minus me-1"></i>Estable
                                                                            </span>
                                                                        {% endif %}
                                                                    </td>
                                                                    <td>
                                                                        {% if name_variable == 'EOG' %}
                                                                            {% if all_variables_extracted|length > 0 %}
                                                                                {% widthratio info_variable.total 1 all_variables_extracted|length as avg_eog %}
                                                                                {% if avg_eog > 0.8 %}
                                                                                    <span class="badge bg-success">Excelente</span>
                                                                                {% elif avg_eog > 0.6 %}
                                                                                    <span class="badge bg-warning">Bueno</span>
                                                                                {% else %}
                                                                                    <span class="badge bg-danger">Bajo</span>
                                                                                {% endif %}
                                                                            {% else %}
                                                                                <span class="badge bg-info">N/A</span>
                                                                            {% endif %}
                                                                        {% elif name_variable == 'TPV' %}
                                                                            {% if info_variable.trend == "increasing" %}
                                                                                <span class="badge bg-success">Creciendo</span>
                                                                            {% elif info_variable.trend == "decreasing" %}
                                                                                <span class="badge bg-warning">Decreciendo</span>
                                                                            {% else %}
                                                                                <span class="badge bg-info">Estable</span>
                                                                            {% endif %}
                                                                        {% else %}
                                                                            <span class="badge bg-info">Normal</span>
                                                                        {% endif %}
                                                                    </td>
                                                                </tr>
                                                                {% endif %}
                                                            {% empty %}
                                                            <tr>
                                                                <td colspan="5" class="text-center py-4">
                                                                    <i class="bx bx-info-circle display-4 text-muted"></i>
                                                                    <h6 class="mt-2 text-muted">No hay datos operativos disponibles</h6>
                                                                    <small class="text-muted">Los datos se generarán durante el procesamiento de la simulación.</small>
                                                                </td>
                                                            </tr>
                                                            {% endfor %}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Modal para pantalla completa -->
                                <div class="modal fade" id="fullscreenModal" tabindex="-1">
                                    <div class="modal-dialog modal-xl modal-fullscreen-lg-down">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="fullscreenModalTitle">Gráfico Operativo</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                            </div>
                                            <div class="modal-body text-center">
                                                <img id="fullscreenModalImage" src="" class="img-fluid" alt="Gráfico expandido">
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-outline-primary" onclick="downloadCurrentChart()">
                                                    <i class="bx bx-download me-1"></i>Descargar
                                                </button>
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                            </div>
                            <!-- Endogenous Variables Tab -->
                            <div class="tab-pane fade" id="endogenous" role="tabpanel">
                                
                                <!-- Título Principal -->
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <div class="alert alert-primary">
                                            <h4 class="alert-heading mb-3">
                                                <i class="bx bx-trending-up me-2"></i>
                                                Variables Endógenas del Modelo
                                            </h4>
                                            <p class="mb-2">
                                                Las variables endógenas son aquellas que se determinan dentro del modelo de simulación 
                                                basándose en las relaciones matemáticas establecidas y las variables exógenas.
                                            </p>
                                            <small class="text-muted">
                                                Total de variables endógenas procesadas: <strong>{{ totales_acumulativos|length|default:0 }}</strong> | 
                                                Período de simulación: <strong>{{ all_variables_extracted|length|default:0 }} días</strong>
                                            </small>
                                        </div>
                                    </div>
                                </div>

                                <!-- Métricas Resumen -->
                                <div class="row mb-4" id="endogenousMetrics">
                                    <div class="col-md-3">
                                        <div class="card bg-gradient-primary text-white">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between">
                                                    <div>
                                                        <h6 class="text-white-50">Variables Totales</h6>
                                                        <h3 class="mb-0" id="totalVarsCount">{{ totales_acumulativos|length|default:0 }}</h3>
                                                    </div>
                                                    <div class="align-self-center">
                                                        <i class="bx bx-list-ul display-6"></i>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card bg-gradient-success text-white">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between">
                                                    <div>
                                                        <h6 class="text-white-50">Variables Financieras</h6>
                                                        <h3 class="mb-0" id="financialVarsCount">0</h3>
                                                    </div>
                                                    <div class="align-self-center">
                                                        <i class="bx bx-dollar display-6"></i>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card bg-gradient-info text-white">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between">
                                                    <div>
                                                        <h6 class="text-white-50">Variables Operativas</h6>
                                                        <h3 class="mb-0" id="operationalVarsCount">0</h3>
                                                    </div>
                                                    <div class="align-self-center">
                                                        <i class="bx bx-cog display-6"></i>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card bg-gradient-warning text-white">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between">
                                                    <div>
                                                        <h6 class="text-white-50">Variables de Calidad</h6>
                                                        <h3 class="mb-0" id="qualityVarsCount">0</h3>
                                                    </div>
                                                    <div class="align-self-center">
                                                        <i class="bx bx-star display-6"></i>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Gráficos de Variables Endógenas -->
                                {% if endogenous_charts or chart_images %}
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <div class="card">
                                            <div class="card-header">
                                                <h5 class="card-title mb-0">
                                                    <i class="bx bx-bar-chart me-2"></i>
                                                    Gráficos de Variables Endógenas
                                                </h5>
                                            </div>
                                            <div class="card-body">
                                                <div class="row g-3">
                                                    <!-- Gráficos endógenos específicos -->
                                                    {% for chart_name, chart_data in endogenous_charts.items %}
                                                    <div class="col-lg-6">
                                                        <div class="card chart-card">
                                                            <div class="card-header">
                                                                <h6 class="card-title mb-0">
                                                                    {% if 'IT' in chart_name %}
                                                                        <i class="bx bx-dollar text-success me-2"></i>Ingresos Totales
                                                                    {% elif 'GT' in chart_name %}
                                                                        <i class="bx bx-trending-up text-info me-2"></i>Ganancia Total
                                                                    {% elif 'TG' in chart_name %}
                                                                        <i class="bx bx-receipt text-danger me-2"></i>Total Gastos
                                                                    {% elif 'TPV' in chart_name %}
                                                                        <i class="bx bx-box text-primary me-2"></i>Total Productos Vendidos
                                                                    {% elif 'NSC' in chart_name %}
                                                                        <i class="bx bx-star text-warning me-2"></i>Satisfacción del Cliente
                                                                    {% elif 'EOG' in chart_name %}
                                                                        <i class="bx bx-cog text-secondary me-2"></i>Eficiencia Operativa
                                                                    {% else %}
                                                                        <i class="bx bx-stats me-2"></i>{{ chart_name }}
                                                                    {% endif %}
                                                                </h6>
                                                            </div>
                                                            <div class="card-body">
                                                                <div class="chart-container">
                                                                    {% if chart_data %}
                                                                        <img src="data:image/png;base64,{{ chart_data }}" 
                                                                            class="img-fluid chart-image" 
                                                                            alt="Gráfico {{ chart_name }}"
                                                                            onclick="expandChart('{{ chart_name }}', this.src)">
                                                                    {% else %}
                                                                        <div class="chart-placeholder">
                                                                            <i class="bx bx-bar-chart display-4 text-muted"></i>
                                                                            <p class="text-muted">Gráfico no disponible</p>
                                                                        </div>
                                                                    {% endif %}
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    {% endfor %}

                                                    <!-- Gráficos adicionales del análisis -->
                                                    {% for chart_key, chart_data in chart_images.items %}
                                                        {% if 'endogenous' in chart_key or 'variables' in chart_key %}
                                                        <div class="col-lg-6">
                                                            <div class="card chart-card">
                                                                <div class="card-header">
                                                                    <h6 class="card-title mb-0">
                                                                        <i class="bx bx-line-chart me-2"></i>
                                                                        {% if 'trend' in chart_key %}
                                                                            Tendencias de Variables
                                                                        {% elif 'correlation' in chart_key %}
                                                                            Correlaciones
                                                                        {% elif 'distribution' in chart_key %}
                                                                            Distribuciones
                                                                        {% else %}
                                                                            {{ chart_key|title }}
                                                                        {% endif %}
                                                                    </h6>
                                                                </div>
                                                                <div class="card-body">
                                                                    <div class="chart-container">
                                                                        <img src="data:image/png;base64,{{ chart_data }}" 
                                                                            class="img-fluid chart-image" 
                                                                            alt="Gráfico {{ chart_key }}"
                                                                            onclick="expandChart('{{ chart_key }}', this.src)">
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        {% endif %}
                                                    {% endfor %}

                                                    <!-- Mensaje si no hay gráficos -->
                                                    {% if not endogenous_charts and not chart_images %}
                                                    <div class="col-12">
                                                        <div class="text-center py-5">
                                                            <i class="bx bx-bar-chart display-1 text-muted"></i>
                                                            <h5 class="mt-3 text-muted">No hay gráficos disponibles</h5>
                                                            <p class="text-muted">Los gráficos de variables endógenas se generarán durante el análisis.</p>
                                                        </div>
                                                    </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}

                                <!-- Tabla Resumen de Variables Endógenas -->
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <div class="data-table-container">
                                            <div class="card-header">
                                                <h5 class="card-title mb-0">
                                                    <i class="bx bx-list-ul me-2"></i>
                                                    Resumen Completo de Variables Endógenas
                                                </h5>
                                            </div>
                                            <div class="card-body">
                                                <div class="table-responsive">
                                                    <table class="table table-hover" id="endogenousTable">
                                                        <thead>
                                                            <tr>
                                                                <th style="width: 25%">Variable</th>
                                                                <th style="width: 15%">Valor Total</th>
                                                                <th style="width: 12%">Unidad</th>
                                                                <th style="width: 15%">Promedio Diario</th>
                                                                <th style="width: 10%">Tendencia</th>
                                                                <th style="width: 13%">Rango</th>
                                                                <th style="width: 10%">Acciones</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody id="endogenousTableBody">
                                                            {% for name_variable, info_variable in totales_acumulativos.items %}
                                                            <tr data-variable="{{ name_variable }}" 
                                                                data-category="{% if 'IT' in name_variable or 'GT' in name_variable or 'TG' in name_variable or 'NR' in name_variable %}financial{% elif 'NSC' in name_variable or 'EOG' in name_variable %}quality{% else %}operational{% endif %}"
                                                                data-trend="{{ info_variable.trend|default:'stable' }}">
                                                                <td>
                                                                    <div class="variable-info">
                                                                        <strong>{{ name_variable }}</strong>
                                                                        <br>
                                                                        <small class="text-muted">
                                                                            {% if "IT" in name_variable %}
                                                                                <i class="bx bx-dollar text-success"></i> Ingresos totales del período
                                                                            {% elif "GT" in name_variable %}
                                                                                <i class="bx bx-trending-up text-info"></i> Ganancia acumulada
                                                                            {% elif "TG" in name_variable %}
                                                                                <i class="bx bx-receipt text-danger"></i> Gastos totales
                                                                            {% elif "TPV" in name_variable %}
                                                                                <i class="bx bx-box text-primary"></i> Productos vendidos
                                                                            {% elif "NSC" in name_variable %}
                                                                                <i class="bx bx-star text-warning"></i> Satisfacción del cliente
                                                                            {% elif "EOG" in name_variable %}
                                                                                <i class="bx bx-cog text-secondary"></i> Eficiencia operativa
                                                                            {% elif "NR" in name_variable %}
                                                                                <i class="bx bx-percentage text-info"></i> Nivel de rentabilidad
                                                                            {% else %}
                                                                                <i class="bx bx-stats text-secondary"></i> Variable del modelo
                                                                            {% endif %}
                                                                        </small>
                                                                    </div>
                                                                </td>
                                                                <td class="fw-bold variable-total">
                                                                    {% if info_variable.unit == "BS" %}
                                                                        <span class="text-success">Bs. {{ info_variable.total|floatformat:2 }}</span>
                                                                    {% elif "%" in info_variable.unit %}
                                                                        <span class="text-info">{{ info_variable.total|floatformat:3 }}</span>
                                                                    {% else %}
                                                                        {{ info_variable.total|floatformat:2 }}
                                                                    {% endif %}
                                                                </td>
                                                                <td class="variable-unit">
                                                                    <span class="badge bg-light text-dark">
                                                                        {% if info_variable.unit == "BS" %}Bolivianos
                                                                        {% elif info_variable.unit == "L" %}Litros
                                                                        {% elif info_variable.unit == "CLIENTES" %}Clientes
                                                                        {% elif info_variable.unit == "%" %}Porcentaje
                                                                        {% elif info_variable.unit == "Horas" %}Horas
                                                                        {% elif info_variable.unit == "L/BS" %}L/Bs.
                                                                        {% elif info_variable.unit == "[0.1,0.3,0.5]" %}Factor
                                                                        {% else %}{{ info_variable.unit }}
                                                                        {% endif %}
                                                                    </span>
                                                                </td>
                                                                <td class="variable-average">
                                                                    {% if all_variables_extracted|length > 0 %}
                                                                        {% widthratio info_variable.total 1 all_variables_extracted|length as daily_average %}
                                                                        {% if info_variable.unit == "BS" %}
                                                                            Bs. {{ daily_average|floatformat:2 }}
                                                                        {% elif "%" in info_variable.unit %}
                                                                            {{ daily_average|floatformat:3 }}
                                                                        {% else %}
                                                                            {{ daily_average|floatformat:2 }}
                                                                        {% endif %}
                                                                    {% else %}
                                                                        N/A
                                                                    {% endif %}
                                                                </td>
                                                                <td class="variable-trend">
                                                                    {% if info_variable.trend == "increasing" %}
                                                                        <span class="badge bg-success">
                                                                            <i class="bx bx-trending-up me-1"></i>Creciente
                                                                        </span>
                                                                    {% elif info_variable.trend == "decreasing" %}
                                                                        <span class="badge bg-danger">
                                                                            <i class="bx bx-trending-down me-1"></i>Decreciente
                                                                        </span>
                                                                    {% else %}
                                                                        <span class="badge bg-secondary">
                                                                            <i class="bx bx-minus me-1"></i>Estable
                                                                        </span>
                                                                    {% endif %}
                                                                </td>
                                                                <td class="variable-range">
                                                                    {% if info_variable.min_value and info_variable.max_value %}
                                                                        <small class="text-muted">
                                                                            {{ info_variable.min_value|floatformat:1 }} - {{ info_variable.max_value|floatformat:1 }}
                                                                        </small>
                                                                    {% else %}
                                                                        <small class="text-muted">N/A</small>
                                                                    {% endif %}
                                                                </td>
                                                                <td class="variable-actions">
                                                                    <div class="btn-group" role="group">
                                                                        <button type="button" class="btn btn-sm btn-outline-primary" 
                                                                                onclick="showVariableDetails('{{ name_variable }}')"
                                                                                title="Ver detalles">
                                                                            <i class="bx bx-info-circle"></i>
                                                                        </button>
                                                                    </div>
                                                                </td>
                                                            </tr>
                                                            {% empty %}
                                                            <tr>
                                                                <td colspan="7" class="text-center py-4">
                                                                    <i class="bx bx-info-circle display-4 text-muted"></i>
                                                                    <h5 class="mt-3 text-muted">No hay variables endógenas disponibles</h5>
                                                                    <p class="text-muted">Las variables se generarán durante el procesamiento de la simulación.</p>
                                                                </td>
                                                            </tr>
                                                            {% endfor %}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Modal para expandir gráficos -->
                                <div class="modal fade" id="chartModal" tabindex="-1">
                                    <div class="modal-dialog modal-xl">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="chartModalTitle">Gráfico de Variable</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                            </div>
                                            <div class="modal-body text-center">
                                                <img id="chartModalImage" src="" class="img-fluid" alt="Gráfico expandido">
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Modal para detalles de variable -->
                                <div class="modal fade" id="variableDetailsModal" tabindex="-1">
                                    <div class="modal-dialog modal-lg">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="variableDetailsTitle">Detalles de Variable</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                            </div>
                                            <div class="modal-body" id="variableDetailsBody">
                                                <!-- Contenido dinámico -->
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                            </div>
                            <!-- Demand Tab -->
                            <div class="tab-pane fade" id="demand" role="tabpanel">
                                <div class="row">
                                    <div class="col-md-6">
                                        <!-- Demand Table -->
                                        <div class="data-table-container">
                                            <div class="card-header">
                                                <h5 class="card-title mb-0">
                                                    <i class="bx bx-table me-2"></i>
                                                    Tabla de Demanda Diaria
                                                </h5>
                                            </div>
                                            <div class="card-body">
                                                <div class="table-responsive" style="max-height: 400px;">
                                                    <table class="table table-striped" id="demandTable">
                                                        <thead>
                                                            <tr>
                                                                <th>Día</th>
                                                                <th>Fecha</th>
                                                                <th>Demanda (L)</th>
                                                                <th>Desviación (%)</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {% for simulate in results %}
                                                            <tr>
                                                                <td>{{ forloop.counter }}</td>
                                                                <td>{{ simulate.date|date:"d/m/Y" }}</td>
                                                                <td class="fw-bold">{{ simulate.demand_mean|floatformat:"2" }}</td>
                                                                <td>
                                                                    <span class="badge bg-info">
                                                                        {{ simulate.demand_std_deviation|floatformat:"2" }}%
                                                                    </span>
                                                                </td>
                                                            </tr>
                                                            {% endfor %}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                            <div class="pagination-controls">
                                                <button type="button" class="btn btn-sm btn-outline-primary btn-pagination" id="prevTablePage">
                                                    <i class="bx bx-chevron-left me-1"></i>Anterior
                                                </button>
                                                <span class="flex-grow-1 text-center small text-muted" id="tablePageInfo">
                                                    Página 1
                                                </span>
                                                <button type="button" class="btn btn-sm btn-outline-primary btn-pagination" id="nextTablePage">
                                                    Siguiente<i class="bx bx-chevron-right ms-1"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="chart-container">
                                            <h6 class="mb-3">
                                                <i class="bx bx-line-chart-down me-2"></i>
                                                Análisis de Demanda con Tendencias
                                            </h6>
                                            {% if image_data_simulation %}
                                            <img src="data:image/png;base64,{{ image_data_simulation }}" 
                                                    class="chart-image" 
                                                    alt="Análisis de demanda"
                                                    loading="lazy">
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% if comparison_chart %}
                                    <div class="col-12 mb-4">
                                        <div class="chart-container">
                                            <h6 class="mb-3">
                                                <i class="bx bx-git-compare me-2"></i>
                                                Comparación: Demanda Histórica vs Simulada
                                            </h6>
                                            <div class="chart-controls">
                                                <div class="chart-control-btn" onclick="downloadChart('{{ comparison_chart }}', 'comparacion-demanda.png')" title="Descargar">
                                                    <i class="bx bx-download"></i>
                                                </div>
                                                <div class="chart-control-btn" onclick="openFullscreen('{{ comparison_chart }}', 'Comparación de Demanda')" title="Pantalla completa">
                                                    <i class="bx bx-fullscreen"></i>
                                                </div>
                                            </div>
                                            <img src="data:image/png;base64,{{ comparison_chart }}" 
                                                class="chart-image" 
                                                alt="Comparación de Demanda Histórica vs Simulada"
                                                loading="lazy">
                                        </div>
                                    </div>
                                    {% endif %}
                                    <!-- Three-Line Validation Chart Section -->
                                    {% if has_three_line_chart %}
                                    <div class="row mb-4">
                                        <div class="col-12">
                                            <div class="card shadow-sm">
                                                <div class="card-header bg-success text-white">
                                                    <h4 class="mb-0">
                                                        <i class="fas fa-check-circle"></i> Validación del Modelo: Comparación de Tres Líneas
                                                    </h4>
                                                </div>
                                                <div class="card-body">
                                                    <div class="row">
                                                        <div class="col-lg-9">
                                                            {% if three_line_validation_chart %}
                                                                <img src="data:image/png;base64,{{ three_line_validation_chart }}" 
                                                                    class="img-fluid rounded shadow" 
                                                                    alt="Gráfico de Validación de Tres Líneas">
                                                            {% endif %}
                                                        </div>
                                                        <div class="col-lg-3">
                                                            <div class="validation-metrics">
                                                                <h5>Métricas de Validación</h5>
                                                                
                                                                {% if three_line_validation_metrics.historical_vs_simulated %}
                                                                <div class="metric-card mb-3 p-3 bg-light rounded">
                                                                    <h6 class="text-muted">Histórico vs Simulado</h6>
                                                                    {% comment %} <p class="mb-1">MAPE: <strong class="text-{{ three_line_validation_metrics.historical_vs_simulated.mape < 10|yesno:'success,warning' }}">{{ three_line_validation_metrics.historical_vs_simulated.mape }}%</strong></p> {% endcomment %}
                                                                    <p class="mb-1">RMSE: <strong>{{ three_line_validation_metrics.historical_vs_simulated.rmse|floatformat:2 }}</strong></p>
                                                                    {% comment %} <p class="mb-0">Precisión: <strong class="text-{{ three_line_validation_metrics.historical_vs_simulated.accuracy_level == 'Excelente'|yesno:'success,info' }}">{{ three_line_validation_metrics.historical_vs_simulated.accuracy_level }}</strong></p> {% endcomment %}
                                                                </div>
                                                                {% endif %}
                                                                
                                                                {% if three_line_validation_metrics.simulated_vs_projected %}
                                                                <div class="metric-card mb-3 p-3 bg-light rounded">
                                                                    <h6 class="text-muted">Simulado vs Proyectado</h6>
                                                                    <p class="mb-1">MAPE: <strong>{{ three_line_validation_metrics.simulated_vs_projected.mape }}%</strong></p>
                                                                    <p class="mb-0">Alineación: <strong>{{ three_line_validation_metrics.simulated_vs_projected.alignment }}</strong></p>
                                                                </div>
                                                                {% endif %}
                                                                
                                                                {% if three_line_validation_metrics.overall_validation %}
                                                                <div class="metric-card p-3 bg-primary text-white rounded">
                                                                    <h6>Validación General</h6>
                                                                    <h3 class="mb-1">{{ three_line_validation_metrics.overall_validation.score|floatformat:1 }}%</h3>
                                                                    <p class="mb-0">{{ three_line_validation_metrics.overall_validation.status }}</p>
                                                                </div>
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                    </div>
                                                    
                                                    <div class="mt-3 p-3 bg-light rounded">
                                                        <h6>Interpretación del Gráfico:</h6>
                                                        <ul class="mb-0">
                                                            <li><span style="color: blue; font-weight: bold;">Línea Azul</span>: Demanda Real Histórica</li>
                                                            <li><span style="color: red; font-weight: bold;">Línea Roja</span>: Demanda Proyectada (tendencia futura)</li>
                                                            <li><span style="color: green; font-weight: bold;">Línea Verde (punteada)</span>: Demanda Simulada (validación del modelo)</li>
                                                        </ul>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            <!-- Statistical Analysis Tab -->
                            <div class="tab-pane fade" id="analysis" role="tabpanel">
                                <div class="row">
                                    <!-- Demand Statistics Comparison -->
                                    {% if demand_stats %}
                                    <div class="col-md-6">
                                        <div class="metric-card">
                                            <div class="card-header">
                                                <h5 class="card-title mb-0">
                                                    <i class="bx bx-stats me-2"></i>
                                                    Comparación Estadística de Demanda
                                                </h5>
                                            </div>
                                            <div class="card-body">
                                                <div class="row">
                                                    <div class="col-6">
                                                        <h6 class="text-primary">Demanda Histórica</h6>
                                                        <dl class="row">
                                                            <dt class="col-6">Media:</dt>
                                                            <dd class="col-6">{{ demand_stats.historical.mean|floatformat:2 }} L</dd>
                                                            <dt class="col-6">Desv. Est.:</dt>
                                                            <dd class="col-6">{{ demand_stats.historical.std|floatformat:2 }}</dd>
                                                            <dt class="col-6">CV:</dt>
                                                            <dd class="col-6">{{ demand_stats.historical.cv|floatformat:3 }}</dd>
                                                            <dt class="col-6">Mín/Máx:</dt>
                                                            <dd class="col-6">{{ demand_stats.historical.min|floatformat:0 }} - {{ demand_stats.historical.max|floatformat:0 }}</dd>
                                                        </dl>
                                                    </div>
                                                    <div class="col-6">
                                                        <h6 class="text-success">Demanda Simulada</h6>
                                                        <dl class="row">
                                                            <dt class="col-6">Media:</dt>
                                                            <dd class="col-6">{{ demand_stats.simulated.mean|floatformat:2 }} L</dd>
                                                            <dt class="col-6">Desv. Est.:</dt>
                                                            <dd class="col-6">{{ demand_stats.simulated.std|floatformat:2 }}</dd>
                                                            <dt class="col-6">CV:</dt>
                                                            <dd class="col-6">{{ demand_stats.simulated.cv|floatformat:3 }}</dd>
                                                            <dt class="col-6">Mín/Máx:</dt>
                                                            <dd class="col-6">{{ demand_stats.simulated.min|floatformat:0 }} - {{ demand_stats.simulated.max|floatformat:0 }}</dd>
                                                        </dl>
                                                    </div>
                                                </div>
                                                {% if demand_stats.comparison %}
                                                <hr>
                                                <h6 class="text-muted">Diferencias</h6>
                                                <div class="row">
                                                    <div class="col-6">
                                                        <small>Cambio en Media:</small>
                                                        <h5 class="{% if demand_stats.comparison.mean_diff > 0 %}text-success{% else %}text-danger{% endif %}">
                                                            {{ demand_stats.comparison.mean_diff|floatformat:2 }} L 
                                                            ({{ demand_stats.comparison.mean_diff_pct|floatformat:1 }}%)
                                                        </h5>
                                                    </div>
                                                    <div class="col-6">
                                                        <small>Cambio en Variabilidad:</small>
                                                        <h5 class="{% if demand_stats.comparison.cv_diff < 0 %}text-success{% else %}text-warning{% endif %}">
                                                            {{ demand_stats.comparison.cv_diff|floatformat:3 }}
                                                        </h5>
                                                    </div>
                                                </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                    
                                    <!-- Demand Boxplot Comparison -->
                                    {% if demand_boxplot %}
                                    <div class="col-md-6">
                                        <div class="chart-container">
                                            <h6 class="mb-3">
                                                <i class="bx bx-box me-2"></i>
                                                Comparación de Distribuciones
                                            </h6>
                                            <div class="chart-controls">
                                                <div class="chart-control-btn" onclick="downloadChart('{{ demand_boxplot }}', 'demand-boxplot.png')" title="Descargar">
                                                    <i class="bx bx-download"></i>
                                                </div>
                                                <div class="chart-control-btn" onclick="openFullscreen('{{ demand_boxplot }}', 'Comparación de Distribuciones')" title="Pantalla completa">
                                                    <i class="bx bx-fullscreen"></i>
                                                </div>
                                            </div>
                                            <img src="data:image/png;base64,{{ demand_boxplot }}" 
                                                class="chart-image" 
                                                alt="Comparación de Distribuciones de Demanda"
                                                loading="lazy">
                                        </div>
                                    </div>
                                    {% endif %}
                                    
                                    <!-- Autocorrelation Analysis -->
                                    {% if demand_acf %}
                                    <div class="col-12">
                                        <div class="chart-container">
                                            <h6 class="mb-3">
                                                <i class="bx bx-pulse me-2"></i>
                                                Análisis de Autocorrelación
                                            </h6>
                                            <div class="chart-controls">
                                                <div class="chart-control-btn" onclick="downloadChart('{{ demand_acf }}', 'autocorrelation.png')" title="Descargar">
                                                    <i class="bx bx-download"></i>
                                                </div>
                                                <div class="chart-control-btn" onclick="openFullscreen('{{ demand_acf }}', 'Análisis de Autocorrelación')" title="Pantalla completa">
                                                    <i class="bx bx-fullscreen"></i>
                                                </div>
                                            </div>
                                            <img src="data:image/png;base64,{{ demand_acf }}" 
                                                class="chart-image" 
                                                alt="Análisis de Autocorrelación"
                                                loading="lazy">
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                                
                                <!-- Model Performance Metrics -->
                                <div class="row mt-4">
                                    <div class="col-12">
                                        <div class="metric-card">
                                            <div class="card-header">
                                                <h5 class="card-title mb-0">
                                                    <i class="bx bx-target-lock me-2"></i>
                                                    Métricas de Desempeño del Modelo
                                                </h5>
                                            </div>
                                            <div class="card-body">
                                                <div class="row text-center">
                                                    <div class="col-md-3">
                                                        <div class="p-3">
                                                            <h6 class="text-muted">Distribución Utilizada</h6>
                                                            <h4 class="text-primary">{{ simulation_instance.fk_fdp.name|default:"Normal" }}</h4>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <div class="p-3">
                                                            <h6 class="text-muted">Error Cuadrático Medio</h6>
                                                            <h4 class="text-success">{{ mse|default:"N/A"|floatformat:2 }}</h4>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <div class="p-3">
                                                            <h6 class="text-muted">Error Absoluto Medio</h6>
                                                            <h4 class="text-info">{{ mae|default:"N/A"|floatformat:2 }}</h4>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <div class="p-3">
                                                            <h6 class="text-muted">Coeficiente R²</h6>
                                                            <h4 class="text-warning">{{ r_squared|default:"N/A"|floatformat:3 }}</h4>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Validation Tab -->
                            <div class="tab-pane fade" id="validation" role="tabpanel">
                                <!-- Resumen de Validación -->
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <div class="alert {% if validation_summary.avg_mape < 10 %}alert-success{% elif validation_summary.avg_mape < 20 %}alert-warning{% else %}alert-danger{% endif %}">
                                            <h5 class="alert-heading">
                                                <i class="bx {% if validation_summary.avg_mape < 10 %}bx-check-circle{% elif validation_summary.avg_mape < 20 %}bx-error-circle{% else %}bx-x-circle{% endif %} me-2"></i>
                                                Estado General de Validación del Modelo
                                            </h5>
                                            <hr>
                                            <div class="row text-center">
                                                <div class="col-md-3">
                                                    <div class="validation-kpi">
                                                        <div class="validation-kpi-value {% if validation_summary.success_rate > 80 %}text-success{% elif validation_summary.success_rate > 60 %}text-warning{% else %}text-danger{% endif %}">
                                                            {{ validation_summary.success_rate|floatformat:1 }}%
                                                        </div>
                                                        <div class="validation-kpi-label">Tasa de Éxito Global</div>
                                                    </div>
                                                </div>
                                                <div class="col-md-3">
                                                    <div class="validation-kpi">
                                                        <div class="validation-kpi-value {% if validation_summary.avg_mape < 10 %}text-success{% elif validation_summary.avg_mape < 20 %}text-warning{% else %}text-danger{% endif %}">
                                                            {{ validation_summary.avg_mape|floatformat:2 }}%
                                                        </div>
                                                        <div class="validation-kpi-label">Error Promedio (MAPE)</div>
                                                    </div>
                                                </div>
                                                <div class="col-md-3">
                                                    <div class="validation-kpi">
                                                        <div class="validation-kpi-value text-success">
                                                            {{ validation_summary.precise_count }}
                                                        </div>
                                                        <div class="validation-kpi-label">Días Precisos (&lt;10%)</div>
                                                    </div>
                                                </div>
                                                <div class="col-md-3">
                                                    <div class="validation-kpi">
                                                        <div class="validation-kpi-value text-danger">
                                                            {{ validation_summary.inaccurate_count }}
                                                        </div>
                                                        <div class="validation-kpi-label">Días Inexactos (&gt;20%)</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Gráfico de Distribución de Precisión -->
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <div class="chart-container">
                                            <h6 class="mb-3">
                                                <i class="bx bx-bar-chart-alt-2 me-2"></i>
                                                Distribución de Precisión - Error Porcentual por Día
                                            </h6>
                                            <div class="chart-controls">
                                                <div class="chart-control-btn" onclick="downloadValidationChart()" title="Descargar">
                                                    <i class="bx bx-download"></i>
                                                </div>
                                                <div class="chart-control-btn" onclick="toggleValidationChartType()" title="Cambiar tipo de gráfico">
                                                    <i class="bx bx-refresh"></i>
                                                </div>
                                            </div>
                                            <div style="position: relative; height: 400px;">
                                                <canvas id="validationPrecisionChart"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Métricas de Error Detalladas -->
                                <div class="row mb-4">
                                    <div class="col-md-6">
                                        <div class="metric-card">
                                            <div class="card-header">
                                                <h5 class="card-title mb-0">
                                                    <i class="bx bx-calculator me-2"></i>
                                                    Métricas de Error del Modelo
                                                </h5>
                                            </div>
                                            <div class="card-body">
                                                <div class="row">
                                                    <div class="col-6">
                                                        <div class="text-center p-3 border rounded mb-3">
                                                            <h6 class="text-muted mb-1">MAE</h6>
                                                            <h4 class="mb-0">{{ validation_metrics.mae|floatformat:2 }} L</h4>
                                                            <small class="text-muted">Error Absoluto Medio</small>
                                                        </div>
                                                    </div>
                                                    <div class="col-6">
                                                        <div class="text-center p-3 border rounded mb-3">
                                                            <h6 class="text-muted mb-1">MAPE</h6>
                                                            <h4 class="mb-0 {% if validation_metrics.mape < 10 %}text-success{% elif validation_metrics.mape < 20 %}text-warning{% else %}text-danger{% endif %}">
                                                                {{ validation_metrics.mape|floatformat:2 }}%
                                                            </h4>
                                                            <small class="text-muted">Error Porcentual Medio</small>
                                                        </div>
                                                    </div>
                                                    <div class="col-6">
                                                        <div class="text-center p-3 border rounded">
                                                            <h6 class="text-muted mb-1">RMSE</h6>
                                                            <h4 class="mb-0">{{ validation_metrics.rmse|floatformat:2 }} L</h4>
                                                            <small class="text-muted">Error Cuadrático Medio</small>
                                                        </div>
                                                    </div>
                                                    <div class="col-6">
                                                        <div class="text-center p-3 border rounded">
                                                            <h6 class="text-muted mb-1">R²</h6>
                                                            <h4 class="mb-0 {% if validation_metrics.r_squared > 0.8 %}text-success{% elif validation_metrics.r_squared > 0.6 %}text-warning{% else %}text-danger{% endif %}">
                                                                {{ validation_metrics.r_squared|floatformat:3 }}
                                                            </h4>
                                                            <small class="text-muted">Coeficiente de Determinación</small>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <div class="metric-card">
                                            <div class="card-header">
                                                <h5 class="card-title mb-0">
                                                    <i class="bx bx-pie-chart-alt-2 me-2"></i>
                                                    Resumen de Precisión por Categoría
                                                </h5>
                                            </div>
                                            <div class="card-body">
                                                <canvas id="validationSummaryChart" height="200"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Tabla de Validación Completa por Día -->
                                <div class="row">
                                    <div class="col-12">
                                        <div class="data-table-container">
                                            <div class="card-header d-flex justify-content-between align-items-center">
                                                <h5 class="card-title mb-0">
                                                    <i class="bx bx-list-check me-2"></i>
                                                    Detalle Completo de Validación por Día
                                                    <span class="badge bg-info ms-2">{{ validation_details|length }} días</span>
                                                </h5>
                                                <button class="btn btn-sm btn-outline-primary" onclick="exportValidationResults()">
                                                    <i class="bx bx-download me-1"></i>Exportar CSV
                                                </button>
                                            </div>
                                            <div class="card-body">
                                                <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                                                    <table class="table table-hover table-sm" id="validationDetailTable">
                                                        <thead class="sticky-top bg-white">
                                                            <tr>
                                                                <th style="width: 80px;">Día</th>
                                                                <th>Fecha</th>
                                                                <th>Producto</th>
                                                                <th class="text-end">Demanda Simulada</th>
                                                                <th class="text-end">Demanda Real</th>
                                                                <th class="text-end">Diferencia</th>
                                                                <th class="text-center">Error %</th>
                                                                <th class="text-center">Veredicto</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {% for item in validation_details %}
                                                            <tr class="validation-row" data-day="{{ item.day_number }}">
                                                                <td class="fw-bold">{{ item.day_number }}</td>
                                                                <td>{{ item.date|date:"d/m/Y" }}</td>
                                                                <td>
                                                                    <small>{{ item.product }}</small>
                                                                    <br>
                                                                    <span class="text-muted" style="font-size: 0.75rem;">{{ item.business_name }}</span>
                                                                </td>
                                                                <td class="text-end text-primary fw-bold">
                                                                    {{ item.simulated_demand|floatformat:0 }} L
                                                                </td>
                                                                <td class="text-end text-info fw-bold">
                                                                    {{ item.real_demand|floatformat:0 }} L
                                                                </td>
                                                                <td class="text-end">
                                                                    {% if item.difference > 0 %}
                                                                        <span class="text-danger">+{{ item.difference|floatformat:0 }} L</span>
                                                                    {% else %}
                                                                        <span class="text-success">{{ item.difference|floatformat:0 }} L</span>
                                                                    {% endif %}
                                                                </td>
                                                                <td class="text-center">
                                                                    <span class="badge {% if item.error_percentage < 10 %}bg-success{% elif item.error_percentage < 20 %}bg-warning{% else %}bg-danger{% endif %} px-3">
                                                                        {{ item.error_percentage|floatformat:1 }}%
                                                                    </span>
                                                                </td>
                                                                <td class="text-center">
                                                                    {% if item.verdict == 'PRECISA' %}
                                                                        <span class="text-success fw-bold">
                                                                            <i class="bx bx-check-circle"></i> Precisa
                                                                        </span>
                                                                    {% elif item.verdict == 'ACEPTABLE' %}
                                                                        <span class="text-warning fw-bold">
                                                                            <i class="bx bx-error-circle"></i> Aceptable
                                                                        </span>
                                                                    {% else %}
                                                                        <span class="text-danger fw-bold">
                                                                            <i class="bx bx-x-circle"></i> Inexacta
                                                                        </span>
                                                                    {% endif %}
                                                                </td>
                                                            </tr>
                                                            {% endfor %}
                                                        </tbody>
                                                        <tfoot class="table-light">
                                                            <tr>
                                                                <td colspan="3" class="fw-bold">Totales/Promedios</td>
                                                                <td class="text-end fw-bold">{{ validation_totals.total_simulated|floatformat:0 }} L</td>
                                                                <td class="text-end fw-bold">{{ validation_totals.total_real|floatformat:0 }} L</td>
                                                                <td class="text-end fw-bold">
                                                                    {% if validation_totals.total_difference > 0 %}
                                                                        <span class="text-danger">+{{ validation_totals.total_difference|floatformat:0 }} L</span>
                                                                    {% else %}
                                                                        <span class="text-success">{{ validation_totals.total_difference|floatformat:0 }} L</span>
                                                                    {% endif %}
                                                                </td>
                                                                <td class="text-center">
                                                                    <span class="badge {% if validation_totals.avg_error < 10 %}bg-success{% elif validation_totals.avg_error < 20 %}bg-warning{% else %}bg-danger{% endif %} px-3">
                                                                        {{ validation_totals.avg_error|floatformat:1 }}%
                                                                    </span>
                                                                </td>
                                                                <td></td>
                                                            </tr>
                                                        </tfoot>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Análisis por Distribución Probabilística -->
                                {% if validation_by_distribution %}
                                <div class="row mt-4">
                                    <div class="col-12">
                                        <div class="metric-card">
                                            <div class="card-header">
                                                <h5 class="card-title mb-0">
                                                    <i class="bx bx-stats me-2"></i>
                                                    Análisis por Tipo de Distribución Probabilística
                                                </h5>
                                            </div>
                                            <div class="card-body">
                                                <div class="row">
                                                    {% for dist_name, dist_stats in validation_by_distribution.items %}
                                                    <div class="col-md-4 mb-3">
                                                        <div class="p-3 border rounded {% if dist_stats.avg_mape < 10 %}border-success{% elif dist_stats.avg_mape < 20 %}border-warning{% else %}border-danger{% endif %}">
                                                            <h6 class="text-primary">{{ dist_name }}</h6>
                                                            <dl class="row mb-0">
                                                                <dt class="col-7">Total simulaciones:</dt>
                                                                <dd class="col-5">{{ dist_stats.count }}</dd>
                                                                <dt class="col-7">MAPE promedio:</dt>
                                                                <dd class="col-5">
                                                                    <span class="badge {% if dist_stats.avg_mape < 10 %}bg-success{% elif dist_stats.avg_mape < 20 %}bg-warning{% else %}bg-danger{% endif %}">
                                                                        {{ dist_stats.avg_mape|floatformat:2 }}%
                                                                    </span>
                                                                </dd>
                                                                <dt class="col-7">Desv. estándar:</dt>
                                                                <dd class="col-5">{{ dist_stats.std_mape|floatformat:2 }}%</dd>
                                                                <dt class="col-7">Mejor ajuste:</dt>
                                                                <dd class="col-5">{{ dist_stats.best_fit_product|default:"N/A" }}</dd>
                                                            </dl>
                                                        </div>
                                                    </div>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}

                                <!-- Recomendaciones de Validación -->
                                {% if validation_recommendations %}
                                <div class="row mt-4">
                                    <div class="col-12">
                                        <div class="alert alert-info">
                                            <h5 class="alert-heading">
                                                <i class="bx bx-bulb me-2"></i>
                                                Recomendaciones basadas en la Validación
                                            </h5>
                                            <hr>
                                            <div class="row">
                                                {% for recommendation in validation_recommendations %}
                                                <div class="col-md-6 mb-2">
                                                    <div class="d-flex align-items-start">
                                                        <i class="bx bx-check-circle text-info me-2 mt-1"></i>
                                                        <p class="mb-0">{{ recommendation }}</p>
                                                    </div>
                                                </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}       
                                
                                <!-- NUEVA SECCIÓN: Validación de Variables del Modelo -->
                                <div class="validation-section variables-validation mt-5">
                                    <h4 class="mb-3">
                                        <i class="bx bx-calculator"></i> Validación de Variables del Modelo
                                    </h4>
                                    
                                    {% if model_validation_summary %}
                                    <!-- Resumen General -->
                                    <div class="row mb-4">
                                        <div class="col-md-3">
                                            <div class="card text-center">
                                                <div class="card-body">
                                                    <h5 class="card-title">Variables Totales</h5>
                                                    <h2 class="text-primary">{{ model_validation_summary.total_variables }}</h2>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="card text-center">
                                                <div class="card-body">
                                                    <h5 class="card-title">Precisas</h5>
                                                    <h2 class="text-success">{{ model_validation_summary.precise_count }}</h2>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="card text-center">
                                                <div class="card-body">
                                                    <h5 class="card-title">Aceptables</h5>
                                                    <h2 class="text-warning">{{ model_validation_summary.acceptable_count }}</h2>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="card text-center">
                                                <div class="card-body">
                                                    <h5 class="card-title">Inexactas</h5>
                                                    <h2 class="text-danger">{{ model_validation_summary.inaccurate_count }}</h2>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                        {{ charts_context.validation_summary.image_data }}
                                    <!-- Score de Validación -->
                                    <div class="row mb-4">
                                        <div class="col-12">
                                            <div class="progress" style="height: 30px;">
                                                <div class="progress-bar {% if model_validation_summary.success_rate >= 90 %}bg-success{% elif model_validation_summary.success_rate >= 70 %}bg-warning{% else %}bg-danger{% endif %}" 
                                                    role="progressbar" 
                                                    style="width: {{ model_validation_summary.success_rate }}%;"
                                                    aria-valuenow="{{ model_validation_summary.success_rate }}" 
                                                    aria-valuemin="0" 
                                                    aria-valuemax="100">
                                                    <strong>{{ model_validation_summary.success_rate|floatformat:1 }}% de Precisión</strong>
                                                </div>
                                            </div>
                                            <p class="text-center mt-2">
                                                <strong>Score de Validación: {{ model_validation_summary.validation_score|floatformat:1 }}/100</strong>
                                                {% if model_validation_summary.is_valid %}
                                                    <span class="badge bg-success">Modelo Válido</span>
                                                {% else %}
                                                    <span class="badge bg-danger">Modelo Requiere Calibración</span>
                                                {% endif %}
                                            </p>
                                        </div>
                                    </div>

                                    <!-- Gráficos Comparativos -->
                                    {% if model_validation_by_variable.comparison_charts %}
                                    <div class="row mb-4">
                                        {% if model_validation_by_variable.comparison_charts.comparison_bar %}
                                        <div class="col-md-8">
                                            <div class="card">
                                                <div class="card-body">
                                                    <h5 class="card-title">Comparación Real vs Simulado</h5>
                                                    <img src="data:image/png;base64,{{ model_validation_by_variable.comparison_charts.comparison_bar }}" 
                                                        class="img-fluid" alt="Comparación de Variables">
                                                </div>
                                            </div>
                                        </div>
                                        {% endif %}
                                        
                                        {% if model_validation_by_variable.comparison_charts.error_distribution %}
                                        <div class="col-md-4">
                                            <div class="card">
                                                <div class="card-body">
                                                    <h5 class="card-title">Distribución de Precisión</h5>
                                                    <img src="data:image/png;base64,{{ model_validation_by_variable.comparison_charts.error_distribution }}" 
                                                        class="img-fluid" alt="Distribución de Errores">
                                                </div>
                                            </div>
                                        </div>
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                    <!-- Tabla de Variables Validadas -->
                                    <div class="card">
                                        <div class="card-header">
                                            <h5 class="mb-0">Detalle de Variables Validadas</h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="table-responsive">
                                                <table class="table table-hover">
                                                    <thead>
                                                        <tr>
                                                            <th>Variable</th>
                                                            <th>Tipo</th>
                                                            <th>Valor Real</th>
                                                            <th>Valor Simulado (Prom.)</th>
                                                            <th>Error %</th>
                                                            <th>Estado</th>
                                                            <th>Acciones</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {% for var_key, var_data in model_validation_by_variable.items %}
                                                        {% if var_data.status != 'NO_DATA' and var_data.simulated_avg != 0 %}
                                                        <tr>
                                                            <td>
                                                                <strong>{{ var_key }}</strong><br>
                                                                <small class="text-muted">{{ var_data.description }}</small>
                                                            </td>
                                                            <td>{{ var_data.type }}</td>
                                                            <td>{{ var_data.real_value|floatformat:2 }} {{ var_data.unit }}</td>
                                                            <td>{{ var_data.simulated_avg|floatformat:2 }} {{ var_data.unit }}</td>
                                                            <td>
                                                                <span class="badge {% if var_data.error_pct <= 5 %}bg-success{% elif var_data.error_pct <= 15 %}bg-warning{% else %}bg-danger{% endif %}">
                                                                    {{ var_data.error_pct|floatformat:1 }}%
                                                                </span>
                                                            </td>
                                                            <td>
                                                                {% if var_data.status == 'PRECISA' %}
                                                                    <span class="badge bg-success">✔️ Precisa</span>
                                                                {% elif var_data.status == 'ACEPTABLE' %}
                                                                    <span class="badge bg-warning">⚠️ Aceptable</span>
                                                                {% else %}
                                                                    <span class="badge bg-danger">❌ Inexacta</span>
                                                                {% endif %}
                                                            </td>
                                                            <td>
                                                                <button class="btn btn-sm btn-outline-primary" 
                                                                        onclick="showVariableDetails('{{ var_key }}')">
                                                                    <i class="bx bx-show"></i> Ver Detalles
                                                                </button>
                                                            </td>
                                                        </tr>
                                                        {% endif %}
                                                        {% endfor %}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Resumen por Tipo de Variable -->
                                    {% if model_validation_by_type %}
                                    <div class="card mt-4">
                                        <div class="card-header">
                                            <h5 class="mb-0">Precisión por Tipo de Variable</h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                {% for type_name, type_data in model_validation_by_type.items %}
                                                <div class="col-md-4 mb-3">
                                                    <h6>{{ type_name }}</h6>
                                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                                        <small>Precisas: {{ type_data.precise }}/{{ type_data.total }}</small>
                                                        <small>{% widthratio type_data.precise type_data.total 100 %}%</small>
                                                    </div>
                                                    <div class="progress" style="height: 20px;">
                                                        <div class="progress-bar bg-success" style="width: {% widthratio type_data.precise type_data.total 100 %}%"></div>
                                                        <div class="progress-bar bg-warning" style="width: {% widthratio type_data.precise type_data.total 100 %}%"></div>
                                                        <div class="progress-bar bg-danger" style="width: {% widthratio type_data.precise type_data.total 100 %}%"></div>
                                                    </div>
                                                </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                        <!-- Recomendaciones -->
                                        {% if model_validation_recommendations %}
                                        <div class="card mt-4">
                                            <div class="card-header">
                                                <h5 class="mb-0">Recomendaciones de Mejora</h5>
                                            </div>
                                            <div class="card-body">
                                                {% for rec in model_validation_recommendations %}
                                                <div class="alert alert-{{ rec.type }} d-flex align-items-center" role="alert">
                                                    <i class="bx bx-{% if rec.type == 'error' %}error{% elif rec.type == 'warning' %}error-alt{% else %}info-circle{% endif %} me-2"></i>
                                                    <div>{{ rec.message }}</div>
                                                </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        {% endif %}

                                        <!-- Recomendaciones -->
                                        {% if model_validation_recommendations %}
                                        <div class="card mt-4">
                                            <div class="card-header">
                                                <h5 class="mb-0">Análisis de Rendimiento</h5>
                                            </div>
                                            <div class="card-body">
                                                <div class="alert alert-success d-flex align-items-center" role="alert">
                                                    <i class="bx bx-check-circle me-2"></i>
                                                    <div><strong>Excelente precisión:</strong> El modelo muestra un rendimiento superior con más del 85% de variables en rango preciso.</div>
                                                </div>
                                                <div class="alert alert-info d-flex align-items-center" role="alert">
                                                    <i class="bx bx-info-circle me-2"></i>
                                                    <div><strong>Validación exitosa:</strong> Los errores promedio se mantienen por debajo del 3%, indicando alta confiabilidad.</div>
                                                </div>
                                                {% for rec in model_validation_recommendations %}
                                                {% if rec.type != 'error' %}
                                                <div class="alert alert-{{ rec.type }} d-flex align-items-center" role="alert">
                                                    <i class="bx bx-{% if rec.type == 'warning' %}error-alt{% else %}info-circle{% endif %} me-2"></i>
                                                    <div>{{ rec.message }}</div>
                                                </div>
                                                {% endif %}
                                                {% endfor %}
                                            </div>
                                        </div>
                                        {% endif %}
                                    {% else %}
                                    <div class="alert alert-info">
                                        <i class="bx bx-info-circle"></i> No se encontraron datos para validar las variables del modelo.
                                    </div>
                                    {% endif %}
                                </div>
                                <!-- Reemplazar la sección de gráficos de validación por variable con esto -->
                                <!-- Gráficos de Validación por Variable -->
                                {% if model_validation_charts %}
                                <div class="card mt-4">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0">
                                            <i class="bx bx-line-chart"></i> Gráficos de Validación por Variable
                                        </h5>
                                        <span class="badge bg-info">
                                            {{ model_validation_charts|length }} tipos de variables
                                        </span>
                                    </div>
                                    <div class="card-body">
                                        <!-- Gráfico Resumen -->
                                        {% if model_validation_charts.summary %}
                                        <div class="row mb-4">
                                            <div class="col-12">
                                                <div class="chart-container">
                                                    <h6 class="mb-3">
                                                        <i class="bx bx-stats"></i> Resumen de Validación por Tipo
                                                    </h6>
                                                    <img src="data:image/png;base64,{{ model_validation_charts.summary }}" 
                                                        class="img-fluid" alt="Resumen de Validación">
                                                </div>
                                            </div>
                                        </div>
                                        {% endif %}
                                        
                                        <!-- Gráficos por Variable -->
                                        <div class="row">
                                            {% for var_type, charts_list in model_validation_charts.items %}
                                                {% if var_type != 'summary' and charts_list %}
                                                    {% for chart_data in charts_list %}
                                                    <div class="col-lg-6 mb-4">
                                                        <div class="card h-100 shadow-sm">
                                                            <div class="card-header d-flex justify-content-between align-items-center">
                                                                <div>
                                                                    <h6 class="mb-0">{{ chart_data.variable }}</h6>
                                                                    <small class="text-muted">{{ chart_data.description|truncatechars:50 }}</small>
                                                                </div>
                                                                <div class="text-end">
                                                                    <span class="badge bg-{% if chart_data.status == 'PRECISA' %}success{% elif chart_data.status == 'ACEPTABLE' %}warning{% else %}danger{% endif %}">
                                                                        {{ chart_data.error_pct|floatformat:1 }}% error
                                                                    </span>
                                                                </div>
                                                            </div>
                                                            <div class="card-body p-2">
                                                                <img src="data:image/png;base64,{{ chart_data.chart }}" 
                                                                    class="img-fluid validation-chart-img" 
                                                                    alt="Gráfico de {{ chart_data.variable }}">
                                                                
                                                                <div class="chart-controls position-absolute top-0 end-0 p-2">
                                                                    <button class="btn btn-sm btn-light" 
                                                                            onclick="openFullscreen('{{ chart_data.chart }}', '{{ chart_data.variable }}')"
                                                                            title="Expandir">
                                                                        <i class="bx bx-expand"></i>
                                                                    </button>
                                                                    <button class="btn btn-sm btn-light" 
                                                                            onclick="downloadChart('{{ chart_data.chart }}', '{{ chart_data.variable }}_validation.png')"
                                                                            title="Descargar">
                                                                        <i class="bx bx-download"></i>
                                                                    </button>
                                                                </div>
                                                            </div>
                                                            <div class="card-footer bg-light">
                                                                <div class="row text-center small">
                                                                    <div class="col-4">
                                                                        <strong>Unidad:</strong><br>{{ chart_data.unit }}
                                                                    </div>
                                                                    <div class="col-4">
                                                                        <strong>Días:</strong><br>{{ chart_data.days_count }}
                                                                    </div>
                                                                    <div class="col-4">
                                                                        <strong>Cobertura:</strong><br>{{ chart_data.coverage|floatformat:0 }}%
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    {% endfor %}
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                                {% else %}
                                <div class="alert alert-info mt-4">
                                    <i class="bx bx-info-circle"></i> No se generaron gráficos de validación.
                                </div>
                                {% endif %}

                            </div>
                        </div>
                        
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para expandir gráficos -->
    <div class="modal fade" id="chartModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="chartModalTitle">Gráfico de Variable</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <img id="chartModalImage" src="" class="img-fluid" alt="Gráfico expandido">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-primary" onclick="downloadChart()">
                        <i class="bx bx-download me-1"></i>Descargar
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal para detalles de variable -->
    <div class="modal fade" id="variableDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="variableDetailsTitle">Detalles de Variable</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="variableDetailsBody">
                    <!-- Contenido dinámico -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal para Detalles de Variable -->
    <div class="modal fade" id="variableDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Detalles de Validación por Día</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="variableDetailsContent">
                    <!-- Contenido dinámico -->
                </div>
            </div>
        </div>
    </div>
    <!-- Modal para pantalla completa -->
    <div class="modal fade" id="fullscreenModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-fullscreen-lg-down">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="fullscreenModalTitle">Gráfico Operativo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <img id="fullscreenModalImage" src="" class="img-fluid" alt="Gráfico expandido">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-primary" onclick="downloadCurrentChart()">
                        <i class="bx bx-download me-1"></i>Descargar
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Fullscreen Overlay -->
    <div class="fullscreen-overlay" id="fullscreenOverlay">
        <span class="close-fullscreen" onclick="closeFullscreen()">&times;</span>
        <div class="fullscreen-content">
            <img id="fullscreenImage" src="" alt="" class="img-fluid">
        </div>
    </div>

    {% block footer %}
    {% include "partials/footer.html" %}
    {% endblock footer %}
</div>
{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<!-- Agregar en la sección de scripts, después de los scripts existentes -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>

<script>
// Animación para los contadores
document.addEventListener('DOMContentLoaded', function() {
    function animateCounters() {
        const counters = document.querySelectorAll('.counter');
        
        counters.forEach(counter => {
            const target = parseFloat(counter.getAttribute('data-target'));
            const duration = 2000; // 2 segundos
            const increment = target / (duration / 16); // 60 FPS
            let current = 0;
            
            const timer = setInterval(() => {
                current += increment;
                
                if (current >= target) {
                    current = target;
                    clearInterval(timer);
                }
                
                // Formatear el número según el tipo
                if (target % 1 === 0) {
                    counter.textContent = Math.floor(current).toLocaleString('es-ES');
                } else {
                    counter.textContent = current.toFixed(2);
                }
            }, 16);
        });
    }
    
    // Iniciar animación cuando sea visible
    const statsGrid = document.querySelector('.stats-grid');
    if (statsGrid) {
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    animateCounters();
                    observer.unobserve(entry.target);
                }
            });
        });
        
        observer.observe(statsGrid);
    }
});
</script>

<script>
// JavaScript para funcionalidad de la pestaña operaciones
function downloadChart(chartData, filename) {
    try {
        if (!chartData) {
            console.warn('No chart data provided for download');
            return;
        }
        
        const link = document.createElement('a');
        link.href = 'data:image/png;base64,' + chartData;
        link.download = filename || 'grafico-operativo.png';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        console.log('Chart downloaded:', filename);
    } catch (error) {
        console.error('Error downloading chart:', error);
        alert('Error al descargar el gráfico');
    }
}

function openFullscreen(chartData, title) {
    try {
        if (!chartData) {
            console.warn('No chart data provided for fullscreen');
            return;
        }
        
        const modal = document.getElementById('fullscreenModal');
        const modalTitle = document.getElementById('fullscreenModalTitle');
        const modalImage = document.getElementById('fullscreenModalImage');
        
        if (modal && modalTitle && modalImage) {
            modalTitle.textContent = title || 'Gráfico Operativo';
            modalImage.src = 'data:image/png;base64,' + chartData;
            modalImage.setAttribute('data-chart-data', chartData);
            
            if (typeof bootstrap !== 'undefined') {
                new bootstrap.Modal(modal).show();
            } else {
                modal.style.display = 'block';
                modal.classList.add('show');
            }
        }
    } catch (error) {
        console.error('Error opening fullscreen:', error);
        alert('Error al abrir el gráfico en pantalla completa');
    }
}

function downloadCurrentChart() {
    try {
        const modalImage = document.getElementById('fullscreenModalImage');
        const chartData = modalImage.getAttribute('data-chart-data');
        const title = document.getElementById('fullscreenModalTitle').textContent;
        
        if (chartData) {
            const filename = title.toLowerCase().replace(/\s+/g, '-') + '.png';
            downloadChart(chartData, filename);
        }
    } catch (error) {
        console.error('Error downloading current chart:', error);
        alert('Error al descargar el gráfico');
    }
}

// Cerrar modal con ESC
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        const modal = document.getElementById('fullscreenModal');
        if (modal && modal.classList.contains('show')) {
            const bsModal = bootstrap.Modal.getInstance(modal);
            if (bsModal) {
                bsModal.hide();
            }
        }
    }
});

// Click en imágenes para abrir en pantalla completa
document.addEventListener('click', function(event) {
    if (event.target.classList.contains('chart-image')) {
        const src = event.target.src;
        const alt = event.target.alt;
        
        // Extraer data base64 del src
        const base64Data = src.split(',')[1];
        if (base64Data) {
            openFullscreen(base64Data, alt);
        }
    }
});

console.log('Operations tab JavaScript loaded successfully');
</script>
<script>
// JavaScript para funcionalidad de la pestaña financiera
function downloadChart(chartData, filename) {
    try {
        if (!chartData) {
            console.warn('No chart data provided for download');
            return;
        }
        
        const link = document.createElement('a');
        link.href = 'data:image/png;base64,' + chartData;
        link.download = filename || 'grafico-financiero.png';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        console.log('Chart downloaded:', filename);
    } catch (error) {
        console.error('Error downloading chart:', error);
        alert('Error al descargar el gráfico');
    }
}

function openFullscreen(chartData, title) {
    try {
        if (!chartData) {
            console.warn('No chart data provided for fullscreen');
            return;
        }
        
        const modal = document.getElementById('fullscreenModal');
        const modalTitle = document.getElementById('fullscreenModalTitle');
        const modalImage = document.getElementById('fullscreenModalImage');
        
        if (modal && modalTitle && modalImage) {
            modalTitle.textContent = title || 'Gráfico Financiero';
            modalImage.src = 'data:image/png;base64,' + chartData;
            modalImage.setAttribute('data-chart-data', chartData);
            
            if (typeof bootstrap !== 'undefined') {
                new bootstrap.Modal(modal).show();
            } else {
                modal.style.display = 'block';
                modal.classList.add('show');
            }
        }
    } catch (error) {
        console.error('Error opening fullscreen:', error);
        alert('Error al abrir el gráfico en pantalla completa');
    }
}

function downloadCurrentChart() {
    try {
        const modalImage = document.getElementById('fullscreenModalImage');
        const chartData = modalImage.getAttribute('data-chart-data');
        const title = document.getElementById('fullscreenModalTitle').textContent;
        
        if (chartData) {
            const filename = title.toLowerCase().replace(/\s+/g, '-') + '.png';
            downloadChart(chartData, filename);
        }
    } catch (error) {
        console.error('Error downloading current chart:', error);
        alert('Error al descargar el gráfico');
    }
}

// Cerrar modal con ESC
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        const modal = document.getElementById('fullscreenModal');
        if (modal && modal.classList.contains('show')) {
            const bsModal = bootstrap.Modal.getInstance(modal);
            if (bsModal) {
                bsModal.hide();
            }
        }
    }
});

// Click en imágenes para abrir en pantalla completa
document.addEventListener('click', function(event) {
    if (event.target.classList.contains('chart-image')) {
        const src = event.target.src;
        const alt = event.target.alt;
        
        // Extraer data base64 del src
        const base64Data = src.split(',')[1];
        if (base64Data) {
            openFullscreen(base64Data, alt);
        }
    }
});

console.log('Financial tab JavaScript loaded successfully');
</script>

<script>
// JavaScript para funcionalidad de la pestaña de variables endógenas
document.addEventListener('DOMContentLoaded', function() {
    // Inicializar contadores
    updateVariableCounts();
    
    // Configurar filtros
    setupTableFilters();
    
    // Configurar navegación de gráficos
    setupChartNavigation();
    
    // Configurar ordenamiento de tabla
    setupTableSorting();
});

function updateVariableCounts() {
    const rows = document.querySelectorAll('#endogenousTableBody tr[data-category]');
    let financial = 0, operational = 0, quality = 0;
    
    rows.forEach(row => {
        const category = row.dataset.category;
        if (category === 'financial') financial++;
        else if (category === 'operational') operational++;
        else if (category === 'quality') quality++;
    });
    
    document.getElementById('financialVarsCount').textContent = financial;
    document.getElementById('operationalVarsCount').textContent = operational;
    document.getElementById('qualityVarsCount').textContent = quality;
}

function setupTableFilters() {
    const searchInput = document.getElementById('endogenousSearch');
    const categoryFilter = document.getElementById('categoryFilter');
    const trendFilter = document.getElementById('trendFilter');
    
    if (searchInput) {
        searchInput.addEventListener('input', filterTable);
    }
    if (categoryFilter) {
        categoryFilter.addEventListener('change', filterTable);
    }
    if (trendFilter) {
        trendFilter.addEventListener('change', filterTable);
    }
}

<script>
// JavaScript simplificado para la pestaña de variables endógenas
document.addEventListener('DOMContentLoaded', function() {
    // Inicializar contadores al cargar la pestaña
    updateVariableCounts();
});

function updateVariableCounts() {
    try {
        const rows = document.querySelectorAll('#endogenousTableBody tr[data-category]');
        let financial = 0, operational = 0, quality = 0;
        
        rows.forEach(row => {
            const category = row.dataset.category;
            if (category === 'financial') financial++;
            else if (category === 'operational') operational++;
            else if (category === 'quality') quality++;
        });
        
        // Actualizar contadores
        const financialCount = document.getElementById('financialVarsCount');
        const operationalCount = document.getElementById('operationalVarsCount');
        const qualityCount = document.getElementById('qualityVarsCount');
        
        if (financialCount) financialCount.textContent = financial;
        if (operationalCount) operationalCount.textContent = operational;
        if (qualityCount) qualityCount.textContent = quality;
        
        console.log(`Variables count updated: Financial: ${financial}, Operational: ${operational}, Quality: ${quality}`);
    } catch (error) {
        console.error('Error updating variable counts:', error);
    }
}

function expandChart(chartName, imageSrc) {
    try {
        const modal = document.getElementById('chartModal');
        const modalTitle = document.getElementById('chartModalTitle');
        const modalImage = document.getElementById('chartModalImage');
        
        if (modal && modalTitle && modalImage) {
            modalTitle.textContent = `Gráfico: ${chartName}`;
            modalImage.src = imageSrc || '';
            
            // Usar Bootstrap modal si está disponible
            if (typeof bootstrap !== 'undefined') {
                new bootstrap.Modal(modal).show();
            } else {
                // Fallback simple
                modal.style.display = 'block';
                modal.classList.add('show');
            }
        }
    } catch (error) {
        console.error('Error expanding chart:', error);
    }
}

function showVariableDetails(variableName) {
    try {
        // Obtener datos de la variable
        const row = document.querySelector(`tr[data-variable="${variableName}"]`);
        if (!row) {
            console.warn(`Variable row not found: ${variableName}`);
            return;
        }
        
        const category = row.dataset.category || 'unknown';
        const trend = row.dataset.trend || 'stable';
        const totalElement = row.querySelector('.variable-total');
        const unitElement = row.querySelector('.variable-unit');
        const averageElement = row.querySelector('.variable-average');
        
        const total = totalElement ? totalElement.textContent.trim() : 'N/A';
        const unit = unitElement ? unitElement.textContent.trim() : 'N/A';
        const average = averageElement ? averageElement.textContent.trim() : 'N/A';
        
        // Construir contenido del modal
        const modalBody = document.getElementById('variableDetailsBody');
        const modalTitle = document.getElementById('variableDetailsTitle');
        
        if (modalBody && modalTitle) {
            modalTitle.textContent = `Detalles: ${variableName}`;
            modalBody.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Información General</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Variable:</strong></td><td>${variableName}</td></tr>
                            <tr><td><strong>Categoría:</strong></td><td class="text-capitalize">${category}</td></tr>
                            <tr><td><strong>Unidad:</strong></td><td>${unit}</td></tr>
                            <tr><td><strong>Tendencia:</strong></td><td class="text-capitalize">${trend}</td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>Valores</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Total:</strong></td><td>${total}</td></tr>
                            <tr><td><strong>Promedio:</strong></td><td>${average}</td></tr>
                        </table>
                    </div>
                </div>
                <div class="mt-3">
                    <h6>Descripción</h6>
                    <p class="text-muted">
                        ${getVariableDescription(variableName)}
                    </p>
                </div>
            `;
            
            // Mostrar modal
            const modal = document.getElementById('variableDetailsModal');
            if (modal) {
                if (typeof bootstrap !== 'undefined') {
                    new bootstrap.Modal(modal).show();
                } else {
                    modal.style.display = 'block';
                    modal.classList.add('show');
                }
            }
        }
    } catch (error) {
        console.error('Error showing variable details:', error);
        alert('Error al mostrar los detalles de la variable.');
    }
}

function getVariableDescription(variableName) {
    const descriptions = {
        'IT': 'Ingresos Totales: Suma de todos los ingresos generados durante el período de simulación.',
        'GT': 'Ganancia Total: Diferencia entre ingresos totales y gastos totales del período.',
        'TG': 'Total Gastos: Suma de todos los costos y gastos incurridos durante la simulación.',
        'TPV': 'Total Productos Vendidos: Cantidad total de productos vendidos en el período.',
        'NSC': 'Nivel de Satisfacción del Cliente: Indicador de calidad del servicio prestado.',
        'EOG': 'Eficiencia Operativa General: Medida de la eficiencia en los procesos operativos.',
        'NR': 'Nivel de Rentabilidad: Porcentaje de ganancia sobre los ingresos totales.',
        'PVP': 'Precio de Venta al Público: Precio unitario de venta del producto.',
        'CFD': 'Costo Fijo Diario: Costos fijos que se incurren diariamente.',
        'CVU': 'Costo Variable Unitario: Costo variable por unidad producida.',
        'DPH': 'Demanda Promedio Histórica: Promedio histórico de la demanda.',
        'CPROD': 'Capacidad de Producción: Capacidad máxima de producción diaria.',
        'NEPP': 'Número de Empleados en Producción: Personal asignado a producción.'
    };
    
    return descriptions[variableName] || `Variable endógena ${variableName} del modelo de simulación.`;
}

// Cerrar modales al hacer clic fuera
document.addEventListener('click', function(event) {
    // Cerrar modal de gráfico
    const chartModal = document.getElementById('chartModal');
    if (chartModal && event.target === chartModal) {
        chartModal.style.display = 'none';
        chartModal.classList.remove('show');
    }
    
    // Cerrar modal de detalles
    const detailsModal = document.getElementById('variableDetailsModal');
    if (detailsModal && event.target === detailsModal) {
        detailsModal.style.display = 'none';
        detailsModal.classList.remove('show');
    }
});

// Cerrar modales con botón close
document.addEventListener('click', function(event) {
    if (event.target.classList.contains('btn-close')) {
        const modal = event.target.closest('.modal');
        if (modal) {
            modal.style.display = 'none';
            modal.classList.remove('show');
        }
    }
});

// Actualizar contadores cuando se activa la pestaña endógenas
document.addEventListener('shown.bs.tab', function(event) {
    if (event.target.getAttribute('aria-controls') === 'endogenous') {
        setTimeout(updateVariableCounts, 100);
    }
});

// Función para manejar clicks en imágenes de gráficos
document.addEventListener('click', function(event) {
    if (event.target.classList.contains('chart-image')) {
        const chartName = event.target.getAttribute('alt') || 'Gráfico';
        const imageSrc = event.target.src;
        expandChart(chartName, imageSrc);
    }
});

console.log('Endogenous variables tab JavaScript loaded successfully');
</script>

<script>
// JavaScript para funcionalidad de la pestaña de variables endógenas
document.addEventListener('DOMContentLoaded', function() {
    // Inicializar contadores
    updateVariableCounts();
    
    // Configurar filtros
    setupTableFilters();
    
    // Configurar navegación de gráficos
    setupChartNavigation();
    
    // Configurar ordenamiento de tabla
    setupTableSorting();
});

function updateVariableCounts() {
    const rows = document.querySelectorAll('#endogenousTableBody tr[data-category]');
    let financial = 0, operational = 0, quality = 0;
    
    rows.forEach(row => {
        const category = row.dataset.category;
        if (category === 'financial') financial++;
        else if (category === 'operational') operational++;
        else if (category === 'quality') quality++;
    });
    
    document.getElementById('financialVarsCount').textContent = financial;
    document.getElementById('operationalVarsCount').textContent = operational;
    document.getElementById('qualityVarsCount').textContent = quality;
}

function setupTableFilters() {
    const searchInput = document.getElementById('endogenousSearch');
    const categoryFilter = document.getElementById('categoryFilter');
    const trendFilter = document.getElementById('trendFilter');
    
    if (searchInput) {
        searchInput.addEventListener('input', filterTable);
    }
    if (categoryFilter) {
        categoryFilter.addEventListener('change', filterTable);
    }
    if (trendFilter) {
        trendFilter.addEventListener('change', filterTable);
    }
}

function filterTable() {
    const search = document.getElementById('endogenousSearch')?.value.toLowerCase() || '';
    const category = document.getElementById('categoryFilter')?.value || '';
    const trend = document.getElementById('trendFilter')?.value || '';
    
    const rows = document.querySelectorAll('#endogenousTableBody tr[data-variable]');
    
    rows.forEach(row => {
        const variable = row.dataset.variable.toLowerCase();
        const rowCategory = row.dataset.category;
        const rowTrend = row.dataset.trend;
        
        const matchesSearch = variable.includes(search);
        const matchesCategory = !category || rowCategory === category;
        const matchesTrend = !trend || rowTrend === trend;
        
        if (matchesSearch && matchesCategory && matchesTrend) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

function setupChartNavigation() {
    // Navegación por categorías de gráficos
    const categoryButtons = document.querySelectorAll('[data-chart-category]');
    categoryButtons.forEach(btn => {
        btn.addEventListener('click', function() {
            // Actualizar botones activos
            categoryButtons.forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            // Filtrar gráficos
            const category = this.dataset.chartCategory;
            filterCharts(category);
        });
    });
    
    // Toggle entre vista grid y carrusel
    const viewButtons = document.querySelectorAll('[data-view]');
    viewButtons.forEach(btn => {
        btn.addEventListener('click', function() {
            viewButtons.forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            const view = this.dataset.view;
            toggleChartView(view);
        });
    });
}

function filterCharts(category) {
    const chartItems = document.querySelectorAll('.chart-item');
    
    chartItems.forEach(item => {
        if (category === 'all' || item.dataset.category === category) {
            item.style.display = '';
        } else {
            item.style.display = 'none';
        }
    });
}

function toggleChartView(view) {
    const gridContainer = document.getElementById('chartsGridContainer');
    const carouselContainer = document.getElementById('chartsCarouselContainer');
    
    if (view === 'grid') {
        gridContainer.classList.remove('d-none');
        carouselContainer.classList.add('d-none');
    } else {
        gridContainer.classList.add('d-none');
        carouselContainer.classList.remove('d-none');
        setupCarousel();
    }
}

function setupCarousel() {
    const carouselInner = document.querySelector('#chartsCarousel .carousel-inner');
    const chartItems = document.querySelectorAll('.chart-item:not([style*="display: none"])');
    
    // Limpiar carousel
    carouselInner.innerHTML = '';
    
    // Crear slides
    chartItems.forEach((item, index) => {
        const slide = document.createElement('div');
        slide.className = `carousel-item ${index === 0 ? 'active' : ''}`;
        slide.innerHTML = item.innerHTML;
        carouselInner.appendChild(slide);
    });
}

function setupTableSorting() {
    const sortableHeaders = document.querySelectorAll('.sortable');
    
    sortableHeaders.forEach(header => {
        header.addEventListener('click', function() {
            const sortType = this.dataset.sort;
            sortTable(sortType);
        });
    });
}

function sortTable(sortType) {
    const tbody = document.getElementById('endogenousTableBody');
    const rows = Array.from(tbody.querySelectorAll('tr[data-variable]'));
    
    rows.sort((a, b) => {
        let aVal, bVal;
        
        switch(sortType) {
            case 'variable':
                aVal = a.dataset.variable.toLowerCase();
                bVal = b.dataset.variable.toLowerCase();
                return aVal.localeCompare(bVal);
                
            case 'total':
                aVal = parseFloat(a.querySelector('.variable-total').textContent.replace(/[^\d.-]/g, ''));
                bVal = parseFloat(b.querySelector('.variable-total').textContent.replace(/[^\d.-]/g, ''));
                return bVal - aVal; // Descendente
                
            case 'average':
                aVal = parseFloat(a.querySelector('.variable-average').textContent.replace(/[^\d.-]/g, ''));
                bVal = parseFloat(b.querySelector('.variable-average').textContent.replace(/[^\d.-]/g, ''));
                return bVal - aVal; // Descendente
                
            default:
                return 0;
        }
    });
    
    // Reordenar las filas
    rows.forEach(row => tbody.appendChild(row));
}

function expandChart(chartName) {
    const chartImage = document.querySelector(`[data-chart-name="${chartName}"]`);
    if (chartImage) {
        document.getElementById('chartModalTitle').textContent = `Gráfico: ${chartName}`;
        document.getElementById('chartModalImage').src = chartImage.src;
        new bootstrap.Modal(document.getElementById('chartModal')).show();
    }
}

function showVariableDetails(variableName) {
    // Obtener datos de la variable
    const row = document.querySelector(`tr[data-variable="${variableName}"]`);
    if (!row) return;
    
    const category = row.dataset.category;
    const trend = row.dataset.trend;
    const total = row.querySelector('.variable-total').textContent;
    const unit = row.querySelector('.variable-unit').textContent;
    const average = row.querySelector('.variable-average').textContent;
    
    // Construir contenido del modal
    const modalBody = document.getElementById('variableDetailsBody');
    modalBody.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <h6>Información General</h6>
                <table class="table table-sm">
                    <tr><td><strong>Variable:</strong></td><td>${variableName}</td></tr>
                    <tr><td><strong>Categoría:</strong></td><td class="text-capitalize">${category}</td></tr>
                    <tr><td><strong>Unidad:</strong></td><td>${unit}</td></tr>
                    <tr><td><strong>Tendencia:</strong></td><td class="text-capitalize">${trend}</td></tr>
                </table>
            </div>
            <div class="col-md-6">
                <h6>Valores</h6>
                <table class="table table-sm">
                    <tr><td><strong>Total:</strong></td><td>${total}</td></tr>
                    <tr><td><strong>Promedio:</strong></td><td>${average}</td></tr>
                </table>
            </div>
        </div>
        <div class="mt-3">
            <h6>Descripción</h6>
            <p class="text-muted">
                ${getVariableDescription(variableName)}
            </p>
        </div>
    `;
    
    document.getElementById('variableDetailsTitle').textContent = `Detalles: ${variableName}`;
    new bootstrap.Modal(document.getElementById('variableDetailsModal')).show();
}

function getVariableDescription(variableName) {
    const descriptions = {
        'IT': 'Ingresos Totales: Suma de todos los ingresos generados durante el período de simulación.',
        'GT': 'Ganancia Total: Diferencia entre ingresos totales y gastos totales del período.',
        'TG': 'Total Gastos: Suma de todos los costos y gastos incurridos durante la simulación.',
        'TPV': 'Total Productos Vendidos: Cantidad total de productos vendidos en el período.',
        'NSC': 'Nivel de Satisfacción del Cliente: Indicador de calidad del servicio prestado.',
        'EOG': 'Eficiencia Operativa General: Medida de la eficiencia en los procesos operativos.',
        'NR': 'Nivel de Rentabilidad: Porcentaje de ganancia sobre los ingresos totales.'
    };
    
    return descriptions[variableName] || `Variable endógena ${variableName} del modelo de simulación.`;
}

function showVariableChart(variableName) {
    // Buscar si existe un gráfico para esta variable
    const chartImage = document.querySelector(`[data-chart-name*="${variableName}"]`);
    if (chartImage) {
        expandChart(variableName);
    } else {
        alert('No hay gráfico disponible para esta variable.');
    }
}

function downloadChart() {
    const chartImage = document.getElementById('chartModalImage');
    if (chartImage.src) {
        const link = document.createElement('a');
        link.href = chartImage.src;
        link.download = 'grafico_variable.png';
        link.click();
    }
}

function exportEndogenousTable(format) {
    const table = document.getElementById('endogenousTable');
    const rows = table.querySelectorAll('tbody tr[data-variable]');
    
    if (format === 'excel') {
        exportToExcel(rows);
    } else if (format === 'pdf') {
        exportToPDF(rows);
    }
}

function exportToExcel(rows) {
    let csvContent = 'Variable,Valor Total,Unidad,Promedio Diario,Tendencia\n';
    
    rows.forEach(row => {
        if (row.style.display !== 'none') {
            const variable = row.dataset.variable;
            const total = row.querySelector('.variable-total').textContent.replace(/[,]/g, '');
            const unit = row.querySelector('.variable-unit').textContent;
            const average = row.querySelector('.variable-average').textContent.replace(/[,]/g, '');
            const trend = row.dataset.trend;
            
            csvContent += `"${variable}","${total}","${unit}","${average}","${trend}"\n`;
        }
    });
    
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'variables_endogenas.csv';
    link.click();
}

function exportToPDF(rows) {
    // Implementación simplificada para PDF
    window.print();
}

// Paginación de tabla
let currentPage = 1;
const rowsPerPage = 10;

function paginateEndogenousTable(direction) {
    const tbody = document.getElementById('endogenousTableBody');
    const rows = Array.from(tbody.querySelectorAll('tr[data-variable]')).filter(row => 
        row.style.display !== 'none'
    );
    
    const totalPages = Math.ceil(rows.length / rowsPerPage);
    
    if (direction === 'prev' && currentPage > 1) {
        currentPage--;
    } else if (direction === 'next' && currentPage < totalPages) {
        currentPage++;
    }
    
    // Ocultar todas las filas
    rows.forEach(row => row.style.display = 'none');
    
    // Mostrar filas de la página actual
    const startIndex = (currentPage - 1) * rowsPerPage;
    const endIndex = startIndex + rowsPerPage;
    
    for (let i = startIndex; i < endIndex && i < rows.length; i++) {
        rows[i].style.display = '';
    }
    
    // Actualizar información de paginación
    document.getElementById('endogenousPageInfo').textContent = `Página ${currentPage} de ${totalPages}`;
    
    // Actualizar estado de botones
    document.getElementById('prevPageItem').classList.toggle('disabled', currentPage === 1);
    document.getElementById('nextPageItem').classList.toggle('disabled', currentPage === totalPages);
}

// Inicializar paginación al cargar
document.addEventListener('DOMContentLoaded', function() {
    paginateEndogenousTable('current');
});
</script>

<script>
// JavaScript para navegación entre días
document.addEventListener('DOMContentLoaded', function() {
    let currentDay = 1;
    const totalDays = {{ all_variables_extracted|length }};
    
    const dailyItems = document.querySelectorAll('.daily-result-item');
    const currentDayIndicator = document.getElementById('currentDayIndicator');
    const dayCounter = document.getElementById('dayCounter');
    const prevDayBtn = document.getElementById('prevDayBtn');
    const nextDayBtn = document.getElementById('nextDayBtn');
    
    function updateDayView() {
        // Ocultar todos los items
        dailyItems.forEach(item => {
            item.style.display = 'none';
        });
        
        // Mostrar el item del día actual
        const currentItem = document.querySelector(`[data-day="${currentDay}"]`);
        if (currentItem) {
            currentItem.style.display = 'block';
        }
        
        // Actualizar indicadores
        currentDayIndicator.textContent = `Día ${currentDay}`;
        dayCounter.textContent = `Día ${currentDay} de ${totalDays}`;
        
        // Actualizar estado de botones
        prevDayBtn.disabled = currentDay <= 1;
        nextDayBtn.disabled = currentDay >= totalDays;
        
        // Scroll to top
        document.querySelector('.card-body').scrollTop = 0;
    }
    
    // Event listeners
    prevDayBtn.addEventListener('click', function() {
        if (currentDay > 1) {
            currentDay--;
            updateDayView();
        }
    });
    
    nextDayBtn.addEventListener('click', function() {
        if (currentDay < totalDays) {
            currentDay++;
            updateDayView();
        }
    });
    
    // Navegación con teclado
    document.addEventListener('keydown', function(e) {
        if (e.key === 'ArrowLeft' && !prevDayBtn.disabled) {
            prevDayBtn.click();
        } else if (e.key === 'ArrowRight' && !nextDayBtn.disabled) {
            nextDayBtn.click();
        }
    });
    
    // Inicializar vista
    updateDayView();
});
<script>
function exportDailyValidation() {
    let csv = 'Day,Date,Variable,Real Value,Simulated Value,Error %,Status\n';
    
    const rows = document.querySelectorAll('#dailyValidationTable tbody tr');
    rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        const day = cells[0].textContent;
        const date = cells[1].textContent;
        const variable = cells[2].textContent;
        const real = cells[3].textContent;
        const simulated = cells[4].textContent;
        const error = cells[5].querySelector('span').textContent;
        const status = cells[6].textContent.trim();
        
        csv += `${day},"${date}","${variable}",${real},${simulated},${error},"${status}"\n`;
    });
    
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'daily_validation_' + new Date().getTime() + '.csv';
    link.click();
}
</script>

<!-- Agregar script de carga diferida -->
<script>
// Variables globales para gestión de gráficos
let allCharts = [];
let loadedCharts = 0;
const CHARTS_PER_BATCH = 3;
let currentTypeFilter = '';

// Preparar datos de gráficos
{% for type_name, type_charts in model_validation_charts.items %}
{% if type_name != 'summary' %}
{% for chart_data in type_charts %}
allCharts.push({
    type: '{{ type_name }}',
    variable: '{{ chart_data.variable }}',
    description: '{{ chart_data.description|escapejs }}',
    unit: '{{ chart_data.unit }}',
    error_pct: {{ chart_data.error_pct|default:0 }},
    status: '{{ chart_data.status }}',
    chart: '{{ chart_data.chart }}',
    days_count: {{ chart_data.days_count|default:0 }},
    coverage: {{ chart_data.coverage|default:0 }}
});
{% endfor %}
{% endif %}
{% endfor %}

// Función para cargar gráficos iniciales
function loadInitialCharts() {
    document.getElementById('chartsContainer').style.display = 'none';
    document.getElementById('loadedChartsContainer').style.display = 'block';
    
    // Ordenar por error descendente para mostrar los más críticos primero
    allCharts.sort((a, b) => b.error_pct - a.error_pct);
    
    loadMoreCharts();
}

// Función para cargar más gráficos
function loadMoreCharts() {
    const container = document.getElementById('chartsGrid');
    const filteredCharts = currentTypeFilter 
        ? allCharts.filter(c => c.type === currentTypeFilter)
        : allCharts;
    
    const endIndex = Math.min(loadedCharts + CHARTS_PER_BATCH, filteredCharts.length);
    
    for (let i = loadedCharts; i < endIndex; i++) {
        const chartData = filteredCharts[i];
        const chartHtml = createChartCard(chartData);
        container.insertAdjacentHTML('beforeend', chartHtml);
        
        // Aplicar lazy loading a la imagen
        const imgElement = container.querySelector(`#chart-${chartData.variable}`);
        if (imgElement && 'IntersectionObserver' in window) {
            const imageObserver = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const img = entry.target;
                        img.src = img.dataset.src;
                        img.classList.remove('lazy');
                        observer.unobserve(img);
                    }
                });
            });
            imageObserver.observe(imgElement);
        }
    }
    
    loadedCharts = endIndex;
    
    // Actualizar botón de cargar más
    const remaining = filteredCharts.length - loadedCharts;
    if (remaining > 0) {
        document.getElementById('loadMoreContainer').style.display = 'block';
        document.getElementById('remainingCount').textContent = `(${remaining} restantes)`;
    } else {
        document.getElementById('loadMoreContainer').style.display = 'none';
    }
    
    // Animar entrada de nuevos gráficos
    animateNewCharts();
}

// Crear tarjeta de gráfico
function createChartCard(chartData) {
    const statusClass = chartData.status === 'PRECISA' ? 'success' : 
                       chartData.status === 'ACEPTABLE' ? 'warning' : 'danger';
    
    return `
        <div class="col-lg-6 mb-4 chart-card" data-variable="${chartData.variable}" data-type="${chartData.type}">
            <div class="card h-100 shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-0">${chartData.variable}</h6>
                        <small class="text-muted">${chartData.description}</small>
                    </div>
                    <div class="text-end">
                        <span class="badge bg-${statusClass}">
                            ${chartData.error_pct.toFixed(1)}% error
                        </span>
                    </div>
                </div>
                <div class="card-body p-2">
                    <div class="chart-wrapper position-relative">
                        <img id="chart-${chartData.variable}"
                             data-src="data:image/png;base64,${chartData.chart}" 
                             class="img-fluid validation-chart-img lazy" 
                             alt="Gráfico de ${chartData.variable}"
                             loading="lazy">
                        
                        <div class="chart-loading position-absolute top-50 start-50 translate-middle" style="display: none;">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Cargando...</span>
                            </div>
                        </div>
                        
                        <div class="chart-controls position-absolute top-0 end-0 p-2">
                            <button class="btn btn-sm btn-light" 
                                    onclick="expandChart('${chartData.variable}', '${chartData.chart}')"
                                    title="Expandir">
                                <i class="bx bx-expand"></i>
                            </button>
                            <button class="btn btn-sm btn-light" 
                                    onclick="downloadChart('${chartData.chart}', '${chartData.variable}_validation.png')"
                                    title="Descargar">
                                <i class="bx bx-download"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-footer bg-light">
                    <div class="row text-center small">
                        <div class="col-4">
                            <strong>Unidad:</strong><br>${chartData.unit}
                        </div>
                        <div class="col-4">
                            <strong>Días:</strong><br>${chartData.days_count}
                        </div>
                        <div class="col-4">
                            <strong>Cobertura:</strong><br>${chartData.coverage.toFixed(0)}%
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
}

// Filtrar gráficos por tipo
function filterChartsByType() {
    const filter = document.getElementById('chartTypeFilter').value;
    currentTypeFilter = filter;
    
    // Reiniciar y recargar
    loadedCharts = 0;
    document.getElementById('chartsGrid').innerHTML = '';
    
    if (document.getElementById('loadedChartsContainer').style.display !== 'none') {
        loadMoreCharts();
    }
}

// Cargar todos los gráficos (con confirmación)
function loadAllCharts() {
    if (allCharts.length > 10) {
        if (!confirm(`¿Está seguro de cargar todos los ${allCharts.length} gráficos? Esto puede tardar un momento.`)) {
            return;
        }
    }
    
    document.getElementById('chartsContainer').style.display = 'none';
    document.getElementById('loadedChartsContainer').style.display = 'block';
    
    // Mostrar indicador de carga
    showLoadingIndicator();
    
    // Cargar por lotes para no bloquear el navegador
    loadChartsInBatches();
}

// Cargar gráficos en lotes
function loadChartsInBatches() {
    const BATCH_SIZE = 5;
    const container = document.getElementById('chartsGrid');
    
    function loadBatch(startIndex) {
        const endIndex = Math.min(startIndex + BATCH_SIZE, allCharts.length);
        
        for (let i = startIndex; i < endIndex; i++) {
            const chartData = allCharts[i];
            const chartHtml = createChartCard(chartData);
            container.insertAdjacentHTML('beforeend', chartHtml);
        }
        
        loadedCharts = endIndex;
        updateProgress(loadedCharts, allCharts.length);
        
        if (endIndex < allCharts.length) {
            // Continuar con el siguiente lote después de un pequeño delay
            setTimeout(() => loadBatch(endIndex), 100);
        } else {
            hideLoadingIndicator();
            document.getElementById('loadMoreContainer').style.display = 'none';
        }
    }
    
    loadBatch(0);
}

// Indicadores de carga
function showLoadingIndicator() {
    const indicator = document.createElement('div');
    indicator.id = 'batchLoadingIndicator';
    indicator.className = 'text-center py-3';
    indicator.innerHTML = `
        <div class="progress mb-2" style="height: 20px;">
            <div id="loadingProgress" class="progress-bar progress-bar-striped progress-bar-animated" 
                 role="progressbar" style="width: 0%">0%</div>
        </div>
        <p class="text-muted">Cargando gráficos...</p>
    `;
    document.getElementById('loadedChartsContainer').insertBefore(
        indicator, 
        document.getElementById('chartsGrid')
    );
}

function updateProgress(current, total) {
    const percentage = (current / total * 100).toFixed(0);
    const progressBar = document.getElementById('loadingProgress');
    if (progressBar) {
        progressBar.style.width = percentage + '%';
        progressBar.textContent = percentage + '%';
    }
}

function hideLoadingIndicator() {
    const indicator = document.getElementById('batchLoadingIndicator');
    if (indicator) {
        indicator.remove();
    }
}

// Animar entrada de gráficos
function animateNewCharts() {
    const newCards = document.querySelectorAll('.chart-card:not(.animated)');
    newCards.forEach((card, index) => {
        setTimeout(() => {
            card.classList.add('animated', 'fadeInUp');
        }, index * 100);
    });
}

// Estilos CSS para animaciones
const style = document.createElement('style');
style.textContent = `
    .chart-card {
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    .chart-card.animated {
        opacity: 1;
    }
    .fadeInUp {
        animation: fadeInUp 0.5s ease;
    }
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    .lazy {
        background: #f0f0f0;
        min-height: 200px;
    }
`;
document.head.appendChild(style);


document.addEventListener('error', function(e) {
    if (e.target.tagName === 'IMG' && e.target.classList.contains('validation-chart-img')) {
        e.target.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjBmMGYwIi8+CiAgPHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxOCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkVycm9yIGNhcmdhbmRvIGdyw6FmaWNvPC90ZXh0Pgo8L3N2Zz4=';
        e.target.classList.remove('lazy');
        
        // Log error
        console.error('Failed to load chart for:', e.target.alt);
    }
}, true);

// Función para reintentar carga de gráficos fallidos
function retryFailedCharts() {
    const failedImages = document.querySelectorAll('.validation-chart-img[src*="Error"]');
    failedImages.forEach(img => {
        const originalSrc = img.dataset.src;
        if (originalSrc) {
            img.src = originalSrc;
        }
    });
}

// Función para verificar rendimiento
function checkPerformance() {
    if ('performance' in window && 'memory' in performance) {
        const memoryUsage = performance.memory.usedJSHeapSize / 1048576;
        console.log(`Memory usage: ${memoryUsage.toFixed(2)} MB`);
        
        if (memoryUsage > 500) {
            console.warn('High memory usage detected. Consider closing other tabs.');
        }
    }
}

// Monitorear rendimiento cada 30 segundos
setInterval(checkPerformance, 30000);

// Función para limpiar memoria
function cleanupCharts() {
    // Remover gráficos no visibles del DOM
    const allCharts = document.querySelectorAll('.chart-card');
    const viewportHeight = window.innerHeight;
    
    allCharts.forEach(chart => {
        const rect = chart.getBoundingClientRect();
        if (rect.bottom < -viewportHeight || rect.top > viewportHeight * 2) {
            const img = chart.querySelector('.validation-chart-img');
            if (img && img.src && !img.classList.contains('lazy')) {
                img.dataset.src = img.src;
                img.src = '';
                img.classList.add('lazy');
            }
        }
    });
}

// Limpiar memoria al hacer scroll
let scrollTimeout;
window.addEventListener('scroll', () => {
    clearTimeout(scrollTimeout);
    scrollTimeout = setTimeout(cleanupCharts, 200);
});

// Función para exportar gráficos seleccionados
function exportSelectedCharts() {
    const selectedCharts = [];
    document.querySelectorAll('.chart-card input[type="checkbox"]:checked').forEach(cb => {
        const card = cb.closest('.chart-card');
        const img = card.querySelector('.validation-chart-img');
        if (img && img.src) {
            selectedCharts.push({
                variable: card.dataset.variable,
                image: img.src
            });
        }
    });
    
    if (selectedCharts.length === 0) {
        alert('Por favor seleccione al menos un gráfico para exportar.');
        return;
    }
    
    // Crear PDF o ZIP con los gráficos seleccionados
    console.log('Exporting', selectedCharts.length, 'charts...');
    // Implementar exportación aquí
}

</script>

<script>

// Variables globales para gráficos de variables
let variablesComparisonChart = null;
let currentVariablesView = 'summary';

// Inicializar cuando se muestre la pestaña
document.getElementById('validation-tab').addEventListener('shown.bs.tab', function (e) {
    // ... código existente ...
    
    // Inicializar gráfico de comparación de variables
    initializeVariablesComparisonChart();
});

function initializeVariablesComparisonChart() {
    const ctx = document.getElementById('variablesComparisonChart');
    if (!ctx) return;
    
    // Destruir gráfico existente si existe
    if (variablesComparisonChart) {
        variablesComparisonChart.destroy();
    }
    
    // Seleccionar las 6 variables más importantes para mostrar
    const keyVariables = ['IT', 'GT', 'TPV', 'TPPRO', 'CTAI', 'GO'];
    const labels = [];
    const realData = [];
    const simulatedData = [];
    
    // Obtener datos de la tabla
    const rows = document.querySelectorAll('#variablesValidationTable tbody tr');
    rows.forEach(row => {
        const varName = row.querySelector('td:first-child strong').textContent;
        if (keyVariables.includes(varName)) {
            labels.push(varName);
            const realValue = parseFloat(row.querySelector('td:nth-child(4)').textContent.replace(/[^\d.-]/g, ''));
            const simValue = parseFloat(row.querySelector('td:nth-child(5)').textContent.replace(/[^\d.-]/g, ''));
            
            // Normalizar valores para mejor visualización
            const maxValue = Math.max(realValue, simValue);
            const normalizedReal = maxValue > 0 ? (realValue / maxValue) * 100 : 0;
            const normalizedSim = maxValue > 0 ? (simValue / maxValue) * 100 : 0;
            
            realData.push(normalizedReal);
            simulatedData.push(normalizedSim);
        }
    });
    
    const config = {
        type: 'radar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Valores Reales',
                data: realData,
                borderColor: 'rgba(54, 162, 235, 1)',
                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                pointBackgroundColor: 'rgba(54, 162, 235, 1)',
                pointBorderColor: '#fff',
                pointHoverBackgroundColor: '#fff',
                pointHoverBorderColor: 'rgba(54, 162, 235, 1)'
            }, {
                label: 'Valores Simulados',
                data: simulatedData,
                borderColor: 'rgba(255, 99, 132, 1)',
                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                pointBackgroundColor: 'rgba(255, 99, 132, 1)',
                pointBorderColor: '#fff',
                pointHoverBackgroundColor: '#fff',
                pointHoverBorderColor: 'rgba(255, 99, 132, 1)'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Comparación de Variables Clave (Normalizado)'
                },
                legend: {
                    position: 'bottom'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ' + context.parsed.r.toFixed(1) + '%';
                        }
                    }
                }
            },
            scales: {
                r: {
                    beginAtZero: true,
                    max: 100,
                    ticks: {
                        stepSize: 20,
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                }
            }
        }
    };
    
    variablesComparisonChart = new Chart(ctx, config);
}

// Función para cambiar vista
function toggleVariablesView() {
    const summaryView = document.getElementById('variablesSummaryView');
    const dailyView = document.getElementById('variablesDailyView');
    
    if (currentVariablesView === 'summary') {
        summaryView.style.display = 'none';
        dailyView.style.display = 'block';
        currentVariablesView = 'daily';
    } else {
        summaryView.style.display = 'block';
        dailyView.style.display = 'none';
        currentVariablesView = 'summary';
    }
}

// Función para filtrar vista diaria por variable
function filterVariableDaily() {
    const filter = document.getElementById('variableFilter').value;
    const rows = document.querySelectorAll('.daily-variable-row');
    
    rows.forEach(row => {
        if (filter === '' || row.dataset.variable === filter) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

// Función para mostrar detalles de una variable
function showVariableDetails(variableName) {
    const modal = new bootstrap.Modal(document.getElementById('variableDetailsModal'));
    const modalTitle = document.getElementById('variableDetailsTitle');
    const modalContent = document.getElementById('variableDetailsContent');
    
    modalTitle.textContent = `Detalles de Validación: ${variableName}`;
    
    // Generar contenido del modal
    const variableData = getVariableValidationData(variableName);
    
    modalContent.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <h6>Información de la Variable</h6>
                <dl class="row">
                    <dt class="col-6">Código:</dt>
                    <dd class="col-6">${variableName}</dd>
                    <dt class="col-6">Descripción:</dt>
                    <dd class="col-6">${variableData.description}</dd>
                    <dt class="col-6">Unidad:</dt>
                    <dd class="col-6">${variableData.unit}</dd>
                    <dt class="col-6">Tipo:</dt>
                    <dd class="col-6">${variableData.type}</dd>
                </dl>
            </div>
            <div class="col-md-6">
                <h6>Estadísticas de Validación</h6>
                <dl class="row">
                    <dt class="col-6">Error Promedio:</dt>
                    <dd class="col-6">
                        <span class="badge ${variableData.avg_error_pct < 5 ? 'bg-success' : variableData.avg_error_pct < 10 ? 'bg-warning' : 'bg-danger'}">
                            ${variableData.avg_error_pct.toFixed(1)}%
                        </span>
                    </dd>
                    <dt class="col-6">Días Válidos:</dt>
                    <dd class="col-6">${variableData.valid_days} de ${variableData.total_days}</dd>
                    <dt class="col-6">Veredicto:</dt>
                    <dd class="col-6">${variableData.verdict}</dd>
                </dl>
            </div>
        </div>
        <hr>
        <div class="row">
            <div class="col-12">
                <canvas id="variableDetailChart" height="150"></canvas>
            </div>
        </div>
    `;
    
    modal.show();
    
    // Crear gráfico de línea para esta variable
    setTimeout(() => {
        createVariableDetailChart(variableName, variableData);
    }, 200);
}

// Función para crear gráfico de detalle de variable
function createVariableDetailChart(variableName, variableData) {
    const ctx = document.getElementById('variableDetailChart');
    if (!ctx) return;
    
    // Obtener datos diarios para esta variable
    const dailyData = getDailyDataForVariable(variableName);
    
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: dailyData.days,
            datasets: [{
                label: 'Valor Real',
                data: dailyData.realValues,
                borderColor: 'rgba(54, 162, 235, 1)',
                backgroundColor: 'rgba(54, 162, 235, 0.1)',
                tension: 0.4
            }, {
                label: 'Valor Simulado',
                data: dailyData.simulatedValues,
                borderColor: 'rgba(255, 99, 132, 1)',
                backgroundColor: 'rgba(255, 99, 132, 0.1)',
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: `Evolución de ${variableName}`
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: variableData.unit
                    }
                }
            }
        }
    });
}

// Función auxiliar para obtener datos de validación de variable
function getVariableValidationData(variableName) {
    // Esta función obtendría los datos de la tabla o de un objeto global
    // Por ahora, retorna datos de ejemplo
    const row = document.querySelector(`tr[data-variable="${variableName}"]`);
    if (row) {
        return {
            description: row.querySelector('td:nth-child(2) small').textContent,
            unit: row.querySelector('td:nth-child(3)').textContent,
            type: row.querySelector('.badge').textContent,
            avg_error_pct: parseFloat(row.querySelector('td:nth-child(6) span').textContent),
            valid_days: parseInt(row.querySelector('td:nth-child(7)').textContent.split('/')[0]),
            total_days: parseInt(row.querySelector('td:nth-child(7)').textContent.split('/')[1]),
            verdict: row.querySelector('td:nth-child(8)').textContent.trim()
        };
    }
    return {};
}

// Función para obtener datos diarios de una variable
function getDailyDataForVariable(variableName) {
    const rows = document.querySelectorAll(`#variablesDailyTable tr[data-variable="${variableName}"]`);
    const days = [];
    const realValues = [];
    const simulatedValues = [];
    
    rows.forEach(row => {
        days.push(row.querySelector('td:first-child').textContent);
        realValues.push(parseFloat(row.querySelector('td:nth-child(3)').textContent));
        simulatedValues.push(parseFloat(row.querySelector('td:nth-child(4)').textContent));
    });
    
    return { days, realValues, simulatedValues };
}

// Función para exportar validación de variables
function exportVariablesValidation() {
    let csv = 'Variable,Descripción,Unidad,Valor Real Promedio,Valor Simulado Promedio,Error Promedio %,Días Válidos,Veredicto\n';
    
    const rows = document.querySelectorAll('#variablesValidationTable tbody tr');
    rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        const variable = cells[0].querySelector('strong').textContent;
        const description = cells[1].textContent.trim();
        const unit = cells[2].textContent.trim();
        const realAvg = cells[3].textContent.replace(/[^\d.-]/g, '');
        const simAvg = cells[4].textContent.replace(/[^\d.-]/g, '');
        const errorAvg = cells[5].querySelector('span').textContent.replace('%', '');
        const validDays = cells[6].textContent.trim();
        const verdict = cells[7].textContent.trim();
        
        csv += `"${variable}","${description}","${unit}",${realAvg},${simAvg},${errorAvg},"${validDays}","${verdict}"\n`;
    });
    
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'validacion_variables_' + new Date().getTime() + '.csv';
    link.click();
    
    showNotification('Validación de variables exportada exitosamente', 'success');
}

</script>


<script>
// Variables globales para los gráficos de validación
let validationPrecisionChart = null;
let validationSummaryChart = null;
let currentChartType = 'bar';

// Inicializar gráficos cuando se muestre la pestaña de validación
document.getElementById('validation-tab').addEventListener('shown.bs.tab', function (e) {
    // Destruir gráficos existentes si existen
    if (validationPrecisionChart) {
        validationPrecisionChart.destroy();
    }
    if (validationSummaryChart) {
        validationSummaryChart.destroy();
    }
    
    // Inicializar gráfico de distribución de precisión
    initializeValidationPrecisionChart();
    
    // Inicializar gráfico de resumen
    initializeValidationSummaryChart();
});

function initializeValidationPrecisionChart() {
    const ctx = document.getElementById('validationPrecisionChart');
    if (!ctx) return;
    
    // Preparar datos desde la tabla
    const tableRows = document.querySelectorAll('#validationDetailTable tbody tr');
    const labels = [];
    const errorData = [];
    const colors = [];
    
    tableRows.forEach(row => {
        const day = row.querySelector('td:first-child').textContent;
        const errorCell = row.querySelector('td:nth-child(7) span');
        const errorValue = parseFloat(errorCell.textContent);
        
        labels.push(`Día ${day}`);
        errorData.push(errorValue);
        
        // Asignar color según el error
        if (errorValue < 10) {
            colors.push('rgba(40, 167, 69, 0.8)'); // Verde
        } else if (errorValue < 20) {
            colors.push('rgba(255, 193, 7, 0.8)'); // Amarillo
        } else {
            colors.push('rgba(220, 53, 69, 0.8)'); // Rojo
        }
    });
    
    // Configuración del gráfico
    const config = {
        type: currentChartType,
        data: {
            labels: labels,
            datasets: [{
                label: 'Error Porcentual (%)',
                data: errorData,
                backgroundColor: currentChartType === 'line' ? 'rgba(54, 162, 235, 0.2)' : colors,
                borderColor: currentChartType === 'line' ? 'rgba(54, 162, 235, 1)' : colors.map(c => c.replace('0.8', '1')),
                borderWidth: currentChartType === 'line' ? 2 : 1,
                tension: currentChartType === 'line' ? 0.4 : 0,
                fill: currentChartType === 'line' ? true : false,
                pointBackgroundColor: currentChartType === 'line' ? colors : undefined,
                pointBorderColor: currentChartType === 'line' ? colors.map(c => c.replace('0.8', '1')) : undefined,
                pointRadius: currentChartType === 'line' ? 4 : 0,
                pointHoverRadius: currentChartType === 'line' ? 6 : 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Distribución de Error Porcentual por Día de Simulación',
                    font: {
                        size: 16
                    }
                },
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `Error: ${context.parsed.y.toFixed(2)}%`;
                        },
                        afterLabel: function(context) {
                            const error = context.parsed.y;
                            if (error < 10) return 'Veredicto: ✅ Precisa';
                            else if (error < 20) return 'Veredicto: ⚠️ Aceptable';
                            else return 'Veredicto: ❌ Inexacta';
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Error Porcentual (%)'
                    },
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    },
                    grid: {
                        color: function(context) {
                            if (context.tick.value === 10) return 'rgba(255, 193, 7, 0.3)';
                            if (context.tick.value === 20) return 'rgba(220, 53, 69, 0.3)';
                            return 'rgba(0, 0, 0, 0.1)';
                        },
                        lineWidth: function(context) {
                            if (context.tick.value === 10 || context.tick.value === 20) return 2;
                            return 1;
                        }
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Días de Simulación'
                    },
                    ticks: {
                        autoSkip: true,
                        maxTicksLimit: 20,
                        callback: function(value, index) {
                            // Mostrar solo cada N días si hay muchos
                            if (labels.length > 50) {
                                return index % 5 === 0 ? this.getLabelForValue(value) : '';
                            }
                            return this.getLabelForValue(value);
                        }
                    }
                }
            },
            interaction: {
                mode: 'index',
                intersect: false
            },
            // Agregar líneas de referencia
            plugins: {
                annotation: {
                    annotations: {
                        line1: {
                            type: 'line',
                            yMin: 10,
                            yMax: 10,
                            borderColor: 'rgba(255, 193, 7, 0.8)',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            label: {
                                content: 'Límite Aceptable (10%)',
                                enabled: true,
                                position: 'end'
                            }
                        },
                        line2: {
                            type: 'line',
                            yMin: 20,
                            yMax: 20,
                            borderColor: 'rgba(220, 53, 69, 0.8)',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            label: {
                                content: 'Límite Inexacto (20%)',
                                enabled: true,
                                position: 'end'
                            }
                        }
                    }
                }
            }
        }
    };
    
    validationPrecisionChart = new Chart(ctx, config);
}

function initializeValidationSummaryChart() {
    const ctx = document.getElementById('validationSummaryChart');
    if (!ctx) return;
    
    // Datos del resumen
    const data = {
        labels: ['Precisa (<10%)', 'Aceptable (10-20%)', 'Inexacta (>20%)'],
        datasets: [{
            data: [
                {{ validation_summary.precise_count|default:0 }},
                {{ validation_summary.acceptable_count|default:0 }},
                {{ validation_summary.inaccurate_count|default:0 }}
            ],
            backgroundColor: [
                'rgba(40, 167, 69, 0.8)',
                'rgba(255, 193, 7, 0.8)',
                'rgba(220, 53, 69, 0.8)'
            ],
            borderColor: [
                'rgba(40, 167, 69, 1)',
                'rgba(255, 193, 7, 1)',
                'rgba(220, 53, 69, 1)'
            ],
            borderWidth: 2
        }]
    };
    
    const config = {
        type: 'doughnut',
        data: data,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 20,
                        usePointStyle: true,
                        font: {
                            size: 12
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((value / total) * 100).toFixed(1);
                            return `${label}: ${value} días (${percentage}%)`;
                        }
                    }
                }
            }
        }
    };
    
    validationSummaryChart = new Chart(ctx, config);
}

// Función para cambiar el tipo de gráfico
function toggleValidationChartType() {
    currentChartType = currentChartType === 'bar' ? 'line' : 'bar';
    if (validationPrecisionChart) {
        validationPrecisionChart.destroy();
        initializeValidationPrecisionChart();
    }
}

// Función para descargar el gráfico
function downloadValidationChart() {
    if (!validationPrecisionChart) return;
    
    const url = validationPrecisionChart.toBase64Image();
    const link = document.createElement('a');
    link.download = 'distribucion_precision_' + new Date().getTime() + '.png';
    link.href = url;
    link.click();
}

// Función para exportar resultados de validación a CSV
function exportValidationResults() {
    let csv = 'Día,Fecha,Producto,Empresa,Demanda Simulada (L),Demanda Real (L),Diferencia (L),Error %,Veredicto\n';
    
    const tableRows = document.querySelectorAll('#validationDetailTable tbody tr.validation-row');
    
    tableRows.forEach(row => {
        const cells = row.querySelectorAll('td');
        const day = cells[0].textContent.trim();
        const date = cells[1].textContent.trim();
        const productInfo = cells[2].textContent.trim().split('\n');
        const product = productInfo[0].trim();
        const business = productInfo[1] ? productInfo[1].trim() : '';
        const simulated = cells[3].textContent.replace(' L', '').trim();
        const real = cells[4].textContent.replace(' L', '').trim();
        const difference = cells[5].textContent.replace(' L', '').replace('+', '').trim();
        const error = cells[6].querySelector('span').textContent.replace('%', '').trim();
        const verdict = cells[7].textContent.trim();
        
        csv += `${day},"${date}","${product}","${business}",${simulated},${real},${difference},${error},"${verdict}"\n`;
    });
    
    // Agregar totales
    const footerCells = document.querySelectorAll('#validationDetailTable tfoot td');
    if (footerCells.length > 0) {
        csv += '\nTotales/Promedios,,,,' + 
               footerCells[3].textContent.replace(' L', '').trim() + ',' +
               footerCells[4].textContent.replace(' L', '').trim() + ',' +
               footerCells[5].textContent.replace(' L', '').replace('+', '').trim() + ',' +
               footerCells[6].querySelector('span').textContent.replace('%', '').trim() + ',';
    }
    
    // Descargar archivo
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'validacion_modelo_' + new Date().getTime() + '.csv';
    link.click();
    
    showNotification('Resultados exportados exitosamente', 'success');
}

// Resaltar filas al hacer hover
document.addEventListener('DOMContentLoaded', function() {
    const validationRows = document.querySelectorAll('.validation-row');
    validationRows.forEach(row => {
        row.addEventListener('mouseenter', function() {
            this.style.backgroundColor = '#f8f9fa';
            this.style.cursor = 'pointer';
        });
        row.addEventListener('mouseleave', function() {
            this.style.backgroundColor = '';
        });
        row.addEventListener('click', function() {
            const day = this.dataset.day;
            // Aquí se podría mostrar más detalles del día específico
            console.log('Día seleccionado:', day);
        });
    });
});
</script>
<script>
// Initialize timeline with limited items
document.addEventListener('DOMContentLoaded', function() {
   // Show only first 10 timeline items initially
   const timelineItems = document.querySelectorAll('.timeline-item');
   let visibleItems = 10;
   
   timelineItems.forEach((item, index) => {
       if (index >= visibleItems) {
           item.style.display = 'none';
       }
   });
   
   // Initialize endogenous table pagination
   initializeEndogenousTablePagination();
});

// Toggle timeline details
function toggleTimelineDetails(day) {
   const detailsDiv = document.getElementById(`timelineDetails${day}`);
   const isVisible = detailsDiv.style.display !== 'none';
   
   if (isVisible) {
       detailsDiv.style.display = 'none';
   } else {
       detailsDiv.style.display = 'block';
       detailsDiv.style.animation = 'fadeIn 0.3s ease';
   }
}

// Load more timeline items
function loadMoreTimeline() {
   const timelineItems = document.querySelectorAll('.timeline-item');
   let visibleCount = 0;
   let itemsToShow = 10;
   
   timelineItems.forEach((item) => {
       if (item.style.display !== 'none') {
           visibleCount++;
       }
   });
   
   let shown = 0;
   timelineItems.forEach((item, index) => {
       if (index >= visibleCount && shown < itemsToShow) {
           item.style.display = 'block';
           item.style.animation = 'fadeIn 0.3s ease';
           shown++;
       }
   });
   
   // Hide button if all items are visible
   if (visibleCount + shown >= timelineItems.length) {
       event.target.style.display = 'none';
   }
}

// Paginate endogenous table
function initializeEndogenousTablePagination() {
   const table = document.getElementById('endogenousTable');
   if (!table) return;
   
   const tbody = table.querySelector('tbody');
   const rows = Array.from(tbody.querySelectorAll('tr'));
   const itemsPerPage = 15;
   let currentPage = 1;
   const totalPages = Math.ceil(rows.length / itemsPerPage);
   
   window.paginateEndogenousTable = function(direction) {
       if (direction === 'prev' && currentPage > 1) {
           currentPage--;
       } else if (direction === 'next' && currentPage < totalPages) {
           currentPage++;
       }
       
       // Hide all rows
       rows.forEach(row => row.style.display = 'none');
       
       // Show current page rows
       const startIndex = (currentPage - 1) * itemsPerPage;
       const endIndex = Math.min(startIndex + itemsPerPage, rows.length);
       
       for (let i = startIndex; i < endIndex; i++) {
           if (rows[i]) {
               rows[i].style.display = 'table-row';
               rows[i].style.animation = 'fadeIn 0.2s ease';
           }
       }
       
       // Update page info
       document.getElementById('endogenousPageInfo').textContent = `Página ${currentPage} de ${totalPages}`;
       
       // Update button states
       const prevBtn = document.querySelector('[onclick="paginateEndogenousTable(\'prev\')"]');
       const nextBtn = document.querySelector('[onclick="paginateEndogenousTable(\'next\')"]');
       
       if (prevBtn) {
           prevBtn.parentElement.classList.toggle('disabled', currentPage === 1);
       }
       if (nextBtn) {
           nextBtn.parentElement.classList.toggle('disabled', currentPage === totalPages);
       }
   };
   
   // Initialize first page
   window.paginateEndogenousTable('init');
}

</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize all interactive features
    initializeCounters();
    initializeDailyResultsPagination();
    initializeTablePagination();
    initializeFullscreen();
    initializeExportFunctions();
    initializeTooltips();
    initializeChartInteractions();
    
    // Check if first time viewing results
    if (!localStorage.getItem('resultsViewedBefore')) {
        localStorage.setItem('resultsViewedBefore', 'true');
    } else {
        // Hide tutorial for returning users
        document.getElementById('resultsTutorial').style.display = 'none';
    }
});

// Hide tutorial
function hideTutorial() {
    const tutorial = document.getElementById('resultsTutorial');
    tutorial.style.animation = 'fadeOut 0.5s ease-out';
    setTimeout(() => {
        tutorial.style.display = 'none';
    }, 500);
}

// Animated Counters
function initializeCounters() {
    const counters = document.querySelectorAll('.counter');
    const speed = 200; // Animation speed
    
    const animateCounter = (counter) => {
        const target = +counter.getAttribute('data-target');
        const count = +counter.innerText;
        const increment = target / speed;
        
        if (count < target) {
            counter.innerText = Math.ceil(count + increment);
            setTimeout(() => animateCounter(counter), 1);
        } else {
            counter.innerText = target;
        }
    };
    
    // Intersection Observer for viewport detection
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                animateCounter(entry.target);
                observer.unobserve(entry.target);
            }
        });
    });
    
    counters.forEach(counter => {
        observer.observe(counter);
    });
}

// Daily Results Pagination
function initializeDailyResultsPagination() {
    const totalDays = {{ all_variables_extracted|length }};
    let currentDay = 1;
    
    const prevBtn = document.getElementById('prevDayBtn');
    const nextBtn = document.getElementById('nextDayBtn');
    const dayCounter = document.getElementById('dayCounter');
    const currentDayIndicator = document.getElementById('currentDayIndicator');
    
    function updateDayDisplay() {
        // Hide all items
        document.querySelectorAll('.daily-result-item').forEach(item => {
            item.style.display = 'none';
        });
        
        // Show current item with animation
        const currentItem = document.querySelector(`[data-day="${currentDay}"]`);
        if (currentItem) {
            currentItem.style.display = 'block';
            currentItem.style.animation = 'fadeIn 0.3s ease';
        }
        
        // Update counters
        dayCounter.textContent = `Día ${currentDay} de ${totalDays}`;
        currentDayIndicator.textContent = `Día ${currentDay}`;
        
        // Update button states
        prevBtn.disabled = currentDay === 1;
        nextBtn.disabled = currentDay === totalDays;
        
        // Add/remove button classes
        prevBtn.classList.toggle('btn-outline-secondary', currentDay === 1);
        prevBtn.classList.toggle('btn-outline-primary', currentDay > 1);
        nextBtn.classList.toggle('btn-outline-secondary', currentDay === totalDays);
        nextBtn.classList.toggle('btn-outline-primary', currentDay < totalDays);
    }
    
    prevBtn.addEventListener('click', function() {
        if (currentDay > 1) {
            currentDay--;
            updateDayDisplay();
        }
    });
    
    nextBtn.addEventListener('click', function() {
        if (currentDay < totalDays) {
            currentDay++;
            updateDayDisplay();
        }
    });
    
    // Initialize display
    updateDayDisplay();
    
    // Keyboard navigation
    document.addEventListener('keydown', function(e) {
        if (e.ctrlKey || e.metaKey) {
            if (e.key === 'ArrowLeft' && currentDay > 1) {
                e.preventDefault();
                currentDay--;
                updateDayDisplay();
            } else if (e.key === 'ArrowRight' && currentDay < totalDays) {
                e.preventDefault();
                currentDay++;
                updateDayDisplay();
            }
        }
    });
}

// Table Pagination
function initializeTablePagination() {
    const table = document.getElementById('demandTable');
    if (!table) return;
    
    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    const itemsPerPage = 10;
    const totalPages = Math.ceil(rows.length / itemsPerPage);
    let currentPage = 1;
    
    const prevBtn = document.getElementById('prevTablePage');
    const nextBtn = document.getElementById('nextTablePage');
    const pageInfo = document.getElementById('tablePageInfo');
    
    function updateTableDisplay() {
        // Hide all rows
        rows.forEach(row => row.style.display = 'none');
        
        // Show current page rows
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = Math.min(startIndex + itemsPerPage, rows.length);
        
        for (let i = startIndex; i < endIndex; i++) {
            if (rows[i]) {
                rows[i].style.display = 'table-row';
                rows[i].style.animation = 'fadeIn 0.2s ease';
            }
        }
        
        // Update page info
        pageInfo.textContent = `Página ${currentPage} de ${totalPages}`;
        
        // Update button states
        prevBtn.disabled = currentPage === 1;
        nextBtn.disabled = currentPage === totalPages;
    }
    
    prevBtn.addEventListener('click', function() {
        if (currentPage > 1) {
            currentPage--;
            updateTableDisplay();
        }
    });
    
    nextBtn.addEventListener('click', function() {
        if (currentPage < totalPages) {
            currentPage++;
            updateTableDisplay();
        }
    });
    
    // Initialize display
    updateTableDisplay();
}

// Fullscreen functionality
function initializeFullscreen() {
    window.openFullscreen = function(imageData, title) {
        const overlay = document.getElementById('fullscreenOverlay');
        const image = document.getElementById('fullscreenImage');
        
        image.src = `data:image/png;base64,${imageData}`;
        image.alt = title;
        overlay.style.display = 'flex';
        
        // Prevent body scroll
        document.body.style.overflow = 'hidden';
    };
    
    window.closeFullscreen = function() {
        const overlay = document.getElementById('fullscreenOverlay');
        overlay.style.display = 'none';
        
        // Restore body scroll
        document.body.style.overflow = '';
    };
    
    // Close on ESC key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeFullscreen();
        }
    });
    
    // Close on overlay click
    document.getElementById('fullscreenOverlay').addEventListener('click', function(e) {
        if (e.target === this) {
            closeFullscreen();
        }
    });
}

// Export functionality
function initializeExportFunctions() {
    window.exportToPDF = async function() {
        const btn = event.target;
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="bx bx-loader-alt bx-spin me-2"></i>Generando PDF...';
        btn.disabled = true;
        
        try {
            // Wait for html2canvas to be ready
            await new Promise(resolve => setTimeout(resolve, 100));
            
            // Capture the main content
            const element = document.querySelector('.page-content');
            const canvas = await html2canvas(element, {
                scale: 2,
                logging: false,
                useCORS: true,
                allowTaint: true
            });
            
            // Convert to PDF
            const imgData = canvas.toDataURL('image/png');
            const pdf = new jspdf.jsPDF({
                orientation: 'landscape',
                unit: 'px',
                format: [canvas.width, canvas.height]
            });
            
            pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
            pdf.save(`simulacion_${new Date().getTime()}_resultados.pdf`);
            
            showNotification('PDF generado exitosamente', 'success');
        } catch (error) {
            console.error('Error generating PDF:', error);
            showNotification('Error al generar PDF', 'error');
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    };
    
    window.exportToExcel = function() {
        const btn = event.target;
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="bx bx-loader-alt bx-spin me-2"></i>Generando Excel...';
        btn.disabled = true;
        
        // Create CSV content
        let csvContent = "data:text/csv;charset=utf-8,";
        
        // Add headers
        csvContent += "Variable,Valor Total,Unidad\n";
        
        // Add data
        {% for name_variable, info_variable in totales_acumulativos.items %}
        csvContent += '"{{ name_variable }}","{{ info_variable.total|floatformat:2 }}","{{ info_variable.unit }}"\n';
        {% endfor %}
        
        // Create download link
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `simulacion_${new Date().getTime()}_resultados.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showNotification('Archivo CSV generado exitosamente', 'success');
        
        btn.innerHTML = originalText;
        btn.disabled = false;
    };
}

// Chart interactions
function initializeChartInteractions() {
    // Download chart
    window.downloadChart = function(imageData, filename) {
        const link = document.createElement('a');
        link.href = `data:image/png;base64,${imageData}`;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showNotification('Gráfico descargado exitosamente', 'success');
    };
    
    // Share results
    window.shareResults = function() {
        if (navigator.share) {
            navigator.share({
                title: 'Resultados de Simulación',
                text: 'Mira los resultados de mi simulación de negocio',
                url: window.location.href
            }).then(() => {
                showNotification('Compartido exitosamente', 'success');
            }).catch((error) => {
                console.log('Error sharing:', error);
            });
        } else {
            // Fallback: copy to clipboard
            navigator.clipboard.writeText(window.location.href).then(() => {
                showNotification('Enlace copiado al portapapeles', 'success');
            });
        }
    };
}

// Timeline functionality
window.loadMoreTimeline = function() {
    showNotification('Cargando más días...', 'info');
    // Here you would load more timeline items via AJAX
};

// Tooltips
function initializeTooltips() {
    // Add CSS for animations
    const style = document.createElement('style');
    style.textContent = `
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-10px); }
        }
        .cursor-pointer { cursor: pointer; }
    `;
    document.head.appendChild(style);
}

// Notification system
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 10000; min-width: 300px;';
    
    const icon = type === 'success' ? 'bx-check-circle' : 
                 type === 'error' ? 'bx-error' : 
                 'bx-info-circle';
    
    notification.innerHTML = `
        <i class="bx ${icon} me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);
}

// Chart loading states
document.querySelectorAll('.chart-image').forEach(img => {
    img.addEventListener('load', function() {
        this.style.opacity = '0';
        this.style.animation = 'fadeIn 0.5s ease forwards';
    });
});

// Smooth tab transitions
document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tab => {
    tab.addEventListener('shown.bs.tab', function(e) {
        const targetPane = document.querySelector(this.getAttribute('data-bs-target'));
        if (targetPane) {
            targetPane.style.animation = 'fadeIn 0.3s ease';
        }
    });
});

// Print functionality
window.addEventListener('beforeprint', function() {
    // Expand all collapsed sections for printing
    document.querySelectorAll('.collapse').forEach(el => {
        el.classList.add('show');
    });
});

window.addEventListener('afterprint', function() {
    // Restore collapsed state after printing
    document.querySelectorAll('.collapse').forEach(el => {
        if (!el.classList.contains('show')) {
            el.classList.remove('show');
        }
    });
});
</script>
{% endblock extra_js %}