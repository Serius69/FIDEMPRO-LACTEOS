{% extends "partials/base.html" %}
{% load static %}
{% block title %}Resultados de Simulación{% endblock title %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/joint.css' %}"> 
<link rel="stylesheet" href="{% static 'libs/dropzone/dist/dropzone.css'%}" type="text/css" />
<link rel="stylesheet" href="{% static 'libs/filepond/dist/filepond.min.css'%}" type="text/css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.9.3/min/dropzone.min.css" />
<link rel="stylesheet" href="{% static 'css/simulate-result.css' %}">
{% endblock extra_css %}
{% block content %}
<div class="main-content">
    <div class="page-content">
        <div class="container-fluid">
            <!-- Page Title -->
            {% block pagetitle %}
            {% include "partials/page-title.html" with pagetitle="Simulación" title="Resultados" %}
            {% endblock pagetitle %}

            <!-- Results Tutorial -->
            <div class="results-tutorial" id="resultsTutorial">
                <h5><i class="bx bx-bulb me-2"></i>Guía de Interpretación de Resultados</h5>
                <p>Sus resultados de simulación están listos. Aquí le explicamos cómo interpretarlos:</p>
                <div class="tutorial-steps">
                    <div class="tutorial-step">
                        <i class="bx bx-bar-chart-alt-2"></i>
                        <h6>Métricas Clave</h6>
                        <p class="small">Revise los indicadores principales en la parte superior</p>
                    </div>
                    <div class="tutorial-step">
                        <i class="bx bx-line-chart"></i>
                        <h6>Análisis Visual</h6>
                        <p class="small">Explore los gráficos interactivos por categoría</p>
                    </div>
                    <div class="tutorial-step">
                        <i class="bx bx-bulb"></i>
                        <h6>Recomendaciones</h6>
                        <p class="small">Lea las sugerencias personalizadas basadas en IA</p>
                    </div>
                    <div class="tutorial-step">
                        <i class="bx bx-download"></i>
                        <h6>Exportar</h6>
                        <p class="small">Descargue reportes en PDF o Excel</p>
                    </div>
                </div>
                <button class="btn btn-sm btn-outline-primary mt-3" onclick="hideTutorial()">
                    <i class="bx bx-x me-1"></i>Entendido
                </button>
            </div>

            <!-- Results Header -->
            <div class="results-header">
                <div class="row align-items-center">
                    <div class="col-lg-8">
                        <h1 class="mb-3">
                            <i class="bx bx-bar-chart-alt-2 me-3"></i>
                            Resultados de Simulación
                        </h1>
                        <p class="fs-5 mb-0">
                            Análisis completo para {{ product_instance.name }} - {{ business_instance.name }}
                        </p>
                        <p class="opacity-75 mb-0">
                            Simulación ejecutada el {{ simulation_instance.date_created|date:"d/m/Y H:i" }}
                        </p>
                    </div>
                    <div class="col-lg-4 text-lg-end">
                        <div class="export-section">
                            <h5 class="mb-3">
                                <i class="bx bx-download me-2"></i>
                                Exportar Resultados
                            </h5>
                            <div class="d-grid gap-2">
                                <button class="btn btn-primary" onclick="exportToPDF()">
                                    <i class="bx bx-file-pdf me-2"></i>
                                    Exportar PDF
                                </button>
                                <button class="btn btn-success" onclick="exportToExcel()">
                                    <i class="bx bx-file me-2"></i>
                                    Exportar Excel
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Key Insights Panel -->
            <div class="insights-panel">
                <h5 class="mb-3"><i class="bx bx-bulb me-2"></i>Insights Principales</h5>
                <div class="row">
                    <div class="col-md-6">
                        <div class="insight-item">
                            <div class="insight-icon {% if growth_rate > 0 %}positive{% else %}negative{% endif %}">
                                <i class="bx {% if growth_rate > 0 %}bx-trending-up{% else %}bx-trending-down{% endif %}"></i>
                            </div>
                            <div>
                                <h6 class="mb-1">Tendencia de Demanda</h6>
                                <p class="mb-0">
                                    La demanda muestra una tendencia 
                                    {% if growth_rate > 0 %}
                                        <strong class="text-success">creciente del {{ growth_rate|floatformat:"2" }}%</strong>
                                    {% else %}
                                        <strong class="text-danger">decreciente del {{ growth_rate|floatformat:"2" }}%</strong>
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="insight-item">
                            <div class="insight-icon {% if error_permisible < 5 %}positive{% elif error_permisible < 10 %}warning{% else %}negative{% endif %}">
                                <i class="bx bx-target-lock"></i>
                            </div>
                            <div>
                                <h6 class="mb-1">Precisión del Modelo</h6>
                                <p class="mb-0">
                                    Error permisible del <strong>{{ error_permisible|floatformat:"2" }}%</strong>
                                    {% if error_permisible < 5 %}
                                        <span class="text-success">(Muy bueno)</span>
                                    {% elif error_permisible < 10 %}
                                        <span class="text-warning">(Bueno)</span>
                                    {% else %}
                                        <span class="text-danger">(Revisar modelo)</span>
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Content Grid -->
            <div class="row">
                <!-- Sidebar with Parameters and Controls -->
                <div class="col-lg-3">
                    <!-- Simulation Parameters -->
                    <div class="metric-card mb-4">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="bx bx-cog me-2"></i>
                                Parámetros de Simulación
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-4">
                                    <img src="{{ product_instance.get_photo_url }}" 
                                         class="img-fluid rounded" 
                                         alt="{{ product_instance.name }}"
                                         loading="lazy">
                                </div>
                                <div class="col-8">
                                    <h6 class="mb-1">{{ business_instance.name }}</h6>
                                    <p class="text-muted mb-0">{{ product_instance.name }}</p>
                                </div>
                            </div>
                            
                            <dl class="row mb-0">
                                <dt class="col-6">Horizonte:</dt>
                                <dd class="col-6">{{ simulation_instance.quantity_time }} {{ simulation_instance.unit_time }}</dd>
                                
                                <dt class="col-6">Inicio:</dt>
                                <dd class="col-6">{{ simulation_instance.date_created|date:"d/m/Y" }}</dd>
                                
                                <dt class="col-6">Estado:</dt>
                                <dd class="col-6">
                                    <span class="badge bg-success">Completada</span>
                                </dd>
                            </dl>
                            
                            <!-- Quick Actions -->
                            <hr>
                            <div class="d-grid gap-2">
                                <button class="btn btn-sm btn-outline-primary" onclick="window.print()">
                                    <i class="bx bx-printer me-1"></i>Imprimir
                                </button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="shareResults()">
                                    <i class="bx bx-share-alt me-1"></i>Compartir
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Financial Recommendations -->
                    {% if financial_recommendations_to_show %}
                    <div class="recommendation-card mb-4">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="bx bx-lightbulb me-2"></i>
                                Recomendaciones Financieras
                            </h5>
                        </div>
                        <div class="card-body">
                            {% for recommendation in financial_recommendations_to_show %}
                            <div class="mb-3 p-3 bg-white rounded">
                                <h6 class="fw-bold text-primary">{{ recommendation.name }}</h6>
                                <p class="mb-2">{{ recommendation.recommendation }}</p>
                                <small class="text-muted">
                                    <i class="bx bx-info-circle me-1"></i>
                                    Variable: {{ recommendation.variable_name }}
                                </small>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Daily Results Navigation -->
                    <div class="container mt-12">
                        <div class="data-table-container">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="bx bx-calendar me-2"></i>
                                    Resultados Diarios
                                    <span class="badge bg-info ms-2" id="currentDayIndicator">Día 1</span>
                                </h5>
                            </div>
                            <div class="card-body" style="max-height: 900px; overflow-y: auto;">
                                <div id="dailyResultsContainer">
                                    {% for item in all_variables_extracted %}
                                    <div class="daily-result-item" 
                                        data-day="{{ forloop.counter }}" 
                                        style="{% if not forloop.first %}display: none;{% endif %}">
                                        <h6 class="text-primary mb-3">
                                            <i class="bx bx-calendar-event me-2"></i>
                                            {% if item.date %}
                                                {{ item.date|date:"d/m/Y" }}
                                            {% else %}
                                                Día {{ forloop.counter }}
                                            {% endif %}
                                        </h6>
                                        
                                        <!-- Demanda del día -->
                                        <div class="mb-4">
                                            <div class="row">
                                                <div class="col-6">
                                                    <div class="p-3 bg-primary text-white rounded">
                                                        <small class="d-block opacity-75">Demanda Media</small>
                                                        <h4 class="mb-0">{{ item.demand_mean|floatformat:2 }}</h4>
                                                    </div>
                                                </div>
                                                <div class="col-6">
                                                    <div class="p-3 bg-info text-white rounded">
                                                        <small class="d-block opacity-75">Desviación Estándar</small>
                                                        <h4 class="mb-0">{{ item.demand_std|floatformat:2 }}</h4>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="table-responsive">
                                            <table class="table table-sm table-hover">
                                                <thead>
                                                    <tr>
                                                        <th style="width: 40%">Variable</th>
                                                        <th style="width: 30%">Valor</th>
                                                        <th style="width: 20%">Unidad</th>
                                                        <th style="width: 10%">Estado</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for key, value in item.items %}
                                                        {% if key != 'day' and key != 'date' and key != 'demand_mean' and key != 'demand_std' %}
                                                        <tr>
                                                            <td class="small">
                                                                <strong>{{ key }}</strong>
                                                                <br>
                                                                <small class="text-muted">
                                                                {% if key == 'PVP' %}Precio de Venta al Público
                                                                {% elif key == 'TPV' %}Total Productos Vendidos
                                                                {% elif key == 'IT' %}Ingresos Totales
                                                                {% elif key == 'TG' %}Total Gastos
                                                                {% elif key == 'GT' %}Ganancia Total
                                                                {% elif key == 'NR' %}Nivel de Rentabilidad
                                                                {% elif key == 'NSC' %}Nivel de Satisfacción del Cliente
                                                                {% elif key == 'EOG' %}Eficiencia Operativa General
                                                                {% elif key == 'DPH' %}Demanda Promedio Histórica
                                                                {% elif key == 'CFD' %}Costo Fijo Diario
                                                                {% elif key == 'CVU' %}Costo Variable Unitario
                                                                {% elif key == 'CPROD' %}Capacidad de Producción
                                                                {% elif key == 'NEPP' %}Número de Empleados en Producción
                                                                {% elif key == 'VPC_BASE' %}Ventas por Cliente Base
                                                                {% elif key == 'IPF_INICIAL' %}Inventario Productos Finales Inicial
                                                                {% elif key == 'II_INICIAL' %}Inventario Insumos Inicial
                                                                {% elif key == 'IPF_NEW' %}Inventario Productos Finales Nuevo
                                                                {% elif key == 'DPE' %}Distancia Promedio de Entrega
                                                                {% elif key == 'DH' %}Demanda Histórica
                                                                {% elif key == 'DE' %}Demanda Esperada
                                                                {% elif key == 'CIP' %}Capacidad Inventario Productos
                                                                {% elif key == 'ED' %}Estacionalidad de la Demanda
                                                                {% elif key == 'CUIP' %}Costo Unitario Insumo
                                                                {% elif key == 'TPC' %}Tiempo Promedio entre Compras
                                                                {% elif key == 'CPD' %}Clientes Por Día
                                                                {% elif key == 'CPPL' %}Cantidad Promedio Producción por Lote
                                                                {% elif key == 'TPE' %}Tiempo de producción por empleado
                                                                {% elif key == 'SE' %}Sueldos Empleados
                                                                {% elif key == 'PC' %}Precio de Venta de la Competencia
                                                                {% elif key == 'CUTRANS' %}Costo Transporte Unitario
                                                                {% elif key == 'TMP' %}Tiempo Medio Procesamiento Pedido
                                                                {% elif key == 'CTPLV' %}Cantidad transportada por viaje
                                                                {% elif key == 'GMM' %}Gastos Marketing Mensual
                                                                {% elif key == 'TR' %}Tiempo Reabastecimiento
                                                                {% elif key == 'CINSP' %}Conversión Insumos
                                                                {% elif key == 'CMIPF' %}Capacidad Máxima Inventario Producto Final
                                                                {% elif key == 'NMD' %}Número Máximo de Días
                                                                {% elif key == 'NPD' %}Número de Proveedores de Leche
                                                                {% elif key == 'SI' %}Stock Inventario Seguridad
                                                                {% elif key == 'DPL' %}Días Promedio de Reposición de Leche
                                                                {% elif key == 'CTL' %}Consumo diario promedio
                                                                {% elif key == 'MLP' %}Minutos Laborables Por Día
                                                                {% elif key == 'HTO' %}Horas Totales de Operación
                                                                {% elif key == 'QMAX' %}Cantidad Máxima Producible
                                                                {% elif key == 'TCFO' %}Temperatura Cadena Frío Objetivo
                                                                {% elif key == 'TEO' %}Tiempo Entrega Objetivo
                                                                {% elif key == 'TE1' %}Tiempo Entrega Proveedor 1
                                                                {% elif key == 'TE2' %}Tiempo Entrega Proveedor 2
                                                                {% elif key == 'TE3' %}Tiempo Entrega Proveedor 3
                                                                {% elif key == 'P1' %}Peso Proveedor 1
                                                                {% elif key == 'P2' %}Peso Proveedor 2
                                                                {% elif key == 'P3' %}Peso Proveedor 3
                                                                {% elif key == 'PMC' %}Participación Mercado Competidor
                                                                {% elif key == 'NPC' %}Número Productos Competencia
                                                                {% elif key == 'QPL' %}Cantidad producida de productos lácteos
                                                                {% elif key == 'VPC' %}Ventas Por Cliente
                                                                {% elif key == 'TCAE' %}Total Clientes Atendidos en el Día
                                                                {% elif key == 'II' %}Inventario Insumos
                                                                {% elif key == 'IPF' %}Inventario Productos Finales
                                                                {% elif key == 'PI' %}Pedido Insumos
                                                                {% elif key == 'UII' %}Uso de Inventario Insumos
                                                                {% elif key == 'PPL' %}Productos Producidos por Lote
                                                                {% elif key == 'TCA' %}Total Clientes Atendidos
                                                                {% elif key == 'TP' %}Tiempo de Parada
                                                                {% elif key == 'QC' %}Cantidad Conforme
                                                                {% elif key == 'CRP' %}Costo Reparaciones
                                                                {% elif key == 'CREP' %}Costo Repuestos
                                                                {% elif key == 'CMOM' %}Costo Mano Obra Mantenimiento
                                                                {% elif key == 'NF' %}Número de Fallas
                                                                {% elif key == 'HMP' %}Horas Mantenimiento Preventivo
                                                                {% elif key == 'HMC' %}Horas Mantenimiento Correctivo
                                                                {% elif key == 'CC' %}Costo de Compra
                                                                {% elif key == 'CTI' %}Costo de Transporte Insumos
                                                                {% elif key == 'CAL' %}Costo de Almacenamiento
                                                                {% elif key == 'CMP1' %}Calidad Materia Prima 1
                                                                {% elif key == 'CMP2' %}Calidad Materia Prima 2
                                                                {% elif key == 'CMP3' %}Calidad Materia Prima 3
                                                                {% elif key == 'V1' %}Volumen Proveedor 1
                                                                {% elif key == 'V2' %}Volumen Proveedor 2
                                                                {% elif key == 'V3' %}Volumen Proveedor 3
                                                                {% elif key == 'IIF' %}Inventario Final Insumos
                                                                {% elif key == 'EAT' %}Entregas a Tiempo
                                                                {% elif key == 'TTEP' %}Total de Entregas Proveedores
                                                                {% elif key == 'ES' %}Empleados Salieron
                                                                {% elif key == 'EE' %}Empleados Entraron
                                                                {% elif key == 'CCAP' %}Costo Capacitación Mensual
                                                                {% elif key == 'HAU' %}Horas Ausentismo
                                                                {% elif key == 'HTP' %}Horas Trabajadas Programadas
                                                                {% elif key == 'LG' %}Leads Generados
                                                                {% elif key == 'NC' %}Nuevos Clientes
                                                                {% elif key == 'AC' %}Alcance de Campañas
                                                                {% elif key == 'ALC' %}Alcance Campañas
                                                                {% elif key == 'MRE' %}Marca Reconocimiento Espontáneo
                                                                {% elif key == 'MRA' %}Marca Reconocimiento Asistido
                                                                {% elif key == 'CDP' %}Calidad Diferenciada Producto
                                                                {% elif key == 'CCP' %}Costo Competitivo Producto
                                                                {% elif key == 'CSP' %}Servicio Competitivo Producto
                                                                {% elif key == 'ICC' %}Intensidad Campañas Competencia
                                                                {% elif key == 'KMT' %}Kilómetros Totales
                                                                {% elif key == 'CCF' %}Costo Cadena Frío
                                                                {% elif key == 'CLOG' %}Costo Logístico
                                                                {% elif key == 'TTED' %}Tiempo Total Entregas Distribución
                                                                {% elif key == 'NE' %}Número de Entregas
                                                                {% elif key == 'TCF' %}Temperatura Cadena Frío
                                                                {% elif key == 'TER' %}Tiempo Entrega Real
                                                                {% elif key == 'PD' %}Productos Devueltos
                                                                {% elif key == 'CTR' %}Costo Total Reorden
                                                                {% elif key == 'CTAI' %}Costo Total Adquisición Insumos
                                                                {% elif key == 'TPPRO' %}Total Productos Producidos
                                                                {% elif key == 'DI' %}Demanda Insatisfecha
                                                                {% elif key == 'GO' %}Gastos Operativos
                                                                {% elif key == 'GG' %}Gastos Generales
                                                                {% elif key == 'CTTL' %}Costo Total Transporte
                                                                {% elif key == 'CPP' %}Costo Promedio Producción
                                                                {% elif key == 'CPV' %}Costo Promedio Venta
                                                                {% elif key == 'CPI' %}Costo Promedio Insumos
                                                                {% elif key == 'CPMO' %}Costo Promedio Mano Obra
                                                                {% elif key == 'CUP' %}Costo Unitario Producción
                                                                {% elif key == 'PVR' %}Precio Venta Recomendado
                                                                {% elif key == 'FU' %}Factor Utilización
                                                                {% elif key == 'IB' %}Ingreso Bruto
                                                                {% elif key == 'MB' %}Margen Bruto
                                                                {% elif key == 'RI' %}Retorno Inversión
                                                                {% elif key == 'RTI' %}Rotación Inventario
                                                                {% elif key == 'RTC' %}Rotación Clientes
                                                                {% elif key == 'PM' %}Participación Mercado
                                                                {% elif key == 'PE' %}Productividad Empleados
                                                                {% elif key == 'HO' %}Horas Ociosas
                                                                {% elif key == 'CHO' %}Costo Horas Ociosas
                                                                {% elif key == 'CA' %}Costo Almacenamiento
                                                                {% elif key == 'DT' %}Demanda Total
                                                                {% elif key == 'NCM' %}Nivel de Competencia en el Mercado
                                                                {% elif key == 'FC' %}Frecuencia de Compra
                                                                {% elif key == 'CUAC' %}Costo Unitario de Adquisición de Clientes
                                                                {% elif key == 'CUI' %}Costo Unitario Inventario
                                                                {% elif key == 'NIL' %}Nivel Ideal del Inventario Leche
                                                                {% elif key == 'DF' %}Tiempo Formulación Pedido
                                                                {% elif key == 'PRL' %}Pedido Reabastecimiento Leche
                                                                {% elif key == 'DSD' %}Desviación Estándar Demanda
                                                                {% elif key == 'CVD' %}Coeficiente Variación Demanda
                                                                {% elif key == 'DDP' %}Demanda Diaria Proyectada
                                                                {% elif key == 'POD' %}Producción Objetivo Diaria
                                                                {% elif key == 'EP' %}Eficiencia Producción
                                                                {% elif key == 'IOP' %}Inventario Objetivo Productos
                                                                {% elif key == 'DCI' %}Días Cobertura Inventario
                                                                {% elif key == 'IOI' %}Inventario Objetivo Insumos
                                                                {% elif key == 'IE' %}Ingresos Esperados
                                                                {% elif key == 'RVE' %}Rentabilidad vs Esperada
                                                                {% elif key == 'HNP' %}Horas Necesarias Producción
                                                                {% elif key == 'EM' %}Efectividad Marketing
                                                                {% elif key == 'IC' %}Índice Competitividad
                                                                {% elif key == 'IDG' %}Índice Desempeño Global
                                                                {% elif key == 'MP' %}Merma Producción Calculada
                                                                {% elif key == 'MI' %}Merma Inventario Calculada
                                                                {% elif key == 'CTM' %}Costo Total Mermas Calculado
                                                                {% elif key == 'ISC' %}Índice Satisfacción Cliente Calculado
                                                                {% elif key == 'PED' %}Punto de Equilibrio Diario
                                                                {% elif key == 'DISP' %}Disponibilidad
                                                                {% elif key == 'OEE' %}Efectividad General Equipos
                                                                {% elif key == 'CML' %}Costo Mantenimiento por Litro
                                                                {% elif key == 'FF' %}Frecuencia de Fallas
                                                                {% elif key == 'RMP' %}Ratio Mantenimiento Preventivo
                                                                {% elif key == 'CTA' %}Costo Total de Adquisición
                                                                {% elif key == 'TPEP' %}Tiempo Promedio Entrega Proveedores
                                                                {% elif key == 'ICP' %}Índice Calidad Proveedores
                                                                {% elif key == 'RIMP' %}Rotación Inventario Materias Primas
                                                                {% elif key == 'CDE' %}Cumplimiento Entregas
                                                                {% elif key == 'IRP' %}Índice Rotación Personal
                                                                {% elif key == 'PPE' %}Productividad por Empleado
                                                                {% elif key == 'CCE' %}Costo Capacitación por Empleado
                                                                {% elif key == 'TAU' %}Tasa Ausentismo
                                                                {% elif key == 'CLL' %}Costo Laboral por Litro
                                                                {% elif key == 'ROIA' %}ROI Inversión Publicitaria
                                                                {% elif key == 'CPL_MKT' %}Costo por Lead
                                                                {% elif key == 'TCL' %}Tasa Conversión Leads
                                                                {% elif key == 'AEC' %}Alcance Efectivo Campañas
                                                                {% elif key == 'RMI' %}Reconocimiento Marca Índice
                                                                {% elif key == 'VCP' %}Ventaja Competitiva Precio
                                                                {% elif key == 'PMR' %}Participación Mercado Relativa
                                                                {% elif key == 'IDP' %}Índice Diferenciación Producto
                                                                {% elif key == 'EEC' %}Efectividad Estrategia Competitiva
                                                                {% elif key == 'AMEN' %}Amenaza Competitiva
                                                                {% elif key == 'ERE' %}Eficiencia Rutas Entrega
                                                                {% elif key == 'CDL' %}Costo Distribución por Litro
                                                                {% elif key == 'TPEC' %}Tiempo Promedio Entrega Cliente
                                                                {% elif key == 'ICE' %}Índice Calidad Entrega
                                                                {% elif key == 'TD' %}Tasa Devoluciones
                                                                {% else %}{{ key }}
                                                                {% endif %}
                                                            </small>
                                                                                                                        </td>
                                                                                                                        <td class="fw-bold">
                                                                {% if key == 'NR' or key == 'NSC' or key == 'EOG' or key == 'EP' or key == 'RVE' or key == 'EM' or key == 'IC' or key == 'IDG' or key == 'ISC' or key == 'DISP' or key == 'OEE' or key == 'RMP' or key == 'TAU' or key == 'ROIA' or key == 'TCL' or key == 'TD' or key == 'MB' or key == 'RI' or key == 'PM' or key == 'FU' or key == 'VCP' or key == 'PMR' or key == 'EEC' or key == 'CVD' %}
                                                                    {{ value|floatformat:3 }}
                                                                {% elif key == 'PVP' or key == 'IT' or key == 'TG' or key == 'GT' or key == 'CFD' or key == 'CVU' or key == 'CUIP' or key == 'SE' or key == 'PC' or key == 'CUTRANS' or key == 'GMM' or key == 'CINSP' or key == 'TCFO' or key == 'TEO' or key == 'P1' or key == 'P2' or key == 'P3' or key == 'CRP' or key == 'CREP' or key == 'CMOM' or key == 'HMP' or key == 'HMC' or key == 'CC' or key == 'CTI' or key == 'CAL' or key == 'CMP1' or key == 'CMP2' or key == 'CMP3' or key == 'CCAP' or key == 'CCF' or key == 'CLOG' or key == 'TCF' or key == 'TER' or key == 'CTR' or key == 'CTAI' or key == 'GO' or key == 'GG' or key == 'CTTL' or key == 'CPP' or key == 'CPV' or key == 'CPI' or key == 'CPMO' or key == 'CUP' or key == 'PVR' or key == 'IB' or key == 'CHO' or key == 'CA' or key == 'CUAC' or key == 'CUI' or key == 'IE' or key == 'CTM' or key == 'CTA' or key == 'CCE' or key == 'CLL' or key == 'CPL_MKT' or key == 'CDL' or key == 'CML' %}
                                                                    {{ value|floatformat:2 }}
                                                                {% else %}
                                                                    {{ value|floatformat:2 }}
                                                                {% endif %}
                                                            </td>
                                                                                                                        <td class="small text-muted">
                                                                {% if key == 'TPV' or key == 'DPH' or key == 'DH' or key == 'DE' or key == 'CIP' or key == 'CPPL' or key == 'QMAX' or key == 'QPL' or key == 'VPC' or key == 'VPC_BASE' or key == 'IPF_INICIAL' or key == 'II_INICIAL' or key == 'IPF_NEW' or key == 'II' or key == 'IPF' or key == 'PI' or key == 'UII' or key == 'PPL' or key == 'QC' or key == 'V1' or key == 'V2' or key == 'V3' or key == 'IIF' or key == 'KMT' or key == 'PD' or key == 'TPPRO' or key == 'DI' or key == 'DT' or key == 'NIL' or key == 'PRL' or key == 'DSD' or key == 'DDP' or key == 'POD' or key == 'IOP' or key == 'IOI' or key == 'MP' or key == 'MI' or key == 'PED' or key == 'CTL' or key == 'CMIPF' or key == 'SI' %}Litros
                                                                {% elif key == 'PVP' or key == 'IT' or key == 'TG' or key == 'GT' or key == 'CFD' or key == 'CVU' or key == 'CUIP' or key == 'SE' or key == 'PC' or key == 'CUTRANS' or key == 'GMM' or key == 'CRP' or key == 'CREP' or key == 'CMOM' or key == 'CC' or key == 'CTI' or key == 'CAL' or key == 'CCAP' or key == 'CCF' or key == 'CLOG' or key == 'CTR' or key == 'CTAI' or key == 'GO' or key == 'GG' or key == 'CTTL' or key == 'CPP' or key == 'CPV' or key == 'CPI' or key == 'CPMO' or key == 'CUP' or key == 'PVR' or key == 'IB' or key == 'CHO' or key == 'CA' or key == 'CUAC' or key == 'CUI' or key == 'IE' or key == 'CTM' or key == 'CTA' or key == 'CCE' or key == 'CLL' or key == 'CPL_MKT' or key == 'CDL' or key == 'CML' %}Bs.
                                                                {% elif key == 'NR' or key == 'NSC' or key == 'EOG' or key == 'ED' or key == 'P1' or key == 'P2' or key == 'P3' or key == 'PMC' or key == 'MRE' or key == 'MRA' or key == 'NCM' or key == 'EP' or key == 'CVD' or key == 'RVE' or key == 'EM' or key == 'IC' or key == 'IDG' or key == 'ISC' or key == 'DISP' or key == 'OEE' or key == 'RMP' or key == 'CDE' or key == 'IRP' or key == 'TAU' or key == 'ROIA' or key == 'TCL' or key == 'VCP' or key == 'EEC' or key == 'TD' or key == 'MB' or key == 'RI' or key == 'PM' or key == 'FU' %}%
                                                                {% elif key == 'CPROD' %}L/día
                                                                {% elif key == 'NEPP' or key == 'CPD' or key == 'TCAE' or key == 'TCA' or key == 'NPC' or key == 'EAT' or key == 'TTEP' or key == 'ES' or key == 'EE' or key == 'LG' or key == 'NC' or key == 'AC' or key == 'ALC' or key == 'NE' or key == 'NF' or key == 'NPD' %}Personas
                                                                {% elif key == 'DPE' %}KM
                                                                {% elif key == 'TPC' or key == 'TMP' or key == 'TR' or key == 'NMD' or key == 'DPL' or key == 'TE1' or key == 'TE2' or key == 'TE3' or key == 'DCI' or key == 'DF' %}DÍAS
                                                                {% elif key == 'TPE' or key == 'MLP' or key == 'HNP' %}minutos
                                                                {% elif key == 'HTO' or key == 'TEO' or key == 'TP' or key == 'HMP' or key == 'HMC' or key == 'HAU' or key == 'HTP' or key == 'TTED' or key == 'TER' or key == 'TPEC' or key == 'HO' %}HORAS
                                                                {% elif key == 'CINSP' %}L/L
                                                                {% elif key == 'TCFO' or key == 'TCF' %}°C
                                                                {% elif key == 'CUIP' or key == 'CUTRANS' or key == 'CVU' or key == 'CML' or key == 'CDL' or key == 'CLL' %}Bs/L
                                                                {% elif key == 'SE' or key == 'GMM' or key == 'CCAP' %}Bs/mes
                                                                {% elif key == 'CMP1' or key == 'CMP2' or key == 'CMP3' or key == 'CDP' or key == 'CCP' or key == 'CSP' or key == 'ICP' or key == 'RMI' or key == 'IDP' %}PUNTOS
                                                                {% elif key == 'ICC' or key == 'AMEN' or key == 'ICE' %}INDICE
                                                                {% elif key == 'FC' %}VECES/DÍA
                                                                {% elif key == 'RTI' or key == 'RTC' or key == 'PMR' %}VECES
                                                                {% elif key == 'PE' or key == 'PPE' %}L/EMPLEADO
                                                                {% elif key == 'FF' %}FALLAS/1000H
                                                                {% elif key == 'RIMP' %}VECES/AÑO
                                                                {% elif key == 'CCE' %}BS/EMPLEADO
                                                                {% elif key == 'CPL_MKT' %}BS/LEAD
                                                                {% elif key == 'CUAC' %}BS/CLIENTE
                                                                {% elif key == 'ERE' %}L/KM
                                                                {% else %}Unidad
                                                                {% endif %}
                                                            </td>
                                                            <td>
                                                                {% if key == 'NR' %}
                                                                    {% if value >= 0.2 %}
                                                                        <span class="badge bg-success">Óptimo</span>
                                                                    {% elif value >= 0.1 %}
                                                                        <span class="badge bg-warning">Aceptable</span>
                                                                    {% else %}
                                                                        <span class="badge bg-danger">Crítico</span>
                                                                    {% endif %}
                                                                {% elif key == 'NSC' %}
                                                                    {% if value >= 0.9 %}
                                                                        <span class="badge bg-success">Excelente</span>
                                                                    {% elif value >= 0.7 %}
                                                                        <span class="badge bg-warning">Bueno</span>
                                                                    {% else %}
                                                                        <span class="badge bg-danger">Bajo</span>
                                                                    {% endif %}
                                                                {% elif key == 'EOG' %}
                                                                    {% if value >= 0.8 %}
                                                                        <span class="badge bg-success">Alta</span>
                                                                    {% elif value >= 0.6 %}
                                                                        <span class="badge bg-warning">Media</span>
                                                                    {% else %}
                                                                        <span class="badge bg-danger">Baja</span>
                                                                    {% endif %}
                                                                {% else %}
                                                                    <span class="badge bg-info">Normal</span>
                                                                {% endif %}
                                                            </td>
                                                        </tr>
                                                        {% endif %}
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                        
                                        <!-- Additional daily stats -->
                                        <div class="mt-4">
                                            <h6 class="text-muted mb-3">Estadísticas del día</h6>
                                            <div class="row g-3">
                                                <div class="col-6 col-md-3">
                                                    <div class="p-3 bg-light rounded text-center">
                                                        <small class="d-block text-muted">Total Variables</small>
                                                        <h5 class="mb-0">
                                                            {% with total_vars=0 %}
                                                                {% for key, value in item.items %}
                                                                    {% if key != 'day' and key != 'date' and key != 'demand_mean' and key != 'demand_std' %}
                                                                        {% with total_vars=total_vars|add:1 %}{% endwith %}
                                                                    {% endif %}
                                                                {% endfor %}
                                                                {{ item.items|length|add:-4 }}
                                                            {% endwith %}
                                                        </h5>
                                                    </div>
                                                </div>
                                                <div class="col-6 col-md-3">
                                                    <div class="p-3 bg-light rounded text-center">
                                                        <small class="d-block text-muted">Día de Simulación</small>
                                                        <h5 class="mb-0">{{ forloop.counter }}</h5>
                                                    </div>
                                                </div>
                                                {% if item.GT %}
                                                <div class="col-6 col-md-3">
                                                    <div class="p-3 bg-light rounded text-center">
                                                        <small class="d-block text-muted">Ganancia</small>
                                                        <h5 class="mb-0 {% if item.GT > 0 %}text-success{% else %}text-danger{% endif %}">
                                                            {{ item.GT|floatformat:0 }} Bs.
                                                        </h5>
                                                    </div>
                                                </div>
                                                {% endif %}
                                                {% if item.NR %}
                                                <div class="col-6 col-md-3">
                                                    <div class="p-3 bg-light rounded text-center">
                                                        <small class="d-block text-muted">Rentabilidad</small>
                                                        <h5 class="mb-0 {% if item.NR >= 0.2 %}text-success{% elif item.NR >= 0.1 %}text-warning{% else %}text-danger{% endif %}">
                                                            {{ item.NR|floatformat:1 }}%
                                                        </h5>
                                                    </div>
                                                </div>
                                                {% endif %}
                                            </div>
                                        </div>

                                        <!-- Daily notes section -->
                                        <div class="mt-4">
                                            <div class="alert alert-info">
                                                <h6 class="mb-2"><i class="bx bx-info-circle me-2"></i>Análisis del día {{ forloop.counter }}</h6>
                                                <small>
                                                    {% if item.GT and item.NR %}
                                                        Ganancia del día: <strong>{{ item.GT|floatformat:2 }} Bs.</strong> 
                                                        con rentabilidad de <strong>{{ item.NR|floatformat:1 }}%</strong>.
                                                        {% if item.NSC %}
                                                            Satisfacción del cliente: <strong>{{ item.NSC|floatformat:1 }}%</strong>.
                                                        {% endif %}
                                                    {% else %}
                                                        Datos correspondientes a la simulación del día {{ forloop.counter }}. 
                                                        Variables calculadas según el modelo de simulación.
                                                    {% endif %}
                                                </small>
                                            </div>
                                        </div>

                                    </div>
                                    {% empty %}
                                    <div class="text-center py-5">
                                        <i class="bx bx-info-circle display-4 text-muted"></i>
                                        <h5 class="mt-3 text-muted">No hay datos de variables disponibles</h5>
                                        <p class="text-muted">Los resultados de la simulación no contienen datos de variables para mostrar.</p>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            <div class="pagination-controls p-3 bg-light">
                                <div class="d-flex justify-content-between align-items-center">
                                    <button type="button" class="btn btn-sm btn-outline-primary btn-pagination" id="prevDayBtn">
                                        <i class="bx bx-chevron-left me-1"></i>Anterior
                                    </button>
                                    <span class="text-center small text-muted" id="dayCounter">
                                        Día 1 de {{ all_variables_extracted|length }}
                                    </span>
                                    <button type="button" class="btn btn-sm btn-outline-primary btn-pagination" id="nextDayBtn">
                                        Siguiente<i class="bx bx-chevron-right ms-1"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Main Charts and Analysis -->
                <div class="col-lg-9">
                    <!-- Chart Tabs -->
                        <div class="chart-tabs">
                            <ul class="nav nav-tabs" id="chartTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" 
                                            data-bs-target="#overview" type="button" role="tab">
                                        <i class="bx bx-line-chart me-2"></i>
                                        Resumen General
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="financial-tab" data-bs-toggle="tab" 
                                            data-bs-target="#financial" type="button" role="tab">
                                        <i class="bx bx-dollar me-2"></i>
                                        Análisis Financiero
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="operations-tab" data-bs-toggle="tab" 
                                            data-bs-target="#operations" type="button" role="tab">
                                        <i class="bx bx-cog me-2"></i>
                                        Operaciones
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="demand-tab" data-bs-toggle="tab" 
                                            data-bs-target="#demand" type="button" role="tab">
                                        <i class="bx bx-trending-up me-2"></i>
                                        Demanda
                                    </button>
                                </li>
                                <!-- En la sección de Tab Content, agregar nuevos tabs -->
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="endogenous-tab" data-bs-toggle="tab" 
                                            data-bs-target="#endogenous" type="button" role="tab">
                                        <i class="bx bx-scatter-chart me-2"></i>
                                        Variables Endógenas
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="analysis-tab" data-bs-toggle="tab" 
                                            data-bs-target="#analysis" type="button" role="tab">
                                        <i class="bx bx-analyse me-2"></i>
                                        Análisis Estadístico
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="validation-tab" data-bs-toggle="tab" 
                                            data-bs-target="#validation" type="button" role="tab">
                                        <i class="bx bx-check-double me-2"></i>
                                        Validación del Modelo
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="ks-validation-tab" data-bs-toggle="tab" 
                                            data-bs-target="#ks-validation" type="button" role="tab">
                                        <i class="bx bx-test-tube me-2"></i>
                                        Validación KS
                                    </button>
                                </li>
                            </ul>
                        </div>
                        <!-- Tab Content -->
                        <div class="tab-content" id="chartTabsContent">
                            <!-- Overview Tab -->
                            <div class="tab-pane fade show active" id="overview" role="tabpanel">
                                
                                <!-- Header de resumen ejecutivo -->
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <div class="executive-summary">
                                            <div class="summary-header">
                                                <h2 class="summary-title">
                                                    <i class="bx bx-chart me-3"></i>
                                                    Resumen Ejecutivo de la Simulación
                                                </h2>
                                                <div class="summary-badges">
                                                    {% if simulation_instance.date_created %}
                                                    <span class="badge bg-info">
                                                        <i class="bx bx-calendar me-1"></i>
                                                        {{ simulation_instance.date_created|date:"d/m/Y H:i" }}
                                                    </span>
                                                    {% endif %}
                                                    <span class="badge bg-success">
                                                        <i class="bx bx-check-circle me-1"></i>
                                                        Simulación Completada
                                                    </span>
                                                    {% if validation_summary.success_rate %}
                                                    <span class="badge bg-{% if validation_summary.success_rate >= 80 %}success{% elif validation_summary.success_rate >= 60 %}warning{% else %}danger{% endif %}">
                                                        <i class="bx bx-target-lock me-1"></i>
                                                        Precisión: {{ validation_summary.success_rate|floatformat:1 }}%
                                                    </span>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            <div class="summary-description">
                                                <p class="lead">
                                                    Análisis integral de {{ all_variables_extracted|length|default:0 }} días de simulación 
                                                    para <strong>{{ product_instance.name|default:"el producto" }}</strong> de 
                                                    <strong>{{ business_instance.name|default:"la empresa" }}</strong>.
                                                    {% if totales_acumulativos.GT %}
                                                        {% if totales_acumulativos.GT.total > 0 %}
                                                            La simulación proyecta un escenario <span class="text-success font-weight-bold">rentable</span> 
                                                            con ganancias totales de <strong>Bs. {{ totales_acumulativos.GT.total|floatformat:2 }}</strong>.
                                                        {% else %}
                                                            La simulación indica la necesidad de <span class="text-warning font-weight-bold">optimización</span> 
                                                            en la estrategia operativa y financiera.
                                                        {% endif %}
                                                    {% endif %}
                                                </p>
                                                
                                                <p class="lead">
                                                    El análisis de demanda revela que la demanda histórica promedio es de 
                                                    <strong>{{ demand_stats.historical.mean|floatformat:1 }} L diarios</strong>, mientras que la simulación 
                                                    proyecta una demanda de <strong>{{ demand_stats.simulated.mean|floatformat:1 }} L diarios</strong>.
                                                    {% if demand_stats.comparison.mean_diff > 0 %}
                                                        Esto representa un <span class="text-success font-weight-bold">incremento esperado</span> de 
                                                        <strong>{{ demand_stats.comparison.mean_diff|floatformat:1 }} L</strong>
                                                        {% if demand_stats.comparison.mean_diff_pct %}
                                                            ({{ demand_stats.comparison.mean_diff_pct|floatformat:1 }}%)
                                                        {% endif %}, 
                                                        indicando un crecimiento positivo en la demanda del producto.
                                                    {% elif demand_stats.comparison.mean_diff < 0 %}
                                                        Esto representa una <span class="text-danger font-weight-bold">disminución esperada</span> de 
                                                        <strong>{{ demand_stats.comparison.mean_diff|floatformat:1 }} L</strong>
                                                        {% if demand_stats.comparison.mean_diff_pct %}
                                                            ({{ demand_stats.comparison.mean_diff_pct|floatformat:1 }}%)
                                                        {% endif %}, 
                                                        sugiriendo la necesidad de estrategias para estimular la demanda.
                                                    {% else %}
                                                        Esto muestra una <span class="text-info font-weight-bold">estabilidad</span> en los patrones de demanda, 
                                                        manteniendo niveles consistentes con el comportamiento histórico.
                                                    {% endif %}
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Gráficos principales del overview -->
                                <div class="row mb-4">
                                    <div class="col-lg-6 mb-4">
                                <div class="chart-container">
                                    <!-- TEXTO ARRIBA: Header con título y controles -->
                                    <div class="chart-header">
                                        <h6 class="chart-title mb-3">
                                            <i class="bx bx-dollar me-2"></i>
                                            Evolución Financiera: Ingresos vs Ganancias
                                        </h6>
                                        <div class="chart-controls">
                                            {% if image_data_ingresos_gastos %}
                                            <div class="chart-control-btn" onclick="downloadChart('{{ image_data_ingresos_gastos }}', 'ingresos-ganancias.png')" title="Descargar">
                                                <i class="bx bx-download"></i>
                                            </div>
                                            <div class="chart-control-btn" onclick="openFullscreen('{{ image_data_ingresos_gastos }}', 'Ingresos vs Ganancias')" title="Pantalla completa">
                                                <i class="bx bx-fullscreen"></i>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>

                                    <!-- GRÁFICO EN EL MEDIO: Imagen o placeholder -->
                                    <div class="chart-content">
                                        {% if image_data_ingresos_gastos %}
                                        <img src="data:image/png;base64,{{ image_data_ingresos_gastos }}" 
                                            class="chart-image" 
                                            alt="Evolución Financiera: Ingresos vs Ganancias"
                                            loading="lazy">
                                        {% else %}
                                        <div class="chart-placeholder">
                                            <i class="bx bx-chart text-muted" style="font-size: 3rem;"></i>
                                            <p class="text-muted mt-2">Gráfico financiero no disponible</p>
                                            <small class="text-muted">Los datos se generarán durante el análisis</small>
                                        </div>
                                        {% endif %}
                                    </div>

                                    <!-- FOOTER ABAJO: Resumen y análisis -->
                                    <div class="chart-footer">
                                        <div class="chart-summary">
                                            <small class="text-muted">
                                                {% if totales_acumulativos.IT and totales_acumulativos.GT %}
                                                    Rendimiento financiero: 
                                                    {% if totales_acumulativos.GT.total > 0 %}
                                                        <span class="text-success">Positivo</span> - 
                                                        Margen del {{ margin_percent|floatformat:1 }}%
                                                    {% else %}
                                                        <span class="text-danger">Requiere optimización</span>
                                                    {% endif %}
                                                {% else %}
                                                    Análisis financiero en proceso
                                                {% endif %}
                                            </small>
                                        </div>
                                    </div>
                                </div>
                        </div>               
                            <div class="col-lg-6 mb-4">
                                <div class="chart-container">
                                    <!-- TEXTO ARRIBA: Header con título y controles -->
                                    <div class="chart-header">
                                        <h6 class="chart-title mb-3">
                                            <i class="bx bx-line-chart me-2"></i>
                                            Comportamiento de la Demanda
                                        </h6>
                                        <div class="chart-controls">
                                            {% if image_data_simulation %}
                                            <div class="chart-control-btn" onclick="downloadChart('{{ image_data_simulation }}', 'tendencia-demanda.png')" title="Descargar">
                                                <i class="bx bx-download"></i>
                                            </div>
                                            <div class="chart-control-btn" onclick="openFullscreen('{{ image_data_simulation }}', 'Tendencia de Demanda')" title="Pantalla completa">
                                                <i class="bx bx-fullscreen"></i>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>

                                    <!-- GRÁFICO EN EL MEDIO: Imagen o placeholder -->
                                    <div class="chart-content">
                                        {% if image_data_simulation %}
                                        <img src="data:image/png;base64,{{ image_data_simulation }}" 
                                            class="chart-image" 
                                            alt="Comportamiento de la Demanda"
                                            loading="lazy">
                                        {% elif comparison_chart %}
                                        <img src="data:image/png;base64,{{ comparison_chart }}" 
                                            class="chart-image" 
                                            alt="Comparación de Demanda"
                                            loading="lazy">
                                        {% else %}
                                        <div class="chart-placeholder">
                                            <i class="bx bx-chart text-muted" style="font-size: 3rem;"></i>
                                            <p class="text-muted mt-2">Gráfico de demanda no disponible</p>
                                            <small class="text-muted">Los datos se generarán durante el análisis</small>
                                        </div>
                                        {% endif %}
                                    </div>

                                    <!-- FOOTER ABAJO: Resumen y análisis -->
                                    <div class="chart-footer">
                                        <div class="chart-summary">
                                            <small class="text-muted">
                                                {% if growth_rate %}
                                                    Tendencia de crecimiento: 
                                                    {% if growth_rate > 0 %}
                                                        <span class="text-success">+{{ growth_rate|floatformat:2 }}%</span> - Creciente
                                                    {% elif growth_rate < 0 %}
                                                        <span class="text-danger">{{ growth_rate|floatformat:2 }}%</span> - Decreciente
                                                    {% else %}
                                                        <span class="text-info">{{ growth_rate|floatformat:2 }}%</span> - Estable
                                                    {% endif %}
                                                {% elif demand_stats.comparison.mean_diff_pct %}
                                                    Cambio vs histórico: {{ demand_stats.comparison.mean_diff_pct|floatformat:2 }}%
                                                {% else %}
                                                    Análisis de tendencia en proceso
                                                {% endif %}
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Gráficos adicionales de overview -->
                        <div class="row mb-6">
                            <div class="col-lg-6 mb-3">
                            <div class="chart-container compact">
                                <!-- TEXTO ARRIBA: Título -->
                                <div class="chart-header">
                                    <h6 class="chart-title mb-3">
                                        <i class="bx bx-bar-chart me-2"></i>
                                        Eficiencia Operativa
                                    </h6>
                                </div>

                                <!-- GRÁFICO EN EL MEDIO: Imagen o placeholder -->
                                <div class="chart-content">
                                    {% if image_data_eficiencia %}
                                    <img src="data:image/png;base64,{{ image_data_eficiencia }}" 
                                        class="chart-image" 
                                        alt="Eficiencia Operativa"
                                        loading="lazy">
                                    {% else %}
                                    <div class="chart-placeholder compact">
                                        <i class="bx bx-bar-chart text-muted" style="font-size: 2rem;"></i>
                                        <p class="text-muted mt-2">No disponible</p>
                                    </div>
                                    {% endif %}
                                </div>

                                <!-- FOOTER ABAJO: Podría agregarse aquí si se necesita -->
                                <div class="chart-footer">
                                    <!-- Footer vacío para mantener consistencia -->
                                </div>
                            </div>
                        </div>
                                <div class="col-lg-6 mb-3">
                                    <div class="chart-container compact">
                                        <!-- TEXTO ARRIBA: Título -->
                                        <div class="chart-header">
                                            <h6 class="chart-title mb-3">
                                                <i class="bx bx-trending-up me-2"></i>
                                                Análisis de ROI
                                            </h6>
                                        </div>

                                        <!-- GRÁFICO EN EL MEDIO: Imagen o placeholder -->
                                        <div class="chart-content">
                                            {% if image_data_kpis %}
                                            <img src="data:image/png;base64,{{ image_data_kpis }}" 
                                                class="chart-image" 
                                                alt="Análisis de KPIs"
                                                loading="lazy">
                                            {% elif image_data_rentabilidad %}
                                            <img src="data:image/png;base64,{{ image_data_rentabilidad }}" 
                                                class="chart-image" 
                                                alt="Análisis de Rentabilidad"
                                                loading="lazy">
                                            {% else %}
                                            <div class="chart-placeholder compact">
                                                <i class="bx bx-trending-up text-muted" style="font-size: 2rem;"></i>
                                                <p class="text-muted mt-2">No disponible</p>
                                            </div>
                                            {% endif %}
                                        </div>

                                        <!-- FOOTER ABAJO: Podría agregarse aquí si se necesita -->
                                        <div class="chart-footer">
                                            <!-- Footer vacío para mantener consistencia -->
                                        </div>
                                    </div>
                                </div>
                                </div>

                                <!-- Datos estadísticos adicionales si están disponibles -->
                                {% if demand_stats.comparison %}
                                <div class="row mb-9">
                                    <div class="col-12">
                                        <h5 class="mb-3">
                                            <i class="bx bx-calculator me-2"></i>
                                            Estadísticas Comparativas
                                        </h5>
                                        <div class="row">
                                            <div class="col-md-3">
                                                <div class="text-center p-3 border rounded">
                                                    <h6 class="text-muted mb-1">Correlación</h6>
                                                    <h4 class="mb-0 {% if demand_stats.comparison.correlation > 0.8 %}text-success{% elif demand_stats.comparison.correlation > 0.6 %}text-warning{% else %}text-danger{% endif %}">
                                                        {{ demand_stats.comparison.correlation|floatformat:3 }}
                                                    </h4>
                                                    <small class="text-muted">Histórico vs Simulado</small>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="text-center p-3 border rounded">
                                                    <h6 class="text-muted mb-1">MAPE</h6>
                                                    <h4 class="mb-0 {% if demand_stats.comparison.mape < 10 %}text-success{% elif demand_stats.comparison.mape < 20 %}text-warning{% else %}text-danger{% endif %}">
                                                        {{ demand_stats.comparison.mape|floatformat:2 }}%
                                                    </h4>
                                                    <small class="text-muted">Error promedio</small>
                                                </div>
                                            </div>
                                            {% if demand_stats.comparison.r_squared %}
                                            <div class="col-md-3">
                                                <div class="text-center p-3 border rounded">
                                                    <h6 class="text-muted mb-1">R²</h6>
                                                    <h4 class="mb-0 {% if demand_stats.comparison.r_squared > 0.8 %}text-success{% elif demand_stats.comparison.r_squared > 0.6 %}text-warning{% else %}text-danger{% endif %}">
                                                        {{ demand_stats.comparison.r_squared|floatformat:3 }}
                                                    </h4>
                                                    <small class="text-muted">Bondad de ajuste</small>
                                                </div>
                                            </div>
                                            {% endif %}
                                            {% if demand_stats.comparison.mean_diff_pct %}
                                            <div class="col-md-3">
                                                <div class="text-center p-3 border rounded">
                                                    <h6 class="text-muted mb-1">Cambio en Media</h6>
                                                    <h4 class="mb-0 {% if demand_stats.comparison.mean_diff_pct > -5 and demand_stats.comparison.mean_diff_pct < 5 %}text-success{% else %}text-warning{% endif %}">
                                                        {% if demand_stats.comparison.mean_diff_pct > 0 %}+{% endif %}{{ demand_stats.comparison.mean_diff_pct|floatformat:1 }}%
                                                    </h4>
                                                    <small class="text-muted">vs histórico</small>
                                                </div>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        <!-- Financial Tab -->
                        <div class="tab-pane fade" id="financial" role="tabpanel">
                            
                            <!-- Header con resumen financiero -->
                            <div class="row mb-4">
                                <div class="col-12">
                                    <div class="alert alert-success">
                                        <h4 class="alert-heading mb-3">
                                            <i class="bx bx-dollar-circle me-2"></i>
                                            Análisis Financiero Integral
                                        </h4>
                                        <p class="mb-2">
                                            Análisis completo de la performance financiera de la simulación, incluyendo ingresos, gastos, 
                                            rentabilidad y métricas clave de rendimiento financiero.
                                        </p>
                                        <small class="text-muted">
                                            Período analizado: <strong>{{ all_variables_extracted|length|default:0 }} días</strong> | 
                                            {% if totales_acumulativos.GT %}
                                                Ganancia total: <strong>Bs. {{ totales_acumulativos.GT.total|floatformat:2|default:"0.00" }}</strong>
                                            {% endif %}
                                            {% if validation_summary.success_rate %}
                                                | Precisión del modelo: <strong>{{ validation_summary.success_rate|floatformat:1 }}%</strong>
                                            {% endif %}
                                        </small>
                                    </div>
                                </div>
                            </div>

                            <!-- Métricas financieras principales -->
                            <div class="row mb-4">
                                <div class="col-md-3">
                                    <div class="card bg-gradient-success text-white">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between">
                                                <div>
                                                    <h6 class="text-white-50">Ingresos Totales</h6>
                                                    <h3 class="mb-0">
                                                        {% if totales_acumulativos.IT %}
                                                            Bs. {{ totales_acumulativos.IT.total|floatformat:0|default:"0" }}
                                                        {% else %}
                                                            Bs. 0
                                                        {% endif %}
                                                    </h3>
                                                    {% if totales_acumulativos.IT.trend %}
                                                    <small class="text-white-75">
                                                        Tendencia: {{ totales_acumulativos.IT.trend|capfirst }}
                                                    </small>
                                                    {% endif %}
                                                </div>
                                                <div class="align-self-center">
                                                    <i class="bx bx-dollar display-6"></i>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-gradient-danger text-white">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between">
                                                <div>
                                                    <h6 class="text-white-50">Gastos Totales</h6>
                                                    <h3 class="mb-0">
                                                        {% if totales_acumulativos.TG %}
                                                            Bs. {{ totales_acumulativos.TG.total|floatformat:0|default:"0" }}
                                                        {% else %}
                                                            Bs. 0
                                                        {% endif %}
                                                    </h3>
                                                    {% if totales_acumulativos.TG.trend %}
                                                    <small class="text-white-75">
                                                        Tendencia: {{ totales_acumulativos.TG.trend|capfirst }}
                                                    </small>
                                                    {% endif %}
                                                </div>
                                                <div class="align-self-center">
                                                    <i class="bx bx-trending-down display-6"></i>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-gradient-primary text-white">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between">
                                                <div>
                                                    <h6 class="text-white-50">Ganancia Neta</h6>
                                                    <h3 class="mb-0">
                                                        {% if totales_acumulativos.GT %}
                                                            Bs. {{ totales_acumulativos.GT.total|floatformat:0|default:"0" }}
                                                        {% else %}
                                                            Bs. 0
                                                        {% endif %}
                                                    </h3>
                                                    {% if totales_acumulativos.GT.trend %}
                                                    <small class="text-white-75">
                                                        Tendencia: {{ totales_acumulativos.GT.trend|capfirst }}
                                                    </small>
                                                    {% endif %}
                                                </div>
                                                <div class="align-self-center">
                                                    <i class="bx bx-trending-up display-6"></i>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-gradient-info text-white">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between">
                                                <div>
                                                    <h6 class="text-white-50">Margen Promedio</h6>
                                                    <h3 class="mb-0">
                                                        {% if totales_acumulativos.NR and all_variables_extracted %}
                                                            {% if all_variables_extracted|length > 0 %}
                                                                {% with total_nr=totales_acumulativos.NR.total|default:0 %}
                                                                {% with days_count=all_variables_extracted|length %}
                                                                {% if days_count > 0 %}
                                                                    {% with avg_margin_decimal=total_nr|floatformat:6 %}
                                                                    {% if avg_margin_decimal != "0.000000" %}
                                                                        {% with avg_margin_calc=total_nr|default:0 %}
                                                                        {% with avg_margin_final=avg_margin_calc|default:0 %}
                                                                        {{ avg_margin_final|floatformat:1 }}%
                                                                        {% endwith %}
                                                                        {% endwith %}
                                                                    {% else %}
                                                                        0.0%
                                                                    {% endif %}
                                                                    {% endwith %}
                                                                {% else %}
                                                                    0.0%
                                                                {% endif %}
                                                                {% endwith %}
                                                                {% endwith %}
                                                            {% else %}
                                                                0.0%
                                                            {% endif %}
                                                        {% else %}
                                                            0.0%
                                                        {% endif %}
                                                    </h3>
                                                    {% if totales_acumulativos.NR.trend %}
                                                    <small class="text-white-75">
                                                        Tendencia: {{ totales_acumulativos.NR.trend|capfirst }}
                                                    </small>
                                                    {% endif %}
                                                </div>
                                                <div class="align-self-center">
                                                    <i class="bx bx-percentage display-6"></i>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Gráficos principales -->
                            <div class="row">
                                <!-- Ingresos vs Ganancias -->
                                <div class="col-md-6 mb-4">
                            <div class="chart-container">
                                <!-- TEXTO ARRIBA: Header con título y controles -->
                                <div class="chart-header">
                                    <h6 class="chart-title mb-3">
                                        <i class="bx bx-dollar me-2"></i>
                                        Evolución de Ingresos vs Ganancias
                                    </h6>
                                    <div class="chart-controls">
                                        {% if image_data_ingresos_gastos %}
                                        <div class="chart-control-btn" onclick="downloadChart('{{ image_data_ingresos_gastos }}', 'ingresos-ganancias.png')" title="Descargar">
                                            <i class="bx bx-download"></i>
                                        </div>
                                        <div class="chart-control-btn" onclick="openFullscreen('{{ image_data_ingresos_gastos }}', 'Ingresos vs Ganancias')" title="Pantalla completa">
                                            <i class="bx bx-fullscreen"></i>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>

                                <!-- GRÁFICO EN EL MEDIO: Imagen o placeholder -->
                                <div class="chart-content">
                                    {% if image_data_ingresos_gastos %}
                                    <img src="data:image/png;base64,{{ image_data_ingresos_gastos }}" 
                                        class="chart-image" 
                                        alt="Evolución de Ingresos vs Ganancias"
                                        loading="lazy">
                                    {% else %}
                                    <div class="chart-placeholder">
                                        <i class="bx bx-chart text-muted" style="font-size: 3rem;"></i>
                                        <p class="text-muted mt-2">Gráfico de ingresos vs ganancias no disponible</p>
                                        <small class="text-muted">Los datos se generarán durante el análisis</small>
                                    </div>
                                    {% endif %}
                                </div>

                                <!-- FOOTER ABAJO: Preparado para resumen -->
                                <div class="chart-footer">
                                    <!-- Footer disponible para agregar información de resumen -->
                                </div>
                            </div>
                        </div>
                            <!-- Análisis de Gastos -->
                            <div class="col-md-6 mb-4">
                                <div class="chart-container">
                                    <div class="chart-header">
                                        <h6 class="mb-3">
                                            <i class="bx bx-trending-down me-2"></i>
                                            Composición y Evolución de Gastos
                                        </h6>
                                        <div class="chart-controls">
                                            {% if image_data_gastos %}
                                            <div class="chart-control-btn" onclick="downloadChart('{{ image_data_gastos }}', 'analisis-gastos.png')" title="Descargar">
                                                <i class="bx bx-download"></i>
                                            </div>
                                            <div class="chart-control-btn" onclick="openFullscreen('{{ image_data_gastos }}', 'Análisis de Gastos')" title="Pantalla completa">
                                                <i class="bx bx-fullscreen"></i>
                                            </div>
                                            {% elif image_data_rentabilidad %}
                                            <div class="chart-control-btn" onclick="downloadChart('{{ image_data_rentabilidad }}', 'analisis-rentabilidad.png')" title="Descargar">
                                                <i class="bx bx-download"></i>
                                            </div>
                                            <div class="chart-control-btn" onclick="openFullscreen('{{ image_data_rentabilidad }}', 'Análisis de Rentabilidad')" title="Pantalla completa">
                                                <i class="bx bx-fullscreen"></i>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% if image_data_gastos %}
                                    <img src="data:image/png;base64,{{ image_data_gastos }}" 
                                        class="chart-image" 
                                        alt="Análisis de gastos"
                                        loading="lazy">
                                    {% elif image_data_rentabilidad %}
                                    <img src="data:image/png;base64,{{ image_data_rentabilidad }}" 
                                        class="chart-image" 
                                        alt="Análisis de rentabilidad y gastos"
                                        loading="lazy">
                                    {% else %}
                                    <div class="chart-placeholder">
                                        <i class="bx bx-chart text-muted" style="font-size: 3rem;"></i>
                                        <p class="text-muted mt-2">Gráfico de análisis de gastos no disponible</p>
                                        <small class="text-muted">Los datos se generarán durante el análisis</small>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <!-- Costos de Producción -->
                            <div class="col-md-6 mb-4">
                                <div class="chart-container">
                                    <div class="chart-header">
                                        <h6 class="mb-3">
                                            <i class="bx bx-calculator me-2"></i>
                                            Estructura de Costos de Producción
                                        </h6>
                                        <div class="chart-controls">
                                            {% if cost_distribution_chart %}
                                            <div class="chart-control-btn" onclick="downloadChart('{{ cost_distribution_chart }}', 'distribucion-costos.png')" title="Descargar">
                                                <i class="bx bx-download"></i>
                                            </div>
                                            <div class="chart-control-btn" onclick="openFullscreen('{{ cost_distribution_chart }}', 'Distribución de Costos')" title="Pantalla completa">
                                                <i class="bx bx-fullscreen"></i>
                                            </div>
                                            {% elif image_data_costos %}
                                            <div class="chart-control-btn" onclick="downloadChart('{{ image_data_costos }}', 'costos-produccion.png')" title="Descargar">
                                                <i class="bx bx-download"></i>
                                            </div>
                                            <div class="chart-control-btn" onclick="openFullscreen('{{ image_data_costos }}', 'Costos de Producción')" title="Pantalla completa">
                                                <i class="bx bx-fullscreen"></i>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% if cost_distribution_chart %}
                                    <img src="data:image/png;base64,{{ cost_distribution_chart }}" 
                                        class="chart-image" 
                                        alt="Distribución de costos"
                                        loading="lazy">
                                    {% elif image_data_costos %}
                                    <img src="data:image/png;base64,{{ image_data_costos }}" 
                                        class="chart-image" 
                                        alt="Costos de producción"
                                        loading="lazy">
                                    {% elif image_data_eficiencia %}
                                    <img src="data:image/png;base64,{{ image_data_eficiencia }}" 
                                        class="chart-image" 
                                        alt="Eficiencia y costos"
                                        loading="lazy">
                                    {% else %}
                                    <div class="chart-placeholder">
                                        <i class="bx bx-chart text-muted" style="font-size: 3rem;"></i>
                                        <p class="text-muted mt-2">Gráfico de costos de producción no disponible</p>
                                        <small class="text-muted">Los datos se generarán durante el análisis</small>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Rentabilidad y ROI -->
                            <div class="col-md-6 mb-4">
                                <div class="chart-container">
                                    <div class="chart-header">
                                        <h6 class="mb-3">
                                            <i class="bx bx-stats me-2"></i>
                                            Rentabilidad y ROI
                                        </h6>
                                        <div class="chart-controls">
                                            {% if financial_efficiency_chart %}
                                            <div class="chart-control-btn" onclick="downloadChart('{{ financial_efficiency_chart }}', 'eficiencia-financiera.png')" title="Descargar">
                                                <i class="bx bx-download"></i>
                                            </div>
                                            <div class="chart-control-btn" onclick="openFullscreen('{{ financial_efficiency_chart }}', 'Eficiencia Financiera')" title="Pantalla completa">
                                                <i class="bx bx-fullscreen"></i>
                                            </div>
                                            {% elif image_data_kpis %}
                                            <div class="chart-control-btn" onclick="downloadChart('{{ image_data_kpis }}', 'roi-rentabilidad.png')" title="Descargar">
                                                <i class="bx bx-download"></i>
                                            </div>
                                            <div class="chart-control-btn" onclick="openFullscreen('{{ image_data_kpis }}', 'ROI y Rentabilidad')" title="Pantalla completa">
                                                <i class="bx bx-fullscreen"></i>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% if financial_efficiency_chart %}
                                    <img src="data:image/png;base64,{{ financial_efficiency_chart }}" 
                                        class="chart-image" 
                                        alt="Eficiencia financiera"
                                        loading="lazy">
                                    {% elif image_data_kpis %}
                                    <img src="data:image/png;base64,{{ image_data_kpis }}" 
                                        class="chart-image" 
                                        alt="KPIs financieros"
                                        loading="lazy">
                                    {% elif image_data_rentabilidad %}
                                    <img src="data:image/png;base64,{{ image_data_rentabilidad }}" 
                                        class="chart-image" 
                                        alt="Análisis de rentabilidad"
                                        loading="lazy">
                                    {% else %}
                                    <div class="chart-placeholder">
                                        <i class="bx bx-chart text-muted" style="font-size: 3rem;"></i>
                                        <p class="text-muted mt-2">Gráfico de ROI y rentabilidad no disponible</p>
                                        <small class="text-muted">Los datos se generarán durante el análisis</small>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                                                    <!-- Gráficos de variables financieras endógenas -->
                                                    {% if endogenous_charts %}
                                                    <div class="row mb-4">
                                                        <div class="col-12">
                                                            <h5 class="mb-3">
                                                                <i class="bx bx-line-chart me-2"></i>
                                                                Variables Financieras Endógenas
                                                            </h5>
                                                        </div>
                                                        
                                                        {% for chart_name, chart_data in endogenous_charts.items %}
                                                            {% if 'IT' in chart_name or 'GT' in chart_name or 'TG' in chart_name or 'NR' in chart_name %}
                                                            <div class="col-md-6 mb-4">
                                                                <div class="chart-container">
                                                                    <div class="chart-header">
                                                                        <h6 class="mb-3">
                                                                            {% if 'IT' in chart_name %}
                                                                                <i class="bx bx-dollar text-success me-2"></i>Evolución de Ingresos Totales
                                                                            {% elif 'GT' in chart_name %}
                                                                                <i class="bx bx-trending-up text-primary me-2"></i>Evolución de Ganancia Total
                                                                            {% elif 'TG' in chart_name %}
                                                                                <i class="bx bx-trending-down text-danger me-2"></i>Evolución de Total Gastos
                                                                            {% elif 'NR' in chart_name %}
                                                                                <i class="bx bx-percentage text-info me-2"></i>Evolución del Nivel de Rentabilidad
                                                                            {% endif %}
                                                                        </h6>
                                                                        <div class="chart-controls">
                                                                            <div class="chart-control-btn" onclick="downloadChart('{{ chart_data }}', '{{ chart_name }}.png')" title="Descargar">
                                                                                <i class="bx bx-download"></i>
                                                                            </div>
                                                                            <div class="chart-control-btn" onclick="openFullscreen('{{ chart_data }}', '{{ chart_name }}')" title="Pantalla completa">
                                                                                <i class="bx bx-fullscreen"></i>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                    <img src="data:image/png;base64,{{ chart_data }}" 
                                                                        class="chart-image" 
                                                                        alt="{{ chart_name }}"
                                                                        loading="lazy">
                                                                </div>
                                                            </div>
                                                            {% endif %}
                                                        {% endfor %}
                                                    </div>
                                                    {% endif %}


                                                    <!-- Recomendaciones financieras -->
                                                    {% if financial_recommendations %}
                                                    <div class="row mb-4">
                                                        <div class="col-12">
                                                            <div class="card">
                                                                <div class="card-header">
                                                                    <h5 class="card-title mb-0">
                                                                    <i class="bx bx-lightbulb me-2"></i>
                                                                    Recomendaciones Financieras
                                                                </h5>
                                                            </div>
                                                            <div class="card-body">
                                                                <div class="row">
                                                                    {% for recommendation in financial_recommendations %}
                                                                    <div class="col-md-6 mb-3">
                                                                        <div class="alert alert-{% if recommendation.severity == 'high' %}danger{% elif recommendation.severity == 'medium' %}warning{% else %}info{% endif %} alert-dismissible">
                                                                            <h6 class="alert-heading">
                                                                                {% if recommendation.severity == 'high' %}
                                                                                    <i class="bx bx-error-circle me-2"></i>
                                                                                {% elif recommendation.severity == 'medium' %}
                                                                                    <i class="bx bx-error me-2"></i>
                                                                                {% else %}
                                                                                    <i class="bx bx-info-circle me-2"></i>
                                                                                {% endif %}
                                                                                {{ recommendation.name|default:'Recomendación Financiera' }}
                                                                            </h6>
                                                                            <p class="mb-2">{{ recommendation.description|default:recommendation.recommendation }}</p>
                                                                            {% if recommendation.priority %}
                                                                            <small class="fw-bold">
                                                                                Prioridad: 
                                                                                <span class="badge bg-{% if recommendation.priority == 'high' %}danger{% elif recommendation.priority == 'medium' %}warning{% else %}secondary{% endif %}">
                                                                                    {% if recommendation.priority == 'high' %}Alta
                                                                                    {% elif recommendation.priority == 'medium' %}Media
                                                                                    {% else %}Baja
                                                                                    {% endif %}
                                                                                </span>
                                                                            </small>
                                                                            {% endif %}
                                                                            {% if recommendation.variable %}
                                                                            <br><small class="text-muted">Variable: {{ recommendation.variable }}</small>
                                                                            {% endif %}
                                                                        </div>
                                                                    </div>
                                                                    {% endfor %}
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                {% endif %}

                                                <!-- Estadísticas de demanda financiera si están disponibles -->
                                                {% if demand_stats.historical and demand_stats.simulated %}
                                                <div class="row mb-4">
                                                    <div class="col-12">
                                                        <div class="card">
                                                            <div class="card-header">
                                                                <h5 class="card-title mb-0">
                                                                    <i class="bx bx-stats me-2"></i>
                                                                    Impacto Financiero de la Demanda
                                                                </h5>
                                                            </div>
                                                            <div class="card-body">
                                                                <div class="row">
                                                                    <div class="col-md-4">
                                                                        <div class="text-center p-3 border rounded">
                                                                            <h6 class="text-muted mb-1">Demanda Histórica</h6>
                                                                            <h4 class="mb-0 text-primary">{{ demand_stats.historical.mean|floatformat:1 }} L</h4>
                                                                            <small class="text-muted">Promedio diario</small>
                                                                        </div>
                                                                    </div>
                                                                    <div class="col-md-4">
                                                                        <div class="text-center p-3 border rounded">
                                                                            <h6 class="text-muted mb-1">Demanda Simulada</h6>
                                                                            <h4 class="mb-0 text-success">{{ demand_stats.simulated.mean|floatformat:1 }} L</h4>
                                                                            <small class="text-muted">Promedio proyectado</small>
                                                                        </div>
                                                                    </div>
                                                                    <div class="col-md-4">
                                                                        <div class="text-center p-3 border rounded">
                                                                            <h6 class="text-muted mb-1">Cambio Esperado</h6>
                                                                            <h4 class="mb-0 {% if demand_stats.comparison.mean_diff > 0 %}text-success{% elif demand_stats.comparison.mean_diff < 0 %}text-danger{% else %}text-info{% endif %}">
                                                                                {% if demand_stats.comparison.mean_diff > 0 %}+{% endif %}{{ demand_stats.comparison.mean_diff|floatformat:1 }} L
                                                                            </h4>
                                                                            <small class="text-muted">
                                                                                {% if demand_stats.comparison.mean_diff_pct %}
                                                                                    ({{ demand_stats.comparison.mean_diff_pct|floatformat:1 }}%)
                                                                                {% endif %}
                                                                            </small>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                {% if demand_stats.comparison.correlation %}
                                                                <div class="mt-3 text-center">
                                                                    <p class="mb-0">
                                                                        <strong>Correlación con histórico:</strong> 
                                                                        <span class="{% if demand_stats.comparison.correlation > 0.8 %}text-success{% elif demand_stats.comparison.correlation > 0.6 %}text-warning{% else %}text-danger{% endif %}">
                                                                            {{ demand_stats.comparison.correlation|floatformat:3 }}
                                                                        </span>
                                                                        {% if demand_stats.comparison.mape %}
                                                                        | <strong>Error promedio:</strong> {{ demand_stats.comparison.mape|floatformat:2 }}%
                                                                        {% endif %}
                                                                    </p>
                                                                </div>
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                {% endif %}

                                                <!-- Métricas de validación financiera si están disponibles -->
                                                {% if validation_summary %}
                                                <div class="row mb-4">
                                                    <div class="col-12">
                                                        <div class="card">
                                                            <div class="card-header">
                                                                <h5 class="card-title mb-0">
                                                                    <i class="bx bx-shield-quarter me-2"></i>
                                                                    Validación del Modelo Financiero
                                                                </h5>
                                                            </div>
                                                            <div class="card-body">
                                                                <div class="row">
                                                                    {% if validation_summary.success_rate %}
                                                                    <div class="col-md-3">
                                                                        <div class="text-center p-3 border rounded">
                                                                            <h6 class="text-muted mb-1">Tasa de Éxito</h6>
                                                                            <h4 class="mb-0 {% if validation_summary.success_rate >= 80 %}text-success{% elif validation_summary.success_rate >= 60 %}text-warning{% else %}text-danger{% endif %}">
                                                                                {{ validation_summary.success_rate|floatformat:1 }}%
                                                                            </h4>
                                                                            <small class="text-muted">Validación general</small>
                                                                        </div>
                                                                    </div>
                                                                    {% endif %}
                                                                    {% if validation_summary.avg_mape %}
                                                                    <div class="col-md-3">
                                                                        <div class="text-center p-3 border rounded">
                                                                            <h6 class="text-muted mb-1">MAPE</h6>
                                                                            <h4 class="mb-0 {% if validation_summary.avg_mape < 10 %}text-success{% elif validation_summary.avg_mape < 20 %}text-warning{% else %}text-danger{% endif %}">
                                                                                {{ validation_summary.avg_mape|floatformat:2 }}%
                                                                            </h4>
                                                                            <small class="text-muted">Error promedio</small>
                                                                        </div>
                                                                    </div>
                                                                    {% endif %}
                                                                    {% if validation_summary.precise_count %}
                                                                    <div class="col-md-3">
                                                                        <div class="text-center p-3 border rounded">
                                                                            <h6 class="text-muted mb-1">Predicciones Precisas</h6>
                                                                            <h4 class="mb-0 text-success">{{ validation_summary.precise_count }}</h4>
                                                                            <small class="text-muted">Error &lt; 10%</small>
                                                                        </div>
                                                                    </div>
                                                                    {% endif %}
                                                                    {% if validation_summary.inaccurate_count %}
                                                                    <div class="col-md-3">
                                                                        <div class="text-center p-3 border rounded">
                                                                            <h6 class="text-muted mb-1">Predicciones Inexactas</h6>
                                                                            <h4 class="mb-0 text-danger">{{ validation_summary.inaccurate_count }}</h4>
                                                                            <small class="text-muted">Error &gt; 20%</small>
                                                                        </div>
                                                                    </div>
                                                                    {% endif %}
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                {% endif %}

                                                <!-- Análisis comparativo con simulaciones anteriores si existe -->
                                                {% if comparison_chart %}
                                                <div class="row mb-4">
                                                    <div class="col-12">
                                                        <div class="card">
                                                            <div class="card-header">
                                                                <h5 class="card-title mb-0">
                                                                    <i class="bx bx-git-compare me-2"></i>
                                                                    Comparación con Datos Históricos
                                                                </h5>
                                                            </div>
                                                            <div class="card-body">
                                                                <div class="chart-container">
                                                                    <img src="data:image/png;base64,{{ comparison_chart }}" 
                                                                        class="chart-image" 
                                                                        alt="Comparación de demanda histórica vs simulada"
                                                                        loading="lazy">
                                                                </div>
                                                                <div class="mt-3">
                                                                    <p class="text-muted mb-0">
                                                                        Este gráfico muestra la comparación entre la demanda histórica real y la demanda simulada por el modelo, 
                                                                        permitiendo evaluar la precisión de las proyecciones financieras.
                                                                    </p>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                {% endif %}

                            </div>
                            <!-- Operations Tab -->
                            <div class="tab-pane fade" id="operations" role="tabpanel">         
                                <!-- Header operativo -->
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <div class="alert alert-info">
                                            <h4 class="alert-heading mb-3">
                                                <i class="bx bx-cog me-2"></i>
                                                Análisis Operativo Integral
                                            </h4>
                                            <p class="mb-2">
                                                Análisis completo de la eficiencia operativa, costos de producción y métricas clave 
                                                durante {{ all_variables_extracted|length|default:0 }} días de simulación.
                                            </p>
                                            <div class="row mt-3">
                                                <div class="col-md-3">
                                                    <strong>Productos Vendidos:</strong> 
                                                    <span class="text-primary">
                                                        {% if totales_acumulativos.TPV %}
                                                            {{ totales_acumulativos.TPV.total|floatformat:0 }}
                                                        {% else %}
                                                            0
                                                        {% endif %} unidades
                                                    </span>
                                                </div>
                                                <div class="col-md-3">
                                                    <strong>Eficiencia Promedio:</strong> 
                                                    {% if totales_acumulativos.EOG and all_variables_extracted|length > 0 %}
                                                        <span class="text-success">{{ totales_acumulativos.EOG.total|floatformat:1 }}%</span>
                                                    {% else %}
                                                        <span class="text-muted">Calculando...</span>
                                                    {% endif %}
                                                </div>
                                                <div class="col-md-3">
                                                    <strong>Personal:</strong>
                                                    {% if totales_acumulativos.NEPP %}
                                                        <span class="text-info">{{ totales_acumulativos.NEPP.total|floatformat:0 }} empleados</span>
                                                    {% else %}
                                                        <span class="text-muted">N/A</span>
                                                    {% endif %}
                                                </div>
                                                <div class="col-md-3">
                                                    <strong>Días Analizados:</strong>
                                                    <span class="text-warning">{{ all_variables_extracted|length|default:0 }}</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Métricas operativas principales -->
                                <div class="row mb-4">
                                    <div class="col-md-3">
                                        <div class="card bg-gradient-primary text-white">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between">
                                                    <div>
                                                        <h6 class="text-white-50">Productos Vendidos</h6>
                                                        <h3 class="mb-0">
                                                            {% if totales_acumulativos.TPV %}
                                                                {{ totales_acumulativos.TPV.total|floatformat:0 }}
                                                            {% else %}
                                                                0
                                                            {% endif %}
                                                        </h3>
                                                        <small class="text-white-75">Total del período</small>
                                                    </div>
                                                    <div class="align-self-center">
                                                        <i class="bx bx-package display-6"></i>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-3">
                                        <div class="card bg-gradient-success text-white">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between">
                                                    <div>
                                                        <h6 class="text-white-50">Eficiencia Operativa</h6>
                                                        <h3 class="mb-0">
                                                            {% if totales_acumulativos.EOG %}
                                                                {{ totales_acumulativos.EOG.total|floatformat:1 }}%
                                                            {% else %}
                                                                0.0%
                                                            {% endif %}
                                                        </h3>
                                                        <small class="text-white-75">Promedio general</small>
                                                    </div>
                                                    <div class="align-self-center">
                                                        <i class="bx bx-tachometer display-6"></i>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-3">
                                        <div class="card bg-gradient-warning text-white">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between">
                                                    <div>
                                                        <h6 class="text-white-50">Capacidad Total</h6>
                                                        <h3 class="mb-0">
                                                            {% if totales_acumulativos.CPROD %}
                                                                {{ totales_acumulativos.CPROD.total|floatformat:0 }}
                                                            {% else %}
                                                                N/A
                                                            {% endif %}
                                                        </h3>
                                                        <small class="text-white-75">Litros/período</small>
                                                    </div>
                                                    <div class="align-self-center">
                                                        <i class="bx bx-bar-chart display-6"></i>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-3">
                                        <div class="card bg-gradient-danger text-white">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between">
                                                    <div>
                                                        <h6 class="text-white-50">Costo Variable Unit.</h6>
                                                        <h3 class="mb-0">
                                                            {% if totales_acumulativos.CVU %}
                                                                Bs. {{ totales_acumulativos.CVU.total|floatformat:2 }}
                                                            {% else %}
                                                                Bs. 0.00
                                                            {% endif %}
                                                        </h3>
                                                        <small class="text-white-75">Promedio</small>
                                                    </div>
                                                    <div class="align-self-center">
                                                        <i class="bx bx-calculator display-6"></i>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Gráficos operativos principales -->
                                <div class="row mb-4">
                                    <!-- Gráfico de Eficiencia Operativa -->
                                    <div class="col-lg-6 mb-4">
                                        <div class="chart-container">
                                            <div class="chart-header">
                                                <h6 class="chart-title mb-3">
                                                    <i class="bx bx-tachometer me-2"></i>
                                                    Indicadores de Eficiencia Operativa
                                                </h6>
                                                <div class="chart-controls">
                                                    {% if image_data_eficiencia %}
                                                    <div class="chart-control-btn" onclick="downloadChart('{{ image_data_eficiencia }}', 'eficiencia-operativa.png')" title="Descargar">
                                                        <i class="bx bx-download"></i>
                                                    </div>
                                                    <div class="chart-control-btn" onclick="openFullscreen('{{ image_data_eficiencia }}', 'Eficiencia Operativa')" title="Pantalla completa">
                                                        <i class="bx bx-fullscreen"></i>
                                                    </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            {% if image_data_eficiencia %}
                                            <img src="data:image/png;base64,{{ image_data_eficiencia }}" 
                                                class="chart-image" 
                                                alt="Indicadores de Eficiencia Operativa"
                                                loading="lazy">
                                            {% else %}
                                            <div class="chart-placeholder">
                                                <i class="bx bx-tachometer text-muted" style="font-size: 3rem;"></i>
                                                <p class="text-muted mt-2">Indicadores de eficiencia</p>
                                                <small class="text-muted">Métricas de rendimiento operativo</small>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>

                                <!-- Gráficos de variables operativas endógenas -->
                                {% if endogenous_charts %}
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <h5 class="mb-3">
                                            <i class="bx bx-cog me-2"></i>
                                            Variables Operativas Endógenas
                                        </h5>
                                    </div>
                                    
                                    {% for chart_name, chart_data in endogenous_charts.items %}
                                        {% if 'TPV' in chart_name or 'EOG' in chart_name or 'CPROD' in chart_name or 'NEPP' in chart_name %}
                                        <div class="col-lg-6 mb-4">
                                            <div class="chart-container">
                                                <div class="chart-header">
                                                    <h6 class="chart-title mb-3">
                                                        {% if 'TPV' in chart_name %}
                                                            <i class="bx bx-package text-primary me-2"></i>Total Productos Vendidos
                                                        {% elif 'EOG' in chart_name %}
                                                            <i class="bx bx-tachometer text-success me-2"></i>Eficiencia Operativa
                                                        {% elif 'CPROD' in chart_name %}
                                                            <i class="bx bx-factory text-info me-2"></i>Capacidad de Producción
                                                        {% elif 'NEPP' in chart_name %}
                                                            <i class="bx bx-group text-warning me-2"></i>Personal en Producción
                                                        {% endif %}
                                                    </h6>
                                                    <div class="chart-controls">
                                                        <div class="chart-control-btn" onclick="downloadChart('{{ chart_data }}', '{{ chart_name }}.png')" title="Descargar">
                                                            <i class="bx bx-download"></i>
                                                        </div>
                                                        <div class="chart-control-btn" onclick="openFullscreen('{{ chart_data }}', '{{ chart_name }}')" title="Pantalla completa">
                                                            <i class="bx bx-fullscreen"></i>
                                                        </div>
                                                    </div>
                                                </div>
                                                <img src="data:image/png;base64,{{ chart_data }}" 
                                                    class="chart-image" 
                                                    alt="{{ chart_name }}"
                                                    loading="lazy">
                                            </div>
                                        </div>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                                {% endif %}

                                <!-- Tabla resumen operativo -->
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <div class="card">
                                            <div class="card-header">
                                                <h5 class="card-title mb-0">
                                                    <i class="bx bx-table me-2"></i>
                                                    Resumen Operativo por Variable
                                                </h5>
                                            </div>
                                            <div class="card-body">
                                                <div class="table-responsive">
                                                    <table class="table table-hover">
                                                        <thead>
                                                            <tr>
                                                                <th>Variable Operativa</th>
                                                                <th>Promedio Diario</th>
                                                                <th>Unidad</th>
                                                                <th>Valor Total</th>
                                                                <th>Tendencia</th>
                                                                <th>Estado</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {% for name_variable, info_variable in totales_acumulativos.items %}
                                                                {% if 'TPV' in name_variable or 'EOG' in name_variable or 'CPROD' in name_variable or 'NEPP' in name_variable or 'CFD' in name_variable or 'CVU' in name_variable %}
                                                                <tr>
                                                                    <td>
                                                                        <strong>
                                                                            {% if name_variable == 'TPV' %}Total Productos Vendidos
                                                                            {% elif name_variable == 'EOG' %}Eficiencia Operativa General
                                                                            {% elif name_variable == 'CPROD' %}Capacidad de Producción
                                                                            {% elif name_variable == 'NEPP' %}Empleados en Producción
                                                                            {% elif name_variable == 'CFD' %}Costo Fijo Diario
                                                                            {% elif name_variable == 'CVU' %}Costo Variable Unitario
                                                                            {% else %}{{ name_variable }}
                                                                            {% endif %}
                                                                        </strong>
                                                                        <br>
                                                                        <small class="text-muted">{{ name_variable }}</small>
                                                                    </td>
                                                                    <td class="fw-bold">
                                                                        {% if info_variable.unit == "BS" %}
                                                                            <span class="text-warning">Bs. {{ info_variable.total|floatformat:2 }}</span>
                                                                        {% elif info_variable.unit == "L" %}
                                                                            <span class="text-primary">{{ info_variable.total|floatformat:0 }} L</span>
                                                                        {% elif "%" in info_variable.unit %}
                                                                            <span class="text-info">{{ info_variable.total|floatformat:3 }}</span>
                                                                        {% else %}
                                                                            {{ info_variable.total|floatformat:2 }}
                                                                        {% endif %}
                                                                    </td>
                                                                    <td>
                                                                        <span class="badge bg-light text-dark">
                                                                            {% if info_variable.unit == "BS" %}Bolivianos
                                                                            {% elif info_variable.unit == "L" %}Litros
                                                                            {% elif info_variable.unit == "%" %}Porcentaje
                                                                            {% elif "Personas" in info_variable.unit %}Empleados
                                                                            {% else %}{{ info_variable.unit }}
                                                                            {% endif %}
                                                                        </span>
                                                                    </td>
                                                                    <td>
                                                                        {% if all_variables_extracted|length > 0 %}
                                                                            {% widthratio info_variable.total 1 all_variables_extracted|length as daily_avg %}
                                                                            {% if info_variable.unit == "BS" %}
                                                                                Bs. {{ daily_avg|floatformat:2 }}
                                                                            {% elif info_variable.unit == "L" %}
                                                                                {{ daily_avg|floatformat:1 }} L
                                                                            {% elif "%" in info_variable.unit %}
                                                                                {{ daily_avg|floatformat:3 }}
                                                                            {% else %}
                                                                                {{ daily_avg|floatformat:2 }}
                                                                            {% endif %}
                                                                        {% else %}
                                                                            N/A
                                                                        {% endif %}
                                                                    </td>
                                                                    <td>
                                                                        {% if info_variable.trend == "increasing" %}
                                                                            <span class="badge bg-success">
                                                                                <i class="bx bx-trending-up me-1"></i>Creciente
                                                                            </span>
                                                                        {% elif info_variable.trend == "decreasing" %}
                                                                            <span class="badge bg-danger">
                                                                                <i class="bx bx-trending-down me-1"></i>Decreciente
                                                                            </span>
                                                                        {% else %}
                                                                            <span class="badge bg-secondary">
                                                                                <i class="bx bx-minus me-1"></i>Estable
                                                                            </span>
                                                                        {% endif %}
                                                                    </td>
                                                                    <td>
                                                                        {% if name_variable == 'EOG' %}
                                                                            {% if info_variable.total > 80 %}
                                                                                <span class="badge bg-success">Excelente</span>
                                                                            {% elif info_variable.total > 60 %}
                                                                                <span class="badge bg-warning">Bueno</span>
                                                                            {% else %}
                                                                                <span class="badge bg-danger">Bajo</span>
                                                                            {% endif %}
                                                                        {% elif name_variable == 'TPV' %}
                                                                            {% if info_variable.trend == "increasing" %}
                                                                                <span class="badge bg-success">Creciendo</span>
                                                                            {% elif info_variable.trend == "decreasing" %}
                                                                                <span class="badge bg-warning">Decreciendo</span>
                                                                            {% else %}
                                                                                <span class="badge bg-info">Estable</span>
                                                                            {% endif %}
                                                                        {% else %}
                                                                            <span class="badge bg-info">Normal</span>
                                                                        {% endif %}
                                                                    </td>
                                                                </tr>
                                                                {% endif %}
                                                            {% empty %}
                                                            <tr>
                                                                <td colspan="6" class="text-center py-4">
                                                                    <i class="bx bx-info-circle display-4 text-muted"></i>
                                                                    <h6 class="mt-2 text-muted">No hay datos operativos disponibles</h6>
                                                                    <small class="text-muted">Los datos se generarán durante el procesamiento.</small>
                                                                </td>
                                                            </tr>
                                                            {% endfor %}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Endogenous Variables Tab -->
                            <div class="tab-pane fade" id="endogenous" role="tabpanel">
                                
                                <!-- Título Principal -->
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <div class="alert alert-primary">
                                            <h4 class="alert-heading mb-3">
                                                <i class="bx bx-trending-up me-2"></i>
                                                Variables Endógenas del Modelo
                                            </h4>
                                            <p class="mb-2">
                                                Las variables endógenas son aquellas que se determinan dentro del modelo de simulación 
                                                basándose en las relaciones matemáticas establecidas y las variables exógenas.
                                            </p>
                                            <small class="text-muted">
                                                Total de variables endógenas procesadas: <strong>{{ totales_acumulativos|length|default:0 }}</strong> | 
                                                Período de simulación: <strong>{{ all_variables_extracted|length|default:0 }} días</strong>
                                            </small>
                                        </div>
                                    </div>
                                </div>

                                <!-- Métricas Resumen -->
                                <div class="row mb-4" id="endogenousMetrics">
                                    <div class="col-md-3">
                                        <div class="card bg-gradient-primary text-white">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between">
                                                    <div>
                                                        <h6 class="text-white-50">Variables Totales</h6>
                                                        <h3 class="mb-0" id="totalVarsCount">{{ totales_acumulativos|length|default:0 }}</h3>
                                                    </div>
                                                    <div class="align-self-center">
                                                        <i class="bx bx-list-ul display-6"></i>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Gráficos de Variables Endógenas -->
                                {% if endogenous_charts or chart_images %}
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <div class="card">
                                            <div class="card-header">
                                                <h5 class="card-title mb-0">
                                                    <i class="bx bx-bar-chart me-2"></i>
                                                    Gráficos de Variables Endógenas
                                                </h5>
                                            </div>
                                            <div class="card-body">
                                                <div class="row g-3">
                                                    <!-- Gráficos endógenos específicos -->
                                                    {% for chart_name, chart_data in endogenous_charts.items %}
                                                    <div class="col-lg-6">
                                                        <div class="card chart-card">
                                                            <div class="card-header">
                                                                <h6 class="card-title mb-0">
                                                                    {% if 'IT' in chart_name %}
                                                                        <i class="bx bx-dollar text-success me-2"></i>Ingresos Totales
                                                                    {% elif 'GT' in chart_name %}
                                                                        <i class="bx bx-trending-up text-info me-2"></i>Ganancia Total
                                                                    {% elif 'TG' in chart_name %}
                                                                        <i class="bx bx-receipt text-danger me-2"></i>Total Gastos
                                                                    {% elif 'TPV' in chart_name %}
                                                                        <i class="bx bx-box text-primary me-2"></i>Total Productos Vendidos
                                                                    {% elif 'NSC' in chart_name %}
                                                                        <i class="bx bx-star text-warning me-2"></i>Satisfacción del Cliente
                                                                    {% elif 'EOG' in chart_name %}
                                                                        <i class="bx bx-cog text-secondary me-2"></i>Eficiencia Operativa
                                                                    {% else %}
                                                                        <i class="bx bx-stats me-2"></i>{{ chart_name }}
                                                                    {% endif %}
                                                                </h6>
                                                            </div>
                                                            <div class="card-body">
                                                                <div class="chart-container">
                                                                    {% if chart_data %}
                                                                        <img src="data:image/png;base64,{{ chart_data }}" 
                                                                            class="img-fluid chart-image" 
                                                                            alt="Gráfico {{ chart_name }}"
                                                                            onclick="expandChart('{{ chart_name }}', this.src)">
                                                                    {% else %}
                                                                        <div class="chart-placeholder">
                                                                            <i class="bx bx-bar-chart display-4 text-muted"></i>
                                                                            <p class="text-muted">Gráfico no disponible</p>
                                                                        </div>
                                                                    {% endif %}
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    {% endfor %}

                                                    <!-- Gráficos adicionales del análisis -->
                                                    {% for chart_key, chart_data in chart_images.items %}
                                                        {% if 'endogenous' in chart_key or 'variables' in chart_key %}
                                                        <div class="col-lg-6">
                                                            <div class="card chart-card">
                                                                <div class="card-header">
                                                                    <h6 class="card-title mb-0">
                                                                        <i class="bx bx-line-chart me-2"></i>
                                                                        {% if 'trend' in chart_key %}
                                                                            Tendencias de Variables
                                                                        {% elif 'correlation' in chart_key %}
                                                                            Correlaciones
                                                                        {% elif 'distribution' in chart_key %}
                                                                            Distribuciones
                                                                        {% else %}
                                                                            {{ chart_key|title }}
                                                                        {% endif %}
                                                                    </h6>
                                                                </div>
                                                                <div class="card-body">
                                                                    <div class="chart-container">
                                                                        <img src="data:image/png;base64,{{ chart_data }}" 
                                                                            class="img-fluid chart-image" 
                                                                            alt="Gráfico {{ chart_key }}"
                                                                            onclick="expandChart('{{ chart_key }}', this.src)">
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        {% endif %}
                                                    {% endfor %}

                                                    <!-- Mensaje si no hay gráficos -->
                                                    {% if not endogenous_charts and not chart_images %}
                                                    <div class="col-12">
                                                        <div class="text-center py-5">
                                                            <i class="bx bx-bar-chart display-1 text-muted"></i>
                                                            <h5 class="mt-3 text-muted">No hay gráficos disponibles</h5>
                                                            <p class="text-muted">Los gráficos de variables endógenas se generarán durante el análisis.</p>
                                                        </div>
                                                    </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}

                                <!-- Tabla Resumen de Variables Endógenas -->
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <div class="data-table-container">
                                            <div class="card-header">
                                                <h5 class="card-title mb-0">
                                                    <i class="bx bx-list-ul me-2"></i>
                                                    Resumen Completo de Variables Endógenas
                                                </h5>
                                            </div>
                                            <div class="card-body">
                                                <div class="table-responsive">
                                                    <table class="table table-hover" id="endogenousTable">
                                                        <thead>
                                                            <tr>
                                                                <th style="width: 25%">Variable</th>
                                                                <th style="width: 15%">Promedio Diario</th>
                                                                <th style="width: 12%">Unidad</th>
                                                                <th style="width: 15%">Valor Total</th>
                                                                <th style="width: 10%">Tendencia</th>
                                                                <th style="width: 13%">Rango</th>
                                                                <th style="width: 10%">Acciones</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody id="endogenousTableBody">
                                                            {% for name_variable, info_variable in totales_acumulativos.items %}
                                                            <tr data-variable="{{ name_variable }}" 
                                                                data-category="{% if 'IT' in name_variable or 'GT' in name_variable or 'TG' in name_variable or 'NR' in name_variable %}financial{% elif 'NSC' in name_variable or 'EOG' in name_variable %}quality{% else %}operational{% endif %}"
                                                                data-trend="{{ info_variable.trend|default:'stable' }}">
                                                                <td>
                                                                    <div class="variable-info">
                                                                        <strong>{{ name_variable }}</strong>
                                                                        <br>
                                                                        <small class="text-muted">
                                                                            {% if "IT" in name_variable %}
                                                                                <i class="bx bx-dollar text-success"></i> Ingresos totales del período
                                                                            {% elif "GT" in name_variable %}
                                                                                <i class="bx bx-trending-up text-info"></i> Ganancia acumulada
                                                                            {% elif "TG" in name_variable %}
                                                                                <i class="bx bx-receipt text-danger"></i> Gastos totales
                                                                            {% elif "TPV" in name_variable %}
                                                                                <i class="bx bx-box text-primary"></i> Productos vendidos
                                                                            {% elif "NSC" in name_variable %}
                                                                                <i class="bx bx-star text-warning"></i> Satisfacción del cliente
                                                                            {% elif "EOG" in name_variable %}
                                                                                <i class="bx bx-cog text-secondary"></i> Eficiencia operativa
                                                                            {% elif "NR" in name_variable %}
                                                                                <i class="bx bx-percentage text-info"></i> Nivel de rentabilidad
                                                                            {% else %}
                                                                                <i class="bx bx-stats text-secondary"></i> Variable del modelo
                                                                            {% endif %}
                                                                        </small>
                                                                    </div>
                                                                </td>
                                                                <td class="fw-bold variable-total">
                                                                    {% if info_variable.unit == "BS" %}
                                                                        <span class="text-success">Bs. {{ info_variable.total|floatformat:2 }}</span>
                                                                    {% elif "%" in info_variable.unit %}
                                                                        <span class="text-info">{{ info_variable.total|floatformat:3 }}</span>
                                                                    {% else %}
                                                                        {{ info_variable.total|floatformat:2 }}
                                                                    {% endif %}
                                                                </td>
                                                                <td class="variable-unit">
                                                                    <span class="badge bg-light text-dark">
                                                                        {% if info_variable.unit == "BS" %}Bolivianos
                                                                        {% elif info_variable.unit == "L" %}Litros
                                                                        {% elif info_variable.unit == "CLIENTES" %}Clientes
                                                                        {% elif info_variable.unit == "%" %}Porcentaje
                                                                        {% elif info_variable.unit == "Horas" %}Horas
                                                                        {% elif info_variable.unit == "L/BS" %}L/Bs.
                                                                        {% elif info_variable.unit == "[0.1,0.3,0.5]" %}Factor
                                                                        {% else %}{{ info_variable.unit }}
                                                                        {% endif %}
                                                                    </span>
                                                                </td>
                                                                <td class="variable-average">
                                                                    {% if all_variables_extracted|length > 0 %}
                                                                        {% widthratio info_variable.total 1 all_variables_extracted|length as daily_average %}
                                                                        {% if info_variable.unit == "BS" %}
                                                                            Bs. {{ daily_average|floatformat:2 }}
                                                                        {% elif "%" in info_variable.unit %}
                                                                            {{ daily_average|floatformat:3 }}
                                                                        {% else %}
                                                                            {{ daily_average|floatformat:2 }}
                                                                        {% endif %}
                                                                    {% else %}
                                                                        N/A
                                                                    {% endif %}
                                                                </td>
                                                                <td class="variable-trend">
                                                                    {% if info_variable.trend == "increasing" %}
                                                                        <span class="badge bg-success">
                                                                            <i class="bx bx-trending-up me-1"></i>Creciente
                                                                        </span>
                                                                    {% elif info_variable.trend == "decreasing" %}
                                                                        <span class="badge bg-danger">
                                                                            <i class="bx bx-trending-down me-1"></i>Decreciente
                                                                        </span>
                                                                    {% else %}
                                                                        <span class="badge bg-secondary">
                                                                            <i class="bx bx-minus me-1"></i>Estable
                                                                        </span>
                                                                    {% endif %}
                                                                </td>
                                                                <td class="variable-range">
                                                                    {% if info_variable.min_value and info_variable.max_value %}
                                                                        <small class="text-muted">
                                                                            {{ info_variable.min_value|floatformat:1 }} - {{ info_variable.max_value|floatformat:1 }}
                                                                        </small>
                                                                    {% else %}
                                                                        <small class="text-muted">N/A</small>
                                                                    {% endif %}
                                                                </td>
                                                                <td class="variable-actions">
                                                                    <div class="btn-group" role="group">
                                                                        <button type="button" class="btn btn-sm btn-outline-primary" 
                                                                                onclick="showVariableDetails('{{ name_variable }}')"
                                                                                title="Ver detalles">
                                                                            <i class="bx bx-info-circle"></i>
                                                                        </button>
                                                                    </div>
                                                                </td>
                                                            </tr>
                                                            {% empty %}
                                                            <tr>
                                                                <td colspan="7" class="text-center py-4">
                                                                    <i class="bx bx-info-circle display-4 text-muted"></i>
                                                                    <h5 class="mt-3 text-muted">No hay variables endógenas disponibles</h5>
                                                                    <p class="text-muted">Las variables se generarán durante el procesamiento de la simulación.</p>
                                                                </td>
                                                            </tr>
                                                            {% endfor %}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Modal para expandir gráficos -->
                                <div class="modal fade" id="chartModal" tabindex="-1">
                                    <div class="modal-dialog modal-xl">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="chartModalTitle">Gráfico de Variable</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                            </div>
                                            <div class="modal-body text-center">
                                                <img id="chartModalImage" src="" class="img-fluid" alt="Gráfico expandido">
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Modal para detalles de variable -->
                                <div class="modal fade" id="variableDetailsModal" tabindex="-1">
                                    <div class="modal-dialog modal-lg">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="variableDetailsTitle">Detalles de Variable</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                            </div>
                                            <div class="modal-body" id="variableDetailsBody">
                                                <!-- Contenido dinámico -->
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                            </div>
                            <!-- Demand Tab -->
                            <div class="tab-pane fade" id="demand" role="tabpanel">
                                <div class="row">
                                    <div class="col-md-6">
                                        <!-- Demand Table -->
                                        <div class="data-table-container">
                                            <div class="card-header">
                                                <h5 class="card-title mb-0">
                                                    <i class="bx bx-table me-2"></i>
                                                    Tabla de Demanda Diaria
                                                </h5>
                                            </div>
                                            <div class="card-body">
                                                <div class="table-responsive" style="max-height: 400px;">
                                                    <table class="table table-striped" id="demandTable">
                                                        <thead>
                                                            <tr>
                                                                <th>Día</th>
                                                                <th>Fecha</th>
                                                                <th>Demanda (L)</th>
                                                                <th>Desviación (%)</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {% for simulate in results %}
                                                            <tr>
                                                                <td>{{ forloop.counter }}</td>
                                                                <td>{{ simulate.date|date:"d/m/Y" }}</td>
                                                                <td class="fw-bold">{{ simulate.demand_mean|floatformat:"2" }}</td>
                                                                <td>
                                                                    <span class="badge bg-info">
                                                                        {{ simulate.demand_std_deviation|floatformat:"2" }}%
                                                                    </span>
                                                                </td>
                                                            </tr>
                                                            {% endfor %}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                            <div class="pagination-controls">
                                                <button type="button" class="btn btn-sm btn-outline-primary btn-pagination" id="prevTablePage">
                                                    <i class="bx bx-chevron-left me-1"></i>Anterior
                                                </button>
                                                <span class="flex-grow-1 text-center small text-muted" id="tablePageInfo">
                                                    Página 1
                                                </span>
                                                <button type="button" class="btn btn-sm btn-outline-primary btn-pagination" id="nextTablePage">
                                                    Siguiente<i class="bx bx-chevron-right ms-1"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="chart-container">
                                            <h6 class="mb-3">
                                                <i class="bx bx-line-chart-down me-2"></i>
                                                Análisis de Demanda con Tendencias
                                            </h6>
                                            {% if image_data_simulation %}
                                            <img src="data:image/png;base64,{{ image_data_simulation }}" 
                                                    class="chart-image" 
                                                    alt="Análisis de demanda"
                                                    loading="lazy">
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% if comparison_chart %}
                                    <div class="col-12 mb-4">
                                        <div class="chart-container">
                                            <h6 class="mb-3">
                                                <i class="bx bx-git-compare me-2"></i>
                                                Comparación: Demanda Histórica vs Simulada
                                            </h6>
                                            <div class="chart-controls">
                                                <div class="chart-control-btn" onclick="downloadChart('{{ comparison_chart }}', 'comparacion-demanda.png')" title="Descargar">
                                                    <i class="bx bx-download"></i>
                                                </div>
                                                <div class="chart-control-btn" onclick="openFullscreen('{{ comparison_chart }}', 'Comparación de Demanda')" title="Pantalla completa">
                                                    <i class="bx bx-fullscreen"></i>
                                                </div>
                                            </div>
                                            <img src="data:image/png;base64,{{ comparison_chart }}" 
                                                class="chart-image" 
                                                alt="Comparación de Demanda Histórica vs Simulada"
                                                loading="lazy">
                                        </div>
                                    </div>
                                    {% endif %}
                                    <!-- Three-Line Validation Chart Section -->
                                    {% if has_three_line_chart %}
                                    <div class="row mb-4">
                                        <div class="col-12">
                                            <div class="card shadow-sm">
                                                <div class="card-header bg-success text-white">
                                                    <h4 class="mb-0">
                                                        <i class="fas fa-check-circle"></i> Validación del Modelo: Comparación de Tres Líneas
                                                    </h4>
                                                </div>
                                                <div class="card-body">
                                                    <div class="row">
                                                        <div class="col-lg-9">
                                                            {% if three_line_validation_chart %}
                                                                <img src="data:image/png;base64,{{ three_line_validation_chart }}" 
                                                                    class="img-fluid rounded shadow" 
                                                                    alt="Gráfico de Validación de Tres Líneas">
                                                            {% endif %}
                                                        </div>
                                                        <div class="col-lg-3">
                                                            <div class="validation-metrics">
                                                                <h5>Métricas de Validación</h5>
                                                                
                                                                {% if three_line_validation_metrics.historical_vs_simulated %}
                                                                <div class="metric-card mb-3 p-3 bg-light rounded">
                                                                    <h6 class="text-muted">Histórico vs Simulado</h6>
                                                                    <p class="mb-1">RMSE: <strong>{{ three_line_validation_metrics.historical_vs_simulated.rmse|floatformat:2 }}</strong></p>
                                                                </div>
                                                                {% endif %}
                                                                
                                                                {% if three_line_validation_metrics.simulated_vs_projected %}
                                                                <div class="metric-card mb-3 p-3 bg-light rounded">
                                                                    <h6 class="text-muted">Simulado vs Proyectado</h6>
                                                                    <p class="mb-1">MAPE: <strong>{{ three_line_validation_metrics.simulated_vs_projected.mape }}%</strong></p>
                                                                    <p class="mb-0">Alineación: <strong>{{ three_line_validation_metrics.simulated_vs_projected.alignment }}</strong></p>
                                                                </div>
                                                                {% endif %}
                                                                
                                                                {% if three_line_validation_metrics.overall_validation %}
                                                                <div class="metric-card p-3 bg-primary text-white rounded">
                                                                    <h6>Validación General</h6>
                                                                    <h3 class="mb-1">{{ three_line_validation_metrics.overall_validation.score|floatformat:1 }}%</h3>
                                                                    <p class="mb-0">{{ three_line_validation_metrics.overall_validation.status }}</p>
                                                                </div>
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                    </div>
                                                    
                                                    <div class="mt-3 p-3 bg-light rounded">
                                                        <h6>Interpretación del Gráfico:</h6>
                                                        <ul class="mb-0">
                                                            <li><span style="color: blue; font-weight: bold;">Línea Azul</span>: Demanda Real Histórica</li>
                                                            <li><span style="color: red; font-weight: bold;">Línea Roja</span>: Demanda Proyectada (tendencia futura)</li>
                                                            <li><span style="color: green; font-weight: bold;">Línea Verde (punteada)</span>: Demanda Simulada (validación del modelo)</li>
                                                        </ul>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            <!-- Statistical Analysis Tab -->
                            <div class="tab-pane fade" id="analysis" role="tabpanel">
                                
                                <!-- Header del análisis estadístico -->
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <div class="analysis-header">
                                            <h2 class="analysis-title">
                                                <i class="bx bx-math me-3"></i>
                                                Análisis Estadístico Avanzado
                                            </h2>
                                            <p class="analysis-subtitle">
                                                Evaluación estadística completa del modelo de simulación, comparación de distribuciones, 
                                                métricas de desempeño y validación de precisión predictiva.
                                            </p>
                                            <div class="analysis-badges">
                                                <span class="badge bg-primary">
                                                    <i class="bx bx-data me-1"></i>
                                                    {{ all_variables_extracted|length|default:0 }} días analizados
                                                </span>
                                                {% if simulation_instance.fk_fdp %}
                                                <span class="badge bg-success">
                                                    <i class="bx bx-chart me-1"></i>
                                                    Distribución: {{ simulation_instance.fk_fdp.name }}
                                                </span>
                                                {% endif %}
                                                {% if performance_metrics.mape %}
                                                <span class="badge bg-info">
                                                    <i class="bx bx-target-lock me-1"></i>
                                                    MAPE: {{ performance_metrics.mape|floatformat:2 }}%
                                                </span>
                                                {% endif %}
                                                {% if charts_available_count %}
                                                <span class="badge bg-warning">
                                                    <i class="bx bx-bar-chart me-1"></i>
                                                    {{ charts_available_count }} gráficos disponibles
                                                </span>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Dashboard de Performance Principal -->
                                {% if statistical_charts.performance_dashboard %}
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <div class="chart-container">
                                            <div class="chart-header">
                                                <h5 class="chart-title mb-3">
                                                    <i class="bx bx-dashboard me-2"></i>
                                                    Dashboard de Performance del Modelo
                                                </h5>
                                                <div class="chart-controls">
                                                    <div class="chart-control-btn" onclick="downloadChart('{{ statistical_charts.performance_dashboard }}', 'dashboard-performance.png')" title="Descargar">
                                                        <i class="bx bx-download"></i>
                                                    </div>
                                                    <div class="chart-control-btn" onclick="openFullscreen('{{ statistical_charts.performance_dashboard }}', 'Dashboard de Performance')" title="Pantalla completa">
                                                        <i class="bx bx-fullscreen"></i>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="chart-content">
                                                <img src="data:image/png;base64,{{ statistical_charts.performance_dashboard }}" 
                                                    class="chart-image" 
                                                    alt="Dashboard de Performance del Modelo"
                                                    loading="lazy">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}

                                <!-- Métricas de Performance Detalladas -->
                                {% if performance_metrics %}
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <div class="metric-card model-performance">
                                            <div class="card-header">
                                                <h5 class="card-title mb-0">
                                                    <i class="bx bx-target-lock me-2"></i>
                                                    Métricas de Desempeño del Modelo
                                                </h5>
                                                <div class="card-subtitle">
                                                    Indicadores cuantitativos de precisión y calidad del modelo de simulación
                                                </div>
                                            </div>
                                            <div class="card-body">
                                                <div class="row">
                                                    <div class="col-lg-2 col-md-4 col-sm-6">
                                                        <div class="performance-metric">
                                                            <div class="metric-icon">
                                                                <i class="bx bx-percentage"></i>
                                                            </div>
                                                            <div class="metric-content">
                                                                <h6 class="metric-label">MAPE</h6>
                                                                <h4 class="metric-value text-{% if performance_metrics.mape < 10 %}success{% elif performance_metrics.mape < 20 %}warning{% else %}danger{% endif %}">
                                                                    {{ performance_metrics.mape|floatformat:2 }}%
                                                                </h4>
                                                                <small class="text-muted">{{ performance_metrics.accuracy_level|default:"Calculando..." }}</small>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-lg-2 col-md-4 col-sm-6">
                                                        <div class="performance-metric">
                                                            <div class="metric-icon">
                                                                <i class="bx bx-check-square"></i>
                                                            </div>
                                                            <div class="metric-content">
                                                                <h6 class="metric-label">R²</h6>
                                                                <h4 class="metric-value text-{% if performance_metrics.r_squared > 0.8 %}success{% elif performance_metrics.r_squared > 0.6 %}warning{% else %}danger{% endif %}">
                                                                    {{ performance_metrics.r_squared|floatformat:3 }}
                                                                </h4>
                                                                <small class="text-muted">{{ performance_metrics.model_quality|default:"Evaluando..." }}</small>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-lg-2 col-md-4 col-sm-6">
                                                        <div class="performance-metric">
                                                            <div class="metric-icon">
                                                                <i class="bx bx-error"></i>
                                                            </div>
                                                            <div class="metric-content">
                                                                <h6 class="metric-label">RMSE</h6>
                                                                <h4 class="metric-value text-info">
                                                                    {{ performance_metrics.rmse|floatformat:2 }}
                                                                </h4>
                                                                <small class="text-muted">Error cuadrático medio</small>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-lg-2 col-md-4 col-sm-6">
                                                        <div class="performance-metric">
                                                            <div class="metric-icon">
                                                                <i class="bx bx-trending-down"></i>
                                                            </div>
                                                            <div class="metric-content">
                                                                <h6 class="metric-label">MAE</h6>
                                                                <h4 class="metric-value text-warning">
                                                                    {{ performance_metrics.mae|floatformat:2 }}
                                                                </h4>
                                                                <small class="text-muted">Error absoluto medio</small>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-lg-2 col-md-4 col-sm-6">
                                                        <div class="performance-metric">
                                                            <div class="metric-icon">
                                                                <i class="bx bx-award"></i>
                                                            </div>
                                                            <div class="metric-content">
                                                                <h6 class="metric-label">Nash-Sutcliffe</h6>
                                                                <h4 class="metric-value text-primary">
                                                                    {{ performance_metrics.nash_sutcliffe|floatformat:3 }}
                                                                </h4>
                                                                <small class="text-muted">Eficiencia del modelo</small>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-lg-2 col-md-4 col-sm-6">
                                                        <div class="performance-metric">
                                                            <div class="metric-icon">
                                                                <i class="bx bx-stats"></i>
                                                            </div>
                                                            <div class="metric-content">
                                                                <h6 class="metric-label">Willmott-d</h6>
                                                                <h4 class="metric-value text-secondary">
                                                                    {{ performance_metrics.willmott_d|floatformat:3 }}
                                                                </h4>
                                                                <small class="text-muted">Índice de concordancia</small>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}

                                <!-- Gráficos Estadísticos Principales -->
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <h5 class="mb-3">
                                            <i class="bx bx-bar-chart me-2"></i>
                                            Análisis de Distribución y Correlación
                                        </h5>
                                    </div>
                                    
                                    <!-- Histograma con distribución -->
                                    {% if statistical_charts.histogram %}
                                    <div class="col-lg-6 mb-4">
                                        <div class="chart-container">
                                            <div class="chart-header">
                                                <h6 class="chart-title mb-3">
                                                    <i class="bx bx-bar-chart me-2"></i>
                                                    Distribución de la Demanda Simulada
                                                </h6>
                                                <div class="chart-controls">
                                                    <div class="chart-control-btn" onclick="downloadChart('{{ statistical_charts.histogram }}', 'distribucion-demanda.png')" title="Descargar">
                                                        <i class="bx bx-download"></i>
                                                    </div>
                                                    <div class="chart-control-btn" onclick="openFullscreen('{{ statistical_charts.histogram }}', 'Distribución de Demanda')" title="Pantalla completa">
                                                        <i class="bx bx-fullscreen"></i>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="chart-content">
                                                <img src="data:image/png;base64,{{ statistical_charts.histogram }}" 
                                                    class="chart-image" 
                                                    alt="Distribución de la Demanda"
                                                    loading="lazy">
                                            </div>
                                            {% if distribution_analysis.basic_stats %}
                                            <div class="chart-footer">
                                                <small class="text-muted">
                                                    Media: {{ distribution_analysis.basic_stats.mean|floatformat:2 }} | 
                                                    Std: {{ distribution_analysis.basic_stats.std|floatformat:2 }} | 
                                                    {% if distribution_analysis.normality_test.is_normal %}
                                                        <span class="text-success">Distribución Normal</span>
                                                    {% else %}
                                                        <span class="text-warning">No Normal</span>
                                                    {% endif %}
                                                </small>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% endif %}
                                    
                                    <!-- Box plot comparativo -->
                                    {% if statistical_charts.boxplot %}
                                    <div class="col-lg-6 mb-4">
                                        <div class="chart-container">
                                            <div class="chart-header">
                                                <h6 class="chart-title mb-3">
                                                    <i class="bx bx-box me-2"></i>
                                                    Comparación de Distribuciones
                                                </h6>
                                                <div class="chart-controls">
                                                    <div class="chart-control-btn" onclick="downloadChart('{{ statistical_charts.boxplot }}', 'boxplot-comparativo.png')" title="Descargar">
                                                        <i class="bx bx-download"></i>
                                                    </div>
                                                    <div class="chart-control-btn" onclick="openFullscreen('{{ statistical_charts.boxplot }}', 'Box Plot Comparativo')" title="Pantalla completa">
                                                        <i class="bx bx-fullscreen"></i>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="chart-content">
                                                <img src="data:image/png;base64,{{ statistical_charts.boxplot }}" 
                                                    class="chart-image" 
                                                    alt="Box Plot Comparativo"
                                                    loading="lazy">
                                            </div>
                                            <div class="chart-footer">
                                                <small class="text-muted">
                                                    Comparación de distribuciones entre demanda histórica y simulada
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                    
                                    <!-- Scatter plot de correlación -->
                                    {% if statistical_charts.scatter %}
                                    <div class="col-lg-6 mb-4">
                                        <div class="chart-container">
                                            <div class="chart-header">
                                                <h6 class="chart-title mb-3">
                                                    <i class="bx bx-scatter-chart me-2"></i>
                                                    Correlación Histórico vs Simulado
                                                </h6>
                                                <div class="chart-controls">
                                                    <div class="chart-control-btn" onclick="downloadChart('{{ statistical_charts.scatter }}', 'correlacion-scatter.png')" title="Descargar">
                                                        <i class="bx bx-download"></i>
                                                    </div>
                                                    <div class="chart-control-btn" onclick="openFullscreen('{{ statistical_charts.scatter }}', 'Gráfico de Correlación')" title="Pantalla completa">
                                                        <i class="bx bx-fullscreen"></i>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="chart-content">
                                                <img src="data:image/png;base64,{{ statistical_charts.scatter }}" 
                                                    class="chart-image" 
                                                    alt="Gráfico de Correlación"
                                                    loading="lazy">
                                            </div>
                                            {% if performance_metrics.r_squared %}
                                            <div class="chart-footer">
                                                <small class="text-muted">
                                                    R² = {{ performance_metrics.r_squared|floatformat:3 }} | 
                                                    Correlación: {{ statistical_tests.correlation.strength|default:"Calculando..." }}
                                                </small>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% endif %}
                                    
                                    <!-- Gráfico de residuos -->
                                    {% if statistical_charts.residuals %}
                                    <div class="col-lg-6 mb-4">
                                        <div class="chart-container">
                                            <div class="chart-header">
                                                <h6 class="chart-title mb-3">
                                                    <i class="bx bx-line-chart me-2"></i>
                                                    Análisis de Residuos
                                                </h6>
                                                <div class="chart-controls">
                                                    <div class="chart-control-btn" onclick="downloadChart('{{ statistical_charts.residuals }}', 'analisis-residuos.png')" title="Descargar">
                                                        <i class="bx bx-download"></i>
                                                    </div>
                                                    <div class="chart-control-btn" onclick="openFullscreen('{{ statistical_charts.residuals }}', 'Análisis de Residuos')" title="Pantalla completa">
                                                        <i class="bx bx-fullscreen"></i>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="chart-content">
                                                <img src="data:image/png;base64,{{ statistical_charts.residuals }}" 
                                                    class="chart-image" 
                                                    alt="Análisis de Residuos"
                                                    loading="lazy">
                                            </div>
                                            <div class="chart-footer">
                                                <small class="text-muted">
                                                    Distribución de errores para evaluar la calidad del ajuste del modelo
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>

                                <!-- Análisis de Normalidad y Autocorrelación -->
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <h5 class="mb-3">
                                            <i class="bx bx-pulse me-2"></i>
                                            Análisis de Normalidad y Patrones Temporales
                                        </h5>
                                    </div>
                                    
                                    <!-- Q-Q Plot -->
                                    {% if statistical_charts.qq_plot %}
                                    <div class="col-lg-6 mb-4">
                                        <div class="chart-container">
                                            <div class="chart-header">
                                                <h6 class="chart-title mb-3">
                                                    <i class="bx bx-stats me-2"></i>
                                                    Prueba de Normalidad (Q-Q Plot)
                                                </h6>
                                                <div class="chart-controls">
                                                    <div class="chart-control-btn" onclick="downloadChart('{{ statistical_charts.qq_plot }}', 'qq-plot-normalidad.png')" title="Descargar">
                                                        <i class="bx bx-download"></i>
                                                    </div>
                                                    <div class="chart-control-btn" onclick="openFullscreen('{{ statistical_charts.qq_plot }}', 'Q-Q Plot')" title="Pantalla completa">
                                                        <i class="bx bx-fullscreen"></i>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="chart-content">
                                                <img src="data:image/png;base64,{{ statistical_charts.qq_plot }}" 
                                                    class="chart-image" 
                                                    alt="Q-Q Plot de Normalidad"
                                                    loading="lazy">
                                            </div>
                                            {% if distribution_analysis.normality_test %}
                                            <div class="chart-footer">
                                                <small class="text-muted">
                                                    Shapiro-Wilk: p = {{ distribution_analysis.normality_test.shapiro_p|floatformat:4 }} | 
                                                    {% if distribution_analysis.normality_test.is_normal %}
                                                        <span class="text-success">Los datos siguen distribución normal</span>
                                                    {% else %}
                                                        <span class="text-warning">Los datos no siguen distribución normal</span>
                                                    {% endif %}
                                                </small>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% endif %}
                                    
                                    <!-- Autocorrelación -->
                                    {% if statistical_charts.autocorrelation %}
                                    <div class="col-lg-6 mb-4">
                                        <div class="chart-container">
                                            <div class="chart-header">
                                                <h6 class="chart-title mb-3">
                                                    <i class="bx bx-pulse me-2"></i>
                                                    Función de Autocorrelación
                                                </h6>
                                                <div class="chart-controls">
                                                    <div class="chart-control-btn" onclick="downloadChart('{{ statistical_charts.autocorrelation }}', 'autocorrelacion.png')" title="Descargar">
                                                        <i class="bx bx-download"></i>
                                                    </div>
                                                    <div class="chart-control-btn" onclick="openFullscreen('{{ statistical_charts.autocorrelation }}', 'Autocorrelación')" title="Pantalla completa">
                                                        <i class="bx bx-fullscreen"></i>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="chart-content">
                                                <img src="data:image/png;base64,{{ statistical_charts.autocorrelation }}" 
                                                    class="chart-image" 
                                                    alt="Función de Autocorrelación"
                                                    loading="lazy">
                                            </div>
                                            <div class="chart-footer">
                                                <small class="text-muted">
                                                    Análisis de dependencias temporales en la serie de demanda simulada
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>

                                <!-- Mapa de correlaciones entre variables -->
                                {% if statistical_charts.correlation_heatmap %}
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <div class="chart-container">
                                            <div class="chart-header">
                                                <h5 class="chart-title mb-3">
                                                    <i class="bx bx-grid me-2"></i>
                                                    Matriz de Correlación entre Variables Endógenas
                                                </h5>
                                                <div class="chart-controls">
                                                    <div class="chart-control-btn" onclick="downloadChart('{{ statistical_charts.correlation_heatmap }}', 'correlaciones-variables.png')" title="Descargar">
                                                        <i class="bx bx-download"></i>
                                                    </div>
                                                    <div class="chart-control-btn" onclick="openFullscreen('{{ statistical_charts.correlation_heatmap }}', 'Matriz de Correlación')" title="Pantalla completa">
                                                        <i class="bx bx-fullscreen"></i>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="chart-content">
                                                <img src="data:image/png;base64,{{ statistical_charts.correlation_heatmap }}" 
                                                    class="chart-image" 
                                                    alt="Matriz de Correlación entre Variables"
                                                    loading="lazy">
                                            </div>
                                            {% if correlation_analysis.significant_correlations %}
                                            <div class="chart-footer">
                                                <small class="text-muted">
                                                    Correlaciones significativas detectadas: {{ correlation_analysis.significant_correlations|length }}
                                                </small>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                {% endif %}

                                <!-- Pruebas Estadísticas -->
                                {% if statistical_tests %}
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <div class="statistical-tests-card">
                                            <h5 class="tests-title">
                                                <i class="bx bx-test-tube me-2"></i>
                                                Pruebas Estadísticas de Validación
                                            </h5>
                                            <div class="tests-grid">
                                                <div class="row">
                                                    {% if statistical_tests.t_test %}
                                                    <div class="col-md-3">
                                                        <div class="test-result">
                                                            <h6 class="test-name">Prueba t (Medias)</h6>
                                                            <div class="test-value">
                                                                <span class="badge {% if statistical_tests.t_test.means_equal %}bg-success{% else %}bg-warning{% endif %}">
                                                                    {% if statistical_tests.t_test.means_equal %}Iguales{% else %}Diferentes{% endif %}
                                                                </span>
                                                                <small class="d-block">p-value: {{ statistical_tests.t_test.p_value|floatformat:4 }}</small>
                                                                <small class="text-muted">{{ statistical_tests.t_test.interpretation }}</small>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    {% endif %}
                                                    
                                                    {% if statistical_tests.f_test %}
                                                    <div class="col-md-3">
                                                        <div class="test-result">
                                                            <h6 class="test-name">Prueba F (Varianzas)</h6>
                                                            <div class="test-value">
                                                                <span class="badge {% if statistical_tests.f_test.variances_equal %}bg-success{% else %}bg-warning{% endif %}">
                                                                    {% if statistical_tests.f_test.variances_equal %}Homogéneas{% else %}Heterogéneas{% endif %}
                                                                </span>
                                                                <small class="d-block">p-value: {{ statistical_tests.f_test.p_value|floatformat:4 }}</small>
                                                                <small class="text-muted">{{ statistical_tests.f_test.interpretation }}</small>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    {% endif %}
                                                    
                                                    {% if statistical_tests.ks_test %}
                                                    <div class="col-md-3">
                                                        <div class="test-result">
                                                            <h6 class="test-name">Kolmogorov-Smirnov</h6>
                                                            <div class="test-value">
                                                                <span class="badge {% if statistical_tests.ks_test.distributions_equal %}bg-success{% else %}bg-warning{% endif %}">
                                                                    {% if statistical_tests.ks_test.distributions_equal %}Similares{% else %}Diferentes{% endif %}
                                                                </span>
                                                                <small class="d-block">p-value: {{ statistical_tests.ks_test.p_value|floatformat:4 }}</small>
                                                                <small class="text-muted">{{ statistical_tests.ks_test.interpretation }}</small>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    {% endif %}
                                                    
                                                    {% if statistical_tests.correlation %}
                                                    <div class="col-md-3">
                                                        <div class="test-result">
                                                            <h6 class="test-name">Correlación de Pearson</h6>
                                                            <div class="test-value">
                                                                <span class="badge {% if statistical_tests.correlation.is_significant %}bg-success{% else %}bg-secondary{% endif %}">
                                                                    {{ statistical_tests.correlation.strength }}
                                                                </span>
                                                                <small class="d-block">r = {{ statistical_tests.correlation.coefficient|floatformat:3 }}</small>
                                                                <small class="text-muted">{{ statistical_tests.correlation.interpretation }}</small>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}

                                <!-- Correlaciones Significativas -->
                                {% if correlation_analysis.significant_correlations %}
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <div class="card">
                                            <div class="card-header">
                                                <h5 class="card-title mb-0">
                                                    <i class="bx bx-link me-2"></i>
                                                    Correlaciones Significativas entre Variables
                                                </h5>
                                            </div>
                                            <div class="card-body">
                                                <div class="row">
                                                    {% for correlation in correlation_analysis.significant_correlations %}
                                                    <div class="col-md-6 mb-3">
                                                        <div class="correlation-item">
                                                            <div class="correlation-header">
                                                                <strong>{{ correlation.var1 }} ↔ {{ correlation.var2 }}</strong>
                                                                <span class="badge bg-{% if correlation.coefficient > 0 %}success{% else %}danger{% endif %} ms-2">
                                                                    {{ correlation.direction }}
                                                                </span>
                                                            </div>
                                                            <div class="correlation-details">
                                                                <small class="text-muted">
                                                                    Coeficiente: {{ correlation.coefficient|floatformat:3 }} | 
                                                                    Fuerza: {{ correlation.strength }}
                                                                </small>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}

                                <!-- Análisis de Tendencias -->
                                {% if trend_analysis %}
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <div class="card">
                                            <div class="card-header">
                                                <h5 class="card-title mb-0">
                                                    <i class="bx bx-trending-up me-2"></i>
                                                    Análisis de Tendencias Temporales
                                                </h5>
                                            </div>
                                            <div class="card-body">
                                                <div class="row">
                                                    <div class="col-md-4">
                                                        <div class="trend-metric">
                                                            <h6 class="trend-label">Tipo de Tendencia</h6>
                                                            <div class="trend-value">
                                                                <span class="badge bg-{% if trend_analysis.trend_type == 'Creciente' %}success{% elif trend_analysis.trend_type == 'Decreciente' %}danger{% else %}secondary{% endif %}">
                                                                    {{ trend_analysis.trend_type }}
                                                                </span>
                                                            </div>
                                                            <small class="text-muted">{{ trend_analysis.trend_strength }} intensidad</small>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <div class="trend-metric">
                                                            <h6 class="trend-label">Pendiente</h6>
                                                            <div class="trend-value">
                                                                <strong class="text-{% if trend_analysis.slope > 0 %}success{% elif trend_analysis.slope < 0 %}danger{% else %}secondary{% endif %}">
                                                                    {{ trend_analysis.slope|floatformat:4 }}
                                                                </strong>
                                                            </div>
                                                            <small class="text-muted">Cambio por período</small>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <div class="trend-metric">
                                                            <h6 class="trend-label">Significancia</h6>
                                                            <div class="trend-value">
                                                                <span class="badge bg-{% if trend_analysis.has_significant_trend %}success{% else %}secondary{% endif %}">
                                                                    {% if trend_analysis.has_significant_trend %}Significativa{% else %}No Significativa{% endif %}
                                                                </span>
                                                            </div>
                                                            <small class="text-muted">R² = {{ trend_analysis.r_squared|floatformat:3 }}</small>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}

                                <!-- Interpretación y Recomendaciones Estadísticas -->
                                <div class="row">
                                    <div class="col-12">
                                        <div class="card">
                                            <div class="card-header">
                                                <h5 class="card-title mb-0">
                                                    <i class="bx bx-brain me-2"></i>
                                                    Interpretación Estadística y Recomendaciones
                                                </h5>
                                            </div>
                                            <div class="card-body">
                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <h6 class="text-primary">Calidad del Modelo</h6>
                                                        {% if performance_metrics %}
                                                        <div class="interpretation-section">
                                                            <p><strong>Nivel de Precisión:</strong> {{ performance_metrics.accuracy_level }}</p>
                                                            <p><strong>Calidad del Ajuste:</strong> {{ performance_metrics.model_quality }}</p>
                                                            
                                                            {% if performance_metrics.mape < 10 %}
                                                            <div class="alert alert-success">
                                                                <i class="bx bx-check-circle me-2"></i>
                                                                El modelo muestra <strong>excelente precisión</strong> con MAPE < 10%. 
                                                                Las predicciones son altamente confiables.
                                                            </div>
                                                            {% elif performance_metrics.mape < 20 %}
                                                            <div class="alert alert-warning">
                                                                <i class="bx bx-error-circle me-2"></i>
                                                                El modelo tiene <strong>buena precisión</strong> pero puede mejorarse. 
                                                                Considerar refinamiento de parámetros.
                                                            </div>
                                                            {% else %}
                                                            <div class="alert alert-danger">
                                                                <i class="bx bx-x-circle me-2"></i>
                                                                El modelo requiere <strong>calibración significativa</strong>. 
                                                                Revisar estructura del modelo y datos de entrada.
                                                            </div>
                                                            {% endif %}
                                                        </div>
                                                        {% endif %}
                                                    </div>
                                                    
                                                    <div class="col-md-6">
                                                        <h6 class="text-success">Recomendaciones</h6>
                                                        <div class="recommendations-section">
                                                            {% if performance_metrics.r_squared > 0.8 %}
                                                            <div class="recommendation-item">
                                                                <i class="bx bx-check text-success me-2"></i>
                                                                <span>Excelente capacidad explicativa del modelo (R² > 0.8)</span>
                                                            </div>
                                                            {% else %}
                                                            <div class="recommendation-item">
                                                                <i class="bx bx-error text-warning me-2"></i>
                                                                <span>Considerar incluir variables adicionales para mejorar R²</span>
                                                            </div>
                                                            {% endif %}
                                                            
                                                            {% if statistical_tests.correlation.is_significant %}
                                                            <div class="recommendation-item">
                                                                <i class="bx bx-check text-success me-2"></i>
                                                                <span>Correlación significativa entre histórico y simulado</span>
                                                            </div>
                                                            {% else %}
                                                            <div class="recommendation-item">
                                                                <i class="bx bx-error text-warning me-2"></i>
                                                                <span>Revisar patrones temporales y ajustar modelo</span>
                                                            </div>
                                                            {% endif %}
                                                            
                                                            {% if distribution_analysis.normality_test.is_normal %}
                                                            <div class="recommendation-item">
                                                                <i class="bx bx-check text-success me-2"></i>
                                                                <span>Distribución normal: métodos estadísticos estándar aplicables</span>
                                                            </div>
                                                            {% else %}
                                                            <div class="recommendation-item">
                                                                <i class="bx bx-info text-info me-2"></i>
                                                                <span>Distribución no normal: considerar transformaciones de datos</span>
                                                            </div>
                                                            {% endif %}
                                                            
                                                            {% if trend_analysis.has_significant_trend %}
                                                            <div class="recommendation-item">
                                                                <i class="bx bx-trending-up text-info me-2"></i>
                                                                <span>Tendencia {{ trend_analysis.trend_type|lower }} detectada: incluir en análisis futuro</span>
                                                            </div>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                            </div>
                            <!-- Validation Tab -->
                            <!-- Validation Tab - COMPLETE IMPROVED VERSION -->
<div class="tab-pane fade" id="validation" role="tabpanel">
    
    <!-- Resumen Principal de Validación con Variables Reales -->
    <div class="row mb-4">
        <div class="col-12">
            {% if model_validation_summary and model_validation_summary.total_variables > 0 %}
                <div class="alert {% if model_validation_summary.success_rate >= 70 %}alert-success{% elif model_validation_summary.success_rate >= 50 %}alert-warning{% elif model_validation_summary.success_rate >= 25 %}alert-info{% else %}alert-danger{% endif %}">
                    <h5 class="alert-heading">
                        <i class="bx {% if model_validation_summary.success_rate >= 70 %}bx-check-circle{% elif model_validation_summary.success_rate >= 50 %}bx-error-circle{% else %}bx-x-circle{% endif %} me-2"></i>
                        Validación del Modelo vs Datos Reales
                    </h5>
                    <hr>
                    <div class="row text-center">
                        <div class="col-md-3">
                            <div class="validation-kpi">
                                <div class="validation-kpi-value {% if model_validation_summary.success_rate > 70 %}text-success{% elif model_validation_summary.success_rate > 50 %}text-warning{% elif model_validation_summary.success_rate > 25 %}text-info{% else %}text-danger{% endif %}">
                                    {{ model_validation_summary.success_rate|floatformat:1 }}%
                                </div>
                                <div class="validation-kpi-label">Precisión del Modelo</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="validation-kpi">
                                <div class="validation-kpi-value text-primary">
                                    {{ model_validation_summary.total_variables|default:0 }}
                                </div>
                                <div class="validation-kpi-label">Variables Validadas</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="validation-kpi">
                                <div class="validation-kpi-value text-success">
                                    {{ model_validation_summary.precise_count|default:0 }}
                                </div>
                                <div class="validation-kpi-label">Variables Precisas</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="validation-kpi">
                                <div class="validation-kpi-value text-warning">
                                    {{ model_validation_summary.acceptable_count|default:0 }}
                                </div>
                                <div class="validation-kpi-label">Variables Aceptables</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Mensaje de Interpretación -->
                    <div class="mt-3 p-3 bg-light rounded">
                        <h6 class="mb-2">💡 Interpretación del Resultado:</h6>
                        {% if model_validation_summary.success_rate >= 70 %}
                            <p class="mb-0 text-success">
                                <strong>Excelente:</strong> El modelo muestra alta precisión comparado con los datos reales de su empresa. 
                                Las predicciones son confiables para la toma de decisiones.
                            </p>
                        {% elif model_validation_summary.success_rate >= 50 %}
                            <p class="mb-0 text-warning">
                                <strong>Bueno:</strong> El modelo tiene precisión aceptable con los datos reales. 
                                Algunas variables pueden necesitar ajustes para mejorar la exactitud.
                            </p>
                        {% elif model_validation_summary.success_rate >= 25 %}
                            <p class="mb-0 text-info">
                                <strong>Moderado:</strong> El modelo captura tendencias generales pero requiere calibración. 
                                Las predicciones son útiles como estimaciones preliminares.
                            </p>
                        {% else %}
                            <p class="mb-0 text-danger">
                                <strong>Necesita Mejoras:</strong> El modelo requiere ajustes significativos para alinearse mejor con los datos reales.
                                Se recomienda revisar los parámetros de entrada.
                            </p>
                        {% endif %}
                    </div>
                </div>
            {% else %}
                <div class="alert alert-info">
                    <h5 class="alert-heading">
                        <i class="bx bx-info-circle me-2"></i>
                        Estado de la Validación
                    </h5>
                    <p class="mb-2">
                        {% if model_validation_summary.validation_details %}
                            Se encontraron <strong>{{ model_validation_summary.validation_details|length }}</strong> variables para validar.
                        {% else %}
                            El sistema está procesando la validación del modelo contra sus datos reales.
                        {% endif %}
                    </p>
                    <div class="row">
                        <div class="col-md-6">
                            <h6>🎯 Variables Disponibles para Validación:</h6>
                            {% if model_validation_summary.validation_details %}
                                <ul class="list-unstyled mb-0">
                                    {% for var_name, details in model_validation_summary.validation_details.items %}
                                        <li><i class="bx bx-check text-success"></i> {{ var_name }}: {{ details.real_value|floatformat:2 }}</li>
                                    {% endfor %}
                                </ul>
                            {% else %}
                                <p class="text-muted">Procesando datos del cuestionario...</p>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <h6>📊 Variables Simuladas Disponibles:</h6>
                            {% if all_variables_extracted and all_variables_extracted.0 %}
                                <ul class="list-unstyled mb-0">
                                    {% for key, value in all_variables_extracted.0.items %}
                                        {% if key != 'day' and key != 'date' and key != 'demand_mean' and key != 'demand_std' %}
                                            <li><i class="bx bx-check text-info"></i> {{ key }}</li>
                                        {% endif %}
                                    {% endfor %}
                                </ul>
                            {% else %}
                                <p class="text-muted">Cargando variables simuladas...</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Detalle de Variables Validadas -->
    {% if model_validation_by_variable %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bx bx-calculator me-2"></i>
                        Validación Detallada por Variable
                    </h5>
                    <span class="badge bg-primary">{{ model_validation_by_variable|length }} variables</span>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Variable</th>
                                    <th>Valor Real</th>
                                    <th>Valor Simulado</th>
                                    <th>Error %</th>
                                    <th>Estado</th>
                                    <th>Método</th>
                                    <th>Interpretación</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for var_name, var_data in model_validation_by_variable.items %}
                                <tr class="clickable" onclick="showVariableDetails('{{ var_name }}', {{ var_data|safe }})">
                                    <td>
                                        <strong>{{ var_name }}</strong>
                                        <br>
                                        <small class="text-muted">{{ var_data.description|default:var_name }}</small>
                                    </td>
                                    <td>
                                        <span class="text-primary">{{ var_data.real_value|floatformat:2 }}</span>
                                        <br>
                                        <small class="text-muted">{{ var_data.unit|default:"" }}</small>
                                    </td>
                                    <td>
                                        <span class="text-info">{{ var_data.simulated_avg|floatformat:2 }}</span>
                                        <br>
                                        <small class="text-muted">({{ var_data.simulated_values_count }} días)</small>
                                    </td>
                                    <td>
                                        <span class="{% if var_data.error_pct <= 10 %}text-success{% elif var_data.error_pct <= 25 %}text-warning{% else %}text-danger{% endif %}">
                                            {{ var_data.error_pct|floatformat:1 }}%
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge bg-{% if var_data.status == 'PRECISE' %}success{% elif var_data.status == 'ACCEPTABLE' or var_data.status == 'MARGINAL' %}warning{% else %}danger{% endif %}">
                                            {% if var_data.status == 'PRECISE' %}
                                                Precisa
                                            {% elif var_data.status == 'ACCEPTABLE' %}
                                                Aceptable
                                            {% elif var_data.status == 'MARGINAL' %}
                                                Marginal
                                            {% elif var_data.status == 'NO_DATA' %}
                                                Sin Datos
                                            {% else %}
                                                Inexacta
                                            {% endif %}
                                        </span>
                                    </td>
                                    <td>
                                        <small class="text-muted">{{ var_data.comparison_method|default:"Promedio" }}</small>
                                    </td>
                                    <td>
                                        {% if var_data.status == 'PRECISE' %}
                                            <small class="text-success">Excelente precisión</small>
                                        {% elif var_data.status == 'ACCEPTABLE' %}
                                            <small class="text-warning">Precisión aceptable</small>
                                        {% elif var_data.status == 'MARGINAL' %}
                                            <small class="text-info">Necesita ajuste menor</small>
                                        {% else %}
                                            <small class="text-danger">Requiere calibración</small>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Gráfico de Comparación de Variables -->
    {% if model_validation_by_variable %}
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bx bx-bar-chart-alt-2 me-2"></i>
                        Comparación Visual: Real vs Simulado
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="realVsSimulatedChart" height="300"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bx bx-pie-chart-alt-2 me-2"></i>
                        Distribución de Precisión
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="precisionDistributionChart"></canvas>
                    <div class="mt-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-success">Precisas</span>
                            <span class="badge bg-success">{{ model_validation_summary.precise_count|default:0 }}</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-warning">Aceptables</span>
                            <span class="badge bg-warning">{{ model_validation_summary.acceptable_count|default:0 }}</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="text-danger">Inexactas</span>
                            <span class="badge bg-danger">{{ model_validation_summary.inaccurate_count|default:0 }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Simulación vs Datos Históricos (si existen) -->
    {% if historical_demand and comparison_chart %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bx bx-line-chart me-2"></i>
                        Validación con Datos Históricos de Demanda
                    </h5>
                </div>
                <div class="card-body">
                    <img src="data:image/png;base64,{{ comparison_chart }}" 
                         class="img-fluid rounded" 
                         alt="Comparación Histórica vs Simulada">
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Three-Line Validation Chart (si está disponible) -->
    {% if has_three_line_chart and three_line_validation_chart %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white">
                    <h4 class="mb-0">
                        <i class="bx bx-check-circle me-2"></i> 
                        Validación Completa del Modelo
                    </h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-lg-9">
                            <img src="data:image/png;base64,{{ three_line_validation_chart }}" 
                                class="img-fluid rounded shadow" 
                                alt="Gráfico de Validación Completa">
                        </div>
                        <div class="col-lg-3">
                            <div class="validation-metrics">
                                <h5>Métricas de Validación</h5>
                                
                                {% if three_line_validation_metrics.historical_vs_simulated %}
                                <div class="metric-card mb-3 p-3 bg-light rounded">
                                    <h6 class="text-muted">Histórico vs Simulado</h6>
                                    <p class="mb-1">MAPE: <strong class="text-{% if three_line_validation_metrics.historical_vs_simulated.mape < 10 %}success{% else %}warning{% endif %}">{{ three_line_validation_metrics.historical_vs_simulated.mape|floatformat:2 }}%</strong></p>
                                    <p class="mb-0">Precisión: <strong class="text-{% if three_line_validation_metrics.historical_vs_simulated.accuracy_level == 'Excelente' %}success{% else %}info{% endif %}">{{ three_line_validation_metrics.historical_vs_simulated.accuracy_level|default:"Buena" }}</strong></p>
                                </div>
                                {% endif %}
                                
                                {% if three_line_validation_metrics.overall_validation %}
                                <div class="metric-card p-3 bg-primary text-white rounded">
                                    <h6>Validación General</h6>
                                    <h3 class="mb-1">{{ three_line_validation_metrics.overall_validation.score|default:85|floatformat:1 }}%</h3>
                                    <p class="mb-0">{{ three_line_validation_metrics.overall_validation.status|default:"Validación Exitosa" }}</p>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Análisis de Calidad de Datos -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bx bx-data me-2"></i>
                        Calidad de Datos de Entrada
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <h6>Datos Reales Disponibles:</h6>
                        <div class="progress mb-2">
                            {% with real_count=model_validation_summary.total_variables|default:0 %}
                            {% if real_count > 0 %}
                                {% if real_count >= 10 %}
                                    <div class="progress-bar bg-success" style="width: 85%">
                                        {{ real_count }} de 15 variables
                                    </div>
                                {% elif real_count >= 5 %}
                                    <div class="progress-bar bg-warning" style="width: 60%">
                                        {{ real_count }} de 15 variables
                                    </div>
                                {% else %}
                                    <div class="progress-bar bg-info" style="width: 35%">
                                        {{ real_count }} de 15 variables
                                    </div>
                                {% endif %}
                            {% else %}
                                <div class="progress-bar bg-light" style="width: 10%">
                                    0 de 15 variables
                                </div>
                            {% endif %}
                            {% endwith %}
                        </div>
                        
                        <h6>Variables Simuladas:</h6>
                        {% if all_variables_extracted and all_variables_extracted.0 %}
                            {% with sim_count=all_variables_extracted.0.items|length %}
                            {% if sim_count > 15 %}
                                <div class="progress">
                                    <div class="progress-bar bg-success" style="width: 90%">
                                        {{ sim_count|add:-4 }} variables calculadas
                                    </div>
                                </div>
                            {% elif sim_count > 10 %}
                                <div class="progress">
                                    <div class="progress-bar bg-warning" style="width: 70%">
                                        {{ sim_count|add:-4 }} variables calculadas
                                    </div>
                                </div>
                            {% else %}
                                <div class="progress">
                                    <div class="progress-bar bg-info" style="width: 45%">
                                        {{ sim_count|add:-4 }} variables calculadas
                                    </div>
                                </div>
                            {% endif %}
                            {% endwith %}
                        {% else %}
                            <div class="progress">
                                <div class="progress-bar bg-light" style="width: 10%">
                                    0 variables calculadas
                                </div>
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="alert alert-light">
                        <h6>Recomendaciones para Mejorar:</h6>
                        <ul class="mb-0">
                            {% if model_validation_summary.total_variables < 5 %}
                                <li>Completar más información en el cuestionario inicial</li>
                            {% endif %}
                            {% if model_validation_summary.success_rate < 70 %}
                                <li>Revisar y ajustar los parámetros del modelo</li>
                            {% endif %}
                            <li>Verificar la consistencia de los datos de entrada</li>
                            <li>Considerar datos históricos adicionales si están disponibles</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bx bx-trending-up me-2"></i>
                        Evolución de Variables Clave
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="variableEvolutionChart" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Radar de Confianza (si hay datos de validación detallados) -->
    {% if model_validation_summary.validation_details %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card hover-lift">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bx bx-radar me-2"></i>
                        Radar de Confianza por Variable
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="confidenceMetricsChart" height="400"></canvas>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Tabla Detallada de Variables Simuladas -->
    {% if all_variables_extracted %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bx bx-list-check me-2"></i>
                        Evolución Diaria de Variables
                        <span class="badge bg-info ms-2">{{ all_variables_extracted|length }} días</span>
                    </h5>
                    <button class="btn btn-sm btn-outline-primary no-print" onclick="exportValidationResults()">
                        <i class="bx bx-download me-1"></i>Exportar CSV
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                        <table class="table table-sm table-hover" id="validationDetailTable">
                            <thead class="sticky-top bg-white">
                                <tr>
                                    <th>Día</th>
                                    <th>Demanda</th>
                                    {% if all_variables_extracted.0 %}
                                        {% for key, value in all_variables_extracted.0.items %}
                                            {% if key != 'day' and key != 'date' and key != 'demand_mean' and key != 'demand_std' %}
                                                <th class="text-end">{{ key }}</th>
                                            {% endif %}
                                        {% endfor %}
                                    {% endif %}
                                    <th class="text-center">Estado</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in all_variables_extracted %}
                                <tr class="validation-row">
                                    <td class="fw-bold">{{ item.day }}</td>
                                    <td class="text-primary">{{ item.demand_mean|floatformat:1 }} L</td>
                                    {% for key, value in item.items %}
                                        {% if key != 'day' and key != 'date' and key != 'demand_mean' and key != 'demand_std' %}
                                            <td class="text-end">
                                                {% if value != None %}
                                                    {{ value|floatformat:2 }}
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                        {% endif %}
                                    {% endfor %}
                                    <td class="text-center">
                                        {% if item.demand_mean > 0 %}
                                            <span class="badge bg-success status-indicator success">✓</span>
                                        {% else %}
                                            <span class="badge bg-warning status-indicator warning">⚠</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Recomendaciones Específicas -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bx bx-bulb me-2"></i>
                        Recomendaciones Personalizadas
                    </h5>
                </div>
                <div class="card-body">
                    {% if model_validation_summary.success_rate >= 70 %}
                        <div class="alert alert-success success-glow">
                            <h6><i class="bx bx-check-circle me-2"></i>Excelente Rendimiento del Modelo</h6>
                            <ul class="mb-0">
                                <li>Su modelo muestra alta precisión comparado con sus datos reales</li>
                                <li>Las predicciones son confiables para la toma de decisiones operativas</li>
                                <li>Puede usar estos resultados para planificación a corto y mediano plazo</li>
                                <li>Considere ejecutar simulaciones con diferentes escenarios</li>
                            </ul>
                        </div>
                    {% elif model_validation_summary.success_rate >= 50 %}
                        <div class="alert alert-warning warning-glow">
                            <h6><i class="bx bx-error-circle me-2"></i>Rendimiento Aceptable con Oportunidades de Mejora</h6>
                            <ul class="mb-0">
                                <li>El modelo captura las tendencias principales de su negocio</li>
                                <li>Algunas variables pueden beneficiarse de ajustes de calibración</li>
                                <li>Use los resultados como estimaciones con un margen de error considerado</li>
                                <li>Recolecte más datos históricos para mejorar la precisión</li>
                            </ul>
                        </div>
                    {% else %}
                        <div class="alert alert-info">
                            <h6><i class="bx bx-info-circle me-2"></i>Oportunidades de Calibración</h6>
                            <ul class="mb-0">
                                <li>El modelo necesita ajustes para alinearse mejor con sus datos específicos</li>
                                <li>Revise los parámetros de entrada en el cuestionario inicial</li>
                                <li>Considere proporcionar datos históricos más detallados</li>
                                <li>Los resultados actuales son útiles para análisis de tendencias generales</li>
                            </ul>
                        </div>
                    {% endif %}
                    
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <h6>📈 Para Mejorar la Precisión:</h6>
                            <ul class="list-unstyled">
                                <li><i class="bx bx-check text-success"></i> Actualizar datos del cuestionario con información más reciente</li>
                                <li><i class="bx bx-check text-success"></i> Incluir más datos históricos de demanda (mínimo 30 datos)</li>
                                <li><i class="bx bx-check text-success"></i> Verificar la consistencia de precios y costos</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6>🎯 Próximos Pasos Recomendados:</h6>
                            <ul class="list-unstyled">
                                <li><i class="bx bx-check text-info"></i> Ejecutar simulaciones con diferentes períodos de tiempo</li>
                                <li><i class="bx bx-check text-info"></i> Comparar resultados con datos reales post-simulación</li>
                                <li><i class="bx bx-check text-info"></i> Usar insights para optimizar operaciones</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
                            <!-- Kolmogorov-Smirnov Validation Tab -->
                            <div class="tab-pane fade" id="ks-validation" role="tabpanel">
                                <!-- Header del análisis KS -->
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <div class="alert {% if ks_validation.summary.overall_validity %}alert-success{% elif ks_validation.summary.passed_tests > 0 %}alert-warning{% else %}alert-danger{% endif %}">
                                            <h4 class="alert-heading mb-3">
                                                <i class="bx bx-test-tube me-2"></i>
                                                Validación Estadística Kolmogorov-Smirnov
                                            </h4>
                                            <p class="mb-2">
                                                Validación específica de que los resultados de simulación siguen las distribuciones esperadas 
                                                del modelo matemático. Esta prueba certifica la validez estadística de las proyecciones generadas.
                                            </p>
                                            <div class="row mt-3">
                                                <div class="col-md-3">
                                                    <strong>Tests Realizados:</strong> 
                                                    <span class="text-primary">{{ ks_validation.summary.total_tests|default:0 }}</span>
                                                </div>
                                                <div class="col-md-3">
                                                    <strong>Tests Aprobados:</strong> 
                                                    <span class="text-success">{{ ks_validation.summary.passed_tests|default:0 }}</span>
                                                </div>
                                                <div class="col-md-3">
                                                    <strong>Fallas Críticas:</strong> 
                                                    <span class="text-danger">{{ ks_validation.summary.critical_failures|default:0 }}</span>
                                                </div>
                                                <div class="col-md-3">
                                                    <strong>Validez General:</strong> 
                                                    {% if ks_validation.summary.overall_validity %}
                                                        <span class="text-success">✓ Válido</span>
                                                    {% else %}
                                                        <span class="text-danger">✗ Requiere Revisión</span>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Dashboard de Confiabilidad Principal -->
                                {% if ks_validation.ks_charts.reliability_dashboard %}
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <div class="chart-container">
                                            <div class="chart-header">
                                                <h5 class="chart-title mb-3">
                                                    <i class="bx bx-dashboard me-2"></i>
                                                    Dashboard de Confiabilidad Estadística
                                                </h5>
                                                <div class="chart-controls">
                                                    <div class="chart-control-btn" onclick="downloadChart('{{ ks_validation.ks_charts.reliability_dashboard }}', 'dashboard-confiabilidad.png')" title="Descargar">
                                                        <i class="bx bx-download"></i>
                                                    </div>
                                                    <div class="chart-control-btn" onclick="openFullscreen('{{ ks_validation.ks_charts.reliability_dashboard }}', 'Dashboard de Confiabilidad')" title="Pantalla completa">
                                                        <i class="bx bx-fullscreen"></i>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="chart-content">
                                                <img src="data:image/png;base64,{{ ks_validation.ks_charts.reliability_dashboard }}" 
                                                    class="chart-image" 
                                                    alt="Dashboard de Confiabilidad"
                                                    loading="lazy">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}

                                <!-- Reporte de Confiabilidad -->
                                {% if ks_validation.reliability_report %}
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <div class="card">
                                            <div class="card-header">
                                                <h5 class="card-title mb-0">
                                                    <i class="bx bx-certificate me-2"></i>
                                                    Reporte de Confiabilidad Estadística
                                                </h5>
                                            </div>
                                            <div class="card-body">
                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <div class="reliability-summary">
                                                            <h6 class="text-primary">Certificación del Modelo</h6>
                                                            <div class="certification-badge mb-3">
                                                                <span class="badge {% if ks_validation.reliability_report.certification_status == 'CERTIFIED' %}bg-success{% elif ks_validation.reliability_report.certification_status == 'CONDITIONAL' %}bg-warning{% else %}bg-danger{% endif %} p-3 fs-6">
                                                                    <i class="bx {% if ks_validation.reliability_report.certification_status == 'CERTIFIED' %}bx-check-circle{% elif ks_validation.reliability_report.certification_status == 'CONDITIONAL' %}bx-error-circle{% else %}bx-x-circle{% endif %} me-2"></i>
                                                                    {{ ks_validation.reliability_report.certification_status|default:"NO_CERTIFIED" }}
                                                                </span>
                                                            </div>
                                                            
                                                            <div class="reliability-metrics">
                                                                <div class="metric-item mb-2">
                                                                    <strong>Score de Confiabilidad:</strong> 
                                                                    <span class="fs-5 {% if ks_validation.reliability_report.reliability_score >= 75 %}text-success{% elif ks_validation.reliability_report.reliability_score >= 60 %}text-warning{% else %}text-danger{% endif %}">
                                                                        {{ ks_validation.reliability_report.reliability_score|default:0|floatformat:1 }}/100
                                                                    </span>
                                                                </div>
                                                                <div class="metric-item mb-2">
                                                                    <strong>Nivel de Confiabilidad:</strong> 
                                                                    <span class="badge bg-info">{{ ks_validation.reliability_report.reliability_level|default:"Desconocido" }}</span>
                                                                </div>
                                                                <div class="metric-item mb-2">
                                                                    <strong>Tasa de Aprobación:</strong> 
                                                                    <span class="text-primary">{{ ks_validation.reliability_report.pass_rate|default:0|floatformat:1 }}%</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    
                                                    <div class="col-md-6">
                                                        <h6 class="text-success">Recomendación del Sistema</h6>
                                                        <div class="recommendation-box p-3 bg-light rounded">
                                                            <p class="mb-0">{{ ks_validation.reliability_report.overall_recommendation|default:"Sin recomendaciones disponibles." }}</p>
                                                        </div>
                                                        
                                                        {% if ks_validation.reliability_report.tests_summary %}
                                                        <div class="tests-summary mt-3">
                                                            <h6>Resumen de Validaciones</h6>
                                                            <ul class="list-unstyled">
                                                                <li><i class="bx bx-check text-success me-2"></i>Tests Exitosos: {{ ks_validation.reliability_report.tests_summary.successful_validations|default:0 }}</li>
                                                                <li><i class="bx bx-list-ul text-info me-2"></i>Total Realizados: {{ ks_validation.reliability_report.tests_summary.total_conducted|default:0 }}</li>
                                                                {% if ks_validation.reliability_report.tests_summary.critical_issues > 0 %}
                                                                <li><i class="bx bx-error text-danger me-2"></i>Issues Críticos: {{ ks_validation.reliability_report.tests_summary.critical_issues }}</li>
                                                                {% endif %}
                                                            </ul>
                                                        </div>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}

                                <!-- Pruebas KS Detalladas -->
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <h5 class="mb-3">
                                            <i class="bx bx-bar-chart me-2"></i>
                                            Resultados de Pruebas Kolmogorov-Smirnov
                                        </h5>
                                    </div>
                                    
                                    <!-- Gráfico de Distribuciones -->
                                    {% if ks_validation.ks_charts.demand_distribution %}
                                    <div class="col-12 mb-4">
                                        <div class="chart-container">
                                            <div class="chart-header">
                                                <h6 class="chart-title mb-3">
                                                    <i class="bx bx-stats me-2"></i>
                                                    Validación de Distribuciones vs Datos Observados
                                                </h6>
                                                <div class="chart-controls">
                                                    <div class="chart-control-btn" onclick="downloadChart('{{ ks_validation.ks_charts.demand_distribution }}', 'validacion-distribuciones.png')" title="Descargar">
                                                        <i class="bx bx-download"></i>
                                                    </div>
                                                    <div class="chart-control-btn" onclick="openFullscreen('{{ ks_validation.ks_charts.demand_distribution }}', 'Validación de Distribuciones')" title="Pantalla completa">
                                                        <i class="bx bx-fullscreen"></i>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="chart-content">
                                                <img src="data:image/png;base64,{{ ks_validation.ks_charts.demand_distribution }}" 
                                                    class="chart-image" 
                                                    alt="Validación de Distribuciones"
                                                    loading="lazy">
                                            </div>
                                            <div class="chart-footer">
                                                <small class="text-muted">
                                                    Las pruebas KS comparan los datos simulados contra distribuciones teóricas esperadas.
                                                    P-values > 0.05 indican buen ajuste a la distribución.
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                    
                                    <!-- Intervalos de Confianza -->
                                    {% if ks_validation.ks_charts.confidence_intervals %}
                                    <div class="col-lg-6 mb-4">
                                        <div class="chart-container">
                                            <div class="chart-header">
                                                <h6 class="chart-title mb-3">
                                                    <i class="bx bx-error-alt me-2"></i>
                                                    Intervalos de Confianza para Proyecciones
                                                </h6>
                                                <div class="chart-controls">
                                                    <div class="chart-control-btn" onclick="downloadChart('{{ ks_validation.ks_charts.confidence_intervals }}', 'intervalos-confianza.png')" title="Descargar">
                                                        <i class="bx bx-download"></i>
                                                    </div>
                                                    <div class="chart-control-btn" onclick="openFullscreen('{{ ks_validation.ks_charts.confidence_intervals }}', 'Intervalos de Confianza')" title="Pantalla completa">
                                                        <i class="bx bx-fullscreen"></i>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="chart-content">
                                                <img src="data:image/png;base64,{{ ks_validation.ks_charts.confidence_intervals }}" 
                                                    class="chart-image" 
                                                    alt="Intervalos de Confianza"
                                                    loading="lazy">
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                    
                                    <!-- Estabilidad Temporal -->
                                    {% if ks_validation.ks_charts.temporal_stability %}
                                    <div class="col-lg-6 mb-4">
                                        <div class="chart-container">
                                            <div class="chart-header">
                                                <h6 class="chart-title mb-3">
                                                    <i class="bx bx-time me-2"></i>
                                                    Estabilidad Temporal de Distribuciones
                                                </h6>
                                                <div class="chart-controls">
                                                    <div class="chart-control-btn" onclick="downloadChart('{{ ks_validation.ks_charts.temporal_stability }}', 'estabilidad-temporal.png')" title="Descargar">
                                                        <i class="bx bx-download"></i>
                                                    </div>
                                                    <div class="chart-control-btn" onclick="openFullscreen('{{ ks_validation.ks_charts.temporal_stability }}', 'Estabilidad Temporal')" title="Pantalla completa">
                                                        <i class="bx bx-fullscreen"></i>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="chart-content">
                                                <img src="data:image/png;base64,{{ ks_validation.ks_charts.temporal_stability }}" 
                                                    class="chart-image" 
                                                    alt="Estabilidad Temporal"
                                                    loading="lazy">
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>

                                <!-- Tabla de Resultados KS por Variable -->
                                {% if ks_validation.ks_tests %}
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <div class="card">
                                            <div class="card-header">
                                                <h5 class="card-title mb-0">
                                                    <i class="bx bx-table me-2"></i>
                                                    Resultados Detallados por Variable
                                                </h5>
                                            </div>
                                            <div class="card-body">
                                                <div class="table-responsive">
                                                    <table class="table table-hover">
                                                        <thead>
                                                            <tr>
                                                                <th>Variable/Componente</th>
                                                                <th>Distribución Esperada</th>
                                                                <th>Estadístico KS</th>
                                                                <th>P-value</th>
                                                                <th>Tamaño Muestra</th>
                                                                <th>Estado</th>
                                                                <th>Interpretación</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {% for test_name, test_result in ks_validation.ks_tests.items %}
                                                            {% if test_name == 'demand' %}
                                                            <tr class="table-primary">
                                                                <td>
                                                                    <strong>Demanda</strong>
                                                                    <br><small class="text-muted">Componente principal</small>
                                                                </td>
                                                                <td>
                                                                    {% if test_result.best_fit_distribution %}
                                                                        <span class="badge bg-info">{{ test_result.best_fit_distribution|title }}</span>
                                                                    {% else %}
                                                                        <span class="text-muted">Múltiples</span>
                                                                    {% endif %}
                                                                </td>
                                                                <td>
                                                                    {% if test_result.distributions_tested %}
                                                                        {% for dist_name, dist_info in test_result.distributions_tested.items %}
                                                                            {% if dist_name == test_result.best_fit_distribution %}
                                                                                {{ dist_info.statistic|floatformat:4 }}
                                                                            {% endif %}
                                                                        {% endfor %}
                                                                    {% else %}
                                                                        N/A
                                                                    {% endif %}
                                                                </td>
                                                                <td>
                                                                    <span class="{% if test_result.best_p_value > 0.05 %}text-success{% elif test_result.best_p_value > 0.01 %}text-warning{% else %}text-danger{% endif %} fw-bold">
                                                                        {{ test_result.best_p_value|floatformat:4 }}
                                                                    </span>
                                                                </td>
                                                                <td>{{ test_result.sample_size|default:0 }}</td>
                                                                <td>
                                                                    {% if test_result.overall_passes %}
                                                                        <span class="badge bg-success">✓ Pasa</span>
                                                                    {% else %}
                                                                        <span class="badge bg-danger">✗ Falla</span>
                                                                    {% endif %}
                                                                </td>
                                                                <td>
                                                                    <small>{{ test_result.interpretation|default:"Sin interpretación" }}</small>
                                                                </td>
                                                            </tr>
                                                            {% else %}
                                                            <tr>
                                                                <td>
                                                                    <strong>{{ test_result.variable|default:test_name }}</strong>
                                                                    <br><small class="text-muted">Variable endógena</small>
                                                                </td>
                                                                <td>
                                                                    <span class="badge bg-secondary">{{ test_result.expected_distribution|default:"Normal"|title }}</span>
                                                                </td>
                                                                <td>{{ test_result.statistic|default:0|floatformat:4 }}</td>
                                                                <td>
                                                                    <span class="{% if test_result.p_value > 0.05 %}text-success{% elif test_result.p_value > 0.01 %}text-warning{% else %}text-danger{% endif %} fw-bold">
                                                                        {{ test_result.p_value|default:0|floatformat:4 }}
                                                                    </span>
                                                                </td>
                                                                <td>{{ test_result.sample_size|default:0 }}</td>
                                                                <td>
                                                                    {% if test_result.passes_test %}
                                                                        <span class="badge bg-success">✓ Pasa</span>
                                                                    {% else %}
                                                                        <span class="badge bg-warning">✗ Falla</span>
                                                                    {% endif %}
                                                                </td>
                                                                <td>
                                                                    <small>{{ test_result.interpretation|default:"Test estadístico completado" }}</small>
                                                                </td>
                                                            </tr>
                                                            {% endif %}
                                                            {% endfor %}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}

                                <!-- Intervalos de Confianza Detallados -->
                                {% if ks_validation.confidence_intervals %}
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <div class="card">
                                            <div class="card-header">
                                                <h5 class="card-title mb-0">
                                                    <i class="bx bx-error-alt me-2"></i>
                                                    Intervalos de Confianza para Proyecciones
                                                </h5>
                                            </div>
                                            <div class="card-body">
                                                <div class="row">
                                                    <!-- Intervalos de Demanda -->
                                                    <div class="col-md-6">
                                                        <h6 class="text-primary">Demanda Proyectada</h6>
                                                        {% for interval_key, interval_data in ks_validation.confidence_intervals.items %}
                                                            {% if 'demand' in interval_key %}
                                                            <div class="confidence-interval-item mb-3 p-3 border rounded">
                                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                                    <strong>{{ interval_data.confidence_level|floatformat:0 }}% de Confianza</strong>
                                                                    <span class="badge bg-info">± {{ interval_data.margin_error|floatformat:2 }}</span>
                                                                </div>
                                                                <div class="interval-visualization">
                                                                    <div class="progress" style="height: 25px;">
                                                                        <div class="progress-bar bg-primary" role="progressbar" 
                                                                            style="width: 100%;" 
                                                                            aria-valuenow="100" aria-valuemin="0" aria-valuemax="100">
                                                                            {{ interval_data.mean|floatformat:1 }} L/día
                                                                        </div>
                                                                    </div>
                                                                    <div class="d-flex justify-content-between mt-1">
                                                                        <small>{{ interval_data.lower_bound|floatformat:1 }}</small>
                                                                        <small>{{ interval_data.upper_bound|floatformat:1 }}</small>
                                                                    </div>
                                                                </div>
                                                                <small class="text-muted">{{ interval_data.interpretation }}</small>
                                                            </div>
                                                            {% endif %}
                                                        {% endfor %}
                                                    </div>
                                                    
                                                    <!-- Intervalos de Variables Clave -->
                                                    <div class="col-md-6">
                                                        <h6 class="text-success">Variables Financieras (95% Confianza)</h6>
                                                        {% for interval_key, interval_data in ks_validation.confidence_intervals.items %}
                                                            {% if 'demand' not in interval_key %}
                                                            <div class="variable-interval-item mb-2 p-2 bg-light rounded">
                                                                <div class="d-flex justify-content-between">
                                                                    <strong>{{ interval_data.variable|default:interval_key }}</strong>
                                                                    <span class="text-primary">{{ interval_data.mean|floatformat:2 }} ± {{ interval_data.margin_error|floatformat:2 }}</span>
                                                                </div>
                                                                <small class="text-muted">
                                                                    Rango: [{{ interval_data.lower_bound|floatformat:2 }}, {{ interval_data.upper_bound|floatformat:2 }}]
                                                                    (n={{ interval_data.sample_size }})
                                                                </small>
                                                            </div>
                                                            {% endif %}
                                                        {% endfor %}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}

                                <!-- Análisis de Consistencia Temporal -->
                                {% if ks_validation.distribution_analysis %}
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <div class="card">
                                            <div class="card-header">
                                                <h5 class="card-title mb-0">
                                                    <i class="bx bx-time-five me-2"></i>
                                                    Análisis de Consistencia Temporal
                                                </h5>
                                            </div>
                                            <div class="card-body">
                                                <div class="row">
                                                    <!-- Estabilidad Temporal -->
                                                    {% if ks_validation.distribution_analysis.temporal_stability %}
                                                    <div class="col-md-6">
                                                        <h6 class="text-info">Estabilidad entre Períodos</h6>
                                                        {% for comparison_key, comparison_data in ks_validation.distribution_analysis.temporal_stability.items %}
                                                        <div class="comparison-item mb-2 p-2 border rounded">
                                                            <div class="d-flex justify-content-between align-items-center">
                                                                <small class="fw-bold">{{ comparison_data.window1_period }} vs {{ comparison_data.window2_period }}</small>
                                                                <span class="badge {% if comparison_data.distributions_similar %}bg-success{% else %}bg-warning{% endif %}">
                                                                    {% if comparison_data.distributions_similar %}Estables{% else %}Diferentes{% endif %}
                                                                </span>
                                                            </div>
                                                            <small class="text-muted">
                                                                KS: {{ comparison_data.ks_statistic|floatformat:4 }}, 
                                                                p-value: {{ comparison_data.p_value|floatformat:4 }}
                                                            </small>
                                                        </div>
                                                        {% endfor %}
                                                    </div>
                                                    {% endif %}
                                                    
                                                    <!-- Drift de Distribución -->
                                                    {% if ks_validation.distribution_analysis.distribution_drift %}
                                                    <div class="col-md-6">
                                                        <h6 class="text-warning">Deriva de la Distribución</h6>
                                                        {% with drift=ks_validation.distribution_analysis.distribution_drift %}
                                                        <div class="drift-analysis p-3 bg-light rounded">
                                                            <div class="row">
                                                                <div class="col-6">
                                                                    <div class="text-center">
                                                                        <div class="fw-bold text-primary">{{ drift.initial_mean|floatformat:1 }}</div>
                                                                        <small>Media Inicial</small>
                                                                    </div>
                                                                </div>
                                                                <div class="col-6">
                                                                    <div class="text-center">
                                                                        <div class="fw-bold text-success">{{ drift.final_mean|floatformat:1 }}</div>
                                                                        <small>Media Final</small>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <hr>
                                                            <div class="text-center">
                                                                <div class="drift-indicator">
                                                                    <span class="badge {% if drift.drift_direction == 'increasing' %}bg-success{% elif drift.drift_direction == 'decreasing' %}bg-danger{% else %}bg-secondary{% endif %} p-2">
                                                                        {% if drift.drift_direction == 'increasing' %}
                                                                            <i class="bx bx-trending-up me-1"></i>Tendencia Creciente
                                                                        {% elif drift.drift_direction == 'decreasing' %}
                                                                            <i class="bx bx-trending-down me-1"></i>Tendencia Decreciente
                                                                        {% else %}
                                                                            <i class="bx bx-minus me-1"></i>Estable
                                                                        {% endif %}
                                                                    </span>
                                                                </div>
                                                                <small class="d-block mt-2">
                                                                    Cambio: {{ drift.relative_drift_pct|floatformat:2 }}% 
                                                                    ({{ drift.absolute_drift|floatformat:2 }} unidades)
                                                                </small>
                                                            </div>
                                                        </div>
                                                        {% endwith %}
                                                    </div>
                                                    {% endif %}
                                                </div>
                                                
                                                <!-- Métricas de Consistencia -->
                                                {% if ks_validation.distribution_analysis.consistency_metrics %}
                                                <div class="row mt-3">
                                                    <div class="col-12">
                                                        <h6 class="text-secondary">Métricas de Consistencia General</h6>
                                                        {% with metrics=ks_validation.distribution_analysis.consistency_metrics %}
                                                        <div class="row">
                                                            <div class="col-md-4">
                                                                <div class="metric-box text-center p-3 border rounded">
                                                                    <div class="metric-value h4 {% if metrics.coefficient_of_variation < 0.1 %}text-success{% elif metrics.coefficient_of_variation < 0.3 %}text-warning{% else %}text-danger{% endif %}">
                                                                        {{ metrics.coefficient_of_variation|floatformat:3 }}
                                                                    </div>
                                                                    <small>Coeficiente de Variación</small>
                                                                </div>
                                                            </div>
                                                            <div class="col-md-4">
                                                                <div class="metric-box text-center p-3 border rounded">
                                                                    <div class="metric-value h4">
                                                                        <span class="badge bg-{% if metrics.stability_assessment == 'high' %}success{% elif metrics.stability_assessment == 'medium' %}warning{% else %}danger{% endif %} p-2">
                                                                            {{ metrics.stability_assessment|title }}
                                                                        </span>
                                                                    </div>
                                                                    <small>Evaluación de Estabilidad</small>
                                                                </div>
                                                            </div>
                                                            <div class="col-md-4">
                                                                <div class="metric-box text-center p-3 border rounded">
                                                                    <div class="metric-value h4">
                                                                        <span class="badge bg-{% if metrics.data_quality == 'excellent' %}success{% elif metrics.data_quality == 'good' %}info{% elif metrics.data_quality == 'fair' %}warning{% else %}danger{% endif %} p-2">
                                                                            {{ metrics.data_quality|title }}
                                                                        </span>
                                                                    </div>
                                                                    <small>Calidad de Datos</small>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        {% endwith %}
                                                    </div>
                                                </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}

                                <!-- Alertas y Recomendaciones KS -->
                                {% if ks_validation.alerts %}
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <div class="card">
                                            <div class="card-header">
                                                <h5 class="card-title mb-0">
                                                    <i class="bx bx-error-circle me-2"></i>
                                                    Alertas y Recomendaciones Estadísticas
                                                </h5>
                                            </div>
                                            <div class="card-body">
                                                {% for alert in ks_validation.alerts %}
                                                <div class="alert alert-{% if alert.type == 'ERROR' %}danger{% elif alert.type == 'WARNING' %}warning{% else %}info{% endif %} mb-3">
                                                    <div class="d-flex align-items-start">
                                                        <i class="bx {% if alert.type == 'ERROR' %}bx-error-circle{% elif alert.type == 'WARNING' %}bx-error{% else %}bx-info-circle{% endif %} me-3 mt-1 fs-4"></i>
                                                        <div class="flex-grow-1">
                                                            <h6 class="alert-heading">
                                                                {{ alert.type|title }} 
                                                                {% if alert.severity %}
                                                                    <span class="badge bg-{% if alert.severity == 'high' %}danger{% elif alert.severity == 'medium' %}warning{% else %}secondary{% endif %} ms-2">
                                                                        {{ alert.severity|title }}
                                                                    </span>
                                                                {% endif %}
                                                            </h6>
                                                            <p class="mb-2">{{ alert.message }}</p>
                                                            {% if alert.recommendation %}
                                                            <div class="recommendation-text">
                                                                <strong>Recomendación:</strong> {{ alert.recommendation }}
                                                            </div>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}

                                <!-- Análisis de Componentes -->
                                {% if ks_validation.reliability_report.component_analysis %}
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <div class="card">
                                            <div class="card-header">
                                                <h5 class="card-title mb-0">
                                                    <i class="bx bx-component me-2"></i>
                                                    Análisis de Confiabilidad por Componente
                                                </h5>
                                            </div>
                                            <div class="card-body">
                                                <div class="row">
                                                    {% for component_key, component_data in ks_validation.reliability_report.component_analysis.items %}
                                                    <div class="col-md-6 mb-3">
                                                        <div class="component-analysis-card p-3 border rounded h-100">
                                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                                <h6 class="mb-0">{{ component_data.component|default:component_key|title }}</h6>
                                                                <span class="badge bg-{% if component_data.reliability == 'high' %}success{% elif component_data.reliability == 'medium' %}warning{% else %}danger{% endif %}">
                                                                    {{ component_data.reliability|title }}
                                                                </span>
                                                            </div>
                                                            <div class="component-metrics">
                                                                {% if component_data.confidence %}
                                                                <div class="metric-row">
                                                                    <small><strong>Confianza:</strong> {{ component_data.confidence }}</small>
                                                                </div>
                                                                {% endif %}
                                                                {% if component_data.pass_rate %}
                                                                <div class="metric-row">
                                                                    <small><strong>Tasa de Aprobación:</strong> {{ component_data.pass_rate }}</small>
                                                                </div>
                                                                {% endif %}
                                                                {% if component_data.variables_tested %}
                                                                <div class="metric-row">
                                                                    <small><strong>Variables Evaluadas:</strong> {{ component_data.variables_tested }}</small>
                                                                </div>
                                                                {% endif %}
                                                                <div class="metric-row">
                                                                    <small><strong>Estado:</strong> 
                                                                        <span class="text-{% if component_data.status == 'validated' %}success{% else %}warning{% endif %}">
                                                                            {% if component_data.status == 'validated' %}Validado{% else %}Requiere Revisión{% endif %}
                                                                        </span>
                                                                    </small>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}

                                <!-- Información del Certificado -->
                                {% if ks_validation.reliability_report.generated_at %}
                                <div class="row">
                                    <div class="col-12">
                                        <div class="card bg-light">
                                            <div class="card-body text-center">
                                                <h6><i class="bx bx-time me-2"></i>Información del Certificado</h6>
                                                <div class="row">
                                                    <div class="col-md-4">
                                                        <small><strong>Generado:</strong> {{ ks_validation.reliability_report.generated_at|date:"d/m/Y H:i" }}</small>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <small><strong>Validez:</strong> {{ ks_validation.reliability_report.validity_period|default:"30 días" }}</small>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <small><strong>Nivel de Confianza:</strong> {{ ks_validation.summary.confidence_level|floatformat:0 }}%</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}

                                <!-- Mensaje si no hay validación KS -->
                                {% if not ks_validation.summary.total_tests %}
                                <div class="row">
                                    <div class="col-12">
                                        <div class="alert alert-info text-center">
                                            <i class="bx bx-info-circle display-4 text-muted"></i>
                                            <h5 class="mt-3">Validación Kolmogorov-Smirnov no Disponible</h5>
                                            <p class="mb-3">
                                                La validación estadística KS requiere datos suficientes de la simulación para poder 
                                                ejecutar las pruebas de distribución. Esta funcionalidad estará disponible cuando 
                                                se complete la simulación con datos adecuados.
                                            </p>
                                            <div class="requirements-list">
                                                <h6>Requisitos para Validación KS:</h6>
                                                <ul class="list-unstyled">
                                                    <li><i class="bx bx-check-circle text-muted me-2"></i>Mínimo 30 datos de demanda simulada</li>
                                                    <li><i class="bx bx-check-circle text-muted me-2"></i>Variables endógenas calculadas</li>
                                                    <li><i class="bx bx-check-circle text-muted me-2"></i>Distribución de probabilidad definida</li>
                                                    <li><i class="bx bx-check-circle text-muted me-2"></i>Simulación completada exitosamente</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}

                            </div>
                        </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para expandir gráficos -->
    <div class="modal fade" id="chartModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="chartModalTitle">Gráfico de Variable</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <img id="chartModalImage" src="" class="img-fluid" alt="Gráfico expandido">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-primary" onclick="downloadChart()">
                        <i class="bx bx-download me-1"></i>Descargar
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal para detalles de variable -->
    <div class="modal fade" id="variableDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="variableDetailsTitle">Detalles de Variable</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="variableDetailsBody">
                    <!-- Contenido dinámico -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal para Detalles de Variable -->
    <div class="modal fade" id="variableDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Detalles de Validación por Día</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="variableDetailsContent">
                    <!-- Contenido dinámico -->
                </div>
            </div>
        </div>
    </div>
    <!-- SOLO ESTOS DOS MODALES AL FINAL DEL TEMPLATE -->
    <div class="modal fade" id="mainFullscreenModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-fullscreen-lg-down">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="mainFullscreenModalTitle">Gráfico</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <img id="mainFullscreenModalImage" src="" class="img-fluid" alt="Gráfico expandido">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-primary" onclick="downloadCurrentChart()">
                        <i class="bx bx-download me-1"></i>Descargar
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="mainDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="mainDetailsModalTitle">Detalles</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="mainDetailsModalBody">
                    <!-- Contenido dinámico -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
    {% block footer %}
    {% include "partials/footer.html" %}
    {% endblock footer %}
</div>
{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<!-- Agregar en la sección de scripts, después de los scripts existentes -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>



<script>


document.addEventListener('DOMContentLoaded', function() {
    // Inicializar gráficos solo si Chart.js está disponible
    if (typeof Chart === 'undefined') {
        console.warn('Chart.js no está disponible');
        showNotification('Algunos gráficos pueden no mostrarse correctamente', 'info');
        return;
    }

    // Gráfico de Comparación Real vs Simulado
    {% if model_validation_by_variable %}
    const realVsSimCtx = document.getElementById('realVsSimulatedChart');
    if (realVsSimCtx) {
        const variables = [
            {% for var_name, var_data in model_validation_by_variable.items %}
            '{{ var_name }}',
            {% endfor %}
        ];
        
        const realValues = [
            {% for var_name, var_data in model_validation_by_variable.items %}
            {{ var_data.real_value|default:0 }},
            {% endfor %}
        ];
        
        const simulatedValues = [
            {% for var_name, var_data in model_validation_by_variable.items %}
            {{ var_data.simulated_avg|default:0 }},
            {% endfor %}
        ];
        
        new Chart(realVsSimCtx, {
            type: 'bar',
            data: {
                labels: variables,
                datasets: [{
                    label: 'Valores Reales',
                    data: realValues,
                    backgroundColor: 'rgba(54, 162, 235, 0.7)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }, {
                    label: 'Valores Simulados',
                    data: simulatedValues,
                    backgroundColor: 'rgba(255, 99, 132, 0.7)',
                    borderColor: 'rgba(255, 99, 132, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                },
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    title: {
                        display: true,
                        text: 'Comparación de Variables: Real vs Simulado'
                    }
                }
            }
        });
    }
    
    // Gráfico de Distribución de Precisión
    const precisionCtx = document.getElementById('precisionDistributionChart');
    if (precisionCtx) {
        new Chart(precisionCtx, {
            type: 'doughnut',
            data: {
                labels: ['Precisas', 'Aceptables', 'Inexactas'],
                datasets: [{
                    data: [
                        {{ model_validation_summary.precise_count|default:0 }},
                        {{ model_validation_summary.acceptable_count|default:0 }},
                        {{ model_validation_summary.inaccurate_count|default:0 }}
                    ],
                    backgroundColor: [
                        'rgba(34, 197, 94, 0.8)',
                        'rgba(251, 191, 36, 0.8)',
                        'rgba(239, 68, 68, 0.8)'
                    ],
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                    },
                    title: {
                        display: true,
                        text: 'Distribución de Precisión'
                    }
                }
            }
        });
    }
    {% endif %}
    
    // Gráfico de Evolución de Variables
    {% if all_variables_extracted %}
    const evolutionCtx = document.getElementById('variableEvolutionChart');
    if (evolutionCtx) {
        const days = [
            {% for item in all_variables_extracted %}
            {{ item.day }},
            {% endfor %}
        ];
        
        const demandData = [
            {% for item in all_variables_extracted %}
            {{ item.demand_mean|default:0 }},
            {% endfor %}
        ];
        
        // Obtener una variable financiera para mostrar evolución
        {% if all_variables_extracted.0.IT %}
        const financialData = [
            {% for item in all_variables_extracted %}
            {{ item.IT|default:0 }},
            {% endfor %}
        ];
        const financialLabel = 'Ingresos Totales (Bs)';
        {% elif all_variables_extracted.0.GT %}
        const financialData = [
            {% for item in all_variables_extracted %}
            {{ item.GT|default:0 }},
            {% endfor %}
        ];
        const financialLabel = 'Ganancias Totales (Bs)';
        {% else %}
        const financialData = demandData.map(d => d * 15);
        const financialLabel = 'Estimación Financiera (Bs)';
        {% endif %}
        
        new Chart(evolutionCtx, {
            type: 'line',
            data: {
                labels: days,
                datasets: [{
                    label: 'Demanda (L)',
                    data: demandData,
                    borderColor: 'rgba(54, 162, 235, 1)',
                    backgroundColor: 'rgba(54, 162, 235, 0.1)',
                    tension: 0.4,
                    yAxisID: 'y'
                }, {
                    label: financialLabel,
                    data: financialData,
                    borderColor: 'rgba(34, 197, 94, 1)',
                    backgroundColor: 'rgba(34, 197, 94, 0.1)',
                    tension: 0.4,
                    yAxisID: 'y1'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                scales: {
                    x: {
                        display: true,
                        title: {
                            display: true,
                            text: 'Día de Simulación'
                        }
                    },
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: 'Demanda (Litros)'
                        }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'Valor Financiero (Bs)'
                        },
                        grid: {
                            drawOnChartArea: false,
                        },
                    }
                },
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    title: {
                        display: true,
                        text: 'Evolución de Variables Clave'
                    }
                }
            }
        });
    }
    {% endif %}
    
    // Gráfico de Radar de Confianza
    {% if model_validation_summary.validation_details %}
    const confidenceCtx = document.getElementById('confidenceMetricsChart');
    if (confidenceCtx) {
        const variables = [
            {% for var_name, details in model_validation_summary.validation_details.items %}
            '{{ var_name }}',
            {% endfor %}
        ];
        
        const confidenceScores = [
            {% for var_name, details in model_validation_summary.validation_details.items %}
            {{ details.error_pct|default:100|floatformat:1 }},
            {% endfor %}
        ].map(error => Math.max(0, 100 - error));
        
        new Chart(confidenceCtx, {
            type: 'radar',
            data: {
                labels: variables,
                datasets: [{
                    label: 'Score de Confianza (%)',
                    data: confidenceScores,
                    borderColor: 'rgba(34, 197, 94, 1)',
                    backgroundColor: 'rgba(34, 197, 94, 0.2)',
                    pointBackgroundColor: 'rgba(34, 197, 94, 1)',
                    pointBorderColor: '#fff',
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: 'rgba(34, 197, 94, 1)'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    r: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            stepSize: 20
                        }
                    }
                },
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    title: {
                        display: true,
                        text: 'Radar de Confianza por Variable'
                    }
                }
            }
        });
    }
    {% endif %}
    
    // Inicializar animaciones de progreso
    updateValidationProgress();
    
    // Agregar tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    if (typeof bootstrap !== 'undefined') {
        tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    }
});

// Función para exportar resultados a CSV
function exportValidationResults() {
    const table = document.getElementById('validationDetailTable');
    if (!table) {
        showNotification('No hay tabla de datos para exportar', 'warning');
        return;
    }
    
    let csv = '';
    
    // Headers
    const headers = [];
    table.querySelectorAll('thead th').forEach(th => {
        headers.push(th.textContent.trim());
    });
    csv += headers.join(',') + '\n';
    
    // Rows
    table.querySelectorAll('tbody tr').forEach(tr => {
        const row = [];
        tr.querySelectorAll('td').forEach(td => {
            let text = td.textContent.trim();
            text = text.replace(/\s+/g, ' ');
            text = text.replace(/\n/g, ' ');
            if (text.includes('✓')) text = 'Válido';
            if (text.includes('⚠')) text = 'Advertencia';
            if (text.includes('L')) text = text.replace(' L', '');
            row.push('"' + text.replace(/"/g, '""') + '"');
        });
        csv += row.join(',') + '\n';
    });
    
    // Download
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    if (link.download !== undefined) {
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', 'validacion_simulacion_' + new Date().toISOString().slice(0,10) + '.csv');
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showNotification('Archivo CSV exportado exitosamente', 'success');
    } else {
        showNotification('Su navegador no soporta la descarga de archivos', 'error');
    }
}

// Función para mostrar detalles de una variable en modal
function showVariableDetails(varName, varData) {
    // Crear modal dinámicamente
    const modalId = 'variableModal_' + varName;
    let modal = document.getElementById(modalId);
    
    if (modal) {
        modal.remove();
    }
    
    modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.id = modalId;
    modal.setAttribute('tabindex', '-1');
    
    const varDataSafe = typeof varData === 'string' ? JSON.parse(varData) : varData;
    
    modal.innerHTML = `
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bx bx-calculator me-2"></i>
                        Detalles de Variable: ${varName}
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h6 class="mb-0">Información General</h6>
                                </div>
                                <div class="card-body">
                                    <table class="table table-sm">
                                        <tr><td><strong>Variable:</strong></td><td>${varName}</td></tr>
                                        <tr><td><strong>Descripción:</strong></td><td>${varDataSafe.description || varName}</td></tr>
                                        <tr><td><strong>Unidad:</strong></td><td>${varDataSafe.unit || 'N/A'}</td></tr>
                                        <tr><td><strong>Tipo:</strong></td><td>${varDataSafe.type || 'Numérica'}</td></tr>
                                        <tr><td><strong>Método:</strong></td><td>${varDataSafe.comparison_method || 'Promedio'}</td></tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h6 class="mb-0">Métricas de Validación</h6>
                                </div>
                                <div class="card-body">
                                    <table class="table table-sm">
                                        <tr><td><strong>Valor Real:</strong></td><td>${varDataSafe.real_value?.toFixed(2) || 'N/A'}</td></tr>
                                        <tr><td><strong>Valor Simulado:</strong></td><td>${varDataSafe.simulated_avg?.toFixed(2) || 'N/A'}</td></tr>
                                        <tr><td><strong>Error (%):</strong></td><td>${varDataSafe.error_pct?.toFixed(1) || 'N/A'}%</td></tr>
                                        <tr><td><strong>Días Analizados:</strong></td><td>${varDataSafe.simulated_values_count || 'N/A'}</td></tr>
                                        <tr><td><strong>Estado:</strong></td><td>
                                            <span class="badge bg-${varDataSafe.status === 'PRECISE' ? 'success' : varDataSafe.status === 'ACCEPTABLE' || varDataSafe.status === 'MARGINAL' ? 'warning' : 'danger'}">
                                                ${varDataSafe.status || 'N/A'}
                                            </span>
                                        </td></tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    ${varDataSafe.validation_notes ? `
                    <div class="mt-3">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">Notas de Validación</h6>
                            </div>
                            <div class="card-body">
                                <div class="alert alert-info mb-0">
                                    ${varDataSafe.validation_notes}
                                </div>
                            </div>
                        </div>
                    </div>
                    ` : ''}
                    
                    ${varDataSafe.all_comparisons ? `
                    <div class="mt-3">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">Métodos de Comparación Evaluados</h6>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Método</th>
                                                <th>Error (%)</th>
                                                <th>Estado</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${Object.entries(varDataSafe.all_comparisons).map(([method, data]) => `
                                                <tr>
                                                    <td>${method.replace('_', ' ').toUpperCase()}</td>
                                                    <td>${data.error?.toFixed(1) || 'N/A'}%</td>
                                                    <td>
                                                        <span class="badge bg-${data.status === 'PRECISE' ? 'success' : data.status === 'ACCEPTABLE' || data.status === 'MARGINAL' ? 'warning' : 'danger'}">
                                                            ${data.status || 'N/A'}
                                                        </span>
                                                    </td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    ` : ''}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bx bx-x me-1"></i>Cerrar
                    </button>
                    <button type="button" class="btn btn-primary" onclick="downloadVariableReport('${varName}')">
                        <i class="bx bx-download me-1"></i>Descargar Reporte
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    if (typeof bootstrap !== 'undefined') {
        const modalInstance = new bootstrap.Modal(modal);
        modalInstance.show();
        
        modal.addEventListener('hidden.bs.modal', () => {
            document.body.removeChild(modal);
        });
    } else {
        console.warn('Bootstrap no está disponible para mostrar el modal');
        showNotification('Detalles de ' + varName + ': Error ' + (varDataSafe.error_pct?.toFixed(1) || 'N/A') + '%', 'info');
    }
}

// Función para descargar reporte de variable específica
function downloadVariableReport(varName) {
    const content = `REPORTE DE VALIDACIÓN - VARIABLE ${varName}
Generado: ${new Date().toLocaleString()}

INFORMACIÓN GENERAL:
- Variable: ${varName}
- Descripción: Variable del modelo de simulación
- Estado: En análisis

MÉTRICAS DE VALIDACIÓN:
- Días analizados: Consultar tabla detallada
- Método de comparación: Múltiples métodos evaluados
- Estado de validación: Ver detalles en sistema

Para más información, consulte el sistema completo de validación.
`;
    
    const blob = new Blob([content], { type: 'text/plain;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `reporte_${varName}_${new Date().toISOString().slice(0,10)}.txt`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showNotification(`Reporte de ${varName} descargado`, 'success');
}

// Función para mostrar notificaciones
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px; max-width: 400px;';
    
    const icon = type === 'success' ? 'bx-check-circle' : 
                 type === 'error' || type === 'danger' ? 'bx-error-circle' : 
                 type === 'warning' ? 'bx-error-circle' : 'bx-info-circle';
    
    notification.innerHTML = `
        <i class="bx ${icon} me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-remover después de 5 segundos
    setTimeout(() => {
        if (notification && notification.parentNode) {
            notification.remove();
        }
    }, 5000);
}

// Función para actualizar el progreso de validación
function updateValidationProgress() {
    const progressBars = document.querySelectorAll('.progress-bar');
    progressBars.forEach(bar => {
        const width = bar.style.width;
        bar.style.width = '0%';
        setTimeout(() => {
            bar.style.width = width;
        }, 300);
    });
}

// Función para alternar vista de tabla
function toggleTableView() {
    const table = document.getElementById('validationDetailTable');
    const container = table?.closest('.table-responsive');
    
    if (container) {
        if (container.style.maxHeight === 'none') {
            container.style.maxHeight = '400px';
            showNotification('Vista compacta activada', 'info');
        } else {
            container.style.maxHeight = 'none';
            showNotification('Vista expandida activada', 'info');
        }
    }
}

// Error handling
window.addEventListener('error', function(e) {
    console.error('Error en validación:', e.error);
    showNotification('Error al cargar algunos componentes de validación', 'warning');
});

// Función para imprimir sección de validación
function printValidation() {
    const printContent = document.getElementById('validation').innerHTML;
    const originalContent = document.body.innerHTML;
    
    document.body.innerHTML = `
        <div class="container-fluid">
            <h1>Reporte de Validación - ${new Date().toLocaleDateString()}</h1>
            ${printContent}
        </div>
    `;
    
    window.print();
    document.body.innerHTML = originalContent;
    location.reload();
}

// AGREGAR ESTAS FUNCIONES AL SCRIPT EXISTENTE EN simulate-result.html

// ==========================================
// FUNCIONES ESPECÍFICAS PARA VALIDACIÓN KS
// ==========================================

function initializeKSValidationTab() {
    """Inicializar funcionalidades específicas del tab KS"""
    try {
        // Inicializar tooltips para métricas KS
        initializeKSTooltips();
        
        // Configurar interacciones de gráficos KS
        setupKSChartInteractions();
        
        // Inicializar contadores animados para métricas KS
        animateKSMetrics();
        
        // Configurar exportación específica KS
        setupKSExportFunctions();
        
        console.log('KS Validation tab initialized successfully');
    } catch (error) {
        console.error('Error initializing KS validation tab:', error);
    }
}

function initializeKSTooltips() {
    """Agregar tooltips explicativos para métricas KS"""
    const ksTooltips = {
        '[data-metric="reliability-score"]': 'Score general de confiabilidad basado en todas las pruebas KS realizadas',
        '[data-metric="ks-statistic"]': 'Estadístico de la prueba Kolmogorov-Smirnov. Valores menores indican mejor ajuste',
        '[data-metric="p-value"]': 'P-value de la prueba KS. Valores > 0.05 indican que los datos siguen la distribución esperada',
        '[data-metric="confidence-interval"]': 'Intervalo de confianza para las proyecciones. Rango donde se espera que estén los valores reales',
        '[data-metric="temporal-stability"]': 'Medida de consistencia de la distribución a lo largo del tiempo',
        '[data-metric="distribution-drift"]': 'Cambio en los parámetros de la distribución durante el período simulado'
    };
    
    Object.entries(ksTooltips).forEach(([selector, tooltip]) => {
        const elements = document.querySelectorAll(selector);
        elements.forEach(element => {
            element.title = tooltip;
            element.style.cursor = 'help';
            
            // Agregar tooltip Bootstrap si está disponible
            if (typeof bootstrap !== 'undefined' && bootstrap.Tooltip) {
                new bootstrap.Tooltip(element, {
                    placement: 'top',
                    title: tooltip
                });
            }
        });
    });
}

function setupKSChartInteractions() {
    """Configurar interacciones específicas para gráficos KS"""
    
    // Click en gráficos KS para expandir
    document.addEventListener('click', function(e) {
        if (e.target.closest('.ks-chart-container')) {
            const chartImg = e.target.closest('.ks-chart-container').querySelector('img');
            if (chartImg) {
                const src = chartImg.src;
                const alt = chartImg.alt;
                const base64Data = src.split(',')[1];
                if (base64Data) {
                    openKSChartFullscreen(base64Data, alt);
                }
            }
        }
    });
    
    // Hover effects para métricas KS
    const metricCards = document.querySelectorAll('.ks-metric-card, .reliability-metric, .confidence-interval-item');
    metricCards.forEach(card => {
        card.addEventListener('mouseenter', function() {
            this.style.transform = 'scale(1.02)';
            this.style.transition = 'transform 0.2s ease';
            this.style.boxShadow = '0 4px 8px rgba(0,0,0,0.1)';
        });
        
        card.addEventListener('mouseleave', function() {
            this.style.transform = 'scale(1)';
            this.style.boxShadow = 'none';
        });
    });
}

function animateKSMetrics() {
    """Animar métricas KS cuando se hace visible el tab"""
    const ksTab = document.getElementById('ks-validation');
    if (!ksTab) return;
    
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                animateKSCounters();
                animateKSProgressBars();
                observer.unobserve(entry.target);
            }
        });
    });
    
    observer.observe(ksTab);
}

function animateKSCounters() {
    """Animar contadores de métricas KS"""
    const counters = document.querySelectorAll('.ks-metric-value[data-target]');
    
    counters.forEach(counter => {
        const target = parseFloat(counter.getAttribute('data-target'));
        const isPercentage = counter.textContent.includes('%');
        const isDecimal = target < 1 && target > 0;
        
        animateValue(counter, 0, target, 1500, (value) => {
            if (isPercentage) {
                return `${value.toFixed(1)}%`;
            } else if (isDecimal) {
                return value.toFixed(3);
            } else {
                return Math.round(value).toString();
            }
        });
    });
}

function animateKSProgressBars() {
    """Animar barras de progreso KS"""
    const progressBars = document.querySelectorAll('.ks-progress-bar');
    
    progressBars.forEach(bar => {
        const targetWidth = bar.getAttribute('data-width') || '0%';
        const numericValue = parseFloat(targetWidth);
        
        bar.style.width = '0%';
        
        setTimeout(() => {
            bar.style.transition = 'width 2s ease-out';
            bar.style.width = targetWidth;
            
            // Agregar color basado en el valor
            if (numericValue >= 80) {
                bar.classList.add('bg-success');
            } else if (numericValue >= 60) {
                bar.classList.add('bg-warning');
            } else {
                bar.classList.add('bg-danger');
            }
        }, 100);
    });
}

function animateValue(element, start, end, duration, formatter) {
    """Función utilitaria para animar valores numéricos"""
    const startTime = performance.now();
    
    function update(currentTime) {
        const elapsed = currentTime - startTime;
        const progress = Math.min(elapsed / duration, 1);
        
        // Easing function (ease-out)
        const easeOut = 1 - Math.pow(1 - progress, 3);
        const current = start + (end - start) * easeOut;
        
        element.textContent = formatter ? formatter(current) : current.toString();
        
        if (progress < 1) {
            requestAnimationFrame(update);
        } else {
            element.textContent = formatter ? formatter(end) : end.toString();
        }
    }
    
    requestAnimationFrame(update);
}

function openKSChartFullscreen(chartData, title) {
    """Abrir gráfico KS en pantalla completa"""
    try {
        const modal = document.getElementById('mainFullscreenModal');
        const modalTitle = document.getElementById('mainFullscreenModalTitle');
        const modalImage = document.getElementById('mainFullscreenModalImage');
        
        if (modal && modalTitle && modalImage) {
            modalTitle.textContent = title || 'Gráfico de Validación KS';
            modalImage.src = 'data:image/png;base64,' + chartData;
            modalImage.setAttribute('data-chart-data', chartData);
            modalImage.setAttribute('data-chart-type', 'ks-validation');
            
            // Agregar información adicional del gráfico KS
            const additionalInfo = document.createElement('div');
            additionalInfo.className = 'mt-3 text-muted';
            additionalInfo.innerHTML = `
                <small>
                    <i class="bx bx-info-circle me-1"></i>
                    Gráfico de validación estadística Kolmogorov-Smirnov para verificación de distribuciones
                </small>
            `;
            
            const modalBody = modal.querySelector('.modal-body');
            const existingInfo = modalBody.querySelector('.chart-additional-info');
            if (existingInfo) {
                existingInfo.remove();
            }
            additionalInfo.className += ' chart-additional-info';
            modalBody.appendChild(additionalInfo);
            
            new bootstrap.Modal(modal).show();
        }
    } catch (error) {
        console.error('Error opening KS chart fullscreen:', error);
        showNotification('Error al abrir el gráfico', 'error');
    }
}

function setupKSExportFunctions() {
    """Configurar funciones de exportación específicas para KS"""
    
    // Exportar reporte de confiabilidad
    window.exportKSReliabilityReport = function() {
        try {
            const reliabilityData = extractKSReliabilityData();
            if (reliabilityData) {
                generateKSReport(reliabilityData);
                showNotification('Reporte de confiabilidad generado exitosamente', 'success');
            } else {
                showNotification('No hay datos de confiabilidad para exportar', 'warning');
            }
        } catch (error) {
            console.error('Error exporting KS reliability report:', error);
            showNotification('Error al exportar reporte de confiabilidad', 'error');
        }
    };
    
    // Exportar datos de intervalos de confianza
    window.exportKSConfidenceIntervals = function() {
        try {
            const intervalData = extractKSConfidenceIntervalData();
            if (intervalData) {
                downloadKSConfidenceCSV(intervalData);
                showNotification('Intervalos de confianza exportados exitosamente', 'success');
            } else {
                showNotification('No hay datos de intervalos para exportar', 'warning');
            }
        } catch (error) {
            console.error('Error exporting confidence intervals:', error);
            showNotification('Error al exportar intervalos de confianza', 'error');
        }
    };
    
    // Exportar resultados completos de validación KS
    window.exportCompleteKSValidation = function() {
        try {
            const completeData = extractCompleteKSData();
            if (completeData) {
                generateCompleteKSReport(completeData);
                showNotification('Validación KS completa exportada exitosamente', 'success');
            } else {
                showNotification('No hay datos de validación para exportar', 'warning');
            }
        } catch (error) {
            console.error('Error exporting complete KS validation:', error);
            showNotification('Error al exportar validación completa', 'error');
        }
    };
}

function extractKSReliabilityData() {
    """Extraer datos de confiabilidad para exportación"""
    try {
        const reliabilityCard = document.querySelector('.reliability-summary');
        if (!reliabilityCard) return null;
        
        const data = {
            certification_status: document.querySelector('[data-certification-status]')?.textContent || 'NO_CERTIFIED',
            reliability_score: document.querySelector('[data-reliability-score]')?.textContent || '0',
            reliability_level: document.querySelector('[data-reliability-level]')?.textContent || 'Desconocido',
            pass_rate: document.querySelector('[data-pass-rate]')?.textContent || '0%',
            recommendation: document.querySelector('.recommendation-box p')?.textContent || '',
            tests_summary: {
                successful: document.querySelector('[data-successful-validations]')?.textContent || '0',
                total: document.querySelector('[data-total-conducted]')?.textContent || '0',
                critical_issues: document.querySelector('[data-critical-issues]')?.textContent || '0'
            },
            generated_at: new Date().toISOString()
        };
        
        return data;
    } catch (error) {
        console.error('Error extracting reliability data:', error);
        return null;
    }
}

function extractKSConfidenceIntervalData() {
    """Extraer datos de intervalos de confianza"""
    try {
        const intervals = [];
        const intervalItems = document.querySelectorAll('.confidence-interval-item, .variable-interval-item');
        
        intervalItems.forEach(item => {
            const confidence = item.querySelector('[data-confidence-level]')?.textContent || 
                            item.textContent.match(/(\d+)% de Confianza/)?.[1] || '95';
            const variable = item.querySelector('[data-variable]')?.textContent ||
                           item.querySelector('strong')?.textContent || 'Variable';
            const mean = item.querySelector('[data-mean]')?.textContent ||
                        item.textContent.match(/([\d.]+) ± /)?.[1] || '0';
            const margin = item.querySelector('[data-margin]')?.textContent ||
                         item.textContent.match(/± ([\d.]+)/)?.[1] || '0';
            const lower = item.querySelector('[data-lower]')?.textContent || '0';
            const upper = item.querySelector('[data-upper]')?.textContent || '0';
            
            intervals.push({
                variable: variable.trim(),
                confidence_level: confidence + '%',
                mean: parseFloat(mean),
                margin_error: parseFloat(margin),
                lower_bound: parseFloat(lower),
                upper_bound: parseFloat(upper)
            });
        });
        
        return intervals;
    } catch (error) {
        console.error('Error extracting confidence interval data:', error);
        return null;
    }
}

function extractCompleteKSData() {
    """Extraer todos los datos de validación KS"""
    try {
        const data = {
            summary: {
                total_tests: document.querySelector('[data-total-tests]')?.textContent || '0',
                passed_tests: document.querySelector('[data-passed-tests]')?.textContent || '0',
                critical_failures: document.querySelector('[data-critical-failures]')?.textContent || '0',
                overall_validity: document.querySelector('[data-overall-validity]')?.textContent === 'true'
            },
            test_results: [],
            reliability_report: extractKSReliabilityData(),
            confidence_intervals: extractKSConfidenceIntervalData(),
            temporal_analysis: extractTemporalAnalysisData(),
            generated_at: new Date().toISOString()
        };
        
        // Extraer resultados de tests individuales
        const testRows = document.querySelectorAll('#ks-tests-table tbody tr');
        testRows.forEach(row => {
            const cells = row.querySelectorAll('td');
            if (cells.length >= 6) {
                data.test_results.push({
                    variable: cells[0].textContent.trim(),
                    expected_distribution: cells[1].textContent.trim(),
                    ks_statistic: cells[2].textContent.trim(),
                    p_value: cells[3].textContent.trim(),
                    sample_size: cells[4].textContent.trim(),
                    status: cells[5].textContent.trim()
                });
            }
        });
        
        return data;
    } catch (error) {
        console.error('Error extracting complete KS data:', error);
        return null;
    }
}

function extractTemporalAnalysisData() {
    """Extraer datos de análisis temporal"""
    try {
        const temporalData = {
            stability_comparisons: [],
            distribution_drift: null,
            consistency_metrics: null
        };
        
        // Extraer comparaciones de estabilidad
        const stabilityItems = document.querySelectorAll('.comparison-item');
        stabilityItems.forEach(item => {
            const periods = item.querySelector('.fw-bold')?.textContent || '';
            const status = item.querySelector('.badge')?.textContent || '';
            const metrics = item.querySelector('.text-muted')?.textContent || '';
            
            temporalData.stability_comparisons.push({
                periods: periods,
                status: status,
                metrics: metrics
            });
        });
        
        // Extraer drift de distribución
        const driftAnalysis = document.querySelector('.drift-analysis');
        if (driftAnalysis) {
            temporalData.distribution_drift = {
                initial_mean: driftAnalysis.querySelector('[data-initial-mean]')?.textContent || '0',
                final_mean: driftAnalysis.querySelector('[data-final-mean]')?.textContent || '0',
                drift_direction: driftAnalysis.querySelector('.drift-indicator .badge')?.textContent || 'stable',
                relative_change: driftAnalysis.querySelector('[data-relative-change]')?.textContent || '0%'
            };
        }
        
        return temporalData;
    } catch (error) {
        console.error('Error extracting temporal analysis data:', error);
        return {};
    }
}

function generateKSReport(reliabilityData) {
    """Generar reporte de confiabilidad KS"""
    try {
        let csvContent = "data:text/csv;charset=utf-8,";
        csvContent += "Reporte de Confiabilidad - Validación Kolmogorov-Smirnov\n\n";
        csvContent += "Métrica,Valor\n";
        csvContent += `Estado de Certificación,"${reliabilityData.certification_status}"\n`;
        csvContent += `Score de Confiabilidad,"${reliabilityData.reliability_score}"\n`;
        csvContent += `Nivel de Confiabilidad,"${reliabilityData.reliability_level}"\n`;
        csvContent += `Tasa de Aprobación,"${reliabilityData.pass_rate}"\n`;
        csvContent += `Tests Exitosos,"${reliabilityData.tests_summary.successful}"\n`;
        csvContent += `Total de Tests,"${reliabilityData.tests_summary.total}"\n`;
        csvContent += `Issues Críticos,"${reliabilityData.tests_summary.critical_issues}"\n`;
        csvContent += `Recomendación,"${reliabilityData.recommendation}"\n`;
        csvContent += `Generado,"${reliabilityData.generated_at}"\n`;
        
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `reporte_confiabilidad_ks_${new Date().getTime()}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    } catch (error) {
        console.error('Error generating KS report:', error);
        throw error;
    }
}

function downloadKSConfidenceCSV(intervalData) {
    """Descargar CSV de intervalos de confianza"""
    try {
        let csvContent = "data:text/csv;charset=utf-8,";
        csvContent += "Variable,Nivel de Confianza,Media,Margen de Error,Límite Inferior,Límite Superior\n";
        
        intervalData.forEach(interval => {
            csvContent += `"${interval.variable}","${interval.confidence_level}",${interval.mean},${interval.margin_error},${interval.lower_bound},${interval.upper_bound}\n`;
        });
        
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `intervalos_confianza_ks_${new Date().getTime()}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    } catch (error) {
        console.error('Error downloading confidence intervals CSV:', error);
        throw error;
    }
}

function generateCompleteKSReport(completeData) {
    """Generar reporte completo de validación KS"""
    try {
        // Generar PDF usando jsPDF
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF();
        
        // Título
        pdf.setFontSize(20);
        pdf.text('Reporte Completo de Validación Kolmogorov-Smirnov', 20, 30);
        
        // Información general
        pdf.setFontSize(14);
        pdf.text('Resumen General:', 20, 50);
        pdf.setFontSize(12);
        pdf.text(`Tests Realizados: ${completeData.summary.total_tests}`, 30, 65);
        pdf.text(`Tests Aprobados: ${completeData.summary.passed_tests}`, 30, 75);
        pdf.text(`Fallas Críticas: ${completeData.summary.critical_failures}`, 30, 85);
        pdf.text(`Validez General: ${completeData.summary.overall_validity ? 'Válido' : 'Requiere Revisión'}`, 30, 95);
        
        // Resultados por variable
        if (completeData.test_results.length > 0) {
            pdf.setFontSize(14);
            pdf.text('Resultados por Variable:', 20, 115);
            
            let yPos = 130;
            completeData.test_results.forEach((result, index) => {
                if (yPos > 250) {
                    pdf.addPage();
                    yPos = 30;
                }
                
                pdf.setFontSize(10);
                pdf.text(`${result.variable}: p-value=${result.p_value}, Status=${result.status}`, 30, yPos);
                yPos += 10;
            });
        }
        
        // Recomendaciones
        if (completeData.reliability_report?.recommendation) {
            pdf.addPage();
            pdf.setFontSize(14);
            pdf.text('Recomendaciones:', 20, 30);
            pdf.setFontSize(12);
            
            const recommendation = completeData.reliability_report.recommendation;
            const lines = pdf.splitTextToSize(recommendation, 170);
            pdf.text(lines, 20, 45);
        }
        
        // Guardar PDF
        pdf.save(`validacion_ks_completa_${new Date().getTime()}.pdf`);
        
    } catch (error) {
        console.error('Error generating complete KS report:', error);
        throw error;
    }
}

// ==========================================
// EVENTO PARA INICIALIZAR TAB KS
// ==========================================

// Agregar evento para cuando se active el tab KS
document.addEventListener('shown.bs.tab', function(e) {
    if (e.target.getAttribute('aria-controls') === 'ks-validation') {
        setTimeout(initializeKSValidationTab, 100);
    }
});

// Exportar funciones para uso global
window.initializeKSValidationTab = initializeKSValidationTab;
window.openKSChartFullscreen = openKSChartFullscreen;
window.extractKSReliabilityData = extractKSReliabilityData;
window.generateKSReport = generateKSReport;



document.addEventListener('DOMContentLoaded', function() {
    initializeEnhancedInsights();
});

function initializeEnhancedInsights() {
    // Animar insights secuencialmente
    const insightCards = document.querySelectorAll('.insight-card');
    
    // Intersection Observer para animar cuando sea visible
    const observer = new IntersectionObserver((entries) => {
        entries.forEach((entry, index) => {
            if (entry.isIntersecting) {
                setTimeout(() => {
                    entry.target.style.opacity = '1';
                    entry.target.style.transform = 'translateY(0)';
                }, index * 100);
                observer.unobserve(entry.target);
            }
        });
    }, {
        threshold: 0.1,
        rootMargin: '50px'
    });
    
    insightCards.forEach(card => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(30px)';
        card.style.transition = 'all 0.6s ease';
        observer.observe(card);
    });
    
    // Agregar tooltips a los insights
    addInsightTooltips();
    
    // Actualizar insights en tiempo real si hay datos dinámicos
    updateInsightsRealTime();
}

function addInsightTooltips() {
    const tooltips = {
        '.financial': 'Análisis de rentabilidad y performance financiera basado en ingresos, gastos y márgenes',
        '.validation': 'Evaluación de la precisión y confiabilidad del modelo predictivo utilizado',
        '.operational': 'Medición de la eficiencia en procesos operativos y uso de recursos',
        '.demand': 'Análisis del comportamiento y tendencias de la demanda del producto',
        '.customer': 'Evaluación del nivel de satisfacción y experiencia del cliente',
        '.comparison': 'Comparación entre datos históricos reales y resultados de la simulación'
    };
    
    Object.entries(tooltips).forEach(([selector, tooltip]) => {
        const elements = document.querySelectorAll(selector);
        elements.forEach(element => {
            element.title = tooltip;
            element.style.cursor = 'help';
        });
    });
}

function updateInsightsRealTime() {
    // Simular actualizaciones en tiempo real de insights
    setInterval(() => {
        updateInsightTrends();
    }, 30000); // Cada 30 segundos
}

function updateInsightTrends() {
    const trendElements = document.querySelectorAll('.insight-trend');
    trendElements.forEach(element => {
        if (element.querySelector('.trend-up, .trend-down')) {
            element.style.animation = 'pulse-success 1s ease';
            setTimeout(() => {
                element.style.animation = '';
            }, 1000);
        }
    });
}

// Función para expandir detalles de un insight específico
function expandInsightDetails(insightType) {
    const modal = document.getElementById('mainDetailsModal');
    const modalTitle = document.getElementById('mainDetailsModalTitle');
    const modalBody = document.getElementById('mainDetailsModalBody');
    
    if (!modal || !modalTitle || !modalBody) return;
    
    const insightDetails = {
        financial: {
            title: 'Detalles del Análisis Financiero',
            content: generateFinancialDetails()
        },
        validation: {
            title: 'Detalles de Validación del Modelo',
            content: generateValidationDetails()
        },
        operational: {
            title: 'Detalles de Eficiencia Operativa',
            content: generateOperationalDetails()
        },
        demand: {
            title: 'Detalles del Comportamiento de Demanda',
            content: generateDemandDetails()
        },
        customer: {
            title: 'Detalles de Satisfacción del Cliente',
            content: generateCustomerDetails()
        },
        comparison: {
            title: 'Detalles de Comparación Histórica',
            content: generateComparisonDetails()
        }
    };
    
    const detail = insightDetails[insightType];
    if (detail) {
        modalTitle.textContent = detail.title;
        modalBody.innerHTML = detail.content;
        new bootstrap.Modal(modal).show();
    }
}

function generateFinancialDetails() {
    return `
        <div class="financial-details">
            <h6>Métricas Financieras Detalladas</h6>
            <div class="row">
                <div class="col-md-6">
                    <h6 class="text-primary">Ingresos</h6>
                    <p>Total generado durante el período de simulación</p>
                </div>
                <div class="col-md-6">
                    <h6 class="text-success">Rentabilidad</h6>
                    <p>Margen de ganancia sobre ingresos totales</p>
                </div>
            </div>
        </div>
    `;
}

function generateValidationDetails() {
    return `
        <div class="validation-details">
            <h6>Métricas de Validación del Modelo</h6>
            <p>El modelo ha sido validado comparando predicciones con datos históricos reales.</p>
        </div>
    `;
}

function generateOperationalDetails() {
    return `
        <div class="operational-details">
            <h6>Análisis de Eficiencia Operativa</h6>
            <p>Evaluación de la eficiencia en procesos de producción y operaciones.</p>
        </div>
    `;
}

function generateDemandDetails() {
    return `
        <div class="demand-details">
            <h6>Análisis de Demanda</h6>
            <p>Tendencias y patrones identificados en el comportamiento de la demanda.</p>
        </div>
    `;
}

function generateCustomerDetails() {
    return `
        <div class="customer-details">
            <h6>Análisis de Satisfacción del Cliente</h6>
            <p>Evaluación del nivel de satisfacción basado en métricas de servicio.</p>
        </div>
    `;
}

function generateComparisonDetails() {
    return `
        <div class="comparison-details">
            <h6>Comparación con Datos Históricos</h6>
            <p>Análisis de correlación entre datos reales y simulaciones.</p>
        </div>
    `;
}

// Exportar funciones globales
window.expandInsightDetails = expandInsightDetails;
</script>

<script>

// ==========================================
// SCRIPT UNIFICADO PARA SIMULATE-RESULT.HTML
// ==========================================

// Variables globales
let currentDay = 1;
let totalDays = 0;
let currentPage = 1;
let rowsPerPage = 10;
let validationPrecisionChart = null;
let validationSummaryChart = null;
let variablesComparisonChart = null;
let currentChartType = 'bar';
let allCharts = [];
let loadedCharts = 0;
const CHARTS_PER_BATCH = 3;

// ==========================================
// INICIALIZACIÓN PRINCIPAL
// ==========================================
document.addEventListener('DOMContentLoaded', function() {
    initializeApp();
});

function initializeApp() {
    totalDays = parseInt(document.querySelector('[data-total-days]')?.dataset.totalDays) || 
                document.querySelectorAll('.daily-result-item').length;
    
    initializeCounters();
    initializeDailyResultsPagination();
    initializeTablePagination();
    initializeModals();
    initializeChartInteractions();
    initializeExportFunctions();
    initializeTooltips();
    initializeTabEvents();
    initializeKeyboardShortcuts();
    
    // Ocultar tutorial si no es primera vez
    if (localStorage.getItem('resultsViewedBefore')) {
        hideTutorial();
    }
}

// ==========================================
// NAVEGACIÓN DE DÍAS
// ==========================================
function initializeDailyResultsPagination() {
    const prevBtn = document.getElementById('prevDayBtn');
    const nextBtn = document.getElementById('nextDayBtn');
    const dayCounter = document.getElementById('dayCounter');
    const currentDayIndicator = document.getElementById('currentDayIndicator');
    
    if (!prevBtn || !nextBtn) return;
    
    function updateDayDisplay() {
        // Ocultar todos los items
        document.querySelectorAll('.daily-result-item').forEach(item => {
            item.style.display = 'none';
        });
        
        // Mostrar item actual con animación
        const currentItem = document.querySelector(`[data-day="${currentDay}"]`);
        if (currentItem) {
            currentItem.style.display = 'block';
            currentItem.style.animation = 'fadeIn 0.3s ease';
        }
        
        // Actualizar contadores
        if (dayCounter) dayCounter.textContent = `Día ${currentDay} de ${totalDays}`;
        if (currentDayIndicator) currentDayIndicator.textContent = `Día ${currentDay}`;
        
        // Actualizar estado de botones
        prevBtn.disabled = currentDay === 1;
        nextBtn.disabled = currentDay === totalDays;
        
        // Clases de botones
        prevBtn.className = currentDay === 1 ? 
            'btn btn-sm btn-outline-secondary btn-pagination' : 
            'btn btn-sm btn-outline-primary btn-pagination';
        nextBtn.className = currentDay === totalDays ? 
            'btn btn-sm btn-outline-secondary btn-pagination' : 
            'btn btn-sm btn-outline-primary btn-pagination';
        
        // Scroll al top
        const cardBody = document.querySelector('.card-body');
        if (cardBody) cardBody.scrollTop = 0;
    }
    
    prevBtn.addEventListener('click', function() {
        if (currentDay > 1) {
            currentDay--;
            updateDayDisplay();
        }
    });
    
    nextBtn.addEventListener('click', function() {
        if (currentDay < totalDays) {
            currentDay++;
            updateDayDisplay();
        }
    });
    
    // Inicializar vista
    updateDayDisplay();
}

// ==========================================
// CONTADORES ANIMADOS
// ==========================================
function initializeCounters() {
    const counters = document.querySelectorAll('.counter');
    const speed = 200;
    
    const animateCounter = (counter) => {
        const target = parseFloat(counter.getAttribute('data-target'));
        const count = parseFloat(counter.innerText) || 0;
        const increment = target / speed;
        
        if (count < target) {
            const newCount = Math.ceil(count + increment);
            if (target % 1 === 0) {
                counter.innerText = newCount.toLocaleString('es-ES');
            } else {
                counter.innerText = newCount.toFixed(2);
            }
            setTimeout(() => animateCounter(counter), 1);
        } else {
            if (target % 1 === 0) {
                counter.innerText = target.toLocaleString('es-ES');
            } else {
                counter.innerText = target.toFixed(2);
            }
        }
    };
    
    // Observer para activar cuando sea visible
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                animateCounter(entry.target);
                observer.unobserve(entry.target);
            }
        });
    });
    
    counters.forEach(counter => {
        observer.observe(counter);
    });
}

// ==========================================
// PAGINACIÓN DE TABLAS
// ==========================================
function initializeTablePagination() {
    const table = document.getElementById('demandTable');
    if (!table) return;
    
    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    const totalPages = Math.ceil(rows.length / rowsPerPage);
    
    const prevBtn = document.getElementById('prevTablePage');
    const nextBtn = document.getElementById('nextTablePage');
    const pageInfo = document.getElementById('tablePageInfo');
    
    if (!prevBtn || !nextBtn) return;
    
    function updateTableDisplay() {
        // Ocultar todas las filas
        rows.forEach(row => row.style.display = 'none');
        
        // Mostrar filas de la página actual
        const startIndex = (currentPage - 1) * rowsPerPage;
        const endIndex = Math.min(startIndex + rowsPerPage, rows.length);
        
        for (let i = startIndex; i < endIndex; i++) {
            if (rows[i]) {
                rows[i].style.display = 'table-row';
                rows[i].style.animation = 'fadeIn 0.2s ease';
            }
        }
        
        // Actualizar info
        if (pageInfo) pageInfo.textContent = `Página ${currentPage} de ${totalPages}`;
        
        // Actualizar botones
        prevBtn.disabled = currentPage === 1;
        nextBtn.disabled = currentPage === totalPages;
    }
    
    prevBtn.addEventListener('click', function() {
        if (currentPage > 1) {
            currentPage--;
            updateTableDisplay();
        }
    });
    
    nextBtn.addEventListener('click', function() {
        if (currentPage < totalPages) {
            currentPage++;
            updateTableDisplay();
        }
    });
    
    updateTableDisplay();
}

// ==========================================
// MODALES UNIFICADOS
// ==========================================
function initializeModals() {
    // Cerrar con ESC
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeAllModals();
        }
    });
    
    // Cerrar al hacer clic fuera
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('modal')) {
            closeAllModals();
        }
    });
}

function closeAllModals() {
    const modals = document.querySelectorAll('.modal.show');
    modals.forEach(modal => {
        const bsModal = bootstrap.Modal.getInstance(modal);
        if (bsModal) bsModal.hide();
    });
}

// ==========================================
// FUNCIONES DE GRÁFICOS UNIFICADAS
// ==========================================
function initializeChartInteractions() {
    // Click en imágenes para expandir
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('chart-image')) {
            const src = e.target.src;
            const alt = e.target.alt;
            const base64Data = src.split(',')[1];
            if (base64Data) {
                openFullscreen(base64Data, alt);
            }
        }
    });
}

function downloadChart(chartData, filename) {
    try {
        if (!chartData) {
            console.warn('No chart data provided for download');
            showNotification('No hay datos del gráfico para descargar', 'warning');
            return;
        }
        
        const link = document.createElement('a');
        link.href = 'data:image/png;base64,' + chartData;
        link.download = filename || 'grafico.png';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showNotification('Gráfico descargado exitosamente', 'success');
    } catch (error) {
        console.error('Error downloading chart:', error);
        showNotification('Error al descargar el gráfico', 'error');
    }
}

function openFullscreen(chartData, title) {
    try {
        if (!chartData) {
            console.warn('No chart data provided for fullscreen');
            return;
        }
        
        const modal = document.getElementById('mainFullscreenModal');
        const modalTitle = document.getElementById('mainFullscreenModalTitle');
        const modalImage = document.getElementById('mainFullscreenModalImage');
        
        if (modal && modalTitle && modalImage) {
            modalTitle.textContent = title || 'Gráfico';
            modalImage.src = 'data:image/png;base64,' + chartData;
            modalImage.setAttribute('data-chart-data', chartData);
            
            new bootstrap.Modal(modal).show();
        }
    } catch (error) {
        console.error('Error opening fullscreen:', error);
        showNotification('Error al abrir el gráfico', 'error');
    }
}

function downloadCurrentChart() {
    try {
        const modalImage = document.getElementById('mainFullscreenModalImage');
        const chartData = modalImage?.getAttribute('data-chart-data');
        const title = document.getElementById('mainFullscreenModalTitle')?.textContent;
        
        if (chartData) {
            const filename = (title || 'grafico').toLowerCase().replace(/\s+/g, '-') + '.png';
            downloadChart(chartData, filename);
        }
    } catch (error) {
        console.error('Error downloading current chart:', error);
        showNotification('Error al descargar el gráfico', 'error');
    }
}

// ==========================================
// EXPORTACIÓN UNIFICADA
// ==========================================
function initializeExportFunctions() {
    window.exportToPDF = async function() {
        const btn = event?.target;
        if (btn) {
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="bx bx-loader-alt bx-spin me-2"></i>Generando PDF...';
            btn.disabled = true;
        }
        
        try {
            const element = document.querySelector('.page-content');
            const canvas = await html2canvas(element, {
                scale: 1.5,
                logging: false,
                useCORS: true,
                allowTaint: true
            });
            
            const imgData = canvas.toDataURL('image/png');
            const pdf = new jspdf.jsPDF({
                orientation: 'landscape',
                unit: 'px',
                format: [canvas.width, canvas.height]
            });
            
            pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
            pdf.save(`simulacion_${new Date().getTime()}_resultados.pdf`);
            
            showNotification('PDF generado exitosamente', 'success');
        } catch (error) {
            console.error('Error generating PDF:', error);
            showNotification('Error al generar PDF', 'error');
        } finally {
            if (btn) {
                btn.innerHTML = btn.dataset.originalText || '<i class="bx bx-file-pdf me-2"></i>Exportar PDF';
                btn.disabled = false;
            }
        }
    };
    
    window.exportToExcel = function() {
        const btn = event?.target;
        if (btn) {
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="bx bx-loader-alt bx-spin me-2"></i>Generando Excel...';
            btn.disabled = true;
        }
        
        try {
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Variable,Valor Total,Unidad,Promedio,Tendencia\n";
            
            // Obtener datos de la tabla de variables
            const rows = document.querySelectorAll('#endogenousTableBody tr');
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 5) {
                    const variable = cells[0].textContent.trim();
                    const total = cells[1].textContent.trim().replace(/[^\d.-]/g, '');
                    const unit = cells[2].textContent.trim();
                    const average = cells[3].textContent.trim().replace(/[^\d.-]/g, '');
                    const trend = cells[4].textContent.trim();
                    
                    csvContent += `"${variable}","${total}","${unit}","${average}","${trend}"\n`;
                }
            });
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `simulacion_${new Date().getTime()}_resultados.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification('Archivo Excel generado exitosamente', 'success');
        } catch (error) {
            console.error('Error generating Excel:', error);
            showNotification('Error al generar Excel', 'error');
        } finally {
            if (btn) {
                btn.innerHTML = '<i class="bx bx-file me-2"></i>Exportar Excel';
                btn.disabled = false;
            }
        }
    };
}

// ==========================================
// GRÁFICOS DE VALIDACIÓN
// ==========================================
function initializeValidationCharts() {
    initializeValidationPrecisionChart();
    initializeValidationSummaryChart();
}

function initializeValidationPrecisionChart() {
    const ctx = document.getElementById('validationPrecisionChart');
    if (!ctx) return;
    
    if (validationPrecisionChart) {
        validationPrecisionChart.destroy();
    }
    
    const tableRows = document.querySelectorAll('#validationDetailTable tbody tr');
    const labels = [];
    const errorData = [];
    const colors = [];
    
    tableRows.forEach(row => {
        const day = row.querySelector('td:first-child')?.textContent;
        const errorCell = row.querySelector('td:nth-child(7) span');
        if (day && errorCell) {
            const errorValue = parseFloat(errorCell.textContent);
            
            labels.push(`Día ${day}`);
            errorData.push(errorValue);
            
            if (errorValue < 10) {
                colors.push('rgba(40, 167, 69, 0.8)');
            } else if (errorValue < 20) {
                colors.push('rgba(255, 193, 7, 0.8)');
            } else {
                colors.push('rgba(220, 53, 69, 0.8)');
            }
        }
    });
    
    const config = {
        type: currentChartType,
        data: {
            labels: labels,
            datasets: [{
                label: 'Error Porcentual (%)',
                data: errorData,
                backgroundColor: colors,
                borderColor: colors.map(c => c.replace('0.8', '1')),
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Distribución de Error Porcentual por Día'
                },
                legend: { display: false }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: { display: true, text: 'Error Porcentual (%)' }
                }
            }
        }
    };
    
    validationPrecisionChart = new Chart(ctx, config);
}

function initializeValidationSummaryChart() {
    const ctx = document.getElementById('validationSummaryChart');
    if (!ctx) return;
    
    if (validationSummaryChart) {
        validationSummaryChart.destroy();
    }
    
    // Obtener datos del template
    const preciseCount = parseInt(document.querySelector('[data-precise-count]')?.dataset.preciseCount) || 0;
    const acceptableCount = parseInt(document.querySelector('[data-acceptable-count]')?.dataset.acceptableCount) || 0;
    const inaccurateCount = parseInt(document.querySelector('[data-inaccurate-count]')?.dataset.inaccurateCount) || 0;
    
    const config = {
        type: 'doughnut',
        data: {
            labels: ['Precisa (<10%)', 'Aceptable (10-20%)', 'Inexacta (>20%)'],
            datasets: [{
                data: [preciseCount, acceptableCount, inaccurateCount],
                backgroundColor: [
                    'rgba(40, 167, 69, 0.8)',
                    'rgba(255, 193, 7, 0.8)',
                    'rgba(220, 53, 69, 0.8)'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom' }
            }
        }
    };
    
    validationSummaryChart = new Chart(ctx, config);
}

function toggleValidationChartType() {
    currentChartType = currentChartType === 'bar' ? 'line' : 'bar';
    initializeValidationPrecisionChart();
}

function downloadValidationChart() {
    if (!validationPrecisionChart) return;
    
    const url = validationPrecisionChart.toBase64Image();
    const link = document.createElement('a');
    link.download = 'distribucion_precision_' + new Date().getTime() + '.png';
    link.href = url;
    link.click();
}

// ==========================================
// VARIABLES ENDÓGENAS
// ==========================================
function updateVariableCounts() {
    try {
        const rows = document.querySelectorAll('#endogenousTableBody tr[data-category]');
        let financial = 0, operational = 0, quality = 0;
        
        rows.forEach(row => {
            const category = row.dataset.category;
            if (category === 'financial') financial++;
            else if (category === 'operational') operational++;
            else if (category === 'quality') quality++;
        });
        
        const financialCount = document.getElementById('financialVarsCount');
        const operationalCount = document.getElementById('operationalVarsCount');
        const qualityCount = document.getElementById('qualityVarsCount');
        
        if (financialCount) financialCount.textContent = financial;
        if (operationalCount) operationalCount.textContent = operational;
        if (qualityCount) qualityCount.textContent = quality;
    } catch (error) {
        console.error('Error updating variable counts:', error);
    }
}

function expandChart(chartName, imageSrc) {
    try {
        const modal = document.getElementById('mainFullscreenModal');
        const modalTitle = document.getElementById('mainFullscreenModalTitle');
        const modalImage = document.getElementById('mainFullscreenModalImage');
        
        if (modal && modalTitle && modalImage) {
            modalTitle.textContent = `Gráfico: ${chartName}`;
            modalImage.src = imageSrc || '';
            
            new bootstrap.Modal(modal).show();
        }
    } catch (error) {
        console.error('Error expanding chart:', error);
    }
}

function showVariableDetails(variableName) {
    try {
        const row = document.querySelector(`tr[data-variable="${variableName}"]`);
        if (!row) return;
        
        const modal = document.getElementById('mainDetailsModal');
        const modalTitle = document.getElementById('mainDetailsModalTitle');
        const modalBody = document.getElementById('mainDetailsModalBody');
        
        if (modal && modalTitle && modalBody) {
            modalTitle.textContent = `Detalles: ${variableName}`;
            
            const category = row.dataset.category || 'unknown';
            const trend = row.dataset.trend || 'stable';
            const totalElement = row.querySelector('.variable-total');
            const unitElement = row.querySelector('.variable-unit');
            const averageElement = row.querySelector('.variable-average');
            
            const total = totalElement?.textContent.trim() || 'N/A';
            const unit = unitElement?.textContent.trim() || 'N/A';
            const average = averageElement?.textContent.trim() || 'N/A';
            
            modalBody.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Información General</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Variable:</strong></td><td>${variableName}</td></tr>
                            <tr><td><strong>Categoría:</strong></td><td class="text-capitalize">${category}</td></tr>
                            <tr><td><strong>Unidad:</strong></td><td>${unit}</td></tr>
                            <tr><td><strong>Tendencia:</strong></td><td class="text-capitalize">${trend}</td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>Valores</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Total:</strong></td><td>${total}</td></tr>
                            <tr><td><strong>Promedio:</strong></td><td>${average}</td></tr>
                        </table>
                    </div>
                </div>
                <div class="mt-3">
                    <h6>Descripción</h6>
                    <p class="text-muted">${getVariableDescription(variableName)}</p>
                </div>
            `;
            
            new bootstrap.Modal(modal).show();
        }
    } catch (error) {
        console.error('Error showing variable details:', error);
    }
}

function getVariableDescription(variableName) {
    const descriptions = {
        'IT': 'Ingresos Totales: Suma de todos los ingresos generados durante el período de simulación.',
        'GT': 'Ganancia Total: Diferencia entre ingresos totales y gastos totales del período.',
        'TG': 'Total Gastos: Suma de todos los costos y gastos incurridos durante la simulación.',
        'TPV': 'Total Productos Vendidos: Cantidad total de productos vendidos en el período.',
        'NSC': 'Nivel de Satisfacción del Cliente: Indicador de calidad del servicio prestado.',
        'EOG': 'Eficiencia Operativa General: Medida de la eficiencia en los procesos operativos.',
        'NR': 'Nivel de Rentabilidad: Porcentaje de ganancia sobre los ingresos totales.',
        'PVP': 'Precio de Venta al Público: Precio unitario de venta del producto.',
        'CFD': 'Costo Fijo Diario: Costos fijos que se incurren diariamente.',
        'CVU': 'Costo Variable Unitario: Costo variable por unidad producida.',
        'DPH': 'Demanda Promedio Histórica: Promedio histórico de la demanda.',
        'CPROD': 'Capacidad de Producción: Capacidad máxima de producción diaria.',
        'NEPP': 'Número de Empleados en Producción: Personal asignado a producción.'
    };
    
    return descriptions[variableName] || `Variable endógena ${variableName} del modelo de simulación.`;
}

// ==========================================
// EVENTOS DE PESTAÑAS
// ==========================================
function initializeTabEvents() {
    // Inicializar contenido cuando se muestre una pestaña
    document.addEventListener('shown.bs.tab', function(e) {
        const targetId = e.target.getAttribute('aria-controls');
        
        switch(targetId) {
            case 'endogenous':
                setTimeout(updateVariableCounts, 100);
                break;
            case 'validation':
                setTimeout(initializeValidationCharts, 100);
                break;
        }
        
        // Animar entrada de contenido
        const targetPane = document.getElementById(targetId);
        if (targetPane) {
            targetPane.style.animation = 'fadeIn 0.3s ease';
        }
    });
}

// ==========================================
// ATAJOS DE TECLADO
// ==========================================
function initializeKeyboardShortcuts() {
    document.addEventListener('keydown', function(e) {
        // Navegación de días con Ctrl + Flechas
        if (e.ctrlKey || e.metaKey) {
            if (e.key === 'ArrowLeft' && currentDay > 1) {
                e.preventDefault();
                currentDay--;
                document.querySelectorAll('.daily-result-item').forEach(item => {
                    item.style.display = item.dataset.day == currentDay ? 'block' : 'none';
                });
                updateDayCounters();
            } else if (e.key === 'ArrowRight' && currentDay < totalDays) {
                e.preventDefault();
                currentDay++;
                document.querySelectorAll('.daily-result-item').forEach(item => {
                    item.style.display = item.dataset.day == currentDay ? 'block' : 'none';
                });
                updateDayCounters();
            }
        }
    });
}

function updateDayCounters() {
    const dayCounter = document.getElementById('dayCounter');
    const currentDayIndicator = document.getElementById('currentDayIndicator');
    
    if (dayCounter) dayCounter.textContent = `Día ${currentDay} de ${totalDays}`;
    if (currentDayIndicator) currentDayIndicator.textContent = `Día ${currentDay}`;
}

// ==========================================
// FUNCIONES AUXILIARES
// ==========================================
function initializeTooltips() {
    // Agregar estilos de animación
    if (!document.getElementById('custom-animations')) {
        const style = document.createElement('style');
        style.id = 'custom-animations';
        style.textContent = `
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(10px); }
                to { opacity: 1; transform: translateY(0); }
            }
            @keyframes fadeOut {
                from { opacity: 1; transform: translateY(0); }
                to { opacity: 0; transform: translateY(-10px); }
            }
            .cursor-pointer { cursor: pointer; }
        `;
        document.head.appendChild(style);
    }
}

function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 10000; min-width: 300px;';
    
    const icon = type === 'success' ? 'bx-check-circle' : 
                 type === 'error' ? 'bx-error' : 
                 'bx-info-circle';
    
    notification.innerHTML = `
        <i class="bx ${icon} me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);
}

function hideTutorial() {
    const tutorial = document.getElementById('resultsTutorial');
    if (tutorial) {
        tutorial.style.animation = 'fadeOut 0.5s ease-out';
        setTimeout(() => {
            tutorial.style.display = 'none';
        }, 500);
        localStorage.setItem('resultsViewedBefore', 'true');
    }
}

function shareResults() {
    if (navigator.share) {
        navigator.share({
            title: 'Resultados de Simulación',
            text: 'Mira los resultados de mi simulación de negocio',
            url: window.location.href
        }).then(() => {
            showNotification('Compartido exitosamente', 'success');
        }).catch((error) => {
            console.log('Error sharing:', error);
        });
    } else {
        navigator.clipboard.writeText(window.location.href).then(() => {
            showNotification('Enlace copiado al portapapeles', 'success');
        });
    }
}

// Exportar validación de resultados
function exportValidationResults() {
    try {
        let csv = 'Día,Fecha,Producto,Empresa,Demanda Simulada (L),Demanda Real (L),Diferencia (L),Error %,Veredicto\n';
        
        const tableRows = document.querySelectorAll('#validationDetailTable tbody tr.validation-row');
        
        tableRows.forEach(row => {
            const cells = row.querySelectorAll('td');
            if (cells.length >= 8) {
                const day = cells[0].textContent.trim();
                const date = cells[1].textContent.trim();
                const productInfo = cells[2].textContent.trim().split('\n');
                const product = productInfo[0].trim();
                const business = productInfo[1] ? productInfo[1].trim() : '';
                const simulated = cells[3].textContent.replace(' L', '').trim();
                const real = cells[4].textContent.replace(' L', '').trim();
                const difference = cells[5].textContent.replace(' L', '').replace('+', '').trim();
                const error = cells[6].querySelector('span')?.textContent.replace('%', '').trim() || '0';
                const verdict = cells[7].textContent.trim();
                
                csv += `${day},"${date}","${product}","${business}",${simulated},${real},${difference},${error},"${verdict}"\n`;
            }
        });
        
        // Agregar totales si existen
        const footerCells = document.querySelectorAll('#validationDetailTable tfoot td');
        if (footerCells.length > 0) {
            csv += '\nTotales/Promedios,,,,' + 
                   footerCells[3]?.textContent.replace(' L', '').trim() + ',' +
                   footerCells[4]?.textContent.replace(' L', '').trim() + ',' +
                   footerCells[5]?.textContent.replace(' L', '').replace('+', '').trim() + ',' +
                   footerCells[6]?.querySelector('span')?.textContent.replace('%', '').trim() + ',';
        }
        
        // Descargar archivo
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'validacion_modelo_' + new Date().getTime() + '.csv';
        link.click();
        
        showNotification('Resultados exportados exitosamente', 'success');
    } catch (error) {
        console.error('Error exporting validation results:', error);
        showNotification('Error al exportar resultados', 'error');
    }
}

// Exportar validación de variables
function exportVariablesValidation() {
    try {
        let csv = 'Variable,Descripción,Unidad,Valor Real Promedio,Valor Simulado Promedio,Error Promedio %,Días Válidos,Veredicto\n';
        
        const rows = document.querySelectorAll('#variablesValidationTable tbody tr');
        rows.forEach(row => {
            const cells = row.querySelectorAll('td');
            if (cells.length >= 8) {
                const variable = cells[0].querySelector('strong')?.textContent || '';
                const description = cells[1].textContent.trim();
                const unit = cells[2].textContent.trim();
                const realAvg = cells[3].textContent.replace(/[^\d.-]/g, '');
                const simAvg = cells[4].textContent.replace(/[^\d.-]/g, '');
                const errorAvg = cells[5].querySelector('span')?.textContent.replace('%', '') || '0';
                const validDays = cells[6].textContent.trim();
                const verdict = cells[7].textContent.trim();
                
                csv += `"${variable}","${description}","${unit}",${realAvg},${simAvg},${errorAvg},"${validDays}","${verdict}"\n`;
            }
        });
        
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'validacion_variables_' + new Date().getTime() + '.csv';
        link.click();
        
        showNotification('Validación de variables exportada exitosamente', 'success');
    } catch (error) {
        console.error('Error exporting variables validation:', error);
        showNotification('Error al exportar validación de variables', 'error');
    }
}

// Exportar tabla de variables endógenas
function exportEndogenousTable(format) {
    try {
        const table = document.getElementById('endogenousTable');
        const rows = table.querySelectorAll('tbody tr[data-variable]');
        
        if (format === 'excel' || format === 'csv') {
            let csvContent = 'Variable,Valor Total,Unidad,Promedio Diario,Tendencia,Rango,Volatilidad\n';
            
            rows.forEach(row => {
                if (row.style.display !== 'none') {
                    const variable = row.dataset.variable;
                    const total = row.querySelector('.variable-total')?.textContent.replace(/[,]/g, '') || '';
                    const unit = row.querySelector('.variable-unit')?.textContent || '';
                    const average = row.querySelector('.variable-average')?.textContent.replace(/[,]/g, '') || '';
                    const trend = row.dataset.trend || '';
                    const range = row.querySelector('.variable-range')?.textContent || '';
                    const volatility = row.querySelector('.variable-volatility')?.textContent || '';
                    
                    csvContent += `"${variable}","${total}","${unit}","${average}","${trend}","${range}","${volatility}"\n`;
                }
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'variables_endogenas_' + new Date().getTime() + '.csv';
            link.click();
            
            showNotification('Variables endógenas exportadas exitosamente', 'success');
        } else if (format === 'pdf') {
            window.print();
        }
    } catch (error) {
        console.error('Error exporting endogenous table:', error);
        showNotification('Error al exportar tabla', 'error');
    }
}

// ==========================================
// FUNCIONES ESPECÍFICAS DE GRÁFICOS
// ==========================================

// Cargar gráficos de validación por lotes
function loadInitialCharts() {
    const container = document.getElementById('chartsContainer');
    const loadedContainer = document.getElementById('loadedChartsContainer');
    
    if (container) container.style.display = 'none';
    if (loadedContainer) loadedContainer.style.display = 'block';
    
    loadMoreCharts();
}

function loadMoreCharts() {
    const container = document.getElementById('chartsGrid');
    if (!container) return;
    
    const remaining = allCharts.length - loadedCharts;
    const toLoad = Math.min(CHARTS_PER_BATCH, remaining);
    
    for (let i = loadedCharts; i < loadedCharts + toLoad; i++) {
        if (allCharts[i]) {
            const chartHtml = createChartCard(allCharts[i]);
            container.insertAdjacentHTML('beforeend', chartHtml);
        }
    }
    
    loadedCharts += toLoad;
    
    // Actualizar botón de cargar más
    const loadMoreContainer = document.getElementById('loadMoreContainer');
    const remainingCount = document.getElementById('remainingCount');
    
    if (loadMoreContainer && remainingCount) {
        const newRemaining = allCharts.length - loadedCharts;
        if (newRemaining > 0) {
            loadMoreContainer.style.display = 'block';
            remainingCount.textContent = `(${newRemaining} restantes)`;
        } else {
            loadMoreContainer.style.display = 'none';
        }
    }
}

function createChartCard(chartData) {
    const statusClass = chartData.status === 'PRECISA' ? 'success' : 
                       chartData.status === 'ACEPTABLE' ? 'warning' : 'danger';
    
    return `
        <div class="col-lg-6 mb-4 chart-card" data-variable="${chartData.variable}" data-type="${chartData.type}">
            <div class="card h-100 shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-0">${chartData.variable}</h6>
                        <small class="text-muted">${chartData.description}</small>
                    </div>
                    <span class="badge bg-${statusClass}">
                        ${chartData.error_pct?.toFixed(1) || 0}% error
                    </span>
                </div>
                <div class="card-body p-2">
                    <img src="data:image/png;base64,${chartData.chart}" 
                         class="img-fluid validation-chart-img" 
                         alt="Gráfico de ${chartData.variable}"
                         onclick="expandChart('${chartData.variable}', this.src)">
                </div>
                <div class="card-footer bg-light">
                    <div class="row text-center small">
                        <div class="col-4">
                            <strong>Unidad:</strong><br>${chartData.unit || 'N/A'}
                        </div>
                        <div class="col-4">
                            <strong>Días:</strong><br>${chartData.days_count || 0}
                        </div>
                        <div class="col-4">
                            <strong>Cobertura:</strong><br>${chartData.coverage?.toFixed(0) || 0}%
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
}

// Filtrar gráficos por tipo
function filterChartsByType() {
    const filter = document.getElementById('chartTypeFilter')?.value || '';
    const chartCards = document.querySelectorAll('.chart-card');
    
    chartCards.forEach(card => {
        const cardType = card.dataset.type;
        if (!filter || cardType === filter) {
            card.style.display = '';
        } else {
            card.style.display = 'none';
        }
    });
}

// ==========================================
// GESTIÓN DE PERFORMANCE Y MEMORIA
// ==========================================
function checkPerformance() {
    if ('performance' in window && 'memory' in performance) {
        const memoryUsage = performance.memory.usedJSHeapSize / 1048576;
        console.log(`Memory usage: ${memoryUsage.toFixed(2)} MB`);
        
        if (memoryUsage > 500) {
            console.warn('High memory usage detected. Consider closing other tabs.');
        }
    }
}

// Monitorear rendimiento cada 30 segundos
setInterval(checkPerformance, 30000);

// Lazy loading de imágenes
function setupLazyLoading() {
    if ('IntersectionObserver' in window) {
        const imageObserver = new IntersectionObserver((entries, observer) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const img = entry.target;
                    if (img.dataset.src) {
                        img.src = img.dataset.src;
                        img.classList.remove('lazy');
                        observer.unobserve(img);
                    }
                }
            });
        });
        
        document.querySelectorAll('img[data-src]').forEach(img => {
            imageObserver.observe(img);
        });
    }
}

// ==========================================
// EVENTOS DE IMPRESIÓN
// ==========================================
window.addEventListener('beforeprint', function() {
    // Expandir secciones colapsadas para impresión
    document.querySelectorAll('.collapse').forEach(el => {
        el.classList.add('show');
    });
    
    // Mostrar todos los días para impresión
    document.querySelectorAll('.daily-result-item').forEach(item => {
        item.style.display = 'block';
    });
});

window.addEventListener('afterprint', function() {
    // Restaurar estado después de impresión
    document.querySelectorAll('.daily-result-item').forEach((item, index) => {
        item.style.display = index === currentDay - 1 ? 'block' : 'none';
    });
});

// ==========================================
// GESTIÓN DE ERRORES GLOBAL
// ==========================================
window.addEventListener('error', function(e) {
    console.error('Global error:', e.error);
    
    // Manejar errores de carga de imágenes
    if (e.target.tagName === 'IMG' && e.target.classList.contains('chart-image')) {
        e.target.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjBmMGYwIi8+CiAgPHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxOCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkVycm9yIGNhcmdhbmRvIGdyw6FmaWNvPC90ZXh0Pgo8L3N2Zz4=';
        e.target.classList.remove('lazy');
    }
});

// ==========================================
// INICIALIZACIÓN FINAL
// ==========================================
console.log('Simulate Result Unified Script loaded successfully');

// Exportar funciones globales necesarias
window.downloadChart = downloadChart;
window.openFullscreen = openFullscreen;
window.downloadCurrentChart = downloadCurrentChart;
window.exportToPDF = exportToPDF;
window.exportToExcel = exportToExcel;
window.shareResults = shareResults;
window.hideTutorial = hideTutorial;
window.showVariableDetails = showVariableDetails;
window.expandChart = expandChart;
window.updateVariableCounts = updateVariableCounts;
window.toggleValidationChartType = toggleValidationChartType;
window.downloadValidationChart = downloadValidationChart;
window.exportValidationResults = exportValidationResults;
window.exportVariablesValidation = exportVariablesValidation;
window.exportEndogenousTable = exportEndogenousTable;
window.loadInitialCharts = loadInitialCharts;
window.loadMoreCharts = loadMoreCharts;
window.filterChartsByType = filterChartsByType;
</script>
{% endblock extra_js %}