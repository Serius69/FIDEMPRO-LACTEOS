{% extends "partials/base.html" %}
{% load static %}
{% block title %}{% if product.name %}{{ product.name }}{% else %}Producto{% endif %} - Descripción{% endblock title %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/product-overview.css' %}">
{% endblock extra_css %}

{% block content %}
<!-- Main Content -->
<div class="main-content">
    <div class="page-content">
        <div class="container-fluid">
            <!-- Page Title Section -->
            {% block pagetitle %}
            {% include "partials/page-title.html" with pagetitle="Producto" title=product.name|default:"Sin nombre" %}
            {% endblock pagetitle %}
            
            <!-- Product Header Section -->
            <div class="row">
                <div class="col-lg-12">
                    <div class="product-header-card">
                        <div class="product-header-content">
                            <div class="row mb-1">
                                <!-- Product Image -->
                                <div class="col-lg-3 col-md-4 col-sm-6">
                                    <div class="product-image-container" 
                                         style="background-image: url('{% if product.get_photo_url %}{{ product.get_photo_url }}{% else %}{% static 'images/default-product.png' %}{% endif %}');">
                                    </div>
                                </div>
                                
                                <!-- Product Details -->
                                <div class="col-lg-9 col-md-8 col-sm-6">
                                    <!-- Product Info Card -->
                                    <div class="product-info-card">
                                        <div class="product-basic-info">
                                            <h4 class="product-title">{% if product.name %}{{ product.name }}{% else %}Producto sin nombre{% endif %}</h4>
                                            <ul class="product-meta-list">
                                                <li class="meta-item">
                                                    <i class="ri-building-line me-1"></i>
                                                    {% if product.fk_business.name %}{{ product.fk_business.name }}{% else %}Sin negocio{% endif %}
                                                </li>
                                                <li class="meta-item">
                                                    Fecha de Creación: 
                                                    <span class="meta-value">
                                                        {% if product.date_created %}{{ product.date_created }}{% else %}No disponible{% endif %}
                                                    </span>
                                                </li>
                                                <li class="meta-item">
                                                    Fecha actualizada: 
                                                    <span class="meta-value">
                                                        {% if product.last_updated %}{{ product.last_updated }}{% else %}No disponible{% endif %}
                                                    </span>
                                                </li>
                                                {% if product.date_created %}
                                                    {% with days_since_creation=product.date_created|timesince:current_datetime %}
                                                        {% if "day" in days_since_creation and days_since_creation|add:0 <= 5 %}
                                                            <li class="meta-item">
                                                                <span class="badge rounded-pill bg-info">Nuevo</span>
                                                            </li>
                                                        {% endif %}
                                                    {% endwith %}
                                                {% endif %}
                                            </ul>
                                        </div>
                                    </div>
                                    
                                    <!-- Product Description Card -->
                                    <div class="product-description-card">
                                        <div class="description-content">
                                            <h6 class="description-title">Descripción</h6>
                                            <p class="description-text">
                                                {% if product.description %}{{ product.description }}{% else %}Sin descripción disponible{% endif %}
                                            </p>
                                            
                                            <div class="product-metadata">
                                                <div class="row">
                                                    <div class="col-lg-3 col-sm-6">
                                                        <div class="metadata-item">
                                                            <p class="metadata-label">Fecha de Creación:</p>
                                                            <h5 class="metadata-value">
                                                                {% if product.date_created %}{{ product.date_created|date:"F j, Y, P" }}{% else %}No disponible{% endif %}
                                                            </h5>
                                                        </div>
                                                    </div>
                                                    <div class="col-lg-3 col-sm-6">
                                                        <div class="metadata-item">
                                                            <p class="metadata-label">Fecha de actualización:</p>
                                                            <h5 class="metadata-value">
                                                                {% if product.last_updated %}{{ product.last_updated|date:"F j, Y, P" }}{% else %}No disponible{% endif %}
                                                            </h5>
                                                        </div>
                                                    </div>
                                                    <div class="col-lg-3 col-sm-6">
                                                        <div class="metadata-item">
                                                            <p class="metadata-label">Listo para simular:</p>
                                                            {% if product.is_ready %}
                                                                <div class="badge bg-success fs-12">Listo</div>
                                                            {% else %}
                                                                <div class="badge bg-danger fs-12">No Listo</div>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                    <div class="col-lg-3 col-sm-6">
                                                        <div class="metadata-item">
                                                            <p class="metadata-label">Tipo de producto:</p>
                                                            {% if product.type == 1 %}
                                                                <div class="badge bg-warning fs-12">Lácteos</div>
                                                            {% elif product.type == 2 %}
                                                                <div class="badge bg-info fs-12">Bebidas</div>
                                                            {% elif product.type == 3 %}
                                                                <div class="badge bg-success fs-12">Alimentos</div>
                                                            {% else %}
                                                                <div class="badge bg-secondary fs-12">Otros</div>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Product Navigation Tabs -->
                            <div class="product-tabs">
                                <ul class="nav nav-tabs-custom border-bottom-0" role="tablist">
                                    <li class="nav-item">
                                        <a class="nav-link active fw-semibold" data-bs-toggle="tab" href="#product-overview" role="tab">
                                            <i class="ri-eye-line me-2"></i>Descripción general
                                        </a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link fw-semibold" data-bs-toggle="tab" href="#product-variable" role="tab">
                                            <i class="ri-bubble-chart-line me-2"></i>Variables
                                        </a>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Content Tabs Section -->
            <div class="row">
                <div class="col-lg-12">
                    <div class="tab-content text-muted">
                        <!-- Overview Tab -->
                        <div class="tab-pane fade show active" id="product-overview" role="tabpanel">
                            <div class="row">
                                <!-- Areas and Reports Section -->
                                <div class="col-xl-9 col-lg-8">
                                    <!-- Areas Section -->
                                    <div class="areas-section">
                                        <div class="section-header">
                                            <h4 class="section-title">
                                                <i class="ri-map-pin-line me-2"></i>Áreas
                                            </h4>
                                            <div class="section-actions">
                                                <button type="button" class="btn btn-soft-danger btn-sm" 
                                                        data-bs-toggle="modal" data-bs-target="#addOrUpdateArea">
                                                    <i class="ri-share-line me-1 align-bottom"></i>Añadir área
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <div class="areas-grid">
                                            {% for area in areas %}
                                            <div class="area-card">
                                                <div class="area-image" 
                                                     style="background-image: url('{% if area.get_photo_url %}{{ area.get_photo_url }}{% else %}{% static 'images/default-area.png' %}{% endif %}');">
                                                </div>
                                                <div class="area-content">
                                                    <h5 class="area-name">{% if area.name %}{{ area.name }}{% else %}Área sin nombre{% endif %}</h5>
                                                    <p class="area-description">{% if area.description %}{{ area.description }}{% else %}Sin descripción{% endif %}</p>
                                                </div>
                                                <div class="area-footer">
                                                    <div class="area-stats">
                                                        <div class="stat-item">
                                                            <i class="ri-function-line me-1"></i>
                                                            <span class="stat-value">{% if area.fk_area_equations.count %}{{ area.fk_area_equations.count }}{% else %}0{% endif %}</span>
                                                        </div>
                                                    </div>
                                                    <div class="area-actions">
                                                        <div class="dropdown">
                                                            <button class="area-menu-btn" data-bs-toggle="dropdown" 
                                                                    aria-haspopup="true" aria-expanded="false">
                                                                <i data-feather="more-horizontal" class="icon-sm"></i>
                                                            </button>
                                                            <div class="dropdown-menu dropdown-menu-end">
                                                                <a class="dropdown-item" href="{% url 'product:area.overview' area.id %}">
                                                                    <i class="ri-eye-fill align-bottom me-2 text-muted"></i>
                                                                    Vista
                                                                </a>
                                                                <a href="{% url 'product:area.edit' area.id %}" class="dropdown-item edit-area">
                                                                    <i class="ri-pencil-fill align-bottom me-2 text-muted"></i>
                                                                    Editar
                                                                </a>
                                                                <div class="dropdown-divider"></div>
                                                                <a class="dropdown-item delete-area" 
                                                                   onclick="deleteArea('{{ area.id }}'); return false;">
                                                                    <i class="ri-delete-bin-fill align-bottom me-2 text-muted"></i>
                                                                    Eliminar
                                                                </a>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            {% empty %}
                                            <div class="empty-state">
                                                <lord-icon src="https://cdn.lordicon.com/msoeawqm.json" trigger="loop" 
                                                           colors="primary:#405189,secondary:#0ab39c" style="width:75px;height:75px">
                                                </lord-icon>
                                                <h5 class="empty-title">No hay ningún área registrada</h5>
                                                <p class="empty-description">Debe agregar un área para comenzar.</p>