<!-- Modal para Crear/Editar Producto -->
{% load static %}
<div class="modal fade zoomIn" id="addOrUpdateProduct" tabindex="-1" aria-labelledby="addProductLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addOrUpdateProductLabel">Crear Producto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <!-- Loading indicator -->
                <div id="modalLoading" class="text-center py-4" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                    <p class="mt-2 text-muted">Cargando datos del producto...</p>
                </div>
                
                <!-- Form content -->
                <div id="modalContent">
                    <div class="tab-content">
                        <div class="tab-pane active" id="productDetails" role="tabpanel">
                            <form id="productForm" enctype="multipart/form-data">
                                {% csrf_token %}
                                
                                <!-- Alert for form errors -->
                                <div id="formAlerts" style="display: none;"></div>
                                
                                <div class="row">
                                    <div class="col-lg-12">
                                        <div class="text-center mb-4 mt-n5 pt-2">
                                            <div class="position-relative d-inline-block">
                                                <div class="position-absolute bottom-0 end-0">
                                                    <label for="product_image_src" class="mb-0" data-bs-toggle="tooltip" data-bs-placement="right" title="Seleccionar Imagen">
                                                        <div class="avatar-xs cursor-pointer">
                                                            <div class="avatar-title bg-light border rounded-circle text-muted">
                                                                <i class="ri-image-fill"></i>
                                                            </div>
                                                        </div>
                                                    </label>
                                                    <input class="form-control d-none" value="" id="product_image_src" type="file" 
                                                           accept="image/png, image/jpeg, image/jpg" name="image_src"/>
                                                </div>
                                                <div class="avatar-lg p-1">
                                                    <div class="avatar-title bg-light rounded-circle">
                                                        <img src="{% static 'images/default-product.png' %}" id="product_logo_img" 
                                                             class="avatar-md rounded-circle object-fit-cover"/>
                                                    </div>
                                                </div>
                                            </div>
                                            <h5 class="fs-13 mt-3">Imagen del Producto</h5>
                                            <p class="text-muted fs-12">Formatos permitidos: JPG, PNG (máx. 2MB)</p>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="product_name" class="form-label">Nombre del Producto <span class="text-danger">*</span></label>
                                            <input type="text" class="form-control" id="product_name" name="name"
                                                placeholder="Introduce el nombre del producto" required maxlength="100"/>
                                            <div class="invalid-feedback"></div>
                                            <div class="form-text">Mínimo 3 caracteres, máximo 100</div>
                                        </div>
                                    </div>
                                    <!--end col-->
                                    
                                    <div class="col-lg-6">
                                        <div class="mb-3">
                                            <label for="product_type" class="form-label">Tipo de Producto <span class="text-danger">*</span></label>
                                            <select class="form-control" id="product_type" name="type" required>
                                                <option value="">Selecciona tipo</option>
                                                <option value="1">Lácteos</option>
                                                <option value="2">Bebidas</option>
                                                <option value="3">Alimentos</option>
                                                <option value="4">Otros</option>
                                            </select>
                                            <div class="invalid-feedback"></div>
                                        </div>
                                    </div>
                                    <!--end col-->
                                    
                                    <div class="col-lg-6">
                                        <div class="mb-3">
                                            <label for="product_fk_business" class="form-label">Negocio <span class="text-danger">*</span></label>
                                            <select class="form-control" id="product_fk_business" name="fk_business" required>
                                                <option value="">Selecciona negocio</option>
                                                {% for business in businesses %}
                                                    <option value="{{ business.id }}">{{ business.name }}</option>
                                                {% empty %}
                                                    <option disabled>No hay negocios disponibles</option>
                                                {% endfor %}
                                            </select>
                                            <div class="invalid-feedback"></div>
                                            {% if not businesses %}
                                            <div class="form-text text-warning">
                                                <i class="ri-warning-line me-1"></i>
                                                Debe crear un negocio antes de agregar productos.
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>       
                                    
                                    <div class="col-lg-12">
                                        <div class="mb-3">
                                            <label for="product_description" class="form-label">Descripción del Producto <span class="text-danger">*</span></label>
                                            <textarea class="form-control" id="product_description" name="description" rows="4"
                                                placeholder="Introduce una descripción detallada del producto" required maxlength="500"></textarea>
                                            <div class="invalid-feedback"></div>
                                            <div class="form-text">
                                                <span id="charCount">0</span>/500 caracteres
                                            </div>
                                        </div>
                                    </div>
                                    <!--end col-->
                                    
                                    <!-- Product status indicator -->
                                    <div class="col-lg-12">
                                        <div class="alert alert-info">
                                            <h6 class="alert-heading">Estado del Producto</h6>
                                            <p class="mb-0">
                                                <i class="ri-information-line me-1"></i>
                                                El producto estará "En desarrollo" hasta que agregue al menos una área y variable.
                                            </p>
                                        </div>
                                    </div>
                                    
                                    <div class="col-lg-12">
                                        <div class="hstack gap-2 justify-content-end">
                                            <button class="btn btn-link link-success text-decoration-none fw-medium"
                                                data-bs-dismiss="modal" type="button">
                                                <i class="ri-close-line me-1 align-middle"></i>
                                                Cancelar
                                            </button>
                                            <input type="hidden" name="product_id" id="product_id" value="">
                                            <button type="submit" class="btn btn-primary" id="submitProductBtn">
                                                <i class="ri-save-3-line align-bottom me-1"></i>
                                                <span id="submitBtnText">Guardar</span>
                                            </button>
                                        </div>
                                    </div>
                                    <!--end col-->
                                </div>
                                <!--end row-->
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!--end modal-->

<!-- Modal para Confirmar Eliminación de Producto -->
<div id="removeProductModal" class="modal fade zoomIn" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" id="close-modal"></button>
            </div>
            <div class="modal-body">
                <!-- Icon and text content -->
                <div class="mt-2 text-center">
                    <lord-icon src="https://cdn.lordicon.com/gsqxdxog.json" trigger="loop" 
                               colors="primary:#f7b84b,secondary:#f06548" style="width: 100px; height: 100px"></lord-icon>
                    <div class="mt-4 pt-2 fs-15 mx-4 mx-sm-5">
                        <h4>¿Está seguro?</h4>
                        <p class="text-muted mx-4 mb-0">
                            ¿Estás seguro de que quieres eliminar este producto?
                            <br><strong class="text-warning">Esta acción no se puede deshacer.</strong>
                        </p>
                    </div>
                </div>
                <!-- Form for deletion -->
                <form id="deleteProductForm" method="POST">
                    {% csrf_token %}
                    <div class="d-flex gap-2 justify-content-center mt-4 mb-2">
                        <button type="button" class="btn w-sm btn-light" data-bs-dismiss="modal">
                            Cancelar
                        </button>
                        <button type="submit" class="btn w-sm btn-danger delete-product-btn">
                            <i class="ri-delete-bin-line me-1"></i>
                            ¡Sí, eliminar!
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript para manejar los modales -->
<script>
// Enhanced product form management
class ProductFormManager {
    constructor() {
        this.modal = document.getElementById('addOrUpdateProduct');
        this.form = document.getElementById('productForm');
        this.modalTitle = document.getElementById('addOrUpdateProductLabel');
        this.productIdField = document.getElementById('product_id');
        this.imagePreview = document.getElementById('product_logo_img');
        this.imageInput = document.getElementById('product_image_src');
        this.submitBtn = document.getElementById('submitProductBtn');
        this.submitBtnText = document.getElementById('submitBtnText');
        this.charCountElement = document.getElementById('charCount');
        this.modalLoading = document.getElementById('modalLoading');
        this.modalContent = document.getElementById('modalContent');
        this.formAlerts = document.getElementById('formAlerts');
        
        this.init();
    }
    
    init() {
        // Image preview handler
        if (this.imageInput) {
            this.imageInput.addEventListener('change', this.handleImagePreview.bind(this));
        }
        
        // Form submission handler
        if (this.form) {
            this.form.addEventListener('submit', this.submitForm.bind(this));
        }
        
        // Modal reset handler
        if (this.modal) {
            this.modal.addEventListener('hidden.bs.modal', this.resetForm.bind(this));
            this.modal.addEventListener('show.bs.modal', this.prepareModal.bind(this));
        }
        
        // Character counter for description
        const descriptionField = document.getElementById('product_description');
        if (descriptionField && this.charCountElement) {
            descriptionField.addEventListener('input', this.updateCharCount.bind(this));
        }
        
        // Real-time validation
        this.setupRealtimeValidation();
    }
    
    handleImagePreview(e) {
        const file = e.target.files[0];
        if (file) {
            // Validate file size (2MB max)
            if (file.size > 2 * 1024 * 1024) {
                this.showAlert('error', 'La imagen no debe superar los 2MB');
                e.target.value = '';
                return;
            }
            
            // Validate file type
            const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png'];
            if (!allowedTypes.includes(file.type)) {
                this.showAlert('error', 'Solo se permiten archivos JPG y PNG');
                e.target.value = '';
                return;
            }
            
            const reader = new FileReader();
            reader.onload = (e) => {
                this.imagePreview.src = e.target.result;
                this.imagePreview.style.display = 'block';
            };
            reader.readAsDataURL(file);
        }
    }
    
    prepareModal() {
        // Hide loading and show content by default
        this.modalLoading.style.display = 'none';
        this.modalContent.style.display = 'block';
        this.hideAlert();
    }
    
    showLoading() {
        this.modalLoading.style.display = 'block';
        this.modalContent.style.display = 'none';
    }
    
    hideLoading() {
        this.modalLoading.style.display = 'none';
        this.modalContent.style.display = 'block';
    }
    
    updateCharCount() {
        const descriptionField = document.getElementById('product_description');
        const currentLength = descriptionField.value.length;
        this.charCountElement.textContent = currentLength;
        
        // Change color based on length
        if (currentLength > 450) {
            this.charCountElement.className = 'text-danger';
        } else if (currentLength > 400) {
            this.charCountElement.className = 'text-warning';
        } else {
            this.charCountElement.className = 'text-muted';
        }
    }
    
    setupRealtimeValidation() {
        const fields = ['product_name', 'product_description'];
        fields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (field) {
                field.addEventListener('blur', () => this.validateField(field));
                field.addEventListener('input', () => this.clearFieldError(field));
            }
        });
    }
    
    validateField(field) {
        const value = field.value.trim();
        let isValid = true;
        let errorMessage = '';
        
        switch (field.id) {
            case 'product_name':
                if (value.length < 3) {
                    isValid = false;
                    errorMessage = 'El nombre debe tener al menos 3 caracteres';
                } else if (value.length > 100) {
                    isValid = false;
                    errorMessage = 'El nombre no puede superar los 100 caracteres';
                }
                break;
            case 'product_description':
                if (value.length < 10) {
                    isValid = false;
                    errorMessage = 'La descripción debe tener al menos 10 caracteres';
                } else if (value.length > 500) {
                    isValid = false;
                    errorMessage = 'La descripción no puede superar los 500 caracteres';
                }
                break;
        }
        
        if (!isValid) {
            this.showFieldError(field, errorMessage);
        } else {
            this.clearFieldError(field);
        }
        
        return isValid;
    }
    
    showFieldError(field, message) {
        field.classList.add('is-invalid');
        field.classList.remove('is-valid');
        const feedback = field.nextElementSibling;
        if (feedback && feedback.classList.contains('invalid-feedback')) {
            feedback.textContent = message;
        }
    }
    
    clearFieldError(field) {
        field.classList.remove('is-invalid');
        if (field.value.trim()) {
            field.classList.add('is-valid');
        } else {
            field.classList.remove('is-valid');
        }
    }
    
    showAlert(type, message) {
        const alertClass = type === 'error' ? 'alert-danger' : 'alert-success';
        this.formAlerts.innerHTML = `
            <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                <i class="ri-${type === 'error' ? 'error-warning' : 'check-double'}-line me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
        this.formAlerts.style.display = 'block';
    }
    
    hideAlert() {
        this.formAlerts.style.display = 'none';
        this.formAlerts.innerHTML = '';
    }
    
    create() {
        this.modalTitle.textContent = 'Crear Nuevo Producto';
        this.productIdField.value = '';
        this.submitBtnText.textContent = 'Crear Producto';
        this.resetForm();
        
        // Show modal
        const bsModal = new bootstrap.Modal(this.modal);
        bsModal.show();
    }
    
    edit(productId) {
        this.modalTitle.textContent = 'Actualizar Producto';
        this.productIdField.value = productId;
        this.submitBtnText.textContent = 'Actualizar Producto';
        
        this.showLoading();
        
        // Load product data
        fetch(`/product/get_details/${productId}/`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error al obtener detalles del producto');
                }
                return response.json();
            })
            .then(data => {
                // Populate form fields
                document.getElementById('product_name').value = data.name;
                document.getElementById('product_type').value = data.type;
                document.getElementById('product_fk_business').value = data.fk_business;
                document.getElementById('product_description').value = data.description;
                
                // Update character count
                this.updateCharCount();
                
                // Show image if exists
                if (data.image_src && data.image_src !== 'None') {
                    this.imagePreview.src = data.image_src;
                    this.imagePreview.style.display = 'block';
                }
                
                this.hideLoading();
                
                // Show modal
                const bsModal = new bootstrap.Modal(this.modal);
                bsModal.show();
            })
            .catch(error => {
                console.error('Error:', error);
                this.hideLoading();
                Swal.fire({
                    title: 'Error',
                    text: 'No se pudieron cargar los detalles del producto',
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
            });
    }
    
    submitForm(e) {
        e.preventDefault();
        
        // Validate all fields
        const nameField = document.getElementById('product_name');
        const descriptionField = document.getElementById('product_description');
        const typeField = document.getElementById('product_type');
        const businessField = document.getElementById('product_fk_business');
        
        let isValid = true;
        
        // Validate required fields
        if (!nameField.value.trim()) {
            this.showFieldError(nameField, 'El nombre es requerido');
            isValid = false;
        } else {
            isValid = this.validateField(nameField) && isValid;
        }
        
        if (!descriptionField.value.trim()) {
            this.showFieldError(descriptionField, 'La descripción es requerida');
            isValid = false;
        } else {
            isValid = this.validateField(descriptionField) && isValid;
        }
        
        if (!typeField.value) {
            this.showFieldError(typeField, 'Debe seleccionar un tipo de producto');
            isValid = false;
        }
        
        if (!businessField.value) {
            this.showFieldError(businessField, 'Debe seleccionar un negocio');
            isValid = false;
        }
        
        if (!isValid) {
            this.showAlert('error', 'Por favor, corrija los errores en el formulario');
            return;
        }
        
        const isUpdate = this.productIdField.value !== '';
        const formData = new FormData(this.form);
        
        // Show loading state
        this.submitBtn.disabled = true;
        this.submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Guardando...';
        
        const url = isUpdate 
            ? `/product/${this.productIdField.value}/update/` 
            : '/product/create/';
        
        fetch(url, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Close modal
                bootstrap.Modal.getInstance(this.modal).hide();
                
                // Show success message
                Swal.fire({
                    title: isUpdate ? 'Producto Actualizado' : 'Producto Creado',
                    text: isUpdate ? 'El producto ha sido actualizado con éxito' : 'El producto ha sido creado con éxito',
                    icon: 'success',
                    confirmButtonText: 'OK',
                    timer: 3000,
                    timerProgressBar: true
                }).then((result) => {
                    if (result.isConfirmed || result.isDismissed) {
                        if (data.redirect_url) {
                            window.location.href = data.redirect_url;
                        } else {
                            window.location.reload();
                        }
                    }
                });
            } else {
                // Show field-specific errors
                if (data.errors) {
                    for (const field in data.errors) {
                        const fieldElement = document.getElementById(`product_${field}`) || document.getElementById(field);
                        if (fieldElement) {
                            this.showFieldError(fieldElement, data.errors[field][0]);
                        }
                    }
                }
                
                // Show general error
                let errorMessage = 'Se encontraron errores en el formulario';
                if (data.errors && data.errors.general) {
                    errorMessage = data.errors.general[0];
                }
                
                this.showAlert('error', errorMessage);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            this.showAlert('error', 'Ocurrió un error al procesar la solicitud. Por favor, intente nuevamente.');
        })
        .finally(() => {
            // Reset button state
            this.submitBtn.disabled = false;
            this.submitBtn.innerHTML = `<i class="ri-save-3-line align-bottom me-1"></i> ${this.submitBtnText.textContent}`;
        });
    }
    
    resetForm() {
        this.form.reset();
        this.imagePreview.src = "{% static 'images/default-product.png' %}";
        this.hideAlert();
        
        // Clear validation classes
        const inputs = this.form.querySelectorAll('.form-control');
        inputs.forEach(input => {
            input.classList.remove('is-invalid', 'is-valid');
        });
        
        // Reset character count
        if (this.charCountElement) {
            this.charCountElement.textContent = '0';
            this.charCountElement.className = 'text-muted';
        }
    }
    
    delete(productId) {
        // Configure deletion URL
        const deleteForm = document.getElementById('deleteProductForm');
        deleteForm.action = `/product/delete/${productId}/`;
        
        // Show confirmation modal
        const bsModal = new bootstrap.Modal(document.getElementById('removeProductModal'));
        bsModal.show();
    }
}

// Enhanced deletion form handler
class ProductDeletionManager {
    constructor() {
        this.form = document.getElementById('deleteProductForm');
        this.submitBtn = document.querySelector('.delete-product-btn');
        this.init();
    }
    
    init() {
        if (this.form) {
            this.form.addEventListener('submit', this.handleSubmit.bind(this));
        }
    }
    
    handleSubmit(e) {
        e.preventDefault();
        
        // Show loading state
        this.submitBtn.disabled = true;
        this.submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Eliminando...';
        
        // Submit form
        fetch(this.form.action, {
            method: 'POST',
            body: new FormData(this.form),
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
            if (response.ok) {
                // Close modal
                bootstrap.Modal.getInstance(document.getElementById('removeProductModal')).hide();
                
                // Show success message
                Swal.fire({
                    title: 'Producto Eliminado',
                    text: 'El producto ha sido eliminado con éxito',
                    icon: 'success',
                    confirmButtonText: 'OK',
                    timer: 3000,
                    timerProgressBar: true
                }).then(() => {
                    window.location.reload();
                });
            } else {
                throw new Error('Error al eliminar el producto');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            Swal.fire({
                title: 'Error',
                text: 'No se pudo eliminar el producto. Por favor, intente nuevamente.',
                icon: 'error',
                confirmButtonText: 'OK'
            });
        })
        .finally(() => {
            // Reset button state
            this.submitBtn.disabled = false;
            this.submitBtn.innerHTML = '<i class="ri-delete-bin-line me-1"></i> ¡Sí, eliminar!';
        });
    }
}

// Initialize managers when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    window.productFormManager = new ProductFormManager();
    window.productDeletionManager = new ProductDeletionManager();
});

// Global functions for backward compatibility
function loadProductDetails(productId) {
    if (window.productFormManager) {
        window.productFormManager.edit(productId);
    }
}
</script>